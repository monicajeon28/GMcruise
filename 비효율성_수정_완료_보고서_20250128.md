# 판매원/대리점장 시스템 비효율성 수정 완료 보고서

> **작성일**: 2025년 1월 28일  
> **수정 내용**: 높은 우선순위 비효율성 3가지 수정 완료

---

## ✅ 수정 완료 항목

### 1. ✅ 링크 생성 시 중복 체크 로직 수정

**수정 전**:
```typescript
const existingLink = await prisma.affiliateLink.findFirst({
  where: {
    OR: [
      { managerId: profile.type === 'BRANCH_MANAGER' ? profile.id : undefined },
      { agentId: profile.type === 'SALES_AGENT' ? profile.id : undefined },
    ],
  },
});
```

**문제점**: `undefined` 값이 포함된 OR 조건이 제대로 작동하지 않을 수 있음

**수정 후**:
```typescript
const where: any = {};
if (profile.type === 'BRANCH_MANAGER') {
  where.managerId = profile.id;
} else if (profile.type === 'SALES_AGENT') {
  where.agentId = profile.id;
}

const existingLink = await prisma.affiliateLink.findFirst({
  where,
  take: 1,
});
```

**개선 효과**: 명확한 조건문으로 정확한 중복 체크 보장

---

### 2. ✅ 링크 코드 충돌 방지 로직 추가

**수정 전**:
```typescript
const linkCode = `${profile.affiliateCode}-${randomBytes(3).toString('hex')}`.toUpperCase();
```

**문제점**: 
- `randomBytes(3)`는 약 1,600만 가지 조합 (충돌 가능성 존재)
- 충돌 체크 없이 바로 생성

**수정 후**:
```typescript
// 고유한 링크 코드 생성 (충돌 방지)
let linkCode: string;
let exists = true;
let attempts = 0;
const maxAttempts = 10;

while (exists && attempts < maxAttempts) {
  // randomBytes(4)로 변경하여 충돌 가능성 감소 (약 42억 가지 조합)
  linkCode = `${profile.affiliateCode}-${randomBytes(4).toString('hex')}`.toUpperCase();
  const existingLinkByCode = await prisma.affiliateLink.findUnique({
    where: { code: linkCode },
  });
  exists = existingLinkByCode !== null;
  attempts++;
}

if (exists) {
  throw new Error(`링크 코드 생성 실패: ${maxAttempts}번 시도 후에도 고유한 코드를 생성할 수 없습니다.`);
}
```

**개선 효과**:
- 충돌 체크 로직 추가
- `randomBytes(4)`로 변경하여 충돌 가능성 대폭 감소 (약 42억 가지 조합)
- 최대 10번 시도 후 실패 처리

---

### 3. ✅ 랜딩 페이지 slug 중복 체크 추가

**수정 전**:
```typescript
const slug = profile.landingSlug || `partner-${profile.id}`;
```

**문제점**: `landingSlug`가 제공된 경우 중복 체크 없음

**수정 후**:
```typescript
// slug 생성 (중복 체크)
let slug = profile.landingSlug || `partner-${profile.id}`;

// landingSlug가 제공된 경우 중복 체크
if (profile.landingSlug) {
  const existingPage = await prisma.sharedLandingPage.findUnique({
    where: { slug: profile.landingSlug },
  });
  
  // 다른 프로필에서 이미 사용 중인 경우 안전한 slug로 변경
  if (existingPage && existingPage.affiliateProfileId !== profile.id) {
    logger.log(`[Auto Setup] Landing slug '${profile.landingSlug}' already exists, using profile ID instead`);
    slug = `partner-${profile.id}`;
  }
}
```

**개선 효과**:
- 중복 체크 로직 추가
- 중복 발견 시 자동으로 안전한 slug 생성
- 로그 기록으로 추적 가능

---

### 4. ✅ 추가 개선 사항

#### 하드코딩된 URL 환경 변수화
**수정 전**:
```typescript
targetUrl: profile.landingSlug ? `https://yourdomain.com/l/${profile.landingSlug}` : 'https://yourdomain.com',
```

**수정 후**:
```typescript
targetUrl: (() => {
  const baseUrl = process.env.NEXT_PUBLIC_BASE_URL || 'https://cruisedot.kr';
  return profile.landingSlug ? `${baseUrl}/l/${profile.landingSlug}` : baseUrl;
})(),
```

**개선 효과**: 환경 변수에서 도메인 가져오기로 유지보수성 향상

#### 고객 그룹 이름 개선
**수정 전**:
```typescript
name: `${displayName}의 고객`,
```

**수정 후**:
```typescript
name: `${displayName}의 고객 (${profile.affiliateCode})`,
```

**개선 효과**: 같은 이름의 판매원/대리점장이 있어도 고유한 그룹 이름 보장

---

## 📊 수정 효과

### 안정성 향상
- ✅ 링크 코드 충돌 방지로 데이터 무결성 보장
- ✅ 랜딩 페이지 slug 중복 방지로 URL 충돌 방지
- ✅ 명확한 조건문으로 버그 가능성 감소

### 확장성 향상
- ✅ 더 긴 랜덤 문자열로 대규모 확장 가능
- ✅ 충돌 체크 로직으로 안전한 자동 생성

### 유지보수성 향상
- ✅ 환경 변수 사용으로 설정 관리 용이
- ✅ 명확한 로그로 디버깅 용이

---

## 🎯 최종 결과

### 수정 완료
- ✅ 링크 생성 시 중복 체크 로직 수정
- ✅ 링크 코드 충돌 방지 로직 추가
- ✅ 랜딩 페이지 slug 중복 체크 추가
- ✅ 하드코딩된 URL 환경 변수화
- ✅ 고객 그룹 이름 개선

### 테스트 권장 사항
1. 새로운 판매원/대리점장 프로필 생성 테스트
2. 링크 코드 충돌 시나리오 테스트
3. 랜딩 페이지 slug 중복 시나리오 테스트

---

**작성자**: AI Assistant  
**최종 업데이트**: 2025년 1월 28일

