# í”„ë¡œí•„ ìƒì„± ì‹œ ê²€ì¦ ê°•í™” ì™„ë£Œ ë³´ê³ ì„œ

> **ì‘ì„±ì¼**: 2025ë…„ 1ì›” 28ì¼  
> **ìˆ˜ì • ë‚´ìš©**: í”„ë¡œí•„ ìƒì„± ì‹œ ê³ ìœ  ê°’ ì¤‘ë³µ ì²´í¬ ê°•í™”

---

## âœ… ìˆ˜ì • ì™„ë£Œ í•­ëª©

### 1. âœ… affiliateCode ì¤‘ë³µ ì²´í¬ ê°•í™”

**ìˆ˜ì • ì „**:
```typescript
const affiliateCode = (data.affiliateCode as string | undefined)?.trim() || generateAffiliateCode(nameForCode, userId);
// ì¤‘ë³µ ì²´í¬ ì—†ì´ ë°”ë¡œ ì‚¬ìš©
```

**ë¬¸ì œì **:
- ì‚¬ìš©ìê°€ ì œê³µí•œ `affiliateCode`ì˜ ì¤‘ë³µ ì²´í¬ ì—†ìŒ
- ìë™ ìƒì„±ëœ ì½”ë“œë„ ì¤‘ë³µ ì²´í¬ ì—†ìŒ
- ìƒì„± í›„ DB ì œì•½ ì¡°ê±´ì—ì„œë§Œ í™•ì¸ (ì—ëŸ¬ ë°œìƒ ì‹œì ì´ ëŠ¦ìŒ)

**ìˆ˜ì • í›„**:
```typescript
let affiliateCode = (data.affiliateCode as string | undefined)?.trim() || generateAffiliateCode(nameForCode, userId);

// affiliateCode ì¤‘ë³µ ì²´í¬ (í”„ë¡œí•„ ìƒì„± ì „)
if (affiliateCode) {
  const existingProfileWithCode = await prisma.affiliateProfile.findUnique({
    where: { affiliateCode },
    select: { id: true },
  });
  if (existingProfileWithCode) {
    // ì¤‘ë³µëœ ê²½ìš° ìë™ ìƒì„±ëœ ì½”ë“œë¡œ ì¬ì‹œë„
    affiliateCode = generateAffiliateCode(nameForCode, userId);
    // ì¬ì‹œë„ í›„ì—ë„ ì¤‘ë³µ ê°€ëŠ¥ì„± ì²´í¬ (ë§¤ìš° ë“œë¬¸ ê²½ìš°)
    const retryCheck = await prisma.affiliateProfile.findUnique({
      where: { affiliateCode },
      select: { id: true },
    });
    if (retryCheck) {
      // ë‘ ë²ˆ ëª¨ë‘ ì¤‘ë³µì´ë©´ íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
      affiliateCode = `${affiliateCode}-${Date.now()}`;
    }
  }
}
```

**ê°œì„  íš¨ê³¼**:
- âœ… í”„ë¡œí•„ ìƒì„± ì „ ì¤‘ë³µ ì²´í¬
- âœ… ì¤‘ë³µ ë°œê²¬ ì‹œ ìë™ìœ¼ë¡œ ì•ˆì „í•œ ì½”ë“œ ìƒì„±
- âœ… ëª…í™•í•œ ì—ëŸ¬ ë°©ì§€

---

### 2. âœ… landingSlug ì¤‘ë³µ ì²´í¬ ì¶”ê°€

**ìˆ˜ì • ì „**:
```typescript
let landingSlug = toNullableString(data.landingSlug);
if (!landingSlug && userRecord?.phone) {
  // ìë™ ìƒì„±
  landingSlug = userRecord.phone;
}
// ì¤‘ë³µ ì²´í¬ ì—†ì´ ë°”ë¡œ ì‚¬ìš©
```

**ë¬¸ì œì **:
- `landingSlug` ì¤‘ë³µ ì²´í¬ ì—†ìŒ
- DB ì œì•½ ì¡°ê±´ì—ì„œë§Œ í™•ì¸ (ì—ëŸ¬ ë°œìƒ ì‹œì ì´ ëŠ¦ìŒ)

**ìˆ˜ì • í›„**:
```typescript
let landingSlug = toNullableString(data.landingSlug);
if (!landingSlug && userRecord?.phone) {
  const partnerIdPattern = type === 'BRANCH_MANAGER' ? /^boss\d+(-.*)?$/i : /^user\d+(-.*)?$/i;
  if (userRecord.phone.match(partnerIdPattern)) {
    landingSlug = userRecord.phone;
  }
}

// landingSlug ì¤‘ë³µ ì²´í¬ (í”„ë¡œí•„ ìƒì„± ì „)
if (landingSlug) {
  const existingProfileWithSlug = await prisma.affiliateProfile.findUnique({
    where: { landingSlug },
    select: { id: true },
  });
  if (existingProfileWithSlug) {
    // ì¤‘ë³µëœ ê²½ìš° ì•ˆì „í•œ slugë¡œ ë³€ê²½
    landingSlug = landingSlug.includes('-') 
      ? `${landingSlug}-${userId}-${Date.now()}`
      : `${landingSlug}-${userId}`;
    // ë³€ê²½ëœ slugë„ ì¤‘ë³µ ì²´í¬ (ë§¤ìš° ë“œë¬¸ ê²½ìš°)
    const retryCheck = await prisma.affiliateProfile.findUnique({
      where: { landingSlug },
      select: { id: true },
    });
    if (retryCheck) {
      // ë‘ ë²ˆ ëª¨ë‘ ì¤‘ë³µì´ë©´ íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
      landingSlug = `${landingSlug}-${Date.now()}`;
    }
    logger.log(`[admin/affiliate/profiles][POST] Landing slug conflict resolved: ${landingSlug}`);
  }
}
```

**ê°œì„  íš¨ê³¼**:
- âœ… í”„ë¡œí•„ ìƒì„± ì „ ì¤‘ë³µ ì²´í¬
- âœ… ì¤‘ë³µ ë°œê²¬ ì‹œ ìë™ìœ¼ë¡œ ì•ˆì „í•œ slug ìƒì„±
- âœ… ë¡œê·¸ ê¸°ë¡ìœ¼ë¡œ ì¶”ì  ê°€ëŠ¥

---

### 3. âœ… mallUserId ì¤‘ë³µ ì²´í¬ ì¶”ê°€

**ìˆ˜ì • ì „**:
```typescript
if (mallUserIdValue !== undefined) {
  await tx.user.update({
    where: { id: userId },
    data: { mallUserId: mallUserIdValue },
  });
}
// ì¤‘ë³µ ì²´í¬ ì—†ì´ ë°”ë¡œ ì—…ë°ì´íŠ¸
```

**ë¬¸ì œì **:
- `mallUserId` ì¤‘ë³µ ì²´í¬ ì—†ìŒ
- ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ `mallUserId`ë¡œ ì—…ë°ì´íŠ¸ ê°€ëŠ¥

**ìˆ˜ì • í›„**:
```typescript
if (mallUserIdValue !== undefined) {
  // mallUserId ì¤‘ë³µ ì²´í¬ (íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ)
  if (mallUserIdValue) {
    const existingUserWithMallId = await tx.user.findFirst({
      where: {
        mallUserId: mallUserIdValue,
        id: { not: userId }, // í˜„ì¬ ì‚¬ìš©ì ì œì™¸
      },
      select: { id: true },
    });
    if (existingUserWithMallId) {
      throw new Error(`mallUserId '${mallUserIdValue}'ëŠ” ì´ë¯¸ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤.`);
    }
  }
  
  await tx.user.update({
    where: { id: userId },
    data: { mallUserId: mallUserIdValue },
  });
}
```

**ê°œì„  íš¨ê³¼**:
- âœ… íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ ì¤‘ë³µ ì²´í¬
- âœ… ì¤‘ë³µ ë°œê²¬ ì‹œ ëª…í™•í•œ ì—ëŸ¬ ë©”ì‹œì§€
- âœ… ë°ì´í„° ë¬´ê²°ì„± ë³´ì¥

---

## ğŸ“Š ê²€ì¦ ê°•í™” íš¨ê³¼

### ë°ì´í„° ë¬´ê²°ì„±
- âœ… **ì´ì „**: DB ì œì•½ ì¡°ê±´ì—ì„œë§Œ í™•ì¸ (ì—ëŸ¬ ë°œìƒ ì‹œì ì´ ëŠ¦ìŒ)
- âœ… **ì´í›„**: í”„ë¡œí•„ ìƒì„± ì „ ì¤‘ë³µ ì²´í¬ (ëª…í™•í•œ ì—ëŸ¬ ë©”ì‹œì§€)

### ì‚¬ìš©ì ê²½í—˜
- âœ… **ì´ì „**: ì¤‘ë³µ ë°œê²¬ ì‹œ DB ì—ëŸ¬ë¡œ ì‹¤íŒ¨
- âœ… **ì´í›„**: ì¤‘ë³µ ë°œê²¬ ì‹œ ìë™ìœ¼ë¡œ ì•ˆì „í•œ ê°’ ìƒì„±

### ì—ëŸ¬ ì²˜ë¦¬
- âœ… **ì´ì „**: ìƒì„± í›„ DB ì—ëŸ¬ ë°œìƒ
- âœ… **ì´í›„**: ìƒì„± ì „ ê²€ì¦ìœ¼ë¡œ ì‚¬ì „ ë°©ì§€

---

## ğŸ” ê²€ì¦ ì™„ë£Œ

### íƒ€ì… ì•ˆì •ì„±
- âœ… ëª¨ë“  íƒ€ì… ì •ì˜ ì •í™•í•¨
- âœ… íƒ€ì… ì˜¤ë¥˜ ì—†ìŒ

### ë¦°í„° ê²€ì‚¬
- âœ… ë¦°í„° ì˜¤ë¥˜ ì—†ìŒ

### ë¡œì§ ì •í™•ì„±
- âœ… ì¤‘ë³µ ì²´í¬ ë¡œì§ ì •í™•í•¨
- âœ… ì•ˆì „í•œ ê°’ ìƒì„± ë¡œì§ ì •í™•í•¨
- âœ… ì—ëŸ¬ ì²˜ë¦¬ ì •í™•í•¨

---

## ğŸ¯ ìµœì¢… ê²°ë¡ 

### ìˆ˜ì • ì™„ë£Œ
- âœ… `affiliateCode` ì¤‘ë³µ ì²´í¬ ê°•í™”
- âœ… `landingSlug` ì¤‘ë³µ ì²´í¬ ì¶”ê°€
- âœ… `mallUserId` ì¤‘ë³µ ì²´í¬ ì¶”ê°€

### ê²€ì¦ ì™„ë£Œ
- âœ… íƒ€ì… ì˜¤ë¥˜ ì—†ìŒ
- âœ… ë¦°í„° ì˜¤ë¥˜ ì—†ìŒ
- âœ… ë¡œì§ ì •í™•ì„± í™•ì¸

### ë°°í¬ ì¤€ë¹„ ìƒíƒœ
**ëª¨ë“  ìˆ˜ì •ì‚¬í•­ì´ ì™„ë£Œë˜ì—ˆê³  ê²€ì¦ë˜ì—ˆìŠµë‹ˆë‹¤. ë°ì´í„° ë¬´ê²°ì„±ì´ í–¥ìƒë˜ì—ˆìŠµë‹ˆë‹¤.**

---

**ì‘ì„±ì**: AI Assistant  
**ìµœì¢… ì—…ë°ì´íŠ¸**: 2025ë…„ 1ì›” 28ì¼

