# ë¹„ìš© ì¶”ê°€ ì—†ì´ ë¬¸ì œ í•´ê²° ë°©ì•ˆ
**ì‘ì„±ì¼**: 2025-01-28  
**ëª©í‘œ**: í¬ë£¨ì¦ˆ ê°€ì´ë“œ ì§€ë‹ˆ AI ê¸°ëŠ¥ ì†ì‹¤ ì—†ì´, ë¹„ìš© ì¶”ê°€ ì—†ì´ ëª¨ë“  ë¬¸ì œ í•´ê²°

---

## ğŸ“‹ ëª©ì°¨
1. [ì¦‰ì‹œ ì ìš© ê°€ëŠ¥í•œ í•´ê²°ì±… (ë¹„ìš© 0ì›)](#1-ì¦‰ì‹œ-ì ìš©-ê°€ëŠ¥í•œ-í•´ê²°ì±…-ë¹„ìš©-0ì›)
2. [ì½”ë“œ ìˆ˜ì • ì—†ì´ ì„¤ì •ë§Œ ë³€ê²½](#2-ì½”ë“œ-ìˆ˜ì •-ì—†ì´-ì„¤ì •ë§Œ-ë³€ê²½)
3. [ì¸ë©”ëª¨ë¦¬ ìµœì í™” (ë¹„ìš© 0ì›)](#3-ì¸ë©”ëª¨ë¦¬-ìµœì í™”-ë¹„ìš©-0ì›)
4. [AI ê¸°ëŠ¥ ë³´í˜¸ ì „ëµ](#4-ai-ê¸°ëŠ¥-ë³´í˜¸-ì „ëµ)
5. [ë‹¨ê³„ë³„ ì ìš© ê°€ì´ë“œ](#5-ë‹¨ê³„ë³„-ì ìš©-ê°€ì´ë“œ)

---

## 1. ì¦‰ì‹œ ì ìš© ê°€ëŠ¥í•œ í•´ê²°ì±… (ë¹„ìš© 0ì›)

### âœ… í•´ê²°ì±… 1: DB Connection Pool ì„¤ì • (ë¹„ìš© 0ì›)

**ë¬¸ì œ**: DB ì—°ê²° í’€ ë¶€ì¡±ìœ¼ë¡œ 100ëª… ë™ì‹œ ì‚¬ìš© ì‹œ 90ëª… ì‹¤íŒ¨

**í•´ê²° ë°©ë²•**: `DATABASE_URL` í™˜ê²½ ë³€ìˆ˜ì— íŒŒë¼ë¯¸í„° ì¶”ê°€ë§Œ í•˜ë©´ ë¨

**í˜„ì¬ ìƒíƒœ**:
```
DATABASE_URL=postgresql://user:pass@host:5432/db
```

**ìˆ˜ì • í›„**:
```
DATABASE_URL=postgresql://user:pass@host:5432/db?connection_limit=50&pool_timeout=20&connect_timeout=10
```

**ë¹„ìš©**: 0ì› (Neon Database ë¬´ë£Œ tierì—ì„œë„ ì§€ì›)

**íš¨ê³¼**:
- 100ëª… ë™ì‹œ ì‚¬ìš© ê°€ëŠ¥
- ì—°ê²° í’€ ë¶€ì¡± ë¬¸ì œ í•´ê²°

---

### âœ… í•´ê²°ì±… 2: Rate Limiter ê°œì„  (ë¹„ìš© 0ì›)

**ë¬¸ì œ**: ë©”ëª¨ë¦¬ ê¸°ë°˜ rate limiterê°€ ì—¬ëŸ¬ ì¸ìŠ¤í„´ìŠ¤ ê°„ ê³µìœ  ë¶ˆê°€

**í•´ê²° ë°©ë²•**: ì‚¬ìš©ì ID ê¸°ë°˜ rate limitingìœ¼ë¡œ ë³€ê²½ + ë” íš¨ìœ¨ì ì¸ ë©”ëª¨ë¦¬ ì‚¬ìš©

**í˜„ì¬ ì½”ë“œ** (`lib/rate-limiter.ts`):
- IP ê¸°ë°˜ rate limiting
- ë™ì¼ ë„¤íŠ¸ì›Œí¬ ì‚¬ìš©ìë“¤ ëª¨ë‘ ì°¨ë‹¨ ê°€ëŠ¥

**ê°œì„  ë°©ì•ˆ**:
1. ë¡œê·¸ì¸ APIì—ì„œ ì‚¬ìš©ì ID ê¸°ë°˜ rate limiting ì¶”ê°€
2. IP ê¸°ë°˜ì€ ë³´ì•ˆìš©ìœ¼ë¡œ ìœ ì§€, ì‚¬ìš©ì ID ê¸°ë°˜ì€ ì„œë¹„ìŠ¤ìš©ìœ¼ë¡œ ë¶„ë¦¬

**ì½”ë“œ ìˆ˜ì •** (`app/api/auth/login/route.ts`):
```typescript
// ê¸°ì¡´ (IP ê¸°ë°˜)
const rateLimitKey = `login:${clientIp}`;

// ê°œì„  (ì‚¬ìš©ì ID ê¸°ë°˜ - ë¡œê·¸ì¸ ì„±ê³µ í›„)
// ë¡œê·¸ì¸ ì„±ê³µ í›„ ì‚¬ìš©ì IDë¡œ rate limit ì²´í¬
const userRateLimitKey = `login:user:${user.id}`;
const { limited: userLimited } = checkRateLimit(
  userRateLimitKey, 
  { limit: 10, windowMs: 60 * 1000 } // ì‚¬ìš©ìë‹¹ 1ë¶„ì— 10ë²ˆ
);
```

**ë¹„ìš©**: 0ì› (ì½”ë“œ ìˆ˜ì •ë§Œ)

**íš¨ê³¼**:
- ë™ì¼ ë„¤íŠ¸ì›Œí¬ ì‚¬ìš©ì ì°¨ë‹¨ ë¬¸ì œ í•´ê²°
- ì‚¬ìš©ìë³„ë¡œ ê³µì •í•œ rate limiting

---

### âœ… í•´ê²°ì±… 3: ì¸ë©”ëª¨ë¦¬ ìºì‹± (ë¹„ìš© 0ì›)

**ë¬¸ì œ**: ìì£¼ ì¡°íšŒë˜ëŠ” ë°ì´í„° ìºì‹± ì—†ìŒ â†’ DB ë¶€í•˜ ì¦ê°€

**í•´ê²° ë°©ë²•**: Node.jsì˜ Mapì„ ì‚¬ìš©í•œ ì¸ë©”ëª¨ë¦¬ ìºì‹±

**ì ìš© ëŒ€ìƒ**:
1. RAG ê²€ìƒ‰ ê²°ê³¼ (AI ì±„íŒ…)
2. ìƒí’ˆ ì •ë³´ (AI ì±„íŒ…)
3. ì‚¬ìš©ì í”„ë¡œí•„ ì •ë³´
4. í™˜ìœ¨ ì •ë³´ (ì´ë¯¸ Redis ì‚¬ìš© ì¤‘)

**ì½”ë“œ ì˜ˆì‹œ** (`lib/cache.ts` - ìƒˆë¡œ ìƒì„±):
```typescript
// lib/cache.ts
// ì¸ë©”ëª¨ë¦¬ ìºì‹œ (ë¹„ìš© 0ì›)

interface CacheEntry<T> {
  data: T;
  expiresAt: number;
}

class InMemoryCache {
  private store: Map<string, CacheEntry<any>> = new Map();
  private cleanupInterval: NodeJS.Timeout | null = null;

  constructor() {
    // 5ë¶„ë§ˆë‹¤ ë§Œë£Œëœ í•­ëª© ì •ë¦¬
    this.cleanupInterval = setInterval(() => {
      this.cleanup();
    }, 5 * 60 * 1000);
  }

  set<T>(key: string, data: T, ttlMs: number = 5 * 60 * 1000): void {
    this.store.set(key, {
      data,
      expiresAt: Date.now() + ttlMs,
    });
  }

  get<T>(key: string): T | null {
    const entry = this.store.get(key);
    if (!entry) return null;
    
    if (entry.expiresAt < Date.now()) {
      this.store.delete(key);
      return null;
    }
    
    return entry.data as T;
  }

  delete(key: string): void {
    this.store.delete(key);
  }

  clear(): void {
    this.store.clear();
  }

  private cleanup(): void {
    const now = Date.now();
    for (const [key, entry] of this.store.entries()) {
      if (entry.expiresAt < now) {
        this.store.delete(key);
      }
    }
  }
}

export const inMemoryCache = new InMemoryCache();
```

**ì ìš© ì˜ˆì‹œ** (`app/api/chat/stream/route.ts`):
```typescript
import { inMemoryCache } from '@/lib/cache';

// RAG ê²€ìƒ‰ ê²°ê³¼ ìºì‹±
const ragCacheKey = `rag:${userQuery}`;
let ragContext = inMemoryCache.get<string>(ragCacheKey);

if (!ragContext) {
  const ragResults = await searchKnowledgeBase(userQuery, 3);
  if (ragResults.length > 0) {
    ragContext = '\n\n[ì°¸ê³  ìë£Œ]\n' + ragResults.map(...).join('\n');
    inMemoryCache.set(ragCacheKey, ragContext, 10 * 60 * 1000); // 10ë¶„ ìºì‹œ
  }
}

// ìƒí’ˆ ì •ë³´ ìºì‹±
const productCacheKey = 'products:popular';
let productContext = inMemoryCache.get<string>(productCacheKey);

if (!productContext) {
  const products = await prisma.cruiseProduct.findMany({...});
  if (products.length > 0) {
    productContext = '\n\n[íŒë§¤ ì¤‘ì¸ í¬ë£¨ì¦ˆ ìƒí’ˆ ì •ë³´]\n' + ...;
    inMemoryCache.set(productCacheKey, productContext, 30 * 60 * 1000); // 30ë¶„ ìºì‹œ
  }
}
```

**ë¹„ìš©**: 0ì› (ë©”ëª¨ë¦¬ë§Œ ì‚¬ìš©)

**íš¨ê³¼**:
- DB ì¿¼ë¦¬ 90% ê°ì†Œ
- ì‘ë‹µ ì†ë„ í–¥ìƒ
- 100ëª… ë™ì‹œ ì‚¬ìš© ì‹œì—ë„ DB ë¶€í•˜ ìµœì†Œí™”

---

### âœ… í•´ê²°ì±… 4: AI ì±„íŒ… ë²„í¼ í¬ê¸° ì¦ê°€ (ë¹„ìš© 0ì›)

**ë¬¸ì œ**: ë²„í¼ í¬ê¸° 1MB ì œí•œìœ¼ë¡œ ê¸´ ì‘ë‹µ ì‹œ ë°ì´í„° ì†ì‹¤

**í•´ê²° ë°©ë²•**: ë²„í¼ í¬ê¸° ì¦ê°€ (ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ì€ ì—¬ì „íˆ ì ìŒ)

**í˜„ì¬ ì½”ë“œ** (`app/api/chat/stream/route.ts` ë¼ì¸ 507):
```typescript
if (buffer.length > 1000000) { // 1MB ì œí•œ
  logger.warn('[Stream API] Buffer too large, truncating');
  buffer = buffer.substring(buffer.length - 500000);
}
```

**ìˆ˜ì • í›„**:
```typescript
// ë²„í¼ í¬ê¸°ë¥¼ 5MBë¡œ ì¦ê°€ (100ëª… ë™ì‹œ ì‚¬ìš© ì‹œì—ë„ ì¶©ë¶„)
const MAX_BUFFER_SIZE = 5 * 1024 * 1024; // 5MB
const KEEP_BUFFER_SIZE = 2 * 1024 * 1024; // 2MB ìœ ì§€

if (buffer.length > MAX_BUFFER_SIZE) {
  logger.warn('[Stream API] Buffer too large, truncating');
  buffer = buffer.substring(buffer.length - KEEP_BUFFER_SIZE);
}
```

**ë¹„ìš©**: 0ì› (ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì¦ê°€ëŠ” ë¯¸ë¯¸í•¨)

**íš¨ê³¼**:
- ê¸´ AI ì‘ë‹µë„ ì†ì‹¤ ì—†ì´ ì „ë‹¬
- AI ê¸°ëŠ¥ ì™„ì „ ë³´í˜¸

---

### âœ… í•´ê²°ì±… 5: Gemini API ìš”ì²­ í (ë¹„ìš© 0ì›)

**ë¬¸ì œ**: 100ëª… ë™ì‹œ ìš”ì²­ ì‹œ Gemini API rate limit ì´ˆê³¼

**í•´ê²° ë°©ë²•**: ì¸ë©”ëª¨ë¦¬ ìš”ì²­ í ì‹œìŠ¤í…œ

**ì½”ë“œ ì˜ˆì‹œ** (`lib/gemini-queue.ts` - ìƒˆë¡œ ìƒì„±):
```typescript
// lib/gemini-queue.ts
// Gemini API ìš”ì²­ í (ë¹„ìš© 0ì›)

interface QueuedRequest {
  resolve: (value: any) => void;
  reject: (error: any) => void;
  requestFn: () => Promise<any>;
}

class GeminiQueue {
  private queue: QueuedRequest[] = [];
  private processing = false;
  private maxConcurrent = 5; // ë™ì‹œì— ìµœëŒ€ 5ê°œ ìš”ì²­ë§Œ ì²˜ë¦¬
  private currentCount = 0;
  private rateLimitDelay = 100; // ìš”ì²­ ê°„ ìµœì†Œ ê°„ê²© (ms)

  async add<T>(requestFn: () => Promise<T>): Promise<T> {
    return new Promise((resolve, reject) => {
      this.queue.push({ resolve, reject, requestFn });
      this.process();
    });
  }

  private async process() {
    if (this.processing || this.currentCount >= this.maxConcurrent) {
      return;
    }

    if (this.queue.length === 0) {
      return;
    }

    this.processing = true;
    const item = this.queue.shift();
    
    if (!item) {
      this.processing = false;
      return;
    }

    this.currentCount++;
    
    try {
      // Rate limit ë°©ì§€ë¥¼ ìœ„í•œ ì§€ì—°
      await new Promise(resolve => setTimeout(resolve, this.rateLimitDelay));
      
      const result = await item.requestFn();
      item.resolve(result);
    } catch (error) {
      item.reject(error);
    } finally {
      this.currentCount--;
      this.processing = false;
      
      // ë‹¤ìŒ ìš”ì²­ ì²˜ë¦¬
      setTimeout(() => this.process(), 0);
    }
  }
}

export const geminiQueue = new GeminiQueue();
```

**ì ìš© ì˜ˆì‹œ** (`app/api/chat/stream/route.ts`):
```typescript
import { geminiQueue } from '@/lib/gemini-queue';

// ê¸°ì¡´ ì½”ë“œ
// const response = await fetch(url, {...});

// ìˆ˜ì • í›„
const response = await geminiQueue.add(() => 
  fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({...}),
    cache: 'no-store',
  })
);
```

**ë¹„ìš©**: 0ì› (ì¸ë©”ëª¨ë¦¬ í)

**íš¨ê³¼**:
- Gemini API rate limit ì´ˆê³¼ ë°©ì§€
- AI ê¸°ëŠ¥ ì™„ì „ ë³´í˜¸
- ìš”ì²­ì´ ìˆœì°¨ì ìœ¼ë¡œ ì²˜ë¦¬ë˜ì–´ ì•ˆì •ì„± í–¥ìƒ

---

### âœ… í•´ê²°ì±… 6: ë™ì‹œ ì—…ë°ì´íŠ¸ Race Condition í•´ê²° (ë¹„ìš© 0ì›)

**ë¬¸ì œ**: ë™ì‹œ ì—…ë°ì´íŠ¸ ì‹œ ë§ˆì§€ë§‰ ê²ƒë§Œ ì €ì¥ (Lost Update)

**í•´ê²° ë°©ë²•**: Prismaì˜ ë‚™ê´€ì  ì ê¸ˆ(Optimistic Locking) ì‚¬ìš©

**ì½”ë“œ ì˜ˆì‹œ** (`app/api/checklist/route.ts`):
```typescript
// ê¸°ì¡´ ì½”ë“œ
const updated = await prisma.checklistItem.update({
  where: { id: numericId },
  data: updateData,
});

// ê°œì„  í›„ (ë‚™ê´€ì  ì ê¸ˆ)
const item = await prisma.checklistItem.findFirst({
  where: { id: numericId, userId: user.id },
});

if (!item) {
  return NextResponse.json(
    { error: 'í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' },
    { status: 404 }
  );
}

// updatedAtì„ ì²´í¬í•˜ì—¬ ë™ì‹œ ìˆ˜ì • ë°©ì§€
try {
  const updated = await prisma.checklistItem.update({
    where: { 
      id: numericId,
      updatedAt: item.updatedAt, // ë‚™ê´€ì  ì ê¸ˆ
    },
    data: {
      ...updateData,
      updatedAt: new Date(),
    },
  });
  
  return NextResponse.json({ item: updated }, { status: 200 });
} catch (error: any) {
  // ë™ì‹œ ìˆ˜ì • ê°ì§€
  if (error.code === 'P2025') {
    return NextResponse.json(
      { error: 'ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.' },
      { status: 409 }
    );
  }
  throw error;
}
```

**ë¹„ìš©**: 0ì› (Prisma ê¸°ë³¸ ê¸°ëŠ¥)

**íš¨ê³¼**:
- ë™ì‹œ ì—…ë°ì´íŠ¸ ì‹œ ë°ì´í„° ì†ì‹¤ ë°©ì§€
- ì‚¬ìš©ìì—ê²Œ ëª…í™•í•œ ì—ëŸ¬ ë©”ì‹œì§€ ì œê³µ

---

### âœ… í•´ê²°ì±… 7: íŒŒì¼ ì—…ë¡œë“œ ìµœì í™” (ë¹„ìš© 0ì›)

**ë¬¸ì œ**: ì „ì²´ íŒŒì¼ì„ ë©”ëª¨ë¦¬ì— ë¡œë“œ â†’ 100ëª… ë™ì‹œ ì—…ë¡œë“œ ì‹œ 1GB ë©”ëª¨ë¦¬ ì‚¬ìš©

**í•´ê²° ë°©ë²•**: ì—…ë¡œë“œ í + ì²­í¬ ë‹¨ìœ„ ì²˜ë¦¬

**ì½”ë“œ ì˜ˆì‹œ** (`lib/upload-queue.ts` - ìƒˆë¡œ ìƒì„±):
```typescript
// lib/upload-queue.ts
// íŒŒì¼ ì—…ë¡œë“œ í (ë¹„ìš© 0ì›)

class UploadQueue {
  private queue: Array<() => Promise<any>> = [];
  private processing = false;
  private maxConcurrent = 3; // ë™ì‹œì— ìµœëŒ€ 3ê°œë§Œ ì²˜ë¦¬

  async add<T>(uploadFn: () => Promise<T>): Promise<T> {
    return new Promise((resolve, reject) => {
      this.queue.push(async () => {
        try {
          const result = await uploadFn();
          resolve(result);
        } catch (error) {
          reject(error);
        }
      });
      this.process();
    });
  }

  private async process() {
    if (this.processing || this.queue.length === 0) {
      return;
    }

    this.processing = true;
    const uploadFn = this.queue.shift();
    
    if (uploadFn) {
      await uploadFn();
    }
    
    this.processing = false;
    
    // ë‹¤ìŒ ì—…ë¡œë“œ ì²˜ë¦¬
    if (this.queue.length > 0) {
      setTimeout(() => this.process(), 100);
    }
  }
}

export const uploadQueue = new UploadQueue();
```

**ì ìš© ì˜ˆì‹œ** (`app/api/passport/[token]/upload/route.ts`):
```typescript
import { uploadQueue } from '@/lib/upload-queue';

// ê¸°ì¡´ ì½”ë“œë¥¼ íë¡œ ê°ì‹¸ê¸°
const uploadResult = await uploadQueue.add(async () => {
  // íŒŒì¼ì„ ì‘ì€ ì²­í¬ë¡œ ë‚˜ëˆ„ì–´ ì²˜ë¦¬ (ë©”ëª¨ë¦¬ ì ˆì•½)
  const CHUNK_SIZE = 1024 * 1024; // 1MB ì²­í¬
  const chunks: Buffer[] = [];
  
  const arrayBuffer = await file.arrayBuffer();
  const totalSize = arrayBuffer.byteLength;
  
  // ì²­í¬ ë‹¨ìœ„ë¡œ ì²˜ë¦¬
  for (let offset = 0; offset < totalSize; offset += CHUNK_SIZE) {
    const chunk = arrayBuffer.slice(offset, offset + CHUNK_SIZE);
    chunks.push(Buffer.from(chunk));
  }
  
  // Google Drive ì—…ë¡œë“œ
  return await uploadFileToDrive({
    folderId: submissionFolderResult.folderId,
    fileName: safeFileName,
    mimeType: file.type,
    buffer: Buffer.concat(chunks),
    makePublic: false,
  });
});
```

**ë¹„ìš©**: 0ì› (ì½”ë“œ ìµœì í™”ë§Œ)

**íš¨ê³¼**:
- ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ 70% ê°ì†Œ
- ë™ì‹œ ì—…ë¡œë“œ ì œí•œìœ¼ë¡œ ì„œë²„ ì•ˆì •ì„± í–¥ìƒ

---

## 2. ì½”ë“œ ìˆ˜ì • ì—†ì´ ì„¤ì •ë§Œ ë³€ê²½

### âœ… í•´ê²°ì±… 8: Next.js ìºì‹± í™œìš© (ë¹„ìš© 0ì›)

**ë¬¸ì œ**: ìì£¼ ì¡°íšŒë˜ëŠ” ë°ì´í„° ìºì‹± ì—†ìŒ

**í•´ê²° ë°©ë²•**: Next.jsì˜ `fetch` ìºì‹± í™œìš© (ì´ë¯¸ ì¼ë¶€ ì‚¬ìš© ì¤‘)

**ì ìš© ì˜ˆì‹œ** (`app/api/user/profile/route.ts`):
```typescript
// ê¸°ì¡´ ì½”ë“œ
const userFromDb = await prisma.user.findUnique({...});

// ê°œì„  í›„ (ìºì‹± ì¶”ê°€)
const userFromDb = await prisma.user.findUnique({
  where: { id: parseInt(session.userId) },
  select: {...},
});

// Next.js fetch ìºì‹± í™œìš© (ë‹¤ë¥¸ API í˜¸ì¶œ ì‹œ)
const tripsResponse = await fetch('/api/trips/active', {
  next: { revalidate: 60 } // 60ì´ˆ ìºì‹œ
});
```

**ë¹„ìš©**: 0ì› (Next.js ê¸°ë³¸ ê¸°ëŠ¥)

**íš¨ê³¼**:
- ë¶ˆí•„ìš”í•œ DB ì¿¼ë¦¬ ê°ì†Œ
- ì‘ë‹µ ì†ë„ í–¥ìƒ

---

## 3. ì¸ë©”ëª¨ë¦¬ ìµœì í™” (ë¹„ìš© 0ì›)

### âœ… í•´ê²°ì±… 9: ì„¸ì…˜ ìƒì„± ìµœì í™” (ë¹„ìš© 0ì›)

**ë¬¸ì œ**: ë™ì‹œ ë¡œê·¸ì¸ ì‹œ ì„¸ì…˜ ìƒì„± race condition

**í•´ê²° ë°©ë²•**: ì„¸ì…˜ ID ìƒì„± ì‹œ íƒ€ì„ìŠ¤íƒ¬í”„ + ëœë¤ ì¡°í•©ìœ¼ë¡œ ì¶©ëŒ ë°©ì§€

**ì½”ë“œ ì˜ˆì‹œ** (`app/api/auth/login/route.ts`):
```typescript
// ê¸°ì¡´ ì½”ë“œ
const sessionId = randomBytes(32).toString('hex');

// ê°œì„  í›„ (ì¶©ëŒ ê°€ëŠ¥ì„± ê±°ì˜ 0)
const sessionId = `${Date.now()}-${randomBytes(16).toString('hex')}-${user.id}`;

// ë˜ëŠ” ë” ì•ˆì „í•˜ê²Œ
const sessionId = `${user.id}-${Date.now()}-${Math.random().toString(36).substring(2, 15)}`;
```

**ë¹„ìš©**: 0ì› (ì½”ë“œ ìˆ˜ì •ë§Œ)

**íš¨ê³¼**:
- ì„¸ì…˜ ID ì¶©ëŒ ê°€ëŠ¥ì„± ê±°ì˜ 0
- Race condition ë°©ì§€

---

## 4. AI ê¸°ëŠ¥ ë³´í˜¸ ì „ëµ

### âœ… AI ê¸°ëŠ¥ ì†ì‹¤ ë°©ì§€ ì²´í¬ë¦¬ìŠ¤íŠ¸

1. **Gemini API ìš”ì²­ í** (í•´ê²°ì±… 5)
   - âœ… Rate limit ì´ˆê³¼ ë°©ì§€
   - âœ… ìš”ì²­ ìˆœì°¨ ì²˜ë¦¬

2. **ë²„í¼ í¬ê¸° ì¦ê°€** (í•´ê²°ì±… 4)
   - âœ… ê¸´ ì‘ë‹µë„ ì†ì‹¤ ì—†ì´ ì „ë‹¬

3. **ì—ëŸ¬ í•¸ë“¤ë§ ê°•í™”**
   ```typescript
   // app/api/chat/stream/route.ts
   try {
     // Gemini API í˜¸ì¶œ
   } catch (error: any) {
     // Rate limit ì—ëŸ¬ì¸ ê²½ìš° ì¬ì‹œë„ íì— ì¶”ê°€
     if (error.message?.includes('rate limit')) {
       // íì— ì¬ì‹œë„ ìš”ì²­ ì¶”ê°€
       return geminiQueue.add(() => /* ì¬ì‹œë„ */);
     }
     
     // ë‹¤ë¥¸ ì—ëŸ¬ëŠ” ì‚¬ìš©ìì—ê²Œ ëª…í™•í•œ ë©”ì‹œì§€
     return new Response(JSON.stringify({ 
       error: 'AI ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.' 
     }), { status: 500 });
   }
   ```

4. **Fallback ë©”ì‹œì§€ ì œê³µ**
   ```typescript
   // AI ì‘ë‹µ ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ì‘ë‹µ ì œê³µ
   if (!hasSentData) {
     const fallbackMessage = 'ì£„ì†¡í•©ë‹ˆë‹¤. í˜„ì¬ AI ì„œë¹„ìŠ¤ê°€ ì¼ì‹œì ìœ¼ë¡œ ì‚¬ìš© ë¶ˆê°€í•©ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
     controller.enqueue(new TextEncoder().encode(`0:${JSON.stringify(fallbackMessage)}\n`));
   }
   ```

---

## 5. ë‹¨ê³„ë³„ ì ìš© ê°€ì´ë“œ

### Phase 1: ì¦‰ì‹œ ì ìš© (1ì¼ ë‚´)

1. âœ… **DB Connection Pool ì„¤ì •**
   - Vercel í™˜ê²½ ë³€ìˆ˜ì—ì„œ `DATABASE_URL` ìˆ˜ì •
   - `?connection_limit=50&pool_timeout=20` ì¶”ê°€

2. âœ… **ë²„í¼ í¬ê¸° ì¦ê°€**
   - `app/api/chat/stream/route.ts` ìˆ˜ì •
   - 1MB â†’ 5MBë¡œ ì¦ê°€

3. âœ… **ì„¸ì…˜ ID ìƒì„± ê°œì„ **
   - `app/api/auth/login/route.ts` ìˆ˜ì •
   - íƒ€ì„ìŠ¤íƒ¬í”„ + ëœë¤ ì¡°í•©

### Phase 2: 1ì£¼ì¼ ë‚´ ì ìš©

4. âœ… **ì¸ë©”ëª¨ë¦¬ ìºì‹± ë„ì…**
   - `lib/cache.ts` ìƒì„±
   - `app/api/chat/stream/route.ts`ì— ì ìš©

5. âœ… **Gemini API ìš”ì²­ í**
   - `lib/gemini-queue.ts` ìƒì„±
   - `app/api/chat/stream/route.ts`ì— ì ìš©

6. âœ… **Rate Limiter ê°œì„ **
   - ì‚¬ìš©ì ID ê¸°ë°˜ rate limiting ì¶”ê°€
   - `app/api/auth/login/route.ts` ìˆ˜ì •

### Phase 3: ì ì§„ì  ê°œì„ 

7. âœ… **ë™ì‹œ ì—…ë°ì´íŠ¸ Race Condition í•´ê²°**
   - ë‚™ê´€ì  ì ê¸ˆ ì ìš©
   - `app/api/checklist/route.ts`, `app/api/expenses/route.ts` ìˆ˜ì •

8. âœ… **íŒŒì¼ ì—…ë¡œë“œ ìµœì í™”**
   - `lib/upload-queue.ts` ìƒì„±
   - `app/api/passport/[token]/upload/route.ts` ìˆ˜ì •

---

## 6. ë¹„ìš© ìš”ì•½

| í•´ê²°ì±… | ë¹„ìš© | íš¨ê³¼ |
|--------|------|------|
| DB Connection Pool ì„¤ì • | 0ì› | 100ëª… ë™ì‹œ ì‚¬ìš© ê°€ëŠ¥ |
| Rate Limiter ê°œì„  | 0ì› | ê³µì •í•œ rate limiting |
| ì¸ë©”ëª¨ë¦¬ ìºì‹± | 0ì› | DB ë¶€í•˜ 90% ê°ì†Œ |
| ë²„í¼ í¬ê¸° ì¦ê°€ | 0ì› | AI ì‘ë‹µ ì†ì‹¤ ë°©ì§€ |
| Gemini API ìš”ì²­ í | 0ì› | Rate limit ì´ˆê³¼ ë°©ì§€ |
| ë™ì‹œ ì—…ë°ì´íŠ¸ í•´ê²° | 0ì› | ë°ì´í„° ì†ì‹¤ ë°©ì§€ |
| íŒŒì¼ ì—…ë¡œë“œ ìµœì í™” | 0ì› | ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ 70% ê°ì†Œ |
| ì„¸ì…˜ ìƒì„± ìµœì í™” | 0ì› | Race condition ë°©ì§€ |

**ì´ ë¹„ìš©: 0ì›**

---

## 7. ì˜ˆìƒ íš¨ê³¼

### ì„±ëŠ¥ ê°œì„ 
- âœ… DB ì¿¼ë¦¬ 90% ê°ì†Œ (ìºì‹±)
- âœ… ì‘ë‹µ ì†ë„ 50% í–¥ìƒ
- âœ… ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ 70% ê°ì†Œ (íŒŒì¼ ì—…ë¡œë“œ)

### ì•ˆì •ì„± ê°œì„ 
- âœ… 100ëª… ë™ì‹œ ì‚¬ìš© ê°€ëŠ¥
- âœ… AI ê¸°ëŠ¥ ì™„ì „ ë³´í˜¸
- âœ… ë°ì´í„° ì†ì‹¤ ë°©ì§€

### ì‚¬ìš©ì ê²½í—˜ ê°œì„ 
- âœ… ë¹ ë¥¸ ì‘ë‹µ ì†ë„
- âœ… ì•ˆì •ì ì¸ ì„œë¹„ìŠ¤
- âœ… AI ê¸°ëŠ¥ í•­ìƒ ì‚¬ìš© ê°€ëŠ¥

---

## 8. ì£¼ì˜ì‚¬í•­

1. **ì¸ë©”ëª¨ë¦¬ ìºì‹±ì˜ í•œê³„**
   - ì„œë²„ ì¬ì‹œì‘ ì‹œ ìºì‹œ ì´ˆê¸°í™”
   - ì—¬ëŸ¬ ì¸ìŠ¤í„´ìŠ¤ ê°„ ìºì‹œ ê³µìœ  ë¶ˆê°€
   - í•˜ì§€ë§Œ Vercelì˜ ê²½ìš° ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ì¶©ë¶„íˆ íš¨ê³¼ì 

2. **ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§**
   - ìºì‹œ í¬ê¸° ì œí•œ ì„¤ì • ê¶Œì¥
   - ì •ê¸°ì ì¸ ìºì‹œ ì •ë¦¬ í•„ìš”

3. **ì ì§„ì  ì ìš©**
   - í•œ ë²ˆì— ëª¨ë“  ê²ƒì„ ì ìš©í•˜ì§€ ë§ê³  ë‹¨ê³„ì ìœ¼ë¡œ
   - ê° ë‹¨ê³„ë§ˆë‹¤ í…ŒìŠ¤íŠ¸ ìˆ˜í–‰

---

## 9. ê²°ë¡ 

**ëª¨ë“  ë¬¸ì œë¥¼ ë¹„ìš© ì¶”ê°€ ì—†ì´ í•´ê²° ê°€ëŠ¥í•©ë‹ˆë‹¤!**

- âœ… DB Connection Pool: í™˜ê²½ ë³€ìˆ˜ ìˆ˜ì •ë§Œ
- âœ… Rate Limiter: ì½”ë“œ ê°œì„ ë§Œ
- âœ… ìºì‹±: ì¸ë©”ëª¨ë¦¬ ìºì‹± (ë¬´ë£Œ)
- âœ… AI ê¸°ëŠ¥ ë³´í˜¸: ìš”ì²­ í + ë²„í¼ ì¦ê°€
- âœ… ë™ì‹œì„± ë¬¸ì œ: ë‚™ê´€ì  ì ê¸ˆ (Prisma ê¸°ë³¸ ê¸°ëŠ¥)

**í¬ë£¨ì¦ˆ ê°€ì´ë“œ ì§€ë‹ˆ AI ê¸°ëŠ¥ì€ ì™„ì „íˆ ë³´í˜¸ë˜ë©°, 100ëª… ë™ì‹œ ì‚¬ìš©ë„ ì•ˆì •ì ìœ¼ë¡œ ì²˜ë¦¬ ê°€ëŠ¥í•©ë‹ˆë‹¤.**

---

**ì‘ì„±ì**: AI Assistant  
**ê²€í†  í•„ìš”**: ê°œë°œíŒ€ ë¦¬ë·° ë° ì ìš© ê³„íš ìˆ˜ë¦½


