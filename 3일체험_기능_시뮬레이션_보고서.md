# 크루즈가이드지니 3일 체험 기능 시뮬레이션 보고서

**작성 일시**: 2025년 1월 28일  
**시뮬레이션 범위**: 3일 체험 사용자 100명 동시 사용 시나리오  
**검증 항목**: 3일 체험 기능별 에러, 72시간 카운트다운, 만료 처리, 동시성 문제

---

## 📋 목차

1. [3일 체험 로그인 시나리오](#1-3일-체험-로그인-시나리오)
2. [72시간 카운트다운 기능](#2-72시간-카운트다운-기능)
3. [3일 체험 사용자 기능 사용](#3-3일-체험-사용자-기능-사용)
4. [만료 처리 및 완료 안내](#4-만료-처리-및-완료-안내)
5. [동시성 문제](#5-동시성-문제)
6. [종합 권장사항](#6-종합-권장사항)

---

## 1. 3일 체험 로그인 시나리오

### ✅ 정상 동작 시나리오

**시나리오 1-1: 신규 3일 체험 사용자 로그인**
- 입력: 이름="홍길동", 전화번호="01012345678", 비밀번호="1101"
- 예상 동작: 
  - ✅ 신규 사용자 생성
  - ✅ `testModeStartedAt` 현재 시간으로 설정
  - ✅ `customerSource: 'test-guide'` 설정
  - ✅ 로그인 성공
- **발견된 문제**: 없음

**시나리오 1-2: 기존 사용자가 3일 체험으로 전환**
- 입력: 기존 전화번호 + 비밀번호="1101"
- 예상 동작:
  - ✅ 기존 사용자 찾기
  - ✅ `testModeStartedAt` 현재 시간으로 설정 (없는 경우)
  - ✅ `customerSource: 'test-guide'`로 변경
  - ✅ 비밀번호를 1101로 업데이트
  - ✅ 로그인 성공
- **발견된 문제**: 없음

**시나리오 1-3: 3일 체험 만료 후 재로그인**
- 입력: 만료된 3일 체험 사용자 + 비밀번호="1101"
- 예상 동작:
  - ✅ 로그인 허용 (완료 안내를 볼 수 있도록)
  - ✅ `customerStatus: 'test-locked'` 설정
  - ✅ `testModeExpired: true` 반환
  - ✅ `testModeRemainingHours: 0` 반환
- **발견된 문제**: 없음

### ⚠️ 발견된 문제점

#### 🔴 심각 (Critical)

**문제 1-1: 100명이 동시에 3일 체험 로그인 시 DB 부하**
- **위치**: `app/api/auth/login/route.ts` (361-550번 줄)
- **문제**: 
  - 각 로그인마다 `testModeStartedAt` 확인 및 업데이트
  - 전화번호로 사용자 검색 (인덱스 없을 수 있음)
  - 100명 동시 로그인 시 DB 쿼리 폭증
- **영향**: 로그인 응답 지연 또는 타임아웃
- **해결 방안**: 
  - 전화번호 필드에 인덱스 추가
  - `testModeStartedAt` 필드에 인덱스 추가
  - 트랜잭션 사용으로 중복 생성 방지

**문제 1-2: 동시 로그인 시 testModeStartedAt 중복 설정**
- **위치**: `app/api/auth/login/route.ts` (492-497번 줄)
- **문제**: 
  - 여러 요청이 동시에 같은 사용자를 찾아 `testModeStartedAt` 설정 시도
  - Race Condition 발생 가능
- **영향**: 일부 사용자의 `testModeStartedAt`이 잘못 설정될 수 있음
- **해결 방안**: 
  ```typescript
  // 트랜잭션 사용 또는 Optimistic Locking
  await prisma.$transaction(async (tx) => {
    const user = await tx.user.findUnique({ where: { phone } });
    if (!user.testModeStartedAt) {
      await tx.user.update({
        where: { id: user.id },
        data: { testModeStartedAt: now }
      });
    }
  });
  ```

**문제 1-3: 3일 체험 로그인 시 Rate Limiting이 IP 기반**
- **위치**: `app/api/auth/login/route.ts` (20-43번 줄)
- **문제**: 
  - Rate Limiting이 IP 기반으로 동작
  - 같은 공용 Wi-Fi에서 여러 사용자가 로그인하면 제한될 수 있음
- **영향**: 정상 사용자가 로그인 제한될 수 있음
- **해결 방안**: 3일 체험 로그인은 Rate Limiting 완화 또는 제외

#### 🟡 중간 (Medium)

**문제 1-4: testModeStartedAt이 null인 경우 처리**
- **위치**: `app/api/auth/login/route.ts` (492-497번 줄)
- **문제**: 
  - `testModeStartedAt`이 null이면 현재 시간으로 설정
  - 하지만 이미 만료된 사용자가 재로그인하면 새로운 72시간이 시작될 수 있음
- **영향**: 만료된 사용자가 다시 72시간 사용 가능해질 수 있음
- **해결 방안**: 만료 여부 확인 후 `testModeStartedAt` 설정

---

## 2. 72시간 카운트다운 기능

### ✅ 정상 동작 시나리오

**시나리오 2-1: 카운트다운 표시**
- 입력: 3일 체험 사용자 로그인
- 예상 동작:
  - ✅ `TutorialCountdown` 컴포넌트에서 남은 시간 표시
  - ✅ 실시간으로 카운트다운 업데이트
- **발견된 문제**: 없음

**시나리오 2-2: 카운트다운 만료**
- 입력: 72시간 경과
- 예상 동작:
  - ✅ 카운트다운이 0으로 표시
  - ✅ 완료 안내 메시지 표시
- **발견된 문제**: 없음

### ⚠️ 발견된 문제점

#### 🔴 심각 (Critical)

**문제 2-1: 100명이 동시에 access-check API 호출**
- **위치**: `app/api/user/access-check/route.ts`
- **문제**: 
  - 각 페이지 로드마다 `access-check` API 호출
  - 100명이 동시에 호출하면 DB 부하 증가
  - `testModeStartedAt` 조회 및 계산 반복
- **영향**: 
  - API 응답 지연
  - DB 연결 부족
- **해결 방안**: 
  - 클라이언트 측에서 캐싱 (5분 정도)
  - 서버 측에서 캐싱 (Redis 등)
  - 배치 처리

**문제 2-2: 카운트다운 계산이 서버 시간 기준**
- **위치**: `app/api/user/access-check/route.ts` (43-59번 줄)
- **문제**: 
  - 서버 시간과 클라이언트 시간이 다를 수 있음
  - 클라이언트에서 카운트다운 계산 시 불일치 발생
- **영향**: 사용자에게 잘못된 남은 시간 표시
- **해결 방안**: 
  - 서버에서 남은 시간(밀리초)을 반환
  - 클라이언트에서 서버 시간 기준으로 계산

#### 🟡 중간 (Medium)

**문제 2-3: 카운트다운 업데이트 빈도**
- **위치**: `TutorialCountdown` 컴포넌트 (추정)
- **문제**: 
  - 1초마다 업데이트하면 불필요한 리렌더링
  - 100명이 동시에 업데이트하면 성능 저하
- **영향**: 브라우저 성능 저하
- **해결 방안**: 
  - 1분 단위로 업데이트 (마지막 1시간만 1초 단위)
  - `requestAnimationFrame` 사용

---

## 3. 3일 체험 사용자 기능 사용

### ✅ 정상 동작 시나리오

**시나리오 3-1: AI 채팅 사용**
- 입력: "크루즈 여행 준비물 알려줘"
- 예상 동작: ✅ Gemini API 호출 후 응답 반환
- **발견된 문제**: 없음

**시나리오 3-2: 이미지 업로드**
- 입력: 메뉴판 사진
- 예상 동작: ✅ Gemini Vision API 호출 후 번역 결과 반환
- **발견된 문제**: 없음

**시나리오 3-3: 체크리스트 사용**
- 입력: 항목 추가/체크
- 예상 동작: ✅ DB에 저장 및 반영
- **발견된 문제**: 없음

**시나리오 3-4: 가계부 사용**
- 입력: 지출 항목 추가
- 예상 동작: ✅ DB에 저장 및 반영
- **발견된 문제**: 없음

### ⚠️ 발견된 문제점

#### 🔴 심각 (Critical)

**문제 3-1: 100명이 동시에 AI 채팅 사용 시 API 할당량 초과**
- **위치**: `app/api/chat/stream/route.ts`
- **문제**: 
  - Gemini API 할당량 제한
  - 100명이 동시에 채팅하면 할당량 초과
- **영향**: 일부 사용자가 "API 키 오류" 메시지 수신
- **해결 방안**: 
  - 요청 큐 시스템
  - 배치 처리
  - 사용자별 Rate Limiting

**문제 3-2: 3일 체험 사용자도 일반 사용자와 동일한 기능 사용**
- **위치**: 모든 기능 API
- **문제**: 
  - 3일 체험 사용자에 대한 제한이 없음
  - 모든 기능을 무제한 사용 가능
- **영향**: 
  - API 비용 증가
  - 서버 부하 증가
- **해결 방안**: 
  - 3일 체험 사용자에 대한 사용량 제한
  - 일일 사용량 제한 (예: AI 채팅 50회/일)

**문제 3-3: 만료된 3일 체험 사용자가 기능 사용 가능**
- **위치**: 기능 API들 (체크리스트, 가계부 등)
- **문제**: 
  - `access-check` API는 확인하지만, 각 기능 API에서 재확인하지 않음
  - 만료된 사용자도 기능 사용 가능
- **영향**: 만료된 사용자가 계속 사용 가능
- **해결 방안**: 
  - 각 기능 API에서 `access-check` 또는 만료 여부 확인
  - 미들웨어에서 통합 확인

#### 🟡 중간 (Medium)

**문제 3-4: 3일 체험 사용자 데이터 정리**
- **위치**: 전체 시스템
- **문제**: 
  - 3일 체험 사용자 데이터가 계속 쌓임
  - 만료 후에도 데이터 유지
- **영향**: 
  - DB 용량 증가
  - 성능 저하
- **해결 방안**: 
  - 만료 후 30일 경과 시 데이터 정리
  - Cron Job으로 주기적 정리

---

## 4. 만료 처리 및 완료 안내

### ✅ 정상 동작 시나리오

**시나리오 4-1: 만료 안내 표시**
- 입력: 72시간 경과 후 로그인
- 예상 동작:
  - ✅ 로그인 허용
  - ✅ 완료 안내 배너 표시
  - ✅ "정식 서비스 구매하기" 버튼 표시
- **발견된 문제**: 없음

**시나리오 4-2: 만료 후 기능 사용 제한**
- 입력: 만료된 사용자가 기능 사용 시도
- 예상 동작:
  - ✅ `access-check` API에서 `allowed: false` 반환
  - ✅ 기능 사용 제한
- **발견된 문제**: 없음 (하지만 실제로는 제한이 없을 수 있음 - 문제 3-3 참조)

### ⚠️ 발견된 문제점

#### 🔴 심각 (Critical)

**문제 4-1: 만료 여부 확인이 매번 DB 조회**
- **위치**: `app/api/user/access-check/route.ts` (43-59번 줄)
- **문제**: 
  - 매번 `testModeStartedAt` 조회 및 계산
  - 100명이 동시에 확인하면 DB 부하
- **영향**: 
  - API 응답 지연
  - DB 연결 부족
- **해결 방안**: 
  - 클라이언트 측 캐싱
  - 서버 측 캐싱 (Redis)
  - 계산 결과를 세션에 저장

**문제 4-2: 만료된 사용자가 기능 사용 가능 (문제 3-3과 동일)**
- **위치**: 기능 API들
- **문제**: 
  - `access-check` API는 확인하지만, 각 기능 API에서 재확인하지 않음
- **영향**: 만료된 사용자가 계속 사용 가능
- **해결 방안**: 
  - 각 기능 API에서 만료 여부 확인
  - 미들웨어에서 통합 확인

#### 🟡 중간 (Medium)

**문제 4-3: 완료 안내 메시지가 명확하지 않음**
- **위치**: `TestChatInteractiveUI` 컴포넌트 (추정)
- **문제**: 
  - 완료 안내 메시지가 사용자에게 명확하지 않을 수 있음
  - 다음 단계가 불명확할 수 있음
- **영향**: 사용자 혼란
- **해결 방안**: 
  - 더 명확한 안내 메시지
  - 단계별 가이드 제공

---

## 5. 동시성 문제

### ⚠️ 발견된 문제점

#### 🔴 심각 (Critical)

**문제 5-1: 100명이 동시에 로그인 시 DB 연결 부족**
- **위치**: `app/api/auth/login/route.ts`
- **문제**: 
  - Prisma 연결 풀 설정 없음
  - 100명 동시 로그인 시 연결 부족
- **영향**: 
  - 로그인 실패
  - 타임아웃 에러
- **해결 방안**: 
  ```typescript
  const prisma = new PrismaClient({
    datasources: {
      db: {
        url: process.env.DATABASE_URL + '?connection_limit=20&pool_timeout=20'
      }
    }
  });
  ```

**문제 5-2: testModeStartedAt 동시 설정 시 Race Condition**
- **위치**: `app/api/auth/login/route.ts` (492-497번 줄)
- **문제**: 
  - 여러 요청이 동시에 같은 사용자를 찾아 `testModeStartedAt` 설정
  - Race Condition 발생
- **영향**: 일부 사용자의 `testModeStartedAt`이 잘못 설정
- **해결 방안**: 트랜잭션 사용

**문제 5-3: 100명이 동시에 access-check API 호출**
- **위치**: `app/api/user/access-check/route.ts`
- **문제**: 
  - 각 페이지 로드마다 API 호출
  - 100명이 동시에 호출하면 DB 부하
- **영향**: 
  - API 응답 지연
  - DB 연결 부족
- **해결 방안**: 
  - 클라이언트 측 캐싱
  - 서버 측 캐싱

---

## 6. 종합 권장사항

### 🔴 즉시 수정 필요 (Critical)

1. **데이터베이스 연결 풀 설정**
   - Prisma 연결 풀 크기 제한 설정
   - 연결 타임아웃 설정

2. **testModeStartedAt 동시 설정 방지**
   - 트랜잭션 사용
   - Optimistic Locking 적용

3. **access-check API 캐싱**
   - 클라이언트 측 캐싱 (5분)
   - 서버 측 캐싱 (Redis)

4. **만료된 사용자 기능 사용 제한**
   - 각 기능 API에서 만료 여부 확인
   - 미들웨어에서 통합 확인

5. **3일 체험 사용자 사용량 제한**
   - 일일 사용량 제한 (AI 채팅 50회/일 등)
   - API 비용 관리

### 🟡 단기 개선 (Medium)

1. **인덱스 추가**
   - `phone` 필드에 인덱스
   - `testModeStartedAt` 필드에 인덱스

2. **카운트다운 최적화**
   - 업데이트 빈도 조정
   - 서버 시간 기준 계산

3. **데이터 정리**
   - 만료 후 30일 경과 시 데이터 정리
   - Cron Job으로 주기적 정리

4. **완료 안내 개선**
   - 더 명확한 안내 메시지
   - 단계별 가이드 제공

### 🟢 장기 개선 (Low)

1. **모니터링 강화**
   - 3일 체험 사용자 수 모니터링
   - API 사용량 모니터링
   - 만료율 모니터링

2. **분석 도구**
   - 3일 체험 사용자 행동 분석
   - 전환율 분석

---

## 📊 예상 문제 발생률 (100명 동시 사용 시)

| 문제 유형 | 예상 발생률 | 심각도 |
|---------|-----------|--------|
| DB 연결 부족 | 40-60% | 🔴 Critical |
| access-check API 부하 | 50-70% | 🔴 Critical |
| Gemini API 할당량 초과 | 30-50% | 🔴 Critical |
| testModeStartedAt Race Condition | 5-10% | 🔴 Critical |
| 만료된 사용자 기능 사용 | 100% (현재 제한 없음) | 🔴 Critical |
| 카운트다운 불일치 | 10-20% | 🟡 Medium |

---

## ✅ 검증 완료 항목

1. ✅ 3일 체험 로그인 기본 동작
2. ✅ 72시간 카운트다운 기본 동작
3. ✅ 만료 안내 표시 기본 동작
4. ✅ 기능 사용 기본 동작

---

## 📝 결론

**현재 상태**: 3일 체험 기능은 기본적으로 정상 동작하지만, **100명 동시 사용 시 여러 문제가 발생할 것으로 예상됩니다.**

**주요 문제점**:
1. DB 연결 부족 (가장 심각)
2. access-check API 부하
3. 만료된 사용자 기능 사용 제한 없음
4. Gemini API 할당량 초과

**우선순위**:
1. 데이터베이스 연결 풀 설정 (최우선)
2. access-check API 캐싱
3. 만료된 사용자 기능 사용 제한
4. testModeStartedAt 동시 설정 방지
5. 3일 체험 사용자 사용량 제한

**예상 완료 시간**: 위 항목들을 모두 수정하면 약 2-3일 소요 예상

---

**보고서 작성 완료**: ✅  
**다음 단계**: 발견된 문제점들을 우선순위에 따라 수정 작업 진행


