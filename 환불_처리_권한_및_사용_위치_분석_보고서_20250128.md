# 환불 처리 권한 및 사용 위치 분석 보고서

> **작성일**: 2025년 1월 28일  
> **목적**: 환불 처리 기능의 현재 상태 및 권한 체크 분석

---

## 📋 현재 환불 처리 기능 위치

### 1. ✅ 환불 처리 API (관리자 전용)

**위치**: `/api/admin/affiliate/sales/[saleId]/refund`  
**파일**: `app/api/admin/affiliate/sales/[saleId]/refund/route.ts`

**권한 체크**: ✅ **관리자만 접근 가능**
```typescript
const admin = await prisma.user.findUnique({ where: { id: sessionUser.id }, select: { role: true } });
const guard = requireAdmin(admin?.role);
if (guard) return guard;
```

**기능**:
- 판매 건 환불 처리
- Lead 상태도 자동으로 'REFUNDED'로 업데이트
- 환불 사유 필수 입력
- 관리자 액션 로그 기록

**사용 위치**:
- 관리자 패널 > 어필리에이트 > 고객 > [고객 상세] > 환불 버튼
- 관리자 패널 > 어필리에이트 > 환불 관리 페이지

---

### 2. ⚠️ Lead 상태 변경 API (현재 문제 있음)

**위치**: `/api/admin/affiliate/leads/[leadId]/status`  
**파일**: `app/api/admin/affiliate/leads/[leadId]/status/route.ts`

**현재 권한 체크**: ❌ **관리자, 대리점장, 판매원 모두 접근 가능**
```typescript
// 권한 체크
if (user.role === 'admin') {
  // 관리자: 모든 Lead 상태 변경 가능
} else if (user.AffiliateProfile?.type === 'BRANCH_MANAGER') {
  // 대리점장: 본인 및 본인 판매원 Lead 상태 변경 가능
} else if (user.AffiliateProfile?.type === 'SALES_AGENT') {
  // 판매원: 본인 Lead 상태 변경 가능
}
```

**문제점**:
- ❌ 환불(REFUNDED) 상태로 변경하는 것도 대리점장/판매원이 가능함
- ❌ 환불은 관리자만 처리해야 하는데 현재는 제한이 없음

---

### 3. 고객 상세 페이지

**위치**: `/admin/affiliate/customers/[leadId]`  
**파일**: `app/admin/affiliate/customers/[leadId]/page.tsx`

**현재 상태**:
- ✅ 환불 버튼: `/api/admin/affiliate/sales/[saleId]/refund` 호출 (관리자 전용)
- ⚠️ 상태 변경 드롭다운: `/api/admin/affiliate/leads/[leadId]/status` 호출 (모든 권한 가능)

**문제점**:
- 상태 변경 드롭다운에 "환불" 옵션이 있으면, 대리점장/판매원도 선택 가능
- 하지만 실제 환불 처리는 관리자만 가능해야 함

---

## 🔍 구체적 사용 위치

### 관리자 패널에서 환불 처리 가능한 위치

#### 1. 고객 상세 페이지
**경로**: 관리자 패널 > 어필리에이트 > 고객 > [고객명 클릭]

**기능**:
- **환불 버튼**: 구매 건이 있는 경우 "환불 처리" 버튼 표시
  - 클릭 시 환불 모달 열림
  - 환불 사유 입력 필수
  - `/api/admin/affiliate/sales/[saleId]/refund` API 호출
  - ✅ **관리자만 접근 가능**

- **상태 변경 드롭다운**: 고객 상태를 직접 변경
  - "신규", "소통중", "진행중", "구매완료", **"환불"**, "종료", "3일체험" 등
  - `/api/admin/affiliate/leads/[leadId]/status` API 호출
  - ⚠️ **현재는 대리점장/판매원도 접근 가능 (문제)**

#### 2. 환불 관리 페이지
**경로**: 관리자 패널 > 어필리에이트 > 환불 관리

**기능**:
- 환불 처리된 판매 건 목록
- 환불 처리 기능
- ✅ **관리자만 접근 가능**

---

## ⚠️ 발견된 문제점

### 문제 1: Lead 상태 변경 API에서 환불 권한 체크 없음

**현재 상태**:
- 대리점장과 판매원도 Lead 상태를 "REFUNDED"로 변경 가능
- 환불은 관리자만 처리해야 하는데 제한이 없음

**해결 방법**:
```typescript
// 환불 상태로 변경하는 것은 관리자만 가능하도록 수정 필요
if (status === 'REFUNDED' && user.role !== 'admin') {
  return NextResponse.json({ ok: false, message: '환불 처리는 관리자만 가능합니다.' }, { status: 403 });
}
```

---

### 문제 2: 고객 상세 페이지에서 상태 변경 드롭다운

**현재 상태**:
- 상태 변경 드롭다운에 "환불" 옵션이 있음
- 대리점장/판매원도 이 페이지에 접근할 수 있다면 "환불" 선택 가능

**해결 방법**:
- 상태 변경 드롭다운에서 "환불" 옵션을 관리자에게만 표시
- 또는 대리점장/판매원이 이 페이지에 접근하지 못하도록 제한

---

## ✅ 올바른 환불 처리 흐름

### 관리자가 환불 처리하는 경우

1. **경로 1: 고객 상세 페이지에서 환불 버튼 클릭**
   ```
   관리자 패널 > 어필리에이트 > 고객 > [고객명 클릭] > 환불 버튼
   ```
   - 환불 모달 열림
   - 환불 사유 입력
   - `/api/admin/affiliate/sales/[saleId]/refund` 호출
   - ✅ 관리자만 접근 가능
   - Lead 상태 자동으로 'REFUNDED'로 변경
   - 본사에 이메일 알림 전송

2. **경로 2: 환불 관리 페이지에서 환불 처리**
   ```
   관리자 패널 > 어필리에이트 > 환불 관리
   ```
   - 환불 처리된 목록 확인
   - 환불 처리 기능 사용
   - ✅ 관리자만 접근 가능

---

## 🔧 수정 필요 사항

### 1. Lead 상태 변경 API 수정

**파일**: `app/api/admin/affiliate/leads/[leadId]/status/route.ts`

**수정 내용**:
- 환불(REFUNDED) 상태로 변경하는 것은 관리자만 가능하도록 권한 체크 추가

### 2. 고객 상세 페이지 수정 (선택사항)

**파일**: `app/admin/affiliate/customers/[leadId]/page.tsx`

**수정 내용**:
- 상태 변경 드롭다운에서 "환불" 옵션을 관리자에게만 표시
- 또는 대리점장/판매원 접근 제한

---

## 📊 최종 정리

### 현재 상태
- ✅ 환불 처리 API: 관리자만 접근 가능 (정상)
- ⚠️ Lead 상태 변경 API: 환불 상태 변경 시 권한 체크 없음 (수정 필요)
- ⚠️ 고객 상세 페이지: 상태 변경 드롭다운에 "환불" 옵션 있음 (수정 권장)

### 권장 수정
1. Lead 상태 변경 API에서 환불 권한 체크 추가
2. 고객 상세 페이지에서 "환불" 옵션을 관리자에게만 표시

---

**작성자**: AI Assistant  
**최종 업데이트**: 2025년 1월 28일

