# 쥬쥬 계정 무료체험 로그인 문제 분석 보고서

**작성일**: 2025년 1월
**분석 대상**: 쥬쥬 계정 (01022222222, 비밀번호 1101)
**문제**: 비밀번호 1101로 로그인 시 무료체험 채팅(`/chat-test`)으로 들어가야 하는데, 유료 버전(`/chat`)으로 로그인됨

---

## 1. 문제 현상

### 1.1 정상 동작
- **신규 사용자**: 비밀번호 1101로 로그인 → 무료체험 채팅(`/chat-test`)으로 정상 진입 ✅

### 1.2 문제 동작
- **쥬쥬 계정** (01022222222, 비밀번호 1101): 비밀번호 1101로 로그인 → **유료 버전**(`/chat`)으로 진입 ❌

---

## 2. 원인 분석

### 2.1 로그인 API 로직 구조

비밀번호 1101 입력 시 다음과 같은 처리 흐름을 따릅니다:

```357:361:app/api/auth/login/route.ts
    // 테스트 모드 비밀번호 (1101만 허용) - 관리자 모드에서는 제외
    // user1~user10 크루즈몰 계정은 제외 (아래에서 별도 처리)
    const isTestModePassword = TEST_MODE_PASSWORDS.includes(password);
    const isNotCruiseMallUser = !phone || !/^user(1[0]|[1-9])$/i.test(phone.trim());
    if (mode !== 'admin' && isTestModePassword && isNotCruiseMallUser) {
```

✅ **쥬쥬 계정은 이 조건을 통과**합니다:
- `mode !== 'admin'` ✅
- `isTestModePassword` (비밀번호 1101) ✅
- `isNotCruiseMallUser` (01022222222는 user1~user10이 아님) ✅

### 2.2 핵심 문제점

#### 문제 1: customerStatus가 기존 값으로 유지됨

```628:635:app/api/auth/login/route.ts
        // 테스트 모드 활성화
        // customerStatus는 기존 값 유지 (구매고객이 3일체험 하는 경우 'active' 유지)
        // 단, customerStatus가 없거나 'locked'인 경우에만 'test'로 설정
        // 72시간 경과 시 'test-locked'로 이미 설정되었으므로 덮어쓰지 않음
        const shouldSetTestStatus = !isExpired && (!testUser.customerStatus || testUser.customerStatus === 'locked');
        await prisma.user.update({
          where: { id: testUser.id },
          data: {
            ...(shouldSetTestStatus && { customerStatus: 'test' }), // 기존 상태가 있으면 유지, 72시간 경과 시에는 test-locked 유지
```

**문제점**:
- `shouldSetTestStatus` 조건이 `customerStatus`가 `null`이거나 `'locked'`일 때만 `'test'`로 설정
- **쥬쥬 계정의 `customerStatus`가 `'active'`인 경우, 이 조건을 통과하지 못함**
- 결과적으로 기존 `'active'` 상태가 유지되어 유료 고객으로 인식됨

#### 문제 2: customerSource가 기존 값으로 유지됨

```640:641:app/api/auth/login/route.ts
            customerSource: trialCode ? 'trial-invite-link' : (testUser.customerSource || 'test-guide'), // customerSource는 기존 값 유지 (구매고객이면 'cruise-guide' 유지)
            password: normalizedTestPassword, // 비밀번호는 항상 1101로 업데이트
```

**문제점**:
- `trialCode`가 없으면 `testUser.customerSource || 'test-guide'`로 설정
- **쥬쥬 계정의 `customerSource`가 `'cruise-guide'`인 경우, 그대로 유지됨**
- 결과적으로 유료 고객 소스로 인식됨

#### 문제 3: 리다이렉트 경로는 정상이지만 상태 값 문제

```920:922:app/api/auth/login/route.ts
        const userId = testUser.id;
        // 비밀번호 1101 = 크루즈 가이드 지니 3일 체험 → /chat-test로 강제 리다이렉트
        const next = '/chat-test';
```

**분석**:
- 리다이렉트 경로는 항상 `/chat-test`로 설정됨 ✅
- 하지만 실제 화면에서는 `customerStatus`나 `customerSource` 값에 따라 다른 UI를 보여줄 수 있음

---

## 3. 기대 동작 vs 실제 동작

### 3.1 기대 동작
비밀번호 **1101**로 로그인하면:
1. `customerStatus` → `'test'`로 설정
2. `customerSource` → `'test-guide'`로 설정
3. `testModeStartedAt` → 현재 시간으로 설정
4. `/chat-test`로 리다이렉트
5. 무료체험 채팅 화면 표시

### 3.2 실제 동작 (쥬쥬 계정)
비밀번호 **1101**로 로그인하면:
1. `customerStatus` → 기존 값(`'active'`) **유지** ❌
2. `customerSource` → 기존 값(`'cruise-guide'`) **유지** ❌
3. `testModeStartedAt` → 설정됨 ✅
4. `/chat-test`로 리다이렉트 ✅
5. 하지만 상태 값이 유료 고객이므로 유료 버전으로 표시됨 ❌

---

## 4. 코드 분석 상세

### 4.1 사용자 조회 로직

```371:389:app/api/auth/login/route.ts
        let testUser = await prisma.user.findFirst({
          where: {
            phone: phone || undefined,
            role: 'user',
            // password 조건 제거: 전화번호만으로 조회하여 어떤 비밀번호든 1101로 업데이트 가능
          },
          select: { 
            id: true, 
            name: true,
            phone: true,
            password: true, 
            role: true,
            onboarded: true, 
            loginCount: true, 
            customerStatus: true,
            testModeStartedAt: true,
            customerSource: true,
          },
        });
```

✅ **정상 동작**: 전화번호로 기존 사용자를 찾습니다.

### 4.2 기존 사용자 업데이트 로직

```469:492:app/api/auth/login/route.ts
        } else {
          // 기존 사용자: 이름/전화번호/비밀번호 업데이트 (입력한 값으로 업데이트, 중복이면 수정)
          // 비밀번호를 1101로 업데이트하여 무조건 로그인 가능하게 함
          await prisma.user.update({
            where: { id: testUser.id },
            data: {
              name: name || testUser.name, // 입력한 이름으로 업데이트
              phone: phone || testUser.phone, // 입력한 전화번호로 업데이트
              password: normalizedTestPassword, // 비밀번호를 1101로 업데이트 (무조건 로그인 가능)
            },
          });
          testUser.name = name || testUser.name;
          testUser.phone = phone || testUser.phone;
          testUser.password = normalizedTestPassword;
          
          // customerSource는 기존 값 유지 (구매고객이 3일체험 하는 경우 'cruise-guide' 유지)
          // 단, customerSource가 없으면 'test-guide'로 설정
          if (!testUser.customerSource) {
            await prisma.user.update({
              where: { id: testUser.id },
              data: { customerSource: 'test-guide' },
            });
            testUser.customerSource = 'test-guide';
          }
        }
```

**문제점**:
- `customerSource`가 이미 있으면 업데이트하지 않음
- 쥬쥬 계정이 `'cruise-guide'`로 설정되어 있으면 그대로 유지됨

---

## 5. 해결 방안

### 5.1 해결 원칙
**비밀번호 1101로 로그인하면 무조건 무료체험 모드로 전환되어야 함**

### 5.2 수정 사항

#### 수정 1: customerStatus를 무조건 'test'로 설정

```typescript
// 현재 코드 (문제)
const shouldSetTestStatus = !isExpired && (!testUser.customerStatus || testUser.customerStatus === 'locked');
await prisma.user.update({
  where: { id: testUser.id },
  data: {
    ...(shouldSetTestStatus && { customerStatus: 'test' }),
    // ...
  },
});

// 수정 코드 (해결)
const shouldSetTestStatus = !isExpired; // expired가 아니면 무조건 'test'
await prisma.user.update({
  where: { id: testUser.id },
  data: {
    ...(shouldSetTestStatus && { customerStatus: 'test' }),
    // ...
  },
});
```

#### 수정 2: customerSource를 무조건 'test-guide'로 설정

```typescript
// 현재 코드 (문제)
customerSource: trialCode ? 'trial-invite-link' : (testUser.customerSource || 'test-guide'),

// 수정 코드 (해결)
customerSource: trialCode ? 'trial-invite-link' : 'test-guide', // 무조건 'test-guide'로 설정
```

#### 수정 3: 기존 사용자 업데이트 시 customerSource도 업데이트

```typescript
// 현재 코드 (문제)
if (!testUser.customerSource) {
  await prisma.user.update({
    where: { id: testUser.id },
    data: { customerSource: 'test-guide' },
  });
  testUser.customerSource = 'test-guide';
}

// 수정 코드 (해결)
// customerSource가 무엇이든 무조건 'test-guide'로 업데이트
await prisma.user.update({
  where: { id: testUser.id },
  data: { customerSource: 'test-guide' },
});
testUser.customerSource = 'test-guide';
```

---

## 6. 영향 범위

### 6.1 영향받는 사용자
- 이미 유료 고객(`customerStatus: 'active'`, `customerSource: 'cruise-guide'`)으로 등록된 사용자가
- 비밀번호 1101로 무료체험을 시도하는 경우

### 6.2 예상 동작 변경
- **변경 전**: 기존 유료 고객 상태 유지 → 유료 버전으로 표시
- **변경 후**: 무료체험 모드로 전환 → 무료체험 버전으로 표시

---

## 7. 테스트 시나리오

### 7.1 시나리오 1: 신규 사용자 (정상)
- 입력: 이름=신규, 전화번호=01099999999, 비밀번호=1101
- 기대 결과: `customerStatus='test'`, `customerSource='test-guide'`, `/chat-test` 리다이렉트 ✅

### 7.2 시나리오 2: 쥬쥬 계정 (문제)
- 입력: 이름=쥬쥬, 전화번호=01022222222, 비밀번호=1101
- 현재 상태: `customerStatus='active'`, `customerSource='cruise-guide'`
- 기대 결과: `customerStatus='test'`, `customerSource='test-guide'`, `/chat-test` 리다이렉트
- 실제 결과: 기존 상태 유지, 유료 버전으로 표시 ❌

### 7.3 시나리오 3: 유료 고객이 무료체험 시도 (수정 후)
- 입력: 이름=유료고객, 전화번호=01011111111, 비밀번호=1101
- 기존 상태: `customerStatus='active'`, `customerSource='cruise-guide'`
- 기대 결과: `customerStatus='test'`, `customerSource='test-guide'`, `/chat-test` 리다이렉트 ✅

---

## 8. 결론

### 8.1 문제 요약
비밀번호 1101로 로그인해도 기존 사용자의 `customerStatus`와 `customerSource`가 유지되어 무료체험 모드로 전환되지 않는 문제가 있습니다.

### 8.2 근본 원인
1. `customerStatus` 업데이트 조건이 제한적 (`null` 또는 `'locked'`일 때만)
2. `customerSource` 업데이트가 선택적 (기존 값이 있으면 유지)
3. 기존 유료 고객의 상태가 우선되어 무료체험 모드로 전환되지 않음

### 8.3 해결 방법
**비밀번호 1101로 로그인하면 무조건 무료체험 모드(`customerStatus='test'`, `customerSource='test-guide'`)로 전환**하도록 로직을 수정해야 합니다.

---

## 9. 권장 수정 사항

1. ✅ `customerStatus` 업데이트 조건 변경: `'active'` 상태도 `'test'`로 전환
2. ✅ `customerSource` 무조건 업데이트: 기존 값이 있어도 `'test-guide'`로 설정
3. ✅ 기존 사용자 업데이트 로직 개선: 무료체험 모드로 강제 전환

---

## 10. 수정 완료 내역

### 10.1 수정 일시
2025년 1월

### 10.2 수정 내용

#### 수정 1: 기존 사용자 업데이트 시 customerSource 강제 전환
- **위치**: `app/api/auth/login/route.ts` 라인 469-493
- **변경 전**: `customerSource`가 기존 값으로 유지됨
- **변경 후**: 비밀번호 1101로 로그인하면 무조건 `customerSource='test-guide'`로 설정

```typescript
// 변경 전
if (!testUser.customerSource) {
  await prisma.user.update({
    where: { id: testUser.id },
    data: { customerSource: 'test-guide' },
  });
}

// 변경 후
customerSource: 'test-guide', // 무조건 무료체험 사용자로 전환 (유료 고객이어도 무시)
```

#### 수정 2: customerStatus 무조건 'test'로 전환
- **위치**: `app/api/auth/login/route.ts` 라인 627-643
- **변경 전**: `customerStatus`가 `null`이거나 `'locked'`일 때만 `'test'`로 설정
- **변경 후**: 72시간 경과가 아니면 무조건 `customerStatus='test'`로 설정

```typescript
// 변경 전
const shouldSetTestStatus = !isExpired && (!testUser.customerStatus || testUser.customerStatus === 'locked');

// 변경 후
const shouldSetTestStatus = !isExpired; // 72시간 경과가 아니면 무조건 'test'로 설정
```

#### 수정 3: customerSource 무조건 'test-guide'로 설정
- **위치**: `app/api/auth/login/route.ts` 라인 640
- **변경 전**: `trialCode`가 없으면 기존 `customerSource` 값 유지
- **변경 후**: `trialCode`가 없으면 무조건 `customerSource='test-guide'`로 설정

```typescript
// 변경 전
customerSource: trialCode ? 'trial-invite-link' : (testUser.customerSource || 'test-guide'),

// 변경 후
customerSource: trialCode ? 'trial-invite-link' : 'test-guide', // 무조건 무료체험 사용자로 전환
```

### 10.3 수정 효과

이제 **비밀번호 1101로 로그인하면 무조건 무료체험 사용자로 전환**됩니다:

1. ✅ 기존 유료 고객(`customerStatus='active'`, `customerSource='cruise-guide'`)이어도
2. ✅ 비밀번호 1101로 로그인하면
3. ✅ 무료체험 사용자(`customerStatus='test'`, `customerSource='test-guide'`)로 전환
4. ✅ `/chat-test` 무료체험 채팅으로 리다이렉트

### 10.4 테스트 시나리오

#### 시나리오: 쥬쥬 계정 (수정 후)
- 입력: 이름=쥬쥬, 전화번호=01022222222, 비밀번호=1101
- 기존 상태: `customerStatus='active'`, `customerSource='cruise-guide'`
- 수정 후 결과: `customerStatus='test'`, `customerSource='test-guide'`, `/chat-test` 리다이렉트 ✅

---

**보고서 작성 완료 및 수정 적용 완료**

