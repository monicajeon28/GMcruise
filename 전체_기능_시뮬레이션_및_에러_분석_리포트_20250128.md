# 크루즈 가이드 전체 기능 시뮬레이션 및 에러 분석 리포트
**작성일**: 2025-01-28  
**목적**: 실제 사용자 관점에서 모든 기능을 시뮬레이션하고, 100명 동시 사용 시나리오에서 발생할 수 있는 에러 및 성능 이슈 분석

---

## 📋 목차
1. [사용자 플로우 시뮬레이션](#1-사용자-플로우-시뮬레이션)
2. [발견된 주요 문제점](#2-발견된-주요-문제점)
3. [100명 동시 사용 시나리오 분석](#3-100명-동시-사용-시나리오-분석)
4. [세부 에러 및 개선 사항](#4-세부-에러-및-개선-사항)
5. [우선순위별 개선 방안](#5-우선순위별-개선-방안)

---

## 1. 사용자 플로우 시뮬레이션

### 1.1 일반 사용자 플로우
1. **랜딩 페이지 접속** → 공개 쇼핑몰
2. **로그인** → `/login` → `/api/auth/login`
3. **온보딩** → `/onboarding` (첫 로그인 시)
4. **메인 채팅 화면** → `/chat` → AI 지니와 대화
5. **기능 사용**:
   - 여권 업로드 (OCR)
   - 여행 준비 체크리스트
   - 여행 가계부
   - 통번역기
   - 내비게이션
   - 사진 검색

### 1.2 파트너/판매원 플로우
1. **파트너 로그인** → `/login` (mode=partner)
2. **대시보드** → `/partner/[partnerId]/dashboard`
3. **고객 관리** → `/partner/[partnerId]/customers`
4. **여권 요청** → 고객에게 링크 발송
5. **결제 관리** → `/api/partner/payments`

### 1.3 관리자 플로우
1. **관리자 로그인** → `/admin/login`
2. **대시보드** → `/admin/dashboard`
3. **고객 관리** → `/admin/customers`
4. **상품 관리** → `/admin/products`
5. **마케팅** → `/admin/marketing/customers`

---

## 2. 발견된 주요 문제점

### 🔴 Critical (즉시 수정 필요)

#### 2.1 데이터베이스 Connection Pool 미설정
**위치**: `lib/prisma.ts`
**문제점**:
- PrismaClient에 connection pool 설정이 없음
- 100명 동시 사용 시 DB 연결 부족 가능성
- 기본값으로는 최대 10개 연결만 사용 가능

**영향**:
- 동시 요청 시 "Too many connections" 에러 발생 가능
- 응답 지연 및 타임아웃 발생

**해결 방안**:
```typescript
const prisma =
  globalThis.__prisma ??
  new PrismaClient({
    log: ['error', 'warn'],
    datasources: {
      db: {
        url: process.env.DATABASE_URL,
      },
    },
  });

// DATABASE_URL에 connection pool 파라미터 추가 필요:
// ?connection_limit=20&pool_timeout=20
```

#### 2.2 Rate Limiter가 메모리 기반 (서버 인스턴스 간 공유 불가)
**위치**: `lib/rate-limiter.ts`
**문제점**:
- 메모리 기반 Map 사용
- 서버 재시작 시 초기화
- 여러 서버 인스턴스 간 공유 불가 (Vercel 등)

**영향**:
- 서버 재시작 시 rate limit 초기화
- 여러 인스턴스에서 동일 IP가 각각 제한 횟수 사용 가능
- DDoS 공격 방어 약화

**해결 방안**:
- Redis 기반 rate limiter로 전환
- 또는 Vercel Edge Config 활용

#### 2.3 세션 관리 Race Condition 가능성
**위치**: `app/api/auth/login/route.ts`
**문제점**:
- 동시 로그인 시 세션 생성 시 race condition 가능
- 쿠키 기반 세션 관리에서 동시성 문제

**영향**:
- 동일 사용자 동시 로그인 시 세션 충돌
- 로그인 실패 또는 세션 무효화

**해결 방안**:
- 트랜잭션 사용 또는 분산 락 적용

### 🟠 High (우선 수정 권장)

#### 2.4 스트리밍 API 버퍼 크기 제한
**위치**: `app/api/chat/stream/route.ts` (라인 499)
**문제점**:
- 버퍼 크기 1MB 제한
- 긴 응답 시 데이터 손실 가능

**영향**:
- 긴 AI 응답 시 일부 데이터 손실
- 사용자 경험 저하

**해결 방안**:
- 버퍼 크기 증가 또는 스트리밍 방식 개선

#### 2.5 파일 업로드 동시 처리 제한
**위치**: `app/api/passport/[token]/upload/route.ts`
**문제점**:
- 동시 업로드 시 메모리 부족 가능
- 파일 크기 10MB 제한이지만 동시 업로드 시 누적 메모리 사용

**영향**:
- 100명이 동시에 여권 업로드 시 서버 메모리 부족
- 업로드 실패 또는 서버 크래시

**해결 방안**:
- 업로드 큐 시스템 도입
- 또는 Vercel Blob Storage 직접 사용

#### 2.6 에러 핸들링 일관성 부족
**위치**: 전체 API 라우트
**문제점**:
- 일부 API는 상세한 에러 처리, 일부는 간단한 처리
- 에러 메시지 형식 불일치

**영향**:
- 디버깅 어려움
- 사용자에게 일관되지 않은 에러 메시지

**해결 방안**:
- 통일된 에러 핸들링 미들웨어 도입
- 에러 타입별 표준 응답 형식 정의

### 🟡 Medium (점진적 개선)

#### 2.7 트랜잭션 처리 일관성 부족
**위치**: 결제 및 주문 관련 API
**문제점**:
- 일부 API만 트랜잭션 사용
- 중간 실패 시 데이터 불일치 가능

**영향**:
- 결제 처리 중 오류 시 부분 완료 상태
- 데이터 정합성 문제

**해결 방안**:
- 모든 중요한 DB 작업에 트랜잭션 적용
- Prisma `$transaction` 사용

#### 2.8 WebSocket 연결 관리 미흡
**위치**: `server/socket-server.js`
**문제점**:
- 연결 해제 시 정리 로직 부족
- 메모리 누수 가능성

**영향**:
- 장시간 사용 시 메모리 누수
- 서버 재시작 필요

**해결 방안**:
- 연결 해제 이벤트 핸들러 추가
- 정기적인 연결 정리 로직

#### 2.9 타임아웃 설정 불일치
**위치**: 여러 API 라우트
**문제점**:
- API별 타임아웃 설정이 다름
- 일부는 타임아웃 없음

**영향**:
- 장시간 대기로 인한 리소스 점유
- 사용자 경험 저하

**해결 방안**:
- 통일된 타임아웃 정책 수립
- Next.js API route timeout 설정

---

## 3. 100명 동시 사용 시나리오 분석

### 3.1 시나리오 1: 동시 로그인 (100명)
**예상 문제**:
- DB 연결 풀 부족 (현재 최대 10개)
- Rate limiter가 IP 기반이라 동일 네트워크 사용자 차단 가능
- 세션 생성 race condition

**발생 가능 에러**:
```
Error: P2002: Unique constraint failed
Error: Too many connections
Error: Rate limit exceeded (잘못된 사용자까지 차단)
```

**해결 방안**:
1. DB connection pool 확대 (최소 50개)
2. Rate limiter를 사용자 ID 기반으로 변경
3. 세션 생성에 트랜잭션 적용

### 3.2 시나리오 2: 동시 AI 채팅 (100명)
**예상 문제**:
- Gemini API rate limit (분당 요청 수 제한)
- 스트리밍 응답 버퍼 오버플로우
- 메모리 사용량 급증

**발생 가능 에러**:
```
Error: Gemini API rate limit exceeded
Error: Buffer overflow
Error: Out of memory
```

**해결 방안**:
1. Gemini API 요청 큐 시스템 도입
2. 버퍼 크기 동적 조정
3. 응답 스트리밍 최적화

### 3.3 시나리오 3: 동시 파일 업로드 (100명)
**예상 문제**:
- 메모리 부족 (10MB × 100 = 1GB)
- Google Drive API rate limit
- 업로드 실패 시 재시도 로직 부족

**발생 가능 에러**:
```
Error: Out of memory
Error: Google Drive API rate limit
Error: Upload timeout
```

**해결 방안**:
1. 업로드 큐 시스템 (최대 10개 동시 처리)
2. 파일 스트리밍 업로드
3. 재시도 로직 추가

### 3.4 시나리오 4: 동시 결제 처리 (100명)
**예상 문제**:
- 트랜잭션 충돌
- 중복 결제 방지 로직 부족
- 결제 상태 업데이트 race condition

**발생 가능 에러**:
```
Error: Transaction conflict
Error: Duplicate payment
Error: Payment status mismatch
```

**해결 방안**:
1. 모든 결제 작업에 트랜잭션 적용
2. 중복 결제 방지 (unique constraint)
3. 낙관적 잠금(optimistic locking) 적용

### 3.5 시나리오 5: 동시 데이터 조회 (100명)
**예상 문제**:
- DB 쿼리 성능 저하
- 인덱스 부족으로 인한 느린 쿼리
- 캐싱 부재

**발생 가능 에러**:
```
Error: Query timeout
Error: Slow query (> 5초)
Error: Database connection pool exhausted
```

**해결 방안**:
1. 자주 조회되는 데이터 캐싱 (Redis)
2. 쿼리 최적화 및 인덱스 추가
3. 페이지네이션 강제

---

## 4. 세부 에러 및 개선 사항

### 4.1 인증 및 세션 관리

#### 문제 1: 세션 쿠키 보안
**위치**: `app/api/auth/login/route.ts`
**현재 상태**:
- 쿠키에 `httpOnly`, `secure`, `sameSite` 설정 확인 필요

**개선 사항**:
```typescript
cookies().set(SESSION_COOKIE, sessionId, {
  httpOnly: true,
  secure: process.env.NODE_ENV === 'production',
  sameSite: 'lax',
  maxAge: 60 * 60 * 24 * 7, // 7일
  path: '/',
});
```

#### 문제 2: 세션 만료 처리
**위치**: `lib/auth.ts`
**현재 상태**:
- 세션 만료 시 자동 정리 로직 확인 필요

**개선 사항**:
- Cron job으로 만료된 세션 정리
- 또는 Prisma에서 자동 삭제 (TTL)

### 4.2 데이터베이스 최적화

#### 문제 1: N+1 쿼리 문제
**위치**: 여러 API 라우트
**예시**: `app/api/partner/payments/route.ts` (라인 183-201)
**문제점**:
- `include` 사용하지만 중첩 관계에서 N+1 발생 가능

**개선 사항**:
- Prisma `include` 최적화
- 필요시 `select`로 필요한 필드만 조회

#### 문제 2: 인덱스 부족
**위치**: `prisma/schema.prisma`
**확인 필요**:
- 자주 조회되는 필드에 인덱스 추가
- 복합 인덱스 최적화

**개선 사항**:
```prisma
model Payment {
  // ...
  @@index([status, paidAt])
  @@index([affiliateCode, status])
  @@index([affiliateMallUserId, status])
}
```

### 4.3 API 성능 최적화

#### 문제 1: 불필요한 데이터 조회
**위치**: `app/api/chat/stream/route.ts` (라인 138-183)
**문제점**:
- 매 요청마다 상품 정보 조회 (캐싱 없음)

**개선 사항**:
- Redis 캐싱 도입
- 또는 Next.js 캐싱 활용

#### 문제 2: 응답 크기 최적화
**위치**: 여러 API 라우트
**문제점**:
- 불필요한 데이터 포함
- JSON 응답 크기 과다

**개선 사항**:
- 필요한 필드만 `select`로 조회
- 응답 압축 활성화 (이미 `compress: true` 설정됨)

### 4.4 에러 핸들링 개선

#### 문제 1: 에러 메시지 노출
**위치**: 전체 API 라우트
**문제점**:
- 개발 환경에서만 상세 에러 노출해야 함
- 프로덕션에서는 일반적인 메시지만

**개선 사항**:
```typescript
const errorMessage = process.env.NODE_ENV === 'development'
  ? error.message
  : '서버 오류가 발생했습니다. 잠시 후 다시 시도해주세요.';
```

#### 문제 2: 에러 로깅 일관성
**위치**: 전체 API 라우트
**문제점**:
- 일부는 `logger.error`, 일부는 `console.error`

**개선 사항**:
- 통일된 로거 사용
- 에러 추적 시스템 연동 (Sentry 등)

### 4.5 메모리 관리

#### 문제 1: 스트리밍 버퍼 관리
**위치**: `app/api/chat/stream/route.ts` (라인 499-502)
**현재 상태**:
- 1MB 제한 후 500KB만 유지

**개선 사항**:
- 버퍼 크기 동적 조정
- 또는 청크 단위로 즉시 처리

#### 문제 2: 파일 업로드 메모리 사용
**위치**: `app/api/passport/[token]/upload/route.ts`
**현재 상태**:
- 전체 파일을 메모리에 로드

**개선 사항**:
- 스트리밍 업로드로 변경
- 또는 Vercel Blob Storage 직접 사용

---

## 5. 우선순위별 개선 방안

### 🔴 Priority 1: 즉시 수정 (운영 안정성)

1. **DB Connection Pool 설정**
   - `DATABASE_URL`에 `?connection_limit=50&pool_timeout=20` 추가
   - Prisma 설정 확인

2. **Rate Limiter 개선**
   - Redis 기반으로 전환 (또는 Vercel Edge Config)
   - 사용자 ID 기반 rate limiting 추가

3. **에러 핸들링 통일**
   - 공통 에러 핸들러 미들웨어 생성
   - 프로덕션/개발 환경 분리

### 🟠 Priority 2: 1주일 내 수정 (성능 개선)

4. **트랜잭션 처리 강화**
   - 모든 결제/주문 관련 작업에 트랜잭션 적용
   - 중복 방지 로직 추가

5. **캐싱 도입**
   - 자주 조회되는 데이터 Redis 캐싱
   - 상품 정보, 사용자 정보 등

6. **쿼리 최적화**
   - 인덱스 추가
   - N+1 쿼리 문제 해결

### 🟡 Priority 3: 점진적 개선 (장기 안정성)

7. **파일 업로드 개선**
   - 업로드 큐 시스템
   - 스트리밍 업로드

8. **모니터링 강화**
   - 에러 추적 시스템 (Sentry)
   - 성능 모니터링 (Vercel Analytics)

9. **테스트 코드 작성**
   - 동시성 테스트
   - 부하 테스트

---

## 6. 체크리스트

### 즉시 확인 필요 사항
- [ ] `DATABASE_URL`에 connection pool 파라미터 확인
- [ ] Rate limiter가 프로덕션에서 제대로 작동하는지 확인
- [ ] 세션 쿠키 보안 설정 확인
- [ ] 에러 로깅이 모든 API에서 일관되게 작동하는지 확인

### 성능 테스트 필요 사항
- [ ] 100명 동시 로그인 테스트
- [ ] 100명 동시 AI 채팅 테스트
- [ ] 100명 동시 파일 업로드 테스트
- [ ] DB 연결 풀 부족 시나리오 테스트

### 모니터링 설정 필요 사항
- [ ] 에러 추적 시스템 연동
- [ ] 성능 메트릭 수집
- [ ] 알림 설정 (에러 발생 시)

---

## 7. 결론

현재 시스템은 기본적인 기능은 잘 구현되어 있으나, **100명 동시 사용 시나리오**에서는 다음과 같은 문제가 발생할 수 있습니다:

1. **DB 연결 부족** - 가장 우선적으로 해결 필요
2. **Rate limiter 한계** - Redis 기반으로 전환 권장
3. **메모리 관리** - 파일 업로드 및 스트리밍 최적화 필요
4. **에러 핸들링** - 통일된 시스템 구축 필요

**권장 사항**:
- 단계적으로 개선 사항 적용
- 각 단계마다 부하 테스트 수행
- 모니터링 시스템 구축 후 점진적 개선

---

**리포트 작성자**: AI Assistant  
**검토 필요**: 개발팀 리뷰 및 우선순위 조정


