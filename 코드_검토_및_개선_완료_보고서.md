# β… μ½”λ“ κ²€ν†  λ° κ°μ„  μ™„λ£ λ³΄κ³ μ„

**μ‘μ„±μΌ**: 2025-01-28  
**κ²€ν†  λ²”μ„**: νλ§¤μ› λ€μ‹λ³΄λ“ κ΄€λ ¨ μμ •λ λ¨λ“  νμΌ

---

## π” λ°κ²¬λ λ¬Έμ μ 

### 1. β Redis ν΄λΌμ΄μ–ΈνΈ μ¬μƒμ„± λ¬Έμ 
**μ„μΉ**: `lib/cache/partner-stats.ts`  
**λ¬Έμ **: `getRedisClient()` ν•¨μκ°€ νΈμ¶λ  λ•λ§λ‹¤ μƒλ΅μ΄ Redis ν΄λΌμ΄μ–ΈνΈ μΈμ¤ν„΄μ¤λ¥Ό μƒμ„±
- λ©”λ¨λ¦¬ λ„μ κ°€λ¥μ„±
- μ—°κ²° μ μ¦κ°€λ΅ μΈν• μ„±λ¥ μ €ν•
- μ—°κ²° ν’€ κ³ κ° μ„ν—

### 2. β οΈ setInterval λ©”λ¨λ¦¬ λ„μ κ°€λ¥μ„±
**μ„μΉ**: `lib/cache/partner-stats.ts`  
**λ¬Έμ **: μ„λ²„ μ¬μ‹μ‘ μ‹ setIntervalμ΄ λ„μ λ  μ μμ
- λ©”λ¨λ¦¬ λ„μ
- μ¤‘λ³µ μ‹¤ν–‰

### 3. β οΈ μΊμ‹ ν•¨μ λ‚΄λ¶€ dateFilter μ¤μ½”ν”„ λ¬Έμ 
**μ„μΉ**: `app/api/partner/dashboard/stats/route.ts`  
**λ¬Έμ **: μ™Έλ¶€μ—μ„ κ³„μ‚°ν• `dateFilter`λ¥Ό μΊμ‹ ν•¨μ λ‚΄λ¶€μ—μ„ μ‚¬μ©
- μΊμ‹ μΌκ΄€μ„± λ¬Έμ  κ°€λ¥μ„±
- κ°™μ€ μΊμ‹ ν‚¤λ΅ λ‹¤λ¥Έ λ°μ΄ν„° μΊμ‹± κ°€λ¥

### 4. β οΈ μ½”λ“ μΈλ΄νΈ λ¶μΌμΉ
**μ„μΉ**: `app/api/partner/dashboard/stats/route.ts`  
**λ¬Έμ **: Promise.all λ°°μ—΄ μΈλ΄νΈκ°€ μΌκ΄€λμ§€ μ•μ
- κ°€λ…μ„± μ €ν•

---

## β… μμ • μ™„λ£

### 1. β… Redis ν΄λΌμ΄μ–ΈνΈ μ‹±κΈ€ν†¤ ν¨ν„΄ μ μ©
**νμΌ**: `lib/cache/partner-stats.ts`

**μμ • λ‚΄μ©**:
- Redis ν΄λΌμ΄μ–ΈνΈλ¥Ό μ‹±κΈ€ν†¤μΌλ΅ λ³€κ²½
- λ™μ‹ μ”μ²­ μ‹ μ¬μ‚¬μ© λ³΄μ¥
- μ¬μ‹λ„ μ „λµ μ¶”κ°€
- μ—λ¬ ν•Έλ“¤λ§ κ°μ„ 

**μμ • μ „**:
```typescript
async function getRedisClient(): Promise<any | null> {
  try {
    const Redis = (await import('ioredis')).default;
    const redisUrl = process.env.REDIS_URL;
    if (redisUrl) {
      return new Redis(redisUrl); // λ§¤λ² μƒλ΅ μƒμ„±
    }
  } catch (error) {
    logger.log('[Partner Stats Cache] Redis not available, using memory cache');
  }
  return null;
}
```

**μμ • ν›„**:
```typescript
// Redis ν΄λΌμ΄μ–ΈνΈ μ‹±κΈ€ν†¤
let redisClient: any | null = null;
let redisClientPromise: Promise<any | null> | null = null;

async function getRedisClient(): Promise<any | null> {
  // μ΄λ―Έ ν΄λΌμ΄μ–ΈνΈκ°€ μμΌλ©΄ μ¬μ‚¬μ©
  if (redisClient) {
    return redisClient;
  }

  // μ΄λ―Έ μƒμ„± μ¤‘μ΄λ©΄ λ€κΈ°
  if (redisClientPromise) {
    return redisClientPromise;
  }

  // μƒλ΅ μƒμ„± (μ‹±κΈ€ν†¤)
  redisClientPromise = (async () => {
    // ... μƒμ„± λ΅μ§
    // μ¬μ‹λ„ μ „λµ, μ—λ¬ ν•Έλ“¤λ§ ν¬ν•¨
  })();

  return redisClientPromise;
}
```

**κ°μ„  ν¨κ³Ό**:
- β… λ©”λ¨λ¦¬ μ‚¬μ©λ‰ κ°μ†
- β… μ—°κ²° μ μµμ†ν™”
- β… μ„±λ¥ ν–¥μƒ
- β… μ•μ •μ„± ν–¥μƒ

---

### 2. β… setInterval λ©”λ¨λ¦¬ λ„μ λ°©μ§€
**νμΌ**: `lib/cache/partner-stats.ts`

**μμ • λ‚΄μ©**:
- μ „μ—­ λ³€μλ΅ interval ID μ €μ¥
- μ¤‘λ³µ μ‹¤ν–‰ λ°©μ§€
- ν”„λ΅μ„Έμ¤ μΆ…λ£ μ‹ μ •λ¦¬

**μμ • μ „**:
```typescript
if (typeof setInterval !== 'undefined') {
  setInterval(cleanExpiredCache, 10 * 60 * 1000);
}
```

**μμ • ν›„**:
```typescript
let cacheCleanupInterval: NodeJS.Timeout | null = null;

if (typeof setInterval !== 'undefined' && !cacheCleanupInterval) {
  cacheCleanupInterval = setInterval(() => {
    cleanExpiredCache();
  }, 10 * 60 * 1000);
}

// ν”„λ΅μ„Έμ¤ μΆ…λ£ μ‹ μ •λ¦¬
process.on('SIGINT', () => {
  if (cacheCleanupInterval) {
    clearInterval(cacheCleanupInterval);
    cacheCleanupInterval = null;
  }
});
```

**κ°μ„  ν¨κ³Ό**:
- β… λ©”λ¨λ¦¬ λ„μ λ°©μ§€
- β… μ¤‘λ³µ μ‹¤ν–‰ λ°©μ§€
- β… ν”„λ΅μ„Έμ¤ μΆ…λ£ μ‹ μ •μƒ μ •λ¦¬

---

### 3. β… μΊμ‹ ν•¨μ λ‚΄λ¶€ dateFilter μ¬κ³„μ‚°
**νμΌ**: `app/api/partner/dashboard/stats/route.ts`

**μμ • λ‚΄μ©**:
- `dateFilter`λ¥Ό μΊμ‹ ν•¨μ λ‚΄λ¶€μ—μ„ μ¬κ³„μ‚°
- μΊμ‹ μΌκ΄€μ„± λ³΄μ¥
- μ™Έλ¶€ μ¤μ½”ν”„ μμ΅΄μ„± μ κ±°

**μμ • μ „**:
```typescript
// μ™Έλ¶€μ—μ„ dateFilter κ³„μ‚°
let dateFilter: { gte?: Date; lte?: Date } = {};
if (month) {
  // ... κ³„μ‚°
}

const stats = await getCachedStats(
  profile.id,
  `dashboard-${cacheKey}`,
  async () => {
    // dateFilter μ‚¬μ© (μ™Έλ¶€ μ¤μ½”ν”„)
    createdAt: dateFilter,
  }
);
```

**μμ • ν›„**:
```typescript
const stats = await getCachedStats(
  profile.id,
  `dashboard-${cacheKey}`,
  async () => {
    // μΊμ‹ ν•¨μ λ‚΄λ¶€μ—μ„ dateFilter μ¬κ³„μ‚°
    let cachedDateFilter: { gte?: Date; lte?: Date } = {};
    if (month) {
      // ... κ³„μ‚°
    }
    
    // cachedDateFilter μ‚¬μ©
    createdAt: cachedDateFilter,
  }
);
```

**κ°μ„  ν¨κ³Ό**:
- β… μΊμ‹ μΌκ΄€μ„± λ³΄μ¥
- β… μ™Έλ¶€ μμ΅΄μ„± μ κ±°
- β… μΊμ‹ ν‚¤μ™€ λ°μ΄ν„° μΌμΉ λ³΄μ¥

---

### 4. β… μ½”λ“ μΈλ΄νΈ μ •λ¦¬
**νμΌ**: `app/api/partner/dashboard/stats/route.ts`

**μμ • λ‚΄μ©**:
- Promise.all λ°°μ—΄ μΈλ΄νΈ μΌκ΄€μ„± ν™•λ³΄
- μ „μ²΄ μ½”λ“ κµ¬μ΅° μ •λ¦¬

**κ°μ„  ν¨κ³Ό**:
- β… κ°€λ…μ„± ν–¥μƒ
- β… μ μ§€λ³΄μμ„± ν–¥μƒ

---

## π“ κ°μ„  ν¨κ³Ό μ”μ•½

### μ„±λ¥ ν–¥μƒ
- β… Redis ν΄λΌμ΄μ–ΈνΈ μ¬μ‚¬μ©μΌλ΅ μ—°κ²° μ κ°μ†
- β… λ©”λ¨λ¦¬ μ‚¬μ©λ‰ μµμ ν™”
- β… μΊμ‹ μΌκ΄€μ„± λ³΄μ¥

### μ•μ •μ„± ν–¥μƒ
- β… λ©”λ¨λ¦¬ λ„μ λ°©μ§€
- β… μ—λ¬ ν•Έλ“¤λ§ κ°μ„ 
- β… ν”„λ΅μ„Έμ¤ μΆ…λ£ μ‹ μ •μƒ μ •λ¦¬

### μ½”λ“ ν’μ§ ν–¥μƒ
- β… κ°€λ…μ„± ν–¥μƒ
- β… μ μ§€λ³΄μμ„± ν–¥μƒ
- β… λ²„κ·Έ κ°€λ¥μ„± κ°μ†

---

## π” μ¶”κ°€ ν™•μΈ μ‚¬ν•­

### μ •μƒ λ™μ‘ ν™•μΈ
- β… Redis μ—°κ²° λ° μ¬μ‚¬μ©
- β… λ©”λ¨λ¦¬ μΊμ‹ ν΄λ°±
- β… μΊμ‹ μ •λ¦¬ μ‘μ—…
- β… ν†µκ³„ μ΅°ν λ΅μ§

### ν…μ¤νΈ κ¶μ¥μ‚¬ν•­
1. **Redis μ—°κ²° ν…μ¤νΈ**:
   - Redisκ°€ μλ” κ²½μ°: μ—°κ²° μ¬μ‚¬μ© ν™•μΈ
   - Redisκ°€ μ—†λ” κ²½μ°: λ©”λ¨λ¦¬ μΊμ‹ λ™μ‘ ν™•μΈ

2. **λ©”λ¨λ¦¬ λ„μ ν…μ¤νΈ**:
   - μ¥μ‹κ°„ μ‹¤ν–‰ μ‹ λ©”λ¨λ¦¬ μ‚¬μ©λ‰ λ¨λ‹ν„°λ§
   - ν”„λ΅μ„Έμ¤ μ¬μ‹μ‘ μ‹ μ •μƒ λ™μ‘ ν™•μΈ

3. **μΊμ‹ μΌκ΄€μ„± ν…μ¤νΈ**:
   - κ°™μ€ μ›” νλΌλ―Έν„°λ΅ μ—¬λ¬ λ² μ”μ²­ μ‹ λ™μΌν• κ²°κ³Ό ν™•μΈ
   - μΊμ‹ λ§λ£ ν›„ μƒλ΅μ΄ λ°μ΄ν„° μ΅°ν ν™•μΈ

---

## π“ μ™„λ£ μƒνƒ

- β… Redis ν΄λΌμ΄μ–ΈνΈ μ‹±κΈ€ν†¤ ν¨ν„΄ μ μ©
- β… setInterval λ©”λ¨λ¦¬ λ„μ λ°©μ§€
- β… μΊμ‹ ν•¨μ λ‚΄λ¶€ dateFilter μ¬κ³„μ‚°
- β… μ½”λ“ μΈλ΄νΈ μ •λ¦¬
- β… μ—λ¬ ν•Έλ“¤λ§ κ°μ„ 
- β… ν”„λ΅μ„Έμ¤ μΆ…λ£ μ‹ μ •λ¦¬ λ΅μ§ μ¶”κ°€

**λ‹¤μ μ‘μ—…**: μ‹¤μ  ν™κ²½μ—μ„ ν…μ¤νΈ λ° λ¨λ‹ν„°λ§


