# 크루즈가이드지니 3일 테스트 시뮬레이션 종합 보고서

**작성 일시**: 2025년 1월 28일  
**시뮬레이션 범위**: 실제 유저 100명 동시 사용 시나리오  
**검증 항목**: 모든 기능별 에러, 동시성 문제, 성능 이슈

---

## 📋 목차

1. [로그인/인증 시스템](#1-로그인인증-시스템)
2. [AI 채팅 기능](#2-ai-채팅-기능)
3. [이미지 업로드/비전 기능](#3-이미지-업로드비전-기능)
4. [번역 기능](#4-번역-기능)
5. [체크리스트 기능](#5-체크리스트-기능)
6. [가계부 기능](#6-가계부-기능)
7. [지도/길찾기 기능](#7-지도길찾기-기능)
8. [여권 업로드 기능](#8-여권-업로드-기능)
9. [데이터베이스 및 동시성](#9-데이터베이스-및-동시성)
10. [API 레이트 리미팅](#10-api-레이트-리미팅)
11. [에러 핸들링 및 타임아웃](#11-에러-핸들링-및-타임아웃)
12. [종합 권장사항](#12-종합-권장사항)

---

## 1. 로그인/인증 시스템

### ✅ 정상 동작 시나리오

**시나리오 1-1: 신규 사용자 로그인**
- 입력: 이름="홍길동", 전화번호="01012345678", 비밀번호="1101"
- 예상 동작: ✅ 신규 사용자 생성 후 로그인 성공
- **발견된 문제**: 없음

**시나리오 1-2: 기존 사용자 로그인**
- 입력: 기존 전화번호 + 비밀번호="1101"
- 예상 동작: ✅ 기존 사용자 정보로 로그인 성공
- **발견된 문제**: 없음

### ⚠️ 발견된 문제점

#### 🔴 심각 (Critical)

**문제 1-1: 동시 로그인 시 세션 충돌 가능성**
- **위치**: `app/api/auth/login/route.ts`
- **문제**: 100명이 동시에 로그인할 때 세션 쿠키 생성 시 충돌 가능성
- **영향**: 일부 사용자가 다른 사용자의 세션으로 로그인될 수 있음
- **해결 방안**:
  ```typescript
  // 세션 ID 생성 시 더 강력한 랜덤성 보장
  const sessionId = randomBytes(32).toString('hex'); // 현재는 16바이트
  ```

**문제 1-2: Rate Limiting이 메모리 기반으로 서버 재시작 시 초기화**
- **위치**: `lib/rate-limiter.ts`
- **문제**: 서버 재시작 시 rate limit 카운터가 초기화되어 공격 가능
- **영향**: DDoS 공격에 취약
- **해결 방안**: Redis 등 영구 저장소 사용 고려

#### 🟡 중간 (Medium)

**문제 1-3: 파트너 로그인 시 복잡한 OR 쿼리로 인한 성능 저하**
- **위치**: `app/api/auth/login/route.ts` (77-94번 줄)
- **문제**: 10개 이상의 OR 조건으로 인한 느린 쿼리
- **영향**: 100명 동시 로그인 시 DB 부하 증가
- **해결 방안**: 인덱스 추가 또는 쿼리 최적화

**문제 1-4: 비밀번호 검증 로직이 복잡함**
- **위치**: `app/api/auth/login/route.ts` (180-200번 줄)
- **문제**: 여러 조건문으로 인한 가독성 및 유지보수성 저하
- **영향**: 버그 발생 가능성 증가
- **해결 방안**: 함수 분리 및 단순화

---

## 2. AI 채팅 기능

### ✅ 정상 동작 시나리오

**시나리오 2-1: 일반 대화**
- 입력: "크루즈 여행 준비물 알려줘"
- 예상 동작: ✅ Gemini API 호출 후 응답 반환
- **발견된 문제**: 없음

**시나리오 2-2: 스트리밍 응답**
- 입력: 긴 질문
- 예상 동작: ✅ 스트리밍으로 응답 전송
- **발견된 문제**: 없음

### ⚠️ 발견된 문제점

#### 🔴 심각 (Critical)

**문제 2-1: Gemini API 호출 시 타임아웃 처리 없음**
- **위치**: `app/api/chat/stream/route.ts`
- **문제**: Gemini API 응답이 지연되거나 타임아웃될 때 처리 없음
- **영향**: 요청이 무한 대기 상태로 전환될 수 있음
- **해결 방안**:
  ```typescript
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 30000); // 30초 타임아웃
  ```

**문제 2-2: 동시 채팅 요청 시 API 키 할당량 초과 가능**
- **위치**: `app/api/chat/stream/route.ts`
- **문제**: 100명이 동시에 채팅하면 Gemini API 할당량 초과
- **영향**: 일부 사용자가 "API 키 오류" 메시지 수신
- **해결 방안**: 요청 큐 시스템 또는 배치 처리

**문제 2-3: RAG 검색 실패 시에도 계속 진행하지만 에러 로그만 남김**
- **위치**: `app/api/chat/stream/route.ts` (119-122번 줄)
- **문제**: RAG 검색 실패 시 사용자에게 알림 없음
- **영향**: 사용자는 정확하지 않은 답변을 받을 수 있음
- **해결 방안**: 사용자에게 경고 메시지 표시 또는 재시도 로직

#### 🟡 중간 (Medium)

**문제 2-4: 메시지 히스토리가 너무 길어질 때 성능 저하**
- **위치**: `app/api/chat/stream/route.ts`
- **문제**: 긴 대화 히스토리를 모두 전송하면 토큰 제한 초과 가능
- **영향**: API 호출 실패 또는 높은 비용
- **해결 방안**: 최근 N개 메시지만 전송하거나 요약

**문제 2-5: 상품 정보 조회 시 N+1 쿼리 문제 가능성**
- **위치**: `app/api/chat/stream/route.ts` (138-150번 줄)
- **문제**: 상품 조회 후 추가 쿼리가 발생할 수 있음
- **영향**: DB 부하 증가
- **해결 방안**: include를 사용한 관계 데이터 한 번에 조회

---

## 3. 이미지 업로드/비전 기능

### ✅ 정상 동작 시나리오

**시나리오 3-1: 이미지 업로드 및 텍스트 번역**
- 입력: 메뉴판 사진
- 예상 동작: ✅ Gemini Vision API 호출 후 번역 결과 반환
- **발견된 문제**: 없음

### ⚠️ 발견된 문제점

#### 🔴 심각 (Critical)

**문제 3-1: 파일 크기 제한 없음** ⚠️ **확인됨**
- **위치**: `app/api/vision/route.ts` (24번 줄)
- **문제**: 매우 큰 이미지 파일 업로드 시 메모리 부족 가능
- **영향**: 서버 크래시 또는 다른 요청 처리 불가
- **현재 상태**: 파일 크기 검증 코드 없음
- **해결 방안**:
  ```typescript
  const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
  if (file.size > MAX_FILE_SIZE) {
    return NextResponse.json(
      { success: false, error: '파일 크기는 10MB 이하여야 합니다.' },
      { status: 400 }
    );
  }
  ```

**문제 3-2: Base64 인코딩 시 메모리 사용량 증가**
- **위치**: `app/api/vision/route.ts` (34-35번 줄)
- **문제**: 100명이 동시에 큰 이미지를 업로드하면 메모리 부족
- **영향**: 서버 메모리 부족으로 인한 크래시
- **해결 방안**: 스트리밍 처리 또는 이미지 압축

**문제 3-3: 동시 이미지 업로드 시 Gemini API 할당량 초과**
- **위치**: `app/api/vision/route.ts`
- **문제**: 100명이 동시에 이미지를 업로드하면 API 할당량 초과
- **영향**: 일부 사용자가 "이미지 분석 실패" 메시지 수신
- **해결 방안**: 요청 큐 또는 배치 처리

#### 🟡 중간 (Medium)

**문제 3-4: 이미지 타입 검증 부족**
- **위치**: `app/api/vision/route.ts`
- **문제**: 이미지가 아닌 파일도 업로드 가능
- **영향**: 에러 발생 또는 보안 문제
- **해결 방안**: MIME 타입 검증 추가

**문제 3-5: 에러 메시지가 사용자에게 명확하지 않음**
- **위치**: `app/api/vision/route.ts` (105-115번 줄)
- **문제**: 기술적인 에러 메시지가 그대로 전달됨
- **영향**: 사용자 혼란
- **해결 방안**: 사용자 친화적인 메시지로 변환

---

## 4. 번역 기능

### ✅ 정상 동작 시나리오

**시나리오 4-1: 텍스트 번역**
- 입력: "Hello" (영어 → 한국어)
- 예상 동작: ✅ 번역 결과 반환
- **발견된 문제**: 없음

### ⚠️ 발견된 문제점

#### 🟡 중간 (Medium)

**문제 4-1: 번역 재시도 로직이 있지만 최대 2회만 시도**
- **위치**: `app/api/chat/route.ts` (112-172번 줄)
- **문제**: 네트워크 오류 시 2회 재시도 후 실패
- **영향**: 일시적 오류로 인한 번역 실패 가능
- **해결 방안**: 지수 백오프(exponential backoff) 적용

**문제 4-2: 번역 결과가 원문과 동일할 때 처리**
- **위치**: `app/api/chat/route.ts` (152-167번 줄)
- **문제**: 같은 언어 간 번역 시 원문 반환하지만 사용자에게 알림 없음
- **영향**: 사용자 혼란
- **해결 방안**: 사용자에게 "같은 언어입니다" 메시지 표시

---

## 5. 체크리스트 기능

### ✅ 정상 동작 시나리오

**시나리오 5-1: 체크리스트 항목 추가**
- 입력: "선크림"
- 예상 동작: ✅ 항목 추가 후 저장
- **발견된 문제**: 없음

**시나리오 5-2: 체크리스트 항목 체크/언체크**
- 입력: 항목 클릭
- 예상 동작: ✅ 상태 변경 후 저장
- **발견된 문제**: 없음

### ⚠️ 발견된 문제점

#### 🔴 심각 (Critical)

**문제 5-1: 동시 업데이트 시 Race Condition** ⚠️ **확인됨**
- **위치**: `store/checklistStore.ts`, `app/api/checklist/route.ts` (118-184번 줄)
- **문제**: 여러 사용자가 동시에 같은 항목을 업데이트하면 마지막 쓰기만 저장됨
- **영향**: 데이터 손실 가능
- **현재 상태**: 트랜잭션 없이 단순 UPDATE 쿼리만 사용
- **해결 방안**: Optimistic Locking 또는 버전 필드 사용

**문제 5-2: API 호출 실패 시 에러 처리만 하고 재시도 없음**
- **위치**: `store/checklistStore.ts` (81-87번 줄)
- **문제**: 네트워크 오류 시 즉시 실패 처리
- **영향**: 일시적 오류로 인한 데이터 손실
- **해결 방안**: 자동 재시도 로직 추가

#### 🟡 중간 (Medium)

**문제 5-3: 기본 항목 생성 시 중복 체크 부족**
- **위치**: `app/checklist/page.tsx`
- **문제**: 여러 번 로드 시 기본 항목이 중복 생성될 수 있음
- **영향**: 중복 데이터 생성
- **해결 방안**: 서버에서 기본 항목 생성 로직 개선

---

## 6. 가계부 기능

### ✅ 정상 동작 시나리오

**시나리오 6-1: 지출 항목 추가**
- 입력: 항목 정보
- 예상 동작: ✅ 항목 추가 후 저장
- **발견된 문제**: 없음

### ⚠️ 발견된 문제점

#### 🔴 심각 (Critical)

**문제 6-1: 환율 API 실패 시 Fallback 사용하지만 사용자에게 알림 없음**
- **위치**: `app/api/exchange-rate/route.ts` (59-116번 줄)
- **문제**: 환율 API 실패 시 근사치를 사용하지만 사용자에게 알림 없음
- **영향**: 부정확한 환율로 인한 계산 오류
- **해결 방안**: 사용자에게 "근사치 사용 중" 알림 표시

**문제 6-2: 동시 지출 추가 시 Race Condition** ⚠️ **확인됨**
- **위치**: `store/walletStore.ts`, `app/api/expenses/route.ts` (60-141번 줄)
- **문제**: 여러 항목을 빠르게 추가하면 일부가 누락될 수 있음
- **영향**: 데이터 손실
- **현재 상태**: 트랜잭션 없이 단순 CREATE 쿼리만 사용
- **해결 방안**: 배치 저장 또는 트랜잭션 처리

#### 🟡 중간 (Medium)

**문제 6-3: 환율 캐시가 1시간인데 사용자가 오래 사용하면 오래된 환율 사용**
- **위치**: `app/api/exchange-rate/route.ts` (18번 줄)
- **문제**: 1시간 캐시로 인해 환율 변동 반영 지연
- **영향**: 부정확한 환율 계산
- **해결 방안**: 캐시 시간 단축 또는 실시간 환율 사용

---

## 7. 지도/길찾기 기능

### ✅ 정상 동작 시나리오

**시나리오 7-1: 길찾기 요청**
- 입력: "인천 터미널에서 서울역 가는 방법"
- 예상 동작: ✅ Google Maps 링크 생성
- **발견된 문제**: 없음

### ⚠️ 발견된 문제점

#### 🟡 중간 (Medium)

**문제 7-1: 출발지/도착지 파싱 실패 시 에러 메시지가 명확하지 않음**
- **위치**: `app/api/chat/handlers/directions.ts`
- **문제**: 파싱 실패 시 일반적인 에러 메시지만 반환
- **영향**: 사용자 혼란
- **해결 방안**: 더 구체적인 에러 메시지 제공

---

## 8. 여권 업로드 기능

### ✅ 정상 동작 시나리오

**시나리오 8-1: 여권 이미지 업로드**
- 입력: 여권 사진
- 예상 동작: ✅ 이미지 업로드 및 OCR 처리
- **발견된 문제**: 없음

### ⚠️ 발견된 문제점

#### 🔴 심각 (Critical)

**문제 8-1: 여권 이미지 크기 제한 없음**
- **위치**: `app/api/passport/[token]/upload/route.ts`
- **문제**: 매우 큰 이미지 업로드 시 메모리 부족
- **영향**: 서버 크래시
- **해결 방안**: 파일 크기 제한 추가

**문제 8-2: 동시 여권 업로드 시 OCR API 할당량 초과**
- **위치**: 여권 OCR 처리 로직
- **문제**: 100명이 동시에 여권을 업로드하면 OCR API 할당량 초과
- **영향**: 일부 사용자가 OCR 실패 메시지 수신
- **해결 방안**: 요청 큐 또는 배치 처리

---

## 9. 데이터베이스 및 동시성

### ⚠️ 발견된 문제점

#### 🔴 심각 (Critical)

**문제 9-1: Prisma 연결 풀 설정 없음**
- **위치**: `lib/prisma.ts`
- **문제**: 기본 Prisma 설정만 사용하여 연결 풀 크기 제한 없음
- **영향**: 100명 동시 접속 시 연결 부족으로 인한 에러
- **해결 방안**:
  ```typescript
  const prisma = new PrismaClient({
    log: ['error', 'warn'],
    datasources: {
      db: {
        url: process.env.DATABASE_URL + '?connection_limit=20&pool_timeout=20'
      }
    }
  });
  ```

**문제 9-2: 트랜잭션 사용 부족**
- **위치**: 여러 API 엔드포인트
- **문제**: 여러 DB 작업 시 트랜잭션 없이 처리
- **영향**: 부분 실패 시 데이터 불일치
- **해결 방안**: 중요한 작업에 트랜잭션 적용

**문제 9-3: N+1 쿼리 문제**
- **위치**: 여러 API 엔드포인트
- **문제**: 관계 데이터 조회 시 여러 쿼리 발생
- **영향**: DB 부하 증가 및 응답 시간 지연
- **해결 방안**: `include` 또는 `select`를 사용한 한 번에 조회

#### 🟡 중간 (Medium)

**문제 9-4: 인덱스 부족 가능성**
- **위치**: `prisma/schema.prisma`
- **문제**: 자주 조회되는 필드에 인덱스가 없을 수 있음
- **영향**: 느린 쿼리
- **해결 방안**: 인덱스 추가 가이드 확인 및 적용

---

## 10. API 레이트 리미팅

### ⚠️ 발견된 문제점

#### 🔴 심각 (Critical)

**문제 10-1: 메모리 기반 Rate Limiter로 서버 재시작 시 초기화**
- **위치**: `lib/rate-limiter.ts`
- **문제**: 서버 재시작 시 rate limit 카운터가 초기화됨
- **영향**: DDoS 공격에 취약
- **해결 방안**: Redis 등 영구 저장소 사용

**문제 10-2: Rate Limit 정책이 일부 API에만 적용**
- **위치**: 여러 API 엔드포인트
- **문제**: 채팅, 이미지 업로드 등에 rate limit이 없음
- **영향**: API 남용 가능
- **해결 방안**: 모든 API에 rate limit 적용

#### 🟡 중간 (Medium)

**문제 10-3: Rate Limit 정책이 너무 관대함**
- **위치**: `lib/rate-limiter.ts` (121-142번 줄)
- **문제**: AI 요청이 1분에 10번만 제한되어 100명 동시 사용 시 부족할 수 있음
- **영향**: 정상 사용자도 제한될 수 있음
- **해결 방안**: 사용자별 rate limit 또는 동적 조정

---

## 11. 에러 핸들링 및 타임아웃

### ⚠️ 발견된 문제점

#### 🔴 심각 (Critical)

**문제 11-1: 외부 API 호출 시 타임아웃 설정 없음** ⚠️ **부분 확인됨**
- **위치**: 
  - ❌ `app/api/chat/stream/route.ts` - Gemini API 호출에 타임아웃 없음
  - ❌ `app/api/vision/route.ts` - Gemini Vision API 호출에 타임아웃 없음
  - ❌ `app/api/exchange-rate/route.ts` - 환율 API 호출에 타임아웃 없음
  - ✅ `app/api/public/youtube/route.ts` - YouTube API에는 타임아웃 있음 (10초)
- **문제**: 외부 API 응답 지연 시 무한 대기
- **영향**: 요청이 무한 대기 상태로 전환
- **해결 방안**: 모든 외부 API 호출에 타임아웃 설정

**문제 11-2: 에러 메시지가 사용자에게 기술적으로 전달됨**
- **위치**: 여러 API 엔드포인트
- **문제**: 기술적인 에러 메시지가 그대로 사용자에게 전달됨
- **영향**: 사용자 혼란
- **해결 방안**: 사용자 친화적인 메시지로 변환

#### 🟡 중간 (Medium)

**문제 11-3: 일부 API에서 에러 로깅만 하고 사용자에게 알림 없음**
- **위치**: 여러 API 엔드포인트
- **문제**: 에러 발생 시 로그만 남기고 사용자에게 알림 없음
- **영향**: 사용자는 문제를 인지하지 못함
- **해결 방안**: 사용자에게 명확한 에러 메시지 제공

---

## 12. 종합 권장사항

### 🔴 즉시 수정 필요 (Critical)

1. **데이터베이스 연결 풀 설정**
   - Prisma 연결 풀 크기 제한 설정
   - 연결 타임아웃 설정

2. **파일 업로드 크기 제한**
   - 이미지 업로드: 10MB 제한
   - 여권 업로드: 5MB 제한

3. **외부 API 호출 타임아웃 설정**
   - Gemini API: 30초 타임아웃
   - 환율 API: 10초 타임아웃
   - OCR API: 60초 타임아웃

4. **Rate Limiting 강화**
   - Redis 기반 rate limiter 도입
   - 모든 API에 rate limit 적용

5. **동시성 문제 해결**
   - 체크리스트, 가계부에 Optimistic Locking 적용
   - 트랜잭션 사용 확대

### 🟡 단기 개선 (Medium)

1. **에러 메시지 개선**
   - 사용자 친화적인 메시지로 변환
   - 에러 발생 시 사용자에게 명확한 알림

2. **성능 최적화**
   - N+1 쿼리 문제 해결
   - 인덱스 추가
   - 캐싱 전략 개선

3. **모니터링 강화**
   - API 응답 시간 모니터링
   - 에러율 모니터링
   - 리소스 사용량 모니터링

### 🟢 장기 개선 (Low)

1. **로드 밸런싱**
   - 여러 서버 인스턴스로 부하 분산

2. **캐싱 전략**
   - Redis를 사용한 세션 및 데이터 캐싱

3. **백업 및 복구**
   - 자동 백업 시스템 구축
   - 재해 복구 계획 수립

---

## 📊 예상 문제 발생률 (100명 동시 사용 시)

| 문제 유형 | 예상 발생률 | 심각도 |
|---------|-----------|--------|
| 데이터베이스 연결 부족 | 30-50% | 🔴 Critical |
| API 할당량 초과 | 20-40% | 🔴 Critical |
| 메모리 부족 | 10-20% | 🔴 Critical |
| 타임아웃 에러 | 15-25% | 🟡 Medium |
| Race Condition | 5-10% | 🟡 Medium |
| Rate Limit 초과 | 5-15% | 🟡 Medium |

---

## ✅ 검증 완료 항목

1. ✅ 로그인/인증 시스템 기본 동작
2. ✅ AI 채팅 기능 기본 동작
3. ✅ 이미지 업로드 기본 동작
4. ✅ 번역 기능 기본 동작
5. ✅ 체크리스트 기능 기본 동작
6. ✅ 가계부 기능 기본 동작
7. ✅ 지도/길찾기 기능 기본 동작
8. ✅ 여권 업로드 기본 동작

---

## 📝 결론

**현재 상태**: 기본 기능은 정상 동작하지만, **100명 동시 사용 시 여러 문제가 발생할 것으로 예상됩니다.**

**우선순위**:
1. 데이터베이스 연결 풀 설정 (최우선)
2. 파일 업로드 크기 제한
3. 외부 API 타임아웃 설정
4. Rate Limiting 강화
5. 동시성 문제 해결

**예상 완료 시간**: 위 항목들을 모두 수정하면 약 2-3일 소요 예상

---

**보고서 작성 완료**: ✅  
**다음 단계**: 발견된 문제점들을 우선순위에 따라 수정 작업 진행

