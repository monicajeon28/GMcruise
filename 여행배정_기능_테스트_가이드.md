# 🧪 여행배정 기능 테스트 가이드

## 📋 목차
1. [사전 준비](#사전-준비)
2. [테스트 시나리오](#테스트-시나리오)
3. [단계별 테스트](#단계별-테스트)
4. [예상 결과](#예상-결과)
5. [문제 해결](#문제-해결)

---

## 사전 준비

### 1. 샘플 데이터 생성

터미널에서 다음 명령어 실행:

```bash
# TypeScript 실행 환경 확인
npx tsx scripts/create-assign-trip-test-data.ts
```

이 스크립트는 다음을 생성합니다:
- ✅ 관리자 계정 (테스트용)
- ✅ 크루즈 가이드 사용자 (여행 배정 대상)
- ✅ 구매 고객 (여행 상품 구매 완료)
- ✅ 크루즈 상품 (여행 배정용)
- ✅ 예약 정보 (구매 고객과 상품 연결)

### 2. 생성된 샘플 데이터 확인

스크립트 실행 후 다음 정보가 출력됩니다:
```
✅ 관리자 계정 생성 완료
   이름: 테스트 관리자
   전화번호: 010-0000-0001
   비밀번호: admin123

✅ 크루즈 가이드 사용자 생성 완료
   이름: 홍길동
   전화번호: 010-1234-5678
   비밀번호: 3800

✅ 구매 고객 생성 완료
   이름: 김구매
   전화번호: 010-9876-5432
   상태: purchase_confirmed

✅ 크루즈 상품 생성 완료
   상품명: MSC 벨리시마 일본 4박 5일
   상품코드: TEST-001
```

---

## 테스트 시나리오

### 시나리오 1: 기본 여행 배정 (구매 고객 없이)

**목적**: 구매 고객 없이 직접 여행 배정하기

**단계**:
1. 관리자 로그인
2. 여행배정 페이지 접근
3. 크루즈 가이드 사용자 검색 및 선택
4. 상품 검색 및 선택
5. 여행 정보 확인 및 제출

---

### 시나리오 2: 구매 고객 기반 자동 배정

**목적**: 구매 고객 선택 시 자동으로 정보 로드되는지 확인

**단계**:
1. 관리자 로그인
2. 여행배정 페이지 접근
3. 구매 고객 검색 및 선택
4. 자동 로드된 정보 확인
5. 여행 배정 완료

---

## 단계별 테스트

### Step 1: 관리자 로그인

1. 브라우저에서 `/admin/login` 접근
2. 다음 정보 입력:
   ```
   이름: 테스트 관리자
   전화번호: 010-0000-0001
   비밀번호: admin123
   ```
3. "관리자 로그인" 버튼 클릭
4. ✅ 대시보드로 이동되면 성공

---

### Step 2: 여행배정 페이지 접근

1. 관리자 대시보드에서 사이드바 메뉴 확인
2. "✈️ 여행 배정" 메뉴 클릭
3. 또는 직접 `/admin/assign-trip` 접근
4. ✅ 여행배정 폼이 표시되면 성공

---

### Step 3: 크루즈 가이드 사용자 검색 (필수)

1. "크루즈 가이드 사용자 검색" 입력창 클릭
2. 드롭다운이 자동으로 열리며 사용자 목록 표시
3. 검색어 입력: `홍길동` 또는 `010-1234-5678`
4. 검색 결과에서 사용자 선택
5. ✅ 선택된 사용자 정보가 표시되면 성공

**예상 결과**:
- 드롭다운에 사용자 목록 표시
- 검색어 입력 시 필터링
- 사용자 선택 시 초록색 박스에 정보 표시

---

### Step 4: 상품 검색 (필수)

1. "크루즈몰 상품 검색" 입력창 클릭
2. 드롭다운이 자동으로 열리며 상품 목록 표시
3. 검색어 입력: `MSC` 또는 `벨리시마`
4. 검색 결과에서 상품 선택
5. ✅ 여행 정보가 자동으로 채워지면 성공

**예상 결과**:
- 크루즈명 자동 채워짐
- 여행 시작일/종료일 자동 채워짐
- 목적지 자동 채워짐
- 여행 정보 박스에 박/일, D-day 표시

---

### Step 5: 구매 고객 검색 (선택사항)

1. "구매 고객 검색" 입력창 클릭
2. 검색어 입력: `김구매` 또는 `010-9876-5432`
3. 검색 결과에서 고객 선택
4. ✅ 자동으로 다음이 로드되면 성공:
   - 여행 상품 정보
   - 크루즈 가이드 사용자 자동 검색 및 매칭 시도

**예상 결과**:
- 구매 고객 선택 시 상품 정보 자동 로드
- 크루즈 가이드 사용자 자동 검색
- 이름/전화번호 일치 시 자동 선택

---

### Step 6: 여행 정보 확인

1. 선택된 상품의 여행 정보 확인:
   - 여행 기간 (박/일)
   - 여행 시작일
   - 여행 종료일
   - D-day 계산
   - 목적지
2. 필요시 날짜 수정 가능
3. 동행 유형 선택 (선택사항)

**예상 결과**:
- 파란색 박스에 여행 정보 표시
- 날짜는 수정 가능
- 목적지는 읽기 전용 (상품 정보에서 가져옴)

---

### Step 7: 여행 배정 제출

1. 모든 필수 정보 입력 확인:
   - ✅ 크루즈 가이드 사용자 선택됨
   - ✅ 상품 선택됨
   - ✅ 여행 시작일 입력됨
   - ✅ 여행 종료일 입력됨
2. "여행 배정하기" 버튼 클릭
3. ✅ 성공 메시지 표시 확인

**예상 결과**:
- "여행이 배정되었습니다! 크루즈 가이드 지니가 활성화되었습니다." 메시지
- 폼이 초기화됨
- 사용자 비밀번호가 3800으로 변경됨
- Trip 레코드 생성됨
- Itinerary 레코드 생성됨

---

## 예상 결과

### 데이터베이스 확인

여행 배정 후 다음이 생성/업데이트되어야 합니다:

1. **Trip 테이블**
   ```sql
   SELECT * FROM "Trip" WHERE "userId" = [선택한 사용자 ID] ORDER BY "id" DESC LIMIT 1;
   ```
   - ✅ cruiseName, startDate, endDate, destination 등이 정상 저장

2. **Itinerary 테이블**
   ```sql
   SELECT * FROM "Itinerary" WHERE "tripId" = [생성된 Trip ID];
   ```
   - ✅ 일정 정보가 정상 저장

3. **User 테이블**
   ```sql
   SELECT "onboarded", "totalTripCount", "password" FROM "User" WHERE "id" = [선택한 사용자 ID];
   ```
   - ✅ onboarded = true
   - ✅ totalTripCount 증가
   - ✅ password = '3800'

4. **VisitedCountry 테이블**
   ```sql
   SELECT * FROM "VisitedCountry" WHERE "userId" = [선택한 사용자 ID];
   ```
   - ✅ 방문 국가 정보 업데이트

---

## 문제 해결

### 문제 1: 관리자 로그인 실패

**증상**: 로그인 시 "관리자 로그인 실패" 메시지

**해결**:
1. 샘플 데이터 생성 스크립트 재실행
2. 관리자 계정의 role이 'admin'인지 확인
3. 브라우저 쿠키/세션 초기화 후 재시도

---

### 문제 2: 사용자 검색 결과가 없음

**증상**: 검색해도 사용자가 나타나지 않음

**해결**:
1. 샘플 데이터 생성 스크립트 재실행
2. 사용자의 role이 'user'인지 확인
3. 브라우저 콘솔에서 API 응답 확인

---

### 문제 3: 상품 검색 결과가 없음

**증상**: 상품 검색해도 결과가 없음

**해결**:
1. 샘플 데이터 생성 스크립트 재실행
2. 상품의 isActive가 true인지 확인
3. API 응답 확인: `/api/admin/products/search?q=`

---

### 문제 4: 여행 배정 실패

**증상**: "여행 배정에 실패했습니다" 메시지

**해결**:
1. 브라우저 개발자 도구 → Network 탭 확인
2. API 응답 확인: `/api/admin/users/[userId]/trips/[tripId]/onboarding`
3. 서버 로그 확인 (터미널)
4. 필수 필드 모두 입력되었는지 확인

---

### 문제 5: 구매 고객 선택 시 정보가 자동 로드되지 않음

**증상**: 구매 고객 선택해도 상품 정보가 안 나타남

**해결**:
1. 구매 고객의 customerStatus가 'purchase_confirmed'인지 확인
2. Reservation과 Trip이 연결되어 있는지 확인
3. API 응답 확인: `/api/admin/purchase-customers/[userId]/trip-info`

---

## 추가 확인 사항

### 크루즈 가이드 사용자 로그인 테스트

여행 배정 후 해당 사용자로 로그인하여 확인:

1. `/login` 페이지 접근
2. 다음 정보 입력:
   ```
   이름: 홍길동
   전화번호: 010-1234-5678
   비밀번호: 3800
   ```
3. ✅ 로그인 성공 후 `/chat`으로 이동
4. ✅ 지니가 활성화되어 대화 가능

---

## 테스트 체크리스트

- [ ] 관리자 로그인 성공
- [ ] 여행배정 페이지 접근 가능
- [ ] 크루즈 가이드 사용자 검색 및 선택
- [ ] 상품 검색 및 선택
- [ ] 여행 정보 자동 채워짐
- [ ] 구매 고객 검색 및 선택 (선택사항)
- [ ] 구매 고객 선택 시 자동 정보 로드
- [ ] 여행 배정 제출 성공
- [ ] 성공 메시지 표시
- [ ] 폼 초기화 확인
- [ ] 데이터베이스에 Trip 생성 확인
- [ ] 사용자 비밀번호 3800으로 변경 확인
- [ ] 사용자 onboarded = true 확인
- [ ] 배정된 사용자로 로그인 테스트

---

## 다음 단계

테스트 완료 후:
1. 실제 운영 데이터로 테스트
2. 다양한 시나리오 테스트 (재구매, 여러 여행 등)
3. 에러 케이스 테스트
4. 성능 테스트 (대량 데이터)

