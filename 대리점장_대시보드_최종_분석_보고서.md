# 대리점장 대시보드 최종 분석 및 배포 체크리스트

**작성일**: 2025년 1월 28일  
**대상**: 대리점장 대시보드 전체 기능  
**규모**: 1만명 고객 관리 대응

---

## 📋 목차

1. [유료 기능 분석](#1-유료-기능-분석)
2. [배포 시 주의사항](#2-배포-시-주의사항)
3. [기능별 상세 분석](#3-기능별-상세-분석)
4. [1만명 규모 효율성 분석](#4-1만명-규모-효율성-분석)
5. [배포 체크리스트](#5-배포-체크리스트)

---

## 1. 유료 기능 분석

### ✅ 알리고 API (SMS 발송) - 유료

**위치**: 대리점장/판매원 개별 설정
- **파일**: `app/api/partner/settings/sms/route.ts`
- **설정 방식**: 각 대리점장/판매원이 자신의 계정으로 설정
  - `PartnerSmsConfig` 테이블 (대리점장용)
  - `AffiliateSmsConfig` 테이블 (판매원용)
- **비용**: 건당 약 20-30원
- **사용 시나리오**:
  - 여권 등록 링크 발송
  - 챗봇 링크 발송
  - 고객에게 직접 SMS 전송
  - 퍼널 문자 자동 발송
- **배포 전 확인**:
  - ✅ 각 대리점장/판매원이 자신의 알리고 계정 설정 필요
  - ✅ 발신번호 등록 완료 여부 (알리고 사이트에서)
  - ✅ API 키 유효성 확인
  - ✅ 잔액 확인

**중요**: 본사가 아닌 각 대리점장/판매원이 개별적으로 설정하므로, 배포 시 각자 설정하도록 안내 필요

### ❌ 카카오톡 알림톡 - 제거됨

**상태**: 기능 제거 완료
- **제거된 파일들**:
  - `app/admin/scheduled-messages/page.tsx` - 카카오톡 옵션 제거
  - `app/partner/[partnerId]/scheduled-messages/page.tsx` - 카카오톡 옵션 제거
  - `app/admin/funnel/page.tsx` - 카카오톡 탭 제거
  - `app/admin/customer-groups/page.tsx` - 퍼널톡 섹션 제거
  - `app/partner/[partnerId]/customer-groups/page.tsx` - 퍼널톡 섹션 제거
  - `app/admin/messages/page.tsx` - 카카오톡 옵션 제거
- **비용 절감**: 월 약 75만원 절감 (1만명 기준)

### ✅ Google Drive API - 유료 (초과 시)

**위치**: 파일 업로드, APIS 생성
- **파일**: `app/api/google/drive/upload/route.ts`
- **비용**:
  - 무료: 15GB까지
  - 유료: 초과 시 과금
- **사용 시나리오**:
  - 여권 이미지 저장
  - 계약서 PDF 저장
  - APIS 엑셀 파일 저장
- **배포 전 확인**:
  - Google Drive 서비스 계정 설정
  - 권한 확인
  - 저장 용량 모니터링 필요

### ✅ Gemini API (AI 기능) - 유료

**위치**: OCR, 이미지 분석
- **파일**: `app/api/partner/passport-requests/ocr-to-apis/route.ts`
- **비용**: 사용량 기반 과금
- **사용 시나리오**:
  - 여권 OCR
  - 이미지 분석
- **배포 전 확인**:
  - API 키 설정 확인
  - 할당량 확인

---

## 2. 배포 시 주의사항

### 🔴 심각한 문제 (즉시 수정 필요)

#### 1. 환경변수 누락 가능성

**문제점**:
```typescript
// 환경변수가 없으면 에러 발생
const apiKey = process.env.GEMINI_API_KEY || '';
const baseUrl = process.env.NEXT_PUBLIC_BASE_URL || 'http://localhost:3000';
```

**필수 환경변수 체크리스트**:
```bash
# 필수 환경변수
GEMINI_API_KEY=your_key
GOOGLE_DRIVE_CLIENT_ID=your_id
GOOGLE_DRIVE_CLIENT_SECRET=your_secret
DATABASE_URL=your_db_url
NEXT_PUBLIC_BASE_URL=https://your-domain.com

# 알리고 API는 각 대리점장/판매원이 개별 설정 (DB에 저장)
# 환경변수 불필요
```

**해결방법**:
- 배포 전 환경변수 검증 스크립트 작성
- `.env.example` 파일에 모든 필수 환경변수 명시

#### 2. 하드코딩된 URL

**문제점**:
```typescript
const baseUrl = process.env.NEXT_PUBLIC_BASE_URL || 'https://cruisedot.co.kr';
```

**해결방법**:
- 모든 URL을 환경변수로 관리
- 배포 환경별로 다른 URL 사용 가능하도록 설정

#### 3. 개발 환경 체크 부족

**문제점**:
```typescript
error: process.env.NODE_ENV === 'development' ? error.message : undefined
```

**해결방법**:
- 프로덕션에서 민감한 에러 정보 노출 방지
- 로깅 시스템 구축

### 🟡 중간 문제 (배포 전 확인 필요)

#### 1. 알리고 API 개별 설정

**현재 상태**: ✅ 각 대리점장/판매원이 개별 설정
- `PartnerSmsConfig` 테이블 사용
- `AffiliateSmsConfig` 테이블 사용

**배포 전 확인**:
- 각 사용자가 자신의 알리고 계정으로 설정하도록 안내
- 발신번호 등록 가이드 제공
- API 키 입력 방법 안내

#### 2. 데이터베이스 연결

**확인 사항**:
- 프로덕션 DB 연결 확인
- Connection Pool 설정 확인
- 1만명 규모 대비 최대 연결 수 확인
- 인덱스 생성 확인

#### 3. 파일 업로드 제한

**확인 사항**:
- Google Drive API 할당량 확인
- 파일 크기 제한 설정 확인
- 업로드 실패 시 재시도 로직 확인

### 🟢 경미한 문제 (모니터링 필요)

1. 캐싱 설정 부재
2. 로깅 시스템 구축 필요
3. Rate Limiting 설정 필요

---

## 3. 기능별 상세 분석

### 3.1 어필리에이트 기능

#### ✅ 확인된 기능
- 링크 관리: 생성, 조회, 통계
- 리드 관리: 잠재고객 추적, 상태 관리
- 판매 관리: 판매 등록, 승인 대기, 월별 통계
- 팀 관리: 판매원 관리, DB 현황 조회

#### ⚠️ 발견된 문제점

1. **성능 이슈**
   - 통계 조회 시 인덱스 부족 가능
   - **필요한 인덱스**:
     - `affiliateLead`: `(managerId, createdAt)`, `(agentId, createdAt)`
     - `affiliateSale`: `(managerId, saleDate)`, `(agentId, saleDate)`
     - `affiliateLink`: `(managerId)`, `(agentId)`

2. **데이터 일관성**
   - 판매 승인 프로세스에서 동시성 처리 부족 가능
   - `saleDate`와 `createdAt` 필터링이 OR 조건으로 되어 있어 중복 카운트 가능성

3. **기능 누락**
   - 판매 취소/환불 처리 플로우가 대시보드에 직접 노출되지 않음
   - 커미션 계산 로직이 대시보드에 표시되지 않음

### 3.2 고객 관리

#### ✅ 확인된 기능
- 전체 고객: 리드 기반 고객 목록
- 전화상담 고객: 몰 유입 고객 관리
- 구매고객: 예약 완료 고객 관리
- 고객 등록: 수동 등록, 동행인 등록

#### ⚠️ 발견된 문제점

1. **검색 성능**
   - 고객 검색이 `limit=10`으로 제한되어 있으나, 1만명 규모에서 검색 속도 저하 가능
   - 전화번호 정규화가 클라이언트에서만 이루어짐 (DB 인덱스 활용 어려움)

2. **데이터 중복**
   - 동일 고객이 여러 리드로 중복 등록 가능
   - 전화번호 정규화가 일관되지 않음

3. **기능 누락**
   - 고객 메모/태그 기능이 대시보드에 없음
   - 고객 이력 추적(상태 변경 이력)이 부족
   - 고객 그룹 자동 할당 기능이 대시보드에 없음

### 3.3 구매 관리

#### ✅ 확인된 기능
- 구매고객 목록: 예약 완료 고객 조회
- 여권 등록: 여권 링크 발송, 챗봇 링크 발송
- 예약 상세: 예약 정보 확인

#### ⚠️ 발견된 문제점

1. **성능 이슈**
   - `loadPurchasedReservations`가 페이지네이션 없이 전체 로드
   - 1만명 규모에서 초기 로딩 지연 가능

2. **기능 누락**
   - 구매 취소/환불 처리 기능이 대시보드에 없음
   - 결제 상태 추적이 부족
   - APIS 다운로드 기능이 대시보드에 직접 연결되지 않음

3. **데이터 일관성**
   - `pnrStatus` 업데이트가 실시간 반영되지 않을 수 있음

### 3.4 랜딩페이지 마케팅

#### ✅ 확인된 기능
- 랜딩페이지 목록: 최근 5개 표시
- 랜딩페이지 생성/편집: 별도 페이지로 이동
- 공통 상품 링크: 관리자가 생성한 링크 표시

#### ⚠️ 발견된 문제점

1. **기능 제한**
   - 대시보드에서 랜딩페이지 통계(조회수, 전환율)가 표시되지 않음
   - 랜딩페이지별 리드 추적이 대시보드에 없음

2. **성능 이슈**
   - 랜딩페이지 목록이 최근 5개만 표시되어 전체 현황 파악 어려움

3. **기능 누락**
   - 랜딩페이지 A/B 테스트 기능 없음
   - 랜딩페이지별 ROI 분석이 없음

### 3.5 퍼널 문자

#### ✅ 확인된 기능
- 예약 메시지 관리: 별도 페이지에서 관리
- 그룹별 퍼널 설정: 고객 그룹에 퍼널 연결
- **카카오톡 알림톡 제거 완료**: SMS, 이메일, 크루즈가이드 메시지만 지원

#### ⚠️ 발견된 문제점

1. **대시보드 연동 부족**
   - 퍼널 문자 발송 현황이 대시보드에 표시되지 않음
   - 퍼널별 전환율이 대시보드에 없음

2. **기능 누락**
   - 퍼널 문자 발송 실패 알림이 대시보드에 없음
   - 퍼널 문자 효과 분석(오픈율, 클릭율)이 없음

### 3.6 그룹 관리

#### ✅ 확인된 기능
- 고객 그룹 관리: 별도 페이지에서 관리
- 그룹별 퍼널 설정: 퍼널 문자 연결
- **퍼널톡(카카오톡) 섹션 제거 완료**

#### ⚠️ 발견된 문제점

1. **대시보드 연동 부족**
   - 그룹별 고객 수, 그룹별 판매 실적이 대시보드에 표시되지 않음
   - 그룹별 퍼널 발송 현황이 없음

2. **기능 누락**
   - 그룹 자동 할당 규칙이 대시보드에서 설정 불가
   - 그룹별 통계 대시보드가 없음

---

## 4. 1만명 규모 효율성 분석

### 🔴 심각한 성능 문제

#### 1. 데이터베이스 쿼리 최적화 필요

**현재 코드** (`app/api/partner/dashboard/stats/route.ts`):
```typescript
// 문제: 인덱스가 없으면 1만명 규모에서 느림
const totalLeads = await prisma.affiliateLead.count({
  where: {
    OR: [
      { managerId: profile.id },
      { agentId: profile.id },
    ],
  },
});
```

**필요한 인덱스**:
```sql
-- affiliateLead 테이블
CREATE INDEX idx_affiliate_lead_manager_created ON "AffiliateLead"(managerId, createdAt);
CREATE INDEX idx_affiliate_lead_agent_created ON "AffiliateLead"(agentId, createdAt);

-- affiliateSale 테이블
CREATE INDEX idx_affiliate_sale_manager_date ON "AffiliateSale"(managerId, saleDate);
CREATE INDEX idx_affiliate_sale_agent_date ON "AffiliateSale"(agentId, saleDate);

-- affiliateLink 테이블
CREATE INDEX idx_affiliate_link_manager ON "AffiliateLink"(managerId);
CREATE INDEX idx_affiliate_link_agent ON "AffiliateLink"(agentId);
```

#### 2. 페이지네이션 부재

**문제점**:
- 구매고객 목록이 전체 로드됨 (`loadPurchasedReservations`)
- 고객 목록이 `limit=10`으로만 제한
- 1만명 규모에서 메모리 부족 가능

**해결방법**:
- 구매고객 목록에 페이지네이션 추가
- 고객 목록 검색 시 페이지네이션 추가
- 무한 스크롤 또는 페이지 번호 방식 구현

#### 3. 캐싱 부재

**문제점**:
- 통계 데이터가 매번 DB 조회
- 1만명 규모에서 쿼리 시간 증가

**해결방법**:
- Redis 캐싱 도입
- 통계 데이터 5분 TTL 설정
- 배치 작업으로 일별/주별 통계 집계

### 🟡 중간 성능 문제

1. **검색 최적화**
   - 전화번호 정규화를 DB 레벨에서 처리
   - Full-text search 도입 고려

2. **실시간 알림**
   - WebSocket 도입 고려
   - 현재는 폴링 방식 사용

### 🟢 경미한 성능 문제

1. **읽기 전용 복제본**
   - 통계 조회는 읽기 전용 복제본 사용
   - 메인 DB 부하 감소

2. **데이터 아카이빙**
   - 오래된 데이터 분리
   - 쿼리 성능 향상

---

## 5. 배포 체크리스트

### 5.1 필수 확인 사항

#### 환경변수 설정
```bash
# 필수 환경변수
GEMINI_API_KEY=your_key
GOOGLE_DRIVE_CLIENT_ID=your_id
GOOGLE_DRIVE_CLIENT_SECRET=your_secret
DATABASE_URL=your_db_url
NEXT_PUBLIC_BASE_URL=https://your-domain.com

# 알리고 API는 각 대리점장/판매원이 개별 설정 (DB에 저장)
```

#### 외부 서비스 설정
- ✅ Google Drive: 서비스 계정 설정, 권한 확인
- ✅ Gemini API: API 키 확인, 할당량 확인
- ⚠️ 알리고 API: 각 대리점장/판매원이 개별 설정 (본사 설정 불필요)

#### 데이터베이스
- 프로덕션 DB 연결 확인
- 인덱스 생성 확인 (위의 인덱스 목록 참조)
- 마이그레이션 실행 확인
- Connection Pool 설정 확인

#### 도메인 및 SSL
- 도메인 연결 확인
- SSL 인증서 확인
- CORS 설정 확인

### 5.2 배포 후 모니터링

#### 비용 모니터링
- 알리고 API 사용량 (각 대리점장/판매원별)
- Google Drive 저장 용량
- Gemini API 사용량

#### 성능 모니터링
- API 응답 시간
- 데이터베이스 쿼리 시간
- 파일 업로드 성공률

#### 에러 모니터링
- SMS 발송 실패율
- API 호출 실패율
- 데이터베이스 연결 오류

### 5.3 비용 예상 (1만명 규모 기준)

#### 월간 예상 비용

1. **SMS 발송 (알리고)**
   - 가정: 고객당 월 2건 발송
   - 10,000명 × 2건 = 20,000건
   - 비용: 20,000건 × 25원 = 약 50만원/월
   - **중요**: 각 대리점장/판매원이 개별 결제

2. **Google Drive**
   - 가정: 고객당 5MB 저장
   - 10,000명 × 5MB = 50GB
   - 비용: 무료 범위 내 (15GB 초과 시 과금)

3. **Gemini API**
   - 사용량에 따라 변동
   - 예상: 월 10-50만원

**총 예상 비용**: 월 60-100만원 (본사 부담)
- SMS는 각 대리점장/판매원이 개별 결제하므로 본사 부담 없음

---

## 6. 우선순위별 개선사항

### 🔴 우선순위 높음 (즉시 수정)

1. **DB 인덱스 추가**
   - `affiliateLead`, `affiliateSale`, `affiliateLink` 테이블에 인덱스 추가
   - 배포 전 필수

2. **구매고객 목록 페이지네이션**
   - 현재 전체 로드 → 페이지네이션 추가
   - 1만명 규모에서 필수

3. **통계 데이터 캐싱**
   - Redis 캐싱 도입
   - 5분 TTL 설정

4. **고객 검색 성능 개선**
   - 전화번호 정규화를 DB 레벨에서 처리
   - 인덱스 활용

### 🟡 우선순위 중간 (1-2주 내)

1. **대시보드에 퍼널 발송 현황 추가**
2. **그룹별 통계 대시보드 추가**
3. **랜딩페이지 통계 연동**
4. **커미션 계산 표시**

### 🟢 우선순위 낮음 (1개월 내)

1. **A/B 테스트 기능**
2. **고급 분석 대시보드**
3. **실시간 알림 시스템**
4. **데이터 아카이빙**

---

## 7. 결론

### ✅ 완료된 작업

1. **카카오톡 알림톡 기능 제거 완료**
   - 모든 UI에서 카카오톡 옵션 제거
   - 퍼널톡 섹션 제거
   - 비용 절감: 월 약 75만원

2. **알리고 API 개별 설정 확인**
   - 각 대리점장/판매원이 개별 설정
   - 본사 부담 없음

### ⚠️ 배포 전 필수 작업

1. **DB 인덱스 추가** (최우선)
2. **페이지네이션 구현** (구매고객 목록)
3. **환경변수 검증 스크립트 작성**
4. **각 대리점장/판매원에게 알리고 설정 안내**

### 📊 예상 비용

- **본사 부담**: 월 60-100만원 (Google Drive, Gemini API)
- **대리점장/판매원 개별 부담**: SMS 발송 비용 (각자 결제)

### 🎯 핵심 개선사항

1. **어필리에이트**: 커미션 계산 표시, 판매 추적 강화
2. **고객 관리**: 검색 성능 개선, 중복 방지
3. **구매 관리**: 페이지네이션, 취소/환불 처리
4. **효율성**: DB 인덱스, 캐싱, 페이지네이션

이 개선사항들을 적용하면 1만명 규모에서도 안정적으로 운영 가능합니다.

---

**작성 완료**: ✅  
**카카오톡 제거 완료**: ✅  
**알리고 개별 설정 확인**: ✅


