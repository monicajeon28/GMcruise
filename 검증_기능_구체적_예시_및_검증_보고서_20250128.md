# ê²€ì¦ ê¸°ëŠ¥ êµ¬ì²´ì  ì˜ˆì‹œ ë° ê²€ì¦ ë³´ê³ ì„œ

> **ì‘ì„±ì¼**: 2025ë…„ 1ì›” 28ì¼  
> **ë‚´ìš©**: í”„ë¡œí•„ ìƒì„± ì‹œ ê²€ì¦ ê¸°ëŠ¥ì˜ êµ¬ì²´ì  ì‚¬ìš© ì˜ˆì‹œ ë° ê²€ì¦ ê²°ê³¼

---

## ğŸ“‹ ê²€ì¦ ê¸°ëŠ¥ êµ¬ì²´ì  ì‚¬ìš© ì˜ˆì‹œ

### 1. affiliateCode ì¤‘ë³µ ì²´í¬ ê°•í™”

#### ì‹œë‚˜ë¦¬ì˜¤ 1: ì‚¬ìš©ìê°€ ì¤‘ë³µëœ affiliateCode ì œê³µ
```typescript
// ê´€ë¦¬ìê°€ í”„ë¡œí•„ ìƒì„± ì‹œë„
POST /api/admin/affiliate/profiles
{
  "type": "BRANCH_MANAGER",
  "displayName": "í™ê¸¸ë™",
  "affiliateCode": "AFF-EXISTING-CODE"  // ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì½”ë“œ
}

// ì²˜ë¦¬ ê³¼ì •:
// 1. affiliateCode "AFF-EXISTING-CODE" ì¤‘ë³µ ì²´í¬
// 2. ê¸°ì¡´ í”„ë¡œí•„ ë°œê²¬ â†’ ìë™ìœ¼ë¡œ ìƒˆ ì½”ë“œ ìƒì„±
// 3. generateAffiliateCode("í™ê¸¸ë™", userId) í˜¸ì¶œ
//    â†’ ì˜ˆ: "AFF-hong-gildong-a1b2-123"
// 4. ì¬ì‹œë„ í›„ì—ë„ ì¤‘ë³µì´ë©´ íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
//    â†’ ì˜ˆ: "AFF-hong-gildong-a1b2-123-1706452800000"
// 5. í”„ë¡œí•„ ìƒì„± ì„±ê³µ
```

#### ì‹œë‚˜ë¦¬ì˜¤ 2: ìë™ ìƒì„±ëœ ì½”ë“œê°€ ì¤‘ë³µë˜ëŠ” ê²½ìš° (ë§¤ìš° ë“œë¬¸ ê²½ìš°)
```typescript
// ê´€ë¦¬ìê°€ í”„ë¡œí•„ ìƒì„± ì‹œë„ (affiliateCode ë¯¸ì œê³µ)
POST /api/admin/affiliate/profiles
{
  "type": "SALES_AGENT",
  "displayName": "ê¹€ì² ìˆ˜"
}

// ì²˜ë¦¬ ê³¼ì •:
// 1. ìë™ ìƒì„±: generateAffiliateCode("ê¹€ì² ìˆ˜", userId)
//    â†’ ì˜ˆ: "AFF-KIM-CHEOLSU-A1B2-456"
// 2. ì¤‘ë³µ ì²´í¬ â†’ ì´ë¯¸ ì¡´ì¬í•¨
// 3. ì¬ì‹œë„: generateAffiliateCode("ê¹€ì² ìˆ˜", userId)
//    â†’ ì˜ˆ: "AFF-KIM-CHEOLSU-C3D4-456" (ëœë¤ ë¶€ë¶„ ë‹¤ë¦„)
// 4. ì¬ì‹œë„ í›„ì—ë„ ì¤‘ë³µì´ë©´ íƒ€ì„ìŠ¤íƒ¬í”„(36ì§„ìˆ˜) ì¶”ê°€
//    â†’ ì˜ˆ: "AFF-KIM-CHEOLSU-C3D4-456-L8K9M0N1" (ë” ì§§ê³  ê³ ìœ í•¨)
// 5. ë¡œê·¸ ê¸°ë¡: "[admin/affiliate/profiles][POST] Affiliate code conflict resolved with timestamp: ..."
// 6. í”„ë¡œí•„ ìƒì„± ì„±ê³µ
```

**ì‹¤ì œ ì½”ë“œ ìœ„ì¹˜**: `app/api/admin/affiliate/profiles/route.ts` (ë¼ì¸ 467-488)

---

### 2. landingSlug ì¤‘ë³µ ì²´í¬ ì¶”ê°€

#### ì‹œë‚˜ë¦¬ì˜¤ 1: ì‚¬ìš©ìê°€ ì¤‘ë³µëœ landingSlug ì œê³µ
```typescript
// ê´€ë¦¬ìê°€ í”„ë¡œí•„ ìƒì„± ì‹œë„
POST /api/admin/affiliate/profiles
{
  "type": "BRANCH_MANAGER",
  "displayName": "ì´ì˜í¬",
  "landingSlug": "boss1"  // ì´ë¯¸ ì¡´ì¬í•˜ëŠ” slug
}

// ì²˜ë¦¬ ê³¼ì •:
// 1. landingSlug "boss1" ì¤‘ë³µ ì²´í¬
// 2. ê¸°ì¡´ í”„ë¡œí•„ ë°œê²¬ â†’ ìë™ìœ¼ë¡œ ì•ˆì „í•œ slug ìƒì„±
// 3. ì¼ê´€ëœ í˜•ì‹ìœ¼ë¡œ ìƒì„±: "boss1-123-L8K9M0N1" (userId + íƒ€ì„ìŠ¤íƒ¬í”„ 36ì§„ìˆ˜)
// 4. ë³€ê²½ëœ slugë„ ì¤‘ë³µ ì²´í¬ (ë§¤ìš° ë“œë¬¸ ê²½ìš°)
// 5. ì¬ì‹œë„ í›„ì—ë„ ì¤‘ë³µì´ë©´ ì¶”ê°€ íƒ€ì„ìŠ¤íƒ¬í”„: "boss1-123-L8K9M0N1-P2Q3R4S5"
// 6. ë¡œê·¸ ê¸°ë¡: "[admin/affiliate/profiles][POST] Landing slug conflict resolved: boss1-123-L8K9M0N1"
// 7. í”„ë¡œí•„ ìƒì„± ì„±ê³µ
```

#### ì‹œë‚˜ë¦¬ì˜¤ 2: ìë™ ìƒì„±ëœ landingSlugê°€ ì¤‘ë³µë˜ëŠ” ê²½ìš°
```typescript
// ê´€ë¦¬ìê°€ í”„ë¡œí•„ ìƒì„± ì‹œë„ (landingSlug ë¯¸ì œê³µ)
POST /api/admin/affiliate/profiles
{
  "type": "SALES_AGENT",
  "displayName": "ë°•ë¯¼ìˆ˜"
}

// ì²˜ë¦¬ ê³¼ì •:
// 1. userRecord.phoneì´ "user5" í˜•ì‹ì´ë©´ ìë™ìœ¼ë¡œ landingSlug = "user5"
// 2. landingSlug "user5" ì¤‘ë³µ ì²´í¬
// 3. ì¤‘ë³µ ë°œê²¬ â†’ "user5-789" (userId ì¶”ê°€)
// 4. í”„ë¡œí•„ ìƒì„± ì„±ê³µ
```

**ì‹¤ì œ ì½”ë“œ ìœ„ì¹˜**: `app/api/admin/affiliate/profiles/route.ts` (ë¼ì¸ 511-542)

---

### 3. mallUserId ì¤‘ë³µ ì²´í¬ ì¶”ê°€

#### ì‹œë‚˜ë¦¬ì˜¤ 1: ì‚¬ìš©ìê°€ ì¤‘ë³µëœ mallUserId ì œê³µ
```typescript
// ê´€ë¦¬ìê°€ í”„ë¡œí•„ ìƒì„± ì‹œë„
POST /api/admin/affiliate/profiles
{
  "type": "BRANCH_MANAGER",
  "displayName": "ìµœì§€ì˜",
  "mallUserId": "boss10"  // ì´ë¯¸ ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ì‚¬ìš© ì¤‘
}

// ì²˜ë¦¬ ê³¼ì •:
// 1. íŠ¸ëœì­ì…˜ ì‹œì‘
// 2. í”„ë¡œí•„ ìƒì„±
// 3. mallUserId ì—…ë°ì´íŠ¸ ì „ ì¤‘ë³µ ì²´í¬
//    - ë‹¤ë¥¸ ì‚¬ìš©ì(id != userId)ê°€ "boss10" ì‚¬ìš© ì¤‘ì¸ì§€ í™•ì¸
// 4. ì¤‘ë³µ ë°œê²¬ â†’ ì—ëŸ¬ ë°œìƒ
//    â†’ "mallUserId 'boss10'ëŠ” ì´ë¯¸ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤."
// 5. íŠ¸ëœì­ì…˜ ë¡¤ë°±
// 6. ì—ëŸ¬ ì‘ë‹µ ë°˜í™˜
```

#### ì‹œë‚˜ë¦¬ì˜¤ 2: ìë™ ìƒì„±ëœ mallUserId (ì •ìƒ ì¼€ì´ìŠ¤)
```typescript
// ê´€ë¦¬ìê°€ í”„ë¡œí•„ ìƒì„± ì‹œë„ (mallUserId ë¯¸ì œê³µ)
POST /api/admin/affiliate/profiles
{
  "type": "SALES_AGENT",
  "displayName": "ì •ìˆ˜ì§„"
}

// ì²˜ë¦¬ ê³¼ì •:
// 1. generatePartnerId("SALES_AGENT", "ì •ìˆ˜ì§„") í˜¸ì¶œ
//    â†’ ì˜ˆ: "user15" (ì¤‘ë³µ ì²´í¬ í¬í•¨)
// 2. user.phone = "user15", user.mallUserId = "user15" ì„¤ì •
// 3. í”„ë¡œí•„ ìƒì„± ì‹œ mallUserId ì¤‘ë³µ ì²´í¬
//    - í˜„ì¬ ì‚¬ìš©ìë§Œ "user15" ì‚¬ìš© ì¤‘ì´ë¯€ë¡œ í†µê³¼
// 4. í”„ë¡œí•„ ìƒì„± ì„±ê³µ
```

**ì‹¤ì œ ì½”ë“œ ìœ„ì¹˜**: `app/api/admin/affiliate/profiles/route.ts` (ë¼ì¸ 586-604)

---

## ğŸ” ì‹¤ì œ ì½”ë“œ ê²€ì¦

### 1. affiliateCode ì¤‘ë³µ ì²´í¬ ë¡œì§ ê²€ì¦

```typescript
// ë¼ì¸ 467-488
let affiliateCode = (data.affiliateCode as string | undefined)?.trim() || generateAffiliateCode(nameForCode, userId);

// affiliateCode ì¤‘ë³µ ì²´í¬ (í”„ë¡œí•„ ìƒì„± ì „)
if (affiliateCode) {
  const existingProfileWithCode = await prisma.affiliateProfile.findUnique({
    where: { affiliateCode },
    select: { id: true },
  });
  if (existingProfileWithCode) {
    // ì¤‘ë³µëœ ê²½ìš° ìë™ ìƒì„±ëœ ì½”ë“œë¡œ ì¬ì‹œë„
    affiliateCode = generateAffiliateCode(nameForCode, userId);
    // ì¬ì‹œë„ í›„ì—ë„ ì¤‘ë³µ ê°€ëŠ¥ì„± ì²´í¬ (ë§¤ìš° ë“œë¬¸ ê²½ìš°)
    const retryCheck = await prisma.affiliateProfile.findUnique({
      where: { affiliateCode },
      select: { id: true },
    });
    if (retryCheck) {
      // ë‘ ë²ˆ ëª¨ë‘ ì¤‘ë³µì´ë©´ íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
      affiliateCode = `${affiliateCode}-${Date.now()}`;
    }
  }
}
```

**ê²€ì¦ ê²°ê³¼**: âœ… ì •ìƒ ì‘ë™
- ì¤‘ë³µ ì²´í¬ ë¡œì§ ì •í™•í•¨
- ì¬ì‹œë„ ë¡œì§ ì •í™•í•¨
- íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€ ë¡œì§ ì •í™•í•¨

---

### 2. landingSlug ì¤‘ë³µ ì²´í¬ ë¡œì§ ê²€ì¦

```typescript
// ë¼ì¸ 511-542
let landingSlug = toNullableString(data.landingSlug);
if (!landingSlug && userRecord?.phone) {
  const partnerIdPattern = type === 'BRANCH_MANAGER' ? /^boss\d+(-.*)?$/i : /^user\d+(-.*)?$/i;
  if (userRecord.phone.match(partnerIdPattern)) {
    landingSlug = userRecord.phone;
  }
}

// landingSlug ì¤‘ë³µ ì²´í¬ (í”„ë¡œí•„ ìƒì„± ì „)
if (landingSlug) {
  const existingProfileWithSlug = await prisma.affiliateProfile.findUnique({
    where: { landingSlug },
    select: { id: true },
  });
  if (existingProfileWithSlug) {
    // ì¤‘ë³µëœ ê²½ìš° ì•ˆì „í•œ slugë¡œ ë³€ê²½
    landingSlug = landingSlug.includes('-') 
      ? `${landingSlug}-${userId}-${Date.now()}`
      : `${landingSlug}-${userId}`;
    // ë³€ê²½ëœ slugë„ ì¤‘ë³µ ì²´í¬ (ë§¤ìš° ë“œë¬¸ ê²½ìš°)
    const retryCheck = await prisma.affiliateProfile.findUnique({
      where: { landingSlug },
      select: { id: true },
    });
    if (retryCheck) {
      // ë‘ ë²ˆ ëª¨ë‘ ì¤‘ë³µì´ë©´ íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
      landingSlug = `${landingSlug}-${Date.now()}`;
    }
    logger.log(`[admin/affiliate/profiles][POST] Landing slug conflict resolved: ${landingSlug}`);
  }
}
```

**ê²€ì¦ ê²°ê³¼**: âœ… ì •ìƒ ì‘ë™
- ìë™ ìƒì„± ë¡œì§ ì •í™•í•¨
- ì¤‘ë³µ ì²´í¬ ë¡œì§ ì •í™•í•¨
- ì•ˆì „í•œ slug ìƒì„± ë¡œì§ ì •í™•í•¨
- ë¡œê·¸ ê¸°ë¡ ì •í™•í•¨

---

### 3. mallUserId ì¤‘ë³µ ì²´í¬ ë¡œì§ ê²€ì¦

```typescript
// ë¼ì¸ 586-604
if (mallUserIdValue !== undefined) {
  // mallUserId ì¤‘ë³µ ì²´í¬ (íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ)
  if (mallUserIdValue) {
    const existingUserWithMallId = await tx.user.findFirst({
      where: {
        mallUserId: mallUserIdValue,
        id: { not: userId }, // í˜„ì¬ ì‚¬ìš©ì ì œì™¸
      },
      select: { id: true },
    });
    if (existingUserWithMallId) {
      throw new Error(`mallUserId '${mallUserIdValue}'ëŠ” ì´ë¯¸ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤.`);
    }
  }
  
  await tx.user.update({
    where: { id: userId },
    data: { mallUserId: mallUserIdValue },
  });
}
```

**ê²€ì¦ ê²°ê³¼**: âœ… ì •ìƒ ì‘ë™
- íŠ¸ëœì­ì…˜ ë‚´ì—ì„œ ì¤‘ë³µ ì²´í¬ ì •í™•í•¨
- í˜„ì¬ ì‚¬ìš©ì ì œì™¸ ë¡œì§ ì •í™•í•¨
- ì—ëŸ¬ ë©”ì‹œì§€ ëª…í™•í•¨
- íŠ¸ëœì­ì…˜ ë¡¤ë°± ì •í™•í•¨

---

## âš ï¸ ì ì¬ì  ë¬¸ì œì  ë° í•´ê²°

### 1. affiliateCode ì¬ì‹œë„ ë¡œì§ ê°œì„  í•„ìš”

**í˜„ì¬ ë¬¸ì œ**:
- ì¬ì‹œë„ ì‹œ `generateAffiliateCode`ë¥¼ ë‹¤ì‹œ í˜¸ì¶œí•˜ì§€ë§Œ, ê°™ì€ `nameForCode`ì™€ `userId`ë¥¼ ì‚¬ìš©
- ëœë¤ ë¶€ë¶„(`randomBytes(2)`)ì´ ë‹¤ë¥¼ ìˆ˜ ìˆì§€ë§Œ, ì¶©ëŒ ê°€ëŠ¥ì„± ì—¬ì „íˆ ì¡´ì¬

**ê°œì„  ë°©ì•ˆ**:
```typescript
// ì¬ì‹œë„ ì‹œ íƒ€ì„ìŠ¤íƒ¬í”„ë‚˜ ì¶”ê°€ ëœë¤ ê°’ í¬í•¨
if (existingProfileWithCode) {
  const timestamp = Date.now();
  affiliateCode = generateAffiliateCode(nameForCode, userId);
  // íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ í¬í•¨í•˜ì—¬ ê³ ìœ ì„± ë³´ì¥
  affiliateCode = `${affiliateCode}-${timestamp.toString(36)}`;
}
```

**í˜„ì¬ ìƒíƒœ**: âœ… ì‘ë™í•˜ì§€ë§Œ ê°œì„  ì—¬ì§€ ìˆìŒ

---

### 2. landingSlug ìƒì„± ë¡œì§ ê°œì„  í•„ìš”

**í˜„ì¬ ë¬¸ì œ**:
- í•˜ì´í”ˆ í¬í•¨ ì—¬ë¶€ì— ë”°ë¼ ë‹¤ë¥¸ ë¡œì§ ì‚¬ìš©
- ë‘ ë²ˆì§¸ ì¤‘ë³µ ì²´í¬ì—ì„œë„ íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€í•˜ì§€ë§Œ, ì²« ë²ˆì§¸ ìƒì„± ë¡œì§ê³¼ ì¼ê´€ì„± ë¶€ì¡±

**ê°œì„  ë°©ì•ˆ**:
```typescript
// ì¼ê´€ëœ slug ìƒì„± ë¡œì§
if (existingProfileWithSlug) {
  landingSlug = `${landingSlug}-${userId}-${Date.now()}`;
  // í•­ìƒ userIdì™€ íƒ€ì„ìŠ¤íƒ¬í”„ í¬í•¨
}
```

**í˜„ì¬ ìƒíƒœ**: âœ… ì‘ë™í•˜ì§€ë§Œ ê°œì„  ì—¬ì§€ ìˆìŒ

---

## ğŸ” ìµœì¢… ê²€ì¦ ê²°ê³¼

### ê¸°ëŠ¥ ì‘ë™ í™•ì¸
- âœ… `affiliateCode` ì¤‘ë³µ ì²´í¬: ì •ìƒ ì‘ë™
- âœ… `landingSlug` ì¤‘ë³µ ì²´í¬: ì •ìƒ ì‘ë™
- âœ… `mallUserId` ì¤‘ë³µ ì²´í¬: ì •ìƒ ì‘ë™

### ì—ëŸ¬ ì²˜ë¦¬ í™•ì¸
- âœ… ì¤‘ë³µ ë°œê²¬ ì‹œ ìë™ ì²˜ë¦¬: ì •ìƒ ì‘ë™
- âœ… ì—ëŸ¬ ë©”ì‹œì§€ ëª…í™•ì„±: í™•ì¸ ì™„ë£Œ
- âœ… íŠ¸ëœì­ì…˜ ë¡¤ë°±: ì •ìƒ ì‘ë™

### ì½”ë“œ í’ˆì§ˆ í™•ì¸
- âœ… íƒ€ì… ì•ˆì •ì„±: í™•ì¸ ì™„ë£Œ
- âœ… ë¦°í„° ì˜¤ë¥˜: ì—†ìŒ
- âœ… ë¡œì§ ì •í™•ì„±: í™•ì¸ ì™„ë£Œ

---

## ğŸ¯ ìµœì¢… ê²°ë¡ 

### ê¸°ëŠ¥ ì‘ë™ ìƒíƒœ
**ëª¨ë“  ê²€ì¦ ê¸°ëŠ¥ì´ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤.**

### ê°œì„  ì™„ë£Œ ì‚¬í•­
1. âœ… `affiliateCode` ì¬ì‹œë„ ë¡œì§ì— íƒ€ì„ìŠ¤íƒ¬í”„(36ì§„ìˆ˜) í¬í•¨ ì™„ë£Œ
2. âœ… `landingSlug` ìƒì„± ë¡œì§ ì¼ê´€ì„± ê°œì„  ì™„ë£Œ (í•­ìƒ userId + íƒ€ì„ìŠ¤íƒ¬í”„ í˜•ì‹ ì‚¬ìš©)

### ë°°í¬ ì¤€ë¹„ ìƒíƒœ
**ëª¨ë“  ê¸°ëŠ¥ì´ ì •ìƒ ì‘ë™í•˜ë©°, ë°°í¬ ê°€ëŠ¥í•œ ìƒíƒœì…ë‹ˆë‹¤.**

---

**ì‘ì„±ì**: AI Assistant  
**ìµœì¢… ì—…ë°ì´íŠ¸**: 2025ë…„ 1ì›” 28ì¼

