# Google Drive 마이그레이션 실행 가이드

## 📋 마이그레이션 순서

### 1단계: 로컬 파일을 Google Drive로 업로드

기존 로컬 파일들을 Google Drive로 업로드합니다.

#### 실행 방법

```bash
# Dry-run 모드 (실제 업로드 없이 확인만)
npm run migrate:uploads -- --dry-run

# 실제 업로드 (로컬 파일 유지)
npm run migrate:uploads

# 실제 업로드 + 로컬 파일 삭제 (주의!)
npm run migrate:uploads -- --delete-local

# 특정 폴더만 마이그레이션
npm run migrate:uploads -- --only=images,profiles
```

#### 지원하는 폴더

- `images`: 일반 이미지
- `profiles`: 프로필 이미지
- `reviews`: 리뷰 이미지
- `audio`: 오디오 파일
- `documents`: 문서 파일
- `videos`: 비디오 파일
- `sales-audio`: 판매 오디오 파일
- `fonts`: 폰트 파일
- `contracts-pdfs`: 계약서 PDF
- `pages`: 페이지 이미지
- `cruise-images`: 크루즈정보사진

#### 결과

- 마이그레이션 결과는 `migrations/uploads-to-drive-{timestamp}.json`에 저장됩니다.
- 각 파일의 Google Drive URL이 기록됩니다.

---

### 2단계: 데이터베이스 경로를 Google Drive URL로 변환

데이터베이스에 저장된 로컬 경로를 Google Drive URL로 변환합니다.

#### 실행 방법

```bash
# Dry-run 모드 (실제 DB 변경 없이 확인만)
npm run migrate:db-paths -- --dry-run

# 실제 마이그레이션
npm run migrate:db-paths
```

#### 마이그레이션 대상

1. **User**
   - `profileImage`: 프로필 이미지
   - `coverImage`: 커버 이미지

2. **CruiseProduct**
   - `galleryImages`: 갤러리 이미지 (JSON 배열)
   - `featuredImages`: 대표 이미지 (JSON 배열)

3. **CruiseReview**
   - `images`: 리뷰 이미지 (JSON 배열)

4. **CommunityPost**
   - `images`: 커뮤니티 포스트 이미지 (JSON 배열)

5. **Reservation**
   - `passportImage`: 여권 이미지

#### 주의사항

⚠️ **중요**: 
- 마이그레이션 전에 **데이터베이스 백업**을 반드시 수행하세요!
- Dry-run 모드로 먼저 확인하세요.
- 프로덕션 환경에서는 신중하게 진행하세요.

#### 결과

- 마이그레이션 결과는 `migrations/db-paths-to-drive-{timestamp}.json`에 저장됩니다.
- 성공/실패 통계가 콘솔에 출력됩니다.

---

## 🔄 전체 마이그레이션 프로세스

### 권장 순서

1. **환경변수 확인**
   ```bash
   # .env.local 파일에 모든 Google Drive 폴더 ID가 설정되어 있는지 확인
   cat .env.local | grep GOOGLE_DRIVE
   ```

2. **1단계: 로컬 파일 업로드 (Dry-run)**
   ```bash
   npm run migrate:uploads -- --dry-run
   ```
   - 결과를 확인하고 문제가 없으면 다음 단계로 진행

3. **1단계: 로컬 파일 업로드 (실제)**
   ```bash
   npm run migrate:uploads
   ```
   - 로컬 파일은 유지 (나중에 확인 후 삭제 가능)

4. **2단계: 데이터베이스 경로 변환 (Dry-run)**
   ```bash
   npm run migrate:db-paths -- --dry-run
   ```
   - 어떤 레코드가 변경될지 확인

5. **데이터베이스 백업**
   ```bash
   # PostgreSQL 백업 예시
   pg_dump $DATABASE_URL > backup-$(date +%Y%m%d-%H%M%S).sql
   ```

6. **2단계: 데이터베이스 경로 변환 (실제)**
   ```bash
   npm run migrate:db-paths
   ```

7. **결과 확인 및 검증**
   ```bash
   # 마이그레이션 결과 검증
   npm run migrate:verify
   ```
   - 마이그레이션 보고서 확인
   - 사이트에서 이미지가 정상적으로 표시되는지 확인

8. **로컬 파일 정리 (선택사항)**
   ```bash
   # 모든 것이 정상 작동하는 것을 확인한 후
   npm run migrate:uploads -- --delete-local
   ```

---

## 📊 마이그레이션 보고서 확인

### 파일 위치

- 로컬 파일 마이그레이션: `migrations/uploads-to-drive-{timestamp}.json`
- DB 경로 마이그레이션: `migrations/db-paths-to-drive-{timestamp}.json`

### 보고서 구조

```json
[
  {
    "target": "images",
    "localPath": "public/uploads/images/1234567890_example.jpg",
    "driveFileId": "1a2b3c4d5e6f7g8h9i0j",
    "driveUrl": "https://drive.google.com/uc?export=view&id=1a2b3c4d5e6f7g8h9i0j",
    "status": "uploaded"
  },
  {
    "model": "User",
    "field": "profileImage",
    "recordId": 123,
    "oldPath": "/uploads/profiles/old.jpg",
    "newUrl": "https://drive.google.com/uc?export=view&id=...",
    "status": "migrated"
  }
]
```

### 상태 값

- `uploaded`: 성공적으로 업로드됨
- `migrated`: 데이터베이스에 성공적으로 반영됨
- `skipped`: 건너뜀 (이미 Google Drive URL이거나 파일이 없음)
- `error`: 오류 발생
- `not-found`: 파일을 찾을 수 없음

---

## 🐛 문제 해결

### 파일을 찾을 수 없음

- 로컬 파일이 이미 삭제되었을 수 있습니다.
- 경로가 올바른지 확인하세요.
- `--dry-run`으로 먼저 확인하세요.

### Google Drive 업로드 실패

- 환경변수가 올바르게 설정되었는지 확인
- Google Drive API 할당량 확인
- 서비스 계정 권한 확인

### 데이터베이스 업데이트 실패

- 데이터베이스 연결 확인
- Prisma 스키마 확인
- 트랜잭션 오류 확인 (로그 확인)

---

## ✅ 마이그레이션 완료 체크리스트

- [ ] 모든 환경변수 설정 완료
- [ ] 1단계 Dry-run 실행 및 확인
- [ ] 1단계 실제 마이그레이션 완료
- [ ] 2단계 Dry-run 실행 및 확인
- [ ] 데이터베이스 백업 완료
- [ ] 2단계 실제 마이그레이션 완료
- [ ] 마이그레이션 검증 실행 (`npm run migrate:verify`)
- [ ] 사이트에서 이미지 정상 표시 확인
- [ ] 마이그레이션 보고서 검토
- [ ] 로컬 파일 정리 (선택사항)

---

## 🔍 마이그레이션 검증

### 실행 방법

```bash
npm run migrate:verify
```

### 검증 항목

- 모든 이미지 URL이 Google Drive URL인지 확인
- 로컬 경로가 남아있는지 확인
- URL 접근 가능 여부 확인

### 검증 결과

- `valid`: 유효한 Google Drive URL
- `invalid`: 무효한 URL (접근 불가)
- `local-path`: 아직 로컬 경로 (마이그레이션 필요)
- `missing`: URL이 없음

---

## 📞 지원

문제가 발생하면 마이그레이션 보고서와 함께 문의하세요.

