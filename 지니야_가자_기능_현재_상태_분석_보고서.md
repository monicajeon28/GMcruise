# "지니야 가자" 기능 현재 상태 분석 보고서

> **작성일**: 2025-01-23  
> **분석 대상**: 크루즈가이드 지니 AI & 크루즈가이드 지니 3일체험  
> **분석 범위**: "지니야 가자" (go mode) 기능 구현 및 두 앱 간 차이점

---

## 📋 목차

1. [현재 구현 상태](#현재-구현-상태)
2. [두 앱 간 차이점 분석](#두-앱-간-차이점-분석)
3. [발견된 문제점](#발견된-문제점)
4. [개선 권장사항](#개선-권장사항)
5. [코드 구조 분석](#코드-구조-분석)

---

## 현재 구현 상태

### 1. 핵심 구현 파일

#### API 라우트: `/app/api/chat/route.ts`

```26:32:app/api/chat/route.ts
    // go 모드: 경로 안내
    if (mode === 'go') {
      // from과 to가 있으면 사용, 없으면 text에서 파싱
      const searchText = (from && to) ? `${from}에서 ${to}까지` : text;
      const messages = handleDirections(searchText);
      return NextResponse.json({ ok: true, messages });
    }
```

**처리 방식:**
- `mode === 'go'`일 때 `handleDirections()` 함수 호출
- `from`과 `to` 파라미터가 있으면 조합, 없으면 `text`에서 파싱

---

#### 핵심 로직: `/app/api/chat/handlers/directions.ts`

```4:36:app/api/chat/handlers/directions.ts
export function handleDirections(text: string): ChatMessage[] {
  const m = text.match(/(.+?)에서\s+(.+?)까지/);
  if (!m) {
    return [{ type:'text', text:'출발지와 도착지를 "A에서 B까지" 형식으로 입력해 주세요.' }];
  }
  const from = m[1].trim();
  const to   = m[2].trim();

  // gmDirUrl은 옵션 객체를 받습니다
  const drivingUrl = gmDirUrl({ 
    origin: from, 
    destination: to, 
    mode: 'driving' 
  });
  const transitUrl = gmDirUrl({ 
    origin: from, 
    destination: to, 
    mode: 'transit' 
  });

  return [
    { type:'text', text:`확인했어요.\n출발지: ${from}\n도착지: ${to}` },
    {
      type:'map-links',
      title:'길찾기',
      links:[
        { label:'🚗 자동차 길찾기(구글 지도)', href: drivingUrl },
        { label:'🚇 대중교통 길찾기(구글 지도)', href: transitUrl },
      ],
    },
    { type:'text', text:'새 창에서 열려요. 지도에서 **시작**만 누르시면 됩니다.' }
  ];
}
```

**현재 구현 특징:**
- ✅ 단순 정규식 패턴 매칭: `/(.+?)에서\s+(.+?)까지/`
- ✅ Google Maps 링크 생성: 자동차(`driving`)와 대중교통(`transit`)만 제공
- ❌ **walking 모드 미제공**: `lib/maps.ts`에 `walking` 모드 지원이 있으나 사용 안 함
- ❌ **고급 파싱 미사용**: `lib/maps.ts`의 `resolveFromTo()` 함수가 있으나 사용 안 함

---

### 2. 클라이언트 구현

#### 입력 처리: `/app/chat/components/InputBar.tsx`

```404:420:app/chat/components/InputBar.tsx
      const combinedText = mode === 'go' 
        ? [finalOrigin, finalDest].filter(Boolean).join(' → ') 
        : finalDest || finalOrigin || '';
      
      if (!combinedText.trim()) {
        console.error('[InputBar] Empty text, cannot send');
        return;
      }
      
      console.log('[InputBar] Sending:', { mode, combinedText, finalOrigin, finalDest, originPick, destPick });
      
      onSend({
        mode: mode === 'go' ? 'go' : 'show', 
        text: combinedText,
        from: finalOrigin || undefined,
        to: finalDest || undefined,
      });
```

**전송 형식:**
- `mode: 'go'`
- `text`: `"출발지 → 도착지"` 형식
- `from`: 출발지 (선택적)
- `to`: 도착지 (선택적)

---

## 두 앱 간 차이점 분석

### 1. 시스템 프롬프트 차이

#### 일반 사용자 (크루즈가이드 지니 AI)

```209:221:app/api/chat/stream/route.ts
      : `당신은 크루즈 여행 전문 AI 어시스턴트 '지니'입니다. 
- 한국어로 간단명료하게 답변하세요.
- 답변은 반드시 100자 이내로 간략하게 작성하세요.
- 핵심 정보만 전달하고 불필요한 설명은 생략하세요.
- 최신 정보가 필요한 질문은 Google Search를 활용하여 정확한 정보를 제공하세요.
- 검색 결과를 바탕으로 간결하고 정확한 답변을 제공하세요.

[크루즈 상품 안내]
- 사용자가 크루즈 상품에 대해 물어보면 [판매 중인 크루즈 상품 정보]를 참고하여 추천하세요.
- 상품코드, 기간, 가격, 설명을 포함하여 간단명료하게 안내하세요.
- 여러 상품이 있으면 인기 상품을 우선 추천하세요.

사용자의 질문에 필요한 핵심만 전달하세요.${ragContext}${productContext}`;
```

#### 3일 체험 사용자 (크루즈가이드 지니 3일체험)

```192:208:app/api/chat/stream/route.ts
    const baseSystemPrompt = isTrialUser
      ? `당신은 크루즈 가이드 지니 3일 체험 전용 AI 어시스턴트입니다.
- 이 사용자는 크루즈 가이드 지니 3일 체험 사용자입니다.
- 3일 체험 사용자들은 3일 체험 사용자들끼리만 연결되어야 합니다.
- 일반 크루즈 가이드 지니가 아닌, 3일 체험 전용 지니로 동작하세요.
- 한국어로 간단명료하게 답변하세요.
- 답변은 반드시 100자 이내로 간략하게 작성하세요.
- 핵심 정보만 전달하고 불필요한 설명은 생략하세요.
- 최신 정보가 필요한 질문은 Google Search를 활용하여 정확한 정보를 제공하세요.
- 검색 결과를 바탕으로 간결하고 정확한 답변을 제공하세요.

[크루즈 상품 안내]
- 사용자가 크루즈 상품에 대해 물어보면 [판매 중인 크루즈 상품 정보]를 참고하여 추천하세요.
- 상품코드, 기간, 가격, 설명을 포함하여 간단명료하게 안내하세요.
- 여러 상품이 있으면 인기 상품을 우선 추천하세요.

사용자의 질문에 필요한 핵심만 전달하세요.${ragContext}${productContext}`
```

**차이점:**
- ✅ **3일 체험 사용자**: "3일 체험 전용 AI 어시스턴트" 명시
- ✅ **일반 사용자**: "크루즈 여행 전문 AI 어시스턴트"
- ⚠️ **"지니야 가자" 기능 자체는 동일**: 두 앱 모두 동일한 `handleDirections()` 함수 사용

---

### 2. "지니야 가자" 기능 처리 방식

**결론: 두 앱 모두 동일한 방식으로 처리됨**

1. **API 엔드포인트**: `/api/chat` (동일)
2. **핸들러 함수**: `handleDirections()` (동일)
3. **응답 형식**: `map-links` 타입 (동일)
4. **Google Maps 링크**: 자동차 + 대중교통 (동일)

**차이점 없음**: "지니야 가자" 기능은 두 앱에서 완전히 동일하게 작동합니다.

---

## 발견된 문제점

### 🔴 심각도: 높음

#### 1. 고급 파싱 함수 미사용

**문제:**
- `lib/maps.ts`에 `resolveFromTo()` 함수가 구현되어 있으나 사용되지 않음
- 현재는 단순 정규식 `/(.+?)에서\s+(.+?)까지/`만 사용

**영향:**
- ❌ "A부터 B까지" 패턴 인식 불가
- ❌ "A → B" 화살표 패턴 인식 불가
- ❌ 지명 하나만 입력 시 공항/터미널 자동 추론 불가
- ❌ 영어 패턴 ("A to B") 인식 불가

**현재 지원되는 패턴:**
- ✅ "A에서 B까지" (한국어만)

**미지원 패턴 (resolveFromTo는 지원하지만 미사용):**
- ❌ "A부터 B까지"
- ❌ "A → B" (화살표)
- ❌ "A to B" (영어)
- ❌ "마이애미" (지명만 입력 시 공항→터미널 자동 추론)

---

#### 2. Walking 모드 미제공

**문제:**
- `lib/maps.ts`의 `buildAllDirUrls()` 함수는 `walking` 모드를 지원
- `handleDirections()`는 `driving`과 `transit`만 제공

**현재 제공:**
- ✅ 자동차 (`driving`)
- ✅ 대중교통 (`transit`)
- ❌ 도보 (`walking`) - 미제공

---

### 🟡 심각도: 중간

#### 3. 에러 메시지 형식 제한적

**현재:**
```typescript
if (!m) {
  return [{ type:'text', text:'출발지와 도착지를 "A에서 B까지" 형식으로 입력해 주세요.' }];
}
```

**문제:**
- 다른 패턴을 시도해도 동일한 에러 메시지
- 사용자가 어떤 형식을 입력해야 하는지 명확하지 않음

---

#### 4. 입력 형식 검증 부족

**현재:**
- 클라이언트에서 `from`과 `to`를 전송하지만, 서버에서는 `text`만 파싱
- `from`과 `to` 파라미터가 있어도 `text`로 재조합 후 파싱

**코드:**
```typescript
const searchText = (from && to) ? `${from}에서 ${to}까지` : text;
```

**문제:**
- `from`과 `to`가 이미 파싱된 상태인데 다시 `text`로 조합 후 파싱
- 불필요한 변환 과정

---

## 개선 권장사항

### 🔴 우선순위: 최고 (즉시 개선)

#### 1. `resolveFromTo()` 함수 활용

**현재 코드:**
```typescript
export function handleDirections(text: string): ChatMessage[] {
  const m = text.match(/(.+?)에서\s+(.+?)까지/);
  if (!m) {
    return [{ type:'text', text:'출발지와 도착지를 "A에서 B까지" 형식으로 입력해 주세요.' }];
  }
  const from = m[1].trim();
  const to   = m[2].trim();
  // ...
}
```

**개선안:**
```typescript
import { resolveFromTo, buildAllDirUrls } from '@/lib/maps';

export function handleDirections(text: string): ChatMessage[] {
  const parsed = resolveFromTo(text);
  
  if (!parsed) {
    return [{ 
      type:'text', 
      text:'출발지와 도착지를 입력해 주세요.\n예: "마이애미 공항에서 마이애미 크루즈 터미널까지"\n또는 "마이애미"만 입력해도 자동으로 공항→터미널 경로를 찾아드려요.' 
    }];
  }
  
  const { origin, dest, originText, destText } = parsed;
  const urls = buildAllDirUrls(origin, dest);
  
  return [
    { type:'text', text:`확인했어요.\n출발지: ${originText}\n도착지: ${destText}` },
    {
      type:'map-links',
      title:'길찾기',
      links:[
        { label:'🚗 자동차 길찾기', href: urls.driving },
        { label:'🚇 대중교통 길찾기', href: urls.transit },
        { label:'🚶 도보 길찾기', href: urls.walking },
      ],
    },
    { type:'text', text:'새 창에서 열려요. 지도에서 **시작**만 누르시면 됩니다.' }
  ];
}
```

**효과:**
- ✅ 다양한 입력 패턴 지원
- ✅ 지명만 입력해도 자동 추론
- ✅ 도보 모드 추가
- ✅ 사용자 경험 대폭 개선

**예상 작업 시간:** 1-2시간

---

#### 2. `from`/`to` 파라미터 직접 활용

**현재 코드:**
```typescript
if (mode === 'go') {
  const searchText = (from && to) ? `${from}에서 ${to}까지` : text;
  const messages = handleDirections(searchText);
  return NextResponse.json({ ok: true, messages });
}
```

**개선안:**
```typescript
if (mode === 'go') {
  let messages: ChatMessage[];
  
  if (from && to) {
    // from/to가 이미 파싱된 경우 직접 사용
    const origin = { text: from };
    const dest = { text: to };
    const urls = buildAllDirUrls(origin, dest);
    messages = [
      { type:'text', text:`확인했어요.\n출발지: ${from}\n도착지: ${to}` },
      {
        type:'map-links',
        title:'길찾기',
        links:[
          { label:'🚗 자동차 길찾기', href: urls.driving },
          { label:'🚇 대중교통 길찾기', href: urls.transit },
          { label:'🚶 도보 길찾기', href: urls.walking },
        ],
      },
      { type:'text', text:'새 창에서 열려요. 지도에서 **시작**만 누르시면 됩니다.' }
    ];
  } else {
    // text에서 파싱
    messages = handleDirections(text);
  }
  
  return NextResponse.json({ ok: true, messages });
}
```

**효과:**
- ✅ 불필요한 변환 제거
- ✅ 성능 개선
- ✅ 코드 명확성 향상

**예상 작업 시간:** 30분-1시간

---

### 🟡 우선순위: 높음 (단기 개선)

#### 3. 에러 메시지 개선

**개선안:**
```typescript
if (!parsed) {
  return [{ 
    type:'text', 
    text:`입력 형식을 확인해 주세요.\n\n✅ 지원되는 형식:\n• "A에서 B까지"\n• "A부터 B까지"\n• "A → B"\n• "A to B"\n• "마이애미" (지명만 입력 시 공항→터미널 자동 추론)\n\n예시:\n• "홍콩 공항에서 카이탁 터미널까지"\n• "마이애미"` 
  }];
}
```

**효과:**
- ✅ 사용자가 어떤 형식을 입력해야 하는지 명확히 안내
- ✅ 다양한 패턴 예시 제공

**예상 작업 시간:** 30분

---

## 코드 구조 분석

### 현재 아키텍처

```
사용자 입력
    ↓
InputBar.tsx (클라이언트)
    ↓
onSend({ mode: 'go', text, from, to })
    ↓
/api/chat (POST)
    ↓
handleDirections(text)
    ↓
정규식 파싱: /(.+?)에서\s+(.+?)까지/
    ↓
gmDirUrl() 호출 (driving, transit만)
    ↓
map-links 타입 응답
```

### 개선 후 아키텍처 (권장)

```
사용자 입력
    ↓
InputBar.tsx (클라이언트)
    ↓
onSend({ mode: 'go', text, from, to })
    ↓
/api/chat (POST)
    ↓
from/to 있으면 → 직접 사용
text만 있으면 → resolveFromTo() 파싱
    ↓
buildAllDirUrls() 호출 (driving, transit, walking)
    ↓
map-links 타입 응답 (3개 링크)
```

---

## 두 앱 간 차이점 요약

| 항목 | 크루즈가이드 지니 AI | 크루즈가이드 지니 3일체험 | 차이점 |
|------|---------------------|------------------------|--------|
| **시스템 프롬프트** | "크루즈 여행 전문 AI" | "3일 체험 전용 AI" | ✅ 다름 |
| **"지니야 가자" API** | `/api/chat` | `/api/chat` | ✅ 동일 |
| **handleDirections()** | 동일 함수 사용 | 동일 함수 사용 | ✅ 동일 |
| **지원 패턴** | "A에서 B까지"만 | "A에서 B까지"만 | ✅ 동일 |
| **제공 링크** | 자동차, 대중교통 | 자동차, 대중교통 | ✅ 동일 |
| **도보 모드** | ❌ 미제공 | ❌ 미제공 | ✅ 동일 |

**결론: "지니야 가자" 기능 자체는 두 앱에서 완전히 동일하게 작동합니다.**

---

## 최종 권장사항

### 즉시 개선 (오늘)

1. ✅ **`resolveFromTo()` 함수 활용** (1-2시간)
   - 다양한 입력 패턴 지원
   - 지명만 입력해도 자동 추론

2. ✅ **도보 모드 추가** (30분)
   - `buildAllDirUrls()`의 `walking` 모드 활용

3. ✅ **`from`/`to` 파라미터 직접 활용** (30분-1시간)
   - 불필요한 변환 제거

### 단기 개선 (이번 주)

4. ⚠️ **에러 메시지 개선** (30분)
   - 다양한 패턴 예시 제공

5. ⚠️ **입력 검증 강화** (1시간)
   - 클라이언트에서 사전 검증

---

## 결론

### 현재 상태

- ✅ **기본 기능 작동**: "A에서 B까지" 형식으로 길찾기 가능
- ⚠️ **기능 제한적**: 단순 정규식만 사용, 고급 파싱 미활용
- ❌ **도보 모드 없음**: 자동차와 대중교통만 제공

### 두 앱 간 차이점

- ✅ **"지니야 가자" 기능은 완전히 동일**: 두 앱 모두 같은 코드 사용
- ✅ **차이점은 시스템 프롬프트뿐**: 일반 대화에서만 차이 발생

### 개선 필요성

- 🔴 **높음**: `resolveFromTo()` 함수 활용으로 다양한 패턴 지원
- 🔴 **높음**: 도보 모드 추가로 사용자 선택권 확대
- 🟡 **중간**: 에러 메시지 및 입력 검증 개선

---

**작성자**: AI Assistant  
**최종 업데이트**: 2025-01-23


