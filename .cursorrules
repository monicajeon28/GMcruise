# ğŸ“œ í”„ë¡œì íŠ¸ ì ˆëŒ€ ë²•ì¹™ (CORE_RULES)

> **âš ï¸ ê²½ê³ : ì´ ê·œì¹™ì„ ì–´ê¸°ë©´ ì½”ë“œë¥¼ ì‘ì„±í•˜ì§€ ë§ˆì„¸ìš”. ë°˜ë“œì‹œ ì´ ê·œì¹™ì„ ë¨¼ì € í™•ì¸í•˜ê³  ì¤€ìˆ˜í•´ì•¼ í•©ë‹ˆë‹¤.**

---

## ğŸš¨ [CRITICAL] ë°ì´í„° ëª¨ë¸ ì ˆëŒ€ ê·œì¹™

### 1. `Trip` ëª¨ë¸ ì‚¬ìš© ê¸ˆì§€

**`Trip` ëª¨ë¸ì€ ë ˆê±°ì‹œ(Legacy)ë‹¤. ëª¨ë“  ì—¬í–‰ ë¡œì§ì€ `UserTrip` ëª¨ë¸ì„ ì‚¬ìš©í•´ì•¼ í•œë‹¤.**

- `prisma.trip` ì½”ë“œê°€ ë³´ì´ë©´ ë¬´ì¡°ê±´ `prisma.userTrip`ìœ¼ë¡œ ë¦¬íŒ©í† ë§ ëŒ€ìƒì´ë‹¤.
- `Trip` ëª¨ë¸ì—ëŠ” `userId` í•„ë“œê°€ ì—†ì–´ì„œ ê³ ê°ê³¼ ì—°ê²°í•  ìˆ˜ ì—†ë‹¤.
- ê³ ê°ì˜ ëª¨ë“  ì—¬í–‰ ì •ë³´ëŠ” `UserTrip` ëª¨ë¸ì—ë§Œ ìˆë‹¤.

### 2. í•„ë“œ ë§¤ì¹­ ê·œì¹™

| Trip í•„ë“œ | UserTrip í•„ë“œ | ë³€í™˜ ë°©ë²• |
|-----------|---------------|-----------|
| `departureDate` | `startDate` | ì§ì ‘ ë§¤í•‘ |
| `productCode` | `CruiseProduct.productCode` | ê´€ê³„ ì°¸ì¡° í•„ìš” |
| `shipName` | `CruiseProduct.shipName` | ê´€ê³„ ì°¸ì¡° í•„ìš” |
| `endDate` | `endDate` | ì§ì ‘ ë§¤í•‘ |
| `status` | `status` | ì§ì ‘ ë§¤í•‘ |
| `googleFolderId` | âŒ ì—†ìŒ | **ìœ„í—˜: UserTripì— ì—†ìŒ** |
| `spreadsheetId` | âŒ ì—†ìŒ | **ìœ„í—˜: UserTripì— ì—†ìŒ** |

**ë³€í™˜ ì˜ˆì‹œ:**
```typescript
// âŒ ì˜ëª»ëœ ì‚¬ìš©
const trip = await prisma.trip.findUnique({
  where: { productCode: 'PROD-001' },
  select: { departureDate: true, shipName: true },
});

// âœ… ì˜¬ë°”ë¥¸ ì‚¬ìš©
const userTrip = await prisma.userTrip.findFirst({
  where: {
    CruiseProduct: { productCode: 'PROD-001' },
  },
  include: {
    CruiseProduct: {
      select: { productCode: true, shipName: true },
    },
  },
  select: { startDate: true },
});
```

### 3. APIS ìƒì„± ì›ì¹™

- **APIS ìƒì„±ì€ `UserTrip`ì˜ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œë‹¤.**
- `Reservation`ê³¼ `User` ì •ë³´ë¥¼ ì¡°í•©í•˜ì—¬ APIS ì‹œíŠ¸ë¥¼ ìƒì„±í•œë‹¤.
- `Trip` ëª¨ë¸ì„ ì‚¬ìš©í•˜ëŠ” APIS ìƒì„± ì½”ë“œëŠ” ëª¨ë‘ `UserTrip`ìœ¼ë¡œ ë³€ê²½í•´ì•¼ í•œë‹¤.

**APIS ìƒì„± í”Œë¡œìš°:**
```
UserTrip.id
    â†“
Reservation (tripId = UserTrip.id)
    â†“
Traveler (reservationId = Reservation.id)
    â†“
User (userId = UserTrip.userId)
    â†“
APIS ì‹œíŠ¸ ìƒì„±
```

---

## ğŸš¨ ìµœìš°ì„  ê·œì¹™: Trip ëª¨ë¸ ì‚¬ìš© ê¸ˆì§€

**ì ˆëŒ€ ì‚¬ìš© ê¸ˆì§€:**
- âŒ `prisma.trip.findMany`
- âŒ `prisma.trip.findUnique`
- âŒ `prisma.trip.create`
- âŒ `prisma.trip.update`
- âŒ `CruiseProduct`ì—ì„œ `Trip` ê´€ê³„ ì ‘ê·¼

**ë¬´ì¡°ê±´ ì‚¬ìš©:**
- âœ… `prisma.userTrip.findMany`
- âœ… `prisma.userTrip.findUnique`
- âœ… `prisma.userTrip.create`
- âœ… `prisma.userTrip.update`
- âœ… `CruiseProduct`ì—ì„œ `UserTrip` ê´€ê³„ ì ‘ê·¼

**ì´ìœ :**
- `Trip` ëª¨ë¸ì—ëŠ” `userId` í•„ë“œê°€ ì—†ìŠµë‹ˆë‹¤.
- ê³ ê°ê³¼ ì—°ê²°ëœ ëª¨ë“  ì—¬í–‰ ì •ë³´ëŠ” `UserTrip` ëª¨ë¸ì—ë§Œ ìˆìŠµë‹ˆë‹¤.
- `Trip` ëª¨ë¸ì„ ì‚¬ìš©í•˜ë©´ ëŸ°íƒ€ì„ ì—ëŸ¬ê°€ ë°œìƒí•©ë‹ˆë‹¤.

---

## 1. [í•µì‹¬] ì—¬í–‰ ì •ë³´ëŠ” ë¬´ì¡°ê±´ `UserTrip`ì´ë‹¤.

* âŒ **ê¸ˆì§€:** `prisma.trip.findMany` (ì ˆëŒ€ ì‚¬ìš© ê¸ˆì§€)

* â­• **ì›ì¹™:** ê³ ê°ì˜ ì—¬í–‰, ì˜ˆì•½, ì—¬ê¶Œ ì •ë³´ëŠ” ëª¨ë‘ **`UserTrip`** ëª¨ë¸ì„ í†µí•´ ì—°ê²°ëœë‹¤.

* **ì´ìœ :** `Trip` ëª¨ë¸ì—ëŠ” `userId`ê°€ ì—†ë‹¤. ê³ ê°ê³¼ ì—°ê²°ëœ ëª¨ë“  ì •ë³´ëŠ” `UserTrip`ì— ìˆë‹¤.

### ì˜ˆì‹œ

```typescript
// âŒ ì˜ëª»ëœ ì‚¬ìš©
const trips = await prisma.trip.findMany({
  where: { userId: sess.userId },  // Trip ëª¨ë¸ì— userId í•„ë“œ ì—†ìŒ!
});

// âœ… ì˜¬ë°”ë¥¸ ì‚¬ìš©
const trips = await prisma.userTrip.findMany({
  where: { userId: sess.userId },
});
```

---

## 2. ë°ì´í„° ì—°ê²° êµ¬ì¡° (The Flow)

```
ê³ ê°(User) â†” ì—¬í–‰(UserTrip) â†” ìƒí’ˆ(CruiseProduct)
```

* **ê³ ê°(User)** â†” **ì—¬í–‰(UserTrip)** â†” **ìƒí’ˆ(CruiseProduct)**

* **ì—¬ê¶Œ(Passport)** ì œì¶œì€ **`UserTrip`** (tripId)ê³¼ ì—°ê²°ëœë‹¤. (ê·¸ë˜ì•¼ ì¬ë°©ë¬¸ ì‹œ PNRë§Œ ë„£ìœ¼ë©´ ìë™ ì™„ì„±ë¨)

* **APIS** ì •ë³´ëŠ” `User` ì •ë³´ì™€ ì¼ì¹˜í•´ì•¼ í•œë‹¤.

### ê´€ê³„ êµ¬ì¡°

* `UserTrip.userId` â†’ `User.id`
* `UserTrip.productId` â†’ `CruiseProduct.id`
* `PassportSubmission.tripId` â†’ `UserTrip.id`
* `PassportSubmission.userId` â†’ `User.id`

---

## 3. ì–´í•„ë¦¬ì—ì´íŠ¸ (ìˆ˜ë‹¹)

* `AffiliateLink`ëŠ” `CruiseProduct`ì™€ ì§ì ‘ ì—°ê²°ëœë‹¤.

* ìˆ˜ë‹¹ ê³„ì‚° ì‹œ `AffiliateProfile`ê³¼ `UserTrip`(êµ¬ë§¤ ì´ë ¥)ì„ ë§¤ì¹­í•œë‹¤.

### ì—°ê²° êµ¬ì¡°

* `AffiliateLink.affiliateProductId` â†’ `AffiliateProduct.id`
* `AffiliateProduct.cruiseProductId` â†’ `CruiseProduct.id`
* `AffiliateLink.productCode` (ì§ì ‘ í•„ë“œ)

---

## 4. í•„ë“œëª… ì ˆëŒ€ ì¤€ìˆ˜

### ê´€ê³„ëª… (Prisma Relation)

* `UserTrip` (ëŒ€ë¬¸ì U, ëŒ€ë¬¸ì T) - âœ… ì˜¬ë°”ë¦„
* `CruiseProduct` (ëŒ€ë¬¸ì C, ëŒ€ë¬¸ì P) - âœ… ì˜¬ë°”ë¦„
* `AffiliateProduct` (ëŒ€ë¬¸ì A, ëŒ€ë¬¸ì P) - âœ… ì˜¬ë°”ë¦„

### DB í•„ë“œëª… (camelCase)

* `affiliateProductId` (ì†Œë¬¸ì a, camelCase) - âœ… ì˜¬ë°”ë¦„
* `cruiseProductId` (ì†Œë¬¸ì c, camelCase) - âœ… ì˜¬ë°”ë¦„
* `userId` (ì†Œë¬¸ì u, camelCase) - âœ… ì˜¬ë°”ë¦„
* `productId` (ì†Œë¬¸ì p, camelCase) - âœ… ì˜¬ë°”ë¦„
* `tripId` (ì†Œë¬¸ì t, camelCase) - âœ… ì˜¬ë°”ë¦„

### Prisma Client ì‚¬ìš©

* `prisma.userTrip` (ì†Œë¬¸ì u, ì†Œë¬¸ì t) - âœ… ì˜¬ë°”ë¦„
* `prisma.cruiseProduct` (ì†Œë¬¸ì c, ì†Œë¬¸ì p) - âœ… ì˜¬ë°”ë¦„
* `prisma.affiliateProduct` (ì†Œë¬¸ì a, ì†Œë¬¸ì p) - âœ… ì˜¬ë°”ë¦„

---

## 5. Trip vs UserTrip êµ¬ë¶„

### Trip ëª¨ë¸ (ì‚¬ìš© ê¸ˆì§€ - ê³ ê° ì •ë³´ ì—†ìŒ)

* `Trip` ëª¨ë¸ì€ `productCode`ë§Œ ê°€ì§€ê³  ìˆìŒ
* `userId` í•„ë“œ ì—†ìŒ
* ê³ ê°ê³¼ ì—°ê²°ë˜ì§€ ì•ŠìŒ
* **ìš©ë„**: ì‹œìŠ¤í…œ ë‚´ë¶€ ê´€ë¦¬ìš© (ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)

### UserTrip ëª¨ë¸ (í•­ìƒ ì‚¬ìš©)

* `UserTrip` ëª¨ë¸ì€ `userId`ì™€ `productId`ë¥¼ ëª¨ë‘ ê°€ì§
* ê³ ê°ì˜ ì‹¤ì œ ì—¬í–‰ ì •ë³´ ì €ì¥
* `cruiseName`, `companionType`, `destination`, `startDate`, `endDate`, `nights`, `days`, `visitCount` ë“± ëª¨ë“  í•„ë“œ í¬í•¨
* **ìš©ë„**: ê³ ê° ì—¬í–‰ ì •ë³´ì˜ ìœ ì¼í•œ ì†ŒìŠ¤

---

## 6. CruiseProduct ê´€ê³„ ì ‘ê·¼

### âŒ ì˜ëª»ëœ ì‚¬ìš©

```typescript
const product = await prisma.cruiseProduct.findUnique({
  where: { productCode },
  select: {
    Trip: {  // âŒ CruiseProductì— Trip ê´€ê³„ ì—†ìŒ!
      select: { id: true },
    },
  },
});
```

### âœ… ì˜¬ë°”ë¥¸ ì‚¬ìš©

```typescript
const product = await prisma.cruiseProduct.findUnique({
  where: { productCode },
  select: {
    UserTrip: {  // âœ… UserTrip ê´€ê³„ ì‚¬ìš©
      select: { id: true },
    },
  },
});
```

ë˜ëŠ” ê´€ê³„ê°€ í•„ìš” ì—†ìœ¼ë©´:

```typescript
const product = await prisma.cruiseProduct.findUnique({
  where: { productCode },
  select: {
    id: true,
    productCode: true,
    // ... í•„ìš”í•œ í•„ë“œë§Œ
  },
});
```

---

## ğŸ“‹ ì²´í¬ë¦¬ìŠ¤íŠ¸

ì½”ë“œë¥¼ ì‘ì„±í•  ë•Œ ë‹¤ìŒì„ í™•ì¸í•˜ì„¸ìš”:

- [ ] ê³ ê°ì˜ ì—¬í–‰ ì •ë³´ë¥¼ ì¡°íšŒí•  ë•Œ `prisma.userTrip`ì„ ì‚¬ìš©í•˜ëŠ”ê°€?
- [ ] `prisma.trip`ì„ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ê°€?
- [ ] `CruiseProduct`ì—ì„œ `Trip` ê´€ê³„ë¥¼ ì°¸ì¡°í•˜ì§€ ì•ŠëŠ”ê°€?
- [ ] í•„ë“œëª…ì´ camelCaseë¡œ ì •í™•íˆ ì‘ì„±ë˜ì—ˆëŠ”ê°€?
- [ ] ê´€ê³„ëª…ì´ ëŒ€ë¬¸ìë¡œ ì‹œì‘í•˜ëŠ”ê°€?

---

## âš ï¸ ìµœì¢… ê²½ê³ 

**ì´ ê·œì¹™ì„ ì–´ê¸°ë©´ ì½”ë“œë¥¼ ì‘ì„±í•˜ì§€ ë§ˆì„¸ìš”.**

- `prisma.trip`ì„ ì‚¬ìš©í•˜ëŠ” ì½”ë“œëŠ” ì ˆëŒ€ ì‘ì„±í•˜ì§€ ë§ˆì„¸ìš”.
- `CruiseProduct`ì—ì„œ `Trip` ê´€ê³„ë¥¼ ì°¸ì¡°í•˜ëŠ” ì½”ë“œëŠ” ì ˆëŒ€ ì‘ì„±í•˜ì§€ ë§ˆì„¸ìš”.
- ê³ ê°ì˜ ì—¬í–‰ ì •ë³´ëŠ” ë°˜ë“œì‹œ `UserTrip` ëª¨ë¸ì„ ì‚¬ìš©í•˜ì„¸ìš”.

**ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸**: 2025-01-27

