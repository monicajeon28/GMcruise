# 카카오톡 채널 추가 오류 해결 가이드

## 문제 현상

### 문제 1: "카카오 채널 ID가 설정되지 않았습니다"
"채널 추가하기" 버튼을 클릭하면 "카카오 채널 ID가 설정되지 않았습니다. 관리자에게 문의하세요." 팝업이 표시됩니다.

### 문제 2: "카카오톡 채널 추가 중 오류가 발생했습니다"
"채널추가하기" 버튼을 클릭하면 "카카오톡 채널 추가 중 오류가 발생했습니다" 경고가 표시됩니다.

## 원인 분석

카카오톡 채널 추가 기능이 실패하는 주요 원인은 다음과 같습니다:

1. **환경 변수 미설정**
   - `NEXT_PUBLIC_KAKAO_JS_KEY`: 카카오 JavaScript SDK 초기화에 필요한 키
   - `NEXT_PUBLIC_KAKAO_CHANNEL_ID`: 카카오 비즈니스 채널 공개 ID

2. **카카오 SDK 로드 실패**
   - 네트워크 문제로 SDK 스크립트를 로드하지 못함
   - SDK 초기화 실패

3. **카카오 채널 API 호출 실패**
   - `Channel.addChannel()` API 호출 실패
   - 채널 ID가 잘못되었거나 존재하지 않음

## 해결 방법

### 1. 환경 변수 확인 및 설정

#### ⚠️ 중요: "카카오 채널 ID가 설정되지 않았습니다" 오류 해결

이 오류는 **Vercel 프로덕션 환경에서 환경 변수가 설정되지 않았거나 재배포가 되지 않았을 때** 발생합니다.

**즉시 해결 방법:**

1. **Vercel 대시보드 접속**
   - https://vercel.com 접속
   - 로그인 후 **cruise-guide** 프로젝트 선택

2. **환경 변수 확인**
   - 상단 메뉴에서 **Settings** 클릭
   - 왼쪽 사이드바에서 **Environment Variables** 클릭
   - 다음 두 환경 변수가 있는지 확인:
     - `NEXT_PUBLIC_KAKAO_JS_KEY`
     - `NEXT_PUBLIC_KAKAO_CHANNEL_ID`

3. **환경 변수 추가/수정** (없는 경우)
   - **"Add New"** 또는 **"Add"** 버튼 클릭
   - 첫 번째 변수 추가:
     - **Key**: `NEXT_PUBLIC_KAKAO_JS_KEY`
     - **Value**: `e4d764f905271796dccf37c55a5b84d7`
     - **Environment**: Production, Preview, Development 모두 체크
     - **Save** 클릭
   - 두 번째 변수 추가:
     - **Key**: `NEXT_PUBLIC_KAKAO_CHANNEL_ID`
     - **Value**: `CzxgPn`
     - **Environment**: Production, Preview, Development 모두 체크
     - **Save** 클릭

4. **재배포 (필수!)**
   - 상단 메뉴에서 **Deployments** 탭 클릭
   - 가장 최근 배포 항목의 **"..."** (점 3개) 메뉴 클릭
   - **"Redeploy"** 선택
   - 확인 팝업에서 **"Redeploy"** 버튼 클릭
   - 배포 완료까지 대기 (1-3분)

5. **테스트**
   - 배포 완료 후 https://www.cruisedot.co.kr 접속
   - "채널 추가하기" 버튼 클릭하여 정상 작동 확인

#### 로컬 개발 환경 (.env.local)

`.env.local` 파일에 다음 환경 변수가 설정되어 있는지 확인하세요:

```bash
# 카카오 설정 (필수)
NEXT_PUBLIC_KAKAO_JS_KEY=e4d764f905271796dccf37c55a5b84d7
NEXT_PUBLIC_KAKAO_CHANNEL_ID=CzxgPn
```

#### Vercel 프로덕션 환경

위의 "즉시 해결 방법" 섹션을 참고하세요.

### 2. 카카오 개발자 콘솔 확인

1. 카카오 개발자 콘솔 접속: https://developers.kakao.com
2. 내 애플리케이션 선택
3. **앱 키** 섹션에서 확인:
   - JavaScript 키가 `NEXT_PUBLIC_KAKAO_JS_KEY`와 일치하는지 확인
4. **플랫폼** 섹션에서 확인:
   - 웹 플랫폼이 등록되어 있는지 확인
   - 사이트 도메인이 등록되어 있는지 확인 (예: `https://www.cruisedot.co.kr`)

### 3. 카카오 비즈니스 채널 확인

1. 카카오 비즈니스 관리자 페이지 접속: https://business.kakao.com
2. 채널 관리 > 채널 목록에서 채널 확인
3. 채널 공개 ID가 `NEXT_PUBLIC_KAKAO_CHANNEL_ID`와 일치하는지 확인
4. 채널이 활성화되어 있는지 확인

### 4. 브라우저 콘솔 확인

개발자 도구(F12)를 열고 Console 탭에서 다음 로그를 확인하세요:

```
[Kakao Channel] SDK 상태 확인: { ... }
[Kakao Channel] 채널 ID 조회 성공: ...
[Kakao Channel] SDK를 사용하여 채널 추가 시도
```

오류가 발생하면 다음과 같은 로그가 표시됩니다:
- `[Kakao Channel] NEXT_PUBLIC_KAKAO_JS_KEY가 설정되지 않았습니다.`
- `[Kakao Channel] 채널 ID가 설정되지 않았습니다.`
- `[Kakao Channel] SDK 스크립트 로드 실패`

## 개선 사항

다음과 같은 개선이 적용되었습니다:

1. **상세한 에러 메시지**: 오류 발생 시 구체적인 원인을 알려줍니다
2. **자동 재시도**: SDK 로드 실패 시 자동으로 재시도합니다
3. **폴백 처리**: SDK를 사용할 수 없는 경우 채널 페이지로 직접 이동합니다
4. **디버깅 로그**: 문제 진단을 위한 상세한 로그를 출력합니다

## 테스트 방법

1. 브라우저 개발자 도구(F12) 열기
2. Console 탭 선택
3. "채널 추가하기" 버튼 클릭
4. 콘솔에 표시되는 로그 확인:
   - 정상: `[Kakao Channel] SDK를 사용하여 채널 추가 시도`
   - 오류: `[Kakao Channel] ...` 형태의 오류 메시지

## 추가 확인 사항

### 환경 변수가 제대로 로드되었는지 확인

브라우저 콘솔에서 다음 명령어를 실행하여 확인할 수 있습니다:

```javascript
// 카카오 SDK 상태 확인
console.log('Kakao SDK:', window.Kakao);
console.log('Kakao 초기화:', window.Kakao?.isInitialized());
console.log('Kakao Channel:', window.Kakao?.Channel);

// 환경 변수 확인 (클라이언트에서는 process.env가 빌드 시점에 치환됨)
// 실제로는 브라우저에서 직접 확인할 수 없으므로, API 응답을 확인하세요
```

### API 응답 확인

Network 탭에서 다음 API 호출을 확인하세요:
- `GET /api/kakao/channel-info` - 채널 정보 조회
  - 정상 응답: `{ ok: true, channelId: "CzxgPn", channelUrl: "..." }`
  - 오류 응답: `{ ok: false, error: "...", missingVars: [...] }`
- `POST /api/kakao/add-channel` - 채널 추가 처리

**환경 변수 확인 방법:**
브라우저에서 직접 확인하려면:
1. 개발자 도구(F12) 열기
2. Network 탭 선택
3. "채널 추가하기" 버튼 클릭
4. `/api/kakao/channel-info` 요청 클릭
5. Response 탭에서 `ok` 값과 `channelId` 값 확인
   - `ok: false`이면 환경 변수가 설정되지 않은 것입니다
   - `missingVars` 배열에 누락된 변수 목록이 표시됩니다

## 문제가 지속되는 경우

1. **환경 변수 재설정**: Vercel에서 환경 변수를 삭제하고 다시 추가
2. **재배포**: 환경 변수 변경 후 반드시 재배포
3. **브라우저 캐시 삭제**: 브라우저 캐시를 삭제하고 다시 시도
4. **다른 브라우저에서 테스트**: 브라우저 확장 프로그램이나 설정 문제일 수 있음
5. **로그 확인**: 서버 로그와 브라우저 콘솔 로그를 모두 확인

## 연락처

문제가 해결되지 않으면 다음 정보와 함께 문의하세요:
- 브라우저 콘솔의 전체 오류 메시지
- Network 탭의 API 응답
- 환경 변수 설정 여부 (키 값은 제외)

