# 🔍 판매원 대시보드 종합 시뮬레이션 테스트 보고서

**작성일**: 2025-01-28  
**테스트 범위**: 판매원 대시보드 모든 기능  
**테스트 방식**: 실제 유저 사용 시나리오 기반 코드 레벨 시뮬레이션

---

## 📋 테스트 시나리오 개요

### 테스트 대상 기능
1. ✅ 로그인/인증
2. ✅ 대시보드 통계 조회
3. ✅ 고객 목록 조회/검색/필터링
4. ✅ 고객 추가/수정
5. ✅ 고객 상세 조회
6. ✅ 상담 기록 추가
7. ✅ 구매 고객 관리
8. ✅ 여권 링크 발송
9. ✅ 판매 확인/등록
10. ✅ 어필리에이트 링크 관리
11. ✅ 정산 조회

---

## 🚨 발견된 오류 및 문제점

### 🔴 심각 (Critical) - 즉시 수정 필요

#### 1. **대시보드 통계 API: 월별 필터링 오류**
**파일**: `app/api/partner/dashboard/stats/route.ts`  
**위치**: Line 24-27

**문제**:
```typescript
const [year, monthNum] = month.split('-').map(Number);
const startDate = new Date(year, monthNum - 1, 1);
const endDate = new Date(year, monthNum, 0, 23, 59, 59, 999);
```

**오류 시나리오**:
- `month` 파라미터가 잘못된 형식인 경우 (예: "2025-1" 대신 "2025-01")
- `month` 파라미터가 없거나 null인 경우
- `month.split('-')` 결과가 2개가 아닌 경우

**실제 오류 발생 가능성**:
- 프론트엔드에서 잘못된 형식으로 전달 시 `NaN` 발생
- `endDate` 계산 오류로 잘못된 날짜 범위

**수정 필요**:
- 입력 검증 추가
- 기본값 처리 개선

---

#### 2. **월별 판매 통계: groupBy 오류 가능성**
**파일**: `app/api/partner/dashboard/stats/route.ts`  
**위치**: Line 147-162

**문제**:
```typescript
const monthlySales = await prisma.affiliateSale.groupBy({
  by: ['saleDate'],
  where: {
    OR: [
      { managerId: profile.id },
      { agentId: profile.id },
    ],
    saleDate: {
      gte: sixMonthsAgo,
    },
  },
  _count: true,
  _sum: {
    saleAmount: true,
  },
});
```

**오류 시나리오**:
- `saleDate`가 `null`인 판매가 있는 경우 groupBy 오류 가능
- `saleAmount`가 `null`인 경우 합계 계산 오류

**실제 오류 발생 가능성**: ⚠️ 높음
- 초기 판매 데이터에 `saleDate`가 null일 수 있음

**수정 필요**:
- `saleDate` null 필터링 추가
- null 체크 및 기본값 처리

---

### 🟡 중간 (Medium) - 곧 수정 필요

#### 3. **고객 목록 조회: 복잡한 쿼리 성능**
**파일**: `app/api/partner/customers/route.ts`  
**위치**: Line 222-266

**문제**:
- 여러 OR 조건과 복잡한 필터링
- 1만명 규모에서 성능 저하 가능

**오류 시나리오**:
- 페이지 100 이상 조회 시 매우 느림
- 인덱스가 있어도 복잡한 쿼리로 인한 성능 저하

**수정 필요**:
- 커서 기반 페이지네이션 적용
- 쿼리 최적화

---

#### 4. **상담 기록 추가: 트랜잭션 타임아웃**
**파일**: `app/api/partner/customers/[leadId]/interactions/route.ts`  
**위치**: Line 129-604

**문제**:
- 매우 긴 트랜잭션 (500줄 이상)
- 계약 해지 확인, 수당 계산 등 복잡한 로직

**오류 시나리오**:
- 데이터베이스 타임아웃 발생 가능
- 동시 요청 시 데드락 가능성

**수정 필요**:
- 트랜잭션 분리
- 재시도 로직 추가

---

#### 5. **예약 조회: 전화번호 매칭 오류**
**파일**: `app/api/partner/reservations/[reservationId]/route.ts`  
**위치**: Line 66-98

**문제**:
- 전화번호 형식 변환 로직이 복잡
- 다양한 형식 매칭 시도

**오류 시나리오**:
- 전화번호 형식 불일치로 권한 오류
- 매칭 실패 시 정당한 접근 차단

**수정 필요**:
- 전화번호 정규화 유틸리티 사용
- 로그 추가로 디버깅 개선

---

### 🟢 경미 (Low) - 개선 권장

#### 6. **에러 메시지 일관성 부족**
- 일부 API는 한국어, 일부는 영어
- 사용자 친화적 메시지 개선 필요

#### 7. **로깅 부족**
- 일부 중요한 로직에 상세 로그 부족
- 디버깅 어려움

---

## ✅ 정상 동작 확인 사항

### 1. 인증/권한 체크
- ✅ `requirePartnerContext` 정상 동작
- ✅ 프로필 타입별 권한 구분 정상

### 2. 데이터 조회
- ✅ 기본 통계 조회 정상
- ✅ 고객 목록 페이징 정상
- ✅ 필터링 동작 정상

### 3. 캐싱
- ✅ 통계 캐싱 로직 정상
- ✅ Redis 폴백 로직 정상

---

## 🔧 권장 수정사항

### 즉시 수정 (Critical)

1. **대시보드 통계 API 입력 검증 강화**
   ```typescript
   // month 파라미터 검증 추가
   if (month) {
     const parts = month.split('-');
     if (parts.length !== 2) {
       throw new PartnerApiError('Invalid month format. Use YYYY-MM', 400);
     }
     const [year, monthNum] = parts.map(Number);
     if (isNaN(year) || isNaN(monthNum) || monthNum < 1 || monthNum > 12) {
       throw new PartnerApiError('Invalid month value', 400);
     }
   }
   ```

2. **월별 판매 통계 groupBy 수정**
   ```typescript
   const monthlySales = await prisma.affiliateSale.groupBy({
     by: ['saleDate'],
     where: {
       OR: [
         { managerId: profile.id },
         { agentId: profile.id },
       ],
       saleDate: {
         gte: sixMonthsAgo,
         not: null, // null 필터링 추가
       },
     },
     _count: true,
     _sum: {
       saleAmount: true,
     },
   });
   ```

### 곧 수정 (Medium)

3. **상담 기록 트랜잭션 분리**
   - 판매 생성 로직을 별도 함수로 분리
   - 계약 해지 확인 로직 최적화

4. **전화번호 정규화 유틸리티 사용**
   - `normalizePhoneInput` 함수 재사용
   - 일관된 전화번호 처리

### 개선 권장 (Low)

5. **에러 메시지 표준화**
   - 모든 API 에러 메시지 한국어 통일
   - 사용자 친화적 메시지 작성

6. **로깅 강화**
   - 중요 비즈니스 로직에 상세 로그
   - 디버깅을 위한 컨텍스트 정보 추가

---

## 📊 성능 개선 확인사항

### ✅ 완료된 개선
- 데이터베이스 인덱스 추가
- 통계 캐싱 도입
- 페이지네이션 유틸리티 추가

### ⚠️ 추가 개선 필요
- 커서 기반 페이지네이션 실제 적용
- 복잡한 쿼리 최적화
- 트랜잭션 타임아웃 방지

---

## 🎯 테스트 체크리스트

### 기본 기능 테스트
- [ ] 로그인 성공
- [ ] 대시보드 로드 성공
- [ ] 고객 목록 조회 성공
- [ ] 고객 추가 성공
- [ ] 고객 수정 성공
- [ ] 상담 기록 추가 성공

### 엣지 케이스 테스트
- [ ] 잘못된 월 파라미터 처리
- [ ] null 값 처리
- [ ] 빈 목록 처리
- [ ] 대량 데이터 조회 (1만명)
- [ ] 동시 요청 처리

### 오류 처리 테스트
- [ ] 네트워크 오류 처리
- [ ] 권한 오류 처리
- [ ] 데이터베이스 오류 처리
- [ ] 유효성 검증 오류 처리

---

## 📝 결론

### 전반적인 평가
- ✅ 핵심 기능은 정상 동작
- ⚠️ 일부 엣지 케이스에서 오류 가능성 발견
- 🔧 성능 최적화는 대부분 완료

### 우선순위별 작업
1. **긴급**: 월별 필터링 입력 검증, groupBy null 처리
2. **중요**: 트랜잭션 분리, 전화번호 정규화
3. **개선**: 에러 메시지 표준화, 로깅 강화

### 다음 단계
1. 즉시 수정 사항 반영
2. 실제 환경에서 부하 테스트
3. 모니터링 도구 연동


