# 관리자 로그인 문제 진단 및 해결

## 🔍 발견된 문제점

### 1. 전화번호 정규화 불일치 ⚠️ **주요 원인**

**문제:**
- 로그인 API (`/api/auth/login`)에서는 전화번호를 정규화합니다:
  ```typescript
  const normalizedPhone = phone.replace(/[-\s]/g, ''); // 하이픈, 공백 제거
  ```
- 하지만 인증 확인 API (`/api/admin/auth-check`)에서는 정규화하지 않고 직접 비교합니다:
  ```typescript
  const isAuthorized = user.phone === '01024958013' || user.phone === '01038609161';
  ```

**영향:**
- DB에 저장된 전화번호가 `010-2495-8013` 형식이면 매칭 실패
- 로그인은 성공하지만 인증 확인에서 실패하여 관리자 패널 접근 불가

**해결:**
- ✅ `auth-check` API에서도 전화번호 정규화 적용 완료

---

### 2. Prisma 클라이언트 오류 가능성

**문제:**
- Vercel 배포 시 Prisma 클라이언트 모듈을 찾지 못하는 오류 발생
- `Cannot find module '.prisma/client/default'`

**영향:**
- DB 조회 실패로 인증 확인 불가
- 로그인 API에서도 DB 조회 실패 가능

**해결:**
- ✅ `next.config.mjs`에서 Prisma 클라이언트 제외 설정 제거 완료
- ✅ `vercel.json`에 빌드 명령어 명시 완료

---

### 3. 에러 로깅 부족

**문제:**
- 인증 실패 시 구체적인 원인 파악 어려움
- 디버깅 정보 부족

**해결:**
- ✅ 상세한 로그 추가 완료
- ✅ 개발 환경에서 에러 메시지 표시

---

## ✅ 수정 완료 사항

### 1. `app/api/admin/auth-check/route.ts` 수정

**변경 내용:**
- 전화번호 정규화 적용 (로그인 시와 동일하게)
- 상세한 로그 추가
- 에러 처리 개선

**수정 전:**
```typescript
const isAuthorized = user.phone === '01024958013' || user.phone === '01038609161';
```

**수정 후:**
```typescript
// 전화번호 정규화 (로그인 시와 동일하게 처리)
const normalizedPhone = user.phone?.replace(/[-\s]/g, '') || '';

// 01024958013 또는 01038609161만 접근 허용 (정규화된 전화번호로 비교)
const isAuthorized = normalizedPhone === '01024958013' || normalizedPhone === '01038609161';
```

---

## 🔧 추가 확인 사항

### 1. 관리자 계정 확인

다음 스크립트로 관리자 계정 상태를 확인하세요:

```bash
# 관리자 계정 조회
npx tsx scripts/check-admin.ts
```

**확인 항목:**
- 전화번호: `01024958013` 또는 `01038609161`
- role: `admin`
- 비밀번호: 설정되어 있는지 확인

---

### 2. 세션 쿠키 확인

**브라우저 개발자 도구에서 확인:**
1. F12 → Application 탭 → Cookies
2. `cg.sid.v2` 쿠키가 있는지 확인
3. 쿠키 값이 있는지 확인

**문제가 있다면:**
- 쿠키가 없으면 로그인 실패
- 쿠키가 있지만 인증 실패면 세션 DB 문제 가능

---

### 3. 네트워크 요청 확인

**브라우저 개발자 도구에서 확인:**
1. F12 → Network 탭
2. `/api/auth/login` 요청 확인
   - Status: 200이어야 함
   - Response: `{ ok: true, ... }`이어야 함
3. `/api/admin/auth-check` 요청 확인
   - Status: 200이어야 함
   - Response: `{ ok: true, authenticated: true }`이어야 함

---

## 🚀 테스트 방법

### 1. 로그인 테스트

1. `/admin/login` 접속
2. 다음 정보 입력:
   - 이름: `관리자` (또는 DB에 저장된 이름)
   - 전화번호: `01024958013` (또는 `01038609161`)
   - 비밀번호: 설정된 비밀번호
3. 로그인 버튼 클릭

**예상 결과:**
- ✅ 로그인 성공 → `/admin/dashboard`로 리다이렉트
- ❌ 로그인 실패 → 에러 메시지 표시

---

### 2. 인증 확인 테스트

**브라우저 콘솔에서:**
```javascript
fetch('/api/admin/auth-check', { credentials: 'include' })
  .then(r => r.json())
  .then(data => console.log('인증 상태:', data));
```

**예상 결과:**
```json
{
  "ok": true,
  "authenticated": true,
  "user": {
    "id": 1,
    "name": "관리자",
    "role": "admin",
    "phone": "01024958013"
  }
}
```

---

## 📋 체크리스트

배포 후 다음을 확인하세요:

- [ ] Prisma 클라이언트 오류 해결 확인
- [ ] 관리자 로그인 성공 확인
- [ ] 인증 확인 API 정상 작동 확인
- [ ] 관리자 패널 접근 가능 확인
- [ ] 브라우저 콘솔에 에러 없음 확인
- [ ] 네트워크 탭에서 모든 요청 200 OK 확인

---

## 🐛 문제가 계속되면

### 1. Vercel 로그 확인

1. Vercel 대시보드 → 프로젝트 → Deployments
2. 최신 배포 → Logs 탭
3. 에러 메시지 확인

### 2. 브라우저 콘솔 확인

1. F12 → Console 탭
2. 에러 메시지 확인
3. Network 탭에서 실패한 요청 확인

### 3. 데이터베이스 확인

```bash
# 관리자 계정 확인
npx tsx scripts/check-admin.ts

# 세션 확인
npx prisma studio
# Session 테이블 확인
```

---

## 📝 참고 정보

### 허용된 관리자 전화번호

- `01024958013` (관리자 1)
- `01038609161` (관리자 2)

### 관리자 계정 생성

관리자 계정이 없으면 로그인 시 자동 생성됩니다:
- 이름: 입력한 이름
- 전화번호: 입력한 전화번호 (정규화됨)
- 비밀번호: 입력한 비밀번호 (평문 저장)
- role: `admin`

### 세션 쿠키

- 이름: `cg.sid.v2`
- 만료: 30일
- HttpOnly: true
- SameSite: lax

