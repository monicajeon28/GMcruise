# 랜딩페이지 페이앱 결제 설정 가이드

## 📋 목차
1. [환경변수 설정](#1-환경변수-설정)
2. [랜딩페이지에서 페이앱 결제 설정](#2-랜딩페이지에서-페이앱-결제-설정)
3. [테스트 방법](#3-테스트-방법)
4. [문제 해결](#4-문제-해결)

---

## 1. 환경변수 설정

### 1-1. 로컬 개발 환경 (`.env.local`)

프로젝트 루트 디렉토리에 `.env.local` 파일을 생성하거나 수정합니다:

```bash
# 프로젝트 루트 디렉토리에서
nano .env.local
# 또는
vim .env.local
# 또는
code .env.local
```

다음 내용을 추가합니다:

```bash
# PayApp 연동 정보 (PayApp 판매자 사이트 > 설정 > 연동정보에서 확인)
PAYAPP_USERID=hyeseon28
PAYAPP_LINKKEY=CPe1Qyvoll6bPRHfd5pTZO1DPJnCCRVaOgT+oqg6zaM=
PAYAPP_LINKVAL=CPe1Qyvoll6bPRHfd5pTZJKhziNbvfVO9tbzpmrIe6s=

# ⚠️ 중요: 크루즈닷 웹사이트 도메인 (PayApp이 콜백을 보낼 주소)
NEXT_PUBLIC_BASE_URL=https://www.cruisedot.co.kr
```

### 1-2. 프로덕션 환경 (Vercel)

1. Vercel 대시보드 접속: https://vercel.com
2. 프로젝트 선택
3. **Settings** → **Environment Variables** 클릭
4. 다음 환경변수 추가:
   - `PAYAPP_USERID` = `hyeseon28`
   - `PAYAPP_LINKKEY` = `CPe1Qyvoll6bPRHfd5pTZO1DPJnCCRVaOgT+oqg6zaM=`
   - `PAYAPP_LINKVAL` = `CPe1Qyvoll6bPRHfd5pTZJKhziNbvfVO9tbzpmrIe6s=`
   - `NEXT_PUBLIC_BASE_URL` = `https://www.cruisedot.co.kr`
5. **Save** 클릭
6. **Deployments** 탭에서 최신 배포를 **Redeploy** (환경변수 적용)

### 1-3. PayApp 연동 정보 확인 방법

1. PayApp 판매자 사이트 로그인: https://www.payapp.kr
2. **설정** → **연동정보** 탭 클릭
3. 다음 정보 확인:
   - `userid`: 판매자 아이디 → `PAYAPP_USERID`
   - `연동 KEY`: → `PAYAPP_LINKKEY`
   - `연동 VALUE`: → `PAYAPP_LINKVAL`

### 1-4. 환경변수 적용 확인

**로컬 개발 환경:**
```bash
# 서버 재시작
npm run dev
# 또는
yarn dev
```

**프로덕션 환경:**
- Vercel에서 자동으로 재배포되거나, 수동으로 Redeploy 실행

---

## 2. 랜딩페이지에서 페이앱 결제 설정

### 2-1. 관리자 페이지 접속

1. 크루즈닷 관리자 페이지 로그인
2. **랜딩페이지** 메뉴 클릭
3. 새 랜딩페이지 생성 또는 기존 랜딩페이지 수정

### 2-2. 상품 구매 설정

랜딩페이지 편집 화면에서 **"상품 구매 설정"** 섹션을 찾습니다:

#### ✅ 결제 기능 활성화
- **"상품 구매 활성화"** 체크박스 선택

#### ✅ 결제 제공업체 선택
- **"페이앱"** 라디오 버튼 선택
  - ⚠️ **"웰컴페이먼츠"**가 아닌 **"페이앱"**을 선택해야 합니다

#### ✅ 상품 정보 입력
- **상품명**: 예) "크루즈 여행 패키지", "프리미엄 가이드북" 등
- **판매가격**: 숫자만 입력 (예: `100000` = 10만원)
- **결제 타입**: 
  - **"기본 타입"**: 본인인증 결제
  - **"카드번호 입력"**: 카드번호만 입력하는 간편 결제

#### ✅ 설정 저장
- **"저장"** 또는 **"발행"** 버튼 클릭

### 2-3. 설정 예시

```
✅ 상품 구매 활성화: 체크
결제 제공업체: ⚪ 페이앱  ⚫ 웰컴페이먼츠
상품명: 크루즈 여행 가이드북
판매가격: 50000
결제 타입: ⚪ 기본 타입  ⚫ 카드번호 입력
```

---

## 3. 테스트 방법

### 3-1. 랜딩페이지 접속

1. 랜딩페이지 URL 접속
   - 예: `https://www.cruisedot.co.kr/landing/your-slug`
   - 또는 랜딩페이지 ID로 접속: `https://www.cruisedot.co.kr/landing/123`

### 3-2. 결제 버튼 확인

랜딩페이지 하단에 **"결제 요청하기"** 버튼이 표시되는지 확인합니다.

### 3-3. 결제 테스트

1. **"결제 요청하기"** 버튼 클릭
2. 페이앱 결제창으로 자동 이동되는지 확인
3. 테스트 카드번호 입력:
   - 카드번호: `4111-1111-1111-1111`
   - 유효기간: 미래 날짜 (예: `12/25`)
   - CVC: `123`
   - 비밀번호: `1234`
4. 결제 완료 후 결제 성공 페이지로 이동 확인

### 3-4. 결제 내역 확인

**관리자 페이지에서 확인:**
1. 관리자 페이지 → **결제 관리** 또는 **랜딩페이지** 메뉴
2. 해당 랜딩페이지의 결제 내역 확인
3. 결제 상태가 **"완료"**로 표시되는지 확인

**데이터베이스에서 확인:**
```sql
SELECT * FROM "Payment" 
WHERE "pgProvider" = 'payapp' 
ORDER BY "createdAt" DESC 
LIMIT 10;
```

---

## 4. 문제 해결

### 4-1. 결제 버튼이 작동하지 않는 경우

**확인 사항:**
1. 브라우저 콘솔(F12) 확인
   - 에러 메시지 확인
   - `[LandingPaymentButton] Payment request error:` 메시지 확인

2. 서버 로그 확인
   ```bash
   # 로컬 개발 환경
   # 터미널에서 에러 메시지 확인
   ```

3. 환경변수 확인
   - `.env.local` 파일에 `PAYAPP_USERID`, `PAYAPP_LINKKEY`가 있는지 확인
   - 서버 재시작 후 다시 테스트

**에러 메시지별 해결 방법:**

| 에러 메시지 | 해결 방법 |
|------------|----------|
| `PayApp 설정이 완료되지 않았습니다` | 환경변수 `PAYAPP_USERID`, `PAYAPP_LINKKEY` 확인 |
| `결제 URL을 생성하지 못했습니다` | PayApp API 응답 확인, 서버 로그 확인 |
| `결제 요청에 실패했습니다` | PayApp 판매자 사이트에서 연동 정보 확인 |

### 4-2. 페이앱 결제창이 안 나오는 경우

**확인 사항:**
1. 랜딩페이지 설정 확인
   - 결제 제공업체가 **"페이앱"**으로 선택되어 있는지 확인
   - 상품 구매 활성화가 체크되어 있는지 확인

2. 서버 로그 확인
   ```
   [Landing Page Payment] PayApp API 호출:
   [Landing Page Payment] PayApp API 응답:
   ```
   - `state: '1'`이면 성공
   - `state: '0'`이면 실패 (에러 메시지 확인)

3. PayApp API 오류 코드 확인
   - `70001`: HTTPS로 호출하지 않음
   - `70010`: userid, linkkey 값이 정확하지 않음
   - `70020`: 파라메터값이 정확하지 않음
   - `70040`: cmd값이 정확하지 않음
   - `70060`: 권한이 없음
   - `70080`: 고객사 응답 실패 (feedbackurl 접속 실패)

### 4-3. 결제 완료 후 feedback이 안 오는 경우

**확인 사항:**
1. `PAYAPP_LINKVAL` 환경변수 확인
   - feedback 검증에 사용되므로 반드시 설정되어야 함

2. `NEXT_PUBLIC_BASE_URL` 확인
   - `https://www.cruisedot.co.kr` 형식으로 설정 (슬래시 없음)
   - PayApp 서버에서 접근 가능한 공개 URL이어야 함

3. 서버 로그 확인
   ```
   [PayApp Feedback] 랜딩페이지 결제 완료:
   ```
   - 이 로그가 보이면 정상 작동

4. 방화벽/보안 설정 확인
   - `/api/payapp/feedback` 경로가 외부에서 접근 가능한지 확인

### 4-4. 결제는 되었는데 DB에 저장이 안 되는 경우

**확인 사항:**
1. Payment 테이블 확인
   ```sql
   SELECT * FROM "Payment" 
   WHERE "orderId" LIKE 'LP_%' 
   ORDER BY "createdAt" DESC;
   ```

2. 서버 로그 확인
   - `[PayApp Feedback]` 관련 로그 확인
   - 에러 메시지 확인

3. 메타데이터 확인
   - Payment 테이블의 `metadata` 컬럼 확인
   - `mul_no`가 저장되어 있는지 확인

---

## 5. 결제 흐름 요약

```
1. 사용자가 랜딩페이지 접속
   ↓
2. "결제 요청하기" 버튼 클릭
   ↓
3. /api/public/landing-pages/[slug]/payment API 호출
   ↓
4. 페이앱 API 호출 (https://api.payapp.kr/oapi/apiLoad.html)
   ↓
5. 페이앱에서 동적 결제 URL 생성
   ↓
6. 사용자를 페이앱 결제창으로 리다이렉트
   ↓
7. 사용자가 카드번호 입력 후 결제
   ↓
8. 페이앱 서버가 /api/payapp/feedback으로 결제 결과 통보
   ↓
9. Payment 테이블에 결제 정보 저장 (status: 'completed')
   ↓
10. 사용자를 결제 완료 페이지로 리다이렉트
```

---

## 6. 주의사항

### 보안
- ⚠️ `PAYAPP_LINKKEY`와 `PAYAPP_LINKVAL`은 절대 공개하지 마세요
- ⚠️ `.env.local` 파일은 `.gitignore`에 포함되어 있어야 합니다
- ⚠️ 프로덕션 환경에서는 반드시 HTTPS를 사용해야 합니다

### 테스트
- 테스트 카드번호로 결제 테스트 가능
- 실제 결제 전에 반드시 테스트 환경에서 확인

### 지원 문의
- PayApp API 문서: https://www.payapp.kr
- PayApp 판매자 사이트: https://www.payapp.kr (로그인 필요)
- 기술 지원: 서버 로그와 함께 문의

---

## 7. 체크리스트

설정 완료 후 다음 항목을 확인하세요:

- [ ] `.env.local` 또는 Vercel 환경변수에 `PAYAPP_USERID` 설정
- [ ] `.env.local` 또는 Vercel 환경변수에 `PAYAPP_LINKKEY` 설정
- [ ] `.env.local` 또는 Vercel 환경변수에 `PAYAPP_LINKVAL` 설정
- [ ] `.env.local` 또는 Vercel 환경변수에 `NEXT_PUBLIC_BASE_URL` 설정
- [ ] 서버 재시작 또는 재배포 완료
- [ ] 랜딩페이지에서 "상품 구매 활성화" 체크
- [ ] 랜딩페이지에서 "페이앱" 선택
- [ ] 상품명, 판매가격 입력 완료
- [ ] 랜딩페이지 저장/발행 완료
- [ ] 테스트 결제 성공 확인
- [ ] Payment 테이블에 결제 정보 저장 확인

---

**설정 완료 후 테스트해보시고, 문제가 있으면 알려주세요!** 🚀

