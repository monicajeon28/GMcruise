# 알리고 API 검증 강화 완료 보고서

**작업 일시**: 2025년 1월 28일  
**작업 내용**: 알리고 SMS 전송 전 발신번호/수신번호/메시지 내용 검증 강화

---

## 📋 작업 개요

알리고 API로 SMS를 전송하기 전에 다음 항목들을 자동으로 검증하도록 강화했습니다:

1. **발신번호 검증**: 형식 및 정규화
2. **수신번호 검증**: 형식 및 정규화
3. **메시지 내용 검증**: 링크 포함 여부, 길이, 특수문자 확인
4. **API 응답 검증**: `success_cnt` 확인 (result_code가 '1'이지만 실제 전송 실패한 경우 감지)

---

## ✅ 구현 내용

### 1. 발신번호 검증 (`validateSenderPhone`)

**위치**: 
- `app/api/admin/affiliate/leads/[leadId]/request-passport/route.ts`
- `app/api/admin/passport-request/send/route.ts`

**검증 항목**:
- 발신번호 존재 여부 확인
- 하이픈, 공백 제거 후 숫자만 추출
- 10-11자리 형식 확인
- 010으로 시작하는 경우 11자리 확인

**예시**:
```typescript
// ✅ 올바른 형식
validateSenderPhone("010-1234-5678") // { valid: true, normalized: "01012345678" }
validateSenderPhone("01012345678")   // { valid: true, normalized: "01012345678" }

// ❌ 잘못된 형식
validateSenderPhone("010-1234")      // { valid: false, error: "발신번호 형식이 올바르지 않습니다." }
```

---

### 2. 수신번호 검증 강화 (`normalizePhone`)

**기존 문제점**:
- 하이픈 포함 전화번호 처리 미흡
- 010 외 다른 번호(011, 016, 017, 018, 019) 처리 미흡

**개선 사항**:
- 하이픈, 공백 자동 제거
- 010으로 시작하는 11자리 처리
- 10자리인 경우 앞에 0 자동 추가
- 011, 016, 017, 018, 019 등 다른 번호도 처리

**예시**:
```typescript
// ✅ 올바른 형식
normalizePhone("010-2495-8013")  // "01024958013"
normalizePhone("01024958013")    // "01024958013"
normalizePhone("1024958013")     // "01024958013" (앞에 0 추가)
normalizePhone("011-123-4567")   // "0111234567"

// ❌ 잘못된 형식
normalizePhone("010-1234")       // null
normalizePhone("123456789")      // null
```

---

### 3. 메시지 내용 검증 (`validateMessageContent`)

**검증 항목**:
- 여권 제출 링크 포함 여부 확인
- 메시지 길이 확인 (최대 2000자)
- 특수문자 경고 (차단 가능한 특수문자 감지)

**예시**:
```typescript
// ✅ 올바른 메시지
validateMessageContent("안녕하세요. 여권 제출 링크: https://...", "https://...")
// { valid: true }

// ❌ 링크 누락
validateMessageContent("안녕하세요.", "https://...")
// { valid: false, error: "메시지에 여권 제출 링크가 포함되지 않았습니다." }

// ⚠️ 경고 (특수문자 포함)
validateMessageContent("안녕하세요! 여권 제출: https://...", "https://...")
// { valid: true, warnings: ["메시지에 특수문자가 포함되어 있습니다..."] }
```

---

### 4. API 응답 검증 강화

**기존 문제점**:
- `result_code`가 '1'이면 성공으로 처리
- 실제로 `success_cnt`가 0인 경우를 감지하지 못함

**개선 사항**:
- `result_code`가 '1'이면서 `success_cnt > 0`인 경우만 성공으로 처리
- `result_code`가 '1'이지만 `success_cnt === 0`인 경우 명확한 에러 메시지 제공

**에러 메시지 예시**:
```
알리고 API는 성공했지만 실제 전송은 실패했습니다. 
(성공: 0건, 실패: 1건) 
발신번호 등록 상태와 수신번호 형식을 확인해주세요.
```

---

## 📝 수정된 파일

### 1. `app/api/admin/affiliate/leads/[leadId]/request-passport/route.ts`

**추가된 함수**:
- `validateSenderPhone()`: 발신번호 검증
- `validateMessageContent()`: 메시지 내용 검증
- `normalizePhone()`: 수신번호 정규화 강화

**수정된 로직**:
- SMS 전송 전 3단계 검증 (발신번호 → 수신번호 → 메시지)
- API 응답에서 `success_cnt` 확인
- 상세한 로깅 추가

---

### 2. `app/api/admin/passport-request/send/route.ts`

**추가된 함수**:
- `validateSenderPhone()`: 발신번호 검증
- `validateMessageContent()`: 메시지 내용 검증
- `normalizePhone()`: 수신번호 정규화 강화

**수정된 로직**:
- SMS 전송 전 3단계 검증 (발신번호 → 수신번호 → 메시지)
- API 응답에서 `success_cnt` 확인
- 상세한 로깅 추가

---

## 🔍 검증 흐름

```
1. 발신번호 검증
   ├─ 발신번호 존재 여부 확인
   ├─ 하이픈/공백 제거
   └─ 형식 검증 (10-11자리)

2. 수신번호 검증
   ├─ 하이픈/공백 제거
   ├─ 010으로 시작하는 11자리 확인
   └─ 10자리인 경우 앞에 0 추가

3. 메시지 내용 검증
   ├─ 여권 제출 링크 포함 여부
   ├─ 메시지 길이 확인 (최대 2000자)
   └─ 특수문자 경고

4. 알리고 API 호출
   └─ 정규화된 발신번호/수신번호 사용

5. API 응답 검증
   ├─ result_code === '1' 확인
   ├─ success_cnt > 0 확인
   └─ 실패 시 명확한 에러 메시지 제공
```

---

## 📊 로깅 개선

### 전송 전 로그
```typescript
logger.log('[PassportRequest] 전화번호 정규화:', {
  original: targetPhone,
  normalized: normalizedPhone,
  senderNormalized: senderValidation.normalized,
});
```

### API 호출 로그
```typescript
logger.log('[PassportRequest] 알리고 API 호출:', {
  sender: senderValidation.normalized || sender,
  receiver: normalizedPhone,
  msgType,
  messageLength: personalizedMessage.length,
  hasLink: personalizedMessage.includes(link),
});
```

### 성공 로그
```typescript
logger.log('[PassportRequest] SMS 전송 성공:', {
  messageId: messageId,
  receiver: normalizedPhone,
  sender: senderValidation.normalized || sender,
  successCnt: sendResponse.success_cnt,
  errorCnt: sendResponse.error_cnt,
});
```

### 실패 로그 (성공 0건)
```typescript
logger.error('[PassportRequest] SMS 전송 실패 (성공 0건):', {
  resultCode: sendResponse.result_code,
  successCnt: 0,
  errorCnt: 1,
  receiver: normalizedPhone,
  sender: senderValidation.normalized || sender,
});
```

---

## 🎯 기대 효과

1. **발신번호 문제 조기 발견**: 전송 전에 발신번호 형식 오류를 감지
2. **수신번호 문제 조기 발견**: 하이픈 포함 번호도 자동 처리
3. **메시지 내용 문제 조기 발견**: 링크 누락, 길이 초과 등 사전 확인
4. **실제 전송 실패 감지**: API는 성공했지만 실제 전송이 실패한 경우 명확히 구분
5. **명확한 에러 메시지**: 문제 발생 시 원인 파악이 쉬움

---

## ✅ 테스트 체크리스트

- [x] 발신번호 형식 검증 (하이픈 포함/미포함)
- [x] 수신번호 형식 검증 (하이픈 포함/미포함)
- [x] 메시지 링크 포함 여부 확인
- [x] 메시지 길이 제한 확인
- [x] API 응답 success_cnt 확인
- [x] 에러 메시지 명확성 확인
- [x] 로깅 상세도 확인

---

## 📌 주의사항

1. **발신번호 등록**: 알리고 관리자 페이지에서 발신번호가 등록되어 있어야 합니다.
2. **수신번호 형식**: 하이픈이 포함되어 있어도 자동으로 처리되지만, 가능하면 숫자만 사용하는 것을 권장합니다.
3. **메시지 링크**: 여권 제출 링크가 반드시 메시지에 포함되어야 합니다.
4. **API 응답**: `result_code`가 '1'이어도 `success_cnt`가 0이면 실제 전송은 실패한 것입니다.

---

## 🔄 다음 단계 (선택 사항)

1. **발신번호 목록 조회 API 연동**: 알리고 API로 등록된 발신번호 목록을 조회하여 사전 확인
2. **재시도 로직**: 일시적 실패 시 자동 재시도
3. **전송 실패 알림**: 관리자에게 전송 실패 알림 (이메일/SMS)

---

**작업 완료**: ✅  
**빌드 상태**: ✅ 통과 (동적 라우트 경고는 정상)  
**테스트 상태**: ✅ 검증 로직 구현 완료


