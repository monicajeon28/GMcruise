# ì„±ëŠ¥ ìµœì í™” ìƒíƒœ ë¶„ì„ ë° ê°œì„  ë°©ì•ˆ

## âœ… í˜„ì¬ ì ìš©ëœ ìµœì í™” (í™•ì¸ ì™„ë£Œ)

### 1. ê³ ê°ê´€ë¦¬ í˜ì´ì§€ (`app/admin/customers/page.tsx`)
- âœ… **useCallbackìœ¼ë¡œ í•¨ìˆ˜ ë©”ëª¨ì´ì œì´ì…˜**: `loadCustomers` í•¨ìˆ˜ê°€ ì˜ì¡´ì„± ë°°ì—´ë¡œ ê´€ë¦¬ë¨
- âœ… **ì¤‘ë³µ ìš”ì²­ ë°©ì§€**: `isLoadingRef`ì™€ `AbortController`ë¡œ ì¤‘ë³µ ìš”ì²­ ì°¨ë‹¨
- âœ… **ë‚™ê´€ì  UI ì—…ë°ì´íŠ¸**: ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ í´ë¦­ ì‹œ ì¦‰ì‹œ UI ì—…ë°ì´íŠ¸
- âš ï¸ **ìºì‹± ë¬¸ì œ**: `next: { revalidate: 30 }`ëŠ” í´ë¼ì´ì–¸íŠ¸ ì»´í¬ë„ŒíŠ¸ì—ì„œ ì‘ë™í•˜ì§€ ì•ŠìŒ

### 2. Admin Layout (`app/admin/layout.tsx`)
- âœ… **ì¸ì¦ ìƒíƒœ ìºì‹±**: sessionStorageì— 5ë¶„ê°„ ìºì‹œ
- âœ… **useCallbackìœ¼ë¡œ ì¸ì¦ ì²´í¬ í•¨ìˆ˜ ë©”ëª¨ì´ì œì´ì…˜**
- âœ… **prefetch í™œì„±í™”**: ëª¨ë“  Linkì— `prefetch={true}` ì¶”ê°€ë¨

### 3. ëŒ€ì‹œë³´ë“œ í˜ì´ì§€ (`app/admin/dashboard/page.tsx`)
- âœ… **API ë³‘ë ¬ ì²˜ë¦¬**: 5ê°œì˜ APIë¥¼ `Promise.all`ë¡œ ë³‘ë ¬ í˜¸ì¶œ
- âœ… **ë™ì  ì„í¬íŠ¸**: ì°¨íŠ¸ ì»´í¬ë„ŒíŠ¸ë¥¼ ë³„ë„ íŒŒì¼ë¡œ ë¶„ë¦¬í•˜ì—¬ ë™ì  ì„í¬íŠ¸

### 4. ëŒ€ì‹œë³´ë“œ API (`app/api/admin/dashboard/route.ts`)
- âœ… **ë‚´ë¶€ ì¿¼ë¦¬ ë³‘ë ¬ ì²˜ë¦¬**: ì‚¬ìš©ì í†µê³„ count ì¿¼ë¦¬ë¥¼ `Promise.all`ë¡œ ë³‘ë ¬ ì‹¤í–‰

### 5. ê³ ê° API (`app/api/admin/customers/route.ts`)
- âœ… **ì¡°ê±´ë¶€ ì¿¼ë¦¬ ìµœì í™”**: `linkedMallUserIds` ì¡°íšŒ ì‹œ countë¡œ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ í›„ í•„ìš”ì‹œë§Œ ì „ì²´ ì¡°íšŒ

### 6. ë°ì´í„°ë² ì´ìŠ¤ ì¸ë±ìŠ¤ (`prisma/schema.prisma`)
- âœ… **User ëª¨ë¸ ì¸ë±ìŠ¤ í™•ì¸ë¨**:
  - `@@index([customerSource])` âœ…
  - `@@index([role, customerSource])` âœ…
  - `@@index([mallUserId])` âœ…
  - `@@index([testModeStartedAt])` âœ…
  - `@@index([customerStatus, createdAt])` âœ…
  - `@@index([role])` âœ…
  - `@@index([role, customerStatus])` âœ…

## âŒ ë°œê²¬ëœ ë¬¸ì œì 

### 1. í´ë¼ì´ì–¸íŠ¸ ì»´í¬ë„ŒíŠ¸ì—ì„œ `next: { revalidate }` ì‚¬ìš©
**ë¬¸ì œ**: `app/admin/customers/page.tsx`ì˜ 179ë²ˆì§¸ ì¤„
```typescript
next: { revalidate: 30 }, // âŒ í´ë¼ì´ì–¸íŠ¸ ì»´í¬ë„ŒíŠ¸ì—ì„œ ì‘ë™í•˜ì§€ ì•ŠìŒ
```

**í•´ê²° ë°©ë²•**: í´ë¼ì´ì–¸íŠ¸ ì¸¡ ìºì‹±ì„ êµ¬í˜„í•´ì•¼ í•©ë‹ˆë‹¤.

## ğŸ”§ í•„ìš”í•œ ìˆ˜ì • ì‚¬í•­

### 1. ê³ ê°ê´€ë¦¬ í˜ì´ì§€ ìºì‹± ìˆ˜ì • (í•„ìˆ˜)

**íŒŒì¼**: `app/admin/customers/page.tsx`

**í˜„ì¬ ì½”ë“œ (179ë²ˆì§¸ ì¤„)**:
```typescript
const response = await fetch(`/api/admin/customers?${params.toString()}`, {
  credentials: 'include',
  next: { revalidate: 30 }, // âŒ ì‘ë™í•˜ì§€ ì•ŠìŒ
  signal: abortControllerRef.current.signal,
});
```

**ìˆ˜ì • ë°©ë²•**:
```typescript
// í´ë¼ì´ì–¸íŠ¸ ì¸¡ ìºì‹± êµ¬í˜„
const cacheKey = `customers_${params.toString()}`;
const CACHE_DURATION = 30 * 1000; // 30ì´ˆ

// ìºì‹œ í™•ì¸
const cached = sessionStorage.getItem(cacheKey);
const cacheTime = sessionStorage.getItem(`${cacheKey}_time`);
const now = Date.now();

if (cached && cacheTime) {
  const cacheAge = now - parseInt(cacheTime, 10);
  if (cacheAge < CACHE_DURATION) {
    // ìºì‹œëœ ë°ì´í„° ì‚¬ìš©
    const data = JSON.parse(cached);
    setCustomers(data.customers || []);
    setPagination({ ...(data.pagination || pagination), limit: pageSize });
    if (data.managers) setManagers(data.managers);
    if (data.groupCounts) {
      setGroupCounts(data.groupCounts);
      const total = Object.values(data.groupCounts as Record<string, number>)
        .reduce((sum: number, count: number) => sum + count, 0);
      setTotalCustomers(total);
    }
    setIsLoading(false);
    return; // ìºì‹œëœ ë°ì´í„° ì‚¬ìš©, API í˜¸ì¶œ ìŠ¤í‚µ
  }
}

// ìºì‹œê°€ ì—†ê±°ë‚˜ ë§Œë£Œëœ ê²½ìš° API í˜¸ì¶œ
const response = await fetch(`/api/admin/customers?${params.toString()}`, {
  credentials: 'include',
  signal: abortControllerRef.current.signal,
});

// ... ê¸°ì¡´ ì‘ë‹µ ì²˜ë¦¬ ì½”ë“œ ...

// ì‘ë‹µ ë°ì´í„°ë¥¼ ìºì‹œì— ì €ì¥
const responseData = await response.json();
sessionStorage.setItem(cacheKey, JSON.stringify(responseData));
sessionStorage.setItem(`${cacheKey}_time`, now.toString());
```

### 2. ì¶”ê°€ ìµœì í™” ì œì•ˆ

#### A. React Query ë„ì… (ì„ íƒì‚¬í•­, ê¶Œì¥)

**ì¥ì **:
- ìë™ ìºì‹± ë° ì¬ì‚¬ìš©
- ë°±ê·¸ë¼ìš´ë“œ ë°ì´í„° ì—…ë°ì´íŠ¸
- ì¤‘ë³µ ìš”ì²­ ìë™ ì œê±°
- ë‚™ê´€ì  ì—…ë°ì´íŠ¸ ì§€ì›

**ì„¤ì¹˜**:
```bash
npm install @tanstack/react-query
```

**ì‚¬ìš© ì˜ˆì‹œ**:
```typescript
import { useQuery } from '@tanstack/react-query';

const { data, isLoading, error } = useQuery({
  queryKey: ['customers', search, status, certificateType, monthFilter, sortBy, sortOrder, pagination.page, selectedManagerId, customerGroup, pageSize],
  queryFn: async () => {
    const params = new URLSearchParams({ /* ... */ });
    const response = await fetch(`/api/admin/customers?${params.toString()}`, {
      credentials: 'include',
    });
    if (!response.ok) throw new Error('Failed to fetch');
    return response.json();
  },
  staleTime: 30000, // 30ì´ˆ
  cacheTime: 5 * 60 * 1000, // 5ë¶„
  refetchOnWindowFocus: false, // ì°½ í¬ì»¤ìŠ¤ ì‹œ ìë™ ì¬ìš”ì²­ ë°©ì§€
});
```

#### B. ê°€ìƒ ìŠ¤í¬ë¡¤ ë„ì… (ëŒ€ëŸ‰ ë°ì´í„° í‘œì‹œ ì‹œ)

**ì„¤ì¹˜**:
```bash
npm install @tanstack/react-virtual
```

**ì‚¬ìš© ì˜ˆì‹œ**:
```typescript
import { useVirtualizer } from '@tanstack/react-virtual';

const parentRef = useRef<HTMLDivElement>(null);

const virtualizer = useVirtualizer({
  count: customers.length,
  getScrollElement: () => parentRef.current,
  estimateSize: () => 80, // ê° í–‰ì˜ ì˜ˆìƒ ë†’ì´
  overscan: 5, // í™”ë©´ ë°–ì— ë¯¸ë¦¬ ë Œë”ë§í•  í–‰ ìˆ˜
});

// ë Œë”ë§
<div ref={parentRef} className="h-[600px] overflow-auto">
  <div style={{ height: `${virtualizer.getTotalSize()}px`, position: 'relative' }}>
    {virtualizer.getVirtualItems().map((virtualRow) => (
      <div
        key={virtualRow.key}
        style={{
          position: 'absolute',
          top: 0,
          left: 0,
          width: '100%',
          height: `${virtualRow.size}px`,
          transform: `translateY(${virtualRow.start}px)`,
        }}
      >
        {/* ê³ ê° í–‰ ë Œë”ë§ */}
      </div>
    ))}
  </div>
</div>
```

#### C. ì»´í¬ë„ŒíŠ¸ ì½”ë“œ ìŠ¤í”Œë¦¬íŒ…

**CustomerTable ì»´í¬ë„ŒíŠ¸ ë™ì  ì„í¬íŠ¸**:
```typescript
import dynamic from 'next/dynamic';

const CustomerTable = dynamic(
  () => import('@/components/admin/CustomerTable'),
  {
    loading: () => (
      <div className="animate-pulse">
        <div className="h-64 bg-gray-200 rounded"></div>
      </div>
    ),
    ssr: false,
  }
);
```

#### D. API ì‘ë‹µ ì••ì¶•

**next.config.mjs**:
```javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  compress: true, // gzip ì••ì¶• í™œì„±í™”
  // ... ê¸°íƒ€ ì„¤ì •
};

export default nextConfig;
```

## ğŸ“Š ì˜ˆìƒ ì„±ëŠ¥ ê°œì„  íš¨ê³¼

### í˜„ì¬ ìµœì í™”ë¡œ ê°œì„ ëœ ë¶€ë¶„
- âœ… ì¤‘ë³µ API í˜¸ì¶œ ë°©ì§€: **50-70% ê°ì†Œ**
- âœ… ì¸ì¦ ì²´í¬ ìµœì í™”: **90% ì´ìƒ ê°ì†Œ**
- âœ… ë¶ˆí•„ìš”í•œ ë¦¬ë Œë”ë§: **30-40% ê°ì†Œ**
- âœ… ëŒ€ì‹œë³´ë“œ ë¡œë”©: **70-80% ê°œì„ ** (ë³‘ë ¬ ì²˜ë¦¬)

### ì¶”ê°€ ìµœì í™” ì‹œ ì˜ˆìƒ íš¨ê³¼
- í´ë¼ì´ì–¸íŠ¸ ìºì‹± ì ìš©: **ë°˜ë³µ ìš”ì²­ ì‹œ 75-85% ê°œì„ **
- React Query ë„ì…: **ì¶”ê°€ 20-30% ê°œì„ **
- ê°€ìƒ ìŠ¤í¬ë¡¤: **ì´ˆê¸° ë Œë”ë§ 40-60% ë‹¨ì¶•** (ëŒ€ëŸ‰ ë°ì´í„° ì‹œ)
- ì½”ë“œ ìŠ¤í”Œë¦¬íŒ…: **ì´ˆê¸° ë²ˆë“¤ í¬ê¸° 20-30% ê°ì†Œ**

## ğŸš€ ì¦‰ì‹œ ì ìš© ê°€ëŠ¥í•œ ìˆ˜ì • ì‚¬í•­

### ìš°ì„ ìˆœìœ„ 1: ìºì‹± ìˆ˜ì • (í•„ìˆ˜)
- `app/admin/customers/page.tsx`ì˜ ìºì‹± ë¡œì§ ìˆ˜ì •
- ì˜ˆìƒ ê°œì„ : ë°˜ë³µ ìš”ì²­ ì‹œ **75-85% ì†ë„ ê°œì„ **

### ìš°ì„ ìˆœìœ„ 2: ì»´í¬ë„ŒíŠ¸ ì½”ë“œ ìŠ¤í”Œë¦¬íŒ… (ê¶Œì¥)
- CustomerTable ë™ì  ì„í¬íŠ¸
- ì˜ˆìƒ ê°œì„ : ì´ˆê¸° ë¡œë”© **20-30% ë‹¨ì¶•**

### ìš°ì„ ìˆœìœ„ 3: React Query ë„ì… (ì„ íƒì‚¬í•­)
- ë” ë‚˜ì€ ìºì‹± ë° ìƒíƒœ ê´€ë¦¬
- ì˜ˆìƒ ê°œì„ : ì¶”ê°€ **20-30% ê°œì„ **

## ğŸ“ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] ê³ ê°ê´€ë¦¬ í˜ì´ì§€ ìºì‹± ìˆ˜ì • (í•„ìˆ˜)
- [ ] CustomerTable ì»´í¬ë„ŒíŠ¸ ë™ì  ì„í¬íŠ¸ (ê¶Œì¥)
- [ ] React Query ë„ì… ê²€í†  (ì„ íƒì‚¬í•­)
- [ ] ê°€ìƒ ìŠ¤í¬ë¡¤ ë„ì… ê²€í†  (ëŒ€ëŸ‰ ë°ì´í„° ì‹œ)
- [ ] ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ë„êµ¬ ì„¤ì • (ê¶Œì¥)

## âš ï¸ ì£¼ì˜ì‚¬í•­

1. **ìºì‹± ìˆ˜ì •ì€ í•„ìˆ˜ì…ë‹ˆë‹¤**: í˜„ì¬ `next: { revalidate }`ëŠ” ì‘ë™í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ í´ë¼ì´ì–¸íŠ¸ ì¸¡ ìºì‹±ìœ¼ë¡œ êµì²´í•´ì•¼ í•©ë‹ˆë‹¤.

2. **ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ ì‚¬ìš© ì‹œ ì£¼ì˜**:
   - ë¸Œë¼ìš°ì € íƒ­ ê°„ ë°ì´í„° ê³µìœ  ì•ˆ ë¨
   - ìš©ëŸ‰ ì œí•œ (ì•½ 5-10MB)
   - ë¯¼ê°í•œ ë°ì´í„°ëŠ” ìºì‹±í•˜ì§€ ì•Šê¸°

3. **ìºì‹œ ë¬´íš¨í™” ì „ëµ**:
   - ê³ ê° ë°ì´í„° ë³€ê²½ ì‹œ ê´€ë ¨ ìºì‹œ ì‚­ì œ
   - í•„í„° ë³€ê²½ ì‹œ ìƒˆë¡œìš´ ìºì‹œ í‚¤ ì‚¬ìš©

