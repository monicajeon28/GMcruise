# 즉시 실행해야 할 작업 가이드

## 🚨 지금 바로 해야 할 3가지

### 1️⃣ DB 인덱스 추가 (10분) - 최우선

**왜 필요한가?**
- 1만명 규모에서 통계 조회가 매우 느려짐
- 배포 후 즉시 성능 문제 발생 가능

**어떻게 하나?**

**방법 1: Prisma 마이그레이션 사용 (권장)**
```bash
# 1. schema.prisma 파일에 인덱스 추가
# 2. 마이그레이션 생성
npx prisma migrate dev --name add_affiliate_indexes

# 3. 프로덕션에 적용
npx prisma migrate deploy
```

**방법 2: 직접 SQL 실행 (빠른 방법)**
```sql
-- 프로덕션 DB에 직접 실행
CREATE INDEX IF NOT EXISTS idx_affiliate_lead_manager_created ON "AffiliateLead"(managerId, createdAt);
CREATE INDEX IF NOT EXISTS idx_affiliate_lead_agent_created ON "AffiliateLead"(agentId, createdAt);
CREATE INDEX IF NOT EXISTS idx_affiliate_sale_manager_date ON "AffiliateSale"(managerId, saleDate);
CREATE INDEX IF NOT EXISTS idx_affiliate_sale_agent_date ON "AffiliateSale"(agentId, saleDate);
CREATE INDEX IF NOT EXISTS idx_affiliate_link_manager ON "AffiliateLink"(managerId);
CREATE INDEX IF NOT EXISTS idx_affiliate_link_agent ON "AffiliateLink"(agentId);
```

**예상 시간**: 10분

---

### 2️⃣ 구매고객 목록 페이지네이션 추가 (1-2시간)

**왜 필요한가?**
- 현재 전체 데이터를 한 번에 로드
- 1만명 규모에서 브라우저 메모리 부족 가능

**어떻게 하나?**

**1단계: API 수정** (`app/api/partner/reservations/route.ts`)
```typescript
export async function GET(req: NextRequest) {
  // ... 기존 코드 ...
  
  const { searchParams } = new URL(req.url);
  const page = parseInt(searchParams.get('page') || '1');
  const limit = parseInt(searchParams.get('limit') || '50');
  const skip = (page - 1) * limit;
  
  // 예약 목록 조회에 skip, take 추가
  const reservations = await prisma.reservation.findMany({
    where: {
      userId: { in: userIdArray },
    },
    skip,
    take: limit,
    // ... 기존 include ...
  });
  
  // 총 개수 조회
  const total = await prisma.reservation.count({
    where: {
      userId: { in: userIdArray },
    },
  });
  
  return NextResponse.json({
    ok: true,
    reservations,
    pagination: {
      page,
      limit,
      total,
      totalPages: Math.ceil(total / limit),
    },
  });
}
```

**2단계: 프론트엔드 수정** (`app/partner/[partnerId]/dashboard/PartnerDashboard.tsx`)
```typescript
// 페이지네이션 상태 추가
const [purchasedPage, setPurchasedPage] = useState(1);
const [purchasedTotal, setPurchasedTotal] = useState(0);

// 로드 함수 수정
const loadPurchasedReservations = useCallback(async (page: number = 1) => {
  if (!isBranchManager) return;
  try {
    setLoadingPurchasedReservations(true);
    const response = await fetch(`/api/partner/reservations?page=${page}&limit=50`, {
      credentials: 'include',
    });
    const data = await response.json();
    if (data.ok) {
      setPurchasedReservations(data.reservations || []);
      setPurchasedTotal(data.pagination?.total || 0);
      setPurchasedPage(data.pagination?.page || 1);
    }
  } catch (error) {
    // ...
  }
}, [isBranchManager]);

// 페이지네이션 UI 추가 (구매고객 목록 하단)
```

**예상 시간**: 1-2시간

---

### 3️⃣ 환경변수 검증 스크립트 작성 (30분)

**왜 필요한가?**
- 배포 시 환경변수 누락으로 인한 에러 방지
- 빠른 문제 발견

**어떻게 하나?**

**파일 생성**: `scripts/check-env-before-deploy.ts`
```typescript
const requiredEnvVars = [
  'GEMINI_API_KEY',
  'GOOGLE_DRIVE_CLIENT_ID',
  'GOOGLE_DRIVE_CLIENT_SECRET',
  'DATABASE_URL',
  'NEXT_PUBLIC_BASE_URL',
];

const missing: string[] = [];

requiredEnvVars.forEach(varName => {
  if (!process.env[varName]) {
    missing.push(varName);
  }
});

if (missing.length > 0) {
  console.error('❌ 누락된 환경변수:');
  missing.forEach(v => console.error(`  - ${v}`));
  process.exit(1);
}

console.log('✅ 모든 필수 환경변수가 설정되어 있습니다.');
```

**package.json에 스크립트 추가**:
```json
{
  "scripts": {
    "check:env": "tsx scripts/check-env-before-deploy.ts"
  }
}
```

**사용 방법**:
```bash
npm run check:env
```

**예상 시간**: 30분

---

## 📋 배포 당일 체크리스트

### 배포 전 (배포 1시간 전)

1. **DB 인덱스 추가 확인**
   ```bash
   # 인덱스가 제대로 생성되었는지 확인
   # DB에 직접 접속해서 확인하거나
   # 통계 조회 API 응답 시간 측정
   ```

2. **환경변수 확인**
   ```bash
   npm run check:env
   ```

3. **각 대리점장/판매원 안내**
   - 알리고 설정 가이드 문서 공유
   - 발신번호 등록 방법 안내

### 배포 직후 (배포 후 30분 내)

1. **기능 테스트**
   - [ ] 대시보드 접속
   - [ ] 통계 데이터 로딩 (속도 확인)
   - [ ] 구매고객 목록 로딩 (페이지네이션 확인)
   - [ ] SMS 발송 테스트 (테스트 계정)

2. **에러 확인**
   - [ ] 서버 로그 확인
   - [ ] 브라우저 콘솔 확인
   - [ ] DB 연결 확인

---

## 🎯 작업 우선순위 요약

### 🔴 배포 전 필수 (지금 바로)
1. **DB 인덱스 추가** (10분) ← 가장 중요!
2. **구매고객 목록 페이지네이션** (1-2시간)
3. **환경변수 검증 스크립트** (30분)

### 🟡 배포 후 1주일 내
4. 통계 데이터 캐싱 (2-3시간)
5. 고객 검색 성능 개선 (1-2시간)

### 🟢 선택 사항
6. 대시보드 기능 추가 (퍼널 현황, 그룹 통계 등)

---

## 💡 핵심 메시지

**지금 당장 해야 할 것**:
1. **DB 인덱스 추가** ← 이것만 해도 성능 10배 향상!
2. **구매고객 목록 페이지네이션** ← 1만명 규모 필수!
3. **환경변수 확인** ← 배포 실수 방지!

이 3가지만 완료하면 배포 가능합니다! 🚀


