# 팀 대시보드 메시지 연동 시뮬레이션 테스트 가이드

## 📋 테스트 목적

관리자 패널에서 팀 대시보드 메시지를 보냈을 때, 판매원 대시보드와 대리점장 대시보드에서 정상적으로 표시되고 연동되는지 확인합니다.

---

## 🔄 연동 흐름

```
관리자 패널
  ↓
팀 대시보드 메시지함에서 메시지 발송
  ↓
AdminMessage 생성 (messageType: 'team-dashboard', userId: 판매원/대리점장 ID)
  ↓
판매원/대리점장 대시보드
  ↓
"팀 메시지" 버튼에 미읽음 배지 표시
  ↓
메시지 모달에서 메시지 확인
  ↓
읽음 처리 → 배지 업데이트
```

---

## 🧪 시뮬레이션 테스트 절차

### 1단계: 테스트 계정 준비

#### 판매원 계정 확인
```sql
-- 판매원 계정 조회
SELECT id, name, phone, role, "affiliateCode"
FROM "User"
WHERE role = 'agent'
LIMIT 5;
```

#### 대리점장 계정 확인
```sql
-- 대리점장 계정 조회
SELECT id, name, phone, role, "affiliateCode"
FROM "User"
WHERE role = 'manager'
LIMIT 5;
```

---

### 2단계: 관리자에서 메시지 발송

1. **관리자 로그인**
   - `/admin/login` 접속
   - 관리자 계정으로 로그인

2. **팀 대시보드 메시지함 접속**
   - `/admin/team-dashboard-messages` 접속
   - 또는 메뉴에서 "팀 대시보드 메시지함" 클릭

3. **메시지 발송**
   - 우측 상단 "메시지 보내기" 버튼 클릭
   - 제목 입력: "테스트 메시지 - 판매원/대리점장 연동 확인"
   - 내용 입력: "이 메시지는 판매원과 대리점장 대시보드에서 확인할 수 있습니다."
   - 수신자 선택:
     - 판매원 계정 선택 (최소 1명)
     - 대리점장 계정 선택 (최소 1명)
   - "메시지 보내기" 클릭

4. **발송 확인**
   - 성공 메시지 확인
   - 메시지 목록에 발송된 메시지 표시 확인

---

### 3단계: 판매원 대시보드에서 확인

1. **판매원 계정으로 로그인**
   - `/admin/login` 접속
   - 판매원 계정으로 로그인 (role='agent')

2. **판매원 대시보드 접속**
   - `/admin/affiliate/agent-dashboard` 접속
   - 또는 메뉴에서 "판매원 대시보드" 클릭

3. **메시지 알림 확인**
   - 우측 상단에 "팀 메시지" 버튼 확인
   - **확인 사항**:
     - ✅ 버튼이 틸(teal) 색상으로 표시되는지
     - ✅ 미읽음 메시지가 있으면 빨간색 배지에 숫자 표시되는지
     - ✅ 배지 숫자가 정확한지

4. **메시지 모달 열기**
   - "팀 메시지" 버튼 클릭
   - 메시지 모달 열림

5. **메시지 내용 확인**
   - **확인 사항**:
     - ✅ 발송한 메시지가 표시되는지
     - ✅ 미읽음 메시지는 틸 배경색으로 표시되는지
     - ✅ 읽은 메시지는 회색 배경색으로 표시되는지
     - ✅ "팀 대시보드" 배지가 표시되는지
     - ✅ 발신자 이름이 표시되는지
     - ✅ 발송 시간이 표시되는지

6. **읽음 처리 테스트**
   - 미읽음 메시지의 "읽음 처리" 버튼 클릭
   - **확인 사항**:
     - ✅ 메시지가 읽음 상태로 변경되는지
     - ✅ 배지 숫자가 감소하는지
     - ✅ 배경색이 회색으로 변경되는지

7. **전체 메시지함 링크 확인**
   - 모달 하단 "전체 메시지함 보기" 클릭
   - `/admin/team-dashboard-messages`로 이동하는지 확인

---

### 4단계: 대리점장 대시보드에서 확인

1. **대리점장 계정으로 로그인**
   - `/admin/login` 접속
   - 대리점장 계정으로 로그인 (role='manager')

2. **대리점장 대시보드 접속**
   - `/admin/affiliate/team-dashboard` 접속
   - 또는 메뉴에서 "팀 성과 대시보드" 클릭

3. **메시지 알림 확인**
   - 우측 상단에 "팀 메시지" 버튼 확인
   - **확인 사항**:
     - ✅ 버튼이 틸(teal) 색상으로 표시되는지
     - ✅ 미읽음 메시지가 있으면 빨간색 배지에 숫자 표시되는지
     - ✅ 배지 숫자가 정확한지

4. **메시지 모달 열기**
   - "팀 메시지" 버튼 클릭
   - 메시지 모달 열림

5. **메시지 내용 확인**
   - 판매원 대시보드와 동일한 확인 사항

6. **읽음 처리 테스트**
   - 판매원 대시보드와 동일한 테스트

---

### 5단계: 실시간 연동 확인

1. **관리자에서 새 메시지 발송**
   - 판매원/대리점장이 대시보드를 보고 있는 상태에서
   - 관리자가 새 메시지 발송

2. **자동 갱신 확인**
   - 판매원/대리점장 대시보드에서 5분 이내 자동 갱신되는지 확인
   - 또는 "새로고침" 버튼 클릭 후 배지 업데이트 확인

3. **여러 메시지 발송 테스트**
   - 같은 수신자에게 여러 메시지 발송
   - 모든 메시지가 모달에 표시되는지 확인
   - 미읽음 개수가 정확히 표시되는지 확인

---

## ✅ 체크리스트

### 관리자 패널
- [ ] 팀 대시보드 메시지함 페이지 접근 가능
- [ ] "메시지 보내기" 버튼 표시
- [ ] 메시지 작성 모달 정상 작동
- [ ] 고객 검색/선택 기능 정상 작동
- [ ] 메시지 발송 성공
- [ ] 발송된 메시지가 목록에 표시됨

### 판매원 대시보드
- [ ] "팀 메시지" 버튼 표시
- [ ] 미읽음 메시지가 있으면 배지 표시
- [ ] 배지 숫자가 정확함
- [ ] 메시지 모달 정상 작동
- [ ] 메시지 내용 정확히 표시됨
- [ ] 읽음 처리 기능 정상 작동
- [ ] 읽음 처리 후 배지 업데이트
- [ ] 전체 메시지함 링크 정상 작동

### 대리점장 대시보드
- [ ] "팀 메시지" 버튼 표시
- [ ] 미읽음 메시지가 있으면 배지 표시
- [ ] 배지 숫자가 정확함
- [ ] 메시지 모달 정상 작동
- [ ] 메시지 내용 정확히 표시됨
- [ ] 읽음 처리 기능 정상 작동
- [ ] 읽음 처리 후 배지 업데이트
- [ ] 전체 메시지함 링크 정상 작동

### 연동 확인
- [ ] 관리자에서 발송한 메시지가 판매원 대시보드에 표시됨
- [ ] 관리자에서 발송한 메시지가 대리점장 대시보드에 표시됨
- [ ] 판매원/대리점장이 읽음 처리하면 관리자 페이지에서 읽음 상태 반영됨
- [ ] 관리자가 메시지 삭제하면 판매원/대리점장 대시보드에서도 사라짐
- [ ] 자동 갱신 기능 정상 작동 (5분마다)

---

## 🐛 문제 해결

### 메시지가 표시되지 않는 경우

1. **API 확인**
   ```bash
   # 판매원/대리점장 계정으로 로그인 후
   curl -X GET "http://localhost:3000/api/admin/affiliate/my-messages" \
     -H "Cookie: cg.sid.v2=[세션쿠키]" \
     -H "Content-Type: application/json"
   ```

2. **데이터베이스 확인**
   ```sql
   -- 메시지가 실제로 발송되었는지 확인
   SELECT id, "adminId", "userId", title, "messageType", "isActive", "createdAt"
   FROM "AdminMessage"
   WHERE "messageType" = 'team-dashboard'
   ORDER BY "createdAt" DESC
   LIMIT 10;
   
   -- 특정 사용자에게 발송된 메시지 확인
   SELECT * FROM "AdminMessage"
   WHERE "messageType" = 'team-dashboard'
   AND "userId" = [판매원/대리점장 ID]
   ORDER BY "createdAt" DESC;
   ```

3. **사용자 ID 확인**
   ```sql
   -- 판매원/대리점장의 User ID 확인
   SELECT id, name, phone, role
   FROM "User"
   WHERE role IN ('agent', 'manager');
   ```

### 배지가 표시되지 않는 경우

1. 브라우저 콘솔에서 에러 확인
2. `/api/admin/affiliate/my-messages?unreadOnly=true` API 직접 호출 테스트
3. `unreadCount` 값이 정확히 반환되는지 확인

### 읽음 처리가 안 되는 경우

1. `/api/admin/affiliate/my-messages` POST API 직접 호출 테스트
2. 데이터베이스에서 `UserMessageRead` 레코드가 생성되는지 확인
   ```sql
   SELECT * FROM "UserMessageRead"
   WHERE "messageId" = [메시지ID]
   AND "userId" = [사용자ID];
   ```

---

## 📊 시뮬레이션 테스트 시나리오

### 시나리오 1: 기본 연동 테스트
1. 관리자 → 판매원 1명에게 메시지 발송
2. 판매원 대시보드 접속 → 메시지 확인
3. 읽음 처리 → 배지 업데이트 확인
4. 관리자 페이지에서 읽음 상태 확인

### 시나리오 2: 대량 발송 테스트
1. 관리자 → 판매원 10명, 대리점장 3명에게 동시 발송
2. 각 판매원/대리점장 대시보드에서 메시지 확인
3. 모든 사용자가 메시지를 받았는지 확인

### 시나리오 3: 실시간 갱신 테스트
1. 판매원 대시보드 열어두기
2. 관리자에서 새 메시지 발송
3. 5분 이내 자동 갱신되는지 확인
4. 또는 새로고침 후 배지 업데이트 확인

### 시나리오 4: 삭제 연동 테스트
1. 관리자에서 메시지 발송
2. 판매원/대리점장 대시보드에서 메시지 확인
3. 관리자에서 메시지 삭제
4. 판매원/대리점장 대시보드에서 메시지가 사라지는지 확인

---

## 🎯 예상 결과

### 정상 작동 시
- ✅ 관리자에서 메시지 발송 즉시 판매원/대리점장 대시보드에 배지 표시
- ✅ 메시지 모달에서 메시지 내용 정확히 표시
- ✅ 읽음 처리 즉시 반영
- ✅ 삭제 시 즉시 사라짐
- ✅ 자동 갱신 정상 작동

### 개선 사항
- ✅ 빠른 메뉴로 접근성 향상
- ✅ 실시간 알림으로 즉시 확인 가능
- ✅ 읽음 상태 자동 동기화
- ✅ 직관적인 UI/UX

---

이제 실제로 테스트해보시고 문제가 있으면 알려주세요!

