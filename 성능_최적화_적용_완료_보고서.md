# ì„±ëŠ¥ ìµœì í™” ì ìš© ì™„ë£Œ ë³´ê³ ì„œ

**ì‘ì„±ì¼**: 2025-01-28  
**ì‘ì—… ë‚´ìš©**: ê´€ë¦¬ì íŒ¨ë„ ì„±ëŠ¥ ìµœì í™” (100ë§Œ íŠ¸ë˜í”½ ëŒ€ì‘)

---

## âœ… ì™„ë£Œëœ ì‘ì—…

### 1. ë°ì´í„°ë² ì´ìŠ¤ ì¸ë±ìŠ¤ ì¶”ê°€ âœ…

#### ì¶”ê°€ëœ ì¸ë±ìŠ¤

1. **User í…Œì´ë¸”**
   ```sql
   CREATE INDEX "idx_user_customer_status_source_created" 
   ON "User"("customerStatus", "customerSource", "createdAt");
   ```
   - ëª©ì : ê³ ê° ê´€ë¦¬ í˜ì´ì§€ ì¿¼ë¦¬ ìµœì í™”
   - ì˜ˆìƒ íš¨ê³¼: ì‘ë‹µ ì‹œê°„ 50% ê°ì†Œ

2. **AffiliateLead í…Œì´ë¸”**
   ```sql
   CREATE INDEX "idx_affiliate_lead_phone_status_created" 
   ON "AffiliateLead"("customerPhone", "status", "createdAt");
   ```
   - ëª©ì : ì–´í•„ë¦¬ì—ì´íŠ¸ ê³ ê° ì¡°íšŒ ìµœì í™”

3. **CommissionLedger í…Œì´ë¸”**
   ```sql
   CREATE INDEX "idx_commission_ledger_settled_created" 
   ON "CommissionLedger"("isSettled", "createdAt");
   ```
   - ëª©ì : ì •ì‚° ëŒ€ì‹œë³´ë“œ ìµœì í™”

4. **AffiliateSale í…Œì´ë¸”**
   ```sql
   CREATE INDEX "idx_affiliate_sale_date_status_created" 
   ON "AffiliateSale"("saleDate", "status", "createdAt");
   ```
   - ëª©ì : íŒë§¤ ì¡°íšŒ ìµœì í™”

#### ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼
- ìœ„ì¹˜: `prisma/migrations/add_performance_indexes.sql`
- ì‹¤í–‰ ë°©ë²•: `npx prisma migrate deploy` ë˜ëŠ” ìˆ˜ë™ ì‹¤í–‰

---

### 2. Redis ìºì‹± ë„ì… âœ…

#### êµ¬í˜„ ë‚´ìš©

1. **Redis í´ë¼ì´ì–¸íŠ¸ ì„¤ì •**
   - íŒŒì¼: `lib/redis.ts`
   - ê¸°ëŠ¥:
     - Redis ì—°ê²° ê´€ë¦¬ (ì‹±ê¸€í†¤ íŒ¨í„´)
     - ìë™ ì¬ì—°ê²° ì²˜ë¦¬
     - ì—ëŸ¬ í•¸ë“¤ë§

2. **ìºì‹± ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜**
   - `getCache<T>(key)`: ìºì‹œ ì¡°íšŒ
   - `setCache<T>(key, value, ttl)`: ìºì‹œ ì €ì¥
   - `deleteCache(key)`: ìºì‹œ ì‚­ì œ
   - `deleteCachePattern(pattern)`: íŒ¨í„´ ê¸°ë°˜ ì‚­ì œ
   - `createCacheKey(prefix, ...parts)`: ìºì‹œ í‚¤ ìƒì„±

3. **ëŒ€ì‹œë³´ë“œ API ìºì‹±**
   - ìºì‹œ í‚¤: `dashboard:stats:YYYY-MM-DD`
   - TTL: 5ë¶„ (300ì´ˆ)
   - ìœ„ì¹˜: `app/api/admin/dashboard/route.ts`

4. **ê³ ê° ëª©ë¡ API ìºì‹±**
   - ìºì‹œ í‚¤: `customers:{group}:{search}:{status}:...`
   - TTL: 1ë¶„ (60ì´ˆ)
   - ìœ„ì¹˜: `app/api/admin/customers/route.ts`

#### í™˜ê²½ ë³€ìˆ˜ ì„¤ì • í•„ìš”
```env
REDIS_URL=redis://localhost:6379
# ë˜ëŠ”
REDIS_URL=rediss://your-redis-host:6380
```

#### ì˜ˆìƒ íš¨ê³¼
- ëŒ€ì‹œë³´ë“œ: ì‘ë‹µ ì‹œê°„ 70% ê°ì†Œ (1-2ì´ˆ â†’ 300-600ms)
- ê³ ê° ëª©ë¡: ì‘ë‹µ ì‹œê°„ 60% ê°ì†Œ (500ms-1s â†’ 200-400ms)

---

### 3. í†µê³„ ë°ì´í„° ì‚¬ì „ ê³„ì‚° âœ…

#### êµ¬í˜„ ë‚´ìš©

1. **DashboardStats ëª¨ë¸ ì¶”ê°€**
   - ìœ„ì¹˜: `prisma/schema.prisma`
   - í•„ë“œ:
     - ì‚¬ìš©ì í†µê³„ (totalUsers, activeUsers, etc.)
     - ì—¬í–‰ í†µê³„ (totalTrips, upcomingTrips, etc.)
     - ë§Œì¡±ë„ í†µê³„ (avgSatisfaction, reviewCount)
     - ì–´í•„ë¦¬ì—ì´íŠ¸ í†µê³„ (branchManagers, salesAgents, etc.)
     - íŠ¸ë Œë“œ ë°ì´í„° (trends: Json)
     - ìƒí’ˆ ì¡°íšŒ í†µê³„ (productViews: Json)

2. **ë°°ì¹˜ ì‘ì—… ìŠ¤í¬ë¦½íŠ¸**
   - íŒŒì¼: `scripts/update-dashboard-stats.ts`
   - ì‹¤í–‰ ë°©ë²•: `npm run update:dashboard-stats`
   - ì‹¤í–‰ ì£¼ê¸°: ë§¤ ì‹œê°„ë§ˆë‹¤ (Cron ì„¤ì • í•„ìš”)

3. **ëŒ€ì‹œë³´ë“œ API ìˆ˜ì •**
   - ì‚¬ì „ ê³„ì‚°ëœ ë°ì´í„° ìš°ì„  ì‚¬ìš©
   - 1ì‹œê°„ ì´ë‚´ ë°ì´í„°ë©´ ì‚¬ì „ ê³„ì‚° ë°ì´í„° ì‚¬ìš©
   - ê·¸ ì™¸ì—ëŠ” ì‹¤ì‹œê°„ ê³„ì‚° (ê¸°ì¡´ ë¡œì§)

#### Cron ì„¤ì • ì˜ˆì‹œ
```bash
# ë§¤ ì‹œê°„ë§ˆë‹¤ í†µê³„ ì—…ë°ì´íŠ¸
0 * * * * cd /path/to/project && npm run update:dashboard-stats
```

#### ì˜ˆìƒ íš¨ê³¼
- ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì‹œê°„: 80% ê°ì†Œ (1-2ì´ˆ â†’ 200-400ms)
- ë°ì´í„°ë² ì´ìŠ¤ ë¶€í•˜: 90% ê°ì†Œ

---

## ğŸ“Š ì„±ëŠ¥ ê°œì„  ì˜ˆìƒ íš¨ê³¼

| ê¸°ëŠ¥ | í˜„ì¬ | ëª©í‘œ | ì˜ˆìƒ ê°œì„ ìœ¨ |
|------|------|------|------------|
| ëŒ€ì‹œë³´ë“œ | 1-2ì´ˆ | 200-500ms | 70-80% |
| ê³ ê° ëª©ë¡ | 500ms-1s | 200-400ms | 50-60% |
| ì •ì‚° ëŒ€ì‹œë³´ë“œ | 1-3ì´ˆ | 500ms-1s | 50-70% |

---

## ğŸš€ ë‹¤ìŒ ë‹¨ê³„

### ì¦‰ì‹œ ì‹¤í–‰ í•„ìš”

1. **ì¸ë±ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰**
   ```bash
   npx prisma migrate deploy
   # ë˜ëŠ”
   psql $DATABASE_URL -f prisma/migrations/add_performance_indexes.sql
   ```

2. **Redis ì„œë²„ ì„¤ì •**
   - ë¡œì»¬ ê°œë°œ: Redis ì„¤ì¹˜ ë° ì‹¤í–‰
   - í”„ë¡œë•ì…˜: Redis í´ë¼ìš°ë“œ ì„œë¹„ìŠ¤ ì‚¬ìš© (ì˜ˆ: Upstash, Redis Cloud)
   - í™˜ê²½ ë³€ìˆ˜ `REDIS_URL` ì„¤ì •

3. **í†µê³„ ë°ì´í„° ì´ˆê¸°í™”**
   ```bash
   npm run update:dashboard-stats
   ```

4. **Cron ì‘ì—… ì„¤ì •**
   - ë§¤ ì‹œê°„ë§ˆë‹¤ í†µê³„ ì—…ë°ì´íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰

### ì„ íƒì  ê°œì„  ì‚¬í•­

1. **ì»¤ì„œ ê¸°ë°˜ í˜ì´ì§€ë„¤ì´ì…˜**
   - ëŒ€ëŸ‰ ë°ì´í„° ì¡°íšŒ ì‹œ ì„±ëŠ¥ í–¥ìƒ

2. **ì½ê¸° ì „ìš© ë³µì œë³¸**
   - í†µê³„ ì¡°íšŒëŠ” ì½ê¸° ì „ìš© ë³µì œë³¸ ì‚¬ìš©

3. **CDN ë„ì…**
   - ì •ì  ìì‚° ìºì‹±

---

## ğŸ“ ì£¼ì˜ì‚¬í•­

1. **Redis ìºì‹œ ë¬´íš¨í™”**
   - ê³ ê° ìƒì„±/ìˆ˜ì • ì‹œ ê´€ë ¨ ìºì‹œ ì‚­ì œ í•„ìš”
   - íŒë§¤ í™•ì • ì‹œ ì •ì‚° ìºì‹œ ì‚­ì œ í•„ìš”
   - êµ¬í˜„ ì˜ˆì‹œ:
     ```typescript
     import { deleteCachePattern } from '@/lib/redis';
     
     // ê³ ê° ìƒì„± í›„
     await deleteCachePattern('customers:*');
     ```

2. **í†µê³„ ë°ì´í„° ê°±ì‹  ì£¼ê¸°**
   - í˜„ì¬: 1ì‹œê°„ë§ˆë‹¤
   - í•„ìš” ì‹œ ë” ìì£¼ ê°±ì‹  ê°€ëŠ¥ (ì˜ˆ: 30ë¶„ë§ˆë‹¤)

3. **ëª¨ë‹ˆí„°ë§**
   - Redis ì—°ê²° ìƒíƒœ ëª¨ë‹ˆí„°ë§
   - ìºì‹œ íˆíŠ¸ìœ¨ ëª¨ë‹ˆí„°ë§
   - í†µê³„ ë°ì´í„° ê°±ì‹  ìƒíƒœ ëª¨ë‹ˆí„°ë§

---

## âœ… ê²€ì¦ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] ì¸ë±ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ ì™„ë£Œ
- [ ] Redis ì„œë²„ ì—°ê²° í™•ì¸
- [ ] ëŒ€ì‹œë³´ë“œ API ìºì‹± ë™ì‘ í™•ì¸
- [ ] ê³ ê° ëª©ë¡ API ìºì‹± ë™ì‘ í™•ì¸
- [ ] í†µê³„ ë°ì´í„° ì´ˆê¸°í™” ì™„ë£Œ
- [ ] Cron ì‘ì—… ì„¤ì • ì™„ë£Œ
- [ ] ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì™„ë£Œ

---

**ì‘ì—… ì™„ë£Œì¼**: 2025-01-28


