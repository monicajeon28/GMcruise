# 🔍 프로젝트 문제 15가지 정리

> **작성일**: 2025년 1월 28일  
> **목적**: 배포 전 및 개선을 위한 문제점 종합 정리

---

## 🔴 긴급 수정 필요 (Critical) - 5가지

### 1. TypeScript 린터 에러 15개 ⚠️⚠️⚠️

**상태**: 빌드 가능하나 타입 안정성 문제

**발견된 에러**:

1. **`app/api/passport/[token]/upload/route.ts:106`**
   - `publicUrl` 변수 미정의
   - 파일 업로드 후 URL 반환 실패 가능

2. **`app/api/customer/passport-upload/route.ts:182,185`**
   - `join`, `existsSync` import 누락
   - 파일 시스템 접근 실패 가능

3. **`app/partner/[partnerId]/customers/PartnerCustomersClient.tsx:5250`**
   - `loadCustomers` 함수 미정의
   - 고객 목록 새로고침 실패

4. **`app/api/admin/customers/route.ts:882,884,1021`**
   - `CustomerGroup` 타입과 문자열 비교 불일치
   - 필터링 로직 오작동 가능

5. **`components/admin/CustomerTable.tsx:752`**
   - `Customer` 타입에 `testModeStartedAt` 속성 없음
   - 테스트 모드 표시 실패

6. **`app/api/admin/payslips/[id]/pdf/route.ts:78`**
   - `Buffer` 타입을 `BodyInit`에 할당 불가
   - PDF 생성 실패 가능

7. **`app/admin/mall/visual-editor/page.tsx:2737,3235,3236,3244,3245,5784`**
   - 타입 불일치 다수
   - 랜딩 페이지 편집기 오작동 가능

**수정 필요**: 즉시 타입 에러 수정  
**예상 작업 시간**: 2-3시간

---

### 2. Phase 3 Task 3-3 미완료 (배로 돌아가기 시스템) ⚠️⚠️

**문제점**:
- 채팅 화면에 카운트다운 타이머 미구현
- GPS 기반 경로 안내 기능 미구현
- Phase 4 시작 전 완료 필요

**위치**:
- `app/chat/page.tsx` 또는 관련 컴포넌트

**영향**:
- 사용자가 배로 돌아가는 시간을 실시간으로 확인 불가
- GPS 기반 경로 안내 미제공

**수정 필요**: 카운트다운 타이머 및 GPS 경로 안내 구현  
**예상 작업 시간**: 6-8시간

---

### 3. RAG 시스템 성능 문제 (임베딩 API 과다 호출) ⚠️⚠️⚠️

**문제점**:
- `lib/ai/ragSearch.ts`에서 각 문서마다 Google Embedding API 호출
- 문서 100개 = API 호출 100번
- **매 채팅마다** 실행되어 비용 급증

**영향**:
- API 비용 급증 (예: 문서 1000개, 검색 10000회 = $1000/월)
- 응답 시간 지연 (100개 문서 = 수십 초)
- 서버 리소스 과다 사용

**해결 방안**:
1. 임베딩을 DB에 저장 (KnowledgeBase 모델에 `embedding` 필드 추가)
2. 문서 생성/수정 시 한 번만 임베딩 생성
3. 검색 시에는 저장된 임베딩 사용

**예상 작업 시간**: 4-6시간  
**비용 절감 효과**: 99% 이상

---

### 4. N+1 쿼리 문제 (3곳) ⚠️⚠️

**문제점 1**: `lib/scheduler/scheduledMessageSender.ts`
- 각 사용자마다 `findFirst`로 중복 확인
- 사용자 1000명 = 쿼리 1000번
- 매 5분마다 실행

**문제점 2**: `app/api/admin/customer-groups/excel-upload/route.ts`
- 각 행마다 `findFirst`와 `create` 호출
- 1000개 행 = 쿼리 2000번
- 타임아웃 위험

**해결 방안**:
- 배치 조회로 변경 (`findMany` + `in` 연산자)
- 트랜잭션 사용

**예상 작업 시간**: 3-5시간

---

### 5. 디버그 로그 정리 필요 ⚠️

**문제점**:
- **2,362개의 console.log/warn/error/debug** 발견
- 프로덕션 환경에서 불필요한 로그 출력
- 성능 저하 및 보안 위험 가능성

**위치**:
- `app/` 디렉토리 전체 (433개 파일)
- 특히 많은 파일:
  - `app/api/public/products/route.ts` - 20+개
  - `app/api/auth/login/route.ts` - 테스트 모드 디버깅 로그
  - `app/admin/` 전체

**수정 방법**:
```typescript
// ❌ 현재
console.log('[DEBUG]', data);

// ✅ 수정 후
if (process.env.NODE_ENV === 'development') {
  console.log('[DEBUG]', data);
}
```

**예상 작업 시간**: 4-6시간

---

## 🟡 중요 수정 필요 (Important) - 5가지

### 6. 결제 시스템 미완성 ⚠️

**문제점**:
- 결제 페이지에 TODO 주석 존재
- 웰컴페이먼츠 연동 미완성

**위치**:
- `app/payment/page.tsx` (84번째 줄)
```typescript
// TODO: 웰컴페이먼츠 결제 페이지 URL로 리다이렉트
```

**현재 상태**:
- 결제 요청 API는 존재 (`/api/payment/request`)
- 결제 콜백 API는 존재 (`/api/payment/callback`)
- 웰컴페이먼츠 연동 로직 미완성

**수정 필요**: 웰컴페이먼츠 API 연동 완료  
**예상 작업 시간**: 8-12시간  
**우선순위**: 결제 기능 사용 시 필수

---

### 7. 가계부/체크리스트 DB 마이그레이션 미완성

**문제점**:
- API는 완성되었으나 클라이언트가 **localStorage 사용 중**
- 서버 DB와 동기화 안 됨
- 디바이스 간 데이터 공유 불가
- AI Tool Calling 불가

**영향**:
- "택시비 30달러 썼어" → AI가 가계부에 자동 기록 불가
- 다른 기기에서 데이터 확인 불가
- 데이터 손실 위험 (브라우저 캐시 삭제 시)

**위치**:
- `app/wallet/page.tsx` - localStorage 사용
- `app/checklist/page.tsx` - localStorage 사용

**수정 필요**: localStorage → API 호출로 변경  
**예상 작업 시간**: 6-8시간

---

### 8. AI 채팅 스트리밍 응답 미구현

**문제점**:
- 전체 응답을 기다린 후 한 번에 표시
- 응답 대기 시간 길어짐
- 부자연스러운 사용자 경험

**현재 상태**:
- API: `/api/chat` - 스트리밍 미구현
- API: `/api/chat/stream` - 존재하나 미사용 가능

**수정 필요**: Vercel AI SDK의 `streamText` 활용  
**예상 작업 시간**: 4-6시간

---

### 9. RAG 시스템 미활용

**문제점**:
- KnowledgeBase 모델은 있으나 실제 검색 안 함
- 크루즈 전문 지식 부족
- AI 응답 정확도 저하 가능성

**현재 상태**:
- DB 모델: `KnowledgeBase` ✅
- 벡터 검색: ❌ 미구현
- AI 연동: ❌ 미구현

**수정 필요**:
- Supabase Vector 또는 Pinecone 연동
- 질문 → 벡터 검색 → 관련 지식 → AI 응답

**예상 작업 시간**: 10-15시간

---

### 10. AI Tool Calling 미구현

**문제점**:
- API는 준비됐으나 AI가 호출 안 함
- "택시비 30달러 썼어" → 가계부 자동 기록 안 됨
- AI 에이전트 기능 부재

**현재 상태**:
- Expense API: ✅ 준비됨
- ChecklistItem API: ✅ 준비됨
- Gemini Function Calling: ❌ 미구현

**수정 필요**: Gemini Function Calling 설정  
**예상 작업 시간**: 8-12시간

---

## 🟢 개선 권장 (Nice to Have) - 5가지

### 11. Prisma 관계 이름 불일치

**문제점**:
- `approve-commission` API와 `syncSaleCommissionLedgers` 함수에서 `manager`, `agent`, `product` 사용
- Prisma 스키마의 실제 관계 이름과 다를 수 있음

**확인 필요**:
- Prisma가 자동으로 별칭을 생성하는지 확인
- 실제 작동하는지 테스트 필요

**예상 작업 시간**: 1-2시간

---

### 12. `currency` 필드 없음

**문제점**:
- `syncSaleCommissionLedgers` 함수에서 `sale.currency` 사용
- `AffiliateSale` 모델에 `currency` 필드가 없음
- 런타임 에러 발생 가능

**해결 방안**:
- `DEFAULT_CURRENCY` 사용 또는 `AffiliateProduct`에서 가져오기
- `affiliateSale.update`에서 `currency` 필드 제거

**예상 작업 시간**: 1시간

---

### 13. 오류 메시지 사용자 친화적 개선 필요

**문제점**:
- 기술적인 에러 메시지 사용 (`alert()`, `console.error`)
- 예: "Failed to load resource: the server responded with a status of 500"
- 예: "브라우저가 GPS를 지원하지 않습니다"

**개선 방안**:
```typescript
// ❌ 현재
alert('브라우저가 GPS를 지원하지 않습니다');

// ✅ 개선
alert('위치 정보를 사용할 수 없습니다. 직접 지도 앱을 사용해 주세요.');
```

**영향 범위**:
- `/components/ReturnToShipBanner.tsx` (GPS 관련)
- `/app/login/page.tsx` (로그인 실패)
- `/app/translator/page.tsx` (음성 인식 오류)
- 모든 `alert()` 사용 부분

**예상 작업 시간**: 2-3시간

---

### 14. 글씨 크기 개선 필요 (50대 이상 사용자)

**문제점**:
- 일부 `text-xs` 사용 (50대 이상 가독성 저하)
- 날씨 정보의 위치명, 시간 등 작은 텍스트

**개선 필요 위치**:
```typescript
// ❌ 현재 (DailyBriefingCard.tsx)
<p className="text-gray-500 text-xs text-center">📍 {w.location}</p>

// ✅ 개선
<p className="text-gray-500 text-sm text-center">📍 {w.location}</p>
```

**예상 작업 시간**: 1시간

---

### 15. localStorage 에러 처리 개선 필요

**문제점**:
- localStorage 저장 실패 시 에러 처리 없음
- 용량 초과 시 데이터 손실 가능

**개선 방안**:
```typescript
function safeLocalStorageSet(key: string, value: string): boolean {
  try {
    localStorage.setItem(key, value);
    return true;
  } catch (error) {
    if (error instanceof DOMException && error.code === 22) {
      // QUOTA_EXCEEDED_ERR - 저장 공간 부족
      console.warn('[localStorage] 저장 공간 부족');
      return false;
    }
    return false;
  }
}
```

**영향 범위**:
- 체크리스트 (`/app/checklist/page.tsx`)
- 여행 가계부 (`/app/wallet/components/ExpenseTracker.tsx`)
- 지도 페이지 (`/app/map/page.tsx`)

**예상 작업 시간**: 2시간

---

## 📊 우선순위별 수정 계획

### Phase 1: 긴급 수정 (1-2일) - 배포 전 필수

1. ✅ **TypeScript 린터 에러 수정** (2-3시간)
2. ✅ **디버그 로그 정리** (4-6시간)
3. ✅ **RAG 시스템 성능 문제 해결** (4-6시간)
4. ✅ **N+1 쿼리 문제 해결** (3-5시간)

**총 예상 시간**: 13-20시간

---

### Phase 2: 중요 수정 (2-3일) - 기능 개선

5. ✅ **Phase 3 Task 3-3 완료** (6-8시간)
6. ✅ **가계부/체크리스트 DB 마이그레이션** (6-8시간)
7. ✅ **AI 채팅 스트리밍 응답** (4-6시간)
8. ✅ **AI Tool Calling 구현** (8-12시간)
9. ✅ **Prisma 관계 이름 및 currency 필드 수정** (2-3시간)

**총 예상 시간**: 26-37시간

---

### Phase 3: 개선 (선택사항) - 사용자 경험 향상

10. ✅ **결제 시스템 완성** (8-12시간) - 결제 기능 사용 시
11. ✅ **RAG 시스템 연동** (10-15시간)
12. ✅ **오류 메시지 개선** (2-3시간)
13. ✅ **글씨 크기 개선** (1시간)
14. ✅ **localStorage 에러 처리** (2시간)

**총 예상 시간**: 23-33시간

---

## 📋 체크리스트

### 긴급 (배포 전 필수)
- [ ] TypeScript 린터 에러 15개 수정
- [ ] 디버그 로그 정리 (프로덕션 환경)
- [ ] RAG 시스템 임베딩 DB 저장
- [ ] N+1 쿼리 문제 해결 (3곳)

### 중요 (기능 개선)
- [ ] Phase 3 Task 3-3 완료 (배로 돌아가기 시스템)
- [ ] 가계부/체크리스트 DB 마이그레이션
- [ ] AI 채팅 스트리밍 응답 구현
- [ ] AI Tool Calling 구현
- [ ] Prisma 관계 이름 및 currency 필드 수정

### 개선 (선택사항)
- [ ] 결제 시스템 완성 (결제 기능 사용 시)
- [ ] RAG 시스템 연동
- [ ] 오류 메시지 사용자 친화적 개선
- [ ] 글씨 크기 개선 (50대 이상)
- [ ] localStorage 에러 처리 개선

---

## 💰 비용 영향 분석

### 현재 예상 비용 (월간)
- Gemini API: 채팅 수 × $0.001
- **Embedding API: 문서 수 × 검색 수 × $0.0001** ⚠️ 매우 높음
  - 예: 문서 100개, 검색 1000회 = $10/월
  - 예: 문서 1000개, 검색 10000회 = $1000/월

### 수정 후 예상 비용
- Embedding API: 문서 생성/수정 시만 호출
  - 예: 문서 100개 생성 = $0.01 (한 번만)
  - 검색은 무료 (DB에서 조회)

**절감 효과**: 99% 이상 비용 절감 가능

---

## 🎯 배포 가능 상태

### 현재 상태로도 배포 가능 ✅
- 핵심 기능 모두 작동
- 사용자 기능 100% 완성
- 관리자 기능 92.5% 완성

### 배포 전 권장 수정
1. **TypeScript 린터 에러 수정** (필수)
2. **디버그 로그 정리** (필수)
3. **RAG 시스템 성능 문제 해결** (비용 절감)
4. **N+1 쿼리 문제 해결** (성능 향상)

### 배포 후 개선 계획
1. Phase 3 Task 3-3 완료
2. 가계부/체크리스트 DB 마이그레이션
3. AI 기능 개선 (스트리밍, RAG, Tool Calling)
4. 사용자 경험 개선

---

**작성일**: 2025년 1월 28일  
**버전**: 1.0  
**다음 업데이트**: 수정 완료 후

