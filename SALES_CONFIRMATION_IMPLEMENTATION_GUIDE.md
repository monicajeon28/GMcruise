# ğŸ¯ íŒë§¤ í™•ì • í”„ë¡œì„¸ìŠ¤ êµ¬í˜„ ê°€ì´ë“œ

> **ì‘ì„±ì¼**: 2025-01-28  
> **ëª©ì **: íŒë§¤ì›/ëŒ€ë¦¬ì ì¥ì´ ë…¹ìŒ íŒŒì¼ì„ ì²¨ë¶€í•˜ì—¬ íŒë§¤ í™•ì • ìš”ì²­í•˜ê³ , ê´€ë¦¬ìê°€ ìŠ¹ì¸í•˜ëŠ” ì‹œìŠ¤í…œ êµ¬í˜„  
> **ë‚œì´ë„**: ì´ˆë³´ìë„ ë”°ë¼í•  ìˆ˜ ìˆë„ë¡ ì‰½ê²Œ ì„¤ëª…

---

## ğŸ“‹ ëª©ì°¨

1. [ì „ì²´ í”„ë¡œì„¸ìŠ¤ ì´í•´í•˜ê¸°](#1-ì „ì²´-í”„ë¡œì„¸ìŠ¤-ì´í•´í•˜ê¸°)
2. [1ë‹¨ê³„: ë°ì´í„°ë² ì´ìŠ¤ ìˆ˜ì •](#2-1ë‹¨ê³„-ë°ì´í„°ë² ì´ìŠ¤-ìˆ˜ì •)
3. [2ë‹¨ê³„: Google Drive ì—…ë¡œë“œ í•¨ìˆ˜ ë§Œë“¤ê¸°](#3-2ë‹¨ê³„-google-drive-ì—…ë¡œë“œ-í•¨ìˆ˜-ë§Œë“¤ê¸°)
4. [3ë‹¨ê³„: íŒë§¤ í™•ì • ìš”ì²­ API ë§Œë“¤ê¸°](#4-3ë‹¨ê³„-íŒë§¤-í™•ì •-ìš”ì²­-api-ë§Œë“¤ê¸°)
5. [4ë‹¨ê³„: ê´€ë¦¬ì ìŠ¹ì¸/ê±°ë¶€ API ë§Œë“¤ê¸°](#5-4ë‹¨ê³„-ê´€ë¦¬ì-ìŠ¹ì¸ê±°ë¶€-api-ë§Œë“¤ê¸°)
6. [5ë‹¨ê³„: UI ë§Œë“¤ê¸°](#6-5ë‹¨ê³„-ui-ë§Œë“¤ê¸°)
7. [6ë‹¨ê³„: ì•Œë¦¼ ê¸°ëŠ¥ ì¶”ê°€](#7-6ë‹¨ê³„-ì•Œë¦¼-ê¸°ëŠ¥-ì¶”ê°€)
8. [í…ŒìŠ¤íŠ¸ ë°©ë²•](#8-í…ŒìŠ¤íŠ¸-ë°©ë²•)

---

## 1. ì „ì²´ í”„ë¡œì„¸ìŠ¤ ì´í•´í•˜ê¸°

### ğŸ¬ ì‹œë‚˜ë¦¬ì˜¤

**ìƒí™©**: íŒë§¤ì› ê¹€ì² ìˆ˜ê°€ ê³ ê°ê³¼ í†µí™”ë¥¼ í–ˆê³ , ê³ ê°ì´ êµ¬ë§¤ë¥¼ ê²°ì •í–ˆìŠµë‹ˆë‹¤.

**ê³¼ì •**:
1. ê¹€ì² ìˆ˜ê°€ í†µí™” ë…¹ìŒ íŒŒì¼ì„ ì¤€ë¹„í•©ë‹ˆë‹¤
2. íŒë§¤ í™•ì • ìš”ì²­ í˜ì´ì§€ì—ì„œ ë…¹ìŒ íŒŒì¼ì„ ì—…ë¡œë“œí•©ë‹ˆë‹¤
3. ì‹œìŠ¤í…œì´ Google Driveì— íŒŒì¼ì„ ì €ì¥í•©ë‹ˆë‹¤
4. ê´€ë¦¬ìì—ê²Œ "ìŠ¹ì¸ ëŒ€ê¸°" ì•Œë¦¼ì´ ê°‘ë‹ˆë‹¤
5. ê´€ë¦¬ìê°€ Google Drive ë§í¬ë¥¼ í´ë¦­í•´ì„œ ë…¹ìŒì„ í™•ì¸í•©ë‹ˆë‹¤
6. ê´€ë¦¬ìê°€ ìŠ¹ì¸í•˜ë©´ ìë™ìœ¼ë¡œ ìˆ˜ë‹¹ì´ ê³„ì‚°ë©ë‹ˆë‹¤
7. ê¹€ì² ìˆ˜ì—ê²Œ "ìŠ¹ì¸ ì™„ë£Œ" ì•Œë¦¼ì´ ê°‘ë‹ˆë‹¤

### ğŸ“Š ìƒíƒœ íë¦„ë„

```
PENDING (ì´ˆê¸° ìƒíƒœ)
    â†“
[íŒë§¤ì›/ëŒ€ë¦¬ì ì¥ì´ ìš”ì²­ ì œì¶œ]
    â†“
PENDING_APPROVAL (ìŠ¹ì¸ ëŒ€ê¸°)
    â†“
[ê´€ë¦¬ìê°€ í™•ì¸ í›„]
    â”œâ”€â†’ APPROVED (ìŠ¹ì¸) â†’ ìˆ˜ë‹¹ ìë™ ê³„ì‚° âœ…
    â””â”€â†’ REJECTED (ê±°ë¶€) â†’ ìˆ˜ì • ê°€ëŠ¥ ğŸ”„
```

---

## 2. 1ë‹¨ê³„: ë°ì´í„°ë² ì´ìŠ¤ ìˆ˜ì •

### ğŸ“ ì„¤ëª…
ë°ì´í„°ë² ì´ìŠ¤ì— "ë…¹ìŒ íŒŒì¼ ì •ë³´"ì™€ "ìŠ¹ì¸ ì •ë³´"ë¥¼ ì €ì¥í•  ê³µê°„ì„ ë§Œë“¤ì–´ì•¼ í•©ë‹ˆë‹¤.

### ğŸ”§ ì‘ì—… ë‚´ìš©

**íŒŒì¼**: `prisma/schema.prisma`

**AffiliateSale ëª¨ë¸ì— ì¶”ê°€í•  í•„ë“œë“¤**:

```prisma
model AffiliateSale {
  // ... ê¸°ì¡´ í•„ë“œë“¤ ...
  
  // ğŸ†• ì¶”ê°€í•  í•„ë“œë“¤
  audioFileGoogleDriveId String?        // Google Drive íŒŒì¼ ID
  audioFileGoogleDriveUrl String?       // Google Drive ê³µìœ  ë§í¬
  audioFileName String?                 // ì›ë³¸ íŒŒì¼ëª…
  submittedById Int?                    // ìš”ì²­ ì œì¶œì ID (íŒë§¤ì›/ëŒ€ë¦¬ì ì¥)
  submittedAt DateTime?                 // ìš”ì²­ ì œì¶œ ì‹œê°„
  approvedById Int?                     // ìŠ¹ì¸í•œ ê´€ë¦¬ì ID
  approvedAt DateTime?                  // ìŠ¹ì¸ ì‹œê°„
  rejectedById Int?                     // ê±°ë¶€í•œ ê´€ë¦¬ì ID
  rejectedAt DateTime?                  // ê±°ë¶€ ì‹œê°„
  rejectionReason String?               // ê±°ë¶€ ì‚¬ìœ 
  
  // ... ê¸°ì¡´ í•„ë“œë“¤ ...
}
```

### ğŸ“Œ ì¤‘ìš” ì‚¬í•­
- `?` í‘œì‹œëŠ” "ì—†ì–´ë„ ë¨"ì„ ì˜ë¯¸í•©ë‹ˆë‹¤
- `String?`ì€ "í…ìŠ¤íŠ¸ ë˜ëŠ” ì—†ìŒ"
- `Int?`ëŠ” "ìˆ«ì ë˜ëŠ” ì—†ìŒ"
- `DateTime?`ì€ "ë‚ ì§œ/ì‹œê°„ ë˜ëŠ” ì—†ìŒ"

### âœ… ì‹¤í–‰ ë°©ë²•

1. **íŒŒì¼ ì—´ê¸°**: `prisma/schema.prisma` íŒŒì¼ì„ ì—½ë‹ˆë‹¤
2. **AffiliateSale ëª¨ë¸ ì°¾ê¸°**: `model AffiliateSale {` ë¶€ë¶„ì„ ì°¾ìŠµë‹ˆë‹¤
3. **í•„ë“œ ì¶”ê°€**: ìœ„ì˜ í•„ë“œë“¤ì„ ê¸°ì¡´ í•„ë“œë“¤ ì•„ë˜ì— ì¶”ê°€í•©ë‹ˆë‹¤
4. **ì €ì¥**: íŒŒì¼ì„ ì €ì¥í•©ë‹ˆë‹¤
5. **ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸**: í„°ë¯¸ë„ì—ì„œ ë‹¤ìŒ ëª…ë ¹ì–´ ì‹¤í–‰
   ```bash
   npx prisma db push
   ```

### âš ï¸ ì£¼ì˜ì‚¬í•­
- ê¸°ì¡´ ë°ì´í„°ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€ë©ë‹ˆë‹¤
- ìƒˆ í•„ë“œëŠ” ëª¨ë‘ "ì—†ìŒ" ìƒíƒœë¡œ ì‹œì‘í•©ë‹ˆë‹¤

---

## 3. 2ë‹¨ê³„: Google Drive ì—…ë¡œë“œ í•¨ìˆ˜ í™•ì¸í•˜ê¸°

### ğŸ“ ì„¤ëª…
ì´ë¯¸ Google Drive ì—…ë¡œë“œ í•¨ìˆ˜ê°€ ìˆìŠµë‹ˆë‹¤! (`lib/google-drive.ts`ì˜ `uploadFileToDrive` í•¨ìˆ˜)
ì´ í•¨ìˆ˜ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ë©´ ë©ë‹ˆë‹¤. ë…¹ìŒ íŒŒì¼ìš©ìœ¼ë¡œ ê°„ë‹¨íˆ ë˜í¼ í•¨ìˆ˜ë§Œ ë§Œë“¤ë©´ ë©ë‹ˆë‹¤.

### ğŸ”§ ì‘ì—… ë‚´ìš©

**íŒŒì¼**: `lib/google-drive.ts` (ì´ë¯¸ ìˆìŒ, í•¨ìˆ˜ ì¶”ê°€)

**ì¶”ê°€í•  í•¨ìˆ˜** (íŒŒì¼ ëì—):

```typescript
/**
 * ë…¹ìŒ íŒŒì¼ì„ Google Driveì— ì—…ë¡œë“œ (ê°„í¸ í•¨ìˆ˜)
 * @param fileBuffer íŒŒì¼ ë°ì´í„° (Buffer)
 * @param fileName íŒŒì¼ëª…
 * @param folderId Google Drive í´ë” ID (ì„ íƒì‚¬í•­, í™˜ê²½ ë³€ìˆ˜ì—ì„œ ê°€ì ¸ì˜´)
 * @returns Google Drive íŒŒì¼ ì •ë³´
 */
export async function uploadAudioFileToDrive(
  fileBuffer: Buffer,
  fileName: string,
  folderId?: string
): Promise<{ ok: boolean; fileId?: string; url?: string; error?: string }> {
  // í´ë” IDê°€ ì—†ìœ¼ë©´ í™˜ê²½ ë³€ìˆ˜ì—ì„œ ê°€ì ¸ì˜¤ê¸°
  const targetFolderId = folderId || process.env.GOOGLE_DRIVE_SALES_AUDIO_FOLDER_ID || 'root';
  
  // íŒŒì¼ í˜•ì‹ ìë™ ê°ì§€
  let mimeType = 'audio/mpeg'; // ê¸°ë³¸ê°’: MP3
  if (fileName.endsWith('.wav')) mimeType = 'audio/wav';
  else if (fileName.endsWith('.m4a')) mimeType = 'audio/m4a';
  else if (fileName.endsWith('.mp3')) mimeType = 'audio/mpeg';

  // ê¸°ì¡´ í•¨ìˆ˜ ì‚¬ìš©
  return await uploadFileToDrive({
    folderId: targetFolderId,
    fileName,
    mimeType,
    buffer: fileBuffer,
    makePublic: true, // ë§í¬ë¡œ ì ‘ê·¼ ê°€ëŠ¥í•˜ê²Œ
  });
}
```

### ğŸ“Œ ì„¤ëª…
- ê¸°ì¡´ `uploadFileToDrive` í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤
- ë…¹ìŒ íŒŒì¼ ì „ìš©ìœ¼ë¡œ ê°„ë‹¨í•˜ê²Œ ë§Œë“  í•¨ìˆ˜ì…ë‹ˆë‹¤
- íŒŒì¼ í˜•ì‹ì„ ìë™ìœ¼ë¡œ ê°ì§€í•©ë‹ˆë‹¤
- ê³µê°œ ë§í¬ë¥¼ ìë™ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤

### âœ… ì‹¤í–‰ ë°©ë²•
1. `lib/google-drive.ts` íŒŒì¼ì„ ì—½ë‹ˆë‹¤
2. íŒŒì¼ ë(ë§ˆì§€ë§‰ ì¤„)ì— ìœ„ í•¨ìˆ˜ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤
3. ì €ì¥í•©ë‹ˆë‹¤

---

## 4. 3ë‹¨ê³„: íŒë§¤ í™•ì • ìš”ì²­ API ë§Œë“¤ê¸°

### ğŸ“ ì„¤ëª…
íŒë§¤ì›/ëŒ€ë¦¬ì ì¥ì´ "íŒë§¤ í™•ì • ìš”ì²­"ì„ ì œì¶œí•˜ëŠ” APIë¥¼ ë§Œë“­ë‹ˆë‹¤.

### ğŸ”§ ì‘ì—… ë‚´ìš©

**ìƒˆ íŒŒì¼ ìƒì„±**: `app/api/affiliate/sales/[saleId]/submit-confirmation/route.ts`

**ì „ì²´ ì½”ë“œ**:

```typescript
// app/api/affiliate/sales/[saleId]/submit-confirmation/route.ts
// íŒë§¤ í™•ì • ìš”ì²­ ì œì¶œ API

import { NextRequest, NextResponse } from 'next/server';
import { cookies } from 'next/headers';
import prisma from '@/lib/prisma';
import { uploadAudioToGoogleDrive } from '@/lib/google/drive';

const SESSION_COOKIE = 'cg.sid.v2';

// ì„¸ì…˜ì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
async function getCurrentUser() {
  const sid = cookies().get(SESSION_COOKIE)?.value;
  if (!sid) return null;

  try {
    const session = await prisma.session.findUnique({
      where: { id: sid },
      include: {
        User: {
          select: { id: true, role: true },
        },
      },
    });

    if (!session || !session.User) return null;
    return session.User;
  } catch (error) {
    console.error('[Submit Confirmation] Session error:', error);
    return null;
  }
}

// íŒë§¤ì›/ëŒ€ë¦¬ì ì¥ ê¶Œí•œ í™•ì¸
async function checkAffiliateAuth(saleId: number, userId: number) {
  // íŒë§¤ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
  const sale = await prisma.affiliateSale.findUnique({
    where: { id: saleId },
    include: {
      agent: {
        select: { userId: true, type: true },
      },
      manager: {
        select: { userId: true, type: true },
      },
    },
  });

  if (!sale) {
    return { allowed: false, reason: 'íŒë§¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' };
  }

  // íŒë§¤ì›ì¸ ê²½ìš°: ë³¸ì¸ íŒë§¤ë§Œ ê°€ëŠ¥
  if (sale.agentId && sale.agent?.userId === userId) {
    return { allowed: true, profile: sale.agent };
  }

  // ëŒ€ë¦¬ì ì¥ì¸ ê²½ìš°: ë³¸ì¸ íŒë§¤ë§Œ ê°€ëŠ¥ (ì†Œì† íŒë§¤ì› íŒë§¤ëŠ” ë¶ˆê°€)
  if (sale.managerId && sale.manager?.userId === userId) {
    return { allowed: true, profile: sale.manager };
  }

  return { allowed: false, reason: 'ë³¸ì¸ì˜ íŒë§¤ë§Œ í™•ì • ìš”ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤' };
}

/**
 * POST: íŒë§¤ í™•ì • ìš”ì²­ ì œì¶œ
 */
export async function POST(
  req: NextRequest,
  { params }: { params: { saleId: string } }
) {
  try {
    // 1. ì‚¬ìš©ì í™•ì¸
    const user = await getCurrentUser();
    if (!user) {
      return NextResponse.json(
        { ok: false, error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' },
        { status: 401 }
      );
    }

    // 2. íŒë§¤ ID í™•ì¸
    const saleId = parseInt(params.saleId);
    if (isNaN(saleId)) {
      return NextResponse.json(
        { ok: false, error: 'ì˜¬ë°”ë¥¸ íŒë§¤ IDê°€ ì•„ë‹™ë‹ˆë‹¤' },
        { status: 400 }
      );
    }

    // 3. ê¶Œí•œ í™•ì¸ (ë³¸ì¸ íŒë§¤ë§Œ)
    const authCheck = await checkAffiliateAuth(saleId, user.id);
    if (!authCheck.allowed) {
      return NextResponse.json(
        { ok: false, error: authCheck.reason },
        { status: 403 }
      );
    }

    // 4. íŒë§¤ ìƒíƒœ í™•ì¸ (ì´ë¯¸ ìš”ì²­í–ˆê±°ë‚˜ ìŠ¹ì¸ëœ ê²½ìš° ë¶ˆê°€)
    const sale = await prisma.affiliateSale.findUnique({
      where: { id: saleId },
      select: { id: true, status: true },
    });

    if (!sale) {
      return NextResponse.json(
        { ok: false, error: 'íŒë§¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' },
        { status: 404 }
      );
    }

    if (sale.status === 'PENDING_APPROVAL') {
      return NextResponse.json(
        { ok: false, error: 'ì´ë¯¸ ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤' },
        { status: 400 }
      );
    }

    if (sale.status === 'APPROVED') {
      return NextResponse.json(
        { ok: false, error: 'ì´ë¯¸ ìŠ¹ì¸ëœ íŒë§¤ì…ë‹ˆë‹¤' },
        { status: 400 }
      );
    }

    // 5. íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
    const formData = await req.formData();
    const audioFile = formData.get('audioFile') as File | null;

    if (!audioFile) {
      return NextResponse.json(
        { ok: false, error: 'ë…¹ìŒ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”' },
        { status: 400 }
      );
    }

    // íŒŒì¼ í¬ê¸° í™•ì¸ (50MB ì œí•œ)
    const MAX_FILE_SIZE = 50 * 1024 * 1024; // 50MB
    if (audioFile.size > MAX_FILE_SIZE) {
      return NextResponse.json(
        { ok: false, error: 'íŒŒì¼ í¬ê¸°ëŠ” 50MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤' },
        { status: 400 }
      );
    }

    // íŒŒì¼ í˜•ì‹ í™•ì¸ (MP3, WAV, M4A)
    const allowedTypes = ['audio/mpeg', 'audio/mp3', 'audio/wav', 'audio/m4a', 'audio/x-m4a'];
    if (!allowedTypes.includes(audioFile.type)) {
      return NextResponse.json(
        { ok: false, error: 'ì§€ì›í•˜ëŠ” íŒŒì¼ í˜•ì‹: MP3, WAV, M4A' },
        { status: 400 }
      );
    }

    // 6. Google Driveì— ì—…ë¡œë“œ
    const fileBuffer = Buffer.from(await audioFile.arrayBuffer());
    const fileName = `sale_${saleId}_${Date.now()}_${audioFile.name}`;

    // Google Drive ì—…ë¡œë“œ (ê¸°ì¡´ í•¨ìˆ˜ ì‚¬ìš©)
    const { uploadAudioFileToDrive } = await import('@/lib/google-drive');
    const driveResult = await uploadAudioFileToDrive(fileBuffer, fileName);

    if (!driveResult.ok || !driveResult.fileId || !driveResult.url) {
      return NextResponse.json(
        { ok: false, error: driveResult.error || 'Google Drive ì—…ë¡œë“œ ì‹¤íŒ¨' },
        { status: 500 }
      );
    }

    // 7. ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸
    const updatedSale = await prisma.affiliateSale.update({
      where: { id: saleId },
      data: {
        status: 'PENDING_APPROVAL',
        audioFileGoogleDriveId: driveResult.fileId,
        audioFileGoogleDriveUrl: driveResult.url,
        audioFileName: audioFile.name,
        submittedById: user.id,
        submittedAt: new Date(),
      },
    });

    return NextResponse.json({
      ok: true,
      message: 'íŒë§¤ í™•ì • ìš”ì²­ì´ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤',
      sale: {
        id: updatedSale.id,
        status: updatedSale.status,
        audioFileUrl: updatedSale.audioFileGoogleDriveUrl,
      },
    });
  } catch (error: any) {
    console.error('[Submit Confirmation] Error:', error);
    return NextResponse.json(
      { ok: false, error: error.message || 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' },
      { status: 500 }
    );
  }
}
```

### ğŸ“Œ ì„¤ëª…
- ì´ APIëŠ” íŒë§¤ì›/ëŒ€ë¦¬ì ì¥ì´ ì‚¬ìš©í•©ë‹ˆë‹¤
- ë³¸ì¸ íŒë§¤ë§Œ ìš”ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
- ë…¹ìŒ íŒŒì¼ì„ Google Driveì— ì—…ë¡œë“œí•©ë‹ˆë‹¤
- íŒë§¤ ìƒíƒœë¥¼ `PENDING_APPROVAL`ë¡œ ë³€ê²½í•©ë‹ˆë‹¤

---

## 5. 4ë‹¨ê³„: ê´€ë¦¬ì ìŠ¹ì¸/ê±°ë¶€ API ë§Œë“¤ê¸°

### ğŸ“ ì„¤ëª…
ê´€ë¦¬ìê°€ íŒë§¤ í™•ì • ìš”ì²­ì„ ìŠ¹ì¸í•˜ê±°ë‚˜ ê±°ë¶€í•˜ëŠ” APIë¥¼ ë§Œë“­ë‹ˆë‹¤.

### ğŸ”§ ì‘ì—… ë‚´ìš©

#### 5-1. ìŠ¹ì¸ API

**ìƒˆ íŒŒì¼ ìƒì„±**: `app/api/admin/affiliate/sales/[saleId]/approve/route.ts`

```typescript
// app/api/admin/affiliate/sales/[saleId]/approve/route.ts
// íŒë§¤ í™•ì • ìŠ¹ì¸ API

import { NextRequest, NextResponse } from 'next/server';
import { cookies } from 'next/headers';
import prisma from '@/lib/prisma';
import { syncSaleCommissionLedgers } from '@/lib/affiliate/commission-ledger';

const SESSION_COOKIE = 'cg.sid.v2';

// ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
async function checkAdminAuth() {
  const sid = cookies().get(SESSION_COOKIE)?.value;
  if (!sid) return null;

  try {
    const session = await prisma.session.findUnique({
      where: { id: sid },
      include: {
        User: {
          select: { id: true, role: true, name: true },
        },
      },
    });

    if (!session || !session.User) return null;
    if (session.User.role !== 'admin') return null;
    return session.User;
  } catch (error) {
    console.error('[Approve Sale] Auth error:', error);
    return null;
  }
}

/**
 * POST: íŒë§¤ í™•ì • ìŠ¹ì¸
 */
export async function POST(
  req: NextRequest,
  { params }: { params: { saleId: string } }
) {
  try {
    // 1. ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
    const admin = await checkAdminAuth();
    if (!admin) {
      return NextResponse.json(
        { ok: false, error: 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤' },
        { status: 403 }
      );
    }

    // 2. íŒë§¤ ID í™•ì¸
    const saleId = parseInt(params.saleId);
    if (isNaN(saleId)) {
      return NextResponse.json(
        { ok: false, error: 'ì˜¬ë°”ë¥¸ íŒë§¤ IDê°€ ì•„ë‹™ë‹ˆë‹¤' },
        { status: 400 }
      );
    }

    // 3. íŒë§¤ ì •ë³´ í™•ì¸
    const sale = await prisma.affiliateSale.findUnique({
      where: { id: saleId },
      select: {
        id: true,
        status: true,
        audioFileGoogleDriveUrl: true,
      },
    });

    if (!sale) {
      return NextResponse.json(
        { ok: false, error: 'íŒë§¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' },
        { status: 404 }
      );
    }

    if (sale.status !== 'PENDING_APPROVAL') {
      return NextResponse.json(
        { ok: false, error: 'ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ íŒë§¤ë§Œ ìŠ¹ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤' },
        { status: 400 }
      );
    }

    // 4. íŒë§¤ ìŠ¹ì¸ ì²˜ë¦¬
    const updatedSale = await prisma.affiliateSale.update({
      where: { id: saleId },
      data: {
        status: 'APPROVED',
        approvedById: admin.id,
        approvedAt: new Date(),
        confirmedAt: new Date(), // ê¸°ì¡´ í•„ë“œì™€ í˜¸í™˜ì„± ìœ ì§€
      },
    });

    // 5. ìˆ˜ë‹¹ ìë™ ê³„ì‚°
    try {
      await syncSaleCommissionLedgers(saleId, {
        includeHq: true,
        regenerate: false,
      });
      console.log(`[Approve Sale] ìˆ˜ë‹¹ ê³„ì‚° ì™„ë£Œ: Sale #${saleId}`);
    } catch (commissionError: any) {
      console.error(`[Approve Sale] ìˆ˜ë‹¹ ê³„ì‚° ì˜¤ë¥˜:`, commissionError);
      // ìˆ˜ë‹¹ ê³„ì‚° ì‹¤íŒ¨í•´ë„ ìŠ¹ì¸ì€ ì™„ë£Œ (ë‚˜ì¤‘ì— ìˆ˜ë™ìœ¼ë¡œ ê³„ì‚° ê°€ëŠ¥)
    }

    return NextResponse.json({
      ok: true,
      message: 'íŒë§¤ê°€ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤',
      sale: {
        id: updatedSale.id,
        status: updatedSale.status,
      },
    });
  } catch (error: any) {
    console.error('[Approve Sale] Error:', error);
    return NextResponse.json(
      { ok: false, error: error.message || 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' },
      { status: 500 }
    );
  }
}
```

#### 5-2. ê±°ë¶€ API

**ìƒˆ íŒŒì¼ ìƒì„±**: `app/api/admin/affiliate/sales/[saleId]/reject/route.ts`

```typescript
// app/api/admin/affiliate/sales/[saleId]/reject/route.ts
// íŒë§¤ í™•ì • ê±°ë¶€ API

import { NextRequest, NextResponse } from 'next/server';
import { cookies } from 'next/headers';
import prisma from '@/lib/prisma';

const SESSION_COOKIE = 'cg.sid.v2';

// ê´€ë¦¬ì ê¶Œí•œ í™•ì¸ (ìœ„ì™€ ë™ì¼)
async function checkAdminAuth() {
  const sid = cookies().get(SESSION_COOKIE)?.value;
  if (!sid) return null;

  try {
    const session = await prisma.session.findUnique({
      where: { id: sid },
      include: {
        User: {
          select: { id: true, role: true, name: true },
        },
      },
    });

    if (!session || !session.User) return null;
    if (session.User.role !== 'admin') return null;
    return session.User;
  } catch (error) {
    console.error('[Reject Sale] Auth error:', error);
    return null;
  }
}

/**
 * POST: íŒë§¤ í™•ì • ê±°ë¶€
 */
export async function POST(
  req: NextRequest,
  { params }: { params: { saleId: string } }
) {
  try {
    // 1. ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
    const admin = await checkAdminAuth();
    if (!admin) {
      return NextResponse.json(
        { ok: false, error: 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤' },
        { status: 403 }
      );
    }

    // 2. íŒë§¤ ID í™•ì¸
    const saleId = parseInt(params.saleId);
    if (isNaN(saleId)) {
      return NextResponse.json(
        { ok: false, error: 'ì˜¬ë°”ë¥¸ íŒë§¤ IDê°€ ì•„ë‹™ë‹ˆë‹¤' },
        { status: 400 }
      );
    }

    // 3. ê±°ë¶€ ì‚¬ìœ  ë°›ê¸°
    const body = await req.json();
    const { reason } = body;

    if (!reason || reason.trim().length === 0) {
      return NextResponse.json(
        { ok: false, error: 'ê±°ë¶€ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”' },
        { status: 400 }
      );
    }

    // 4. íŒë§¤ ì •ë³´ í™•ì¸
    const sale = await prisma.affiliateSale.findUnique({
      where: { id: saleId },
      select: {
        id: true,
        status: true,
      },
    });

    if (!sale) {
      return NextResponse.json(
        { ok: false, error: 'íŒë§¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' },
        { status: 404 }
      );
    }

    if (sale.status !== 'PENDING_APPROVAL') {
      return NextResponse.json(
        { ok: false, error: 'ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ íŒë§¤ë§Œ ê±°ë¶€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤' },
        { status: 400 }
      );
    }

    // 5. íŒë§¤ ê±°ë¶€ ì²˜ë¦¬
    const updatedSale = await prisma.affiliateSale.update({
      where: { id: saleId },
      data: {
        status: 'REJECTED',
        rejectedById: admin.id,
        rejectedAt: new Date(),
        rejectionReason: reason.trim(),
        // ìƒíƒœë¥¼ PENDINGìœ¼ë¡œ ë˜ëŒë ¤ì„œ ì¬ìš”ì²­ ê°€ëŠ¥í•˜ê²Œ
        submittedAt: null,
        submittedById: null,
      },
    });

    return NextResponse.json({
      ok: true,
      message: 'íŒë§¤ê°€ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤',
      sale: {
        id: updatedSale.id,
        status: updatedSale.status,
        rejectionReason: updatedSale.rejectionReason,
      },
    });
  } catch (error: any) {
    console.error('[Reject Sale] Error:', error);
    return NextResponse.json(
      { ok: false, error: error.message || 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' },
      { status: 500 }
    );
  }
}
```

#### 5-3. ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡ ì¡°íšŒ API

**ìƒˆ íŒŒì¼ ìƒì„±**: `app/api/admin/affiliate/sales/pending-approval/route.ts`

```typescript
// app/api/admin/affiliate/sales/pending-approval/route.ts
// ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ íŒë§¤ ëª©ë¡ ì¡°íšŒ

import { NextRequest, NextResponse } from 'next/server';
import { cookies } from 'next/headers';
import prisma from '@/lib/prisma';

const SESSION_COOKIE = 'cg.sid.v2';

// ê´€ë¦¬ì ê¶Œí•œ í™•ì¸ (ìœ„ì™€ ë™ì¼)
async function checkAdminAuth() {
  const sid = cookies().get(SESSION_COOKIE)?.value;
  if (!sid) return null;

  try {
    const session = await prisma.session.findUnique({
      where: { id: sid },
      include: {
        User: {
          select: { id: true, role: true },
        },
      },
    });

    if (!session || !session.User) return null;
    if (session.User.role !== 'admin') return null;
    return session.User;
  } catch (error) {
    return null;
  }
}

/**
 * GET: ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ íŒë§¤ ëª©ë¡
 */
export async function GET(req: NextRequest) {
  try {
    // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
    const admin = await checkAdminAuth();
    if (!admin) {
      return NextResponse.json(
        { ok: false, error: 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤' },
        { status: 403 }
      );
    }

    // ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ íŒë§¤ ì¡°íšŒ
    const pendingSales = await prisma.affiliateSale.findMany({
      where: {
        status: 'PENDING_APPROVAL',
      },
      include: {
        agent: {
          select: {
            id: true,
            displayName: true,
            affiliateCode: true,
            type: true,
            user: {
              select: {
                id: true,
                name: true,
                phone: true,
              },
            },
          },
        },
        manager: {
          select: {
            id: true,
            displayName: true,
            affiliateCode: true,
            type: true,
            user: {
              select: {
                id: true,
                name: true,
                phone: true,
              },
            },
          },
        },
        product: {
          select: {
            productCode: true,
            title: true,
          },
        },
      },
      orderBy: {
        submittedAt: 'asc', // ì˜¤ë˜ëœ ê²ƒë¶€í„°
      },
    });

    return NextResponse.json({
      ok: true,
      sales: pendingSales.map((sale) => ({
        id: sale.id,
        productCode: sale.productCode,
        productTitle: sale.product?.title,
        saleAmount: sale.saleAmount,
        saleDate: sale.saleDate,
        submittedAt: sale.submittedAt,
        audioFileGoogleDriveUrl: sale.audioFileGoogleDriveUrl,
        audioFileName: sale.audioFileName,
        agent: sale.agent
          ? {
              name: sale.agent.displayName || sale.agent.user?.name,
              code: sale.agent.affiliateCode,
              phone: sale.agent.user?.phone,
            }
          : null,
        manager: sale.manager
          ? {
              name: sale.manager.displayName || sale.manager.user?.name,
              code: sale.manager.affiliateCode,
              phone: sale.manager.user?.phone,
            }
          : null,
      })),
      count: pendingSales.length,
    });
  } catch (error: any) {
    console.error('[Pending Approval] Error:', error);
    return NextResponse.json(
      { ok: false, error: error.message || 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' },
      { status: 500 }
    );
  }
}
```

### ğŸ“Œ ì„¤ëª…
- **ìŠ¹ì¸ API**: íŒë§¤ë¥¼ ìŠ¹ì¸í•˜ê³  ìˆ˜ë‹¹ì„ ìë™ ê³„ì‚°í•©ë‹ˆë‹¤
- **ê±°ë¶€ API**: íŒë§¤ë¥¼ ê±°ë¶€í•˜ê³  ì‚¬ìœ ë¥¼ ì €ì¥í•©ë‹ˆë‹¤ (ì¬ìš”ì²­ ê°€ëŠ¥)
- **ëª©ë¡ API**: ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ ëª¨ë“  íŒë§¤ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤

---

## 6. 5ë‹¨ê³„: UI ë§Œë“¤ê¸°

### ğŸ“ ì„¤ëª…
ì‚¬ìš©ìê°€ ì‰½ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” í™”ë©´ì„ ë§Œë“­ë‹ˆë‹¤. ë‹¨ê³„ë³„ë¡œ í•˜ë‚˜ì”© ë§Œë“¤ì–´ë´…ì‹œë‹¤.

### ğŸ”§ ì‘ì—… ë‚´ìš©

#### 6-1. íŒë§¤ í™•ì • ìš”ì²­ ëª¨ë‹¬ ì»´í¬ë„ŒíŠ¸ ë§Œë“¤ê¸°

**ìƒˆ íŒŒì¼ ìƒì„±**: `components/affiliate/SalesConfirmationModal.tsx`

ì´ ì»´í¬ë„ŒíŠ¸ëŠ” íŒë§¤ì›/ëŒ€ë¦¬ì ì¥ì´ ì‚¬ìš©í•©ë‹ˆë‹¤.

```typescript
'use client';

import { useState, useRef } from 'react';
import { FiUpload, FiX, FiCheckCircle, FiAlertCircle } from 'react-icons/fi';
import { showError, showSuccess } from '@/components/ui/Toast';

interface SalesConfirmationModalProps {
  saleId: number;
  currentStatus: string;
  audioFileUrl?: string | null;
  onClose: () => void;
  onSuccess: () => void;
}

export default function SalesConfirmationModal({
  saleId,
  currentStatus,
  audioFileUrl,
  onClose,
  onSuccess,
}: SalesConfirmationModalProps) {
  const [audioFile, setAudioFile] = useState<File | null>(null);
  const [isUploading, setIsUploading] = useState(false);
  const fileInputRef = useRef<HTMLInputElement>(null);

  // íŒŒì¼ ì„ íƒ
  const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    // íŒŒì¼ í¬ê¸° í™•ì¸ (50MB)
    if (file.size > 50 * 1024 * 1024) {
      showError('íŒŒì¼ í¬ê¸°ëŠ” 50MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
      return;
    }

    // íŒŒì¼ í˜•ì‹ í™•ì¸
    const allowedTypes = ['audio/mpeg', 'audio/mp3', 'audio/wav', 'audio/m4a', 'audio/x-m4a'];
    if (!allowedTypes.includes(file.type)) {
      showError('ì§€ì›í•˜ëŠ” íŒŒì¼ í˜•ì‹: MP3, WAV, M4A');
      return;
    }

    setAudioFile(file);
  };

  // íŒë§¤ í™•ì • ìš”ì²­ ì œì¶œ
  const handleSubmit = async () => {
    if (!audioFile) {
      showError('ë…¹ìŒ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
      return;
    }

    setIsUploading(true);
    try {
      const formData = new FormData();
      formData.append('audioFile', audioFile);

      const response = await fetch(`/api/affiliate/sales/${saleId}/submit-confirmation`, {
        method: 'POST',
        body: formData,
        credentials: 'include',
      });

      const data = await response.json();

      if (response.ok && data.ok) {
        showSuccess('íŒë§¤ í™•ì • ìš”ì²­ì´ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤');
        onSuccess();
        onClose();
      } else {
        showError(data.error || 'ìš”ì²­ ì œì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
      }
    } catch (error: any) {
      console.error('[Sales Confirmation] Submit error:', error);
      showError('ìš”ì²­ ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    } finally {
      setIsUploading(false);
    }
  };

  // ìš”ì²­ ì·¨ì†Œ (PENDING_APPROVAL ìƒíƒœì¼ ë•Œë§Œ)
  const handleCancel = async () => {
    if (!confirm('íŒë§¤ í™•ì • ìš”ì²­ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      return;
    }

    try {
      const response = await fetch(`/api/affiliate/sales/${saleId}/cancel-confirmation`, {
        method: 'POST',
        credentials: 'include',
      });

      const data = await response.json();

      if (response.ok && data.ok) {
        showSuccess('ìš”ì²­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤');
        onSuccess();
        onClose();
      } else {
        showError(data.error || 'ìš”ì²­ ì·¨ì†Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
      }
    } catch (error: any) {
      console.error('[Sales Confirmation] Cancel error:', error);
      showError('ìš”ì²­ ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    }
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
        {/* í—¤ë” */}
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-xl font-bold text-gray-800">íŒë§¤ í™•ì • ìš”ì²­</h2>
          <button
            onClick={onClose}
            className="text-gray-500 hover:text-gray-700"
          >
            <FiX className="w-6 h-6" />
          </button>
        </div>

        {/* ìƒíƒœ í‘œì‹œ */}
        {currentStatus === 'PENDING_APPROVAL' && (
          <div className="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
            <div className="flex items-center gap-2 text-yellow-800">
              <FiAlertCircle className="w-5 h-5" />
              <span className="font-semibold">ìŠ¹ì¸ ëŒ€ê¸° ì¤‘</span>
            </div>
            {audioFileUrl && (
              <a
                href={audioFileUrl}
                target="_blank"
                rel="noopener noreferrer"
                className="mt-2 text-sm text-yellow-700 hover:text-yellow-900 underline"
              >
                ë…¹ìŒ íŒŒì¼ í™•ì¸í•˜ê¸°
              </a>
            )}
          </div>
        )}

        {currentStatus === 'APPROVED' && (
          <div className="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg">
            <div className="flex items-center gap-2 text-green-800">
              <FiCheckCircle className="w-5 h-5" />
              <span className="font-semibold">ìŠ¹ì¸ ì™„ë£Œ</span>
            </div>
          </div>
        )}

        {currentStatus === 'REJECTED' && (
          <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg">
            <div className="flex items-center gap-2 text-red-800">
              <FiAlertCircle className="w-5 h-5" />
              <span className="font-semibold">ê±°ë¶€ë¨</span>
            </div>
            <p className="mt-2 text-sm text-red-700">
              ê±°ë¶€ ì‚¬ìœ ë¥¼ í™•ì¸í•˜ê³  ìˆ˜ì • í›„ ë‹¤ì‹œ ì œì¶œí•´ì£¼ì„¸ìš”.
            </p>
          </div>
        )}

        {/* íŒŒì¼ ì—…ë¡œë“œ (PENDING ë˜ëŠ” REJECTED ìƒíƒœì¼ ë•Œë§Œ) */}
        {(currentStatus === 'PENDING' || currentStatus === 'REJECTED') && (
          <div className="space-y-4">
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                ê³ ê°ê³¼ì˜ í†µí™” ë…¹ìŒ íŒŒì¼
              </label>
              <div className="border-2 border-dashed border-gray-300 rounded-lg p-4">
                <input
                  ref={fileInputRef}
                  type="file"
                  accept="audio/mpeg,audio/mp3,audio/wav,audio/m4a"
                  onChange={handleFileSelect}
                  className="hidden"
                />
                {audioFile ? (
                  <div className="space-y-2">
                    <p className="text-sm text-gray-700">{audioFile.name}</p>
                    <p className="text-xs text-gray-500">
                      í¬ê¸°: {(audioFile.size / 1024 / 1024).toFixed(2)} MB
                    </p>
                    <button
                      onClick={() => {
                        setAudioFile(null);
                        if (fileInputRef.current) {
                          fileInputRef.current.value = '';
                        }
                      }}
                      className="text-sm text-red-600 hover:text-red-700"
                    >
                      íŒŒì¼ ì œê±°
                    </button>
                  </div>
                ) : (
                  <button
                    onClick={() => fileInputRef.current?.click()}
                    className="w-full flex flex-col items-center justify-center py-4 text-gray-500 hover:text-gray-700"
                  >
                    <FiUpload className="w-8 h-8 mb-2" />
                    <span className="text-sm">ë…¹ìŒ íŒŒì¼ ì„ íƒ</span>
                    <span className="text-xs mt-1">MP3, WAV, M4A (ìµœëŒ€ 50MB)</span>
                  </button>
                )}
              </div>
            </div>

            <div className="flex gap-2">
              <button
                onClick={handleSubmit}
                disabled={!audioFile || isUploading}
                className="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                {isUploading ? 'ì—…ë¡œë“œ ì¤‘...' : 'ìš”ì²­ ì œì¶œ'}
              </button>
              <button
                onClick={onClose}
                className="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
              >
                ì·¨ì†Œ
              </button>
            </div>
          </div>
        )}

        {/* ì·¨ì†Œ ë²„íŠ¼ (PENDING_APPROVAL ìƒíƒœì¼ ë•Œë§Œ) */}
        {currentStatus === 'PENDING_APPROVAL' && (
          <div className="mt-4">
            <button
              onClick={handleCancel}
              className="w-full px-4 py-2 border border-red-300 text-red-600 rounded-lg hover:bg-red-50"
            >
              ìš”ì²­ ì·¨ì†Œ
            </button>
          </div>
        )}
      </div>
    </div>
  );
}
```

#### 6-2. ìš”ì²­ ì·¨ì†Œ API ë§Œë“¤ê¸°

**ìƒˆ íŒŒì¼ ìƒì„±**: `app/api/affiliate/sales/[saleId]/cancel-confirmation/route.ts`

```typescript
// app/api/affiliate/sales/[saleId]/cancel-confirmation/route.ts
// íŒë§¤ í™•ì • ìš”ì²­ ì·¨ì†Œ API

import { NextRequest, NextResponse } from 'next/server';
import { cookies } from 'next/headers';
import prisma from '@/lib/prisma';

const SESSION_COOKIE = 'cg.sid.v2';

// ì„¸ì…˜ì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ìœ„ì™€ ë™ì¼)
async function getCurrentUser() {
  const sid = cookies().get(SESSION_COOKIE)?.value;
  if (!sid) return null;

  try {
    const session = await prisma.session.findUnique({
      where: { id: sid },
      include: {
        User: {
          select: { id: true, role: true },
        },
      },
    });

    if (!session || !session.User) return null;
    return session.User;
  } catch (error) {
    return null;
  }
}

/**
 * POST: íŒë§¤ í™•ì • ìš”ì²­ ì·¨ì†Œ
 */
export async function POST(
  req: NextRequest,
  { params }: { params: { saleId: string } }
) {
  try {
    // 1. ì‚¬ìš©ì í™•ì¸
    const user = await getCurrentUser();
    if (!user) {
      return NextResponse.json(
        { ok: false, error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' },
        { status: 401 }
      );
    }

    // 2. íŒë§¤ ID í™•ì¸
    const saleId = parseInt(params.saleId);
    if (isNaN(saleId)) {
      return NextResponse.json(
        { ok: false, error: 'ì˜¬ë°”ë¥¸ íŒë§¤ IDê°€ ì•„ë‹™ë‹ˆë‹¤' },
        { status: 400 }
      );
    }

    // 3. íŒë§¤ ì •ë³´ í™•ì¸
    const sale = await prisma.affiliateSale.findUnique({
      where: { id: saleId },
      include: {
        agent: {
          select: { userId: true },
        },
        manager: {
          select: { userId: true },
        },
      },
    });

    if (!sale) {
      return NextResponse.json(
        { ok: false, error: 'íŒë§¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' },
        { status: 404 }
      );
    }

    // 4. ê¶Œí•œ í™•ì¸ (ë³¸ì¸ì´ ì œì¶œí•œ ìš”ì²­ë§Œ ì·¨ì†Œ ê°€ëŠ¥)
    if (sale.submittedById !== user.id) {
      return NextResponse.json(
        { ok: false, error: 'ë³¸ì¸ì´ ì œì¶œí•œ ìš”ì²­ë§Œ ì·¨ì†Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤' },
        { status: 403 }
      );
    }

    // 5. ìƒíƒœ í™•ì¸ (PENDING_APPROVALë§Œ ì·¨ì†Œ ê°€ëŠ¥)
    if (sale.status !== 'PENDING_APPROVAL') {
      return NextResponse.json(
        { ok: false, error: 'ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ ìš”ì²­ë§Œ ì·¨ì†Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤' },
        { status: 400 }
      );
    }

    // 6. ìš”ì²­ ì·¨ì†Œ ì²˜ë¦¬ (ìƒíƒœë¥¼ PENDINGìœ¼ë¡œ ë˜ëŒë¦¼)
    const updatedSale = await prisma.affiliateSale.update({
      where: { id: saleId },
      data: {
        status: 'PENDING',
        submittedAt: null,
        submittedById: null,
        // Google Drive íŒŒì¼ì€ ê·¸ëŒ€ë¡œ ìœ ì§€ (ë‚˜ì¤‘ì— ì¬ì‚¬ìš© ê°€ëŠ¥)
      },
    });

    return NextResponse.json({
      ok: true,
      message: 'ìš”ì²­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤',
      sale: {
        id: updatedSale.id,
        status: updatedSale.status,
      },
    });
  } catch (error: any) {
    console.error('[Cancel Confirmation] Error:', error);
    return NextResponse.json(
      { ok: false, error: error.message || 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' },
      { status: 500 }
    );
  }
}
```

#### 6-3. íŒë§¤ì›/ëŒ€ë¦¬ì ì¥ ëŒ€ì‹œë³´ë“œì— í†µí•©

**íŒŒì¼**: `app/partner/[partnerId]/dashboard/PartnerDashboard.tsx`

**ì¶”ê°€í•  ë‚´ìš©**:

1. **ìƒíƒœ ë³€ìˆ˜ ì¶”ê°€** (íŒŒì¼ ìƒë‹¨, ë‹¤ë¥¸ useState ê·¼ì²˜):
```typescript
const [showSalesConfirmationModal, setShowSalesConfirmationModal] = useState(false);
const [selectedSaleForConfirmation, setSelectedSaleForConfirmation] = useState<{
  id: number;
  status: string;
  audioFileUrl?: string | null;
} | null>(null);
```

2. **íŒë§¤ ëª©ë¡ API í˜¸ì¶œ í•¨ìˆ˜ ì¶”ê°€**:
```typescript
const [mySales, setMySales] = useState<Array<{
  id: number;
  productCode: string;
  saleAmount: number;
  status: string;
  audioFileGoogleDriveUrl: string | null;
  saleDate: string | null;
}>>([]);

const loadMySales = async () => {
  try {
    const response = await fetch('/api/affiliate/sales/my-sales', {
      credentials: 'include',
    });
    const data = await response.json();
    if (response.ok && data.ok) {
      setMySales(data.sales || []);
    }
  } catch (error) {
    console.error('[PartnerDashboard] Failed to load sales:', error);
  }
};

// useEffectì— ì¶”ê°€
useEffect(() => {
  loadStats();
  loadMyContract();
  loadMySales(); // ì¶”ê°€
  if (isBranchManager) {
    loadContracts();
  }
}, [isBranchManager, loadMyContract]);
```

3. **íŒë§¤ ëª©ë¡ ì„¹ì…˜ ì¶”ê°€** (ëŒ€ì‹œë³´ë“œ JSX ë¶€ë¶„):
```typescript
{/* íŒë§¤ ëª©ë¡ ì„¹ì…˜ */}
<div className="bg-white rounded-lg shadow-md p-6">
  <h2 className="text-xl font-bold text-gray-800 mb-4">ë‚´ íŒë§¤ ëª©ë¡</h2>
  {mySales.length === 0 ? (
    <p className="text-gray-500">íŒë§¤ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p>
  ) : (
    <div className="space-y-3">
      {mySales.map((sale) => {
        const statusBadge = {
          PENDING: { label: 'í™•ì • ëŒ€ê¸°', color: 'bg-gray-100 text-gray-800' },
          PENDING_APPROVAL: { label: 'ìŠ¹ì¸ ëŒ€ê¸°', color: 'bg-yellow-100 text-yellow-800' },
          APPROVED: { label: 'ìŠ¹ì¸ ì™„ë£Œ', color: 'bg-green-100 text-green-800' },
          REJECTED: { label: 'ê±°ë¶€ë¨', color: 'bg-red-100 text-red-800' },
        }[sale.status] || { label: sale.status, color: 'bg-gray-100 text-gray-800' };

        return (
          <div key={sale.id} className="border border-gray-200 rounded-lg p-4">
            <div className="flex items-center justify-between">
              <div className="flex-1">
                <div className="flex items-center gap-3 mb-2">
                  <span className="font-semibold text-gray-800">#{sale.id}</span>
                  <span className={`px-2 py-1 rounded-full text-xs font-semibold ${statusBadge.color}`}>
                    {statusBadge.label}
                  </span>
                </div>
                <p className="text-sm text-gray-600">
                  ìƒí’ˆ: {sale.productCode} | ê¸ˆì•¡: {(sale.saleAmount / 10000).toLocaleString()}ë§Œì›
                </p>
              </div>
              <button
                onClick={() => {
                  setSelectedSaleForConfirmation({
                    id: sale.id,
                    status: sale.status,
                    audioFileUrl: sale.audioFileGoogleDriveUrl,
                  });
                  setShowSalesConfirmationModal(true);
                }}
                className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-semibold"
              >
                {sale.status === 'PENDING' || sale.status === 'REJECTED' ? 'í™•ì • ìš”ì²­' : 'ìƒì„¸ ë³´ê¸°'}
              </button>
            </div>
          </div>
        );
      })}
    </div>
  )}
</div>
```

4. **ëª¨ë‹¬ ì»´í¬ë„ŒíŠ¸ ì¶”ê°€** (íŒŒì¼ ë, return ë¬¸ ì•ˆ):
```typescript
{/* íŒë§¤ í™•ì • ëª¨ë‹¬ */}
{showSalesConfirmationModal && selectedSaleForConfirmation && (
  <SalesConfirmationModal
    saleId={selectedSaleForConfirmation.id}
    currentStatus={selectedSaleForConfirmation.status}
    audioFileUrl={selectedSaleForConfirmation.audioFileUrl}
    onClose={() => {
      setShowSalesConfirmationModal(false);
      setSelectedSaleForConfirmation(null);
    }}
    onSuccess={() => {
      loadMySales(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
    }}
  />
)}
```

5. **import ì¶”ê°€** (íŒŒì¼ ìƒë‹¨):
```typescript
import SalesConfirmationModal from '@/components/affiliate/SalesConfirmationModal';
```

**ì¶”ê°€ë¡œ í•„ìš”í•œ API**: `app/api/affiliate/sales/my-sales/route.ts`

```typescript
// app/api/affiliate/sales/my-sales/route.ts
// ë‚´ íŒë§¤ ëª©ë¡ ì¡°íšŒ API

import { NextRequest, NextResponse } from 'next/server';
import { cookies } from 'next/headers';
import prisma from '@/lib/prisma';

const SESSION_COOKIE = 'cg.sid.v2';

async function getCurrentUser() {
  const sid = cookies().get(SESSION_COOKIE)?.value;
  if (!sid) return null;

  try {
    const session = await prisma.session.findUnique({
      where: { id: sid },
      include: {
        User: {
          select: { id: true },
        },
      },
    });
    return session?.User || null;
  } catch (error) {
    return null;
  }
}

export async function GET(req: NextRequest) {
  try {
    const user = await getCurrentUser();
    if (!user) {
      return NextResponse.json({ ok: false, error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, { status: 401 });
    }

    // ì‚¬ìš©ìì˜ ì–´í•„ë¦¬ì—ì´íŠ¸ í”„ë¡œí•„ ì°¾ê¸°
    const profile = await prisma.affiliateProfile.findUnique({
      where: { userId: user.id },
      select: { id: true, type: true },
    });

    if (!profile) {
      return NextResponse.json({ ok: true, sales: [] });
    }

    // ë³¸ì¸ íŒë§¤ë§Œ ì¡°íšŒ
    const where: any = {};
    if (profile.type === 'SALES_AGENT') {
      where.agentId = profile.id;
    } else if (profile.type === 'BRANCH_MANAGER') {
      where.managerId = profile.id;
    } else {
      return NextResponse.json({ ok: true, sales: [] });
    }

    const sales = await prisma.affiliateSale.findMany({
      where,
      select: {
        id: true,
        productCode: true,
        saleAmount: true,
        status: true,
        audioFileGoogleDriveUrl: true,
        saleDate: true,
        submittedAt: true,
        approvedAt: true,
      },
      orderBy: {
        createdAt: 'desc',
      },
      take: 50, // ìµœê·¼ 50ê°œë§Œ
    });

    return NextResponse.json({
      ok: true,
      sales,
    });
  } catch (error: any) {
    console.error('[My Sales] Error:', error);
    return NextResponse.json(
      { ok: false, error: error.message || 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' },
      { status: 500 }
    );
  }
}
```

#### 6-4. ê´€ë¦¬ì ìŠ¹ì¸ ëŒ€ê¸° í˜ì´ì§€

**ìƒˆ íŒŒì¼ ìƒì„±**: `app/admin/affiliate/sales/pending-approval/page.tsx`

```typescript
'use client';

import { useState, useEffect } from 'react';
import { FiCheckCircle, FiXCircle, FiExternalLink, FiRefreshCw, FiClock } from 'react-icons/fi';
import { showError, showSuccess } from '@/components/ui/Toast';

interface PendingSale {
  id: number;
  productCode: string;
  productTitle: string | null;
  saleAmount: number;
  saleDate: string | null;
  submittedAt: string;
  audioFileGoogleDriveUrl: string | null;
  audioFileName: string | null;
  agent: {
    name: string | null;
    code: string;
    phone: string | null;
  } | null;
  manager: {
    name: string | null;
    code: string;
    phone: string | null;
  } | null;
}

export default function PendingApprovalPage() {
  const [sales, setSales] = useState<PendingSale[]>([]);
  const [loading, setLoading] = useState(true);
  const [approvingId, setApprovingId] = useState<number | null>(null);
  const [rejectingId, setRejectingId] = useState<number | null>(null);
  const [rejectReason, setRejectReason] = useState('');
  const [showRejectModal, setShowRejectModal] = useState<number | null>(null);

  // ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
  const loadPendingSales = async () => {
    try {
      setLoading(true);
      const response = await fetch('/api/admin/affiliate/sales/pending-approval', {
        credentials: 'include',
      });
      const data = await response.json();

      if (response.ok && data.ok) {
        setSales(data.sales || []);
      } else {
        showError(data.error || 'ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
      }
    } catch (error: any) {
      console.error('[Pending Approval] Load error:', error);
      showError('ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    loadPendingSales();
  }, []);

  // ìŠ¹ì¸ ì²˜ë¦¬
  const handleApprove = async (saleId: number) => {
    if (!confirm('ì´ íŒë§¤ë¥¼ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ìŠ¹ì¸ ì‹œ ìˆ˜ë‹¹ì´ ìë™ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤.')) {
      return;
    }

    try {
      setApprovingId(saleId);
      const response = await fetch(`/api/admin/affiliate/sales/${saleId}/approve`, {
        method: 'POST',
        credentials: 'include',
      });
      const data = await response.json();

      if (response.ok && data.ok) {
        showSuccess('íŒë§¤ê°€ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤');
        loadPendingSales(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
      } else {
        showError(data.error || 'ìŠ¹ì¸ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
      }
    } catch (error: any) {
      console.error('[Pending Approval] Approve error:', error);
      showError('ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    } finally {
      setApprovingId(null);
    }
  };

  // ê±°ë¶€ ì²˜ë¦¬
  const handleReject = async (saleId: number) => {
    if (!rejectReason.trim()) {
      showError('ê±°ë¶€ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
      return;
    }

    try {
      setRejectingId(saleId);
      const response = await fetch(`/api/admin/affiliate/sales/${saleId}/reject`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ reason: rejectReason }),
      });
      const data = await response.json();

      if (response.ok && data.ok) {
        showSuccess('íŒë§¤ê°€ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤');
        setShowRejectModal(null);
        setRejectReason('');
        loadPendingSales(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
      } else {
        showError(data.error || 'ê±°ë¶€ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
      }
    } catch (error: any) {
      console.error('[Pending Approval] Reject error:', error);
      showError('ê±°ë¶€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    } finally {
      setRejectingId(null);
    }
  };

  // ê¸ˆì•¡ í¬ë§·íŒ…
  const formatAmount = (amount: number) => {
    return `${(amount / 10000).toLocaleString()}ë§Œì›`;
  };

  // ë‚ ì§œ í¬ë§·íŒ…
  const formatDate = (dateString: string | null) => {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleDateString('ko-KR', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
    });
  };

  return (
    <div className="space-y-6 p-6">
      {/* í—¤ë” */}
      <div className="bg-white rounded-lg shadow-md p-6">
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-3xl font-bold text-gray-800 mb-2">
              â³ íŒë§¤ í™•ì • ìŠ¹ì¸ ëŒ€ê¸°
            </h1>
            <p className="text-gray-600">
              ë…¹ìŒ íŒŒì¼ì„ í™•ì¸í•˜ê³  íŒë§¤ í™•ì •ì„ ìŠ¹ì¸í•˜ê±°ë‚˜ ê±°ë¶€í•˜ì„¸ìš”.
            </p>
          </div>
          <button
            onClick={loadPendingSales}
            disabled={loading}
            className="inline-flex items-center gap-2 rounded-lg bg-gray-100 px-4 py-2 text-sm font-semibold text-gray-700 hover:bg-gray-200 disabled:opacity-50"
          >
            <FiRefreshCw className={loading ? 'animate-spin' : ''} />
            ìƒˆë¡œê³ ì¹¨
          </button>
        </div>
      </div>

      {/* ëª©ë¡ */}
      {loading ? (
        <div className="text-center py-12">
          <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
          <p className="mt-2 text-gray-600">ë¡œë”© ì¤‘...</p>
        </div>
      ) : sales.length === 0 ? (
        <div className="bg-white rounded-lg shadow-md p-12 text-center">
          <FiCheckCircle className="w-16 h-16 text-green-500 mx-auto mb-4" />
          <p className="text-xl font-semibold text-gray-800">ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ íŒë§¤ê°€ ì—†ìŠµë‹ˆë‹¤</p>
          <p className="text-gray-600 mt-2">ëª¨ë“  íŒë§¤ê°€ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
        </div>
      ) : (
        <div className="space-y-4">
          {sales.map((sale) => (
            <div key={sale.id} className="bg-white rounded-lg shadow-md p-6">
              <div className="flex items-start justify-between">
                {/* ì™¼ìª½: íŒë§¤ ì •ë³´ */}
                <div className="flex-1">
                  <div className="flex items-center gap-3 mb-3">
                    <span className="text-2xl font-bold text-blue-600">#{sale.id}</span>
                    <span className="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm font-semibold">
                      ìŠ¹ì¸ ëŒ€ê¸° ì¤‘
                    </span>
                  </div>

                  <div className="grid grid-cols-2 gap-4 mb-4">
                    <div>
                      <p className="text-sm text-gray-500">ìƒí’ˆ</p>
                      <p className="font-semibold text-gray-800">
                        {sale.productTitle || sale.productCode}
                      </p>
                    </div>
                    <div>
                      <p className="text-sm text-gray-500">íŒë§¤ ê¸ˆì•¡</p>
                      <p className="font-semibold text-gray-800">{formatAmount(sale.saleAmount)}</p>
                    </div>
                    <div>
                      <p className="text-sm text-gray-500">ìš”ì²­ ì œì¶œ ì‹œê°„</p>
                      <p className="font-semibold text-gray-800">{formatDate(sale.submittedAt)}</p>
                    </div>
                    <div>
                      <p className="text-sm text-gray-500">ë‹´ë‹¹ì</p>
                      <p className="font-semibold text-gray-800">
                        {sale.agent
                          ? `íŒë§¤ì›: ${sale.agent.name || 'ì´ë¦„ ì—†ìŒ'} (${sale.agent.code})`
                          : sale.manager
                          ? `ëŒ€ë¦¬ì ì¥: ${sale.manager.name || 'ì´ë¦„ ì—†ìŒ'} (${sale.manager.code})`
                          : 'ë‹´ë‹¹ì ì—†ìŒ'}
                      </p>
                    </div>
                  </div>

                  {/* ë…¹ìŒ íŒŒì¼ ë§í¬ */}
                  {sale.audioFileGoogleDriveUrl && (
                    <div className="mb-4">
                      <a
                        href={sale.audioFileGoogleDriveUrl}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="inline-flex items-center gap-2 text-blue-600 hover:text-blue-700 font-semibold"
                      >
                        <FiExternalLink />
                        ë…¹ìŒ íŒŒì¼ í™•ì¸í•˜ê¸° (Google Drive)
                        {sale.audioFileName && (
                          <span className="text-sm text-gray-500">({sale.audioFileName})</span>
                        )}
                      </a>
                    </div>
                  )}
                </div>

                {/* ì˜¤ë¥¸ìª½: ì•¡ì…˜ ë²„íŠ¼ */}
                <div className="flex flex-col gap-2 ml-6">
                  <button
                    onClick={() => handleApprove(sale.id)}
                    disabled={approvingId === sale.id}
                    className="inline-flex items-center justify-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed min-w-[120px]"
                  >
                    {approvingId === sale.id ? (
                      <>
                        <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                        ìŠ¹ì¸ ì¤‘...
                      </>
                    ) : (
                      <>
                        <FiCheckCircle />
                        ìŠ¹ì¸
                      </>
                    )}
                  </button>
                  <button
                    onClick={() => setShowRejectModal(sale.id)}
                    disabled={rejectingId === sale.id}
                    className="inline-flex items-center justify-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed min-w-[120px]"
                  >
                    <FiXCircle />
                    ê±°ë¶€
                  </button>
                </div>
              </div>
            </div>
          ))}
        </div>
      )}

      {/* ê±°ë¶€ ì‚¬ìœ  ì…ë ¥ ëª¨ë‹¬ */}
      {showRejectModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
            <h3 className="text-xl font-bold text-gray-800 mb-4">ê±°ë¶€ ì‚¬ìœ  ì…ë ¥</h3>
            <textarea
              value={rejectReason}
              onChange={(e) => setRejectReason(e.target.value)}
              placeholder="ê±°ë¶€ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”..."
              className="w-full h-32 border border-gray-300 rounded-lg px-3 py-2 focus:border-red-500 focus:outline-none focus:ring-2 focus:ring-red-100"
            />
            <div className="flex gap-2 mt-4">
              <button
                onClick={() => handleReject(showRejectModal)}
                disabled={!rejectReason.trim() || rejectingId === showRejectModal}
                className="flex-1 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                {rejectingId === showRejectModal ? 'ì²˜ë¦¬ ì¤‘...' : 'ê±°ë¶€í•˜ê¸°'}
              </button>
              <button
                onClick={() => {
                  setShowRejectModal(null);
                  setRejectReason('');
                }}
                className="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
              >
                ì·¨ì†Œ
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
```

### ğŸ“Œ ì„¤ëª…
- ê´€ë¦¬ìê°€ ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ ëª¨ë“  íŒë§¤ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤
- ê° íŒë§¤ë§ˆë‹¤ Google Drive ë§í¬ê°€ ìˆì–´ ë°”ë¡œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
- ìŠ¹ì¸/ê±°ë¶€ ë²„íŠ¼ìœ¼ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
- ê±°ë¶€ ì‹œ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤

---

## 7. 6ë‹¨ê³„: ì•Œë¦¼ ê¸°ëŠ¥ ì¶”ê°€

### ğŸ“ ì„¤ëª…
ìŠ¹ì¸/ê±°ë¶€ ì‹œ íŒë§¤ì›/ëŒ€ë¦¬ì ì¥ì—ê²Œ ì•Œë¦¼ì„ ë³´ëƒ…ë‹ˆë‹¤.

### ğŸ”§ ì‘ì—… ë‚´ìš©

**íŒŒì¼**: `lib/affiliate/sales-notification.ts` (ìƒˆë¡œ ë§Œë“¤ê¸°)

```typescript
// lib/affiliate/sales-notification.ts
// íŒë§¤ í™•ì • ê´€ë ¨ ì•Œë¦¼

import prisma from '@/lib/prisma';
import { sendNotificationToUser } from '@/lib/push/server';

/**
 * íŒë§¤ í™•ì • ìŠ¹ì¸ ì•Œë¦¼
 */
export async function notifySaleApproved(saleId: number) {
  try {
    const sale = await prisma.affiliateSale.findUnique({
      where: { id: saleId },
      include: {
        agent: {
          include: {
            user: {
              select: { id: true, name: true },
            },
          },
        },
        manager: {
          include: {
            user: {
              select: { id: true, name: true },
            },
          },
        },
      },
    });

    if (!sale) return;

    // íŒë§¤ì›ì—ê²Œ ì•Œë¦¼
    if (sale.agentId && sale.agent?.user) {
      await sendNotificationToUser(sale.agent.user.id, {
        title: 'âœ… íŒë§¤ í™•ì • ìŠ¹ì¸',
        body: `íŒë§¤ #${saleId}ì´(ê°€) ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. ìˆ˜ë‹¹ì´ ê³„ì‚°ë˜ì—ˆìŠµë‹ˆë‹¤.`,
        data: { saleId, type: 'sale_approved' },
      });
    }

    // ëŒ€ë¦¬ì ì¥ì—ê²Œ ì•Œë¦¼ (íŒë§¤ì›ì´ ì•„ë‹Œ ê²½ìš°)
    if (sale.managerId && sale.manager?.user && !sale.agentId) {
      await sendNotificationToUser(sale.manager.user.id, {
        title: 'âœ… íŒë§¤ í™•ì • ìŠ¹ì¸',
        body: `íŒë§¤ #${saleId}ì´(ê°€) ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. ìˆ˜ë‹¹ì´ ê³„ì‚°ë˜ì—ˆìŠµë‹ˆë‹¤.`,
        data: { saleId, type: 'sale_approved' },
      });
    }
  } catch (error) {
    console.error('[Notify Sale Approved] Error:', error);
  }
}

/**
 * íŒë§¤ í™•ì • ê±°ë¶€ ì•Œë¦¼
 */
export async function notifySaleRejected(saleId: number, reason: string) {
  try {
    const sale = await prisma.affiliateSale.findUnique({
      where: { id: saleId },
      include: {
        agent: {
          include: {
            user: {
              select: { id: true, name: true },
            },
          },
        },
        manager: {
          include: {
            user: {
              select: { id: true, name: true },
            },
          },
        },
      },
    });

    if (!sale) return;

    // íŒë§¤ì›ì—ê²Œ ì•Œë¦¼
    if (sale.agentId && sale.agent?.user) {
      await sendNotificationToUser(sale.agent.user.id, {
        title: 'âŒ íŒë§¤ í™•ì • ê±°ë¶€',
        body: `íŒë§¤ #${saleId}ì´(ê°€) ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ì‚¬ìœ : ${reason}`,
        data: { saleId, type: 'sale_rejected', reason },
      });
    }

    // ëŒ€ë¦¬ì ì¥ì—ê²Œ ì•Œë¦¼
    if (sale.managerId && sale.manager?.user && !sale.agentId) {
      await sendNotificationToUser(sale.manager.user.id, {
        title: 'âŒ íŒë§¤ í™•ì • ê±°ë¶€',
        body: `íŒë§¤ #${saleId}ì´(ê°€) ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ì‚¬ìœ : ${reason}`,
        data: { saleId, type: 'sale_rejected', reason },
      });
    }
  } catch (error) {
    console.error('[Notify Sale Rejected] Error:', error);
  }
}
```

**ìŠ¹ì¸/ê±°ë¶€ APIì— ì•Œë¦¼ ì¶”ê°€**:

ìŠ¹ì¸ API (`app/api/admin/affiliate/sales/[saleId]/approve/route.ts`)ì— ì¶”ê°€:
```typescript
import { notifySaleApproved } from '@/lib/affiliate/sales-notification';

// ìŠ¹ì¸ ì²˜ë¦¬ í›„:
await notifySaleApproved(saleId);
```

ê±°ë¶€ API (`app/api/admin/affiliate/sales/[saleId]/reject/route.ts`)ì— ì¶”ê°€:
```typescript
import { notifySaleRejected } from '@/lib/affiliate/sales-notification';

// ê±°ë¶€ ì²˜ë¦¬ í›„:
await notifySaleRejected(saleId, reason);
```

---

## 8. í…ŒìŠ¤íŠ¸ ë°©ë²•

### ğŸ“ ë‹¨ê³„ë³„ í…ŒìŠ¤íŠ¸

1. **ë°ì´í„°ë² ì´ìŠ¤ í…ŒìŠ¤íŠ¸**
   - Prisma Studio ì—´ê¸°: `npx prisma studio`
   - AffiliateSale í…Œì´ë¸” í™•ì¸
   - ìƒˆ í•„ë“œë“¤ì´ ì¶”ê°€ë˜ì—ˆëŠ”ì§€ í™•ì¸

2. **íŒŒì¼ ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸**
   - íŒë§¤ í™•ì • ìš”ì²­ API í˜¸ì¶œ
   - Google Driveì— íŒŒì¼ì´ ì—…ë¡œë“œë˜ëŠ”ì§€ í™•ì¸
   - ë§í¬ê°€ ì •ìƒì ìœ¼ë¡œ ìƒì„±ë˜ëŠ”ì§€ í™•ì¸

3. **ìŠ¹ì¸/ê±°ë¶€ í…ŒìŠ¤íŠ¸**
   - ê´€ë¦¬ìë¡œ ë¡œê·¸ì¸
   - ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡ í™•ì¸
   - ìŠ¹ì¸/ê±°ë¶€ ì‹¤í–‰
   - ìˆ˜ë‹¹ ê³„ì‚° í™•ì¸

4. **ì•Œë¦¼ í…ŒìŠ¤íŠ¸**
   - í‘¸ì‹œ ì•Œë¦¼ì´ ì •ìƒì ìœ¼ë¡œ ì „ì†¡ë˜ëŠ”ì§€ í™•ì¸

---

## ğŸ“Œ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •

`.env.local` íŒŒì¼ì— ì¶”ê°€ (ì´ë¯¸ ìˆìœ¼ë©´ í™•ì¸ë§Œ):

```bash
# Google Drive Service Account ì„¤ì • (ì´ë¯¸ ìˆì„ ìˆ˜ ìˆìŒ)
GOOGLE_DRIVE_SERVICE_ACCOUNT_EMAIL=your-service-account@project.iam.gserviceaccount.com
GOOGLE_DRIVE_SERVICE_ACCOUNT_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n"
GOOGLE_DRIVE_SHARED_DRIVE_ID=your_shared_drive_id  # ì„ íƒì‚¬í•­

# ë…¹ìŒ íŒŒì¼ ì €ì¥ í´ë” (ì„ íƒì‚¬í•­, ì—†ìœ¼ë©´ rootì— ì €ì¥)
GOOGLE_DRIVE_SALES_AUDIO_FOLDER_ID=your_folder_id
```

### ğŸ“ Google Drive í´ë” ID ì°¾ëŠ” ë°©ë²•
1. Google Driveì—ì„œ í´ë”ë¥¼ ì—½ë‹ˆë‹¤
2. URLì„ í™•ì¸í•©ë‹ˆë‹¤: `https://drive.google.com/drive/folders/ì—¬ê¸°ê°€í´ë”ID`
3. í´ë” IDë¥¼ ë³µì‚¬í•´ì„œ í™˜ê²½ ë³€ìˆ˜ì— ë„£ìŠµë‹ˆë‹¤

---

## âš ï¸ ì£¼ì˜ì‚¬í•­

1. **Google Drive ê¶Œí•œ**: Service Account ë˜ëŠ” OAuth ì„¤ì • í•„ìš”
2. **íŒŒì¼ í¬ê¸°**: 50MB ì œí•œ í™•ì¸
3. **ì—ëŸ¬ ì²˜ë¦¬**: ëª¨ë“  APIì— ì—ëŸ¬ ì²˜ë¦¬ í¬í•¨
4. **ë³´ì•ˆ**: ê¶Œí•œ í™•ì¸ í•„ìˆ˜

---

## ğŸ‰ ì™„ë£Œ ì²´í¬ë¦¬ìŠ¤íŠ¸

### 1ë‹¨ê³„: ë°ì´í„°ë² ì´ìŠ¤
- [ ] `prisma/schema.prisma`ì— AffiliateSale í•„ë“œ ì¶”ê°€
- [ ] `npx prisma db push` ì‹¤í–‰
- [ ] Prisma Studioë¡œ ìƒˆ í•„ë“œ í™•ì¸

### 2ë‹¨ê³„: Google Drive í•¨ìˆ˜
- [ ] `lib/google-drive.ts`ì— `uploadAudioFileToDrive` í•¨ìˆ˜ ì¶”ê°€
- [ ] í™˜ê²½ ë³€ìˆ˜ ì„¤ì • í™•ì¸

### 3ë‹¨ê³„: API ë§Œë“¤ê¸°
- [ ] `app/api/affiliate/sales/[saleId]/submit-confirmation/route.ts` ìƒì„±
- [ ] `app/api/affiliate/sales/[saleId]/cancel-confirmation/route.ts` ìƒì„±
- [ ] `app/api/admin/affiliate/sales/[saleId]/approve/route.ts` ìƒì„±
- [ ] `app/api/admin/affiliate/sales/[saleId]/reject/route.ts` ìƒì„±
- [ ] `app/api/admin/affiliate/sales/pending-approval/route.ts` ìƒì„±

### 4ë‹¨ê³„: ì•Œë¦¼ ê¸°ëŠ¥
- [ ] `lib/affiliate/sales-notification.ts` ìƒì„±
- [ ] ìŠ¹ì¸ APIì— ì•Œë¦¼ ì¶”ê°€
- [ ] ê±°ë¶€ APIì— ì•Œë¦¼ ì¶”ê°€

### 5ë‹¨ê³„: UI ë§Œë“¤ê¸°
- [ ] `components/affiliate/SalesConfirmationModal.tsx` ìƒì„±
- [ ] `app/admin/affiliate/sales/pending-approval/page.tsx` ìƒì„±
- [ ] íŒë§¤ì›/ëŒ€ë¦¬ì ì¥ ëŒ€ì‹œë³´ë“œì— ëª¨ë‹¬ í†µí•©

### 6ë‹¨ê³„: í…ŒìŠ¤íŠ¸
- [ ] íŒë§¤ í™•ì • ìš”ì²­ í…ŒìŠ¤íŠ¸
- [ ] Google Drive ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸
- [ ] ê´€ë¦¬ì ìŠ¹ì¸/ê±°ë¶€ í…ŒìŠ¤íŠ¸
- [ ] ì•Œë¦¼ ì „ì†¡ í…ŒìŠ¤íŠ¸
- [ ] ìˆ˜ë‹¹ ìë™ ê³„ì‚° í™•ì¸

---

## ğŸ“š êµ¬í˜„ ìš°ì„ ìˆœìœ„ (ë‹¨ê³„ë³„)

### â­ ìµœìš°ì„  (1ì¼ì°¨)
1. **ë°ì´í„°ë² ì´ìŠ¤ ìˆ˜ì •** (30ë¶„)
   - ìŠ¤í‚¤ë§ˆ ìˆ˜ì •
   - ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰

2. **Google Drive í•¨ìˆ˜** (30ë¶„)
   - `uploadAudioFileToDrive` í•¨ìˆ˜ ì¶”ê°€
   - í…ŒìŠ¤íŠ¸

3. **íŒë§¤ í™•ì • ìš”ì²­ API** (1ì‹œê°„)
   - íŒŒì¼ ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸
   - ê¶Œí•œ í™•ì¸ í…ŒìŠ¤íŠ¸

### ğŸ”¥ ì¤‘ìš” (2ì¼ì°¨)
4. **ê´€ë¦¬ì ìŠ¹ì¸/ê±°ë¶€ API** (1ì‹œê°„)
   - ìŠ¹ì¸ API
   - ê±°ë¶€ API
   - ìˆ˜ë‹¹ ê³„ì‚° ì—°ê²°

5. **ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡ API** (30ë¶„)
   - ëª©ë¡ ì¡°íšŒ í…ŒìŠ¤íŠ¸

### ğŸ’¡ ë³´ì™„ (3ì¼ì°¨)
6. **ì•Œë¦¼ ê¸°ëŠ¥** (1ì‹œê°„)
   - ì•Œë¦¼ í•¨ìˆ˜ ë§Œë“¤ê¸°
   - APIì— ì—°ê²°

7. **UI êµ¬í˜„** (2-3ì‹œê°„)
   - ëª¨ë‹¬ ì»´í¬ë„ŒíŠ¸
   - ê´€ë¦¬ì í˜ì´ì§€
   - ëŒ€ì‹œë³´ë“œ í†µí•©

8. **í…ŒìŠ¤íŠ¸ ë° ìˆ˜ì •** (1-2ì‹œê°„)
   - ì „ì²´ í”Œë¡œìš° í…ŒìŠ¤íŠ¸
   - ë²„ê·¸ ìˆ˜ì •

---

## ğŸš¨ ì£¼ì˜ì‚¬í•­ ë° íŒ

### 1. Google Drive ì„¤ì •
- Service Account í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤
- í´ë” IDëŠ” ì„ íƒì‚¬í•­ì…ë‹ˆë‹¤ (ì—†ìœ¼ë©´ rootì— ì €ì¥)
- ê³µê°œ ë§í¬ê°€ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤

### 2. íŒŒì¼ í¬ê¸° ì œí•œ
- ìµœëŒ€ 50MBë¡œ ì œí•œí–ˆìŠµë‹ˆë‹¤
- ë” í° íŒŒì¼ì´ í•„ìš”í•˜ë©´ í™˜ê²½ ë³€ìˆ˜ë¡œ ì¡°ì • ê°€ëŠ¥

### 3. ì—ëŸ¬ ì²˜ë¦¬
- ëª¨ë“  APIì— try-catch ì¶”ê°€í–ˆìŠµë‹ˆë‹¤
- ì‚¬ìš©ìì—ê²Œ ëª…í™•í•œ ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ

### 4. ë³´ì•ˆ
- ë³¸ì¸ íŒë§¤ë§Œ ìš”ì²­ ê°€ëŠ¥
- ê´€ë¦¬ìë§Œ ìŠ¹ì¸/ê±°ë¶€ ê°€ëŠ¥
- ì„¸ì…˜ í™•ì¸ í•„ìˆ˜

### 5. ê¸°ì¡´ ê¸°ëŠ¥ê³¼ì˜ í˜¸í™˜ì„±
- ê¸°ì¡´ `CONFIRMED` ìƒíƒœëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€
- ìƒˆ í”„ë¡œì„¸ìŠ¤ëŠ” `PENDING_APPROVAL` â†’ `APPROVED` ì‚¬ìš©

---

## ğŸ’¬ ì§ˆë¬¸ì´ ìˆìœ¼ë©´?

êµ¬í˜„ ì¤‘ ë¬¸ì œê°€ ìƒê¸°ê±°ë‚˜ ì´í•´ê°€ ì•ˆ ë˜ëŠ” ë¶€ë¶„ì´ ìˆìœ¼ë©´ ì–¸ì œë“ ì§€ ë¬¼ì–´ë³´ì„¸ìš”!

---

## âš ï¸ ê¸°ì¡´ ê´€ë¦¬ì íŒ¨ë„ ì—°ê²° ë¬¸ì œì  í™•ì¸

### ë°œê²¬ëœ ë¬¸ì œì 

1. **ìˆ˜ë‹¹ ì¡°ì • ìŠ¹ì¸ í˜ì´ì§€** (`/admin/affiliate/adjustments`)
   - "êµ¬ë§¤ ì™„ë£Œ ìŠ¹ì¸" íƒ­ì—ì„œ ì‚¬ìš©í•˜ëŠ” `/api/admin/affiliate/sales/[saleId]/approve-commission` API ì¡´ì¬ ì—¬ë¶€ í™•ì¸ í•„ìš”
   - ì´ APIê°€ ì—†ìœ¼ë©´ êµ¬ë§¤ ì™„ë£Œ ìŠ¹ì¸ ê¸°ëŠ¥ì´ ì‘ë™í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ

2. **ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡ API**
   - ê¸°ì¡´ APIëŠ” `PENDING` ìƒíƒœë§Œ í™•ì¸
   - ìƒˆë¡œìš´ í”„ë¡œì„¸ìŠ¤ëŠ” `PENDING_APPROVAL` ìƒíƒœ ì‚¬ìš©
   - ë‘ í”„ë¡œì„¸ìŠ¤ê°€ ê³µì¡´í•  ìˆ˜ ìˆë„ë¡ API ìˆ˜ì • í•„ìš”

3. **ë°ì´í„° í˜•ì‹ ë¶ˆì¼ì¹˜**
   - ì¼ë¶€ APIëŠ” `{ ok: true, error: '...' }` í˜•ì‹
   - ì¼ë¶€ APIëŠ” `{ ok: true, message: '...' }` í˜•ì‹
   - í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì¼ê´€ë˜ì§€ ì•Šê²Œ ì²˜ë¦¬í•  ìˆ˜ ìˆìŒ

**ìƒì„¸ ë‚´ìš©ì€ `ADMIN_AFFILIATE_CONNECTION_ISSUES.md` íŒŒì¼ ì°¸ì¡°**

---

## ğŸ“– ì „ì²´ ìš”ì•½ (í•œëˆˆì— ë³´ê¸°)

### ğŸ¯ ëª©í‘œ
íŒë§¤ì›/ëŒ€ë¦¬ì ì¥ì´ ê³ ê°ê³¼ì˜ í†µí™” ë…¹ìŒì„ Google Driveì— ì—…ë¡œë“œí•˜ê³ , ê´€ë¦¬ìê°€ í™•ì¸ í›„ ìŠ¹ì¸í•˜ë©´ ìë™ìœ¼ë¡œ ìˆ˜ë‹¹ì´ ê³„ì‚°ë˜ëŠ” ì‹œìŠ¤í…œ

### ğŸ“‹ ë§Œë“¤ íŒŒì¼ ëª©ë¡

#### ë°ì´í„°ë² ì´ìŠ¤
- `prisma/schema.prisma` (ìˆ˜ì •)

#### í•¨ìˆ˜/ìœ í‹¸ë¦¬í‹°
- `lib/google-drive.ts` (í•¨ìˆ˜ ì¶”ê°€)
- `lib/affiliate/sales-notification.ts` (ìƒˆë¡œ ë§Œë“¤ê¸°)

#### API (5ê°œ)
- `app/api/affiliate/sales/[saleId]/submit-confirmation/route.ts` (ìƒˆë¡œ ë§Œë“¤ê¸°)
- `app/api/affiliate/sales/[saleId]/cancel-confirmation/route.ts` (ìƒˆë¡œ ë§Œë“¤ê¸°)
- `app/api/affiliate/sales/my-sales/route.ts` (ìƒˆë¡œ ë§Œë“¤ê¸°)
- `app/api/admin/affiliate/sales/[saleId]/approve/route.ts` (ìƒˆë¡œ ë§Œë“¤ê¸°)
- `app/api/admin/affiliate/sales/[saleId]/reject/route.ts` (ìƒˆë¡œ ë§Œë“¤ê¸°)
- `app/api/admin/affiliate/sales/pending-approval/route.ts` (ìƒˆë¡œ ë§Œë“¤ê¸°)

#### UI ì»´í¬ë„ŒíŠ¸
- `components/affiliate/SalesConfirmationModal.tsx` (ìƒˆë¡œ ë§Œë“¤ê¸°)
- `app/admin/affiliate/sales/pending-approval/page.tsx` (ìƒˆë¡œ ë§Œë“¤ê¸°)
- `app/partner/[partnerId]/dashboard/PartnerDashboard.tsx` (ìˆ˜ì •)

### ğŸ”„ í”„ë¡œì„¸ìŠ¤ ìš”ì•½

1. **íŒë§¤ ìƒì„±** (ìë™)
   - ê°ì ëª°ì—ì„œ ê²°ì œ ì™„ë£Œ ì‹œ ìë™ ìƒì„±

2. **íŒë§¤ í™•ì • ìš”ì²­** (íŒë§¤ì›/ëŒ€ë¦¬ì ì¥)
   - ëŒ€ì‹œë³´ë“œì—ì„œ "í™•ì • ìš”ì²­" í´ë¦­
   - ë…¹ìŒ íŒŒì¼ ì—…ë¡œë“œ
   - Google Driveì— ì €ì¥
   - ìƒíƒœ: `PENDING` â†’ `PENDING_APPROVAL`

3. **ê´€ë¦¬ì í™•ì¸** (ê´€ë¦¬ì)
   - ìŠ¹ì¸ ëŒ€ê¸° í˜ì´ì§€ì—ì„œ ëª©ë¡ í™•ì¸
   - Google Drive ë§í¬ í´ë¦­í•˜ì—¬ ë…¹ìŒ í™•ì¸
   - ìŠ¹ì¸ ë˜ëŠ” ê±°ë¶€

4. **ìŠ¹ì¸ ì‹œ** (ìë™)
   - ìƒíƒœ: `PENDING_APPROVAL` â†’ `APPROVED`
   - ìˆ˜ë‹¹ ìë™ ê³„ì‚°
   - CommissionLedger ìƒì„±
   - íŒë§¤ì›/ëŒ€ë¦¬ì ì¥ì—ê²Œ ì•Œë¦¼

5. **ê±°ë¶€ ì‹œ**
   - ìƒíƒœ: `PENDING_APPROVAL` â†’ `REJECTED`
   - íŒë§¤ì›/ëŒ€ë¦¬ì ì¥ì—ê²Œ ì•Œë¦¼
   - ìˆ˜ì • í›„ ì¬ìš”ì²­ ê°€ëŠ¥

### âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸ (ê°„ë‹¨ ë²„ì „)

1. [ ] ë°ì´í„°ë² ì´ìŠ¤ ìˆ˜ì •
2. [ ] Google Drive í•¨ìˆ˜ ì¶”ê°€
3. [ ] íŒë§¤ í™•ì • ìš”ì²­ API
4. [ ] ìš”ì²­ ì·¨ì†Œ API
5. [ ] ë‚´ íŒë§¤ ëª©ë¡ API
6. [ ] ê´€ë¦¬ì ìŠ¹ì¸ API
7. [ ] ê´€ë¦¬ì ê±°ë¶€ API
8. [ ] ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡ API
9. [ ] ì•Œë¦¼ í•¨ìˆ˜
10. [ ] íŒë§¤ í™•ì • ëª¨ë‹¬ ì»´í¬ë„ŒíŠ¸
11. [ ] ê´€ë¦¬ì ìŠ¹ì¸ ëŒ€ê¸° í˜ì´ì§€
12. [ ] ëŒ€ì‹œë³´ë“œ í†µí•©
13. [ ] í…ŒìŠ¤íŠ¸

---

## ğŸš€ ì‹œì‘í•˜ê¸°

**1ë‹¨ê³„ë¶€í„° ì°¨ê·¼ì°¨ê·¼ ë”°ë¼í•˜ì‹œë©´ ë©ë‹ˆë‹¤!**

ê° ë‹¨ê³„ë§ˆë‹¤:
1. íŒŒì¼ì„ ë§Œë“¤ê±°ë‚˜ ìˆ˜ì •í•©ë‹ˆë‹¤
2. ì½”ë“œë¥¼ ë³µì‚¬í•´ì„œ ë¶™ì—¬ë„£ìŠµë‹ˆë‹¤
3. ì €ì¥í•©ë‹ˆë‹¤
4. í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤
5. ë‹¤ìŒ ë‹¨ê³„ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤

**ë¬¸ì œê°€ ìƒê¸°ë©´ ì–¸ì œë“ ì§€ ë¬¼ì–´ë³´ì„¸ìš”!** ğŸ˜Š


> **ì‘ì„±ì¼**: 2025-01-28  
> **ëª©ì **: íŒë§¤ì›/ëŒ€ë¦¬ì ì¥ì´ ë…¹ìŒ íŒŒì¼ì„ ì²¨ë¶€í•˜ì—¬ íŒë§¤ í™•ì • ìš”ì²­í•˜ê³ , ê´€ë¦¬ìê°€ ìŠ¹ì¸í•˜ëŠ” ì‹œìŠ¤í…œ êµ¬í˜„  
> **ë‚œì´ë„**: ì´ˆë³´ìë„ ë”°ë¼í•  ìˆ˜ ìˆë„ë¡ ì‰½ê²Œ ì„¤ëª…

---

## ğŸ“‹ ëª©ì°¨

1. [ì „ì²´ í”„ë¡œì„¸ìŠ¤ ì´í•´í•˜ê¸°](#1-ì „ì²´-í”„ë¡œì„¸ìŠ¤-ì´í•´í•˜ê¸°)
2. [1ë‹¨ê³„: ë°ì´í„°ë² ì´ìŠ¤ ìˆ˜ì •](#2-1ë‹¨ê³„-ë°ì´í„°ë² ì´ìŠ¤-ìˆ˜ì •)
3. [2ë‹¨ê³„: Google Drive ì—…ë¡œë“œ í•¨ìˆ˜ ë§Œë“¤ê¸°](#3-2ë‹¨ê³„-google-drive-ì—…ë¡œë“œ-í•¨ìˆ˜-ë§Œë“¤ê¸°)
4. [3ë‹¨ê³„: íŒë§¤ í™•ì • ìš”ì²­ API ë§Œë“¤ê¸°](#4-3ë‹¨ê³„-íŒë§¤-í™•ì •-ìš”ì²­-api-ë§Œë“¤ê¸°)
5. [4ë‹¨ê³„: ê´€ë¦¬ì ìŠ¹ì¸/ê±°ë¶€ API ë§Œë“¤ê¸°](#5-4ë‹¨ê³„-ê´€ë¦¬ì-ìŠ¹ì¸ê±°ë¶€-api-ë§Œë“¤ê¸°)
6. [5ë‹¨ê³„: UI ë§Œë“¤ê¸°](#6-5ë‹¨ê³„-ui-ë§Œë“¤ê¸°)
7. [6ë‹¨ê³„: ì•Œë¦¼ ê¸°ëŠ¥ ì¶”ê°€](#7-6ë‹¨ê³„-ì•Œë¦¼-ê¸°ëŠ¥-ì¶”ê°€)
8. [í…ŒìŠ¤íŠ¸ ë°©ë²•](#8-í…ŒìŠ¤íŠ¸-ë°©ë²•)

---

## 1. ì „ì²´ í”„ë¡œì„¸ìŠ¤ ì´í•´í•˜ê¸°

### ğŸ¬ ì‹œë‚˜ë¦¬ì˜¤

**ìƒí™©**: íŒë§¤ì› ê¹€ì² ìˆ˜ê°€ ê³ ê°ê³¼ í†µí™”ë¥¼ í–ˆê³ , ê³ ê°ì´ êµ¬ë§¤ë¥¼ ê²°ì •í–ˆìŠµë‹ˆë‹¤.

**ê³¼ì •**:
1. ê¹€ì² ìˆ˜ê°€ í†µí™” ë…¹ìŒ íŒŒì¼ì„ ì¤€ë¹„í•©ë‹ˆë‹¤
2. íŒë§¤ í™•ì • ìš”ì²­ í˜ì´ì§€ì—ì„œ ë…¹ìŒ íŒŒì¼ì„ ì—…ë¡œë“œí•©ë‹ˆë‹¤
3. ì‹œìŠ¤í…œì´ Google Driveì— íŒŒì¼ì„ ì €ì¥í•©ë‹ˆë‹¤
4. ê´€ë¦¬ìì—ê²Œ "ìŠ¹ì¸ ëŒ€ê¸°" ì•Œë¦¼ì´ ê°‘ë‹ˆë‹¤
5. ê´€ë¦¬ìê°€ Google Drive ë§í¬ë¥¼ í´ë¦­í•´ì„œ ë…¹ìŒì„ í™•ì¸í•©ë‹ˆë‹¤
6. ê´€ë¦¬ìê°€ ìŠ¹ì¸í•˜ë©´ ìë™ìœ¼ë¡œ ìˆ˜ë‹¹ì´ ê³„ì‚°ë©ë‹ˆë‹¤
7. ê¹€ì² ìˆ˜ì—ê²Œ "ìŠ¹ì¸ ì™„ë£Œ" ì•Œë¦¼ì´ ê°‘ë‹ˆë‹¤

### ğŸ“Š ìƒíƒœ íë¦„ë„

```
PENDING (ì´ˆê¸° ìƒíƒœ)
    â†“
[íŒë§¤ì›/ëŒ€ë¦¬ì ì¥ì´ ìš”ì²­ ì œì¶œ]
    â†“
PENDING_APPROVAL (ìŠ¹ì¸ ëŒ€ê¸°)
    â†“
[ê´€ë¦¬ìê°€ í™•ì¸ í›„]
    â”œâ”€â†’ APPROVED (ìŠ¹ì¸) â†’ ìˆ˜ë‹¹ ìë™ ê³„ì‚° âœ…
    â””â”€â†’ REJECTED (ê±°ë¶€) â†’ ìˆ˜ì • ê°€ëŠ¥ ğŸ”„
```

---

## 2. 1ë‹¨ê³„: ë°ì´í„°ë² ì´ìŠ¤ ìˆ˜ì •

### ğŸ“ ì„¤ëª…
ë°ì´í„°ë² ì´ìŠ¤ì— "ë…¹ìŒ íŒŒì¼ ì •ë³´"ì™€ "ìŠ¹ì¸ ì •ë³´"ë¥¼ ì €ì¥í•  ê³µê°„ì„ ë§Œë“¤ì–´ì•¼ í•©ë‹ˆë‹¤.

### ğŸ”§ ì‘ì—… ë‚´ìš©

**íŒŒì¼**: `prisma/schema.prisma`

**AffiliateSale ëª¨ë¸ì— ì¶”ê°€í•  í•„ë“œë“¤**:

```prisma
model AffiliateSale {
  // ... ê¸°ì¡´ í•„ë“œë“¤ ...
  
  // ğŸ†• ì¶”ê°€í•  í•„ë“œë“¤
  audioFileGoogleDriveId String?        // Google Drive íŒŒì¼ ID
  audioFileGoogleDriveUrl String?       // Google Drive ê³µìœ  ë§í¬
  audioFileName String?                 // ì›ë³¸ íŒŒì¼ëª…
  submittedById Int?                    // ìš”ì²­ ì œì¶œì ID (íŒë§¤ì›/ëŒ€ë¦¬ì ì¥)
  submittedAt DateTime?                 // ìš”ì²­ ì œì¶œ ì‹œê°„
  approvedById Int?                     // ìŠ¹ì¸í•œ ê´€ë¦¬ì ID
  approvedAt DateTime?                  // ìŠ¹ì¸ ì‹œê°„
  rejectedById Int?                     // ê±°ë¶€í•œ ê´€ë¦¬ì ID
  rejectedAt DateTime?                  // ê±°ë¶€ ì‹œê°„
  rejectionReason String?               // ê±°ë¶€ ì‚¬ìœ 
  
  // ... ê¸°ì¡´ í•„ë“œë“¤ ...
}
```

### ğŸ“Œ ì¤‘ìš” ì‚¬í•­
- `?` í‘œì‹œëŠ” "ì—†ì–´ë„ ë¨"ì„ ì˜ë¯¸í•©ë‹ˆë‹¤
- `String?`ì€ "í…ìŠ¤íŠ¸ ë˜ëŠ” ì—†ìŒ"
- `Int?`ëŠ” "ìˆ«ì ë˜ëŠ” ì—†ìŒ"
- `DateTime?`ì€ "ë‚ ì§œ/ì‹œê°„ ë˜ëŠ” ì—†ìŒ"

### âœ… ì‹¤í–‰ ë°©ë²•

1. **íŒŒì¼ ì—´ê¸°**: `prisma/schema.prisma` íŒŒì¼ì„ ì—½ë‹ˆë‹¤
2. **AffiliateSale ëª¨ë¸ ì°¾ê¸°**: `model AffiliateSale {` ë¶€ë¶„ì„ ì°¾ìŠµë‹ˆë‹¤
3. **í•„ë“œ ì¶”ê°€**: ìœ„ì˜ í•„ë“œë“¤ì„ ê¸°ì¡´ í•„ë“œë“¤ ì•„ë˜ì— ì¶”ê°€í•©ë‹ˆë‹¤
4. **ì €ì¥**: íŒŒì¼ì„ ì €ì¥í•©ë‹ˆë‹¤
5. **ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸**: í„°ë¯¸ë„ì—ì„œ ë‹¤ìŒ ëª…ë ¹ì–´ ì‹¤í–‰
   ```bash
   npx prisma db push
   ```

### âš ï¸ ì£¼ì˜ì‚¬í•­
- ê¸°ì¡´ ë°ì´í„°ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€ë©ë‹ˆë‹¤
- ìƒˆ í•„ë“œëŠ” ëª¨ë‘ "ì—†ìŒ" ìƒíƒœë¡œ ì‹œì‘í•©ë‹ˆë‹¤

---

## 3. 2ë‹¨ê³„: Google Drive ì—…ë¡œë“œ í•¨ìˆ˜ í™•ì¸í•˜ê¸°

### ğŸ“ ì„¤ëª…
ì´ë¯¸ Google Drive ì—…ë¡œë“œ í•¨ìˆ˜ê°€ ìˆìŠµë‹ˆë‹¤! (`lib/google-drive.ts`ì˜ `uploadFileToDrive` í•¨ìˆ˜)
ì´ í•¨ìˆ˜ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ë©´ ë©ë‹ˆë‹¤. ë…¹ìŒ íŒŒì¼ìš©ìœ¼ë¡œ ê°„ë‹¨íˆ ë˜í¼ í•¨ìˆ˜ë§Œ ë§Œë“¤ë©´ ë©ë‹ˆë‹¤.

### ğŸ”§ ì‘ì—… ë‚´ìš©

**íŒŒì¼**: `lib/google-drive.ts` (ì´ë¯¸ ìˆìŒ, í•¨ìˆ˜ ì¶”ê°€)

**ì¶”ê°€í•  í•¨ìˆ˜** (íŒŒì¼ ëì—):

```typescript
/**
 * ë…¹ìŒ íŒŒì¼ì„ Google Driveì— ì—…ë¡œë“œ (ê°„í¸ í•¨ìˆ˜)
 * @param fileBuffer íŒŒì¼ ë°ì´í„° (Buffer)
 * @param fileName íŒŒì¼ëª…
 * @param folderId Google Drive í´ë” ID (ì„ íƒì‚¬í•­, í™˜ê²½ ë³€ìˆ˜ì—ì„œ ê°€ì ¸ì˜´)
 * @returns Google Drive íŒŒì¼ ì •ë³´
 */
export async function uploadAudioFileToDrive(
  fileBuffer: Buffer,
  fileName: string,
  folderId?: string
): Promise<{ ok: boolean; fileId?: string; url?: string; error?: string }> {
  // í´ë” IDê°€ ì—†ìœ¼ë©´ í™˜ê²½ ë³€ìˆ˜ì—ì„œ ê°€ì ¸ì˜¤ê¸°
  const targetFolderId = folderId || process.env.GOOGLE_DRIVE_SALES_AUDIO_FOLDER_ID || 'root';
  
  // íŒŒì¼ í˜•ì‹ ìë™ ê°ì§€
  let mimeType = 'audio/mpeg'; // ê¸°ë³¸ê°’: MP3
  if (fileName.endsWith('.wav')) mimeType = 'audio/wav';
  else if (fileName.endsWith('.m4a')) mimeType = 'audio/m4a';
  else if (fileName.endsWith('.mp3')) mimeType = 'audio/mpeg';

  // ê¸°ì¡´ í•¨ìˆ˜ ì‚¬ìš©
  return await uploadFileToDrive({
    folderId: targetFolderId,
    fileName,
    mimeType,
    buffer: fileBuffer,
    makePublic: true, // ë§í¬ë¡œ ì ‘ê·¼ ê°€ëŠ¥í•˜ê²Œ
  });
}
```

### ğŸ“Œ ì„¤ëª…
- ê¸°ì¡´ `uploadFileToDrive` í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤
- ë…¹ìŒ íŒŒì¼ ì „ìš©ìœ¼ë¡œ ê°„ë‹¨í•˜ê²Œ ë§Œë“  í•¨ìˆ˜ì…ë‹ˆë‹¤
- íŒŒì¼ í˜•ì‹ì„ ìë™ìœ¼ë¡œ ê°ì§€í•©ë‹ˆë‹¤
- ê³µê°œ ë§í¬ë¥¼ ìë™ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤

### âœ… ì‹¤í–‰ ë°©ë²•
1. `lib/google-drive.ts` íŒŒì¼ì„ ì—½ë‹ˆë‹¤
2. íŒŒì¼ ë(ë§ˆì§€ë§‰ ì¤„)ì— ìœ„ í•¨ìˆ˜ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤
3. ì €ì¥í•©ë‹ˆë‹¤

---

## 4. 3ë‹¨ê³„: íŒë§¤ í™•ì • ìš”ì²­ API ë§Œë“¤ê¸°

### ğŸ“ ì„¤ëª…
íŒë§¤ì›/ëŒ€ë¦¬ì ì¥ì´ "íŒë§¤ í™•ì • ìš”ì²­"ì„ ì œì¶œí•˜ëŠ” APIë¥¼ ë§Œë“­ë‹ˆë‹¤.

### ğŸ”§ ì‘ì—… ë‚´ìš©

**ìƒˆ íŒŒì¼ ìƒì„±**: `app/api/affiliate/sales/[saleId]/submit-confirmation/route.ts`

**ì „ì²´ ì½”ë“œ**:

```typescript
// app/api/affiliate/sales/[saleId]/submit-confirmation/route.ts
// íŒë§¤ í™•ì • ìš”ì²­ ì œì¶œ API

import { NextRequest, NextResponse } from 'next/server';
import { cookies } from 'next/headers';
import prisma from '@/lib/prisma';
import { uploadAudioToGoogleDrive } from '@/lib/google/drive';

const SESSION_COOKIE = 'cg.sid.v2';

// ì„¸ì…˜ì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
async function getCurrentUser() {
  const sid = cookies().get(SESSION_COOKIE)?.value;
  if (!sid) return null;

  try {
    const session = await prisma.session.findUnique({
      where: { id: sid },
      include: {
        User: {
          select: { id: true, role: true },
        },
      },
    });

    if (!session || !session.User) return null;
    return session.User;
  } catch (error) {
    console.error('[Submit Confirmation] Session error:', error);
    return null;
  }
}

// íŒë§¤ì›/ëŒ€ë¦¬ì ì¥ ê¶Œí•œ í™•ì¸
async function checkAffiliateAuth(saleId: number, userId: number) {
  // íŒë§¤ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
  const sale = await prisma.affiliateSale.findUnique({
    where: { id: saleId },
    include: {
      agent: {
        select: { userId: true, type: true },
      },
      manager: {
        select: { userId: true, type: true },
      },
    },
  });

  if (!sale) {
    return { allowed: false, reason: 'íŒë§¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' };
  }

  // íŒë§¤ì›ì¸ ê²½ìš°: ë³¸ì¸ íŒë§¤ë§Œ ê°€ëŠ¥
  if (sale.agentId && sale.agent?.userId === userId) {
    return { allowed: true, profile: sale.agent };
  }

  // ëŒ€ë¦¬ì ì¥ì¸ ê²½ìš°: ë³¸ì¸ íŒë§¤ë§Œ ê°€ëŠ¥ (ì†Œì† íŒë§¤ì› íŒë§¤ëŠ” ë¶ˆê°€)
  if (sale.managerId && sale.manager?.userId === userId) {
    return { allowed: true, profile: sale.manager };
  }

  return { allowed: false, reason: 'ë³¸ì¸ì˜ íŒë§¤ë§Œ í™•ì • ìš”ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤' };
}

/**
 * POST: íŒë§¤ í™•ì • ìš”ì²­ ì œì¶œ
 */
export async function POST(
  req: NextRequest,
  { params }: { params: { saleId: string } }
) {
  try {
    // 1. ì‚¬ìš©ì í™•ì¸
    const user = await getCurrentUser();
    if (!user) {
      return NextResponse.json(
        { ok: false, error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' },
        { status: 401 }
      );
    }

    // 2. íŒë§¤ ID í™•ì¸
    const saleId = parseInt(params.saleId);
    if (isNaN(saleId)) {
      return NextResponse.json(
        { ok: false, error: 'ì˜¬ë°”ë¥¸ íŒë§¤ IDê°€ ì•„ë‹™ë‹ˆë‹¤' },
        { status: 400 }
      );
    }

    // 3. ê¶Œí•œ í™•ì¸ (ë³¸ì¸ íŒë§¤ë§Œ)
    const authCheck = await checkAffiliateAuth(saleId, user.id);
    if (!authCheck.allowed) {
      return NextResponse.json(
        { ok: false, error: authCheck.reason },
        { status: 403 }
      );
    }

    // 4. íŒë§¤ ìƒíƒœ í™•ì¸ (ì´ë¯¸ ìš”ì²­í–ˆê±°ë‚˜ ìŠ¹ì¸ëœ ê²½ìš° ë¶ˆê°€)
    const sale = await prisma.affiliateSale.findUnique({
      where: { id: saleId },
      select: { id: true, status: true },
    });

    if (!sale) {
      return NextResponse.json(
        { ok: false, error: 'íŒë§¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' },
        { status: 404 }
      );
    }

    if (sale.status === 'PENDING_APPROVAL') {
      return NextResponse.json(
        { ok: false, error: 'ì´ë¯¸ ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤' },
        { status: 400 }
      );
    }

    if (sale.status === 'APPROVED') {
      return NextResponse.json(
        { ok: false, error: 'ì´ë¯¸ ìŠ¹ì¸ëœ íŒë§¤ì…ë‹ˆë‹¤' },
        { status: 400 }
      );
    }

    // 5. íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
    const formData = await req.formData();
    const audioFile = formData.get('audioFile') as File | null;

    if (!audioFile) {
      return NextResponse.json(
        { ok: false, error: 'ë…¹ìŒ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”' },
        { status: 400 }
      );
    }

    // íŒŒì¼ í¬ê¸° í™•ì¸ (50MB ì œí•œ)
    const MAX_FILE_SIZE = 50 * 1024 * 1024; // 50MB
    if (audioFile.size > MAX_FILE_SIZE) {
      return NextResponse.json(
        { ok: false, error: 'íŒŒì¼ í¬ê¸°ëŠ” 50MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤' },
        { status: 400 }
      );
    }

    // íŒŒì¼ í˜•ì‹ í™•ì¸ (MP3, WAV, M4A)
    const allowedTypes = ['audio/mpeg', 'audio/mp3', 'audio/wav', 'audio/m4a', 'audio/x-m4a'];
    if (!allowedTypes.includes(audioFile.type)) {
      return NextResponse.json(
        { ok: false, error: 'ì§€ì›í•˜ëŠ” íŒŒì¼ í˜•ì‹: MP3, WAV, M4A' },
        { status: 400 }
      );
    }

    // 6. Google Driveì— ì—…ë¡œë“œ
    const fileBuffer = Buffer.from(await audioFile.arrayBuffer());
    const fileName = `sale_${saleId}_${Date.now()}_${audioFile.name}`;

    // Google Drive ì—…ë¡œë“œ (ê¸°ì¡´ í•¨ìˆ˜ ì‚¬ìš©)
    const { uploadAudioFileToDrive } = await import('@/lib/google-drive');
    const driveResult = await uploadAudioFileToDrive(fileBuffer, fileName);

    if (!driveResult.ok || !driveResult.fileId || !driveResult.url) {
      return NextResponse.json(
        { ok: false, error: driveResult.error || 'Google Drive ì—…ë¡œë“œ ì‹¤íŒ¨' },
        { status: 500 }
      );
    }

    // 7. ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸
    const updatedSale = await prisma.affiliateSale.update({
      where: { id: saleId },
      data: {
        status: 'PENDING_APPROVAL',
        audioFileGoogleDriveId: driveResult.fileId,
        audioFileGoogleDriveUrl: driveResult.url,
        audioFileName: audioFile.name,
        submittedById: user.id,
        submittedAt: new Date(),
      },
    });

    return NextResponse.json({
      ok: true,
      message: 'íŒë§¤ í™•ì • ìš”ì²­ì´ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤',
      sale: {
        id: updatedSale.id,
        status: updatedSale.status,
        audioFileUrl: updatedSale.audioFileGoogleDriveUrl,
      },
    });
  } catch (error: any) {
    console.error('[Submit Confirmation] Error:', error);
    return NextResponse.json(
      { ok: false, error: error.message || 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' },
      { status: 500 }
    );
  }
}
```

### ğŸ“Œ ì„¤ëª…
- ì´ APIëŠ” íŒë§¤ì›/ëŒ€ë¦¬ì ì¥ì´ ì‚¬ìš©í•©ë‹ˆë‹¤
- ë³¸ì¸ íŒë§¤ë§Œ ìš”ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
- ë…¹ìŒ íŒŒì¼ì„ Google Driveì— ì—…ë¡œë“œí•©ë‹ˆë‹¤
- íŒë§¤ ìƒíƒœë¥¼ `PENDING_APPROVAL`ë¡œ ë³€ê²½í•©ë‹ˆë‹¤

---

## 5. 4ë‹¨ê³„: ê´€ë¦¬ì ìŠ¹ì¸/ê±°ë¶€ API ë§Œë“¤ê¸°

### ğŸ“ ì„¤ëª…
ê´€ë¦¬ìê°€ íŒë§¤ í™•ì • ìš”ì²­ì„ ìŠ¹ì¸í•˜ê±°ë‚˜ ê±°ë¶€í•˜ëŠ” APIë¥¼ ë§Œë“­ë‹ˆë‹¤.

### ğŸ”§ ì‘ì—… ë‚´ìš©

#### 5-1. ìŠ¹ì¸ API

**ìƒˆ íŒŒì¼ ìƒì„±**: `app/api/admin/affiliate/sales/[saleId]/approve/route.ts`

```typescript
// app/api/admin/affiliate/sales/[saleId]/approve/route.ts
// íŒë§¤ í™•ì • ìŠ¹ì¸ API

import { NextRequest, NextResponse } from 'next/server';
import { cookies } from 'next/headers';
import prisma from '@/lib/prisma';
import { syncSaleCommissionLedgers } from '@/lib/affiliate/commission-ledger';

const SESSION_COOKIE = 'cg.sid.v2';

// ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
async function checkAdminAuth() {
  const sid = cookies().get(SESSION_COOKIE)?.value;
  if (!sid) return null;

  try {
    const session = await prisma.session.findUnique({
      where: { id: sid },
      include: {
        User: {
          select: { id: true, role: true, name: true },
        },
      },
    });

    if (!session || !session.User) return null;
    if (session.User.role !== 'admin') return null;
    return session.User;
  } catch (error) {
    console.error('[Approve Sale] Auth error:', error);
    return null;
  }
}

/**
 * POST: íŒë§¤ í™•ì • ìŠ¹ì¸
 */
export async function POST(
  req: NextRequest,
  { params }: { params: { saleId: string } }
) {
  try {
    // 1. ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
    const admin = await checkAdminAuth();
    if (!admin) {
      return NextResponse.json(
        { ok: false, error: 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤' },
        { status: 403 }
      );
    }

    // 2. íŒë§¤ ID í™•ì¸
    const saleId = parseInt(params.saleId);
    if (isNaN(saleId)) {
      return NextResponse.json(
        { ok: false, error: 'ì˜¬ë°”ë¥¸ íŒë§¤ IDê°€ ì•„ë‹™ë‹ˆë‹¤' },
        { status: 400 }
      );
    }

    // 3. íŒë§¤ ì •ë³´ í™•ì¸
    const sale = await prisma.affiliateSale.findUnique({
      where: { id: saleId },
      select: {
        id: true,
        status: true,
        audioFileGoogleDriveUrl: true,
      },
    });

    if (!sale) {
      return NextResponse.json(
        { ok: false, error: 'íŒë§¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' },
        { status: 404 }
      );
    }

    if (sale.status !== 'PENDING_APPROVAL') {
      return NextResponse.json(
        { ok: false, error: 'ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ íŒë§¤ë§Œ ìŠ¹ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤' },
        { status: 400 }
      );
    }

    // 4. íŒë§¤ ìŠ¹ì¸ ì²˜ë¦¬
    const updatedSale = await prisma.affiliateSale.update({
      where: { id: saleId },
      data: {
        status: 'APPROVED',
        approvedById: admin.id,
        approvedAt: new Date(),
        confirmedAt: new Date(), // ê¸°ì¡´ í•„ë“œì™€ í˜¸í™˜ì„± ìœ ì§€
      },
    });

    // 5. ìˆ˜ë‹¹ ìë™ ê³„ì‚°
    try {
      await syncSaleCommissionLedgers(saleId, {
        includeHq: true,
        regenerate: false,
      });
      console.log(`[Approve Sale] ìˆ˜ë‹¹ ê³„ì‚° ì™„ë£Œ: Sale #${saleId}`);
    } catch (commissionError: any) {
      console.error(`[Approve Sale] ìˆ˜ë‹¹ ê³„ì‚° ì˜¤ë¥˜:`, commissionError);
      // ìˆ˜ë‹¹ ê³„ì‚° ì‹¤íŒ¨í•´ë„ ìŠ¹ì¸ì€ ì™„ë£Œ (ë‚˜ì¤‘ì— ìˆ˜ë™ìœ¼ë¡œ ê³„ì‚° ê°€ëŠ¥)
    }

    return NextResponse.json({
      ok: true,
      message: 'íŒë§¤ê°€ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤',
      sale: {
        id: updatedSale.id,
        status: updatedSale.status,
      },
    });
  } catch (error: any) {
    console.error('[Approve Sale] Error:', error);
    return NextResponse.json(
      { ok: false, error: error.message || 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' },
      { status: 500 }
    );
  }
}
```

#### 5-2. ê±°ë¶€ API

**ìƒˆ íŒŒì¼ ìƒì„±**: `app/api/admin/affiliate/sales/[saleId]/reject/route.ts`

```typescript
// app/api/admin/affiliate/sales/[saleId]/reject/route.ts
// íŒë§¤ í™•ì • ê±°ë¶€ API

import { NextRequest, NextResponse } from 'next/server';
import { cookies } from 'next/headers';
import prisma from '@/lib/prisma';

const SESSION_COOKIE = 'cg.sid.v2';

// ê´€ë¦¬ì ê¶Œí•œ í™•ì¸ (ìœ„ì™€ ë™ì¼)
async function checkAdminAuth() {
  const sid = cookies().get(SESSION_COOKIE)?.value;
  if (!sid) return null;

  try {
    const session = await prisma.session.findUnique({
      where: { id: sid },
      include: {
        User: {
          select: { id: true, role: true, name: true },
        },
      },
    });

    if (!session || !session.User) return null;
    if (session.User.role !== 'admin') return null;
    return session.User;
  } catch (error) {
    console.error('[Reject Sale] Auth error:', error);
    return null;
  }
}

/**
 * POST: íŒë§¤ í™•ì • ê±°ë¶€
 */
export async function POST(
  req: NextRequest,
  { params }: { params: { saleId: string } }
) {
  try {
    // 1. ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
    const admin = await checkAdminAuth();
    if (!admin) {
      return NextResponse.json(
        { ok: false, error: 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤' },
        { status: 403 }
      );
    }

    // 2. íŒë§¤ ID í™•ì¸
    const saleId = parseInt(params.saleId);
    if (isNaN(saleId)) {
      return NextResponse.json(
        { ok: false, error: 'ì˜¬ë°”ë¥¸ íŒë§¤ IDê°€ ì•„ë‹™ë‹ˆë‹¤' },
        { status: 400 }
      );
    }

    // 3. ê±°ë¶€ ì‚¬ìœ  ë°›ê¸°
    const body = await req.json();
    const { reason } = body;

    if (!reason || reason.trim().length === 0) {
      return NextResponse.json(
        { ok: false, error: 'ê±°ë¶€ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”' },
        { status: 400 }
      );
    }

    // 4. íŒë§¤ ì •ë³´ í™•ì¸
    const sale = await prisma.affiliateSale.findUnique({
      where: { id: saleId },
      select: {
        id: true,
        status: true,
      },
    });

    if (!sale) {
      return NextResponse.json(
        { ok: false, error: 'íŒë§¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' },
        { status: 404 }
      );
    }

    if (sale.status !== 'PENDING_APPROVAL') {
      return NextResponse.json(
        { ok: false, error: 'ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ íŒë§¤ë§Œ ê±°ë¶€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤' },
        { status: 400 }
      );
    }

    // 5. íŒë§¤ ê±°ë¶€ ì²˜ë¦¬
    const updatedSale = await prisma.affiliateSale.update({
      where: { id: saleId },
      data: {
        status: 'REJECTED',
        rejectedById: admin.id,
        rejectedAt: new Date(),
        rejectionReason: reason.trim(),
        // ìƒíƒœë¥¼ PENDINGìœ¼ë¡œ ë˜ëŒë ¤ì„œ ì¬ìš”ì²­ ê°€ëŠ¥í•˜ê²Œ
        submittedAt: null,
        submittedById: null,
      },
    });

    return NextResponse.json({
      ok: true,
      message: 'íŒë§¤ê°€ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤',
      sale: {
        id: updatedSale.id,
        status: updatedSale.status,
        rejectionReason: updatedSale.rejectionReason,
      },
    });
  } catch (error: any) {
    console.error('[Reject Sale] Error:', error);
    return NextResponse.json(
      { ok: false, error: error.message || 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' },
      { status: 500 }
    );
  }
}
```

#### 5-3. ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡ ì¡°íšŒ API

**ìƒˆ íŒŒì¼ ìƒì„±**: `app/api/admin/affiliate/sales/pending-approval/route.ts`

```typescript
// app/api/admin/affiliate/sales/pending-approval/route.ts
// ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ íŒë§¤ ëª©ë¡ ì¡°íšŒ

import { NextRequest, NextResponse } from 'next/server';
import { cookies } from 'next/headers';
import prisma from '@/lib/prisma';

const SESSION_COOKIE = 'cg.sid.v2';

// ê´€ë¦¬ì ê¶Œí•œ í™•ì¸ (ìœ„ì™€ ë™ì¼)
async function checkAdminAuth() {
  const sid = cookies().get(SESSION_COOKIE)?.value;
  if (!sid) return null;

  try {
    const session = await prisma.session.findUnique({
      where: { id: sid },
      include: {
        User: {
          select: { id: true, role: true },
        },
      },
    });

    if (!session || !session.User) return null;
    if (session.User.role !== 'admin') return null;
    return session.User;
  } catch (error) {
    return null;
  }
}

/**
 * GET: ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ íŒë§¤ ëª©ë¡
 */
export async function GET(req: NextRequest) {
  try {
    // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
    const admin = await checkAdminAuth();
    if (!admin) {
      return NextResponse.json(
        { ok: false, error: 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤' },
        { status: 403 }
      );
    }

    // ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ íŒë§¤ ì¡°íšŒ
    const pendingSales = await prisma.affiliateSale.findMany({
      where: {
        status: 'PENDING_APPROVAL',
      },
      include: {
        agent: {
          select: {
            id: true,
            displayName: true,
            affiliateCode: true,
            type: true,
            user: {
              select: {
                id: true,
                name: true,
                phone: true,
              },
            },
          },
        },
        manager: {
          select: {
            id: true,
            displayName: true,
            affiliateCode: true,
            type: true,
            user: {
              select: {
                id: true,
                name: true,
                phone: true,
              },
            },
          },
        },
        product: {
          select: {
            productCode: true,
            title: true,
          },
        },
      },
      orderBy: {
        submittedAt: 'asc', // ì˜¤ë˜ëœ ê²ƒë¶€í„°
      },
    });

    return NextResponse.json({
      ok: true,
      sales: pendingSales.map((sale) => ({
        id: sale.id,
        productCode: sale.productCode,
        productTitle: sale.product?.title,
        saleAmount: sale.saleAmount,
        saleDate: sale.saleDate,
        submittedAt: sale.submittedAt,
        audioFileGoogleDriveUrl: sale.audioFileGoogleDriveUrl,
        audioFileName: sale.audioFileName,
        agent: sale.agent
          ? {
              name: sale.agent.displayName || sale.agent.user?.name,
              code: sale.agent.affiliateCode,
              phone: sale.agent.user?.phone,
            }
          : null,
        manager: sale.manager
          ? {
              name: sale.manager.displayName || sale.manager.user?.name,
              code: sale.manager.affiliateCode,
              phone: sale.manager.user?.phone,
            }
          : null,
      })),
      count: pendingSales.length,
    });
  } catch (error: any) {
    console.error('[Pending Approval] Error:', error);
    return NextResponse.json(
      { ok: false, error: error.message || 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' },
      { status: 500 }
    );
  }
}
```

### ğŸ“Œ ì„¤ëª…
- **ìŠ¹ì¸ API**: íŒë§¤ë¥¼ ìŠ¹ì¸í•˜ê³  ìˆ˜ë‹¹ì„ ìë™ ê³„ì‚°í•©ë‹ˆë‹¤
- **ê±°ë¶€ API**: íŒë§¤ë¥¼ ê±°ë¶€í•˜ê³  ì‚¬ìœ ë¥¼ ì €ì¥í•©ë‹ˆë‹¤ (ì¬ìš”ì²­ ê°€ëŠ¥)
- **ëª©ë¡ API**: ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ ëª¨ë“  íŒë§¤ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤

---

## 6. 5ë‹¨ê³„: UI ë§Œë“¤ê¸°

### ğŸ“ ì„¤ëª…
ì‚¬ìš©ìê°€ ì‰½ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” í™”ë©´ì„ ë§Œë“­ë‹ˆë‹¤. ë‹¨ê³„ë³„ë¡œ í•˜ë‚˜ì”© ë§Œë“¤ì–´ë´…ì‹œë‹¤.

### ğŸ”§ ì‘ì—… ë‚´ìš©

#### 6-1. íŒë§¤ í™•ì • ìš”ì²­ ëª¨ë‹¬ ì»´í¬ë„ŒíŠ¸ ë§Œë“¤ê¸°

**ìƒˆ íŒŒì¼ ìƒì„±**: `components/affiliate/SalesConfirmationModal.tsx`

ì´ ì»´í¬ë„ŒíŠ¸ëŠ” íŒë§¤ì›/ëŒ€ë¦¬ì ì¥ì´ ì‚¬ìš©í•©ë‹ˆë‹¤.

```typescript
'use client';

import { useState, useRef } from 'react';
import { FiUpload, FiX, FiCheckCircle, FiAlertCircle } from 'react-icons/fi';
import { showError, showSuccess } from '@/components/ui/Toast';

interface SalesConfirmationModalProps {
  saleId: number;
  currentStatus: string;
  audioFileUrl?: string | null;
  onClose: () => void;
  onSuccess: () => void;
}

export default function SalesConfirmationModal({
  saleId,
  currentStatus,
  audioFileUrl,
  onClose,
  onSuccess,
}: SalesConfirmationModalProps) {
  const [audioFile, setAudioFile] = useState<File | null>(null);
  const [isUploading, setIsUploading] = useState(false);
  const fileInputRef = useRef<HTMLInputElement>(null);

  // íŒŒì¼ ì„ íƒ
  const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    // íŒŒì¼ í¬ê¸° í™•ì¸ (50MB)
    if (file.size > 50 * 1024 * 1024) {
      showError('íŒŒì¼ í¬ê¸°ëŠ” 50MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
      return;
    }

    // íŒŒì¼ í˜•ì‹ í™•ì¸
    const allowedTypes = ['audio/mpeg', 'audio/mp3', 'audio/wav', 'audio/m4a', 'audio/x-m4a'];
    if (!allowedTypes.includes(file.type)) {
      showError('ì§€ì›í•˜ëŠ” íŒŒì¼ í˜•ì‹: MP3, WAV, M4A');
      return;
    }

    setAudioFile(file);
  };

  // íŒë§¤ í™•ì • ìš”ì²­ ì œì¶œ
  const handleSubmit = async () => {
    if (!audioFile) {
      showError('ë…¹ìŒ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
      return;
    }

    setIsUploading(true);
    try {
      const formData = new FormData();
      formData.append('audioFile', audioFile);

      const response = await fetch(`/api/affiliate/sales/${saleId}/submit-confirmation`, {
        method: 'POST',
        body: formData,
        credentials: 'include',
      });

      const data = await response.json();

      if (response.ok && data.ok) {
        showSuccess('íŒë§¤ í™•ì • ìš”ì²­ì´ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤');
        onSuccess();
        onClose();
      } else {
        showError(data.error || 'ìš”ì²­ ì œì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
      }
    } catch (error: any) {
      console.error('[Sales Confirmation] Submit error:', error);
      showError('ìš”ì²­ ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    } finally {
      setIsUploading(false);
    }
  };

  // ìš”ì²­ ì·¨ì†Œ (PENDING_APPROVAL ìƒíƒœì¼ ë•Œë§Œ)
  const handleCancel = async () => {
    if (!confirm('íŒë§¤ í™•ì • ìš”ì²­ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      return;
    }

    try {
      const response = await fetch(`/api/affiliate/sales/${saleId}/cancel-confirmation`, {
        method: 'POST',
        credentials: 'include',
      });

      const data = await response.json();

      if (response.ok && data.ok) {
        showSuccess('ìš”ì²­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤');
        onSuccess();
        onClose();
      } else {
        showError(data.error || 'ìš”ì²­ ì·¨ì†Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
      }
    } catch (error: any) {
      console.error('[Sales Confirmation] Cancel error:', error);
      showError('ìš”ì²­ ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    }
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
        {/* í—¤ë” */}
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-xl font-bold text-gray-800">íŒë§¤ í™•ì • ìš”ì²­</h2>
          <button
            onClick={onClose}
            className="text-gray-500 hover:text-gray-700"
          >
            <FiX className="w-6 h-6" />
          </button>
        </div>

        {/* ìƒíƒœ í‘œì‹œ */}
        {currentStatus === 'PENDING_APPROVAL' && (
          <div className="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
            <div className="flex items-center gap-2 text-yellow-800">
              <FiAlertCircle className="w-5 h-5" />
              <span className="font-semibold">ìŠ¹ì¸ ëŒ€ê¸° ì¤‘</span>
            </div>
            {audioFileUrl && (
              <a
                href={audioFileUrl}
                target="_blank"
                rel="noopener noreferrer"
                className="mt-2 text-sm text-yellow-700 hover:text-yellow-900 underline"
              >
                ë…¹ìŒ íŒŒì¼ í™•ì¸í•˜ê¸°
              </a>
            )}
          </div>
        )}

        {currentStatus === 'APPROVED' && (
          <div className="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg">
            <div className="flex items-center gap-2 text-green-800">
              <FiCheckCircle className="w-5 h-5" />
              <span className="font-semibold">ìŠ¹ì¸ ì™„ë£Œ</span>
            </div>
          </div>
        )}

        {currentStatus === 'REJECTED' && (
          <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg">
            <div className="flex items-center gap-2 text-red-800">
              <FiAlertCircle className="w-5 h-5" />
              <span className="font-semibold">ê±°ë¶€ë¨</span>
            </div>
            <p className="mt-2 text-sm text-red-700">
              ê±°ë¶€ ì‚¬ìœ ë¥¼ í™•ì¸í•˜ê³  ìˆ˜ì • í›„ ë‹¤ì‹œ ì œì¶œí•´ì£¼ì„¸ìš”.
            </p>
          </div>
        )}

        {/* íŒŒì¼ ì—…ë¡œë“œ (PENDING ë˜ëŠ” REJECTED ìƒíƒœì¼ ë•Œë§Œ) */}
        {(currentStatus === 'PENDING' || currentStatus === 'REJECTED') && (
          <div className="space-y-4">
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                ê³ ê°ê³¼ì˜ í†µí™” ë…¹ìŒ íŒŒì¼
              </label>
              <div className="border-2 border-dashed border-gray-300 rounded-lg p-4">
                <input
                  ref={fileInputRef}
                  type="file"
                  accept="audio/mpeg,audio/mp3,audio/wav,audio/m4a"
                  onChange={handleFileSelect}
                  className="hidden"
                />
                {audioFile ? (
                  <div className="space-y-2">
                    <p className="text-sm text-gray-700">{audioFile.name}</p>
                    <p className="text-xs text-gray-500">
                      í¬ê¸°: {(audioFile.size / 1024 / 1024).toFixed(2)} MB
                    </p>
                    <button
                      onClick={() => {
                        setAudioFile(null);
                        if (fileInputRef.current) {
                          fileInputRef.current.value = '';
                        }
                      }}
                      className="text-sm text-red-600 hover:text-red-700"
                    >
                      íŒŒì¼ ì œê±°
                    </button>
                  </div>
                ) : (
                  <button
                    onClick={() => fileInputRef.current?.click()}
                    className="w-full flex flex-col items-center justify-center py-4 text-gray-500 hover:text-gray-700"
                  >
                    <FiUpload className="w-8 h-8 mb-2" />
                    <span className="text-sm">ë…¹ìŒ íŒŒì¼ ì„ íƒ</span>
                    <span className="text-xs mt-1">MP3, WAV, M4A (ìµœëŒ€ 50MB)</span>
                  </button>
                )}
              </div>
            </div>

            <div className="flex gap-2">
              <button
                onClick={handleSubmit}
                disabled={!audioFile || isUploading}
                className="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                {isUploading ? 'ì—…ë¡œë“œ ì¤‘...' : 'ìš”ì²­ ì œì¶œ'}
              </button>
              <button
                onClick={onClose}
                className="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
              >
                ì·¨ì†Œ
              </button>
            </div>
          </div>
        )}

        {/* ì·¨ì†Œ ë²„íŠ¼ (PENDING_APPROVAL ìƒíƒœì¼ ë•Œë§Œ) */}
        {currentStatus === 'PENDING_APPROVAL' && (
          <div className="mt-4">
            <button
              onClick={handleCancel}
              className="w-full px-4 py-2 border border-red-300 text-red-600 rounded-lg hover:bg-red-50"
            >
              ìš”ì²­ ì·¨ì†Œ
            </button>
          </div>
        )}
      </div>
    </div>
  );
}
```

#### 6-2. ìš”ì²­ ì·¨ì†Œ API ë§Œë“¤ê¸°

**ìƒˆ íŒŒì¼ ìƒì„±**: `app/api/affiliate/sales/[saleId]/cancel-confirmation/route.ts`

```typescript
// app/api/affiliate/sales/[saleId]/cancel-confirmation/route.ts
// íŒë§¤ í™•ì • ìš”ì²­ ì·¨ì†Œ API

import { NextRequest, NextResponse } from 'next/server';
import { cookies } from 'next/headers';
import prisma from '@/lib/prisma';

const SESSION_COOKIE = 'cg.sid.v2';

// ì„¸ì…˜ì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ìœ„ì™€ ë™ì¼)
async function getCurrentUser() {
  const sid = cookies().get(SESSION_COOKIE)?.value;
  if (!sid) return null;

  try {
    const session = await prisma.session.findUnique({
      where: { id: sid },
      include: {
        User: {
          select: { id: true, role: true },
        },
      },
    });

    if (!session || !session.User) return null;
    return session.User;
  } catch (error) {
    return null;
  }
}

/**
 * POST: íŒë§¤ í™•ì • ìš”ì²­ ì·¨ì†Œ
 */
export async function POST(
  req: NextRequest,
  { params }: { params: { saleId: string } }
) {
  try {
    // 1. ì‚¬ìš©ì í™•ì¸
    const user = await getCurrentUser();
    if (!user) {
      return NextResponse.json(
        { ok: false, error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' },
        { status: 401 }
      );
    }

    // 2. íŒë§¤ ID í™•ì¸
    const saleId = parseInt(params.saleId);
    if (isNaN(saleId)) {
      return NextResponse.json(
        { ok: false, error: 'ì˜¬ë°”ë¥¸ íŒë§¤ IDê°€ ì•„ë‹™ë‹ˆë‹¤' },
        { status: 400 }
      );
    }

    // 3. íŒë§¤ ì •ë³´ í™•ì¸
    const sale = await prisma.affiliateSale.findUnique({
      where: { id: saleId },
      include: {
        agent: {
          select: { userId: true },
        },
        manager: {
          select: { userId: true },
        },
      },
    });

    if (!sale) {
      return NextResponse.json(
        { ok: false, error: 'íŒë§¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' },
        { status: 404 }
      );
    }

    // 4. ê¶Œí•œ í™•ì¸ (ë³¸ì¸ì´ ì œì¶œí•œ ìš”ì²­ë§Œ ì·¨ì†Œ ê°€ëŠ¥)
    if (sale.submittedById !== user.id) {
      return NextResponse.json(
        { ok: false, error: 'ë³¸ì¸ì´ ì œì¶œí•œ ìš”ì²­ë§Œ ì·¨ì†Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤' },
        { status: 403 }
      );
    }

    // 5. ìƒíƒœ í™•ì¸ (PENDING_APPROVALë§Œ ì·¨ì†Œ ê°€ëŠ¥)
    if (sale.status !== 'PENDING_APPROVAL') {
      return NextResponse.json(
        { ok: false, error: 'ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ ìš”ì²­ë§Œ ì·¨ì†Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤' },
        { status: 400 }
      );
    }

    // 6. ìš”ì²­ ì·¨ì†Œ ì²˜ë¦¬ (ìƒíƒœë¥¼ PENDINGìœ¼ë¡œ ë˜ëŒë¦¼)
    const updatedSale = await prisma.affiliateSale.update({
      where: { id: saleId },
      data: {
        status: 'PENDING',
        submittedAt: null,
        submittedById: null,
        // Google Drive íŒŒì¼ì€ ê·¸ëŒ€ë¡œ ìœ ì§€ (ë‚˜ì¤‘ì— ì¬ì‚¬ìš© ê°€ëŠ¥)
      },
    });

    return NextResponse.json({
      ok: true,
      message: 'ìš”ì²­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤',
      sale: {
        id: updatedSale.id,
        status: updatedSale.status,
      },
    });
  } catch (error: any) {
    console.error('[Cancel Confirmation] Error:', error);
    return NextResponse.json(
      { ok: false, error: error.message || 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' },
      { status: 500 }
    );
  }
}
```

#### 6-3. íŒë§¤ì›/ëŒ€ë¦¬ì ì¥ ëŒ€ì‹œë³´ë“œì— í†µí•©

**íŒŒì¼**: `app/partner/[partnerId]/dashboard/PartnerDashboard.tsx`

**ì¶”ê°€í•  ë‚´ìš©**:

1. **ìƒíƒœ ë³€ìˆ˜ ì¶”ê°€** (íŒŒì¼ ìƒë‹¨, ë‹¤ë¥¸ useState ê·¼ì²˜):
```typescript
const [showSalesConfirmationModal, setShowSalesConfirmationModal] = useState(false);
const [selectedSaleForConfirmation, setSelectedSaleForConfirmation] = useState<{
  id: number;
  status: string;
  audioFileUrl?: string | null;
} | null>(null);
```

2. **íŒë§¤ ëª©ë¡ API í˜¸ì¶œ í•¨ìˆ˜ ì¶”ê°€**:
```typescript
const [mySales, setMySales] = useState<Array<{
  id: number;
  productCode: string;
  saleAmount: number;
  status: string;
  audioFileGoogleDriveUrl: string | null;
  saleDate: string | null;
}>>([]);

const loadMySales = async () => {
  try {
    const response = await fetch('/api/affiliate/sales/my-sales', {
      credentials: 'include',
    });
    const data = await response.json();
    if (response.ok && data.ok) {
      setMySales(data.sales || []);
    }
  } catch (error) {
    console.error('[PartnerDashboard] Failed to load sales:', error);
  }
};

// useEffectì— ì¶”ê°€
useEffect(() => {
  loadStats();
  loadMyContract();
  loadMySales(); // ì¶”ê°€
  if (isBranchManager) {
    loadContracts();
  }
}, [isBranchManager, loadMyContract]);
```

3. **íŒë§¤ ëª©ë¡ ì„¹ì…˜ ì¶”ê°€** (ëŒ€ì‹œë³´ë“œ JSX ë¶€ë¶„):
```typescript
{/* íŒë§¤ ëª©ë¡ ì„¹ì…˜ */}
<div className="bg-white rounded-lg shadow-md p-6">
  <h2 className="text-xl font-bold text-gray-800 mb-4">ë‚´ íŒë§¤ ëª©ë¡</h2>
  {mySales.length === 0 ? (
    <p className="text-gray-500">íŒë§¤ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p>
  ) : (
    <div className="space-y-3">
      {mySales.map((sale) => {
        const statusBadge = {
          PENDING: { label: 'í™•ì • ëŒ€ê¸°', color: 'bg-gray-100 text-gray-800' },
          PENDING_APPROVAL: { label: 'ìŠ¹ì¸ ëŒ€ê¸°', color: 'bg-yellow-100 text-yellow-800' },
          APPROVED: { label: 'ìŠ¹ì¸ ì™„ë£Œ', color: 'bg-green-100 text-green-800' },
          REJECTED: { label: 'ê±°ë¶€ë¨', color: 'bg-red-100 text-red-800' },
        }[sale.status] || { label: sale.status, color: 'bg-gray-100 text-gray-800' };

        return (
          <div key={sale.id} className="border border-gray-200 rounded-lg p-4">
            <div className="flex items-center justify-between">
              <div className="flex-1">
                <div className="flex items-center gap-3 mb-2">
                  <span className="font-semibold text-gray-800">#{sale.id}</span>
                  <span className={`px-2 py-1 rounded-full text-xs font-semibold ${statusBadge.color}`}>
                    {statusBadge.label}
                  </span>
                </div>
                <p className="text-sm text-gray-600">
                  ìƒí’ˆ: {sale.productCode} | ê¸ˆì•¡: {(sale.saleAmount / 10000).toLocaleString()}ë§Œì›
                </p>
              </div>
              <button
                onClick={() => {
                  setSelectedSaleForConfirmation({
                    id: sale.id,
                    status: sale.status,
                    audioFileUrl: sale.audioFileGoogleDriveUrl,
                  });
                  setShowSalesConfirmationModal(true);
                }}
                className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-semibold"
              >
                {sale.status === 'PENDING' || sale.status === 'REJECTED' ? 'í™•ì • ìš”ì²­' : 'ìƒì„¸ ë³´ê¸°'}
              </button>
            </div>
          </div>
        );
      })}
    </div>
  )}
</div>
```

4. **ëª¨ë‹¬ ì»´í¬ë„ŒíŠ¸ ì¶”ê°€** (íŒŒì¼ ë, return ë¬¸ ì•ˆ):
```typescript
{/* íŒë§¤ í™•ì • ëª¨ë‹¬ */}
{showSalesConfirmationModal && selectedSaleForConfirmation && (
  <SalesConfirmationModal
    saleId={selectedSaleForConfirmation.id}
    currentStatus={selectedSaleForConfirmation.status}
    audioFileUrl={selectedSaleForConfirmation.audioFileUrl}
    onClose={() => {
      setShowSalesConfirmationModal(false);
      setSelectedSaleForConfirmation(null);
    }}
    onSuccess={() => {
      loadMySales(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
    }}
  />
)}
```

5. **import ì¶”ê°€** (íŒŒì¼ ìƒë‹¨):
```typescript
import SalesConfirmationModal from '@/components/affiliate/SalesConfirmationModal';
```

**ì¶”ê°€ë¡œ í•„ìš”í•œ API**: `app/api/affiliate/sales/my-sales/route.ts`

```typescript
// app/api/affiliate/sales/my-sales/route.ts
// ë‚´ íŒë§¤ ëª©ë¡ ì¡°íšŒ API

import { NextRequest, NextResponse } from 'next/server';
import { cookies } from 'next/headers';
import prisma from '@/lib/prisma';

const SESSION_COOKIE = 'cg.sid.v2';

async function getCurrentUser() {
  const sid = cookies().get(SESSION_COOKIE)?.value;
  if (!sid) return null;

  try {
    const session = await prisma.session.findUnique({
      where: { id: sid },
      include: {
        User: {
          select: { id: true },
        },
      },
    });
    return session?.User || null;
  } catch (error) {
    return null;
  }
}

export async function GET(req: NextRequest) {
  try {
    const user = await getCurrentUser();
    if (!user) {
      return NextResponse.json({ ok: false, error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, { status: 401 });
    }

    // ì‚¬ìš©ìì˜ ì–´í•„ë¦¬ì—ì´íŠ¸ í”„ë¡œí•„ ì°¾ê¸°
    const profile = await prisma.affiliateProfile.findUnique({
      where: { userId: user.id },
      select: { id: true, type: true },
    });

    if (!profile) {
      return NextResponse.json({ ok: true, sales: [] });
    }

    // ë³¸ì¸ íŒë§¤ë§Œ ì¡°íšŒ
    const where: any = {};
    if (profile.type === 'SALES_AGENT') {
      where.agentId = profile.id;
    } else if (profile.type === 'BRANCH_MANAGER') {
      where.managerId = profile.id;
    } else {
      return NextResponse.json({ ok: true, sales: [] });
    }

    const sales = await prisma.affiliateSale.findMany({
      where,
      select: {
        id: true,
        productCode: true,
        saleAmount: true,
        status: true,
        audioFileGoogleDriveUrl: true,
        saleDate: true,
        submittedAt: true,
        approvedAt: true,
      },
      orderBy: {
        createdAt: 'desc',
      },
      take: 50, // ìµœê·¼ 50ê°œë§Œ
    });

    return NextResponse.json({
      ok: true,
      sales,
    });
  } catch (error: any) {
    console.error('[My Sales] Error:', error);
    return NextResponse.json(
      { ok: false, error: error.message || 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' },
      { status: 500 }
    );
  }
}
```

#### 6-4. ê´€ë¦¬ì ìŠ¹ì¸ ëŒ€ê¸° í˜ì´ì§€

**ìƒˆ íŒŒì¼ ìƒì„±**: `app/admin/affiliate/sales/pending-approval/page.tsx`

```typescript
'use client';

import { useState, useEffect } from 'react';
import { FiCheckCircle, FiXCircle, FiExternalLink, FiRefreshCw, FiClock } from 'react-icons/fi';
import { showError, showSuccess } from '@/components/ui/Toast';

interface PendingSale {
  id: number;
  productCode: string;
  productTitle: string | null;
  saleAmount: number;
  saleDate: string | null;
  submittedAt: string;
  audioFileGoogleDriveUrl: string | null;
  audioFileName: string | null;
  agent: {
    name: string | null;
    code: string;
    phone: string | null;
  } | null;
  manager: {
    name: string | null;
    code: string;
    phone: string | null;
  } | null;
}

export default function PendingApprovalPage() {
  const [sales, setSales] = useState<PendingSale[]>([]);
  const [loading, setLoading] = useState(true);
  const [approvingId, setApprovingId] = useState<number | null>(null);
  const [rejectingId, setRejectingId] = useState<number | null>(null);
  const [rejectReason, setRejectReason] = useState('');
  const [showRejectModal, setShowRejectModal] = useState<number | null>(null);

  // ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
  const loadPendingSales = async () => {
    try {
      setLoading(true);
      const response = await fetch('/api/admin/affiliate/sales/pending-approval', {
        credentials: 'include',
      });
      const data = await response.json();

      if (response.ok && data.ok) {
        setSales(data.sales || []);
      } else {
        showError(data.error || 'ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
      }
    } catch (error: any) {
      console.error('[Pending Approval] Load error:', error);
      showError('ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    loadPendingSales();
  }, []);

  // ìŠ¹ì¸ ì²˜ë¦¬
  const handleApprove = async (saleId: number) => {
    if (!confirm('ì´ íŒë§¤ë¥¼ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ìŠ¹ì¸ ì‹œ ìˆ˜ë‹¹ì´ ìë™ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤.')) {
      return;
    }

    try {
      setApprovingId(saleId);
      const response = await fetch(`/api/admin/affiliate/sales/${saleId}/approve`, {
        method: 'POST',
        credentials: 'include',
      });
      const data = await response.json();

      if (response.ok && data.ok) {
        showSuccess('íŒë§¤ê°€ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤');
        loadPendingSales(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
      } else {
        showError(data.error || 'ìŠ¹ì¸ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
      }
    } catch (error: any) {
      console.error('[Pending Approval] Approve error:', error);
      showError('ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    } finally {
      setApprovingId(null);
    }
  };

  // ê±°ë¶€ ì²˜ë¦¬
  const handleReject = async (saleId: number) => {
    if (!rejectReason.trim()) {
      showError('ê±°ë¶€ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
      return;
    }

    try {
      setRejectingId(saleId);
      const response = await fetch(`/api/admin/affiliate/sales/${saleId}/reject`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ reason: rejectReason }),
      });
      const data = await response.json();

      if (response.ok && data.ok) {
        showSuccess('íŒë§¤ê°€ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤');
        setShowRejectModal(null);
        setRejectReason('');
        loadPendingSales(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
      } else {
        showError(data.error || 'ê±°ë¶€ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
      }
    } catch (error: any) {
      console.error('[Pending Approval] Reject error:', error);
      showError('ê±°ë¶€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    } finally {
      setRejectingId(null);
    }
  };

  // ê¸ˆì•¡ í¬ë§·íŒ…
  const formatAmount = (amount: number) => {
    return `${(amount / 10000).toLocaleString()}ë§Œì›`;
  };

  // ë‚ ì§œ í¬ë§·íŒ…
  const formatDate = (dateString: string | null) => {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleDateString('ko-KR', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
    });
  };

  return (
    <div className="space-y-6 p-6">
      {/* í—¤ë” */}
      <div className="bg-white rounded-lg shadow-md p-6">
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-3xl font-bold text-gray-800 mb-2">
              â³ íŒë§¤ í™•ì • ìŠ¹ì¸ ëŒ€ê¸°
            </h1>
            <p className="text-gray-600">
              ë…¹ìŒ íŒŒì¼ì„ í™•ì¸í•˜ê³  íŒë§¤ í™•ì •ì„ ìŠ¹ì¸í•˜ê±°ë‚˜ ê±°ë¶€í•˜ì„¸ìš”.
            </p>
          </div>
          <button
            onClick={loadPendingSales}
            disabled={loading}
            className="inline-flex items-center gap-2 rounded-lg bg-gray-100 px-4 py-2 text-sm font-semibold text-gray-700 hover:bg-gray-200 disabled:opacity-50"
          >
            <FiRefreshCw className={loading ? 'animate-spin' : ''} />
            ìƒˆë¡œê³ ì¹¨
          </button>
        </div>
      </div>

      {/* ëª©ë¡ */}
      {loading ? (
        <div className="text-center py-12">
          <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
          <p className="mt-2 text-gray-600">ë¡œë”© ì¤‘...</p>
        </div>
      ) : sales.length === 0 ? (
        <div className="bg-white rounded-lg shadow-md p-12 text-center">
          <FiCheckCircle className="w-16 h-16 text-green-500 mx-auto mb-4" />
          <p className="text-xl font-semibold text-gray-800">ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ íŒë§¤ê°€ ì—†ìŠµë‹ˆë‹¤</p>
          <p className="text-gray-600 mt-2">ëª¨ë“  íŒë§¤ê°€ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
        </div>
      ) : (
        <div className="space-y-4">
          {sales.map((sale) => (
            <div key={sale.id} className="bg-white rounded-lg shadow-md p-6">
              <div className="flex items-start justify-between">
                {/* ì™¼ìª½: íŒë§¤ ì •ë³´ */}
                <div className="flex-1">
                  <div className="flex items-center gap-3 mb-3">
                    <span className="text-2xl font-bold text-blue-600">#{sale.id}</span>
                    <span className="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm font-semibold">
                      ìŠ¹ì¸ ëŒ€ê¸° ì¤‘
                    </span>
                  </div>

                  <div className="grid grid-cols-2 gap-4 mb-4">
                    <div>
                      <p className="text-sm text-gray-500">ìƒí’ˆ</p>
                      <p className="font-semibold text-gray-800">
                        {sale.productTitle || sale.productCode}
                      </p>
                    </div>
                    <div>
                      <p className="text-sm text-gray-500">íŒë§¤ ê¸ˆì•¡</p>
                      <p className="font-semibold text-gray-800">{formatAmount(sale.saleAmount)}</p>
                    </div>
                    <div>
                      <p className="text-sm text-gray-500">ìš”ì²­ ì œì¶œ ì‹œê°„</p>
                      <p className="font-semibold text-gray-800">{formatDate(sale.submittedAt)}</p>
                    </div>
                    <div>
                      <p className="text-sm text-gray-500">ë‹´ë‹¹ì</p>
                      <p className="font-semibold text-gray-800">
                        {sale.agent
                          ? `íŒë§¤ì›: ${sale.agent.name || 'ì´ë¦„ ì—†ìŒ'} (${sale.agent.code})`
                          : sale.manager
                          ? `ëŒ€ë¦¬ì ì¥: ${sale.manager.name || 'ì´ë¦„ ì—†ìŒ'} (${sale.manager.code})`
                          : 'ë‹´ë‹¹ì ì—†ìŒ'}
                      </p>
                    </div>
                  </div>

                  {/* ë…¹ìŒ íŒŒì¼ ë§í¬ */}
                  {sale.audioFileGoogleDriveUrl && (
                    <div className="mb-4">
                      <a
                        href={sale.audioFileGoogleDriveUrl}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="inline-flex items-center gap-2 text-blue-600 hover:text-blue-700 font-semibold"
                      >
                        <FiExternalLink />
                        ë…¹ìŒ íŒŒì¼ í™•ì¸í•˜ê¸° (Google Drive)
                        {sale.audioFileName && (
                          <span className="text-sm text-gray-500">({sale.audioFileName})</span>
                        )}
                      </a>
                    </div>
                  )}
                </div>

                {/* ì˜¤ë¥¸ìª½: ì•¡ì…˜ ë²„íŠ¼ */}
                <div className="flex flex-col gap-2 ml-6">
                  <button
                    onClick={() => handleApprove(sale.id)}
                    disabled={approvingId === sale.id}
                    className="inline-flex items-center justify-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed min-w-[120px]"
                  >
                    {approvingId === sale.id ? (
                      <>
                        <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                        ìŠ¹ì¸ ì¤‘...
                      </>
                    ) : (
                      <>
                        <FiCheckCircle />
                        ìŠ¹ì¸
                      </>
                    )}
                  </button>
                  <button
                    onClick={() => setShowRejectModal(sale.id)}
                    disabled={rejectingId === sale.id}
                    className="inline-flex items-center justify-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed min-w-[120px]"
                  >
                    <FiXCircle />
                    ê±°ë¶€
                  </button>
                </div>
              </div>
            </div>
          ))}
        </div>
      )}

      {/* ê±°ë¶€ ì‚¬ìœ  ì…ë ¥ ëª¨ë‹¬ */}
      {showRejectModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
            <h3 className="text-xl font-bold text-gray-800 mb-4">ê±°ë¶€ ì‚¬ìœ  ì…ë ¥</h3>
            <textarea
              value={rejectReason}
              onChange={(e) => setRejectReason(e.target.value)}
              placeholder="ê±°ë¶€ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”..."
              className="w-full h-32 border border-gray-300 rounded-lg px-3 py-2 focus:border-red-500 focus:outline-none focus:ring-2 focus:ring-red-100"
            />
            <div className="flex gap-2 mt-4">
              <button
                onClick={() => handleReject(showRejectModal)}
                disabled={!rejectReason.trim() || rejectingId === showRejectModal}
                className="flex-1 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                {rejectingId === showRejectModal ? 'ì²˜ë¦¬ ì¤‘...' : 'ê±°ë¶€í•˜ê¸°'}
              </button>
              <button
                onClick={() => {
                  setShowRejectModal(null);
                  setRejectReason('');
                }}
                className="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
              >
                ì·¨ì†Œ
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
```

### ğŸ“Œ ì„¤ëª…
- ê´€ë¦¬ìê°€ ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ ëª¨ë“  íŒë§¤ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤
- ê° íŒë§¤ë§ˆë‹¤ Google Drive ë§í¬ê°€ ìˆì–´ ë°”ë¡œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
- ìŠ¹ì¸/ê±°ë¶€ ë²„íŠ¼ìœ¼ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
- ê±°ë¶€ ì‹œ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤

---

## 7. 6ë‹¨ê³„: ì•Œë¦¼ ê¸°ëŠ¥ ì¶”ê°€

### ğŸ“ ì„¤ëª…
ìŠ¹ì¸/ê±°ë¶€ ì‹œ íŒë§¤ì›/ëŒ€ë¦¬ì ì¥ì—ê²Œ ì•Œë¦¼ì„ ë³´ëƒ…ë‹ˆë‹¤.

### ğŸ”§ ì‘ì—… ë‚´ìš©

**íŒŒì¼**: `lib/affiliate/sales-notification.ts` (ìƒˆë¡œ ë§Œë“¤ê¸°)

```typescript
// lib/affiliate/sales-notification.ts
// íŒë§¤ í™•ì • ê´€ë ¨ ì•Œë¦¼

import prisma from '@/lib/prisma';
import { sendNotificationToUser } from '@/lib/push/server';

/**
 * íŒë§¤ í™•ì • ìŠ¹ì¸ ì•Œë¦¼
 */
export async function notifySaleApproved(saleId: number) {
  try {
    const sale = await prisma.affiliateSale.findUnique({
      where: { id: saleId },
      include: {
        agent: {
          include: {
            user: {
              select: { id: true, name: true },
            },
          },
        },
        manager: {
          include: {
            user: {
              select: { id: true, name: true },
            },
          },
        },
      },
    });

    if (!sale) return;

    // íŒë§¤ì›ì—ê²Œ ì•Œë¦¼
    if (sale.agentId && sale.agent?.user) {
      await sendNotificationToUser(sale.agent.user.id, {
        title: 'âœ… íŒë§¤ í™•ì • ìŠ¹ì¸',
        body: `íŒë§¤ #${saleId}ì´(ê°€) ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. ìˆ˜ë‹¹ì´ ê³„ì‚°ë˜ì—ˆìŠµë‹ˆë‹¤.`,
        data: { saleId, type: 'sale_approved' },
      });
    }

    // ëŒ€ë¦¬ì ì¥ì—ê²Œ ì•Œë¦¼ (íŒë§¤ì›ì´ ì•„ë‹Œ ê²½ìš°)
    if (sale.managerId && sale.manager?.user && !sale.agentId) {
      await sendNotificationToUser(sale.manager.user.id, {
        title: 'âœ… íŒë§¤ í™•ì • ìŠ¹ì¸',
        body: `íŒë§¤ #${saleId}ì´(ê°€) ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. ìˆ˜ë‹¹ì´ ê³„ì‚°ë˜ì—ˆìŠµë‹ˆë‹¤.`,
        data: { saleId, type: 'sale_approved' },
      });
    }
  } catch (error) {
    console.error('[Notify Sale Approved] Error:', error);
  }
}

/**
 * íŒë§¤ í™•ì • ê±°ë¶€ ì•Œë¦¼
 */
export async function notifySaleRejected(saleId: number, reason: string) {
  try {
    const sale = await prisma.affiliateSale.findUnique({
      where: { id: saleId },
      include: {
        agent: {
          include: {
            user: {
              select: { id: true, name: true },
            },
          },
        },
        manager: {
          include: {
            user: {
              select: { id: true, name: true },
            },
          },
        },
      },
    });

    if (!sale) return;

    // íŒë§¤ì›ì—ê²Œ ì•Œë¦¼
    if (sale.agentId && sale.agent?.user) {
      await sendNotificationToUser(sale.agent.user.id, {
        title: 'âŒ íŒë§¤ í™•ì • ê±°ë¶€',
        body: `íŒë§¤ #${saleId}ì´(ê°€) ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ì‚¬ìœ : ${reason}`,
        data: { saleId, type: 'sale_rejected', reason },
      });
    }

    // ëŒ€ë¦¬ì ì¥ì—ê²Œ ì•Œë¦¼
    if (sale.managerId && sale.manager?.user && !sale.agentId) {
      await sendNotificationToUser(sale.manager.user.id, {
        title: 'âŒ íŒë§¤ í™•ì • ê±°ë¶€',
        body: `íŒë§¤ #${saleId}ì´(ê°€) ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ì‚¬ìœ : ${reason}`,
        data: { saleId, type: 'sale_rejected', reason },
      });
    }
  } catch (error) {
    console.error('[Notify Sale Rejected] Error:', error);
  }
}
```

**ìŠ¹ì¸/ê±°ë¶€ APIì— ì•Œë¦¼ ì¶”ê°€**:

ìŠ¹ì¸ API (`app/api/admin/affiliate/sales/[saleId]/approve/route.ts`)ì— ì¶”ê°€:
```typescript
import { notifySaleApproved } from '@/lib/affiliate/sales-notification';

// ìŠ¹ì¸ ì²˜ë¦¬ í›„:
await notifySaleApproved(saleId);
```

ê±°ë¶€ API (`app/api/admin/affiliate/sales/[saleId]/reject/route.ts`)ì— ì¶”ê°€:
```typescript
import { notifySaleRejected } from '@/lib/affiliate/sales-notification';

// ê±°ë¶€ ì²˜ë¦¬ í›„:
await notifySaleRejected(saleId, reason);
```

---

## 8. í…ŒìŠ¤íŠ¸ ë°©ë²•

### ğŸ“ ë‹¨ê³„ë³„ í…ŒìŠ¤íŠ¸

1. **ë°ì´í„°ë² ì´ìŠ¤ í…ŒìŠ¤íŠ¸**
   - Prisma Studio ì—´ê¸°: `npx prisma studio`
   - AffiliateSale í…Œì´ë¸” í™•ì¸
   - ìƒˆ í•„ë“œë“¤ì´ ì¶”ê°€ë˜ì—ˆëŠ”ì§€ í™•ì¸

2. **íŒŒì¼ ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸**
   - íŒë§¤ í™•ì • ìš”ì²­ API í˜¸ì¶œ
   - Google Driveì— íŒŒì¼ì´ ì—…ë¡œë“œë˜ëŠ”ì§€ í™•ì¸
   - ë§í¬ê°€ ì •ìƒì ìœ¼ë¡œ ìƒì„±ë˜ëŠ”ì§€ í™•ì¸

3. **ìŠ¹ì¸/ê±°ë¶€ í…ŒìŠ¤íŠ¸**
   - ê´€ë¦¬ìë¡œ ë¡œê·¸ì¸
   - ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡ í™•ì¸
   - ìŠ¹ì¸/ê±°ë¶€ ì‹¤í–‰
   - ìˆ˜ë‹¹ ê³„ì‚° í™•ì¸

4. **ì•Œë¦¼ í…ŒìŠ¤íŠ¸**
   - í‘¸ì‹œ ì•Œë¦¼ì´ ì •ìƒì ìœ¼ë¡œ ì „ì†¡ë˜ëŠ”ì§€ í™•ì¸

---

## ğŸ“Œ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •

`.env.local` íŒŒì¼ì— ì¶”ê°€ (ì´ë¯¸ ìˆìœ¼ë©´ í™•ì¸ë§Œ):

```bash
# Google Drive Service Account ì„¤ì • (ì´ë¯¸ ìˆì„ ìˆ˜ ìˆìŒ)
GOOGLE_DRIVE_SERVICE_ACCOUNT_EMAIL=your-service-account@project.iam.gserviceaccount.com
GOOGLE_DRIVE_SERVICE_ACCOUNT_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n"
GOOGLE_DRIVE_SHARED_DRIVE_ID=your_shared_drive_id  # ì„ íƒì‚¬í•­

# ë…¹ìŒ íŒŒì¼ ì €ì¥ í´ë” (ì„ íƒì‚¬í•­, ì—†ìœ¼ë©´ rootì— ì €ì¥)
GOOGLE_DRIVE_SALES_AUDIO_FOLDER_ID=your_folder_id
```

### ğŸ“ Google Drive í´ë” ID ì°¾ëŠ” ë°©ë²•
1. Google Driveì—ì„œ í´ë”ë¥¼ ì—½ë‹ˆë‹¤
2. URLì„ í™•ì¸í•©ë‹ˆë‹¤: `https://drive.google.com/drive/folders/ì—¬ê¸°ê°€í´ë”ID`
3. í´ë” IDë¥¼ ë³µì‚¬í•´ì„œ í™˜ê²½ ë³€ìˆ˜ì— ë„£ìŠµë‹ˆë‹¤

---

## âš ï¸ ì£¼ì˜ì‚¬í•­

1. **Google Drive ê¶Œí•œ**: Service Account ë˜ëŠ” OAuth ì„¤ì • í•„ìš”
2. **íŒŒì¼ í¬ê¸°**: 50MB ì œí•œ í™•ì¸
3. **ì—ëŸ¬ ì²˜ë¦¬**: ëª¨ë“  APIì— ì—ëŸ¬ ì²˜ë¦¬ í¬í•¨
4. **ë³´ì•ˆ**: ê¶Œí•œ í™•ì¸ í•„ìˆ˜

---

## ğŸ‰ ì™„ë£Œ ì²´í¬ë¦¬ìŠ¤íŠ¸

### 1ë‹¨ê³„: ë°ì´í„°ë² ì´ìŠ¤
- [ ] `prisma/schema.prisma`ì— AffiliateSale í•„ë“œ ì¶”ê°€
- [ ] `npx prisma db push` ì‹¤í–‰
- [ ] Prisma Studioë¡œ ìƒˆ í•„ë“œ í™•ì¸

### 2ë‹¨ê³„: Google Drive í•¨ìˆ˜
- [ ] `lib/google-drive.ts`ì— `uploadAudioFileToDrive` í•¨ìˆ˜ ì¶”ê°€
- [ ] í™˜ê²½ ë³€ìˆ˜ ì„¤ì • í™•ì¸

### 3ë‹¨ê³„: API ë§Œë“¤ê¸°
- [ ] `app/api/affiliate/sales/[saleId]/submit-confirmation/route.ts` ìƒì„±
- [ ] `app/api/affiliate/sales/[saleId]/cancel-confirmation/route.ts` ìƒì„±
- [ ] `app/api/admin/affiliate/sales/[saleId]/approve/route.ts` ìƒì„±
- [ ] `app/api/admin/affiliate/sales/[saleId]/reject/route.ts` ìƒì„±
- [ ] `app/api/admin/affiliate/sales/pending-approval/route.ts` ìƒì„±

### 4ë‹¨ê³„: ì•Œë¦¼ ê¸°ëŠ¥
- [ ] `lib/affiliate/sales-notification.ts` ìƒì„±
- [ ] ìŠ¹ì¸ APIì— ì•Œë¦¼ ì¶”ê°€
- [ ] ê±°ë¶€ APIì— ì•Œë¦¼ ì¶”ê°€

### 5ë‹¨ê³„: UI ë§Œë“¤ê¸°
- [ ] `components/affiliate/SalesConfirmationModal.tsx` ìƒì„±
- [ ] `app/admin/affiliate/sales/pending-approval/page.tsx` ìƒì„±
- [ ] íŒë§¤ì›/ëŒ€ë¦¬ì ì¥ ëŒ€ì‹œë³´ë“œì— ëª¨ë‹¬ í†µí•©

### 6ë‹¨ê³„: í…ŒìŠ¤íŠ¸
- [ ] íŒë§¤ í™•ì • ìš”ì²­ í…ŒìŠ¤íŠ¸
- [ ] Google Drive ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸
- [ ] ê´€ë¦¬ì ìŠ¹ì¸/ê±°ë¶€ í…ŒìŠ¤íŠ¸
- [ ] ì•Œë¦¼ ì „ì†¡ í…ŒìŠ¤íŠ¸
- [ ] ìˆ˜ë‹¹ ìë™ ê³„ì‚° í™•ì¸

---

## ğŸ“š êµ¬í˜„ ìš°ì„ ìˆœìœ„ (ë‹¨ê³„ë³„)

### â­ ìµœìš°ì„  (1ì¼ì°¨)
1. **ë°ì´í„°ë² ì´ìŠ¤ ìˆ˜ì •** (30ë¶„)
   - ìŠ¤í‚¤ë§ˆ ìˆ˜ì •
   - ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰

2. **Google Drive í•¨ìˆ˜** (30ë¶„)
   - `uploadAudioFileToDrive` í•¨ìˆ˜ ì¶”ê°€
   - í…ŒìŠ¤íŠ¸

3. **íŒë§¤ í™•ì • ìš”ì²­ API** (1ì‹œê°„)
   - íŒŒì¼ ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸
   - ê¶Œí•œ í™•ì¸ í…ŒìŠ¤íŠ¸

### ğŸ”¥ ì¤‘ìš” (2ì¼ì°¨)
4. **ê´€ë¦¬ì ìŠ¹ì¸/ê±°ë¶€ API** (1ì‹œê°„)
   - ìŠ¹ì¸ API
   - ê±°ë¶€ API
   - ìˆ˜ë‹¹ ê³„ì‚° ì—°ê²°

5. **ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡ API** (30ë¶„)
   - ëª©ë¡ ì¡°íšŒ í…ŒìŠ¤íŠ¸

### ğŸ’¡ ë³´ì™„ (3ì¼ì°¨)
6. **ì•Œë¦¼ ê¸°ëŠ¥** (1ì‹œê°„)
   - ì•Œë¦¼ í•¨ìˆ˜ ë§Œë“¤ê¸°
   - APIì— ì—°ê²°

7. **UI êµ¬í˜„** (2-3ì‹œê°„)
   - ëª¨ë‹¬ ì»´í¬ë„ŒíŠ¸
   - ê´€ë¦¬ì í˜ì´ì§€
   - ëŒ€ì‹œë³´ë“œ í†µí•©

8. **í…ŒìŠ¤íŠ¸ ë° ìˆ˜ì •** (1-2ì‹œê°„)
   - ì „ì²´ í”Œë¡œìš° í…ŒìŠ¤íŠ¸
   - ë²„ê·¸ ìˆ˜ì •

---

## ğŸš¨ ì£¼ì˜ì‚¬í•­ ë° íŒ

### 1. Google Drive ì„¤ì •
- Service Account í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤
- í´ë” IDëŠ” ì„ íƒì‚¬í•­ì…ë‹ˆë‹¤ (ì—†ìœ¼ë©´ rootì— ì €ì¥)
- ê³µê°œ ë§í¬ê°€ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤

### 2. íŒŒì¼ í¬ê¸° ì œí•œ
- ìµœëŒ€ 50MBë¡œ ì œí•œí–ˆìŠµë‹ˆë‹¤
- ë” í° íŒŒì¼ì´ í•„ìš”í•˜ë©´ í™˜ê²½ ë³€ìˆ˜ë¡œ ì¡°ì • ê°€ëŠ¥

### 3. ì—ëŸ¬ ì²˜ë¦¬
- ëª¨ë“  APIì— try-catch ì¶”ê°€í–ˆìŠµë‹ˆë‹¤
- ì‚¬ìš©ìì—ê²Œ ëª…í™•í•œ ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ

### 4. ë³´ì•ˆ
- ë³¸ì¸ íŒë§¤ë§Œ ìš”ì²­ ê°€ëŠ¥
- ê´€ë¦¬ìë§Œ ìŠ¹ì¸/ê±°ë¶€ ê°€ëŠ¥
- ì„¸ì…˜ í™•ì¸ í•„ìˆ˜

### 5. ê¸°ì¡´ ê¸°ëŠ¥ê³¼ì˜ í˜¸í™˜ì„±
- ê¸°ì¡´ `CONFIRMED` ìƒíƒœëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€
- ìƒˆ í”„ë¡œì„¸ìŠ¤ëŠ” `PENDING_APPROVAL` â†’ `APPROVED` ì‚¬ìš©

---

## ğŸ’¬ ì§ˆë¬¸ì´ ìˆìœ¼ë©´?

êµ¬í˜„ ì¤‘ ë¬¸ì œê°€ ìƒê¸°ê±°ë‚˜ ì´í•´ê°€ ì•ˆ ë˜ëŠ” ë¶€ë¶„ì´ ìˆìœ¼ë©´ ì–¸ì œë“ ì§€ ë¬¼ì–´ë³´ì„¸ìš”!

---

## âš ï¸ ê¸°ì¡´ ê´€ë¦¬ì íŒ¨ë„ ì—°ê²° ë¬¸ì œì  í™•ì¸

### ë°œê²¬ëœ ë¬¸ì œì 

1. **ìˆ˜ë‹¹ ì¡°ì • ìŠ¹ì¸ í˜ì´ì§€** (`/admin/affiliate/adjustments`)
   - "êµ¬ë§¤ ì™„ë£Œ ìŠ¹ì¸" íƒ­ì—ì„œ ì‚¬ìš©í•˜ëŠ” `/api/admin/affiliate/sales/[saleId]/approve-commission` API ì¡´ì¬ ì—¬ë¶€ í™•ì¸ í•„ìš”
   - ì´ APIê°€ ì—†ìœ¼ë©´ êµ¬ë§¤ ì™„ë£Œ ìŠ¹ì¸ ê¸°ëŠ¥ì´ ì‘ë™í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ

2. **ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡ API**
   - ê¸°ì¡´ APIëŠ” `PENDING` ìƒíƒœë§Œ í™•ì¸
   - ìƒˆë¡œìš´ í”„ë¡œì„¸ìŠ¤ëŠ” `PENDING_APPROVAL` ìƒíƒœ ì‚¬ìš©
   - ë‘ í”„ë¡œì„¸ìŠ¤ê°€ ê³µì¡´í•  ìˆ˜ ìˆë„ë¡ API ìˆ˜ì • í•„ìš”

3. **ë°ì´í„° í˜•ì‹ ë¶ˆì¼ì¹˜**
   - ì¼ë¶€ APIëŠ” `{ ok: true, error: '...' }` í˜•ì‹
   - ì¼ë¶€ APIëŠ” `{ ok: true, message: '...' }` í˜•ì‹
   - í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì¼ê´€ë˜ì§€ ì•Šê²Œ ì²˜ë¦¬í•  ìˆ˜ ìˆìŒ

**ìƒì„¸ ë‚´ìš©ì€ `ADMIN_AFFILIATE_CONNECTION_ISSUES.md` íŒŒì¼ ì°¸ì¡°**

---

## ğŸ“– ì „ì²´ ìš”ì•½ (í•œëˆˆì— ë³´ê¸°)

### ğŸ¯ ëª©í‘œ
íŒë§¤ì›/ëŒ€ë¦¬ì ì¥ì´ ê³ ê°ê³¼ì˜ í†µí™” ë…¹ìŒì„ Google Driveì— ì—…ë¡œë“œí•˜ê³ , ê´€ë¦¬ìê°€ í™•ì¸ í›„ ìŠ¹ì¸í•˜ë©´ ìë™ìœ¼ë¡œ ìˆ˜ë‹¹ì´ ê³„ì‚°ë˜ëŠ” ì‹œìŠ¤í…œ

### ğŸ“‹ ë§Œë“¤ íŒŒì¼ ëª©ë¡

#### ë°ì´í„°ë² ì´ìŠ¤
- `prisma/schema.prisma` (ìˆ˜ì •)

#### í•¨ìˆ˜/ìœ í‹¸ë¦¬í‹°
- `lib/google-drive.ts` (í•¨ìˆ˜ ì¶”ê°€)
- `lib/affiliate/sales-notification.ts` (ìƒˆë¡œ ë§Œë“¤ê¸°)

#### API (5ê°œ)
- `app/api/affiliate/sales/[saleId]/submit-confirmation/route.ts` (ìƒˆë¡œ ë§Œë“¤ê¸°)
- `app/api/affiliate/sales/[saleId]/cancel-confirmation/route.ts` (ìƒˆë¡œ ë§Œë“¤ê¸°)
- `app/api/affiliate/sales/my-sales/route.ts` (ìƒˆë¡œ ë§Œë“¤ê¸°)
- `app/api/admin/affiliate/sales/[saleId]/approve/route.ts` (ìƒˆë¡œ ë§Œë“¤ê¸°)
- `app/api/admin/affiliate/sales/[saleId]/reject/route.ts` (ìƒˆë¡œ ë§Œë“¤ê¸°)
- `app/api/admin/affiliate/sales/pending-approval/route.ts` (ìƒˆë¡œ ë§Œë“¤ê¸°)

#### UI ì»´í¬ë„ŒíŠ¸
- `components/affiliate/SalesConfirmationModal.tsx` (ìƒˆë¡œ ë§Œë“¤ê¸°)
- `app/admin/affiliate/sales/pending-approval/page.tsx` (ìƒˆë¡œ ë§Œë“¤ê¸°)
- `app/partner/[partnerId]/dashboard/PartnerDashboard.tsx` (ìˆ˜ì •)

### ğŸ”„ í”„ë¡œì„¸ìŠ¤ ìš”ì•½

1. **íŒë§¤ ìƒì„±** (ìë™)
   - ê°ì ëª°ì—ì„œ ê²°ì œ ì™„ë£Œ ì‹œ ìë™ ìƒì„±

2. **íŒë§¤ í™•ì • ìš”ì²­** (íŒë§¤ì›/ëŒ€ë¦¬ì ì¥)
   - ëŒ€ì‹œë³´ë“œì—ì„œ "í™•ì • ìš”ì²­" í´ë¦­
   - ë…¹ìŒ íŒŒì¼ ì—…ë¡œë“œ
   - Google Driveì— ì €ì¥
   - ìƒíƒœ: `PENDING` â†’ `PENDING_APPROVAL`

3. **ê´€ë¦¬ì í™•ì¸** (ê´€ë¦¬ì)
   - ìŠ¹ì¸ ëŒ€ê¸° í˜ì´ì§€ì—ì„œ ëª©ë¡ í™•ì¸
   - Google Drive ë§í¬ í´ë¦­í•˜ì—¬ ë…¹ìŒ í™•ì¸
   - ìŠ¹ì¸ ë˜ëŠ” ê±°ë¶€

4. **ìŠ¹ì¸ ì‹œ** (ìë™)
   - ìƒíƒœ: `PENDING_APPROVAL` â†’ `APPROVED`
   - ìˆ˜ë‹¹ ìë™ ê³„ì‚°
   - CommissionLedger ìƒì„±
   - íŒë§¤ì›/ëŒ€ë¦¬ì ì¥ì—ê²Œ ì•Œë¦¼

5. **ê±°ë¶€ ì‹œ**
   - ìƒíƒœ: `PENDING_APPROVAL` â†’ `REJECTED`
   - íŒë§¤ì›/ëŒ€ë¦¬ì ì¥ì—ê²Œ ì•Œë¦¼
   - ìˆ˜ì • í›„ ì¬ìš”ì²­ ê°€ëŠ¥

### âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸ (ê°„ë‹¨ ë²„ì „)

1. [ ] ë°ì´í„°ë² ì´ìŠ¤ ìˆ˜ì •
2. [ ] Google Drive í•¨ìˆ˜ ì¶”ê°€
3. [ ] íŒë§¤ í™•ì • ìš”ì²­ API
4. [ ] ìš”ì²­ ì·¨ì†Œ API
5. [ ] ë‚´ íŒë§¤ ëª©ë¡ API
6. [ ] ê´€ë¦¬ì ìŠ¹ì¸ API
7. [ ] ê´€ë¦¬ì ê±°ë¶€ API
8. [ ] ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡ API
9. [ ] ì•Œë¦¼ í•¨ìˆ˜
10. [ ] íŒë§¤ í™•ì • ëª¨ë‹¬ ì»´í¬ë„ŒíŠ¸
11. [ ] ê´€ë¦¬ì ìŠ¹ì¸ ëŒ€ê¸° í˜ì´ì§€
12. [ ] ëŒ€ì‹œë³´ë“œ í†µí•©
13. [ ] í…ŒìŠ¤íŠ¸

---

## ğŸš€ ì‹œì‘í•˜ê¸°

**1ë‹¨ê³„ë¶€í„° ì°¨ê·¼ì°¨ê·¼ ë”°ë¼í•˜ì‹œë©´ ë©ë‹ˆë‹¤!**

ê° ë‹¨ê³„ë§ˆë‹¤:
1. íŒŒì¼ì„ ë§Œë“¤ê±°ë‚˜ ìˆ˜ì •í•©ë‹ˆë‹¤
2. ì½”ë“œë¥¼ ë³µì‚¬í•´ì„œ ë¶™ì—¬ë„£ìŠµë‹ˆë‹¤
3. ì €ì¥í•©ë‹ˆë‹¤
4. í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤
5. ë‹¤ìŒ ë‹¨ê³„ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤

**ë¬¸ì œê°€ ìƒê¸°ë©´ ì–¸ì œë“ ì§€ ë¬¼ì–´ë³´ì„¸ìš”!** ğŸ˜Š


> **ì‘ì„±ì¼**: 2025-01-28  
> **ëª©ì **: íŒë§¤ì›/ëŒ€ë¦¬ì ì¥ì´ ë…¹ìŒ íŒŒì¼ì„ ì²¨ë¶€í•˜ì—¬ íŒë§¤ í™•ì • ìš”ì²­í•˜ê³ , ê´€ë¦¬ìê°€ ìŠ¹ì¸í•˜ëŠ” ì‹œìŠ¤í…œ êµ¬í˜„  
> **ë‚œì´ë„**: ì´ˆë³´ìë„ ë”°ë¼í•  ìˆ˜ ìˆë„ë¡ ì‰½ê²Œ ì„¤ëª…

---

## ğŸ“‹ ëª©ì°¨

1. [ì „ì²´ í”„ë¡œì„¸ìŠ¤ ì´í•´í•˜ê¸°](#1-ì „ì²´-í”„ë¡œì„¸ìŠ¤-ì´í•´í•˜ê¸°)
2. [1ë‹¨ê³„: ë°ì´í„°ë² ì´ìŠ¤ ìˆ˜ì •](#2-1ë‹¨ê³„-ë°ì´í„°ë² ì´ìŠ¤-ìˆ˜ì •)
3. [2ë‹¨ê³„: Google Drive ì—…ë¡œë“œ í•¨ìˆ˜ ë§Œë“¤ê¸°](#3-2ë‹¨ê³„-google-drive-ì—…ë¡œë“œ-í•¨ìˆ˜-ë§Œë“¤ê¸°)
4. [3ë‹¨ê³„: íŒë§¤ í™•ì • ìš”ì²­ API ë§Œë“¤ê¸°](#4-3ë‹¨ê³„-íŒë§¤-í™•ì •-ìš”ì²­-api-ë§Œë“¤ê¸°)
5. [4ë‹¨ê³„: ê´€ë¦¬ì ìŠ¹ì¸/ê±°ë¶€ API ë§Œë“¤ê¸°](#5-4ë‹¨ê³„-ê´€ë¦¬ì-ìŠ¹ì¸ê±°ë¶€-api-ë§Œë“¤ê¸°)
6. [5ë‹¨ê³„: UI ë§Œë“¤ê¸°](#6-5ë‹¨ê³„-ui-ë§Œë“¤ê¸°)
7. [6ë‹¨ê³„: ì•Œë¦¼ ê¸°ëŠ¥ ì¶”ê°€](#7-6ë‹¨ê³„-ì•Œë¦¼-ê¸°ëŠ¥-ì¶”ê°€)
8. [í…ŒìŠ¤íŠ¸ ë°©ë²•](#8-í…ŒìŠ¤íŠ¸-ë°©ë²•)

---

## 1. ì „ì²´ í”„ë¡œì„¸ìŠ¤ ì´í•´í•˜ê¸°

### ğŸ¬ ì‹œë‚˜ë¦¬ì˜¤

**ìƒí™©**: íŒë§¤ì› ê¹€ì² ìˆ˜ê°€ ê³ ê°ê³¼ í†µí™”ë¥¼ í–ˆê³ , ê³ ê°ì´ êµ¬ë§¤ë¥¼ ê²°ì •í–ˆìŠµë‹ˆë‹¤.

**ê³¼ì •**:
1. ê¹€ì² ìˆ˜ê°€ í†µí™” ë…¹ìŒ íŒŒì¼ì„ ì¤€ë¹„í•©ë‹ˆë‹¤
2. íŒë§¤ í™•ì • ìš”ì²­ í˜ì´ì§€ì—ì„œ ë…¹ìŒ íŒŒì¼ì„ ì—…ë¡œë“œí•©ë‹ˆë‹¤
3. ì‹œìŠ¤í…œì´ Google Driveì— íŒŒì¼ì„ ì €ì¥í•©ë‹ˆë‹¤
4. ê´€ë¦¬ìì—ê²Œ "ìŠ¹ì¸ ëŒ€ê¸°" ì•Œë¦¼ì´ ê°‘ë‹ˆë‹¤
5. ê´€ë¦¬ìê°€ Google Drive ë§í¬ë¥¼ í´ë¦­í•´ì„œ ë…¹ìŒì„ í™•ì¸í•©ë‹ˆë‹¤
6. ê´€ë¦¬ìê°€ ìŠ¹ì¸í•˜ë©´ ìë™ìœ¼ë¡œ ìˆ˜ë‹¹ì´ ê³„ì‚°ë©ë‹ˆë‹¤
7. ê¹€ì² ìˆ˜ì—ê²Œ "ìŠ¹ì¸ ì™„ë£Œ" ì•Œë¦¼ì´ ê°‘ë‹ˆë‹¤

### ğŸ“Š ìƒíƒœ íë¦„ë„

```
PENDING (ì´ˆê¸° ìƒíƒœ)
    â†“
[íŒë§¤ì›/ëŒ€ë¦¬ì ì¥ì´ ìš”ì²­ ì œì¶œ]
    â†“
PENDING_APPROVAL (ìŠ¹ì¸ ëŒ€ê¸°)
    â†“
[ê´€ë¦¬ìê°€ í™•ì¸ í›„]
    â”œâ”€â†’ APPROVED (ìŠ¹ì¸) â†’ ìˆ˜ë‹¹ ìë™ ê³„ì‚° âœ…
    â””â”€â†’ REJECTED (ê±°ë¶€) â†’ ìˆ˜ì • ê°€ëŠ¥ ğŸ”„
```

---

## 2. 1ë‹¨ê³„: ë°ì´í„°ë² ì´ìŠ¤ ìˆ˜ì •

### ğŸ“ ì„¤ëª…
ë°ì´í„°ë² ì´ìŠ¤ì— "ë…¹ìŒ íŒŒì¼ ì •ë³´"ì™€ "ìŠ¹ì¸ ì •ë³´"ë¥¼ ì €ì¥í•  ê³µê°„ì„ ë§Œë“¤ì–´ì•¼ í•©ë‹ˆë‹¤.

### ğŸ”§ ì‘ì—… ë‚´ìš©

**íŒŒì¼**: `prisma/schema.prisma`

**AffiliateSale ëª¨ë¸ì— ì¶”ê°€í•  í•„ë“œë“¤**:

```prisma
model AffiliateSale {
  // ... ê¸°ì¡´ í•„ë“œë“¤ ...
  
  // ğŸ†• ì¶”ê°€í•  í•„ë“œë“¤
  audioFileGoogleDriveId String?        // Google Drive íŒŒì¼ ID
  audioFileGoogleDriveUrl String?       // Google Drive ê³µìœ  ë§í¬
  audioFileName String?                 // ì›ë³¸ íŒŒì¼ëª…
  submittedById Int?                    // ìš”ì²­ ì œì¶œì ID (íŒë§¤ì›/ëŒ€ë¦¬ì ì¥)
  submittedAt DateTime?                 // ìš”ì²­ ì œì¶œ ì‹œê°„
  approvedById Int?                     // ìŠ¹ì¸í•œ ê´€ë¦¬ì ID
  approvedAt DateTime?                  // ìŠ¹ì¸ ì‹œê°„
  rejectedById Int?                     // ê±°ë¶€í•œ ê´€ë¦¬ì ID
  rejectedAt DateTime?                  // ê±°ë¶€ ì‹œê°„
  rejectionReason String?               // ê±°ë¶€ ì‚¬ìœ 
  
  // ... ê¸°ì¡´ í•„ë“œë“¤ ...
}
```

### ğŸ“Œ ì¤‘ìš” ì‚¬í•­
- `?` í‘œì‹œëŠ” "ì—†ì–´ë„ ë¨"ì„ ì˜ë¯¸í•©ë‹ˆë‹¤
- `String?`ì€ "í…ìŠ¤íŠ¸ ë˜ëŠ” ì—†ìŒ"
- `Int?`ëŠ” "ìˆ«ì ë˜ëŠ” ì—†ìŒ"
- `DateTime?`ì€ "ë‚ ì§œ/ì‹œê°„ ë˜ëŠ” ì—†ìŒ"

### âœ… ì‹¤í–‰ ë°©ë²•

1. **íŒŒì¼ ì—´ê¸°**: `prisma/schema.prisma` íŒŒì¼ì„ ì—½ë‹ˆë‹¤
2. **AffiliateSale ëª¨ë¸ ì°¾ê¸°**: `model AffiliateSale {` ë¶€ë¶„ì„ ì°¾ìŠµë‹ˆë‹¤
3. **í•„ë“œ ì¶”ê°€**: ìœ„ì˜ í•„ë“œë“¤ì„ ê¸°ì¡´ í•„ë“œë“¤ ì•„ë˜ì— ì¶”ê°€í•©ë‹ˆë‹¤
4. **ì €ì¥**: íŒŒì¼ì„ ì €ì¥í•©ë‹ˆë‹¤
5. **ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸**: í„°ë¯¸ë„ì—ì„œ ë‹¤ìŒ ëª…ë ¹ì–´ ì‹¤í–‰
   ```bash
   npx prisma db push
   ```

### âš ï¸ ì£¼ì˜ì‚¬í•­
- ê¸°ì¡´ ë°ì´í„°ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€ë©ë‹ˆë‹¤
- ìƒˆ í•„ë“œëŠ” ëª¨ë‘ "ì—†ìŒ" ìƒíƒœë¡œ ì‹œì‘í•©ë‹ˆë‹¤

---

## 3. 2ë‹¨ê³„: Google Drive ì—…ë¡œë“œ í•¨ìˆ˜ í™•ì¸í•˜ê¸°

### ğŸ“ ì„¤ëª…
ì´ë¯¸ Google Drive ì—…ë¡œë“œ í•¨ìˆ˜ê°€ ìˆìŠµë‹ˆë‹¤! (`lib/google-drive.ts`ì˜ `uploadFileToDrive` í•¨ìˆ˜)
ì´ í•¨ìˆ˜ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ë©´ ë©ë‹ˆë‹¤. ë…¹ìŒ íŒŒì¼ìš©ìœ¼ë¡œ ê°„ë‹¨íˆ ë˜í¼ í•¨ìˆ˜ë§Œ ë§Œë“¤ë©´ ë©ë‹ˆë‹¤.

### ğŸ”§ ì‘ì—… ë‚´ìš©

**íŒŒì¼**: `lib/google-drive.ts` (ì´ë¯¸ ìˆìŒ, í•¨ìˆ˜ ì¶”ê°€)

**ì¶”ê°€í•  í•¨ìˆ˜** (íŒŒì¼ ëì—):

```typescript
/**
 * ë…¹ìŒ íŒŒì¼ì„ Google Driveì— ì—…ë¡œë“œ (ê°„í¸ í•¨ìˆ˜)
 * @param fileBuffer íŒŒì¼ ë°ì´í„° (Buffer)
 * @param fileName íŒŒì¼ëª…
 * @param folderId Google Drive í´ë” ID (ì„ íƒì‚¬í•­, í™˜ê²½ ë³€ìˆ˜ì—ì„œ ê°€ì ¸ì˜´)
 * @returns Google Drive íŒŒì¼ ì •ë³´
 */
export async function uploadAudioFileToDrive(
  fileBuffer: Buffer,
  fileName: string,
  folderId?: string
): Promise<{ ok: boolean; fileId?: string; url?: string; error?: string }> {
  // í´ë” IDê°€ ì—†ìœ¼ë©´ í™˜ê²½ ë³€ìˆ˜ì—ì„œ ê°€ì ¸ì˜¤ê¸°
  const targetFolderId = folderId || process.env.GOOGLE_DRIVE_SALES_AUDIO_FOLDER_ID || 'root';
  
  // íŒŒì¼ í˜•ì‹ ìë™ ê°ì§€
  let mimeType = 'audio/mpeg'; // ê¸°ë³¸ê°’: MP3
  if (fileName.endsWith('.wav')) mimeType = 'audio/wav';
  else if (fileName.endsWith('.m4a')) mimeType = 'audio/m4a';
  else if (fileName.endsWith('.mp3')) mimeType = 'audio/mpeg';

  // ê¸°ì¡´ í•¨ìˆ˜ ì‚¬ìš©
  return await uploadFileToDrive({
    folderId: targetFolderId,
    fileName,
    mimeType,
    buffer: fileBuffer,
    makePublic: true, // ë§í¬ë¡œ ì ‘ê·¼ ê°€ëŠ¥í•˜ê²Œ
  });
}
```

### ğŸ“Œ ì„¤ëª…
- ê¸°ì¡´ `uploadFileToDrive` í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤
- ë…¹ìŒ íŒŒì¼ ì „ìš©ìœ¼ë¡œ ê°„ë‹¨í•˜ê²Œ ë§Œë“  í•¨ìˆ˜ì…ë‹ˆë‹¤
- íŒŒì¼ í˜•ì‹ì„ ìë™ìœ¼ë¡œ ê°ì§€í•©ë‹ˆë‹¤
- ê³µê°œ ë§í¬ë¥¼ ìë™ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤

### âœ… ì‹¤í–‰ ë°©ë²•
1. `lib/google-drive.ts` íŒŒì¼ì„ ì—½ë‹ˆë‹¤
2. íŒŒì¼ ë(ë§ˆì§€ë§‰ ì¤„)ì— ìœ„ í•¨ìˆ˜ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤
3. ì €ì¥í•©ë‹ˆë‹¤

---

## 4. 3ë‹¨ê³„: íŒë§¤ í™•ì • ìš”ì²­ API ë§Œë“¤ê¸°

### ğŸ“ ì„¤ëª…
íŒë§¤ì›/ëŒ€ë¦¬ì ì¥ì´ "íŒë§¤ í™•ì • ìš”ì²­"ì„ ì œì¶œí•˜ëŠ” APIë¥¼ ë§Œë“­ë‹ˆë‹¤.

### ğŸ”§ ì‘ì—… ë‚´ìš©

**ìƒˆ íŒŒì¼ ìƒì„±**: `app/api/affiliate/sales/[saleId]/submit-confirmation/route.ts`

**ì „ì²´ ì½”ë“œ**:

```typescript
// app/api/affiliate/sales/[saleId]/submit-confirmation/route.ts
// íŒë§¤ í™•ì • ìš”ì²­ ì œì¶œ API

import { NextRequest, NextResponse } from 'next/server';
import { cookies } from 'next/headers';
import prisma from '@/lib/prisma';
import { uploadAudioToGoogleDrive } from '@/lib/google/drive';

const SESSION_COOKIE = 'cg.sid.v2';

// ì„¸ì…˜ì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
async function getCurrentUser() {
  const sid = cookies().get(SESSION_COOKIE)?.value;
  if (!sid) return null;

  try {
    const session = await prisma.session.findUnique({
      where: { id: sid },
      include: {
        User: {
          select: { id: true, role: true },
        },
      },
    });

    if (!session || !session.User) return null;
    return session.User;
  } catch (error) {
    console.error('[Submit Confirmation] Session error:', error);
    return null;
  }
}

// íŒë§¤ì›/ëŒ€ë¦¬ì ì¥ ê¶Œí•œ í™•ì¸
async function checkAffiliateAuth(saleId: number, userId: number) {
  // íŒë§¤ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
  const sale = await prisma.affiliateSale.findUnique({
    where: { id: saleId },
    include: {
      agent: {
        select: { userId: true, type: true },
      },
      manager: {
        select: { userId: true, type: true },
      },
    },
  });

  if (!sale) {
    return { allowed: false, reason: 'íŒë§¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' };
  }

  // íŒë§¤ì›ì¸ ê²½ìš°: ë³¸ì¸ íŒë§¤ë§Œ ê°€ëŠ¥
  if (sale.agentId && sale.agent?.userId === userId) {
    return { allowed: true, profile: sale.agent };
  }

  // ëŒ€ë¦¬ì ì¥ì¸ ê²½ìš°: ë³¸ì¸ íŒë§¤ë§Œ ê°€ëŠ¥ (ì†Œì† íŒë§¤ì› íŒë§¤ëŠ” ë¶ˆê°€)
  if (sale.managerId && sale.manager?.userId === userId) {
    return { allowed: true, profile: sale.manager };
  }

  return { allowed: false, reason: 'ë³¸ì¸ì˜ íŒë§¤ë§Œ í™•ì • ìš”ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤' };
}

/**
 * POST: íŒë§¤ í™•ì • ìš”ì²­ ì œì¶œ
 */
export async function POST(
  req: NextRequest,
  { params }: { params: { saleId: string } }
) {
  try {
    // 1. ì‚¬ìš©ì í™•ì¸
    const user = await getCurrentUser();
    if (!user) {
      return NextResponse.json(
        { ok: false, error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' },
        { status: 401 }
      );
    }

    // 2. íŒë§¤ ID í™•ì¸
    const saleId = parseInt(params.saleId);
    if (isNaN(saleId)) {
      return NextResponse.json(
        { ok: false, error: 'ì˜¬ë°”ë¥¸ íŒë§¤ IDê°€ ì•„ë‹™ë‹ˆë‹¤' },
        { status: 400 }
      );
    }

    // 3. ê¶Œí•œ í™•ì¸ (ë³¸ì¸ íŒë§¤ë§Œ)
    const authCheck = await checkAffiliateAuth(saleId, user.id);
    if (!authCheck.allowed) {
      return NextResponse.json(
        { ok: false, error: authCheck.reason },
        { status: 403 }
      );
    }

    // 4. íŒë§¤ ìƒíƒœ í™•ì¸ (ì´ë¯¸ ìš”ì²­í–ˆê±°ë‚˜ ìŠ¹ì¸ëœ ê²½ìš° ë¶ˆê°€)
    const sale = await prisma.affiliateSale.findUnique({
      where: { id: saleId },
      select: { id: true, status: true },
    });

    if (!sale) {
      return NextResponse.json(
        { ok: false, error: 'íŒë§¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' },
        { status: 404 }
      );
    }

    if (sale.status === 'PENDING_APPROVAL') {
      return NextResponse.json(
        { ok: false, error: 'ì´ë¯¸ ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤' },
        { status: 400 }
      );
    }

    if (sale.status === 'APPROVED') {
      return NextResponse.json(
        { ok: false, error: 'ì´ë¯¸ ìŠ¹ì¸ëœ íŒë§¤ì…ë‹ˆë‹¤' },
        { status: 400 }
      );
    }

    // 5. íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
    const formData = await req.formData();
    const audioFile = formData.get('audioFile') as File | null;

    if (!audioFile) {
      return NextResponse.json(
        { ok: false, error: 'ë…¹ìŒ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”' },
        { status: 400 }
      );
    }

    // íŒŒì¼ í¬ê¸° í™•ì¸ (50MB ì œí•œ)
    const MAX_FILE_SIZE = 50 * 1024 * 1024; // 50MB
    if (audioFile.size > MAX_FILE_SIZE) {
      return NextResponse.json(
        { ok: false, error: 'íŒŒì¼ í¬ê¸°ëŠ” 50MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤' },
        { status: 400 }
      );
    }

    // íŒŒì¼ í˜•ì‹ í™•ì¸ (MP3, WAV, M4A)
    const allowedTypes = ['audio/mpeg', 'audio/mp3', 'audio/wav', 'audio/m4a', 'audio/x-m4a'];
    if (!allowedTypes.includes(audioFile.type)) {
      return NextResponse.json(
        { ok: false, error: 'ì§€ì›í•˜ëŠ” íŒŒì¼ í˜•ì‹: MP3, WAV, M4A' },
        { status: 400 }
      );
    }

    // 6. Google Driveì— ì—…ë¡œë“œ
    const fileBuffer = Buffer.from(await audioFile.arrayBuffer());
    const fileName = `sale_${saleId}_${Date.now()}_${audioFile.name}`;

    // Google Drive ì—…ë¡œë“œ (ê¸°ì¡´ í•¨ìˆ˜ ì‚¬ìš©)
    const { uploadAudioFileToDrive } = await import('@/lib/google-drive');
    const driveResult = await uploadAudioFileToDrive(fileBuffer, fileName);

    if (!driveResult.ok || !driveResult.fileId || !driveResult.url) {
      return NextResponse.json(
        { ok: false, error: driveResult.error || 'Google Drive ì—…ë¡œë“œ ì‹¤íŒ¨' },
        { status: 500 }
      );
    }

    // 7. ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸
    const updatedSale = await prisma.affiliateSale.update({
      where: { id: saleId },
      data: {
        status: 'PENDING_APPROVAL',
        audioFileGoogleDriveId: driveResult.fileId,
        audioFileGoogleDriveUrl: driveResult.url,
        audioFileName: audioFile.name,
        submittedById: user.id,
        submittedAt: new Date(),
      },
    });

    return NextResponse.json({
      ok: true,
      message: 'íŒë§¤ í™•ì • ìš”ì²­ì´ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤',
      sale: {
        id: updatedSale.id,
        status: updatedSale.status,
        audioFileUrl: updatedSale.audioFileGoogleDriveUrl,
      },
    });
  } catch (error: any) {
    console.error('[Submit Confirmation] Error:', error);
    return NextResponse.json(
      { ok: false, error: error.message || 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' },
      { status: 500 }
    );
  }
}
```

### ğŸ“Œ ì„¤ëª…
- ì´ APIëŠ” íŒë§¤ì›/ëŒ€ë¦¬ì ì¥ì´ ì‚¬ìš©í•©ë‹ˆë‹¤
- ë³¸ì¸ íŒë§¤ë§Œ ìš”ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
- ë…¹ìŒ íŒŒì¼ì„ Google Driveì— ì—…ë¡œë“œí•©ë‹ˆë‹¤
- íŒë§¤ ìƒíƒœë¥¼ `PENDING_APPROVAL`ë¡œ ë³€ê²½í•©ë‹ˆë‹¤

---

## 5. 4ë‹¨ê³„: ê´€ë¦¬ì ìŠ¹ì¸/ê±°ë¶€ API ë§Œë“¤ê¸°

### ğŸ“ ì„¤ëª…
ê´€ë¦¬ìê°€ íŒë§¤ í™•ì • ìš”ì²­ì„ ìŠ¹ì¸í•˜ê±°ë‚˜ ê±°ë¶€í•˜ëŠ” APIë¥¼ ë§Œë“­ë‹ˆë‹¤.

### ğŸ”§ ì‘ì—… ë‚´ìš©

#### 5-1. ìŠ¹ì¸ API

**ìƒˆ íŒŒì¼ ìƒì„±**: `app/api/admin/affiliate/sales/[saleId]/approve/route.ts`

```typescript
// app/api/admin/affiliate/sales/[saleId]/approve/route.ts
// íŒë§¤ í™•ì • ìŠ¹ì¸ API

import { NextRequest, NextResponse } from 'next/server';
import { cookies } from 'next/headers';
import prisma from '@/lib/prisma';
import { syncSaleCommissionLedgers } from '@/lib/affiliate/commission-ledger';

const SESSION_COOKIE = 'cg.sid.v2';

// ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
async function checkAdminAuth() {
  const sid = cookies().get(SESSION_COOKIE)?.value;
  if (!sid) return null;

  try {
    const session = await prisma.session.findUnique({
      where: { id: sid },
      include: {
        User: {
          select: { id: true, role: true, name: true },
        },
      },
    });

    if (!session || !session.User) return null;
    if (session.User.role !== 'admin') return null;
    return session.User;
  } catch (error) {
    console.error('[Approve Sale] Auth error:', error);
    return null;
  }
}

/**
 * POST: íŒë§¤ í™•ì • ìŠ¹ì¸
 */
export async function POST(
  req: NextRequest,
  { params }: { params: { saleId: string } }
) {
  try {
    // 1. ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
    const admin = await checkAdminAuth();
    if (!admin) {
      return NextResponse.json(
        { ok: false, error: 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤' },
        { status: 403 }
      );
    }

    // 2. íŒë§¤ ID í™•ì¸
    const saleId = parseInt(params.saleId);
    if (isNaN(saleId)) {
      return NextResponse.json(
        { ok: false, error: 'ì˜¬ë°”ë¥¸ íŒë§¤ IDê°€ ì•„ë‹™ë‹ˆë‹¤' },
        { status: 400 }
      );
    }

    // 3. íŒë§¤ ì •ë³´ í™•ì¸
    const sale = await prisma.affiliateSale.findUnique({
      where: { id: saleId },
      select: {
        id: true,
        status: true,
        audioFileGoogleDriveUrl: true,
      },
    });

    if (!sale) {
      return NextResponse.json(
        { ok: false, error: 'íŒë§¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' },
        { status: 404 }
      );
    }

    if (sale.status !== 'PENDING_APPROVAL') {
      return NextResponse.json(
        { ok: false, error: 'ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ íŒë§¤ë§Œ ìŠ¹ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤' },
        { status: 400 }
      );
    }

    // 4. íŒë§¤ ìŠ¹ì¸ ì²˜ë¦¬
    const updatedSale = await prisma.affiliateSale.update({
      where: { id: saleId },
      data: {
        status: 'APPROVED',
        approvedById: admin.id,
        approvedAt: new Date(),
        confirmedAt: new Date(), // ê¸°ì¡´ í•„ë“œì™€ í˜¸í™˜ì„± ìœ ì§€
      },
    });

    // 5. ìˆ˜ë‹¹ ìë™ ê³„ì‚°
    try {
      await syncSaleCommissionLedgers(saleId, {
        includeHq: true,
        regenerate: false,
      });
      console.log(`[Approve Sale] ìˆ˜ë‹¹ ê³„ì‚° ì™„ë£Œ: Sale #${saleId}`);
    } catch (commissionError: any) {
      console.error(`[Approve Sale] ìˆ˜ë‹¹ ê³„ì‚° ì˜¤ë¥˜:`, commissionError);
      // ìˆ˜ë‹¹ ê³„ì‚° ì‹¤íŒ¨í•´ë„ ìŠ¹ì¸ì€ ì™„ë£Œ (ë‚˜ì¤‘ì— ìˆ˜ë™ìœ¼ë¡œ ê³„ì‚° ê°€ëŠ¥)
    }

    return NextResponse.json({
      ok: true,
      message: 'íŒë§¤ê°€ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤',
      sale: {
        id: updatedSale.id,
        status: updatedSale.status,
      },
    });
  } catch (error: any) {
    console.error('[Approve Sale] Error:', error);
    return NextResponse.json(
      { ok: false, error: error.message || 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' },
      { status: 500 }
    );
  }
}
```

#### 5-2. ê±°ë¶€ API

**ìƒˆ íŒŒì¼ ìƒì„±**: `app/api/admin/affiliate/sales/[saleId]/reject/route.ts`

```typescript
// app/api/admin/affiliate/sales/[saleId]/reject/route.ts
// íŒë§¤ í™•ì • ê±°ë¶€ API

import { NextRequest, NextResponse } from 'next/server';
import { cookies } from 'next/headers';
import prisma from '@/lib/prisma';

const SESSION_COOKIE = 'cg.sid.v2';

// ê´€ë¦¬ì ê¶Œí•œ í™•ì¸ (ìœ„ì™€ ë™ì¼)
async function checkAdminAuth() {
  const sid = cookies().get(SESSION_COOKIE)?.value;
  if (!sid) return null;

  try {
    const session = await prisma.session.findUnique({
      where: { id: sid },
      include: {
        User: {
          select: { id: true, role: true, name: true },
        },
      },
    });

    if (!session || !session.User) return null;
    if (session.User.role !== 'admin') return null;
    return session.User;
  } catch (error) {
    console.error('[Reject Sale] Auth error:', error);
    return null;
  }
}

/**
 * POST: íŒë§¤ í™•ì • ê±°ë¶€
 */
export async function POST(
  req: NextRequest,
  { params }: { params: { saleId: string } }
) {
  try {
    // 1. ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
    const admin = await checkAdminAuth();
    if (!admin) {
      return NextResponse.json(
        { ok: false, error: 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤' },
        { status: 403 }
      );
    }

    // 2. íŒë§¤ ID í™•ì¸
    const saleId = parseInt(params.saleId);
    if (isNaN(saleId)) {
      return NextResponse.json(
        { ok: false, error: 'ì˜¬ë°”ë¥¸ íŒë§¤ IDê°€ ì•„ë‹™ë‹ˆë‹¤' },
        { status: 400 }
      );
    }

    // 3. ê±°ë¶€ ì‚¬ìœ  ë°›ê¸°
    const body = await req.json();
    const { reason } = body;

    if (!reason || reason.trim().length === 0) {
      return NextResponse.json(
        { ok: false, error: 'ê±°ë¶€ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”' },
        { status: 400 }
      );
    }

    // 4. íŒë§¤ ì •ë³´ í™•ì¸
    const sale = await prisma.affiliateSale.findUnique({
      where: { id: saleId },
      select: {
        id: true,
        status: true,
      },
    });

    if (!sale) {
      return NextResponse.json(
        { ok: false, error: 'íŒë§¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' },
        { status: 404 }
      );
    }

    if (sale.status !== 'PENDING_APPROVAL') {
      return NextResponse.json(
        { ok: false, error: 'ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ íŒë§¤ë§Œ ê±°ë¶€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤' },
        { status: 400 }
      );
    }

    // 5. íŒë§¤ ê±°ë¶€ ì²˜ë¦¬
    const updatedSale = await prisma.affiliateSale.update({
      where: { id: saleId },
      data: {
        status: 'REJECTED',
        rejectedById: admin.id,
        rejectedAt: new Date(),
        rejectionReason: reason.trim(),
        // ìƒíƒœë¥¼ PENDINGìœ¼ë¡œ ë˜ëŒë ¤ì„œ ì¬ìš”ì²­ ê°€ëŠ¥í•˜ê²Œ
        submittedAt: null,
        submittedById: null,
      },
    });

    return NextResponse.json({
      ok: true,
      message: 'íŒë§¤ê°€ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤',
      sale: {
        id: updatedSale.id,
        status: updatedSale.status,
        rejectionReason: updatedSale.rejectionReason,
      },
    });
  } catch (error: any) {
    console.error('[Reject Sale] Error:', error);
    return NextResponse.json(
      { ok: false, error: error.message || 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' },
      { status: 500 }
    );
  }
}
```

#### 5-3. ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡ ì¡°íšŒ API

**ìƒˆ íŒŒì¼ ìƒì„±**: `app/api/admin/affiliate/sales/pending-approval/route.ts`

```typescript
// app/api/admin/affiliate/sales/pending-approval/route.ts
// ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ íŒë§¤ ëª©ë¡ ì¡°íšŒ

import { NextRequest, NextResponse } from 'next/server';
import { cookies } from 'next/headers';
import prisma from '@/lib/prisma';

const SESSION_COOKIE = 'cg.sid.v2';

// ê´€ë¦¬ì ê¶Œí•œ í™•ì¸ (ìœ„ì™€ ë™ì¼)
async function checkAdminAuth() {
  const sid = cookies().get(SESSION_COOKIE)?.value;
  if (!sid) return null;

  try {
    const session = await prisma.session.findUnique({
      where: { id: sid },
      include: {
        User: {
          select: { id: true, role: true },
        },
      },
    });

    if (!session || !session.User) return null;
    if (session.User.role !== 'admin') return null;
    return session.User;
  } catch (error) {
    return null;
  }
}

/**
 * GET: ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ íŒë§¤ ëª©ë¡
 */
export async function GET(req: NextRequest) {
  try {
    // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
    const admin = await checkAdminAuth();
    if (!admin) {
      return NextResponse.json(
        { ok: false, error: 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤' },
        { status: 403 }
      );
    }

    // ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ íŒë§¤ ì¡°íšŒ
    const pendingSales = await prisma.affiliateSale.findMany({
      where: {
        status: 'PENDING_APPROVAL',
      },
      include: {
        agent: {
          select: {
            id: true,
            displayName: true,
            affiliateCode: true,
            type: true,
            user: {
              select: {
                id: true,
                name: true,
                phone: true,
              },
            },
          },
        },
        manager: {
          select: {
            id: true,
            displayName: true,
            affiliateCode: true,
            type: true,
            user: {
              select: {
                id: true,
                name: true,
                phone: true,
              },
            },
          },
        },
        product: {
          select: {
            productCode: true,
            title: true,
          },
        },
      },
      orderBy: {
        submittedAt: 'asc', // ì˜¤ë˜ëœ ê²ƒë¶€í„°
      },
    });

    return NextResponse.json({
      ok: true,
      sales: pendingSales.map((sale) => ({
        id: sale.id,
        productCode: sale.productCode,
        productTitle: sale.product?.title,
        saleAmount: sale.saleAmount,
        saleDate: sale.saleDate,
        submittedAt: sale.submittedAt,
        audioFileGoogleDriveUrl: sale.audioFileGoogleDriveUrl,
        audioFileName: sale.audioFileName,
        agent: sale.agent
          ? {
              name: sale.agent.displayName || sale.agent.user?.name,
              code: sale.agent.affiliateCode,
              phone: sale.agent.user?.phone,
            }
          : null,
        manager: sale.manager
          ? {
              name: sale.manager.displayName || sale.manager.user?.name,
              code: sale.manager.affiliateCode,
              phone: sale.manager.user?.phone,
            }
          : null,
      })),
      count: pendingSales.length,
    });
  } catch (error: any) {
    console.error('[Pending Approval] Error:', error);
    return NextResponse.json(
      { ok: false, error: error.message || 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' },
      { status: 500 }
    );
  }
}
```

### ğŸ“Œ ì„¤ëª…
- **ìŠ¹ì¸ API**: íŒë§¤ë¥¼ ìŠ¹ì¸í•˜ê³  ìˆ˜ë‹¹ì„ ìë™ ê³„ì‚°í•©ë‹ˆë‹¤
- **ê±°ë¶€ API**: íŒë§¤ë¥¼ ê±°ë¶€í•˜ê³  ì‚¬ìœ ë¥¼ ì €ì¥í•©ë‹ˆë‹¤ (ì¬ìš”ì²­ ê°€ëŠ¥)
- **ëª©ë¡ API**: ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ ëª¨ë“  íŒë§¤ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤

---

## 6. 5ë‹¨ê³„: UI ë§Œë“¤ê¸°

### ğŸ“ ì„¤ëª…
ì‚¬ìš©ìê°€ ì‰½ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” í™”ë©´ì„ ë§Œë“­ë‹ˆë‹¤. ë‹¨ê³„ë³„ë¡œ í•˜ë‚˜ì”© ë§Œë“¤ì–´ë´…ì‹œë‹¤.

### ğŸ”§ ì‘ì—… ë‚´ìš©

#### 6-1. íŒë§¤ í™•ì • ìš”ì²­ ëª¨ë‹¬ ì»´í¬ë„ŒíŠ¸ ë§Œë“¤ê¸°

**ìƒˆ íŒŒì¼ ìƒì„±**: `components/affiliate/SalesConfirmationModal.tsx`

ì´ ì»´í¬ë„ŒíŠ¸ëŠ” íŒë§¤ì›/ëŒ€ë¦¬ì ì¥ì´ ì‚¬ìš©í•©ë‹ˆë‹¤.

```typescript
'use client';

import { useState, useRef } from 'react';
import { FiUpload, FiX, FiCheckCircle, FiAlertCircle } from 'react-icons/fi';
import { showError, showSuccess } from '@/components/ui/Toast';

interface SalesConfirmationModalProps {
  saleId: number;
  currentStatus: string;
  audioFileUrl?: string | null;
  onClose: () => void;
  onSuccess: () => void;
}

export default function SalesConfirmationModal({
  saleId,
  currentStatus,
  audioFileUrl,
  onClose,
  onSuccess,
}: SalesConfirmationModalProps) {
  const [audioFile, setAudioFile] = useState<File | null>(null);
  const [isUploading, setIsUploading] = useState(false);
  const fileInputRef = useRef<HTMLInputElement>(null);

  // íŒŒì¼ ì„ íƒ
  const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    // íŒŒì¼ í¬ê¸° í™•ì¸ (50MB)
    if (file.size > 50 * 1024 * 1024) {
      showError('íŒŒì¼ í¬ê¸°ëŠ” 50MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
      return;
    }

    // íŒŒì¼ í˜•ì‹ í™•ì¸
    const allowedTypes = ['audio/mpeg', 'audio/mp3', 'audio/wav', 'audio/m4a', 'audio/x-m4a'];
    if (!allowedTypes.includes(file.type)) {
      showError('ì§€ì›í•˜ëŠ” íŒŒì¼ í˜•ì‹: MP3, WAV, M4A');
      return;
    }

    setAudioFile(file);
  };

  // íŒë§¤ í™•ì • ìš”ì²­ ì œì¶œ
  const handleSubmit = async () => {
    if (!audioFile) {
      showError('ë…¹ìŒ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
      return;
    }

    setIsUploading(true);
    try {
      const formData = new FormData();
      formData.append('audioFile', audioFile);

      const response = await fetch(`/api/affiliate/sales/${saleId}/submit-confirmation`, {
        method: 'POST',
        body: formData,
        credentials: 'include',
      });

      const data = await response.json();

      if (response.ok && data.ok) {
        showSuccess('íŒë§¤ í™•ì • ìš”ì²­ì´ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤');
        onSuccess();
        onClose();
      } else {
        showError(data.error || 'ìš”ì²­ ì œì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
      }
    } catch (error: any) {
      console.error('[Sales Confirmation] Submit error:', error);
      showError('ìš”ì²­ ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    } finally {
      setIsUploading(false);
    }
  };

  // ìš”ì²­ ì·¨ì†Œ (PENDING_APPROVAL ìƒíƒœì¼ ë•Œë§Œ)
  const handleCancel = async () => {
    if (!confirm('íŒë§¤ í™•ì • ìš”ì²­ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      return;
    }

    try {
      const response = await fetch(`/api/affiliate/sales/${saleId}/cancel-confirmation`, {
        method: 'POST',
        credentials: 'include',
      });

      const data = await response.json();

      if (response.ok && data.ok) {
        showSuccess('ìš”ì²­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤');
        onSuccess();
        onClose();
      } else {
        showError(data.error || 'ìš”ì²­ ì·¨ì†Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
      }
    } catch (error: any) {
      console.error('[Sales Confirmation] Cancel error:', error);
      showError('ìš”ì²­ ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    }
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
        {/* í—¤ë” */}
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-xl font-bold text-gray-800">íŒë§¤ í™•ì • ìš”ì²­</h2>
          <button
            onClick={onClose}
            className="text-gray-500 hover:text-gray-700"
          >
            <FiX className="w-6 h-6" />
          </button>
        </div>

        {/* ìƒíƒœ í‘œì‹œ */}
        {currentStatus === 'PENDING_APPROVAL' && (
          <div className="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
            <div className="flex items-center gap-2 text-yellow-800">
              <FiAlertCircle className="w-5 h-5" />
              <span className="font-semibold">ìŠ¹ì¸ ëŒ€ê¸° ì¤‘</span>
            </div>
            {audioFileUrl && (
              <a
                href={audioFileUrl}
                target="_blank"
                rel="noopener noreferrer"
                className="mt-2 text-sm text-yellow-700 hover:text-yellow-900 underline"
              >
                ë…¹ìŒ íŒŒì¼ í™•ì¸í•˜ê¸°
              </a>
            )}
          </div>
        )}

        {currentStatus === 'APPROVED' && (
          <div className="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg">
            <div className="flex items-center gap-2 text-green-800">
              <FiCheckCircle className="w-5 h-5" />
              <span className="font-semibold">ìŠ¹ì¸ ì™„ë£Œ</span>
            </div>
          </div>
        )}

        {currentStatus === 'REJECTED' && (
          <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg">
            <div className="flex items-center gap-2 text-red-800">
              <FiAlertCircle className="w-5 h-5" />
              <span className="font-semibold">ê±°ë¶€ë¨</span>
            </div>
            <p className="mt-2 text-sm text-red-700">
              ê±°ë¶€ ì‚¬ìœ ë¥¼ í™•ì¸í•˜ê³  ìˆ˜ì • í›„ ë‹¤ì‹œ ì œì¶œí•´ì£¼ì„¸ìš”.
            </p>
          </div>
        )}

        {/* íŒŒì¼ ì—…ë¡œë“œ (PENDING ë˜ëŠ” REJECTED ìƒíƒœì¼ ë•Œë§Œ) */}
        {(currentStatus === 'PENDING' || currentStatus === 'REJECTED') && (
          <div className="space-y-4">
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                ê³ ê°ê³¼ì˜ í†µí™” ë…¹ìŒ íŒŒì¼
              </label>
              <div className="border-2 border-dashed border-gray-300 rounded-lg p-4">
                <input
                  ref={fileInputRef}
                  type="file"
                  accept="audio/mpeg,audio/mp3,audio/wav,audio/m4a"
                  onChange={handleFileSelect}
                  className="hidden"
                />
                {audioFile ? (
                  <div className="space-y-2">
                    <p className="text-sm text-gray-700">{audioFile.name}</p>
                    <p className="text-xs text-gray-500">
                      í¬ê¸°: {(audioFile.size / 1024 / 1024).toFixed(2)} MB
                    </p>
                    <button
                      onClick={() => {
                        setAudioFile(null);
                        if (fileInputRef.current) {
                          fileInputRef.current.value = '';
                        }
                      }}
                      className="text-sm text-red-600 hover:text-red-700"
                    >
                      íŒŒì¼ ì œê±°
                    </button>
                  </div>
                ) : (
                  <button
                    onClick={() => fileInputRef.current?.click()}
                    className="w-full flex flex-col items-center justify-center py-4 text-gray-500 hover:text-gray-700"
                  >
                    <FiUpload className="w-8 h-8 mb-2" />
                    <span className="text-sm">ë…¹ìŒ íŒŒì¼ ì„ íƒ</span>
                    <span className="text-xs mt-1">MP3, WAV, M4A (ìµœëŒ€ 50MB)</span>
                  </button>
                )}
              </div>
            </div>

            <div className="flex gap-2">
              <button
                onClick={handleSubmit}
                disabled={!audioFile || isUploading}
                className="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                {isUploading ? 'ì—…ë¡œë“œ ì¤‘...' : 'ìš”ì²­ ì œì¶œ'}
              </button>
              <button
                onClick={onClose}
                className="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
              >
                ì·¨ì†Œ
              </button>
            </div>
          </div>
        )}

        {/* ì·¨ì†Œ ë²„íŠ¼ (PENDING_APPROVAL ìƒíƒœì¼ ë•Œë§Œ) */}
        {currentStatus === 'PENDING_APPROVAL' && (
          <div className="mt-4">
            <button
              onClick={handleCancel}
              className="w-full px-4 py-2 border border-red-300 text-red-600 rounded-lg hover:bg-red-50"
            >
              ìš”ì²­ ì·¨ì†Œ
            </button>
          </div>
        )}
      </div>
    </div>
  );
}
```

#### 6-2. ìš”ì²­ ì·¨ì†Œ API ë§Œë“¤ê¸°

**ìƒˆ íŒŒì¼ ìƒì„±**: `app/api/affiliate/sales/[saleId]/cancel-confirmation/route.ts`

```typescript
// app/api/affiliate/sales/[saleId]/cancel-confirmation/route.ts
// íŒë§¤ í™•ì • ìš”ì²­ ì·¨ì†Œ API

import { NextRequest, NextResponse } from 'next/server';
import { cookies } from 'next/headers';
import prisma from '@/lib/prisma';

const SESSION_COOKIE = 'cg.sid.v2';

// ì„¸ì…˜ì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ìœ„ì™€ ë™ì¼)
async function getCurrentUser() {
  const sid = cookies().get(SESSION_COOKIE)?.value;
  if (!sid) return null;

  try {
    const session = await prisma.session.findUnique({
      where: { id: sid },
      include: {
        User: {
          select: { id: true, role: true },
        },
      },
    });

    if (!session || !session.User) return null;
    return session.User;
  } catch (error) {
    return null;
  }
}

/**
 * POST: íŒë§¤ í™•ì • ìš”ì²­ ì·¨ì†Œ
 */
export async function POST(
  req: NextRequest,
  { params }: { params: { saleId: string } }
) {
  try {
    // 1. ì‚¬ìš©ì í™•ì¸
    const user = await getCurrentUser();
    if (!user) {
      return NextResponse.json(
        { ok: false, error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' },
        { status: 401 }
      );
    }

    // 2. íŒë§¤ ID í™•ì¸
    const saleId = parseInt(params.saleId);
    if (isNaN(saleId)) {
      return NextResponse.json(
        { ok: false, error: 'ì˜¬ë°”ë¥¸ íŒë§¤ IDê°€ ì•„ë‹™ë‹ˆë‹¤' },
        { status: 400 }
      );
    }

    // 3. íŒë§¤ ì •ë³´ í™•ì¸
    const sale = await prisma.affiliateSale.findUnique({
      where: { id: saleId },
      include: {
        agent: {
          select: { userId: true },
        },
        manager: {
          select: { userId: true },
        },
      },
    });

    if (!sale) {
      return NextResponse.json(
        { ok: false, error: 'íŒë§¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' },
        { status: 404 }
      );
    }

    // 4. ê¶Œí•œ í™•ì¸ (ë³¸ì¸ì´ ì œì¶œí•œ ìš”ì²­ë§Œ ì·¨ì†Œ ê°€ëŠ¥)
    if (sale.submittedById !== user.id) {
      return NextResponse.json(
        { ok: false, error: 'ë³¸ì¸ì´ ì œì¶œí•œ ìš”ì²­ë§Œ ì·¨ì†Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤' },
        { status: 403 }
      );
    }

    // 5. ìƒíƒœ í™•ì¸ (PENDING_APPROVALë§Œ ì·¨ì†Œ ê°€ëŠ¥)
    if (sale.status !== 'PENDING_APPROVAL') {
      return NextResponse.json(
        { ok: false, error: 'ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ ìš”ì²­ë§Œ ì·¨ì†Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤' },
        { status: 400 }
      );
    }

    // 6. ìš”ì²­ ì·¨ì†Œ ì²˜ë¦¬ (ìƒíƒœë¥¼ PENDINGìœ¼ë¡œ ë˜ëŒë¦¼)
    const updatedSale = await prisma.affiliateSale.update({
      where: { id: saleId },
      data: {
        status: 'PENDING',
        submittedAt: null,
        submittedById: null,
        // Google Drive íŒŒì¼ì€ ê·¸ëŒ€ë¡œ ìœ ì§€ (ë‚˜ì¤‘ì— ì¬ì‚¬ìš© ê°€ëŠ¥)
      },
    });

    return NextResponse.json({
      ok: true,
      message: 'ìš”ì²­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤',
      sale: {
        id: updatedSale.id,
        status: updatedSale.status,
      },
    });
  } catch (error: any) {
    console.error('[Cancel Confirmation] Error:', error);
    return NextResponse.json(
      { ok: false, error: error.message || 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' },
      { status: 500 }
    );
  }
}
```

#### 6-3. íŒë§¤ì›/ëŒ€ë¦¬ì ì¥ ëŒ€ì‹œë³´ë“œì— í†µí•©

**íŒŒì¼**: `app/partner/[partnerId]/dashboard/PartnerDashboard.tsx`

**ì¶”ê°€í•  ë‚´ìš©**:

1. **ìƒíƒœ ë³€ìˆ˜ ì¶”ê°€** (íŒŒì¼ ìƒë‹¨, ë‹¤ë¥¸ useState ê·¼ì²˜):
```typescript
const [showSalesConfirmationModal, setShowSalesConfirmationModal] = useState(false);
const [selectedSaleForConfirmation, setSelectedSaleForConfirmation] = useState<{
  id: number;
  status: string;
  audioFileUrl?: string | null;
} | null>(null);
```

2. **íŒë§¤ ëª©ë¡ API í˜¸ì¶œ í•¨ìˆ˜ ì¶”ê°€**:
```typescript
const [mySales, setMySales] = useState<Array<{
  id: number;
  productCode: string;
  saleAmount: number;
  status: string;
  audioFileGoogleDriveUrl: string | null;
  saleDate: string | null;
}>>([]);

const loadMySales = async () => {
  try {
    const response = await fetch('/api/affiliate/sales/my-sales', {
      credentials: 'include',
    });
    const data = await response.json();
    if (response.ok && data.ok) {
      setMySales(data.sales || []);
    }
  } catch (error) {
    console.error('[PartnerDashboard] Failed to load sales:', error);
  }
};

// useEffectì— ì¶”ê°€
useEffect(() => {
  loadStats();
  loadMyContract();
  loadMySales(); // ì¶”ê°€
  if (isBranchManager) {
    loadContracts();
  }
}, [isBranchManager, loadMyContract]);
```

3. **íŒë§¤ ëª©ë¡ ì„¹ì…˜ ì¶”ê°€** (ëŒ€ì‹œë³´ë“œ JSX ë¶€ë¶„):
```typescript
{/* íŒë§¤ ëª©ë¡ ì„¹ì…˜ */}
<div className="bg-white rounded-lg shadow-md p-6">
  <h2 className="text-xl font-bold text-gray-800 mb-4">ë‚´ íŒë§¤ ëª©ë¡</h2>
  {mySales.length === 0 ? (
    <p className="text-gray-500">íŒë§¤ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p>
  ) : (
    <div className="space-y-3">
      {mySales.map((sale) => {
        const statusBadge = {
          PENDING: { label: 'í™•ì • ëŒ€ê¸°', color: 'bg-gray-100 text-gray-800' },
          PENDING_APPROVAL: { label: 'ìŠ¹ì¸ ëŒ€ê¸°', color: 'bg-yellow-100 text-yellow-800' },
          APPROVED: { label: 'ìŠ¹ì¸ ì™„ë£Œ', color: 'bg-green-100 text-green-800' },
          REJECTED: { label: 'ê±°ë¶€ë¨', color: 'bg-red-100 text-red-800' },
        }[sale.status] || { label: sale.status, color: 'bg-gray-100 text-gray-800' };

        return (
          <div key={sale.id} className="border border-gray-200 rounded-lg p-4">
            <div className="flex items-center justify-between">
              <div className="flex-1">
                <div className="flex items-center gap-3 mb-2">
                  <span className="font-semibold text-gray-800">#{sale.id}</span>
                  <span className={`px-2 py-1 rounded-full text-xs font-semibold ${statusBadge.color}`}>
                    {statusBadge.label}
                  </span>
                </div>
                <p className="text-sm text-gray-600">
                  ìƒí’ˆ: {sale.productCode} | ê¸ˆì•¡: {(sale.saleAmount / 10000).toLocaleString()}ë§Œì›
                </p>
              </div>
              <button
                onClick={() => {
                  setSelectedSaleForConfirmation({
                    id: sale.id,
                    status: sale.status,
                    audioFileUrl: sale.audioFileGoogleDriveUrl,
                  });
                  setShowSalesConfirmationModal(true);
                }}
                className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-semibold"
              >
                {sale.status === 'PENDING' || sale.status === 'REJECTED' ? 'í™•ì • ìš”ì²­' : 'ìƒì„¸ ë³´ê¸°'}
              </button>
            </div>
          </div>
        );
      })}
    </div>
  )}
</div>
```

4. **ëª¨ë‹¬ ì»´í¬ë„ŒíŠ¸ ì¶”ê°€** (íŒŒì¼ ë, return ë¬¸ ì•ˆ):
```typescript
{/* íŒë§¤ í™•ì • ëª¨ë‹¬ */}
{showSalesConfirmationModal && selectedSaleForConfirmation && (
  <SalesConfirmationModal
    saleId={selectedSaleForConfirmation.id}
    currentStatus={selectedSaleForConfirmation.status}
    audioFileUrl={selectedSaleForConfirmation.audioFileUrl}
    onClose={() => {
      setShowSalesConfirmationModal(false);
      setSelectedSaleForConfirmation(null);
    }}
    onSuccess={() => {
      loadMySales(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
    }}
  />
)}
```

5. **import ì¶”ê°€** (íŒŒì¼ ìƒë‹¨):
```typescript
import SalesConfirmationModal from '@/components/affiliate/SalesConfirmationModal';
```

**ì¶”ê°€ë¡œ í•„ìš”í•œ API**: `app/api/affiliate/sales/my-sales/route.ts`

```typescript
// app/api/affiliate/sales/my-sales/route.ts
// ë‚´ íŒë§¤ ëª©ë¡ ì¡°íšŒ API

import { NextRequest, NextResponse } from 'next/server';
import { cookies } from 'next/headers';
import prisma from '@/lib/prisma';

const SESSION_COOKIE = 'cg.sid.v2';

async function getCurrentUser() {
  const sid = cookies().get(SESSION_COOKIE)?.value;
  if (!sid) return null;

  try {
    const session = await prisma.session.findUnique({
      where: { id: sid },
      include: {
        User: {
          select: { id: true },
        },
      },
    });
    return session?.User || null;
  } catch (error) {
    return null;
  }
}

export async function GET(req: NextRequest) {
  try {
    const user = await getCurrentUser();
    if (!user) {
      return NextResponse.json({ ok: false, error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, { status: 401 });
    }

    // ì‚¬ìš©ìì˜ ì–´í•„ë¦¬ì—ì´íŠ¸ í”„ë¡œí•„ ì°¾ê¸°
    const profile = await prisma.affiliateProfile.findUnique({
      where: { userId: user.id },
      select: { id: true, type: true },
    });

    if (!profile) {
      return NextResponse.json({ ok: true, sales: [] });
    }

    // ë³¸ì¸ íŒë§¤ë§Œ ì¡°íšŒ
    const where: any = {};
    if (profile.type === 'SALES_AGENT') {
      where.agentId = profile.id;
    } else if (profile.type === 'BRANCH_MANAGER') {
      where.managerId = profile.id;
    } else {
      return NextResponse.json({ ok: true, sales: [] });
    }

    const sales = await prisma.affiliateSale.findMany({
      where,
      select: {
        id: true,
        productCode: true,
        saleAmount: true,
        status: true,
        audioFileGoogleDriveUrl: true,
        saleDate: true,
        submittedAt: true,
        approvedAt: true,
      },
      orderBy: {
        createdAt: 'desc',
      },
      take: 50, // ìµœê·¼ 50ê°œë§Œ
    });

    return NextResponse.json({
      ok: true,
      sales,
    });
  } catch (error: any) {
    console.error('[My Sales] Error:', error);
    return NextResponse.json(
      { ok: false, error: error.message || 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' },
      { status: 500 }
    );
  }
}
```

#### 6-4. ê´€ë¦¬ì ìŠ¹ì¸ ëŒ€ê¸° í˜ì´ì§€

**ìƒˆ íŒŒì¼ ìƒì„±**: `app/admin/affiliate/sales/pending-approval/page.tsx`

```typescript
'use client';

import { useState, useEffect } from 'react';
import { FiCheckCircle, FiXCircle, FiExternalLink, FiRefreshCw, FiClock } from 'react-icons/fi';
import { showError, showSuccess } from '@/components/ui/Toast';

interface PendingSale {
  id: number;
  productCode: string;
  productTitle: string | null;
  saleAmount: number;
  saleDate: string | null;
  submittedAt: string;
  audioFileGoogleDriveUrl: string | null;
  audioFileName: string | null;
  agent: {
    name: string | null;
    code: string;
    phone: string | null;
  } | null;
  manager: {
    name: string | null;
    code: string;
    phone: string | null;
  } | null;
}

export default function PendingApprovalPage() {
  const [sales, setSales] = useState<PendingSale[]>([]);
  const [loading, setLoading] = useState(true);
  const [approvingId, setApprovingId] = useState<number | null>(null);
  const [rejectingId, setRejectingId] = useState<number | null>(null);
  const [rejectReason, setRejectReason] = useState('');
  const [showRejectModal, setShowRejectModal] = useState<number | null>(null);

  // ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
  const loadPendingSales = async () => {
    try {
      setLoading(true);
      const response = await fetch('/api/admin/affiliate/sales/pending-approval', {
        credentials: 'include',
      });
      const data = await response.json();

      if (response.ok && data.ok) {
        setSales(data.sales || []);
      } else {
        showError(data.error || 'ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
      }
    } catch (error: any) {
      console.error('[Pending Approval] Load error:', error);
      showError('ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    loadPendingSales();
  }, []);

  // ìŠ¹ì¸ ì²˜ë¦¬
  const handleApprove = async (saleId: number) => {
    if (!confirm('ì´ íŒë§¤ë¥¼ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ìŠ¹ì¸ ì‹œ ìˆ˜ë‹¹ì´ ìë™ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤.')) {
      return;
    }

    try {
      setApprovingId(saleId);
      const response = await fetch(`/api/admin/affiliate/sales/${saleId}/approve`, {
        method: 'POST',
        credentials: 'include',
      });
      const data = await response.json();

      if (response.ok && data.ok) {
        showSuccess('íŒë§¤ê°€ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤');
        loadPendingSales(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
      } else {
        showError(data.error || 'ìŠ¹ì¸ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
      }
    } catch (error: any) {
      console.error('[Pending Approval] Approve error:', error);
      showError('ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    } finally {
      setApprovingId(null);
    }
  };

  // ê±°ë¶€ ì²˜ë¦¬
  const handleReject = async (saleId: number) => {
    if (!rejectReason.trim()) {
      showError('ê±°ë¶€ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
      return;
    }

    try {
      setRejectingId(saleId);
      const response = await fetch(`/api/admin/affiliate/sales/${saleId}/reject`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ reason: rejectReason }),
      });
      const data = await response.json();

      if (response.ok && data.ok) {
        showSuccess('íŒë§¤ê°€ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤');
        setShowRejectModal(null);
        setRejectReason('');
        loadPendingSales(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
      } else {
        showError(data.error || 'ê±°ë¶€ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
      }
    } catch (error: any) {
      console.error('[Pending Approval] Reject error:', error);
      showError('ê±°ë¶€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    } finally {
      setRejectingId(null);
    }
  };

  // ê¸ˆì•¡ í¬ë§·íŒ…
  const formatAmount = (amount: number) => {
    return `${(amount / 10000).toLocaleString()}ë§Œì›`;
  };

  // ë‚ ì§œ í¬ë§·íŒ…
  const formatDate = (dateString: string | null) => {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleDateString('ko-KR', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
    });
  };

  return (
    <div className="space-y-6 p-6">
      {/* í—¤ë” */}
      <div className="bg-white rounded-lg shadow-md p-6">
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-3xl font-bold text-gray-800 mb-2">
              â³ íŒë§¤ í™•ì • ìŠ¹ì¸ ëŒ€ê¸°
            </h1>
            <p className="text-gray-600">
              ë…¹ìŒ íŒŒì¼ì„ í™•ì¸í•˜ê³  íŒë§¤ í™•ì •ì„ ìŠ¹ì¸í•˜ê±°ë‚˜ ê±°ë¶€í•˜ì„¸ìš”.
            </p>
          </div>
          <button
            onClick={loadPendingSales}
            disabled={loading}
            className="inline-flex items-center gap-2 rounded-lg bg-gray-100 px-4 py-2 text-sm font-semibold text-gray-700 hover:bg-gray-200 disabled:opacity-50"
          >
            <FiRefreshCw className={loading ? 'animate-spin' : ''} />
            ìƒˆë¡œê³ ì¹¨
          </button>
        </div>
      </div>

      {/* ëª©ë¡ */}
      {loading ? (
        <div className="text-center py-12">
          <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
          <p className="mt-2 text-gray-600">ë¡œë”© ì¤‘...</p>
        </div>
      ) : sales.length === 0 ? (
        <div className="bg-white rounded-lg shadow-md p-12 text-center">
          <FiCheckCircle className="w-16 h-16 text-green-500 mx-auto mb-4" />
          <p className="text-xl font-semibold text-gray-800">ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ íŒë§¤ê°€ ì—†ìŠµë‹ˆë‹¤</p>
          <p className="text-gray-600 mt-2">ëª¨ë“  íŒë§¤ê°€ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
        </div>
      ) : (
        <div className="space-y-4">
          {sales.map((sale) => (
            <div key={sale.id} className="bg-white rounded-lg shadow-md p-6">
              <div className="flex items-start justify-between">
                {/* ì™¼ìª½: íŒë§¤ ì •ë³´ */}
                <div className="flex-1">
                  <div className="flex items-center gap-3 mb-3">
                    <span className="text-2xl font-bold text-blue-600">#{sale.id}</span>
                    <span className="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm font-semibold">
                      ìŠ¹ì¸ ëŒ€ê¸° ì¤‘
                    </span>
                  </div>

                  <div className="grid grid-cols-2 gap-4 mb-4">
                    <div>
                      <p className="text-sm text-gray-500">ìƒí’ˆ</p>
                      <p className="font-semibold text-gray-800">
                        {sale.productTitle || sale.productCode}
                      </p>
                    </div>
                    <div>
                      <p className="text-sm text-gray-500">íŒë§¤ ê¸ˆì•¡</p>
                      <p className="font-semibold text-gray-800">{formatAmount(sale.saleAmount)}</p>
                    </div>
                    <div>
                      <p className="text-sm text-gray-500">ìš”ì²­ ì œì¶œ ì‹œê°„</p>
                      <p className="font-semibold text-gray-800">{formatDate(sale.submittedAt)}</p>
                    </div>
                    <div>
                      <p className="text-sm text-gray-500">ë‹´ë‹¹ì</p>
                      <p className="font-semibold text-gray-800">
                        {sale.agent
                          ? `íŒë§¤ì›: ${sale.agent.name || 'ì´ë¦„ ì—†ìŒ'} (${sale.agent.code})`
                          : sale.manager
                          ? `ëŒ€ë¦¬ì ì¥: ${sale.manager.name || 'ì´ë¦„ ì—†ìŒ'} (${sale.manager.code})`
                          : 'ë‹´ë‹¹ì ì—†ìŒ'}
                      </p>
                    </div>
                  </div>

                  {/* ë…¹ìŒ íŒŒì¼ ë§í¬ */}
                  {sale.audioFileGoogleDriveUrl && (
                    <div className="mb-4">
                      <a
                        href={sale.audioFileGoogleDriveUrl}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="inline-flex items-center gap-2 text-blue-600 hover:text-blue-700 font-semibold"
                      >
                        <FiExternalLink />
                        ë…¹ìŒ íŒŒì¼ í™•ì¸í•˜ê¸° (Google Drive)
                        {sale.audioFileName && (
                          <span className="text-sm text-gray-500">({sale.audioFileName})</span>
                        )}
                      </a>
                    </div>
                  )}
                </div>

                {/* ì˜¤ë¥¸ìª½: ì•¡ì…˜ ë²„íŠ¼ */}
                <div className="flex flex-col gap-2 ml-6">
                  <button
                    onClick={() => handleApprove(sale.id)}
                    disabled={approvingId === sale.id}
                    className="inline-flex items-center justify-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed min-w-[120px]"
                  >
                    {approvingId === sale.id ? (
                      <>
                        <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                        ìŠ¹ì¸ ì¤‘...
                      </>
                    ) : (
                      <>
                        <FiCheckCircle />
                        ìŠ¹ì¸
                      </>
                    )}
                  </button>
                  <button
                    onClick={() => setShowRejectModal(sale.id)}
                    disabled={rejectingId === sale.id}
                    className="inline-flex items-center justify-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed min-w-[120px]"
                  >
                    <FiXCircle />
                    ê±°ë¶€
                  </button>
                </div>
              </div>
            </div>
          ))}
        </div>
      )}

      {/* ê±°ë¶€ ì‚¬ìœ  ì…ë ¥ ëª¨ë‹¬ */}
      {showRejectModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
            <h3 className="text-xl font-bold text-gray-800 mb-4">ê±°ë¶€ ì‚¬ìœ  ì…ë ¥</h3>
            <textarea
              value={rejectReason}
              onChange={(e) => setRejectReason(e.target.value)}
              placeholder="ê±°ë¶€ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”..."
              className="w-full h-32 border border-gray-300 rounded-lg px-3 py-2 focus:border-red-500 focus:outline-none focus:ring-2 focus:ring-red-100"
            />
            <div className="flex gap-2 mt-4">
              <button
                onClick={() => handleReject(showRejectModal)}
                disabled={!rejectReason.trim() || rejectingId === showRejectModal}
                className="flex-1 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                {rejectingId === showRejectModal ? 'ì²˜ë¦¬ ì¤‘...' : 'ê±°ë¶€í•˜ê¸°'}
              </button>
              <button
                onClick={() => {
                  setShowRejectModal(null);
                  setRejectReason('');
                }}
                className="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
              >
                ì·¨ì†Œ
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
```

### ğŸ“Œ ì„¤ëª…
- ê´€ë¦¬ìê°€ ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ ëª¨ë“  íŒë§¤ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤
- ê° íŒë§¤ë§ˆë‹¤ Google Drive ë§í¬ê°€ ìˆì–´ ë°”ë¡œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
- ìŠ¹ì¸/ê±°ë¶€ ë²„íŠ¼ìœ¼ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
- ê±°ë¶€ ì‹œ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤

---

## 7. 6ë‹¨ê³„: ì•Œë¦¼ ê¸°ëŠ¥ ì¶”ê°€

### ğŸ“ ì„¤ëª…
ìŠ¹ì¸/ê±°ë¶€ ì‹œ íŒë§¤ì›/ëŒ€ë¦¬ì ì¥ì—ê²Œ ì•Œë¦¼ì„ ë³´ëƒ…ë‹ˆë‹¤.

### ğŸ”§ ì‘ì—… ë‚´ìš©

**íŒŒì¼**: `lib/affiliate/sales-notification.ts` (ìƒˆë¡œ ë§Œë“¤ê¸°)

```typescript
// lib/affiliate/sales-notification.ts
// íŒë§¤ í™•ì • ê´€ë ¨ ì•Œë¦¼

import prisma from '@/lib/prisma';
import { sendNotificationToUser } from '@/lib/push/server';

/**
 * íŒë§¤ í™•ì • ìŠ¹ì¸ ì•Œë¦¼
 */
export async function notifySaleApproved(saleId: number) {
  try {
    const sale = await prisma.affiliateSale.findUnique({
      where: { id: saleId },
      include: {
        agent: {
          include: {
            user: {
              select: { id: true, name: true },
            },
          },
        },
        manager: {
          include: {
            user: {
              select: { id: true, name: true },
            },
          },
        },
      },
    });

    if (!sale) return;

    // íŒë§¤ì›ì—ê²Œ ì•Œë¦¼
    if (sale.agentId && sale.agent?.user) {
      await sendNotificationToUser(sale.agent.user.id, {
        title: 'âœ… íŒë§¤ í™•ì • ìŠ¹ì¸',
        body: `íŒë§¤ #${saleId}ì´(ê°€) ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. ìˆ˜ë‹¹ì´ ê³„ì‚°ë˜ì—ˆìŠµë‹ˆë‹¤.`,
        data: { saleId, type: 'sale_approved' },
      });
    }

    // ëŒ€ë¦¬ì ì¥ì—ê²Œ ì•Œë¦¼ (íŒë§¤ì›ì´ ì•„ë‹Œ ê²½ìš°)
    if (sale.managerId && sale.manager?.user && !sale.agentId) {
      await sendNotificationToUser(sale.manager.user.id, {
        title: 'âœ… íŒë§¤ í™•ì • ìŠ¹ì¸',
        body: `íŒë§¤ #${saleId}ì´(ê°€) ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. ìˆ˜ë‹¹ì´ ê³„ì‚°ë˜ì—ˆìŠµë‹ˆë‹¤.`,
        data: { saleId, type: 'sale_approved' },
      });
    }
  } catch (error) {
    console.error('[Notify Sale Approved] Error:', error);
  }
}

/**
 * íŒë§¤ í™•ì • ê±°ë¶€ ì•Œë¦¼
 */
export async function notifySaleRejected(saleId: number, reason: string) {
  try {
    const sale = await prisma.affiliateSale.findUnique({
      where: { id: saleId },
      include: {
        agent: {
          include: {
            user: {
              select: { id: true, name: true },
            },
          },
        },
        manager: {
          include: {
            user: {
              select: { id: true, name: true },
            },
          },
        },
      },
    });

    if (!sale) return;

    // íŒë§¤ì›ì—ê²Œ ì•Œë¦¼
    if (sale.agentId && sale.agent?.user) {
      await sendNotificationToUser(sale.agent.user.id, {
        title: 'âŒ íŒë§¤ í™•ì • ê±°ë¶€',
        body: `íŒë§¤ #${saleId}ì´(ê°€) ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ì‚¬ìœ : ${reason}`,
        data: { saleId, type: 'sale_rejected', reason },
      });
    }

    // ëŒ€ë¦¬ì ì¥ì—ê²Œ ì•Œë¦¼
    if (sale.managerId && sale.manager?.user && !sale.agentId) {
      await sendNotificationToUser(sale.manager.user.id, {
        title: 'âŒ íŒë§¤ í™•ì • ê±°ë¶€',
        body: `íŒë§¤ #${saleId}ì´(ê°€) ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ì‚¬ìœ : ${reason}`,
        data: { saleId, type: 'sale_rejected', reason },
      });
    }
  } catch (error) {
    console.error('[Notify Sale Rejected] Error:', error);
  }
}
```

**ìŠ¹ì¸/ê±°ë¶€ APIì— ì•Œë¦¼ ì¶”ê°€**:

ìŠ¹ì¸ API (`app/api/admin/affiliate/sales/[saleId]/approve/route.ts`)ì— ì¶”ê°€:
```typescript
import { notifySaleApproved } from '@/lib/affiliate/sales-notification';

// ìŠ¹ì¸ ì²˜ë¦¬ í›„:
await notifySaleApproved(saleId);
```

ê±°ë¶€ API (`app/api/admin/affiliate/sales/[saleId]/reject/route.ts`)ì— ì¶”ê°€:
```typescript
import { notifySaleRejected } from '@/lib/affiliate/sales-notification';

// ê±°ë¶€ ì²˜ë¦¬ í›„:
await notifySaleRejected(saleId, reason);
```

---

## 8. í…ŒìŠ¤íŠ¸ ë°©ë²•

### ğŸ“ ë‹¨ê³„ë³„ í…ŒìŠ¤íŠ¸

1. **ë°ì´í„°ë² ì´ìŠ¤ í…ŒìŠ¤íŠ¸**
   - Prisma Studio ì—´ê¸°: `npx prisma studio`
   - AffiliateSale í…Œì´ë¸” í™•ì¸
   - ìƒˆ í•„ë“œë“¤ì´ ì¶”ê°€ë˜ì—ˆëŠ”ì§€ í™•ì¸

2. **íŒŒì¼ ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸**
   - íŒë§¤ í™•ì • ìš”ì²­ API í˜¸ì¶œ
   - Google Driveì— íŒŒì¼ì´ ì—…ë¡œë“œë˜ëŠ”ì§€ í™•ì¸
   - ë§í¬ê°€ ì •ìƒì ìœ¼ë¡œ ìƒì„±ë˜ëŠ”ì§€ í™•ì¸

3. **ìŠ¹ì¸/ê±°ë¶€ í…ŒìŠ¤íŠ¸**
   - ê´€ë¦¬ìë¡œ ë¡œê·¸ì¸
   - ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡ í™•ì¸
   - ìŠ¹ì¸/ê±°ë¶€ ì‹¤í–‰
   - ìˆ˜ë‹¹ ê³„ì‚° í™•ì¸

4. **ì•Œë¦¼ í…ŒìŠ¤íŠ¸**
   - í‘¸ì‹œ ì•Œë¦¼ì´ ì •ìƒì ìœ¼ë¡œ ì „ì†¡ë˜ëŠ”ì§€ í™•ì¸

---

## ğŸ“Œ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •

`.env.local` íŒŒì¼ì— ì¶”ê°€ (ì´ë¯¸ ìˆìœ¼ë©´ í™•ì¸ë§Œ):

```bash
# Google Drive Service Account ì„¤ì • (ì´ë¯¸ ìˆì„ ìˆ˜ ìˆìŒ)
GOOGLE_DRIVE_SERVICE_ACCOUNT_EMAIL=your-service-account@project.iam.gserviceaccount.com
GOOGLE_DRIVE_SERVICE_ACCOUNT_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n"
GOOGLE_DRIVE_SHARED_DRIVE_ID=your_shared_drive_id  # ì„ íƒì‚¬í•­

# ë…¹ìŒ íŒŒì¼ ì €ì¥ í´ë” (ì„ íƒì‚¬í•­, ì—†ìœ¼ë©´ rootì— ì €ì¥)
GOOGLE_DRIVE_SALES_AUDIO_FOLDER_ID=your_folder_id
```

### ğŸ“ Google Drive í´ë” ID ì°¾ëŠ” ë°©ë²•
1. Google Driveì—ì„œ í´ë”ë¥¼ ì—½ë‹ˆë‹¤
2. URLì„ í™•ì¸í•©ë‹ˆë‹¤: `https://drive.google.com/drive/folders/ì—¬ê¸°ê°€í´ë”ID`
3. í´ë” IDë¥¼ ë³µì‚¬í•´ì„œ í™˜ê²½ ë³€ìˆ˜ì— ë„£ìŠµë‹ˆë‹¤

---

## âš ï¸ ì£¼ì˜ì‚¬í•­

1. **Google Drive ê¶Œí•œ**: Service Account ë˜ëŠ” OAuth ì„¤ì • í•„ìš”
2. **íŒŒì¼ í¬ê¸°**: 50MB ì œí•œ í™•ì¸
3. **ì—ëŸ¬ ì²˜ë¦¬**: ëª¨ë“  APIì— ì—ëŸ¬ ì²˜ë¦¬ í¬í•¨
4. **ë³´ì•ˆ**: ê¶Œí•œ í™•ì¸ í•„ìˆ˜

---

## ğŸ‰ ì™„ë£Œ ì²´í¬ë¦¬ìŠ¤íŠ¸

### 1ë‹¨ê³„: ë°ì´í„°ë² ì´ìŠ¤
- [ ] `prisma/schema.prisma`ì— AffiliateSale í•„ë“œ ì¶”ê°€
- [ ] `npx prisma db push` ì‹¤í–‰
- [ ] Prisma Studioë¡œ ìƒˆ í•„ë“œ í™•ì¸

### 2ë‹¨ê³„: Google Drive í•¨ìˆ˜
- [ ] `lib/google-drive.ts`ì— `uploadAudioFileToDrive` í•¨ìˆ˜ ì¶”ê°€
- [ ] í™˜ê²½ ë³€ìˆ˜ ì„¤ì • í™•ì¸

### 3ë‹¨ê³„: API ë§Œë“¤ê¸°
- [ ] `app/api/affiliate/sales/[saleId]/submit-confirmation/route.ts` ìƒì„±
- [ ] `app/api/affiliate/sales/[saleId]/cancel-confirmation/route.ts` ìƒì„±
- [ ] `app/api/admin/affiliate/sales/[saleId]/approve/route.ts` ìƒì„±
- [ ] `app/api/admin/affiliate/sales/[saleId]/reject/route.ts` ìƒì„±
- [ ] `app/api/admin/affiliate/sales/pending-approval/route.ts` ìƒì„±

### 4ë‹¨ê³„: ì•Œë¦¼ ê¸°ëŠ¥
- [ ] `lib/affiliate/sales-notification.ts` ìƒì„±
- [ ] ìŠ¹ì¸ APIì— ì•Œë¦¼ ì¶”ê°€
- [ ] ê±°ë¶€ APIì— ì•Œë¦¼ ì¶”ê°€

### 5ë‹¨ê³„: UI ë§Œë“¤ê¸°
- [ ] `components/affiliate/SalesConfirmationModal.tsx` ìƒì„±
- [ ] `app/admin/affiliate/sales/pending-approval/page.tsx` ìƒì„±
- [ ] íŒë§¤ì›/ëŒ€ë¦¬ì ì¥ ëŒ€ì‹œë³´ë“œì— ëª¨ë‹¬ í†µí•©

### 6ë‹¨ê³„: í…ŒìŠ¤íŠ¸
- [ ] íŒë§¤ í™•ì • ìš”ì²­ í…ŒìŠ¤íŠ¸
- [ ] Google Drive ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸
- [ ] ê´€ë¦¬ì ìŠ¹ì¸/ê±°ë¶€ í…ŒìŠ¤íŠ¸
- [ ] ì•Œë¦¼ ì „ì†¡ í…ŒìŠ¤íŠ¸
- [ ] ìˆ˜ë‹¹ ìë™ ê³„ì‚° í™•ì¸

---

## ğŸ“š êµ¬í˜„ ìš°ì„ ìˆœìœ„ (ë‹¨ê³„ë³„)

### â­ ìµœìš°ì„  (1ì¼ì°¨)
1. **ë°ì´í„°ë² ì´ìŠ¤ ìˆ˜ì •** (30ë¶„)
   - ìŠ¤í‚¤ë§ˆ ìˆ˜ì •
   - ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰

2. **Google Drive í•¨ìˆ˜** (30ë¶„)
   - `uploadAudioFileToDrive` í•¨ìˆ˜ ì¶”ê°€
   - í…ŒìŠ¤íŠ¸

3. **íŒë§¤ í™•ì • ìš”ì²­ API** (1ì‹œê°„)
   - íŒŒì¼ ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸
   - ê¶Œí•œ í™•ì¸ í…ŒìŠ¤íŠ¸

### ğŸ”¥ ì¤‘ìš” (2ì¼ì°¨)
4. **ê´€ë¦¬ì ìŠ¹ì¸/ê±°ë¶€ API** (1ì‹œê°„)
   - ìŠ¹ì¸ API
   - ê±°ë¶€ API
   - ìˆ˜ë‹¹ ê³„ì‚° ì—°ê²°

5. **ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡ API** (30ë¶„)
   - ëª©ë¡ ì¡°íšŒ í…ŒìŠ¤íŠ¸

### ğŸ’¡ ë³´ì™„ (3ì¼ì°¨)
6. **ì•Œë¦¼ ê¸°ëŠ¥** (1ì‹œê°„)
   - ì•Œë¦¼ í•¨ìˆ˜ ë§Œë“¤ê¸°
   - APIì— ì—°ê²°

7. **UI êµ¬í˜„** (2-3ì‹œê°„)
   - ëª¨ë‹¬ ì»´í¬ë„ŒíŠ¸
   - ê´€ë¦¬ì í˜ì´ì§€
   - ëŒ€ì‹œë³´ë“œ í†µí•©

8. **í…ŒìŠ¤íŠ¸ ë° ìˆ˜ì •** (1-2ì‹œê°„)
   - ì „ì²´ í”Œë¡œìš° í…ŒìŠ¤íŠ¸
   - ë²„ê·¸ ìˆ˜ì •

---

## ğŸš¨ ì£¼ì˜ì‚¬í•­ ë° íŒ

### 1. Google Drive ì„¤ì •
- Service Account í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤
- í´ë” IDëŠ” ì„ íƒì‚¬í•­ì…ë‹ˆë‹¤ (ì—†ìœ¼ë©´ rootì— ì €ì¥)
- ê³µê°œ ë§í¬ê°€ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤

### 2. íŒŒì¼ í¬ê¸° ì œí•œ
- ìµœëŒ€ 50MBë¡œ ì œí•œí–ˆìŠµë‹ˆë‹¤
- ë” í° íŒŒì¼ì´ í•„ìš”í•˜ë©´ í™˜ê²½ ë³€ìˆ˜ë¡œ ì¡°ì • ê°€ëŠ¥

### 3. ì—ëŸ¬ ì²˜ë¦¬
- ëª¨ë“  APIì— try-catch ì¶”ê°€í–ˆìŠµë‹ˆë‹¤
- ì‚¬ìš©ìì—ê²Œ ëª…í™•í•œ ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ

### 4. ë³´ì•ˆ
- ë³¸ì¸ íŒë§¤ë§Œ ìš”ì²­ ê°€ëŠ¥
- ê´€ë¦¬ìë§Œ ìŠ¹ì¸/ê±°ë¶€ ê°€ëŠ¥
- ì„¸ì…˜ í™•ì¸ í•„ìˆ˜

### 5. ê¸°ì¡´ ê¸°ëŠ¥ê³¼ì˜ í˜¸í™˜ì„±
- ê¸°ì¡´ `CONFIRMED` ìƒíƒœëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€
- ìƒˆ í”„ë¡œì„¸ìŠ¤ëŠ” `PENDING_APPROVAL` â†’ `APPROVED` ì‚¬ìš©

---

## ğŸ’¬ ì§ˆë¬¸ì´ ìˆìœ¼ë©´?

êµ¬í˜„ ì¤‘ ë¬¸ì œê°€ ìƒê¸°ê±°ë‚˜ ì´í•´ê°€ ì•ˆ ë˜ëŠ” ë¶€ë¶„ì´ ìˆìœ¼ë©´ ì–¸ì œë“ ì§€ ë¬¼ì–´ë³´ì„¸ìš”!

---

## âš ï¸ ê¸°ì¡´ ê´€ë¦¬ì íŒ¨ë„ ì—°ê²° ë¬¸ì œì  í™•ì¸

### ë°œê²¬ëœ ë¬¸ì œì 

1. **ìˆ˜ë‹¹ ì¡°ì • ìŠ¹ì¸ í˜ì´ì§€** (`/admin/affiliate/adjustments`)
   - "êµ¬ë§¤ ì™„ë£Œ ìŠ¹ì¸" íƒ­ì—ì„œ ì‚¬ìš©í•˜ëŠ” `/api/admin/affiliate/sales/[saleId]/approve-commission` API ì¡´ì¬ ì—¬ë¶€ í™•ì¸ í•„ìš”
   - ì´ APIê°€ ì—†ìœ¼ë©´ êµ¬ë§¤ ì™„ë£Œ ìŠ¹ì¸ ê¸°ëŠ¥ì´ ì‘ë™í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ

2. **ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡ API**
   - ê¸°ì¡´ APIëŠ” `PENDING` ìƒíƒœë§Œ í™•ì¸
   - ìƒˆë¡œìš´ í”„ë¡œì„¸ìŠ¤ëŠ” `PENDING_APPROVAL` ìƒíƒœ ì‚¬ìš©
   - ë‘ í”„ë¡œì„¸ìŠ¤ê°€ ê³µì¡´í•  ìˆ˜ ìˆë„ë¡ API ìˆ˜ì • í•„ìš”

3. **ë°ì´í„° í˜•ì‹ ë¶ˆì¼ì¹˜**
   - ì¼ë¶€ APIëŠ” `{ ok: true, error: '...' }` í˜•ì‹
   - ì¼ë¶€ APIëŠ” `{ ok: true, message: '...' }` í˜•ì‹
   - í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì¼ê´€ë˜ì§€ ì•Šê²Œ ì²˜ë¦¬í•  ìˆ˜ ìˆìŒ

**ìƒì„¸ ë‚´ìš©ì€ `ADMIN_AFFILIATE_CONNECTION_ISSUES.md` íŒŒì¼ ì°¸ì¡°**

---

## ğŸ“– ì „ì²´ ìš”ì•½ (í•œëˆˆì— ë³´ê¸°)

### ğŸ¯ ëª©í‘œ
íŒë§¤ì›/ëŒ€ë¦¬ì ì¥ì´ ê³ ê°ê³¼ì˜ í†µí™” ë…¹ìŒì„ Google Driveì— ì—…ë¡œë“œí•˜ê³ , ê´€ë¦¬ìê°€ í™•ì¸ í›„ ìŠ¹ì¸í•˜ë©´ ìë™ìœ¼ë¡œ ìˆ˜ë‹¹ì´ ê³„ì‚°ë˜ëŠ” ì‹œìŠ¤í…œ

### ğŸ“‹ ë§Œë“¤ íŒŒì¼ ëª©ë¡

#### ë°ì´í„°ë² ì´ìŠ¤
- `prisma/schema.prisma` (ìˆ˜ì •)

#### í•¨ìˆ˜/ìœ í‹¸ë¦¬í‹°
- `lib/google-drive.ts` (í•¨ìˆ˜ ì¶”ê°€)
- `lib/affiliate/sales-notification.ts` (ìƒˆë¡œ ë§Œë“¤ê¸°)

#### API (5ê°œ)
- `app/api/affiliate/sales/[saleId]/submit-confirmation/route.ts` (ìƒˆë¡œ ë§Œë“¤ê¸°)
- `app/api/affiliate/sales/[saleId]/cancel-confirmation/route.ts` (ìƒˆë¡œ ë§Œë“¤ê¸°)
- `app/api/affiliate/sales/my-sales/route.ts` (ìƒˆë¡œ ë§Œë“¤ê¸°)
- `app/api/admin/affiliate/sales/[saleId]/approve/route.ts` (ìƒˆë¡œ ë§Œë“¤ê¸°)
- `app/api/admin/affiliate/sales/[saleId]/reject/route.ts` (ìƒˆë¡œ ë§Œë“¤ê¸°)
- `app/api/admin/affiliate/sales/pending-approval/route.ts` (ìƒˆë¡œ ë§Œë“¤ê¸°)

#### UI ì»´í¬ë„ŒíŠ¸
- `components/affiliate/SalesConfirmationModal.tsx` (ìƒˆë¡œ ë§Œë“¤ê¸°)
- `app/admin/affiliate/sales/pending-approval/page.tsx` (ìƒˆë¡œ ë§Œë“¤ê¸°)
- `app/partner/[partnerId]/dashboard/PartnerDashboard.tsx` (ìˆ˜ì •)

### ğŸ”„ í”„ë¡œì„¸ìŠ¤ ìš”ì•½

1. **íŒë§¤ ìƒì„±** (ìë™)
   - ê°ì ëª°ì—ì„œ ê²°ì œ ì™„ë£Œ ì‹œ ìë™ ìƒì„±

2. **íŒë§¤ í™•ì • ìš”ì²­** (íŒë§¤ì›/ëŒ€ë¦¬ì ì¥)
   - ëŒ€ì‹œë³´ë“œì—ì„œ "í™•ì • ìš”ì²­" í´ë¦­
   - ë…¹ìŒ íŒŒì¼ ì—…ë¡œë“œ
   - Google Driveì— ì €ì¥
   - ìƒíƒœ: `PENDING` â†’ `PENDING_APPROVAL`

3. **ê´€ë¦¬ì í™•ì¸** (ê´€ë¦¬ì)
   - ìŠ¹ì¸ ëŒ€ê¸° í˜ì´ì§€ì—ì„œ ëª©ë¡ í™•ì¸
   - Google Drive ë§í¬ í´ë¦­í•˜ì—¬ ë…¹ìŒ í™•ì¸
   - ìŠ¹ì¸ ë˜ëŠ” ê±°ë¶€

4. **ìŠ¹ì¸ ì‹œ** (ìë™)
   - ìƒíƒœ: `PENDING_APPROVAL` â†’ `APPROVED`
   - ìˆ˜ë‹¹ ìë™ ê³„ì‚°
   - CommissionLedger ìƒì„±
   - íŒë§¤ì›/ëŒ€ë¦¬ì ì¥ì—ê²Œ ì•Œë¦¼

5. **ê±°ë¶€ ì‹œ**
   - ìƒíƒœ: `PENDING_APPROVAL` â†’ `REJECTED`
   - íŒë§¤ì›/ëŒ€ë¦¬ì ì¥ì—ê²Œ ì•Œë¦¼
   - ìˆ˜ì • í›„ ì¬ìš”ì²­ ê°€ëŠ¥

### âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸ (ê°„ë‹¨ ë²„ì „)

1. [ ] ë°ì´í„°ë² ì´ìŠ¤ ìˆ˜ì •
2. [ ] Google Drive í•¨ìˆ˜ ì¶”ê°€
3. [ ] íŒë§¤ í™•ì • ìš”ì²­ API
4. [ ] ìš”ì²­ ì·¨ì†Œ API
5. [ ] ë‚´ íŒë§¤ ëª©ë¡ API
6. [ ] ê´€ë¦¬ì ìŠ¹ì¸ API
7. [ ] ê´€ë¦¬ì ê±°ë¶€ API
8. [ ] ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡ API
9. [ ] ì•Œë¦¼ í•¨ìˆ˜
10. [ ] íŒë§¤ í™•ì • ëª¨ë‹¬ ì»´í¬ë„ŒíŠ¸
11. [ ] ê´€ë¦¬ì ìŠ¹ì¸ ëŒ€ê¸° í˜ì´ì§€
12. [ ] ëŒ€ì‹œë³´ë“œ í†µí•©
13. [ ] í…ŒìŠ¤íŠ¸

---

## ğŸš€ ì‹œì‘í•˜ê¸°

**1ë‹¨ê³„ë¶€í„° ì°¨ê·¼ì°¨ê·¼ ë”°ë¼í•˜ì‹œë©´ ë©ë‹ˆë‹¤!**

ê° ë‹¨ê³„ë§ˆë‹¤:
1. íŒŒì¼ì„ ë§Œë“¤ê±°ë‚˜ ìˆ˜ì •í•©ë‹ˆë‹¤
2. ì½”ë“œë¥¼ ë³µì‚¬í•´ì„œ ë¶™ì—¬ë„£ìŠµë‹ˆë‹¤
3. ì €ì¥í•©ë‹ˆë‹¤
4. í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤
5. ë‹¤ìŒ ë‹¨ê³„ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤

**ë¬¸ì œê°€ ìƒê¸°ë©´ ì–¸ì œë“ ì§€ ë¬¼ì–´ë³´ì„¸ìš”!** ğŸ˜Š

