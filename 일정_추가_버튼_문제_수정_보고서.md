# 일정 추가 버튼 문제 수정 보고서

## 🔍 발견된 문제

크루즈가이드 지니의 일정 추가 버튼이 제대로 작동하지 않는 문제가 있었습니다.

### 문제 원인 분석

1. **세션 인증 확인 부족**
   - API 호출 전에 세션 상태를 미리 확인하지 않음
   - 세션이 만료된 경우 명확한 에러 메시지 부족

2. **에러 처리 개선 필요**
   - API에서 더 자세한 에러 정보 제공 필요
   - 요청 본문 파싱 에러 처리 부족
   - userId 유효성 검사 부족

3. **3일 체험 사용자 동일 문제**
   - `TestChatInteractiveUI`도 같은 `DailyBriefingCard` 컴포넌트 사용
   - 동일한 문제 발생 가능

---

## ✅ 수정 내용

### 1. 프론트엔드 개선 (`app/chat/components/DailyBriefingCard.tsx`)

#### 세션 확인 로직 추가
```typescript
// API 호출 전에 세션 상태 미리 확인
try {
  const sessionCheck = await fetch('/api/user/profile', { credentials: 'include' });
  if (!sessionCheck.ok) {
    throw new Error('세션이 만료되었습니다. 다시 로그인해주세요.');
  }
} catch (sessionError) {
  console.error('[DailyBriefingCard] 세션 확인 실패:', sessionError);
  alert('로그인 상태를 확인할 수 없습니다. 다시 로그인해주세요.');
  setIsAddingSchedule(false);
  return false;
}
```

**효과**:
- API 호출 전에 세션 상태를 확인하여 불필요한 요청 방지
- 사용자에게 명확한 에러 메시지 제공

---

### 2. 백엔드 API 개선 (`app/api/schedules/route.ts`)

#### 세션 에러 메시지 개선
```typescript
if (!session?.userId) {
  console.error('[API] Schedules POST: 세션 없음');
  return NextResponse.json({ 
    ok: false, 
    error: '인증이 필요합니다',
    details: '세션이 만료되었거나 로그인이 필요합니다. 다시 로그인해주세요.'
  }, { status: 401 });
}
```

#### userId 유효성 검사 추가
```typescript
const userId = parseInt(session.userId);

// userId 유효성 검사
if (isNaN(userId) || userId <= 0) {
  console.error('[API] Schedules POST: 유효하지 않은 userId:', session.userId);
  return NextResponse.json({ 
    ok: false, 
    error: '사용자 정보가 올바르지 않습니다',
    details: `userId: ${session.userId}`
  }, { status: 400 });
}
```

#### 요청 본문 파싱 에러 처리 추가
```typescript
let body;
try {
  body = await req.json();
} catch (parseError) {
  console.error('[API] Schedules POST: 요청 본문 파싱 실패:', parseError);
  return NextResponse.json({ 
    ok: false, 
    error: '요청 데이터 형식이 올바르지 않습니다',
    details: String(parseError)
  }, { status: 400 });
}
```

**효과**:
- 더 자세한 에러 정보 제공
- 디버깅이 쉬워짐
- 사용자에게 명확한 에러 메시지 제공

---

## 🎯 적용 범위

### 일반 사용자
- ✅ 일정 추가 기능 개선
- ✅ 세션 만료 시 명확한 에러 메시지
- ✅ 더 나은 에러 처리

### 3일 체험 사용자
- ✅ `TestChatInteractiveUI`에서도 같은 `DailyBriefingCard` 사용
- ✅ 동일한 개선 사항 적용
- ✅ 세션 확인 및 에러 처리 개선

---

## 📋 테스트 체크리스트

### 일반 사용자 테스트
- [ ] 일정 추가 버튼 클릭 시 정상 작동
- [ ] 세션 만료 시 적절한 에러 메시지 표시
- [ ] 시간/제목 입력 없이 추가 시도 시 에러 메시지
- [ ] 일정 추가 성공 후 목록 갱신 확인

### 3일 체험 사용자 테스트
- [ ] 3일 체험 사용자도 일정 추가 기능 정상 작동
- [ ] 세션 만료 시 적절한 에러 메시지 표시
- [ ] 일정 추가 성공 후 목록 갱신 확인

---

## 🔧 추가 개선 사항 (선택사항)

### 1. 로딩 상태 개선
- 일정 추가 중 버튼 비활성화 및 로딩 표시 (이미 구현됨)

### 2. 성공 메시지 추가
- 일정 추가 성공 시 토스트 메시지 표시 (선택사항)

### 3. 자동 새로고침
- 일정 추가 성공 후 자동으로 일정 목록 새로고침 (이미 구현됨)

---

## ✅ 수정 완료 상태

- [x] 프론트엔드 세션 확인 로직 추가
- [x] 백엔드 에러 메시지 개선
- [x] userId 유효성 검사 추가
- [x] 요청 본문 파싱 에러 처리 추가
- [x] 린트 에러 확인 완료

---

## 📝 참고 사항

1. **세션 쿠키**: `credentials: 'include'` 설정으로 쿠키가 자동으로 전달됩니다.
2. **에러 로깅**: 콘솔에 상세한 에러 정보가 기록됩니다.
3. **사용자 피드백**: 모든 에러 상황에서 사용자에게 명확한 메시지가 표시됩니다.

---

## 🚀 다음 단계

1. 실제 환경에서 테스트
2. 사용자 피드백 수집
3. 필요시 추가 개선


