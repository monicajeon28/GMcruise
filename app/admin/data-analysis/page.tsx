'use client';

import { useState, useEffect, useCallback, useMemo, memo } from 'react';
import {
  LineChart,
  Line,
  BarChart,
  Bar,
  PieChart,
  Pie,
  Cell,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  Legend,
  ResponsiveContainer,
} from 'recharts';
import { FiSearch, FiX, FiCheckCircle, FiRefreshCw } from 'react-icons/fi';

// íƒ€ì… ì •ì˜
interface AnalyticsStats {
  users: {
    total: number;
    active: number;
    newToday: number;
    newThisWeek: number;
    newThisMonth: number;
    hibernated: number;
  };
  features: Array<{
    feature: string;
    usageCount: number;
    activeUsers: number;
  }>;
  trips: {
    total: number;
    thisWeek: number;
    avgDuration: number;
    topDestinations: Array<{ name: string; count: number }>;
  };
  expenses: {
    totalKRW: number;
    avgDaily: number;
    byCategory: Record<string, number>;
  };
  rePurchase: {
    conversionRate: number;
    pending: number;
    converted: number;
    total: number;
    byTripCount?: {
      first: number;
      second: number;
      third: number;
      fourth: number;
      fifthPlus: number;
    };
    conversionRates?: {
      firstToSecond: number;
      secondToThird: number;
      thirdToFourth: number;
      fourthToFifth: number;
    };
  };
  averages?: {
    avgTripCountPerUser: number;
    avgChatMessagesPerUser: number;
    avgChecklistItemsPerUser: number;
    avgChecklistCompletionRate: number;
    avgExpensesPerUser: number;
    avgExpenseAmountPerUser: number;
    avgTranslationUsageRate: number;
    avgFeatureUsagePerUser: number;
  };
}

interface TrendData {
  date: string;
  newUsers: number;
  activeUsers: number;
  newTrips: number;
}

interface MarketingInsight {
  id: number;
  userId: number;
  insightType: string;
  data: any;
  createdAt: string;
  updatedAt: string;
  user: {
    id: number;
    name: string | null;
    phone: string | null;
    mallUserId?: string | null;
    mallNickname?: string | null;
    genieStatus?: string | null;
    genieLinkedAt?: string | null;
    mallUser?: {
      id: number;
      name: string | null;
      phone: string | null;
    } | null;
  };
}

import { Customer } from '@/types/customer';

const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884d8', '#82ca9d'];

const INSIGHT_TYPE_NAMES: Record<string, string> = {
  destination_preference: 'ëª©ì ì§€ ì„ í˜¸ë„',
  spending_pattern: 'ì§€ì¶œ íŒ¨í„´',
  feature_usage: 'ê¸°ëŠ¥ ì‚¬ìš© íŒ¨í„´',
  re_purchase_score: 'ì¬êµ¬ë§¤ ì ìˆ˜',
  engagement_score: 'ê³ ê° ì°¸ì—¬ë„',
  satisfaction_score: 'ê³ ê° ë§Œì¡±ë„',
  lifecycle_stage: 'ê³ ê° ë¼ì´í”„ì‚¬ì´í´',
  cruise_preference: 'ì„ í˜¸ í¬ë£¨ì¦ˆ ë¶„ì„',
  communication_preference: 'ì†Œí†µ ì„ í˜¸ë„',
};

const FEATURE_NAMES: Record<string, string> = {
  ai_chat: 'AI ì±„íŒ…',
  checklist: 'ì²´í¬ë¦¬ìŠ¤íŠ¸',
  wallet: 'ê°€ê³„ë¶€',
  map: 'ì§€ë„',
  translator: 'ë²ˆì—­ê¸°',
};

// í†µê³„ ì¹´ë“œ ì»´í¬ë„ŒíŠ¸
const StatCard = memo(function StatCard({
  title,
  value,
  icon,
  color = 'blue',
}: {
  title: string;
  value: number | string;
  icon: string;
  color?: 'blue' | 'green' | 'yellow' | 'red' | 'purple';
}) {
  const colorClasses = {
    blue: 'from-blue-500 to-indigo-600',
    green: 'from-green-500 to-emerald-600',
    yellow: 'from-yellow-500 to-amber-600',
    red: 'from-red-500 to-pink-600',
    purple: 'from-purple-500 to-pink-600',
  };

  return (
    <div className="bg-gradient-to-br from-white to-gray-50 rounded-xl shadow-lg border-2 border-gray-100 p-6 hover:shadow-xl hover:scale-105 transition-all duration-200">
      <div className="flex items-center justify-between">
        <div>
          <p className="text-sm font-semibold text-gray-600 mb-2">{title}</p>
          <p className="text-4xl font-extrabold text-gray-900 mb-2">{value}</p>
        </div>
        <div className={`bg-gradient-to-br ${colorClasses[color]} rounded-xl p-4 shadow-md`}>
          <span className="text-3xl text-white">{icon}</span>
        </div>
      </div>
    </div>
  );
});

// ì‹œê°„ ë²”ìœ„ ì„ íƒ ì»´í¬ë„ŒíŠ¸
const TimeRangeSelector = memo(function TimeRangeSelector({
  value,
  onChange,
}: {
  value: string;
  onChange: (value: string) => void;
}) {
  const timeRangeOptions = useMemo(
    () => [
      { label: '7ì¼', value: '7d' },
      { label: '30ì¼', value: '30d' },
      { label: '90ì¼', value: '90d' },
    ],
    []
  );

  return (
    <div className="flex items-center gap-4">
      <span className="text-sm font-semibold text-gray-700">ê¸°ê°„ ì„ íƒ:</span>
      {timeRangeOptions.map((option) => (
        <button
          key={option.value}
          onClick={() => onChange(option.value)}
          className={`px-5 py-2.5 rounded-xl font-bold transition-all shadow-md ${
            value === option.value
              ? 'bg-gradient-to-r from-red-600 to-pink-600 text-white hover:from-red-700 hover:to-pink-700'
              : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
          }`}
        >
          {option.label}
        </button>
      ))}
    </div>
  );
});

export default function DataAnalysisPage() {
  const [stats, setStats] = useState<AnalyticsStats | null>(null);
  const [trends, setTrends] = useState<TrendData[]>([]);
  const [insights, setInsights] = useState<MarketingInsight[]>([]);
  const [loading, setLoading] = useState(true);
  const [insightsLoading, setInsightsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [timeRange, setTimeRange] = useState<'7d' | '30d' | '90d'>('30d');
  const [generating, setGenerating] = useState(false);
  
  // ê³ ê° ê²€ìƒ‰ ê´€ë ¨ ìƒíƒœ
  const [customerSearchTerm, setCustomerSearchTerm] = useState('');
  const [customerSearchResults, setCustomerSearchResults] = useState<Customer[]>([]);
  const [customerSearchLoading, setCustomerSearchLoading] = useState(false);
  const [selectedUserId, setSelectedUserId] = useState<number | null>(null);
  const [selectedType, setSelectedType] = useState<string>('');

  // Analytics ë°ì´í„° ë¡œë“œ
  const loadAnalytics = useCallback(async (showLoading = true) => {
    if (showLoading) setLoading(true);
    setError(null);
    try {
      const analyticsUrl = `/api/admin/analytics?range=${timeRange}`;
      
      const analyticsResponse = await fetch(analyticsUrl, {
        method: 'GET',
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json',
        },
      });
      
      if (!analyticsResponse.ok) {
        let errorMessage = 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
        
        if (analyticsResponse.status === 401) {
          errorMessage = 'ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.';
        } else if (analyticsResponse.status === 403) {
          errorMessage = 'ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.';
        } else if (analyticsResponse.status >= 500) {
          errorMessage = 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.';
        }
        
        throw new Error(errorMessage);
      }
      
      const analyticsData = await analyticsResponse.json().catch((err) => {
        console.error('[Data Analysis] JSON parse error:', err);
        throw new Error('ì‘ë‹µ ë°ì´í„°ë¥¼ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      });
      
      if (!analyticsData.ok) {
        throw new Error(analyticsData.error || 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      }
      
      if (!analyticsData.stats) {
        throw new Error('ë°ì´í„° í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      }
      
      setStats(analyticsData.stats);
      setTrends(analyticsData.trends || []);
      setError(null);
    } catch (error) {
      console.error('[Data Analysis] Error loading analytics:', error);
      
      let errorMessage = 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
      
      if (error instanceof TypeError && error.message.includes('fetch')) {
        errorMessage = 'ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.';
      } else if (error instanceof Error) {
        errorMessage = error.message;
      }
      
      setError(errorMessage);
      setStats(null);
      setTrends([]);
    } finally {
      if (showLoading) setLoading(false);
    }
  }, [timeRange]);

  // Insights ë°ì´í„° ë¡œë“œ (í•„í„°ë§Œ ë³€ê²½ë  ë•Œ)
  const loadInsights = useCallback(async () => {
    setInsightsLoading(true);
    try {
      const params = new URLSearchParams();
      if (selectedUserId !== null && selectedUserId !== undefined) {
        params.append('userId', selectedUserId.toString());
      }
      if (selectedType) {
        params.append('type', selectedType);
      }
      
      const insightsUrl = `/api/admin/insights?${params.toString()}`;
      
      const insightsResponse = await fetch(insightsUrl, {
        method: 'GET',
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json',
        },
      });
      
      if (insightsResponse.ok) {
        const insightsData = await insightsResponse.json();
        if (insightsData.ok) {
          setInsights(insightsData.insights || []);
        }
      } else {
        setInsights([]);
      }
    } catch (insightsError) {
      console.warn('[Data Analysis] Insights loading error:', insightsError);
      setInsights([]);
    } finally {
      setInsightsLoading(false);
    }
  }, [selectedUserId, selectedType]);

  // ì „ì²´ ë°ì´í„° ë¡œë“œ (ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ í´ë¦­ ì‹œ) - ë³‘ë ¬ ì²˜ë¦¬
  const loadData = useCallback(async () => {
    setLoading(true);
    setInsightsLoading(true);
    setError(null);
    
    const params = new URLSearchParams();
    if (selectedUserId !== null && selectedUserId !== undefined) {
      params.append('userId', selectedUserId.toString());
    }
    if (selectedType) {
      params.append('type', selectedType);
    }
    
    try {
      const [analyticsResponse, insightsResponse] = await Promise.all([
        fetch(`/api/admin/analytics?range=${timeRange}`, {
          method: 'GET',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
        }),
        fetch(`/api/admin/insights?${params.toString()}`, {
          method: 'GET',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
        }),
      ]);

      // Analytics ì²˜ë¦¬
      if (!analyticsResponse.ok) {
        let errorMessage = 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
        if (analyticsResponse.status === 401) {
          errorMessage = 'ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.';
        } else if (analyticsResponse.status === 403) {
          errorMessage = 'ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.';
        } else if (analyticsResponse.status >= 500) {
          errorMessage = 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.';
        }
        throw new Error(errorMessage);
      }

      const analyticsData = await analyticsResponse.json();
      if (analyticsData.ok && analyticsData.stats) {
        setStats(analyticsData.stats);
        setTrends(analyticsData.trends || []);
      } else {
        throw new Error(analyticsData.error || 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      }

      // Insights ì²˜ë¦¬
      if (insightsResponse.ok) {
        const insightsData = await insightsResponse.json();
        if (insightsData.ok) {
          setInsights(insightsData.insights || []);
        }
      }

      setError(null);
    } catch (error) {
      console.error('[Data Analysis] Error loading data:', error);
      let errorMessage = 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
      if (error instanceof TypeError && error.message.includes('fetch')) {
        errorMessage = 'ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.';
      } else if (error instanceof Error) {
        errorMessage = error.message;
      }
      setError(errorMessage);
      if (!stats) {
        setStats(null);
        setTrends([]);
      }
    } finally {
      setLoading(false);
      setInsightsLoading(false);
    }
  }, [timeRange, selectedUserId, selectedType]);

  // ì´ˆê¸° ë¡œë“œ: Analyticsì™€ Insightsë¥¼ ë³‘ë ¬ë¡œ ë¡œë“œ
  useEffect(() => {
    const loadInitialData = async () => {
      setLoading(true);
      setInsightsLoading(true);
      setError(null);
      
      const params = new URLSearchParams();
      if (selectedUserId !== null && selectedUserId !== undefined) {
        params.append('userId', selectedUserId.toString());
      }
      if (selectedType) {
        params.append('type', selectedType);
      }
      
      try {
        const [analyticsResponse, insightsResponse] = await Promise.all([
          fetch(`/api/admin/analytics?range=${timeRange}`, {
            method: 'GET',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
          }),
          fetch(`/api/admin/insights?${params.toString()}`, {
            method: 'GET',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
          }),
        ]);

        // Analytics ì²˜ë¦¬
        if (!analyticsResponse.ok) {
          let errorMessage = 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
          if (analyticsResponse.status === 401) {
            errorMessage = 'ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.';
          } else if (analyticsResponse.status === 403) {
            errorMessage = 'ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.';
          } else if (analyticsResponse.status >= 500) {
            errorMessage = 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.';
          }
          throw new Error(errorMessage);
        }

        const analyticsData = await analyticsResponse.json();
        if (analyticsData.ok && analyticsData.stats) {
          setStats(analyticsData.stats);
          setTrends(analyticsData.trends || []);
        } else {
          throw new Error(analyticsData.error || 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }

        // Insights ì²˜ë¦¬
        if (insightsResponse.ok) {
          const insightsData = await insightsResponse.json();
          if (insightsData.ok) {
            setInsights(insightsData.insights || []);
          }
        }

        setError(null);
      } catch (error) {
        console.error('[Data Analysis] Error loading data:', error);
        let errorMessage = 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        if (error instanceof TypeError && error.message.includes('fetch')) {
          errorMessage = 'ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.';
        } else if (error instanceof Error) {
          errorMessage = error.message;
        }
        setError(errorMessage);
        setStats(null);
        setTrends([]);
      } finally {
        setLoading(false);
        setInsightsLoading(false);
      }
    };

    loadInitialData();
  }, [timeRange]); // timeRange ë³€ê²½ ì‹œì—ë§Œ ì „ì²´ ì¬ë¡œë“œ

  // Insights í•„í„° ë³€ê²½ ì‹œ Insightsë§Œ ë‹¤ì‹œ ë¡œë“œ
  useEffect(() => {
    // ì´ˆê¸° ë¡œë“œê°€ ì•„ë‹ ë•Œë§Œ Insights ë¡œë“œ (Analyticsê°€ ì´ë¯¸ ë¡œë“œëœ í›„)
    if (stats !== null) {
      loadInsights();
    }
  }, [selectedUserId, selectedType]); // í•„í„°ë§Œ ë³€ê²½ë  ë•Œ

  // ê³ ê° ê²€ìƒ‰
  useEffect(() => {
    if (!customerSearchTerm.trim()) {
      setCustomerSearchResults([]);
      return;
    }

    const timeoutId = setTimeout(async () => {
      setCustomerSearchLoading(true);
      try {
        const response = await fetch(`/api/admin/customers/search?q=${encodeURIComponent(customerSearchTerm)}`, {
          credentials: 'include',
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.ok) {
            setCustomerSearchResults(data.customers || []);
          }
        }
      } catch (error) {
        console.error('Customer search error:', error);
      } finally {
        setCustomerSearchLoading(false);
      }
    }, 300);

    return () => clearTimeout(timeoutId);
  }, [customerSearchTerm]);

  const handleSelectCustomer = (customer: Customer) => {
    setSelectedUserId(customer.id);
    setCustomerSearchTerm(`${customer.name || ''} (${customer.phone || ''})`);
    setCustomerSearchResults([]);
  };

  const handleClearCustomer = () => {
    setSelectedUserId(null);
    setCustomerSearchTerm('');
    setCustomerSearchResults([]);
  };

  const handleGenerate = useCallback(async (userId?: number) => {
    setGenerating(true);
    try {
      const response = await fetch('/api/admin/insights/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({
          userId: userId || null,
          all: !userId,
        }),
      });
      
      if (response.ok) {
        const data = await response.json();
        if (data.ok) {
          alert(data.message || 'ì¸ì‚¬ì´íŠ¸ ìƒì„± ì™„ë£Œ');
          setTimeout(() => loadInsights(), 500);
        } else {
          alert('ì¸ì‚¬ì´íŠ¸ ìƒì„± ì‹¤íŒ¨: ' + (data.error || 'Unknown error'));
        }
      }
    } catch (error) {
      console.error('[Data Analysis] Error generating insights:', error);
      alert('ì¸ì‚¬ì´íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
      setGenerating(false);
    }
  }, [loadInsights]);

  // ì°¨íŠ¸ ë°ì´í„° ì¤€ë¹„
  const featureData = useMemo(() => {
    if (!stats) return [];
    return stats.features.map((f) => ({
      name: FEATURE_NAMES[f.feature] || f.feature,
      value: f.usageCount,
      activeUsers: f.activeUsers,
    }));
  }, [stats?.features]);

  const expenseCategoryData = useMemo(() => {
    if (!stats) return [];
    return Object.entries(stats.expenses.byCategory).map(([name, value]) => ({
      name,
      value: Math.round(value),
    }));
  }, [stats?.expenses.byCategory]);

  const topDestinationsData = useMemo(() => {
    if (!stats) return [];
    return stats.trips.topDestinations
      .slice(0, 10)
      .map((d, index) => ({
        name: d.name,
        count: d.count,
        fill: COLORS[index % COLORS.length],
      }));
  }, [stats?.trips.topDestinations]);

  if (loading) {
    return (
      <div className="space-y-6">
        <div>
          <h1 className="text-3xl font-bold text-gray-800 mb-2">ë°ì´í„°ë¶„ì„</h1>
          <p className="text-gray-600">ê³ ê°ì˜ ëª¨ë“  ì—¬ì •ì„ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”</p>
        </div>
        <div className="flex flex-col items-center justify-center py-24">
          <div className="animate-spin rounded-full h-16 w-16 border-4 border-brand-red border-t-transparent mb-4"></div>
          <p className="text-lg font-medium text-gray-700">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* í—¤ë” */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-4xl font-extrabold text-gray-800 mb-2 flex items-center gap-3">
            <span className="text-5xl">ğŸ“Š</span>
            ë°ì´í„°ë¶„ì„
          </h1>
          <p className="text-lg text-gray-600 font-medium">ê³ ê°ì˜ ëª¨ë“  ì—¬ì •ì„ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”</p>
        </div>
        <button
          onClick={loadData}
          className="flex items-center gap-2 bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 text-white px-5 py-2.5 rounded-xl text-sm font-bold transition-all shadow-md hover:scale-105"
        >
          <FiRefreshCw className={loading ? 'animate-spin' : ''} />
          ìƒˆë¡œê³ ì¹¨
        </button>
      </div>

      {/* ì—ëŸ¬ ë©”ì‹œì§€ */}
      {error && (
        <div className="bg-red-50 border-2 border-red-200 rounded-lg p-4">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-2">
              <span className="text-red-500 text-xl">âš ï¸</span>
              <p className="text-red-800 font-medium">{error}</p>
            </div>
            <button
              onClick={() => loadAnalytics(true)}
              className="text-red-600 hover:text-red-800 text-sm font-medium underline"
            >
              ë‹¤ì‹œ ì‹œë„
            </button>
          </div>
        </div>
      )}

      {/* ì‹œê°„ ë²”ìœ„ ì„ íƒ */}
      <div className="bg-gradient-to-br from-white to-gray-50 rounded-xl shadow-lg border-2 border-gray-100 p-6">
        <TimeRangeSelector value={timeRange} onChange={(v) => setTimeRange(v as '7d' | '30d' | '90d')} />
      </div>

      {/* 1. ì£¼ìš” ì§€í‘œ ì¹´ë“œ */}
      {stats && (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <StatCard
            title="ì´ ì‚¬ìš©ì"
            value={stats.users.total || 0}
            icon="ğŸ‘¥"
            color="blue"
          />
          <StatCard
            title="í™œì„± ì‚¬ìš©ì"
            value={stats.users.active || 0}
            icon="âœ…"
            color="green"
          />
          <StatCard
            title="ì´ë²ˆ ì£¼ ì‹ ê·œ"
            value={stats.users.newThisWeek || 0}
            icon="ğŸ†•"
            color="yellow"
          />
          <StatCard
            title="ì¬êµ¬ë§¤ ì „í™˜ìœ¨"
            value={`${stats.rePurchase.conversionRate || 0}%`}
            icon="ğŸ”„"
            color="red"
          />
        </div>
      )}

      {/* 2. ì¬êµ¬ë§¤ ì „í™˜ ì¶”ì  */}
      {stats && stats.rePurchase && (
        <div className="bg-gradient-to-br from-white to-gray-50 rounded-xl shadow-lg border-2 border-gray-100 p-6">
          <h3 className="text-2xl font-bold mb-4 flex items-center gap-2">
            <span>ğŸ”„</span>
            ì¬êµ¬ë§¤ ì „í™˜ ì¶”ì 
          </h3>
          
          <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div className="text-center p-4 bg-blue-50 rounded-lg">
              <p className="text-sm text-gray-600">ì „ì²´ ì ì¬ ê³ ê°</p>
              <p className="text-2xl font-bold text-blue-600">{stats.rePurchase.total}</p>
            </div>
            <div className="text-center p-4 bg-yellow-50 rounded-lg">
              <p className="text-sm text-gray-600">ì „í™˜ ëŒ€ê¸°</p>
              <p className="text-2xl font-bold text-yellow-600">{stats.rePurchase.pending}</p>
              <p className="text-xs text-gray-500 mt-1">(ì²« ë²ˆì§¸ ì—¬í–‰)</p>
            </div>
            <div className="text-center p-4 bg-green-50 rounded-lg">
              <p className="text-sm text-gray-600">ì „í™˜ ì™„ë£Œ</p>
              <p className="text-2xl font-bold text-green-600">{stats.rePurchase.converted}</p>
              <p className="text-xs text-gray-500 mt-1">(2íšŒ ì´ìƒ)</p>
            </div>
            <div className="text-center p-4 bg-red-50 rounded-lg">
              <p className="text-sm text-gray-600">ì „ì²´ ì „í™˜ìœ¨</p>
              <p className="text-2xl font-bold text-red-600">{stats.rePurchase.conversionRate}%</p>
            </div>
          </div>

          {/* ì—¬í–‰ íšŸìˆ˜ë³„ ë¶„í¬ */}
          {stats.rePurchase.byTripCount && (
            <div className="mb-6">
              <h4 className="text-md font-semibold text-gray-700 mb-3">ì—¬í–‰ íšŸìˆ˜ë³„ ê³ ê° ë¶„í¬</h4>
              <div className="grid grid-cols-2 md:grid-cols-5 gap-3 mb-4">
                <div className="bg-gray-50 rounded-lg p-3 text-center">
                  <p className="text-xs text-gray-600">1íšŒ</p>
                  <p className="text-xl font-bold text-gray-800">{stats.rePurchase.byTripCount.first || 0}ëª…</p>
                </div>
                <div className="bg-green-50 rounded-lg p-3 text-center">
                  <p className="text-xs text-gray-600">2íšŒ</p>
                  <p className="text-xl font-bold text-green-700">{stats.rePurchase.byTripCount.second || 0}ëª…</p>
                </div>
                <div className="bg-blue-50 rounded-lg p-3 text-center">
                  <p className="text-xs text-gray-600">3íšŒ</p>
                  <p className="text-xl font-bold text-blue-700">{stats.rePurchase.byTripCount.third || 0}ëª…</p>
                </div>
                <div className="bg-purple-50 rounded-lg p-3 text-center">
                  <p className="text-xs text-gray-600">4íšŒ</p>
                  <p className="text-xl font-bold text-purple-700">{stats.rePurchase.byTripCount.fourth || 0}ëª…</p>
                </div>
                <div className="bg-indigo-50 rounded-lg p-3 text-center">
                  <p className="text-xs text-gray-600">5íšŒ ì´ìƒ</p>
                  <p className="text-xl font-bold text-indigo-700">{stats.rePurchase.byTripCount.fifthPlus || 0}ëª…</p>
                </div>
              </div>
              <ResponsiveContainer width="100%" height={300}>
                <BarChart data={[
                  { name: '1íšŒ', value: stats.rePurchase.byTripCount.first },
                  { name: '2íšŒ', value: stats.rePurchase.byTripCount.second },
                  { name: '3íšŒ', value: stats.rePurchase.byTripCount.third },
                  { name: '4íšŒ', value: stats.rePurchase.byTripCount.fourth },
                  { name: '5íšŒ+', value: stats.rePurchase.byTripCount.fifthPlus },
                ]}>
                  <CartesianGrid strokeDasharray="3 3" />
                  <XAxis dataKey="name" />
                  <YAxis />
                  <Tooltip />
                  <Legend />
                  <Bar dataKey="value" fill="#8884d8" name="ê³ ê° ìˆ˜" />
                </BarChart>
              </ResponsiveContainer>
            </div>
          )}

          {/* ë‹¨ê³„ë³„ ì „í™˜ìœ¨ ì°¨íŠ¸ */}
          {stats.rePurchase.conversionRates && (
            <div>
              <h4 className="text-md font-semibold text-gray-700 mb-3">ë‹¨ê³„ë³„ ì „í™˜ìœ¨</h4>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                <div className="bg-yellow-50 rounded-lg p-3">
                  <p className="text-xs text-gray-600">1íšŒ â†’ 2íšŒ</p>
                  <p className="text-xl font-bold text-yellow-700">{stats.rePurchase.conversionRates.firstToSecond || 0}%</p>
                </div>
                <div className="bg-green-50 rounded-lg p-3">
                  <p className="text-xs text-gray-600">2íšŒ â†’ 3íšŒ</p>
                  <p className="text-xl font-bold text-green-700">{stats.rePurchase.conversionRates.secondToThird || 0}%</p>
                </div>
                <div className="bg-blue-50 rounded-lg p-3">
                  <p className="text-xs text-gray-600">3íšŒ â†’ 4íšŒ</p>
                  <p className="text-xl font-bold text-blue-700">{stats.rePurchase.conversionRates.thirdToFourth || 0}%</p>
                </div>
                <div className="bg-purple-50 rounded-lg p-3">
                  <p className="text-xs text-gray-600">4íšŒ â†’ 5íšŒ+</p>
                  <p className="text-xl font-bold text-purple-700">{stats.rePurchase.conversionRates.fourthToFifth || 0}%</p>
                </div>
              </div>
              <ResponsiveContainer width="100%" height={300}>
                <BarChart data={[
                  { step: '1íšŒâ†’2íšŒ', rate: stats.rePurchase.conversionRates.firstToSecond },
                  { step: '2íšŒâ†’3íšŒ', rate: stats.rePurchase.conversionRates.secondToThird },
                  { step: '3íšŒâ†’4íšŒ', rate: stats.rePurchase.conversionRates.thirdToFourth },
                  { step: '4íšŒâ†’5íšŒ+', rate: stats.rePurchase.conversionRates.fourthToFifth },
                ]}>
                  <CartesianGrid strokeDasharray="3 3" />
                  <XAxis dataKey="step" />
                  <YAxis domain={[0, 100]} />
                  <Tooltip formatter={(value: number) => `${value.toFixed(1)}%`} />
                  <Legend />
                  <Bar dataKey="rate" fill="#ff8042" name="ì „í™˜ìœ¨ (%)" />
                </BarChart>
              </ResponsiveContainer>
            </div>
          )}
        </div>
      )}

      {/* 3. ì‚¬ìš©ì ì¦ê°€ ì¶”ì´ (ë¼ì¸ ì°¨íŠ¸) */}
      {stats && (
        <div className="bg-gradient-to-br from-white to-gray-50 rounded-xl shadow-lg border-2 border-gray-100 p-6">
          <h3 className="text-lg font-bold mb-4">ì‚¬ìš©ì ì¦ê°€ ì¶”ì´</h3>
          {trends.length === 0 ? (
            <div className="flex flex-col items-center justify-center py-16 text-gray-400">
              <div className="text-5xl mb-4">ğŸ“Š</div>
              <p className="text-lg font-medium">ì¶”ì´ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</p>
            </div>
          ) : (
            <ResponsiveContainer width="100%" height={300}>
              <LineChart data={trends}>
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis
                  dataKey="date"
                  tickFormatter={(value) => {
                    const date = new Date(value);
                    return `${date.getMonth() + 1}/${date.getDate()}`;
                  }}
                />
                <YAxis />
                <Tooltip
                  labelFormatter={(value) => {
                    const date = new Date(value);
                    return date.toLocaleDateString('ko-KR');
                  }}
                />
                <Legend />
                <Line
                  type="monotone"
                  dataKey="newUsers"
                  stroke="#8884d8"
                  name="ì‹ ê·œ ê°€ì…ì"
                  strokeWidth={2}
                />
                <Line
                  type="monotone"
                  dataKey="activeUsers"
                  stroke="#82ca9d"
                  name="í™œì„± ì‚¬ìš©ì"
                  strokeWidth={2}
                />
              </LineChart>
            </ResponsiveContainer>
          )}
        </div>
      )}

      {/* 4. ê¸°ëŠ¥ ì‚¬ìš© ë¶„í¬ (íŒŒì´ ì°¨íŠ¸ ë° ë°” ì°¨íŠ¸) */}
      {stats && (
        <div className="bg-gradient-to-br from-white to-gray-50 rounded-xl shadow-lg border-2 border-gray-100 p-6">
          <h3 className="text-lg font-bold mb-4">ê¸°ëŠ¥ ì‚¬ìš© ë¶„í¬</h3>
          {featureData.length === 0 ? (
            <div className="flex flex-col items-center justify-center py-16 text-gray-400">
              <div className="text-5xl mb-4">ğŸ“±</div>
              <p className="text-lg font-medium">ê¸°ëŠ¥ ì‚¬ìš© ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</p>
            </div>
          ) : (
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <ResponsiveContainer width="100%" height={300}>
                <PieChart>
                  <Pie
                    data={featureData}
                    cx="50%"
                    cy="50%"
                    labelLine={false}
                    label={(props: any) => `${props.name} ${(props.percent * 100).toFixed(0)}%`}
                    outerRadius={80}
                    fill="#8884d8"
                    dataKey="value"
                  >
                    {featureData.map((entry, index) => (
                      <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                    ))}
                  </Pie>
                  <Tooltip />
                </PieChart>
              </ResponsiveContainer>
              <ResponsiveContainer width="100%" height={300}>
                <BarChart data={featureData}>
                  <CartesianGrid strokeDasharray="3 3" />
                  <XAxis dataKey="name" />
                  <YAxis />
                  <Tooltip />
                  <Legend />
                  <Bar dataKey="value" fill="#8884d8" name="ì‚¬ìš© íšŸìˆ˜" />
                </BarChart>
              </ResponsiveContainer>
            </div>
          )}
        </div>
      )}

      {/* 5. ì¸ê¸° ì—¬í–‰ì§€ Top 10 (ìˆ˜í‰ ë°” ì°¨íŠ¸) */}
      {stats && topDestinationsData.length > 0 && (
        <div className="bg-gradient-to-br from-white to-gray-50 rounded-xl shadow-lg border-2 border-gray-100 p-6">
          <h3 className="text-2xl font-extrabold text-gray-900 mb-4">ì¸ê¸° ì—¬í–‰ì§€ Top 10</h3>
          <ResponsiveContainer width="100%" height={500}>
            <BarChart data={topDestinationsData} layout="vertical" margin={{ top: 5, right: 30, left: 150, bottom: 5 }}>
              <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
              <XAxis 
                type="number" 
                tick={{ fill: '#374151', fontSize: 12 }}
                tickFormatter={(value) => value.toLocaleString()}
              />
              <YAxis 
                dataKey="name" 
                type="category" 
                width={150}
                tick={{ fill: '#374151', fontSize: 12 }}
                interval={0}
              />
              <Tooltip 
                formatter={(value: number) => [`${value.toLocaleString()}íšŒ`, 'ì—¬í–‰ ìˆ˜']}
                contentStyle={{ backgroundColor: '#fff', border: '1px solid #e5e7eb', borderRadius: '8px' }}
              />
              <Legend />
              <Bar dataKey="count" name="ì—¬í–‰ ìˆ˜" radius={[0, 8, 8, 0]}>
                {topDestinationsData.map((entry, index) => (
                  <Cell key={`cell-${index}`} fill={entry.fill} />
                ))}
              </Bar>
            </BarChart>
          </ResponsiveContainer>
        </div>
      )}

      {/* 6. ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ ë¶„í¬ (ë°” ì°¨íŠ¸) */}
      {stats && expenseCategoryData.length > 0 && (
        <div className="bg-gradient-to-br from-white to-gray-50 rounded-xl shadow-lg border-2 border-gray-100 p-6">
          <h3 className="text-lg font-bold mb-4">ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ ë¶„í¬</h3>
          <div className="mb-4 text-center">
            <p className="text-2xl font-bold text-gray-900">
              ì´ ì§€ì¶œ: {stats.expenses.totalKRW.toLocaleString()}ì›
            </p>
            <p className="text-sm text-gray-600 mt-1">
              í‰ê·  ì¼ì¼ ì§€ì¶œ: {stats.expenses.avgDaily.toLocaleString()}ì›
            </p>
          </div>
          <ResponsiveContainer width="100%" height={300}>
            <BarChart data={expenseCategoryData}>
              <CartesianGrid strokeDasharray="3 3" />
              <XAxis dataKey="name" />
              <YAxis />
              <Tooltip formatter={(value) => `${value.toLocaleString()}ì›`} />
              <Legend />
              <Bar dataKey="value" fill="#FF8042" name="ì§€ì¶œ ê¸ˆì•¡ (ì›)" />
            </BarChart>
          </ResponsiveContainer>
        </div>
      )}

      {/* 7. ì „ì²´ í‰ê·  ë°ì´í„° (8ê°œ í‰ê·  ì§€í‘œ) */}
      {stats && stats.averages && (
        <div className="bg-gradient-to-br from-white to-gray-50 rounded-xl shadow-lg border-2 border-gray-100 p-6">
          <h3 className="text-lg font-bold mb-4">ğŸ“Š ì „ì²´ í‰ê·  ë°ì´í„°</h3>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div className="bg-white rounded-lg p-4 border border-gray-200">
              <p className="text-sm font-semibold text-gray-600 mb-1">í‰ê·  ì—¬í–‰ íšŸìˆ˜</p>
              <p className="text-2xl font-bold text-gray-900">{stats.averages.avgTripCountPerUser}íšŒ</p>
            </div>
            <div className="bg-white rounded-lg p-4 border border-gray-200">
              <p className="text-sm font-semibold text-gray-600 mb-1">í‰ê·  ì±„íŒ… ë©”ì‹œì§€</p>
              <p className="text-2xl font-bold text-gray-900">{stats.averages.avgChatMessagesPerUser}ê°œ</p>
            </div>
            <div className="bg-white rounded-lg p-4 border border-gray-200">
              <p className="text-sm font-semibold text-gray-600 mb-1">í‰ê·  ì²´í¬ë¦¬ìŠ¤íŠ¸ í•­ëª©</p>
              <p className="text-2xl font-bold text-gray-900">{stats.averages.avgChecklistItemsPerUser}ê°œ</p>
            </div>
            <div className="bg-white rounded-lg p-4 border border-gray-200">
              <p className="text-sm font-semibold text-gray-600 mb-1">ì²´í¬ë¦¬ìŠ¤íŠ¸ ì™„ë£Œìœ¨</p>
              <p className="text-2xl font-bold text-gray-900">{stats.averages.avgChecklistCompletionRate}%</p>
            </div>
            <div className="bg-white rounded-lg p-4 border border-gray-200">
              <p className="text-sm font-semibold text-gray-600 mb-1">í‰ê·  ì§€ì¶œ í•­ëª©</p>
              <p className="text-2xl font-bold text-gray-900">{stats.averages.avgExpensesPerUser}ê°œ</p>
            </div>
            <div className="bg-white rounded-lg p-4 border border-gray-200">
              <p className="text-sm font-semibold text-gray-600 mb-1">í‰ê·  ì§€ì¶œ ê¸ˆì•¡</p>
              <p className="text-2xl font-bold text-gray-900">{stats.averages.avgExpenseAmountPerUser.toLocaleString()}ì›</p>
            </div>
            <div className="bg-white rounded-lg p-4 border border-gray-200">
              <p className="text-sm font-semibold text-gray-600 mb-1">ë²ˆì—­ê¸° ì‚¬ìš©ë¥ </p>
              <p className="text-2xl font-bold text-gray-900">{stats.averages.avgTranslationUsageRate}%</p>
            </div>
            <div className="bg-white rounded-lg p-4 border border-gray-200">
              <p className="text-sm font-semibold text-gray-600 mb-1">í‰ê·  ê¸°ëŠ¥ ì‚¬ìš©</p>
              <p className="text-2xl font-bold text-gray-900">{stats.averages.avgFeatureUsagePerUser}íšŒ</p>
            </div>
          </div>
        </div>
      )}

      {/* 8. ë§ˆì¼€íŒ… ì¸ì‚¬ì´íŠ¸ (ê³ ê° ê²€ìƒ‰, í•„í„°ë§, ì¸ì‚¬ì´íŠ¸ ìƒì„± ë° í‘œì‹œ) */}
      <div className="bg-gradient-to-br from-white to-gray-50 rounded-xl shadow-lg border-2 border-gray-100 p-6">
        <div className="flex items-center justify-between mb-4">
          <h3 className="text-2xl font-bold flex items-center gap-2">
            <span>ğŸ’¡</span>
            ë§ˆì¼€íŒ… ì¸ì‚¬ì´íŠ¸
          </h3>
          <button
            onClick={() => handleGenerate()}
            disabled={generating}
            className="bg-gradient-to-r from-red-600 to-pink-600 hover:from-red-700 hover:to-pink-700 disabled:bg-gray-400 text-white px-6 py-3 rounded-xl font-bold transition-all shadow-lg hover:scale-105 disabled:hover:scale-100"
          >
            {generating ? 'ìƒì„± ì¤‘...' : 'ì „ì²´ ì‚¬ìš©ì ì¸ì‚¬ì´íŠ¸ ìƒì„±'}
          </button>
        </div>

        {/* í•„í„° */}
        <div className="mb-6 space-y-4">
          <div className="flex flex-col md:flex-row gap-4">
            {/* ê³ ê° ê²€ìƒ‰ */}
            <div className="flex-1 relative">
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                ê³ ê° ê²€ìƒ‰
              </label>
              <div className="relative">
                <input
                  type="text"
                  value={customerSearchTerm}
                  onChange={(e) => {
                    setCustomerSearchTerm(e.target.value);
                    if (!e.target.value) {
                      handleClearCustomer();
                    }
                  }}
                  placeholder="ê³ ê° ì´ë¦„ ë˜ëŠ” ì—°ë½ì²˜ë¡œ ê²€ìƒ‰"
                  className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base pr-12"
                />
                {customerSearchTerm && (
                  <button
                    type="button"
                    onClick={handleClearCustomer}
                    className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
                  >
                    <FiX size={20} />
                  </button>
                )}
              </div>
              {customerSearchResults.length > 0 && (
                <div className="absolute z-10 w-full bg-white border-2 border-gray-300 rounded-lg shadow-xl mt-2 max-h-60 overflow-y-auto">
                  {customerSearchResults.map((customer) => (
                    <div
                      key={customer.id}
                      onClick={() => handleSelectCustomer(customer)}
                      className="flex items-center justify-between px-4 py-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0"
                    >
                      <div>
                        <p className="font-medium text-gray-900">{customer.name || 'ì´ë¦„ ì—†ìŒ'}</p>
                        <p className="text-sm text-gray-500">{customer.phone || 'ì—°ë½ì²˜ ì—†ìŒ'}</p>
                      </div>
                      {selectedUserId === customer.id && (
                        <FiCheckCircle className="text-blue-500" size={20} />
                      )}
                    </div>
                  ))}
                </div>
              )}
            </div>

            {/* ì¸ì‚¬ì´íŠ¸ íƒ€ì… í•„í„° */}
            <div className="w-full md:w-auto">
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                ì¸ì‚¬ì´íŠ¸ íƒ€ì…
              </label>
              <select
                value={selectedType}
                onChange={(e) => setSelectedType(e.target.value)}
                className="w-full md:w-auto px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base"
              >
                <option value="">ì „ì²´</option>
                {Object.entries(INSIGHT_TYPE_NAMES).map(([value, label]) => (
                  <option key={value} value={value}>
                    {label}
                  </option>
                ))}
              </select>
            </div>
          </div>

          {selectedUserId && (
            <button
              onClick={() => handleGenerate(selectedUserId)}
              disabled={generating}
              className="px-4 py-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white text-sm font-semibold rounded-lg transition-colors"
            >
              {generating ? 'ìƒì„± ì¤‘...' : 'ì„ íƒí•œ ê³ ê° ì¸ì‚¬ì´íŠ¸ ìƒì„±'}
            </button>
          )}
        </div>

        {/* ì¸ì‚¬ì´íŠ¸ ëª©ë¡ */}
        {insightsLoading ? (
          <div className="bg-white rounded-lg shadow-sm border p-16 text-center">
            <div className="animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent mx-auto mb-4"></div>
            <p className="text-gray-600">ì¸ì‚¬ì´íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
          </div>
        ) : insights.length === 0 ? (
          <div className="bg-white rounded-lg shadow-sm border p-16 text-center">
            <div className="text-6xl mb-6">ğŸ’¡</div>
            <h3 className="text-xl font-bold text-gray-800 mb-2">ì¸ì‚¬ì´íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
            <p className="text-gray-600 mb-6">ë§ˆì¼€íŒ… ì¸ì‚¬ì´íŠ¸ë¥¼ ìƒì„±í•˜ì—¬ ì‚¬ìš©ì íŒ¨í„´ì„ ë¶„ì„í•˜ì„¸ìš”</p>
          </div>
        ) : (
          <div className="space-y-4">
            {insights.map((insight) => {
              const user = insight.user || { id: insight.userId, name: null, phone: null };
              const isLinked = !!user.mallUser || !!user.mallUserId;
              
              return (
                <div key={insight.id} className="bg-white rounded-xl shadow-lg border-2 border-gray-100 p-6 hover:shadow-xl transition-all">
                  <div className="flex items-start justify-between mb-4">
                    <div className="flex-1">
                      <div className="flex items-center gap-2 mb-2">
                        <h4 className="text-lg font-bold text-gray-800">
                          {user.name || 'ì´ë¦„ ì—†ìŒ'} ({user.phone || 'ì „í™”ë²ˆí˜¸ ì—†ìŒ'})
                        </h4>
                        {isLinked && (
                          <span className="px-2 py-1 text-xs font-bold rounded bg-green-100 text-green-700 border border-green-300">
                            ì—°ë™ë¨
                          </span>
                        )}
                      </div>
                      <p className="text-sm text-gray-600">
                        {INSIGHT_TYPE_NAMES[insight.insightType] || insight.insightType}
                      </p>
                    </div>
                    <div className="text-right text-sm text-gray-500">
                      <p>ì—…ë°ì´íŠ¸: {new Date(insight.updatedAt).toLocaleString('ko-KR')}</p>
                    </div>
                  </div>
                  <div className="border-t pt-4">
                    <pre className="bg-gray-50 p-4 rounded-lg overflow-auto text-sm max-h-96">
                      {JSON.stringify(insight.data, null, 2)}
                    </pre>
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </div>
    </div>
  );
}
