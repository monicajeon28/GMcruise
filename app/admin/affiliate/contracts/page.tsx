'use client';

import { useCallback, useEffect, useRef, useState } from 'react';
import {
  FiRefreshCw,
  FiSearch,
  FiCheckCircle,
  FiXCircle,
  FiClock,
  FiFileText,
  FiExternalLink,
  FiSend,
  FiCopy,
  FiX,
  FiEye,
  FiTrash2,
} from 'react-icons/fi';
import SignaturePad from 'signature_pad';
import { showError, showSuccess } from '@/components/ui/Toast';
import ContractInviteModal from '@/components/admin/ContractInviteModal';

type AffiliateContract = {
  id: number;
  name: string;
  phone: string;
  email: string | null;
  status: 'submitted' | 'approved' | 'rejected' | 'completed' | 'terminated';
  submittedAt: string | null;
  reviewedAt: string | null;
  createdAt: string;
  residentId: string | null;
  address: string | null;
  bankName: string | null;
  bankAccount: string | null;
  bankAccountHolder: string | null;
  idCardPath: string | null;
  bankbookPath: string | null;
  metadata: any;
  user: {
    id: number;
    name: string | null;
    email: string | null;
    phone: string | null;
    mallUserId: string | null;
    password: string | null; // 비밀번호 추가
  } | null;
  reviewer: {
    id: number;
    name: string | null;
    email: string | null;
  } | null;
  AffiliateProfile: {
    id: number;
    displayName: string | null;
    nickname: string | null;
    type: 'BRANCH_MANAGER' | 'SALES_AGENT' | 'HQ';
    affiliateCode: string;
    branchLabel: string | null;
    contactPhone: string | null; // 프로필 수정에서 입력한 연락처
    contactEmail: string | null; // 프로필 수정에서 입력한 이메일
    user: {
      id: number;
      name: string | null;
      email: string | null;
      phone: string | null;
      mallUserId: string | null;
    } | null;
  } | null;
  managerInfo: {
    id: number;
    displayName: string | null;
    nickname: string | null;
    affiliateCode: string;
    branchLabel: string | null;
    type: string;
  } | null; // 판매원의 소속 대리점장 정보
};

type AffiliateProfile = {
  id: number;
  userId: number;
  affiliateCode: string;
  type: 'BRANCH_MANAGER' | 'SALES_AGENT' | 'HQ';
  displayName: string | null;
  nickname: string | null;
  user: {
    mallUserId: string | null;
  } | null;
};

const STATUS_OPTIONS = [
  { value: 'all', label: '전체' },
  { value: 'submitted', label: '제출됨' },
  { value: 'completed', label: '완료됨' },
  { value: 'approved', label: '승인됨' },
  { value: 'rejected', label: '거부됨' },
] as const;

const CONTRACT_SECTIONS: Array<{ title: string; clauses: string[] }> = [
  {
    title: '제1조 (목적)',
    clauses: [
      '본 계약은 주식회사 크루즈닷(이하 "갑")과 계약 신청자(이하 "을")가 크루즈 상품 판매를 위한 어필리에이트 활동을 수행함에 있어 필요한 권리와 의무를 명확히 함을 목적으로 합니다.',
    ],
  },
  {
    title: '제2조 (정의)',
    clauses: [
      '"어필리에이트 활동"이라 함은 갑이 제공하는 상품, 서비스 및 프로모션을 을이 소개·판매·중개하는 일체의 영업 행위를 의미합니다.',
      '"고객 DB"라 함은 갑이 직접 보유하거나 을을 통해 수집된 고객의 개인정보, 여행 이력, 상담 내역 및 판매 성과 데이터를 말합니다.',
    ],
  },
  {
    title: '제3조 (을의 역할과 의무)',
    clauses: [
      '을은 갑이 제공한 최신 상품 정보와 가격 정책을 정확히 전달하며, 허위·과장 광고를 하지 않습니다.',
      '을은 고객 상담, 예약, 결제 안내 등 판매 과정에서 필요한 절차를 성실히 수행하고, 고객 문의에 신속히 대응합니다.',
      '을은 갑이 지정한 교육 프로그램을 이수하고, 변경된 정책 및 지침을 즉시 반영합니다.',
    ],
  },
  {
    title: '제4조 (수수료 및 정산)',
    clauses: [
      '을의 활동으로 발생한 매출에 대해서는 갑이 사전에 고지한 커미션 정책에 따라 수수료가 산정됩니다.',
      '정산은 매월 말일 기준으로 집계하며, 갑은 익월 30일 이내에 을이 지정한 계좌로 지급합니다.',
      '고객의 취소·환불·미납 등이 발생할 경우, 해당 금액은 차기 정산분에서 공제하거나 환수할 수 있습니다.',
    ],
  },
  {
    title: '제5조 (고객 정보 보호 및 활용 제한)',
    clauses: [
      '을은 고객 DB를 계약 목적 외 용도로 이용하거나 제3자에게 제공·유출해서는 안 됩니다.',
      '계약 종료 시 을은 보유 중인 고객 DB를 즉시 반환하거나 복구 불가능한 방법으로 파기해야 하며, 이를 준수하지 않을 경우 손해배상 책임을 집니다.',
      '고객 동의 없이 타사 상품 홍보, 리크루팅, 스팸성 메시지 발송 등을 금지합니다.',
    ],
  },
  {
    title: '제6조 (교육, 자료 및 브랜드 사용)',
    clauses: [
      '갑은 을에게 필요한 교육 자료, 영업 가이드, 마케팅 콘텐츠를 제공할 수 있으며, 을은 해당 자료를 변형 없이 사용합니다.',
      '을은 갑의 상호, 로고, 브랜드 자산을 허가된 용도 내에서만 사용할 수 있으며, 별도 승인 없이 상업적 2차 제작물을 만들 수 없습니다.',
    ],
  },
  {
    title: '제7조 (계약 기간 및 해지)',
    clauses: [
      '본 계약의 유효기간은 서명일로부터 1년이며, 어느 일방의 서면 해지 통지가 없는 경우 동일 조건으로 자동 연장됩니다.',
      '갑 또는 을은 상대방이 계약을 위반하거나 신뢰를 훼손하는 행위를 한 경우 즉시 해지할 수 있습니다.',
      '계약이 해지되는 경우 을은 진행 중인 고객 상담과 판매 건에 대해 갑의 지침을 따르며, 미정산 수수료는 확정 후 지급·조정합니다.',
    ],
  },
  {
    title: '제8조 (손해배상 및 위약벌)',
    clauses: [
      '을이 고객 DB 무단 활용, 허위·과장 광고, 금품 요구 등의 행위를 하여 갑 또는 고객에게 피해가 발생한 경우, 을은 전액 배상하여야 합니다.',
      '을이 경업 금지 조항을 위반하거나 갑의 영업상 기밀을 유출한 경우, 갑은 발생한 손해와 별도로 위약벌(매출의 3배 이내)을 청구할 수 있습니다.',
    ],
  },
  {
    title: '제9조 (기타 및 준거법)',
    clauses: [
      '본 계약에 명시되지 않은 사항은 갑의 운영 정책과 관련 법령, 그리고 상관례에 따릅니다.',
      '본 계약과 관련하여 분쟁이 발생할 경우, 갑의 본사 소재지를 관할하는 법원을 1심 전속 관할 법원으로 합니다.',
    ],
  },
  {
    title: '부칙',
    clauses: [
      '본 계약은 전자 서명 제출일에 효력이 발생하며, 갑의 승인을 통해 최종 확정됩니다.',
      '갑은 필요 시 정책 변동 사항을 을에게 사전 통지하며, 통지일로부터 7일 이내에 이의 제기가 없을 경우 변경 사항에 동의한 것으로 간주합니다.',
    ],
  },
];

// 교육 계약서 요약본 (간략 버전 - 법적 안전성을 위한 핵심 내용)
// 각 타입별로 실제 문서 내용에 맞게 작성 필요
const EDUCATION_CONTRACT_SUMMARY: Record<string, Array<{ title: string; clauses: string[] }>> = {
  SALES_AGENT: [
    {
      title: '교육 계약서 (판매원) - 요약',
      clauses: [
        '본 교육 계약서는 "330 판매원 계약서 마비즈 계약서 2025-07-04.docx" 문서의 내용을 기반으로 합니다.',
        '',
        '【핵심 내용】',
        '• 을은 갑이 제공하는 크루즈 상품 판매 교육 프로그램을 성실히 이수해야 합니다.',
        '• 교육 내용: 크루즈 상품 이해, 판매 프로세스, 고객 상담 방법, 정산 절차, 법적 사항',
        '• 교육 이수 후 갑이 지정한 평가를 통과해야 정식 판매원으로 활동할 수 있습니다.',
        '• 평가 미통과 시 재교육 및 재평가를 통해 인증을 받을 수 있습니다.',
        '• 교육 자료는 판매 활동 목적으로만 사용하며, 제3자에게 제공하거나 무단 복제할 수 없습니다.',
        '• 본 계약서는 전자 서명으로 체결되며, 갑의 최종 승인을 통해 효력이 발생합니다.',
        '',
        '※ 아래 전문에서 "330 판매원 계약서 마비즈 계약서 2025-07-04.docx" 문서의 전체 내용을 확인하실 수 있습니다.',
      ],
    },
  ],
  CRUISE_STAFF: [
    {
      title: '교육 계약서 (크루즈스탭) - 요약',
      clauses: [
        '본 교육 계약서는 "540 판매원 계약서 마비즈 계약서 2025-07-04의 사본 (1).docx" 문서의 내용을 기반으로 합니다.',
        '',
        '【핵심 내용】',
        '• 을은 갑이 제공하는 크루즈 상품 판매 및 크루즈스탭 업무 교육 프로그램을 성실히 이수해야 합니다.',
        '• 교육 내용: 크루즈 상품 이해, 판매 프로세스, 크루즈스탭 업무, 고객 상담 방법, 정산 절차, 법적 사항',
        '• 교육 이수 후 갑이 지정한 평가를 통과해야 정식 크루즈스탭으로 활동할 수 있습니다.',
        '• 평가 미통과 시 재교육 및 재평가를 통해 인증을 받을 수 있습니다.',
        '• 교육 자료는 판매 활동 및 크루즈스탭 업무 목적으로만 사용하며, 제3자에게 제공하거나 무단 복제할 수 없습니다.',
        '• 본 계약서는 전자 서명으로 체결되며, 갑의 최종 승인을 통해 효력이 발생합니다.',
        '',
        '※ 아래 전문에서 "540 판매원 계약서 마비즈 계약서 2025-07-04의 사본 (1).docx" 문서의 전체 내용을 확인하실 수 있습니다.',
      ],
    },
  ],
  PRIMARKETER: [
    {
      title: '교육 계약서 (프리마케터) - 요약',
      clauses: [
        '본 교육 계약서는 "100만원 판매원 계약서 .docx" 문서의 내용을 기반으로 합니다.',
        '',
        '【핵심 내용】',
        '• 을은 갑이 제공하는 크루즈 상품 판매 및 프리마케터 전용 교육 프로그램을 성실히 이수해야 합니다.',
        '• 교육 내용: 크루즈 상품 이해, 판매 프로세스, 프리마케터 업무, 고객 상담 방법, 정산 절차, 법적 사항',
        '• 교육 이수 후 갑이 지정한 평가를 통과해야 정식 프리마케터로 활동할 수 있습니다.',
        '• 평가 미통과 시 재교육 및 재평가를 통해 인증을 받을 수 있습니다.',
        '• 교육 자료는 판매 활동 및 프리마케터 업무 목적으로만 사용하며, 제3자에게 제공하거나 무단 복제할 수 없습니다.',
        '• 본 계약서는 전자 서명으로 체결되며, 갑의 최종 승인을 통해 효력이 발생합니다.',
        '',
        '※ 아래 전문에서 "100만원 판매원 계약서 .docx" 문서의 전체 내용을 확인하실 수 있습니다.',
      ],
    },
  ],
  BRANCH_MANAGER: [
    {
      title: '교육 계약서 (대리점장) - 요약',
      clauses: [
        '본 교육 계약서는 "750 B2B 계약서 .docx" 문서의 내용을 기반으로 합니다.',
        '',
        '【핵심 내용】',
        '• 을은 갑이 제공하는 크루즈 상품 판매 및 대리점장 업무 교육 프로그램을 성실히 이수해야 합니다.',
        '• 교육 내용: 크루즈 상품 이해, 판매 프로세스, 팀 관리, 고객 상담 방법, 정산 절차, 법적 사항',
        '• 교육 이수 후 갑이 지정한 평가를 통과해야 정식 대리점장으로 활동할 수 있습니다.',
        '• 평가 미통과 시 재교육 및 재평가를 통해 인증을 받을 수 있습니다.',
        '• 교육 자료는 판매 활동 및 팀 관리 목적으로만 사용하며, 제3자에게 제공하거나 무단 복제할 수 없습니다.',
        '• 본 계약서는 전자 서명으로 체결되며, 갑의 최종 승인을 통해 효력이 발생합니다.',
        '',
        '※ 아래 전문에서 "750 B2B 계약서 .docx" 문서의 전체 내용을 확인하실 수 있습니다.',
      ],
    },
  ],
};

// 교육 계약서 내용 (각 타입별 - 전체 내용)
// ⚠️ 중요: 각 타입별로 실제 문서 내용이 다릅니다. 실제 문서 파일을 확인하여 정확한 내용으로 업데이트가 필요합니다.
// - 판매원: "330 판매원 계약서 마비즈 계약서 2025-07-04.docx"
// - 크루즈스탭: "540 판매원 계약서 마비즈 계약서 2025-07-04의 사본 (1).docx"
// - 프리마케터: "100만원 판매원 계약서 .docx"
// - 대리점장: "750 B2B 계약서 .docx"
const EDUCATION_CONTRACT_SECTIONS: Record<string, Array<{ title: string; clauses: string[] }>> = {
  SALES_AGENT: [
    {
      title: '교육 계약서 (판매원) - 330 판매원 계약서 마비즈 계약서 2025-07-04.docx',
      clauses: [
        '마케팅 세일즈 에이전시 서비스 제휴 계약서',
        '본 서비스 제휴 계약(이하 "본 계약")은 주식회사 마비즈컴퍼니(이하 "회사"), 고객사(이하 "고객사"), 그리고 멘토(이하 "멘토") 사이에서 체결되었다. 이하 "회사", "고객사", "멘토" 중 1인을 가리켜 "당사자", 그 전부를 가리켜 "당사자들"이라 한다.',
        '',
        '제1조 (목적)',
        '본 계약은 "고객사"가 "회사"와 "멘토"로부터 제공받는 홍보 및 제휴마케팅 서비스(이하 "제휴마케팅")와 관련된 업무 처리 방법과 조건을 정하고, 당사자 간의 권리, 의무 및 기타 제반 사항을 규정함을 목적으로 한다. 제공되는 서비스에는 DB 지급, 세일즈 교육, 마케팅 교육 등이 포함된다.',
        '',
        '제2조 (용어의 정의)',
        '본 계약에서 사용하는 용어의 정의는 다음과 같다. 본 계약서에서 별도로 정의하지 않은 용어는 "회사", "고객사" 및 "멘토"의 이용약관에서 정의한 바에 따른다.',
        '"고객"이란 "회사", "고객사" 및 "멘토"가 제공하는 "제휴마케팅"을 이용하는 모든 사람을 의미한다.',
        '"마케팅"이란 "고객사"의 기존 소비자를 관리하고 신규 소비자를 유치하기 위한 모든 활동을 의미하며, "제휴마케팅"이란 "회사"가 일정 비용을 지급받는 대가로 "고객사"의 마케팅을 돕는 것을 의미한다.',
        '고객 DB(데이터베이스)란, 고객이 신청한 이름, 전화번호 등 영업에 필요한 정보의 총체를 말하며, 본 계약에 따라 "멘토"가 제공한다.',
        '"제휴플랫폼"이란 "회사"가 제공하는 사이트와 마케팅 솔루션을 의미한다.',
        '"경업"이란 "고객사"가 본 계약과 유사한 형태의 사업을 "회사" 또는 "멘토"의 동의 없이 영위하거나 제3자로 하여금 영위하게 하는 것을 말한다.',
        '"리크루팅"이란 "회사" 또는 "멘토"의 고객이나 관계자를 대상으로 직원이나 사업자를 모집하거나 권유하는 행위를 말한다.',
        '',
        '제3조 (계약기간 및 갱신)',
        '① 본 계약에 따른 유료 서비스, 즉 \'현장실무를 위한 액기스 강의 4주 과정\'의 제공 기간은 결제일로부터 4주로 한정하며, 해당 기간이 만료되면 "회사"의 주된 서비스 제공 의무는 정상적으로 이행 완료된 것으로 본다.',
        '② 제9조에 명시된 부가 서비스는 무상 프로모션으로 제공되며, 그 이용 권한은 계약 체결일로부터 12개월간 유지된다.',
        '③ 제2항의 무상 서비스 기간(12개월) 만료 30일 이전에 당사자 일방의 서면 해지 통지가 없는 경우, 무상 부가 서비스 이용 권한은 동일한 조건으로 1년씩 자동으로 연장된다.',
        '④ 계약 기간 중 계약 위반 시, 계약은 즉시 해지될 수 있다.',
        '',
        '제4조 (회사의 의무)',
        '① "회사"는 다음과 같은 의무를 가진다.',
        '제휴마케팅 기획, 개발 및 운영: "제휴플랫폼"을 통한 마케팅 서비스의 기획, 개발, 운영 업무를 담당한다.',
        '컨설팅 및 교육 제공: "제휴플랫폼" 및 관련 서비스를 통한 마케팅 컨설팅 및 교육을 제공한다.',
        '마케팅 대행 및 지원: "고객사" 또는 소속 협력사 판매원에게 마케팅 대행 및 컨설팅을 제공한다.',
        '고객 DB 제공 관리: "멘토"로부터 제공된 고객 DB를 관리하며, "고객사"가 이를 활용할 수 있도록 지원한다.',
        '추가 서비스 제공: "회사"가 제공하는 추가 서비스의 내용을 "고객사"와 협의하여 확정한다.',
        '',
        '제5조 (고객사의 의무)',
        '① "고객사"는 "회사"와 "멘토"의 제휴마케팅 품질 향상을 위해 다음과 같은 의무를 진다.',
        '영업 데이터 제공: 영업 활동을 통해 축적한 통계, 데이터 및 소비자의 행동 내역 등을 "회사"와 "멘토"에 제공한다.',
        '영업 및 마케팅 관련 책임: "고객사"는 마케팅 활동으로 인한 책임을 전적으로 부담하며, "회사"와 "멘토"에 손해가 발생할 경우 이를 배상해야 한다.',
        'DB 사용 제한: 제공받은 DB는 본 계약에서 정한 목적 내에서만 활용해야 하며, 이를 위반할 경우 손해 배상 책임이 발생한다.',
        '다단계 영업 금지 조항: "고객사"는 다른 사람을 모집하여 수당 구조에 추가적인 하위 영업 조직을 형성하는 방식으로 영업해서는 안 된다. 이는 다단계 방식으로 간주될 수 있으며, 이를 위반할 경우 "회사"와 "멘토"의 명예 훼손 및 법적 문제를 야기할 수 있다.',
        '\'스터디원 등급\' 활동에 대한 책임: "고객사"는 "회사"가 주는 서비스를 받고 활동을 해야 할 의무가 있으며, 이 의무를 1개월간 활동하지 않는 것은 이렇게 체크 한다.',
        '1) 1개월 동안 멘토와 소통이 되지 않는 경우',
        '2) 1개월 동안 마케터로서 교육받은 마케팅 결과물을 만들지 않은 경우',
        '2가지에 해당 되는 경우 \'궁금해요\'등급 강등이 될 수 있다.',
        '3) \'궁금해요\' 강등 시 멘토가 준 모든 DB는 "멘토"가 회수 하여 멘토가 관리 한다.',
        '단, \'궁금해요\'등급 으로 다시 스터디를 하면서 \'스터디원\' 등급 도전을 다시 할 수 있다.',
        '',
        '제6조 (DB 제공 및 수수료 규정)',
        '① DB 제공: 본 계약에 따른 모든 고객 DB는 "멘토"가 제공하며, DB의 소유권 및 모든 영업 권한은 "멘토"에게 있다.',
        '② DB 사용 제한: "고객사"는 제공받은 DB를 다른 영업직이나 다른 영업 활동에 사용할 수 없으며, 이를 위반할 경우 3,000만 원의 위약금을 "멘토"에게 배상해야 한다.',
        '③ 수수료 지급: "고객사"는 신규 DB 1개당 1만 원의 수수료를 "멘토"에게 지급해야 한다.',
        '신청 데이터 기준 3일 이전 DB를 신규 DB 라고 칭한다.',
        '',
        '제7조 (비밀유지 및 경업행위, 리크루팅 금지)',
        '① 비밀유지: "고객사"는 계약 기간 중 및 계약 종료 후 7년간 "회사"와 "멘토"의 영업 비밀, 교육 자료, 마케팅 기법 등 모든 정보에 대해 비밀을 유지해야 하며, 제3자에게 유출하거나 무단으로 사용해서는 안 된다.',
        '② 경업 금지: "고객사"는 계약 기간 동안 및 계약 종료 후 7년간 다음과 같은 행위를 할 수 없다.',
        '"회사" 및 "멘토"와 동일하거나 유사한 형태의 사업을 영위하거나 제3자를 통해 영위하는 행위.',
        '"멘토"가 제공한 DB를 활용하여 동일한 서비스를 제공하는 경쟁사 설립 및 운영.',
        '③ 리크루팅 금지: "고객사"는 계약 기간 중 및 종료 후 7년간 "회사" 또는 "멘토"의 의뢰인이나 관련자들을 대상으로 다음과 같은 리크루팅 활동을 할 수 없다.',
        '직원, 사업자, 판매원 등을 모집하거나 권유하는 행위.',
        '"회사"와 "멘토"의 관계자를 대상으로 한 상품 홍보, 영업 아이템 권유 등.',
        '④ 판매 및 구매 제한: "고객사"는 "회사"와 "멘토"의 서면 동의 없이 다음과 같은 행위를 할 수 없다.',
        '"회사" 및 "멘토"의 다른 의뢰인에게 제품을 판매하거나 해당 제품을 구매하는 행위.',
        '"회사"와 "멘토"의 다른 의뢰인 간 사적 거래나 상업적 관계를 맺는 행위.',
        '⑤ 비밀 모임 금지: "고객사"는 "회사" 및 "멘토"의 승인 없이 "회사"와 "멘토"의 다른 의뢰인들과 사적 모임을 만들거나 유지할 수 없다. 여기서 사적 모임이란 "회사"와 "멘토"에게 사전 보고되지 않은 온·오프라인 모임을 의미한다.',
        '',
        '제8조 (비용 지급 및 정산 절차)',
        '① 비용 지급: "고객사"는 제9조에 명시된 유료 서비스인 \'현장실무를 위한 액기스 강의 4주 과정\'의 수강료로 330만 원을 계약 체결 시 선불로 1회 "회사"에 지급한다.',
        '결제 링크: http://leadz.kr/xA8',
        '\'멘토\'에게 본사로 연결된 카드 결제링크 지급 받는다.',
        '계좌이체는: 국민 531301-04-166504 마비즈스쿨 원격평생교육원 (전혜선)로 지급 받는다.',
        '',
        '제9조 (제공 서비스 설명)',
        '【1. 유료 서비스: 현장실무를 위한 액기스 강의 4주 과정】',
        '"고객사"가 지급하는 330만 원은 오직 아래의 4주 과정에 대한 수강료에만 해당한다.',
        '현장 실무를 위한 액기스 강의 4주 과정',
        '성공마인드셋교육',
        '상품교육',
        '세일즈 강의',
        '스크립트 강의',
      ],
    },
  ],
  CRUISE_STAFF: [
    {
      title: '교육 계약서 (크루즈스탭) - 540 판매원 계약서 마비즈 계약서 2025-07-04의 사본 (1).docx',
      clauses: [
        '마케팅 세일즈 에이전시 서비스 제휴 계약서',
        '본 서비스 제휴 계약(이하 "본 계약")은 주식회사 마비즈컴퍼니(이하 "회사"), 고객사(이하 "고객사"), 그리고 멘토(이하 "멘토") 사이에서 체결되었다. 이하 "회사", "고객사", "멘토" 중 1인을 가리켜 "당사자", 그 전부를 가리켜 "당사자들"이라 한다.',
        '',
        '제1조 (목적)',
        '본 계약은 "고객사"가 "회사"와 "멘토"로부터 제공받는 홍보 및 제휴마케팅 서비스(이하 "제휴마케팅")와 관련된 업무 처리 방법과 조건을 정하고, 당사자 간의 권리, 의무 및 기타 제반 사항을 규정함을 목적으로 한다. 제공되는 서비스에는 DB 지급, 세일즈 교육, 마케팅 교육 등이 포함된다.',
        '',
        '제2조 (용어의 정의)',
        '본 계약에서 사용하는 용어의 정의는 다음과 같다. 본 계약서에서 별도로 정의하지 않은 용어는 "회사", "고객사" 및 "멘토"의 이용약관에서 정의한 바에 따른다.',
        '"고객"이란 "회사", "고객사" 및 "멘토"가 제공하는 "제휴마케팅"을 이용하는 모든 사람을 의미한다.',
        '"마케팅"이란 "고객사"의 기존 소비자를 관리하고 신규 소비자를 유치하기 위한 모든 활동을 의미하며, "제휴마케팅"이란 "회사"가 일정 비용을 지급받는 대가로 "고객사"의 마케팅을 돕는 것을 의미한다.',
        '고객 DB(데이터베이스)란, 고객이 신청한 이름, 전화번호 등 영업에 필요한 정보의 총체를 말하며, 본 계약에 따라 "멘토"가 제공한다.',
        '"제휴플랫폼"이란 "회사"가 제공하는 사이트와 마케팅 솔루션을 의미한다.',
        '"경업"이란 "고객사"가 본 계약과 유사한 형태의 사업을 "회사" 또는 "멘토"의 동의 없이 영위하거나 제3자로 하여금 영위하게 하는 것을 말한다.',
        '"리크루팅"이란 "회사" 또는 "멘토"의 고객이나 관계자를 대상으로 직원이나 사업자를 모집하거나 권유하는 행위를 말한다.',
        '',
        '제3조 (계약기간 및 갱신)',
        '① 본 계약에 따른 유료 서비스, 즉 \'현장실무를 위한 액기스 강의 4주 과정\'의 제공 기간은 결제일로부터 4주로 한정하며, 해당 기간이 만료되면 "회사"의 주된 서비스 제공 의무는 정상적으로 이행 완료된 것으로 본다.',
        '② 제9조에 명시된 부가 서비스는 무상 프로모션으로 제공되며, 그 이용 권한은 계약 체결일로부터 12개월간 유지된다.',
        '③ 제2항의 무상 서비스 기간(12개월) 만료 30일 이전에 당사자 일방의 서면 해지 통지가 없는 경우, 무상 부가 서비스 이용 권한은 동일한 조건으로 1년씩 자동으로 연장된다.',
        '④ 계약 기간 중 계약 위반 시, 계약은 즉시 해지될 수 있다.',
        '',
        '제4조 (회사의 의무)',
        '① "회사"는 다음과 같은 의무를 가진다.',
        '제휴마케팅 기획, 개발 및 운영: "제휴플랫폼"을 통한 마케팅 서비스의 기획, 개발, 운영 업무를 담당한다.',
        '컨설팅 및 교육 제공: "제휴플랫폼" 및 관련 서비스를 통한 마케팅 컨설팅 및 교육을 제공한다.',
        '마케팅 대행 및 지원: "고객사" 또는 소속 협력사 판매원에게 마케팅 대행 및 컨설팅을 제공한다.',
        '고객 DB 제공 관리: "멘토"로부터 제공된 고객 DB를 관리하며, "고객사"가 이를 활용할 수 있도록 지원한다.',
        '추가 서비스 제공: "회사"가 제공하는 추가 서비스의 내용을 "고객사"와 협의하여 확정한다.',
        '',
        '제5조 (고객사의 의무)',
        '① "고객사"는 "회사"와 "멘토"의 제휴마케팅 품질 향상을 위해 다음과 같은 의무를 진다.',
        '영업 데이터 제공: 영업 활동을 통해 축적한 통계, 데이터 및 소비자의 행동 내역 등을 "회사"와 "멘토"에 제공한다.',
        '영업 및 마케팅 관련 책임: "고객사"는 마케팅 활동으로 인한 책임을 전적으로 부담하며, "회사"와 "멘토"에 손해가 발생할 경우 이를 배상해야 한다.',
        'DB 사용 제한: 제공받은 DB는 본 계약에서 정한 목적 내에서만 활용해야 하며, 이를 위반할 경우 손해 배상 책임이 발생한다.',
        '다단계 영업 금지 조항: "고객사"는 다른 사람을 모집하여 수당 구조에 추가적인 하위 영업 조직을 형성하는 방식으로 영업해서는 안 된다. 이는 다단계 방식으로 간주될 수 있으며, 이를 위반할 경우 "회사"와 "멘토"의 명예 훼손 및 법적 문제를 야기할 수 있다.',
        '\'스터디원 등급\' 활동에 대한 책임: "고객사"는 "회사"가 주는 서비스를 받고 활동을 해야 할 의무가 있으며, 이 의무를 1개월간 활동하지 않는 것은 이렇게 체크 한다.',
        '1) 1개월 동안 멘토와 소통이 되지 않는 경우',
        '2) 1개월 동안 마케터로서 교육받은 마케팅 결과물을 만들지 않은 경우',
        '2가지에 해당 되는 경우 \'궁금해요\'등급 강등이 될 수 있다.',
        '3) \'궁금해요\' 강등 시 멘토가 준 모든 DB는 "멘토"가 회수 하여 멘토가 관리 한다.',
        '단, \'궁금해요\'등급 으로 다시 스터디를 하면서 \'스터디원\' 등급 도전을 다시 할 수 있다.',
        '',
        '제6조 (DB 제공 및 수수료 규정)',
        '① DB 제공: 본 계약에 따른 모든 고객 DB는 "멘토"가 제공하며, DB의 소유권 및 모든 영업 권한은 "멘토"에게 있다.',
        '② DB 사용 제한: "고객사"는 제공받은 DB를 다른 영업직이나 다른 영업 활동에 사용할 수 없으며, 이를 위반할 경우 3,000만 원의 위약금을 "멘토"에게 배상해야 한다.',
        '③ 수수료 지급: "고객사"는 신규 DB 1개당 1만 원의 수수료를 "멘토"에게 지급해야 한다.',
        '신청 데이터 기준 3일 이전 DB를 신규 DB 라고 칭한다.',
        '',
        '제7조 (비밀유지 및 경업행위, 리크루팅 금지)',
        '① 비밀유지: "고객사"는 계약 기간 중 및 계약 종료 후 7년간 "회사"와 "멘토"의 영업 비밀, 교육 자료, 마케팅 기법 등 모든 정보에 대해 비밀을 유지해야 하며, 제3자에게 유출하거나 무단으로 사용해서는 안 된다.',
        '② 경업 금지: "고객사"는 계약 기간 동안 및 계약 종료 후 7년간 다음과 같은 행위를 할 수 없다.',
        '"회사" 및 "멘토"와 동일하거나 유사한 형태의 사업을 영위하거나 제3자를 통해 영위하는 행위.',
        '"멘토"가 제공한 DB를 활용하여 동일한 서비스를 제공하는 경쟁사 설립 및 운영.',
        '③ 리크루팅 금지: "고객사"는 계약 기간 중 및 종료 후 7년간 "회사" 또는 "멘토"의 의뢰인이나 관련자들을 대상으로 다음과 같은 리크루팅 활동을 할 수 없다.',
        '직원, 사업자, 판매원 등을 모집하거나 권유하는 행위.',
        '"회사"와 "멘토"의 관계자를 대상으로 한 상품 홍보, 영업 아이템 권유 등.',
        '④ 판매 및 구매 제한: "고객사"는 "회사"와 "멘토"의 서면 동의 없이 다음과 같은 행위를 할 수 없다.',
        '"회사" 및 "멘토"의 다른 의뢰인에게 제품을 판매하거나 해당 제품을 구매하는 행위.',
        '"회사"와 "멘토"의 다른 의뢰인 간 사적 거래나 상업적 관계를 맺는 행위.',
        '⑤ 비밀 모임 금지: "고객사"는 "회사" 및 "멘토"의 승인 없이 "회사"와 "멘토"의 다른 의뢰인들과 사적 모임을 만들거나 유지할 수 없다. 여기서 사적 모임이란 "회사"와 "멘토"에게 사전 보고되지 않은 온·오프라인 모임을 의미한다.',
        '',
        '제8조 (비용 지급 및 정산 절차)',
        '① 비용 지급: "고객사"는 제9조에 명시된 유료 서비스인 \'현장실무를 위한 액기스 강의 4주 과정\'의 수강료로 540만 원을 계약 체결 시 선불로 1회 "회사"에 지급한다.',
        '결제 링크: http://leadz.kr/xHX',
        '\'멘토\'에게 본사로 연결된 카드 결제링크 지급 받는다.',
        '계좌이체는: 국민 531301-04-166504 마비즈스쿨 원격평생교육원 (전혜선)로 지급 받는다.',
        '② 수수료 정산: 신규 DB에 대한 수수료는 1개당 1만원 이다. 매월 15일에 "멘토"에게 지급한다.',
        '③ 정산 절차: "회사"는 매월 말까지 발생한 비용 내역을 정산하여 익월 15일까지 "고객사"에 통지하며, "고객사"는 해당 월 15일까지 비용을 "회사"와 "멘토"에게 지급해야 한다."고객사"가 회사에 기여한 매출도 15일에 정산을 "회사"에게 지급받는다.',
        '④ 추가 정산 규정: 필요 시 서면 합의를 통해 정산 주기나 비용을 변경할 수 있다.',
        '',
        '제9조 (제공 서비스 설명)',
        '【1. 유료 서비스: 현장실무를 위한 액기스 강의 4주 과정】',
        '"고객사"가 지급하는 540만 원은 오직 아래의 4주 과정에 대한 수강료에만 해당한다.',
        '현장 실무를 위한 액기스 강의 4주 과정',
        '성공마인드셋교육',
        '상품교육',
        '세일즈 강의',
        '스크립트 강의',
        '영업기초편',
        '온라인 코칭 3회',
        '',
        '【2. 무상 프로모션 부가 서비스】',
        '아래의 부가 서비스는 상기 유료 서비스 결제 시 1년간 무상으로 제공되는 프로모션 혜택이며, 제11조의 환불 대상 및 기간 산정 기준에 포함되지 않는다.',
        '',
        '제9조 (제공 서비스 설명)',
        '서비스명: 세일즈 지원 서비스',
        '서비스내용: 세일즈에 필요한 모든 종류의 세일즈 지원 교육 혜택을 말한다., 해당 서비스의 종류는 지속적으로 추가 및 개선 된다.',
        '운영 카페: 1% 카페 https://cafe.naver.com/funhanshop2',
        '\'스터디원\' 등급으로 필요한 교육을 온라인 상시 강의를 볼 수 있다.',
        '',
        '서비스명: 마케팅 지원 및 자문 서비스',
        'SNS 정기적 검토 및 개선사항 피드백',
        '마케팅 활동 및 기획에 대한 마케팅 전문가의 자문 서비스',
        '오픈 카톡방 24시간 소통 연락망 제공',
        '1% 카페 교육을 받는 정회원들 간의 커뮤니티 제공, 사업을 하며 만날 수 있는 모든 상황에 대해 소통할 수 있는 오픈 카톡방 제공',
        '"고객사"와 24시간 카톡방으로 소통을 원활하게 주고 받을 수 있도록 한다.',
        '',
        '서비스명: SNS 마케팅 교육 콘텐츠',
        '1. SNS 마케팅 기술 교육',
        '2. SNS 마케팅을 실전 세일즈에 활용할 수 있는 고객 심리활용 스킬 교육',
        '3. SNS 마케팅을 통해 아이템 혹은 사업에 대한 상담을 요청하는 고객을 만드는 방법에 대한 교육',
        '4. SNS 마케팅을 잘 이용하고 있는 다른 사업자들의 인스타그램 분석을 통한 세밀한 교육',
        '',
        '서비스명: 아이템 제품 세일즈 교육 콘텐츠',
        '고객이 상담 받고 싶도록 만드는 세일즈 노하우 교육',
        '고객과의 미팅을 자연스럽게 잡을 수 있는 세일즈 노하우 교육',
        '고객의 구매 심리를 자극하게 하는 세일즈 노하우 교육',
        '아이템별 세일즈 노하우 교육',
        '아이템을 접하고 고객의 반응별 대처방법 세일즈 노하우 교육',
        '',
        '서비스명: 세일즈 활용 콘텐츠',
        '고객과의 미팅시 활용할 수 있는 자료, 세일즈에 도움되는 각종 콘텐츠 자료 제공',
        '',
        '서비스명: 아이템 전문가 양성 18주, 온라인 코칭 4회',
        '왜 크루즈 인가?, 다른 여행과의 비교 분석, 크루즈 산업의 이해',
        '크루즈 상품의 기본 구조, 크루즈 등급과 가격 체계, 선박의 종류와 특징',
        '크루즈 예약 기초 지식, 예약부터 승선까지의 단계, 주요 예약 시스템 소개',
        '선내 생활 안내, 크루즈 시설 및 프로그램, 선상 에티켓과 주의 사항',
        '크루즈 여행 관련 FAQ, 실전 질문 대응 훈련, 고객 유형별 응대 방법',
        '크루즈 상담 기법, 고객 니즈 파악하기, 맞춤형 제안 전략',
        '예약 시스템 실습, 선실 선택 전략, 특별 요청 처리 방법',
        '출발전 체크리스트, 고객관리 시스템 활용, 사전 정보 제공 방법',
        '부가 상품 소개 기술, 업셀링과 크로스셀링, 프리미엄 서비스 판매법',
      ],
    },
  ],
  PRIMARKETER: [
    {
      title: '교육 계약서 (프리마케터) - 100만원 판매원 계약서 .docx',
      clauses: [
        '크루즈 전문 판매원 위촉 및 교육 서비스 계약서',
        '본 서비스 제휴 계약(이하 "본 계약")은 주식회사 마비즈컴퍼니(이하 "회사"), 판매원(이하 "고객사"), 그리고 멘토(이하 "멘토") 사이에서 체결되었다. 이하 "회사", "고객사", "멘토" 중 1인을 가리켜 "당사자", 그 전부를 가리켜 "당사자들"이라 한다.',
        '',
        '제1조 (목적)',
        '본 계약은 "고객사"가 "회사"와 "멘토"로부터 제공받는 크루즈 상품 판매 권한, 판매원 전용 쇼핑몰(이하 "판매원몰") 분양 및 이에 필요한 마케팅·세일즈 교육과 관련된 업무 처리 방법과 조건을 정하고, 당사자 간의 권리, 의무 및 기타 제반 사항을 규정함을 목적으로 한다.',
        '',
        '제2조 (용어의 정의)',
        '본 계약에서 사용하는 용어의 정의는 다음과 같다.',
        '"판매원몰"이란 "회사"가 "고객사"에게 영업 활동을 위해 제공하는 크루즈 상품 판매 전용 온라인 사이트 및 관리자 페이지를 의미한다.',
        '"구DB(Old Data)"란 과거 마케팅 활동을 통해 수집되었으나 현재 시점에서 신규로 분류되지 않는 데이터베이스를 의미하며, 본 계약에 따라 영업 연습 및 가망 고객 발굴 용도로 "멘토"가 제공한다.',
        '"크루즈 판매권"이란 "회사"가 취급하는 크루즈 여행 상품을 "판매원몰"을 통해 소비자에게 판매할 수 있는 권한을 의미한다.',
        '"독립 사업자"란 "고객사"가 "회사"에 고용된 근로자가 아니며, 독립적인 지위에서 자신의 책임과 판단하에 영업을 수행하는 프리랜서(또는 개인사업자)임을 의미한다. 따라서 "고객사"는 근로기준법상의 근로자로 간주되지 않으며, 4대 보험, 퇴직금, 연차 수당 등 근로자에게 적용되는 일체의 권리를 주장할 수 없다.',
        '',
        '제3조 (서비스의 성격 및 수익 비보장)',
        '① 본 계약에 따른 서비스는 크루즈 판매를 위한 \'실무 교육\'과 \'판매 시스템(쇼핑몰)\'을 제공하는 것에 한정된다.',
        '② 수익 비보장: "회사"와 "멘토"는 "고객사"에게 구체적인 매출이나 수익을 보장하지 않는다. 영업 성과는 전적으로 "고객사" 개인의 역량과 활동량에 달려 있음을 "고객사"는 충분히 인지하고 이에 동의한다.',
        '',
        '제4조 (계약기간 및 서비스 제공)',
        '① 본 계약에 따른 유료 교육 서비스, 즉 \'마케팅 및 세일즈 실전 통합 과정(총 4주)\'의 제공 기간은 결제일로부터 4주로 한정하며, 해당 기간이 만료되면 "회사"의 교육 제공 의무는 이행 완료된 것으로 본다.',
        '② "판매원몰" 이용 권한 및 부가 서비스는 계약 체결일로부터 12개월간 유지된다.',
        '③ 제2항의 기간 만료 30일 이전에 서면 해지 통지가 없는 경우, 이용 권한은 동일한 조건으로 1년씩 자동 연장된다.',
        '',
        '제5조 (회사의 의무)',
        '"회사"는 다음과 같은 의무를 가진다.',
        '판매원몰 분양 및 관리: "고객사"가 크루즈 상품을 판매할 수 있는 전용 쇼핑몰 시스템을 제공하고 유지 보수한다.',
        '교육 제공: 마케팅 세일즈 4주로 구성된 총 4주(4시간) 커리큘럼의 교육을 제공한다.',
        '상품 소싱: 판매 가능한 크루즈 상품을 기획하고 공급한다.',
        '',
        '제6조 (고객사의 의무)',
        '"고객사"는 다음의 의무를 진다.',
        '크루즈 판매 활동: 제공받은 "판매원몰"을 활용하여 합법적인 방식으로 크루즈 상품 판매 활동을 수행한다.',
        'DB 활용 준수: 제공받은 "구DB"는 본 계약 목적 내에서만 활용해야 하며, 불법적인 스팸 발송 등 정보통신망법을 위반하는 행위를 해서는 안 된다.',
        '품위 유지: "회사"와 "멘토"의 명예를 훼손하거나 다단계 방식으로 오인될 수 있는 영업 활동을 금지한다.',
        '',
        '제7조 (DB 제공 및 면책)',
        '① 신규 DB 미지급: 본 계약은 100만 원 소자본 창업 및 교육 계약이므로, "회사"와 "멘토"는 "고객사"에게 별도의 비용을 받고 판매하는 \'신규 DB(유료 DB)\'를 공급할 의무가 없다.',
        '② 구DB 무제한 제공: "멘토"는 "고객사"의 영업 훈련 및 가망 고객 발굴을 돕기 위해 보유하고 있는 "구DB"를 무제한으로 열람 또는 사용할 수 있도록 제공한다.',
        '③ 데이터 품질 면책: "구DB"는 과거 데이터이므로 결번, 수신 거부, 고객의 비우호적 반응 등이 포함될 수 있다. "회사"와 "멘토"는 데이터의 최신성 및 유효성에 대해 어떠한 보증도 하지 않으며, "고객사"는 DB의 품질을 이유로 계약 해지나 환불을 요구할 수 없다.',
        '④ DB 사용 제한: "고객사"는 제공받은 구DB를 타 영업직이나 타사 상품 판매(보험, 상조, 부동산 등 타 업종 포함)에 절대 사용할 수 없으며, 이를 위반할 경우 제12조에 따른 위약금이 발생한다.',
        '',
        '제8조 (비밀유지 및 경업금지)',
        '① 비밀유지: "고객사"는 계약 기간 중 및 계약 종료 후 7년간 "회사"와 "멘토"의 영업 비밀, 교육 자료, 마케팅 기법 등 모든 정보에 대해 비밀을 유지해야 하며, 제3자에게 유출하거나 무단으로 사용해서는 안 된다.',
        '② 경업 금지: "고객사"는 계약 기간 동안 및 계약 종료 후 7년간 "회사" 및 "멘토"와 동일하거나 유사한 형태의 사업을 영위하거나, "멘토"가 제공한 DB를 활용하여 경쟁사를 설립·운영할 수 없다.',
        '③ 리크루팅 금지: "고객사"는 계약 기간 중 및 종료 후 7년간 "회사" 또는 "멘토"의 의뢰인이나 관계자들을 대상으로 직원이나 판매원을 모집하는 행위를 할 수 없다.',
        '',
        '제9조 (비용 지급)',
        '① 비용: "고객사"는 본 계약에 따른 가입비, 교육비 및 시스템 세팅비로 일금 일백만 원정(\\1,000,000, VAT 별도)을 계약 체결 시 선불로 지급한다.',
        '② 결제 계좌 및 방식은 "회사"가 별도로 안내하는 바에 따른다.',
        '',
        '제10조 (제공 서비스 상세)',
        '"고객사"가 지급하는 100만 원에 대한 서비스 구성은 다음과 같다.',
        '',
        '1. 유료 서비스: 마케팅 & 세일즈 실전 통합 과정 (총 8주)',
        '1~2주차 (마케팅): SNS 채널 개설, 기초 브랜딩, 트래픽 생성 기초, 콘텐츠 기획 (4시간)',
        '3~4주차 (세일즈): 고객 심리 파악, 상담 스크립트 활용, 클로징 기법, 컴플레인 대처 (4시간)',
        '',
        '2. 제공 솔루션 및 권한',
        '판매원몰 분양: 개인별 크루즈 판매 전용 쇼핑몰(웹사이트) 및 관리자 모드 제공',
        '판매 권한: 크루즈 여행 상품 판매 권한 부여 (타 상품 판매 불가)',
        'DB 지원: 구DB(Old DB) 무제한 사용 권한 제공 (신규 DB 제외)',
        '',
        '제11조 (계약의 해지 및 환불 기준)',
        '① 본 계약의 환불 규정은 「평생교육법」 및 「전자상거래 등에서의 소비자보호에 관한 법률」을 준수한다.',
        '② 초기 세팅비 공제: 본 계약 체결 즉시 "고객사" 전용의 \'판매원몰(쇼핑몰)\' 개설 및 서버 세팅이 진행되므로, 교육 수강 여부와 관계없이 초기 세팅비 및 행정 수수료 명목으로 금 500,000원이 공제된다.',
        '③ 환불 금액 산정: 환불 요청 시, 결제 금액(100만 원)에서 위 세팅비(50만 원)를 우선 차감한 잔액(50만 원)을 기준으로 아래와 같이 산정한다.',
        '수업 시작 전: 잔액 전액 환불',
        '총 수업시간의 1/3 경과 전: 잔액의 2/3 해당액 환불',
        '총 수업시간의 1/2 경과 전: 잔액의 1/2 해당액 환불',
        '총 수업시간의 1/2 경과 후: 환불 불가',
        '④ 단순 변심에 의한 환불 요청 시 결제일로부터 7일 이내에만 100% 환불이 가능하나, 이미 강의를 수강하였거나 쇼핑몰 세팅이 완료된 경우 해당 비용은 공제된다.',
        '',
        '제12조 (손해배상 및 위약벌)',
        '① 본 계약 제7조(DB 유용), 제8조(비밀유지)를 위반할 경우, "고객사"는 "회사"에게 발생한 손해를 배상해야 한다.',
        '② 위약벌: 특별 제공된 DB를 타 용도로 유용하거나 무단 유출한 경우, 또는 "회사"의 승인 없이 타사 상품을 판매하는 경우 피해 규모와 상관없이 위약벌로 금 3,000만 원을 지급하기로 합의한다.',
        '③ 악성 행위로 인한 해지: "고객사"가 다음 각 호에 해당하는 행위를 할 경우, "회사"는 즉시 계약을 해지할 수 있으며 기 납입한 비용은 일체 환불되지 않는다.',
        '단체 채팅방, 커뮤니티 등에서 근거 없는 사실로 "회사"나 "멘토"를 비방하거나 허위 사실을 유포하는 행위',
        '타 수강생이나 판매원에게 부정적인 영향을 미치거나 선동하여 영업을 방해하는 행위',
        '정당한 절차를 거치지 않고 반복적으로 악성 민원을 제기하여 업무를 방해하는 행위',
        '',
        '제13조 (저작권 및 권리 귀속)',
        '① "회사"가 제공하는 교육 자료, 영상, 판매원몰의 디자인 및 시스템에 대한 저작권은 "회사"에 있다.',
        '② "고객사"는 이를 무단으로 복제, 배포하거나 타인에게 양도할 수 없다.',
        '',
        '제14조 (전속 제휴 및 판매 제한)',
        '① 크루즈 판매 한정: "고객사"는 본 계약을 통해 오직 "회사"가 공급하는 \'크루즈 상품\'에 한해서만 판매 권한을 갖는다.',
        '② "회사"의 사전 승인 없이 "판매원몰"을 통해 타사의 상품을 판매하거나, "회사"의 DB(구DB 포함)를 활용하여 다른 영업(보험, 상조, 타 여행사 상품 등)을 병행하는 것은 엄격히 금지된다.',
        '',
        '제15조 (기타)',
        '본 계약에 명시되지 않은 사항은 관계 법령 및 상관례에 따르며, 분쟁 발생 시 서울중앙지방법원을 관할 법원으로 한다.',
        '당사자들은 본 계약을 성실히 준수할 것을 다짐하며 본 계약서에 날인하고, 본 계약의 체결과 그 내용을 증명하기 위해 계약서 3부를 작성하여 각자 1부씩 보관한다.',
      ],
    },
  ],
  BRANCH_MANAGER: [
    {
      title: '교육 계약서 (대리점장) - 750 B2B 계약서 .docx',
      clauses: [
        '마케팅 세일즈 에이전시 서비스 제휴 계약서',
        '본 서비스 제휴 계약(이하 "본 계약")은 주식회사 마비즈컴퍼니(이하 "회사"), 고객사(이하 "고객사"), 그리고 멘토(이하 "멘토") 사이에서 체결되었다. 이하 "회사", "고객사", "멘토" 중 1인을 가리켜 "당사자", 그 전부를 가리켜 "당사자들"이라 한다.',
        '',
        '제1조 (목적)',
        '본 계약은 "고객사"가 "회사"와 "멘토"로부터 제공받는 홍보 및 제휴마케팅 서비스(이하 "제휴마케팅")와 관련된 업무 처리 방법과 조건을 정하고, 당사자 간의 권리, 의무 및 기타 제반 사항을 규정함을 목적으로 한다. 제공되는 서비스에는 퍼널마케팅설계, 세일즈 교육, 마케팅 교육, 아이템 교육, DB지급 서비스 등이 포함된다.',
        '',
        '제2조 (용어의 정의)',
        '본 계약에서 사용하는 용어의 정의는 다음과 같다. 본 계약서에서 별도로 정의하지 않은 용어는 "회사", "고객사" 및 "멘토"의 이용약관에서 정의한 바에 따른다.',
        '"고객"이란 "회사", "고객사" 및 "멘토"가 제공하는 "제휴마케팅"을 이용하는 모든 사람을 의미한다.',
        '"마케팅"이란 "고객사"의 기존 소비자를 관리하고 신규 소비자를 유치하기 위한 모든 활동을 의미하며, "제휴마케팅"이란 "회사"가 일정 비용을 지급받는 대가로 "고객사"의 마케팅을 돕는 것을 의미한다.',
        '고객 DB(데이터베이스)란, 고객이 신청한 이름, 전화번호 등 영업에 필요한 정보의 총체를 말하며, 본 계약에 따라 "멘토"가 제공한다.',
        '"제휴플랫폼"이란 "회사"가 제공하는 사이트와 마케팅 솔루션을 의미한다.',
        '"경업"이란 "고객사"가 본 계약과 유사한 형태의 사업을 "회사" 또는 "멘토"의 동의 없이 영위하거나 제3자로 하여금 영위하게 하는 것을 말한다.',
        '"리크루팅"이란 "회사" 또는 "멘토"의 고객이나 관계자를 대상으로 직원이나 사업자를 모집하거나 권유하는 행위를 말한다.',
        '',
        '제3조 (계약기간 및 갱신)',
        '① 본 계약에 따른 유료 서비스, 즉 \'비즈니스 모델 설계 + 퍼널마케팅 + 코칭 6주 과정\'의 제공 기간은 결제일로부터 4주로 한정하며, 해당 기간이 만료되면 "회사"의 주된 서비스 제공 의무는 정상적으로 이행 완료된 것으로 본다.',
        '② 제9조에 명시된 부가 서비스는 무상 프로모션으로 제공되며, 그 이용 권한은 계약 체결일로부터 12개월간 유지된다.',
        '③ 제2항의 무상 서비스 기간(12개월) 만료 30일 이전에 당사자 일방의 서면 해지 통지가 없는 경우, 무상 부가 서비스 이용 권한은 동일한 조건으로 1년씩 자동으로 연장된다.',
        '④ 계약 기간 중 계약 위반 시, 계약은 즉시 해지될 수 있다.',
        '',
        '제4조 (회사의 의무)',
        '① "회사"는 다음과 같은 의무를 가진다.',
        '제휴마케팅 기획, 개발 및 운영: "제휴플랫폼"을 통한 마케팅 서비스의 기획, 개발, 운영 업무를 담당한다.',
        '컨설팅 및 교육 제공: "제휴플랫폼" 및 관련 서비스를 통한 마케팅 컨설팅 및 교육을 제공한다.',
        '마케팅 대행 및 지원: "고객사"에게 마케팅 대행 및 컨설팅을 제공한다.',
        '고객 DB 제공 관리: "멘토"로부터 제공된 고객 DB를 관리하며, "고객사"가 이를 활용할 수 있도록 지원한다.',
        '추가 서비스 제공: "회사"가 제공하는 추가 서비스의 내용을 "고객사"와 협의하여 확정한다.',
        '',
        '제5조 (고객사의 의무)',
        '① "고객사"는 "회사"와 "멘토"의 제휴마케팅 품질 향상을 위해 다음과 같은 의무를 진다.',
        '영업 데이터 제공: 영업 활동을 통해 축적한 통계, 데이터 및 소비자의 행동 내역 등을 "회사"와 "멘토"에 제공한다.',
        '영업 및 마케팅 관련 책임: "고객사"는 마케팅 활동으로 인한 책임을 전적으로 부담하며, "회사"와 "멘토"에 손해가 발생할 경우 이를 배상해야 한다.',
        'DB 사용 제한: 제공받은 DB는 본 계약에서 정한 목적 내에서만 활용해야 하며, 이를 위반할 경우 손해 배상 책임이 발생한다.',
        '다단계 영업 금지 조항: "고객사"는 다른 사람을 모집하여 수당 구조에 추가적인 하위 영업 조직을 형성하는 방식으로 영업해서는 안 된다. 이는 다단계 방식으로 간주될 수 있으며, 이를 위반할 경우 "회사"와 "멘토"의 명예 훼손 및 법적 문제를 야기할 수 있다.',
        '\'1인창업 등급\' 활동에 대한 책임: "고객사"는 "회사"가 주는 서비스를 받고 활동을 해야 할 의무가 있다. 아래 사항으로 확인 될 경우',
        '1) 협력사 매 주 1회 회의에 연속 2회 이상 참여 않을 경우',
        '2) 협력사 마케팅을 1개월 이상 하지 않는 경우',
        '3) 협력사 오프라인 활동 연속 2회 이상 활동 하지 않을 경우',
        '4) 협력사와 본사 1개월 이상 소통하지 않은 경우',
        '\'스터디원 등급\'으로 하락 할 수 있다.',
        '\'스터디원 등급\' 강등 시 멘토가 준 모든 DB는 "멘토"가 회수한다.',
        '단, 다시 학습하여 멘토와 상의 후 1인창업 등급으로 복귀 할 수 있다.',
        '',
        '제6조 (DB 제공 및 수수료 규정)',
        '① DB 제공: 본 계약에 따른 모든 고객 DB는 "멘토"가 제공하며, DB의 소유권 및 모든 영업 권한은 "멘토"에게 있다.',
        '② DB 사용 제한: "고객사"는 제공받은 DB를 다른 영업직이나 다른 영업 활동에 사용할 수 없으며, 이를 위반할 경우 3,000만 원의 위약금을 "멘토"에게 배상해야 한다.',
        '③ 수수료 지급: "고객사"는 신규 DB 1개당 1만 원의 수수료를 "멘토"에게 지급해야 한다.',
        '신청 데이터 기준 3일 이전 DB를 신규 DB 라고 칭한다.',
        '④ 비신규 DB 사용: 신규 DB가 아닌 경우 "멘토"로부터 무상으로 DB를 제공받을 수 있다.',
        '신청 데이터 기준 3일 이후 DB를 비신규 DB라고 칭한다.',
        '⑤ 신규 DB 지급 활동 중지: 멘토와 상의 없이 DB 받지 않은지 1주일이 넘고, 영업활동 하지 않은지 1주일이 넘어 (멘토가 주는 DB 체크리스트 기록이 1주일 동안 기록이 없는 경우) 활동 정지라고 판정 한다. 다시 재 활동 신청 시 멘토와 상의하여 신규 DB지급 서비스 무료 혹은 유료 결정하여 신규 DB를 받을 수 있다.',
        '',
        '제7조 (비밀유지 및 경업행위, 리크루팅 금지)',
        '① 비밀유지: "고객사"는 계약 기간 중 및 계약 종료 후 7년간 "회사"와 "멘토"의 영업 비밀, 교육 자료, 마케팅 기법 등 모든 정보에 대해 비밀을 유지해야 하며, 제3자에게 유출하거나 무단으로 사용해서는 안 된다.',
        '② 경업 금지: "고객사"는 계약 기간 동안 및 계약 종료 후 7년간 다음과 같은 행위를 할 수 없다.',
        '"회사" 및 "멘토"와 동일하거나 유사한 형태의 사업을 영위하거나 제3자를 통해 영위하는 행위.',
        '"멘토"가 제공한 DB를 활용하여 동일한 서비스를 제공하는 경쟁사 설립 및 운영.',
        '③ 리크루팅 금지: "고객사"는 계약 기간 중 및 종료 후 7년간 "회사" 또는 "멘토"의 의뢰인이나 관련자들을 대상으로 다음과 같은 리크루팅 활동을 할 수 없다.',
        '직원, 사업자, 판매원 등을 모집하거나 권유하는 행위.',
        '"회사"와 "멘토"의 관계자를 대상으로 한 상품 홍보, 영업 아이템 권유 등.',
        '④ 판매 및 구매 제한: "고객사"는 "회사"와 "멘토"의 서면 동의 없이 다음과 같은 행위를 할 수 없다.',
        '"회사" 및 "멘토"의 다른 의뢰인에게 제품을 판매하거나 해당 제품을 구매하는 행위.',
        '"회사"와 "멘토"의 다른 의뢰인 간 사적 거래나 상업적 관계를 맺는 행위.',
        '⑤ 비밀 모임 금지: "고객사"는 "회사" 및 "멘토"의 승인 없이 "회사"와 "멘토"의 다른 의뢰인들과 사적 모임을 만들거나 유지할 수 없다. 여기서 사적 모임이란 "회사"와 "멘토"에게 사전 보고되지 않은 온·오프라인 모임을 의미한다.',
        '',
        '제8조 (비용 지급 및 정산 절차)',
        '① 비용 지급: "고객사"는 제9조에 명시된 유료 서비스인 \'비즈니스 모델 설계 + 퍼널마케팅 + 코칭 6주 과정\'의 수강료로 750만 원을 계약 체결 시 선불로 1회 "회사"에 지급한다.',
        '결제 링크: http://leadz.kr/xWG',
        '\'멘토\'에게 본사로 연결된 카드 결제링크 지급 받는다.',
        '계좌이체는: 국민 531301-04-166504 마비즈스쿨 원격평생교육원 (전혜선)로 지급 받는다.',
        '② 수수료 정산: 신규 DB에 대한 수수료는 1개당 1만원 이다. 매월 15일에 "멘토"에게 지급한다.',
        '③ 정산 절차: "회사"는 매월 말까지 발생한 비용 내역을 정산하여 익월 15일까지 "고객사"에 통지하며, "고객사"는 해당 월 15일까지 비용을 "회사"와 "멘토"에게 지급해야 한다."고객사"가 회사에 기여한 매출도 15일에 정산을 "회사"에게 지급받는다.',
        '④ 추가 정산 규정: 필요 시 서면 합의를 통해 정산 주기나 비용을 변경할 수 있다.',
        '',
        '제9조 (제공 서비스 설명)',
        '【1. 유료 서비스: 비즈니스 모델 설계 + 퍼널마케팅 + 코칭 6주 과정】',
        '"고객사"가 지급하는 750만 원은 오직 아래의 6주 과정에 대한 수강료에만 해당한다.',
        '비즈니스 모델 설계 + 퍼널마케팅 + 코칭 6주',
        '시장 분석 & 아이템 선정 & 포지셔닝',
        '크루즈 예약 유도 퍼널 및 가치 사다리 설계',
        '잠재고객을 끌어모으는 제안과 카피라이팅',
        '퍼널 설계 페이지 제작 및 예약 자동화',
        '퍼널로 고객 유입시키는 방법',
        '데이터 기반 퍼널 개선 및 재구매 유도 방법 (CRM 설계)',
        '',
        '【2. 무상 프로모션 부가 서비스】',
        '아래의 부가 서비스는 상기 유료 서비스 결제 시 1년간 무상으로 제공되는 프로모션 혜택이며, 제11조의 환불 대상 및 기간 산정 기준에 포함되지 않는다.',
        '',
        '서비스명: 세일즈 지원 서비스',
        '서비스내용: 세일즈에 필요한 모든 종류의 세일즈 지원 교육 혜택을 말한다., 해당 서비스의 종류는 지속적으로 추가 및 개선 된다.',
        '운영 카페: 1% 카페 https://cafe.naver.com/funhanshop2',
        '\'스터디원\' 등급으로 필요한 교육을 온라인 상시 강의를 볼 수 있다.',
        '',
        '서비스명: 마케팅 지원 및 자문 서비스',
        'SNS 정기적 검토 및 개선사항 피드백',
        '마케팅 활동 및 기획에 대한 마케팅 전문가의 자문 서비스',
        '오픈 카톡방 24시간 소통 연락망 제공',
        '1% 카페 교육을 받는 정회원들 간의 커뮤니티 제공, 사업을 하며 만날 수 있는 모든 상황에 대해 소통할 수 있는 오픈 카톡방 제공',
        '"고객사"와 24시간 카톡방으로 소통을 원활하게 주고 받을 수 있도록 한다.',
        '',
        '서비스명: SNS 마케팅 교육 콘텐츠',
        '1. SNS 마케팅 기술 교육',
        '2. SNS 마케팅을 실전 세일즈에 활용할 수 있는 고객 심리활용 스킬 교육',
        '3. SNS 마케팅을 통해 아이템 혹은 사업에 대한 상담을 요청하는 고객을 만드는 방법에 대한 교육',
        '4. SNS 마케팅을 잘 이용하고 있는 다른 사업자들의 인스타그램 분석을 통한 세밀한 교육',
        '',
        '서비스명: SNS 올인원 마케팅 (카피라이팅, 전략기획) 12주 + AI 특강 + 코칭 3회',
        '마인드셋, 고객 페르소나, 채널 개설 및 세팅, 콘텐츠 캘린더 기획',
        '블로그 글쓰기 기법, 키워드 발굴 및 활용',
        '인스타그램 전략, 숏폼 콘텐츠 제작, 시선을 사로잡는 이미지 편집',
        '리서치 기술, 경험없이 콘텐츠 제작, AI 활용 콘텐츠 제작, AI 활용 콘텐츠 생성 법',
        '영상 콘텐츠 기획, 촬영 및 편집 기초',
        '효율적인 콘텐츠 재활용, 시간 절약 워크 플로우',
        '충성 고객 확보, 메시징 전략, 자동화 시스템 구축',
        '영향력 구축, 팬층 확보, 활발한 상호작용 유도 방법',
        '상위 노출 최적화, 수익화 연계',
        '고급 편집 기법, 브랜드 일관성 구축, 참여율 높이는 비주얼',
        '비즈니스 모델 설계, 디지털 상품 개발, 마케팅 자동화',
        '장기 전략, 지속가능한 콘텐츠 시스템, 미래 확장 계획',
        '',
        '서비스명: 아이템 제품 세일즈 교육 콘텐츠',
        '고객이 상담 받고 싶도록 만드는 세일즈 노하우 교육',
        '고객과의 미팅을 자연스럽게 잡을 수 있는 세일즈 노하우 교육',
      ],
    },
  ],
};

export default function AdminAffiliateContractsPage() {
  const [contracts, setContracts] = useState<AffiliateContract[]>([]);
  const [isLoading, setIsLoading] = useState(false);
  const [filters, setFilters] = useState<{
    status: 'all' | 'submitted' | 'approved' | 'rejected' | 'completed';
    search: string;
  }>({
    status: 'all', // 기본값: 전체 계약서 표시 (완료됨 상태도 승인 가능하도록)
    search: '',
  });
  const [searchInput, setSearchInput] = useState('');
  const [showSendContractModal, setShowSendContractModal] = useState(false);
  const [contractType, setContractType] = useState<'SALES_AGENT' | 'BRANCH_MANAGER' | 'CRUISE_STAFF' | 'PRIMARKETER'>('SALES_AGENT');
  const [profiles, setProfiles] = useState<AffiliateProfile[]>([]);
  const [selectedProfile, setSelectedProfile] = useState<AffiliateProfile | null>(null);
  const [contractLink, setContractLink] = useState<string | null>(null);
  const [loadingProfiles, setLoadingProfiles] = useState(false);
  const [showContractFormModal, setShowContractFormModal] = useState(false);
  const [contractForm, setContractForm] = useState({
    name: '',
    phone: '',
    email: '',
    residentIdFront: '',
    residentIdBack: '',
    address: '',
    bankName: '',
    bankAccount: '',
    bankAccountHolder: '',
    signatureUrl: '',
    signatureOriginalName: '',
    signatureFileId: '',
    consentPrivacy: false,
    consentNonCompete: false,
    consentDbUse: false,
    consentPenalty: false,
    consentRefund: false,
  });
  const [submittingContract, setSubmittingContract] = useState(false);
  const [uploadingSignature, setUploadingSignature] = useState(false);
  const [showSignatureModal, setShowSignatureModal] = useState(false);
  const [signaturePreview, setSignaturePreview] = useState('');
  const signatureCanvasRef = useRef<HTMLCanvasElement>(null);
  const signaturePadRef = useRef<SignaturePad | null>(null);
  const [showInviteMessageModal, setShowInviteMessageModal] = useState(false);
  const [inviteForm, setInviteForm] = useState({ name: '', phone: '' });
  const [inviteMessage, setInviteMessage] = useState('');
  const [generatingInvite, setGeneratingInvite] = useState(false);
  const [showContractTextModal, setShowContractTextModal] = useState(false);
  const [contractReadConfirmed, setContractReadConfirmed] = useState(false);
  const [selectedContract, setSelectedContract] = useState<AffiliateContract | null>(null);
  const [showContractDetailModal, setShowContractDetailModal] = useState(false);
  const [loadingContractDetail, setLoadingContractDetail] = useState(false);
  const [deletingContractId, setDeletingContractId] = useState<number | null>(null);
  const [sendingPdfContractId, setSendingPdfContractId] = useState<number | null>(null);
  const [showEducationContractModal, setShowEducationContractModal] = useState(false);
  const [educationContractType, setEducationContractType] = useState<'SALES_AGENT' | 'BRANCH_MANAGER' | 'CRUISE_STAFF' | 'PRIMARKETER'>('SALES_AGENT');
  // 계약서 열람 확인 추적 (계약서 ID Set)
  const [viewedContractIds, setViewedContractIds] = useState<Set<number>>(new Set());

  useEffect(() => {
    loadContracts();
  }, [filters]);

  const loadProfiles = async () => {
    try {
      setLoadingProfiles(true);
      const res = await fetch('/api/admin/affiliate/profiles?status=ACTIVE');
      const json = await res.json();
      if (!res.ok || !json.ok) {
        throw new Error(json.message || '프로필을 불러오지 못했습니다.');
      }
      setProfiles(json.profiles ?? []);
    } catch (error: any) {
      console.error('[AdminContracts] load profiles error', error);
      showError(error.message || '프로필 목록을 불러오는 중 오류가 발생했습니다.');
    } finally {
      setLoadingProfiles(false);
    }
  };

  const handleOpenSendContractModal = () => {
    setShowSendContractModal(true);
  };

  const dataUrlToFile = (dataUrl: string, defaultName: string) => {
    const parts = dataUrl.split(',');
    if (parts.length < 2) {
      throw new Error('잘못된 데이터 URL 형식입니다.');
    }
    const match = parts[0].match(/data:(.*?);base64/);
    const mimeType = match?.[1] || 'image/png';
    const binaryString = atob(parts[1]);
    const len = binaryString.length;
    const bytes = new Uint8Array(len);
    for (let i = 0; i < len; i += 1) {
      bytes[i] = binaryString.charCodeAt(i);
    }
    return new File([bytes], defaultName, { type: mimeType });
  };

  useEffect(() => {
    if (!showSignatureModal) {
      signaturePadRef.current?.off();
      signaturePadRef.current = null;
      return;
    }

    const canvas = signatureCanvasRef.current;
    if (!canvas) return;

    const resizeCanvas = () => {
      const ratio = window.devicePixelRatio || 1;
      const width = canvas.clientWidth;
      const height = canvas.clientHeight;
      canvas.width = width * ratio;
      canvas.height = height * ratio;
      const context = canvas.getContext('2d');
      if (context) {
        context.scale(ratio, ratio);
        context.fillStyle = '#ffffff';
        context.fillRect(0, 0, width, height);
      }
    };

    resizeCanvas();

    const pad = new SignaturePad(canvas, {
      backgroundColor: '#ffffff',
      penColor: '#2563eb',
      minWidth: 1.5,
      maxWidth: 3,
    });

    signaturePadRef.current = pad;

    window.addEventListener('resize', resizeCanvas);

    return () => {
      window.removeEventListener('resize', resizeCanvas);
      pad.off();
      signaturePadRef.current = null;
    };
  }, [showSignatureModal]);

  const uploadSignature = useCallback(async (file: File, options?: { previewDataUrl?: string }) => {
    setUploadingSignature(true);
    try {
      const formData = new FormData();
      formData.append('file', file);
      formData.append('fileName', file.name);

      const response = await fetch('/api/affiliate/contracts/upload?type=signature', {
        method: 'POST',
        body: formData,
      });

      const json = await response.json();
      if (!response.ok || !json?.ok) {
        throw new Error(json?.message || '파일 업로드에 실패했습니다.');
      }

      if (!json.url || !json.fileId) {
        throw new Error('업로드가 완료되었지만 파일 정보를 받지 못했습니다.');
      }

      const originalName = json.originalName || file.name;

      setContractForm((prev) => ({
        ...prev,
        signatureUrl: json.url,
        signatureOriginalName: originalName,
        signatureFileId: json.fileId,
      }));

      if (options?.previewDataUrl) {
        setSignaturePreview(options.previewDataUrl);
      }

      return true;
    } catch (error: any) {
      console.error('[AdminContracts] signature upload error', error);
      showError(error?.message || '파일 업로드 중 오류가 발생했습니다.');
      return false;
    } finally {
      setUploadingSignature(false);
    }
  }, []);

  const handleSignatureSave = useCallback(async () => {
    const pad = signaturePadRef.current;
    if (!pad) return;
    if (pad.isEmpty()) {
      showError('싸인을 먼저 입력해주세요.');
      return;
    }
    try {
      const dataUrl = pad.toDataURL('image/png');
      const fileName = `affiliate-signature-${Date.now()}.png`;
      const file = dataUrlToFile(dataUrl, fileName);
      const success = await uploadSignature(file, { previewDataUrl: dataUrl });
      if (success) {
        setShowSignatureModal(false);
        signaturePadRef.current?.clear();
      }
    } catch (error) {
      console.error('[AdminContracts] signature save error', error);
      showError('싸인 이미지를 처리하는 중 문제가 발생했습니다.');
    }
  }, [uploadSignature]);

  const handleSubmitContract = async (e: React.FormEvent) => {
    e.preventDefault();
    if (submittingContract) return;

    if (uploadingSignature) {
      showError('싸인 업로드가 완료될 때까지 기다려주세요.');
      return;
    }

    if (!contractForm.name.trim() || !contractForm.phone.trim() || !contractForm.residentIdFront.trim() || !contractForm.residentIdBack.trim() || !contractForm.address.trim()) {
      showError('필수 항목을 모두 입력해주세요.');
      return;
    }

    if (![contractForm.consentPrivacy, contractForm.consentNonCompete, contractForm.consentDbUse, contractForm.consentPenalty, contractForm.consentRefund].every(Boolean)) {
      showError('모든 필수 동의 항목에 체크해주세요.');
      return;
    }

    if (!contractForm.signatureUrl.trim() || !contractForm.signatureFileId.trim()) {
      showError('계약서에 싸인을 그린 후 반드시 저장해주세요.');
      return;
    }

    if (!contractReadConfirmed) {
      showError('계약서 전문을 확인하고 "확인했습니다"에 체크해주세요.');
      return;
    }

    try {
      setSubmittingContract(true);
      const response = await fetch('/api/affiliate/contracts', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          ...contractForm,
          invitedByProfileId: selectedProfile?.id ?? undefined,
        }),
      });

      const json = await response.json();
      if (!response.ok || !json?.ok) {
        throw new Error(json?.message || '서버 오류가 발생했습니다.');
      }

      showSuccess('계약서가 접수되었습니다.');
      setShowContractFormModal(false);
      setShowSendContractModal(false);
      loadContracts();
    } catch (error: any) {
      console.error('[AdminContracts] submit error', error);
      showError(error.message || '저장 중 오류가 발생했습니다.');
    } finally {
      setSubmittingContract(false);
    }
  };

  const loadContracts = async () => {
    try {
      setIsLoading(true);
      const params = new URLSearchParams();
      if (filters.status !== 'all') params.set('status', filters.status);
      if (filters.search.trim()) params.set('search', filters.search.trim());

      const res = await fetch(`/api/admin/affiliate/contracts?${params.toString()}`);
      const json = await res.json();
      if (!res.ok || !json.ok) {
        throw new Error(json.message || '계약 목록을 불러오지 못했습니다.');
      }
      setContracts(json.contracts ?? []);
    } catch (error: any) {
      console.error('[AdminContracts] load error', error);
      showError(error.message || '계약 목록을 불러오는 중 오류가 발생했습니다.');
    } finally {
      setIsLoading(false);
    }
  };

  const handleApprove = async (contractId: number) => {
    if (!confirm('이 계약을 승인하여 아이디와 비밀번호를 생성하시겠습니까?')) return;

    try {
      const res = await fetch(`/api/admin/affiliate/contracts/${contractId}/approve`, {
        method: 'POST',
        credentials: 'include',
      });
      const json = await res.json();
      if (!res.ok || !json.ok) {
        const errorMessage = json.message || json.error || '계약 승인에 실패했습니다.';
        console.error('[AdminContracts] Approve error details:', { status: res.status, json });
        throw new Error(errorMessage);
      }
      showSuccess('계약이 승인되었고 아이디와 비밀번호가 생성되었습니다.');
      loadContracts();
      // 어필리에이트 인력 페이지로 이동
      if (json.profileId) {
        window.location.href = '/admin/affiliate/profiles';
      }
    } catch (error: any) {
      console.error('[AdminContracts] approve error', error);
      showError(error.message || '계약 승인 중 오류가 발생했습니다.');
    }
  };

  const handleComplete = async (contractId: number) => {
    // 계약서 열람 확인 체크
    if (!viewedContractIds.has(contractId)) {
      showError('계약서를 완료하기 전에 반드시 계약서를 열어서 확인해주세요. 계약서 상세 보기 또는 PDF 보기를 통해 계약서를 확인할 수 있습니다.');
      return;
    }

    if (!confirm('이 계약서를 완료하여 PDF를 이메일로 전송하시겠습니까?')) return;

    try {
      const res = await fetch(`/api/admin/affiliate/contracts/${contractId}/complete`, {
        method: 'POST',
        credentials: 'include',
      });
      const json = await res.json();
      if (!res.ok || !json.ok) {
        throw new Error(json.message || '계약서 완료 처리에 실패했습니다.');
      }
      if (json.emailSent) {
        showSuccess('계약서가 완료되었고 이메일로 전송되었습니다.');
      } else {
        showSuccess('계약서가 완료되었으나 이메일 전송에 실패했습니다.');
      }
      
      // 모달 닫기
      setShowContractDetailModal(false);
      setSelectedContract(null);
      
      // 목록 새로고침
      loadContracts();
      
      // 완료 페이지로 리다이렉트 (새 창에서 열기)
      if (json.redirectUrl) {
        window.open(json.redirectUrl, '_blank');
      }
    } catch (error: any) {
      console.error('[AdminContracts] complete error', error);
      showError(error.message || '계약서 완료 처리 중 오류가 발생했습니다.');
    }
  };

  const handleReject = async (contractId: number) => {
    const reason = prompt('거부 사유를 입력하세요:');
    if (!reason) return;

    try {
      const res = await fetch(`/api/admin/affiliate/contracts/${contractId}/reject`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ reason }),
      });
      const json = await res.json();
      if (!res.ok || !json.ok) {
        throw new Error(json.message || '계약 거부에 실패했습니다.');
      }
      showSuccess('계약이 거부되었습니다.');
      loadContracts();
    } catch (error: any) {
      console.error('[AdminContracts] reject error', error);
      showError(error.message || '계약 거부 중 오류가 발생했습니다.');
    }
  };

  const handleViewDetail = async (contractId: number) => {
    try {
      setLoadingContractDetail(true);
      const res = await fetch(`/api/admin/affiliate/contracts/${contractId}`);
      const json = await res.json();
      if (!res.ok || !json.ok) {
        throw new Error(json.message || '계약서 정보를 불러오지 못했습니다.');
      }
      setSelectedContract(json.contract);
      setShowContractDetailModal(true);
      // 계약서 열람 확인 추가
      setViewedContractIds(prev => new Set(prev).add(contractId));
    } catch (error: any) {
      console.error('[AdminContracts] view detail error', error);
      showError(error.message || '계약서 정보를 불러오는 중 오류가 발생했습니다.');
    } finally {
      setLoadingContractDetail(false);
    }
  };

  const handleSendPDF = async (contractId: number) => {
    if (!confirm('계약서 PDF를 계약자 이메일 주소로 전송하시겠습니까? (본사 이메일은 참조로 추가됩니다)')) return;
    try {
      setSendingPdfContractId(contractId);
      const res = await fetch(`/api/admin/affiliate/contracts/${contractId}/send-pdf`, {
        method: 'POST',
      });
      const json = await res.json();
      if (!res.ok || !json.ok) {
        const errorMsg = json.message || json.error || 'PDF 전송에 실패했습니다.';
        throw new Error(errorMsg);
      }
      showSuccess('PDF가 성공적으로 전송되었습니다.');
      // PDF 보기를 통한 계약서 열람 확인 추가
      setViewedContractIds(prev => new Set(prev).add(contractId));
    } catch (error: any) {
      console.error('[AdminContracts] send PDF error', error);
      const errorMsg = error.message || 'PDF 전송 중 오류가 발생했습니다.';
      showError(errorMsg);
    } finally {
      setSendingPdfContractId(null);
    }
  };

  const handleDelete = async (contractId: number) => {
    if (!confirm('정말로 이 계약서를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) return;
    try {
      setDeletingContractId(contractId);
      const res = await fetch(`/api/admin/affiliate/contracts/${contractId}`, {
        method: 'DELETE',
      });
      const json = await res.json();
      if (!res.ok || !json.ok) {
        throw new Error(json.message || '삭제에 실패했습니다.');
      }
      showSuccess('계약서가 삭제되었습니다.');
      loadContracts();
    } catch (error: any) {
      console.error('[AdminContracts] delete error', error);
      showError(error.message || '삭제 중 오류가 발생했습니다.');
    } finally {
      setDeletingContractId(null);
    }
  };

  const buildInviteMessage = (name: string, phone: string, contractUrl: string) => {
    return [
      '[크루즈닷 어필리에이트 계약서 작성 안내]',
      '',
      `${name}님, 안녕하세요.`,
      '',
      '크루즈닷 어필리에이트 계약서 작성을 안내드립니다.',
      '아래 링크에서 계약서를 작성해주세요.',
      '',
      contractUrl,
      '',
      '※ 계약서 작성 시 필요 자료:',
      '- 신분증 사본 (앞면/뒷면)',
      '- 통장 사본',
      '- 계약서 전자 서명',
      '',
      '계약서 작성 완료 후 본사에서 검토하여 승인 절차를 진행합니다.',
      '',
      '문의사항이 있으시면 언제든지 연락주세요.',
      '',
      '감사합니다.',
      '크루즈닷 본사',
    ].join('\n');
  };

  const handleGenerateInviteMessage = async () => {
    if (!selectedProfile) {
      showError('판매원을 먼저 선택해주세요.');
      return;
    }

    if (!inviteForm.name.trim() || !inviteForm.phone.trim()) {
      showError('이름과 연락처를 모두 입력해주세요.');
      return;
    }

    try {
      setGeneratingInvite(true);
      
      // 계약서 작성 링크 생성
      let contractUrl = '';
      if (selectedProfile.user?.mallUserId) {
        const baseUrl = typeof window !== 'undefined' ? window.location.origin : '';
        contractUrl = `${baseUrl}/partner/${selectedProfile.user.mallUserId}/contract`;
      } else {
        // 판매몰 ID가 없으면 공개 계약서 페이지로
        const baseUrl = typeof window !== 'undefined' ? window.location.origin : '';
        contractUrl = `${baseUrl}/affiliate/contract`;
      }

      const message = buildInviteMessage(inviteForm.name, inviteForm.phone, contractUrl);
      setInviteMessage(message);

      // 클립보드에 복사
      try {
        await navigator.clipboard.writeText(message);
        showSuccess('초대 메시지가 생성되고 클립보드에 복사되었습니다.');
      } catch (clipboardError) {
        showSuccess('초대 메시지가 생성되었습니다. 아래 내용을 복사해 전송해주세요.');
      }
    } catch (error: any) {
      console.error('[AdminContracts] generate invite error', error);
      showError(error.message || '초대 메시지 생성 중 오류가 발생했습니다.');
    } finally {
      setGeneratingInvite(false);
    }
  };

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'approved':
        return 'bg-emerald-50 text-emerald-700';
      case 'rejected':
        return 'bg-red-50 text-red-700';
      case 'submitted':
        return 'bg-blue-50 text-blue-700';
      case 'completed':
        return 'bg-purple-50 text-purple-700';
      default:
        return 'bg-gray-50 text-gray-700';
    }
  };

  const getStatusLabel = (status: string) => {
    switch (status) {
      case 'approved':
        return '승인됨';
      case 'rejected':
        return '거부됨';
      case 'submitted':
        return '제출됨';
      case 'completed':
        return '완료됨';
      default:
        return status;
    }
  };

  const getStatusIcon = (status: string) => {
    switch (status) {
      case 'approved':
        return <FiCheckCircle className="text-base" />;
      case 'rejected':
        return <FiXCircle className="text-base" />;
      case 'submitted':
        return <FiClock className="text-base" />;
      default:
        return <FiFileText className="text-base" />;
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-b from-slate-50 via-white to-slate-100 pb-24">
      <div className="mx-auto flex w-full max-w-7xl flex-col gap-6 px-4 pt-10 md:px-6">
        {/* 헤더 */}
        <header className="rounded-3xl bg-gradient-to-r from-blue-600 via-indigo-600 to-purple-600 p-8 text-white shadow-xl">
          <div className="flex flex-col gap-6 md:flex-row md:items-center md:justify-between">
            <div className="space-y-2">
              <h1 className="text-3xl font-extrabold">어필리에이트 계약 관리</h1>
              <p className="text-sm text-white/80">
                파트너 계약 신청서를 검토하고 승인/거부할 수 있습니다.
              </p>
            </div>
            <div className="flex items-center gap-2">
              <button
                onClick={() => {
                  setContractType('SALES_AGENT');
                  handleOpenSendContractModal();
                }}
                className="inline-flex items-center gap-2 rounded-xl bg-white px-4 py-2 text-sm font-semibold text-blue-600 hover:bg-blue-50 shadow-md"
              >
                <FiSend className="text-base" />
                판매원 계약서 보내기
              </button>
              <button
                onClick={() => {
                  setContractType('BRANCH_MANAGER');
                  handleOpenSendContractModal();
                }}
                className="inline-flex items-center gap-2 rounded-xl bg-white px-4 py-2 text-sm font-semibold text-purple-600 hover:bg-purple-50 shadow-md"
              >
                <FiSend className="text-base" />
                대리점장 계약서 보내기
              </button>
              <button
                onClick={() => {
                  setContractType('CRUISE_STAFF');
                  handleOpenSendContractModal();
                }}
                className="inline-flex items-center gap-2 rounded-xl bg-white px-4 py-2 text-sm font-semibold text-green-600 hover:bg-green-50 shadow-md"
              >
                <FiSend className="text-base" />
                크루즈스탭 계약서 보내기
              </button>
              <button
                onClick={() => {
                  setContractType('PRIMARKETER');
                  handleOpenSendContractModal();
                }}
                className="inline-flex items-center gap-2 rounded-xl bg-white px-4 py-2 text-sm font-semibold text-orange-600 hover:bg-orange-50 shadow-md"
              >
                <FiSend className="text-base" />
                프리마케터 계약서 보내기
              </button>
              <button
                onClick={loadContracts}
                className="inline-flex items-center gap-2 rounded-xl bg-white/20 px-4 py-2 text-sm font-semibold text-white hover:bg-white/30"
              >
                <FiRefreshCw className="text-base" />
                새로고침
              </button>
            </div>
          </div>
        </header>

        {/* 필터 */}
        <section className="rounded-3xl bg-white p-6 shadow-lg">
          <div className="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
            <div className="flex flex-1 items-center gap-3">
              <div className="relative flex-1 max-w-md">
                <FiSearch className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" />
                <input
                  type="text"
                  value={searchInput}
                  onChange={(e) => setSearchInput(e.target.value)}
                  onKeyDown={(e) => {
                    if (e.key === 'Enter') {
                      setFilters((prev) => ({ ...prev, search: searchInput }));
                    }
                  }}
                  placeholder="이름, 전화번호, 이메일 검색..."
                  className="w-full rounded-xl border border-gray-300 py-2 pl-10 pr-4 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100"
                />
              </div>
              <select
                value={filters.status}
                onChange={(e) => setFilters((prev) => ({ ...prev, status: e.target.value as typeof prev.status }))}
                className="rounded-xl border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100"
              >
                {STATUS_OPTIONS.map((option) => (
                  <option key={option.value} value={option.value}>
                    {option.label}
                  </option>
                ))}
              </select>
            </div>
          </div>
        </section>

        {/* 계약 목록 */}
        <section className="rounded-3xl bg-white shadow-lg">
          <div className="overflow-x-auto">
            <table className="min-w-full divide-y divide-gray-200">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-4 py-3 text-left text-sm font-semibold text-gray-600">신청자 정보</th>
                  <th className="px-4 py-3 text-left text-sm font-semibold text-gray-600">초대한 사람</th>
                  <th className="px-4 py-3 text-left text-sm font-semibold text-gray-600">상태</th>
                  <th className="px-4 py-3 text-left text-sm font-semibold text-gray-600">제출일</th>
                  <th className="px-4 py-3 text-left text-sm font-semibold text-gray-600">검토일</th>
                  <th className="px-4 py-3 text-left text-sm font-semibold text-gray-600">재계약 갱신일</th>
                  <th className="px-4 py-3 text-left text-sm font-semibold text-gray-600">검토자</th>
                  <th className="px-4 py-3 text-left text-sm font-semibold text-gray-600">액션</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-gray-200">
                {isLoading && (
                  <tr>
                    <td colSpan={8} className="px-4 py-6 text-center text-sm text-gray-500">
                      계약 목록을 불러오는 중입니다...
                    </td>
                  </tr>
                )}
                {!isLoading && contracts.length === 0 && (
                  <tr>
                    <td colSpan={8} className="px-4 py-10 text-center text-sm text-gray-500">
                      계약 신청 내역이 없습니다.
                    </td>
                  </tr>
                )}
                {!isLoading &&
                  contracts.map((contract) => (
                    <tr key={contract.id} className="hover:bg-blue-50/40">
                      <td className="px-4 py-4">
                        <div className="text-sm font-semibold text-gray-900">{contract.name}</div>
                        <div className="text-xs text-gray-500">{contract.phone}</div>
                        {contract.email && <div className="text-xs text-gray-500">{contract.email}</div>}
                        {contract.user?.mallUserId && (
                          <div className="mt-1 space-y-1">
                            <div className="text-xs font-mono text-blue-600">
                              파트너 ID: {contract.user.mallUserId}
                            </div>
                            {contract.metadata?.partnerId && (
                              <div className="text-xs font-mono text-purple-600">
                                생성된 ID: {contract.metadata.partnerId}
                              </div>
                            )}
                            {contract.user && contract.status === 'approved' && (
                              <div className="text-xs font-mono text-green-600">
                                비밀번호: {contract.user.password || '1101'}
                              </div>
                            )}
                          </div>
                        )}
                      </td>
                      <td className="px-4 py-4">
                        {(() => {
                          // 먼저 AffiliateProfile이 있는지 확인 (초대자가 있는 경우)
                          // 멘토 정보 표시
                          if (contract.AffiliateProfile) {
                            const mentorType = contract.AffiliateProfile.type;
                            // 프로필 수정에서 입력한 displayName을 우선 사용
                            const mentorName = contract.AffiliateProfile.displayName || contract.AffiliateProfile.nickname || contract.AffiliateProfile.user?.name || '이름 없음';
                            
                            if (mentorType === 'BRANCH_MANAGER') {
                              return (
                                <div className="space-y-1">
                                  <div className="flex items-center gap-2">
                                    <span className="inline-flex items-center gap-1 rounded-full bg-blue-100 px-2 py-1 text-xs font-semibold text-blue-700">
                                      대리점장
                                    </span>
                                    <span className="text-sm font-semibold text-gray-900">{mentorName}</span>
                                  </div>
                                  {contract.AffiliateProfile.affiliateCode && (
                                    <div className="text-xs font-mono text-blue-600">
                                      {contract.AffiliateProfile.affiliateCode}
                                    </div>
                                  )}
                                  {contract.AffiliateProfile.branchLabel && (
                                    <div className="text-xs text-gray-500">
                                      {contract.AffiliateProfile.branchLabel}
                                    </div>
                                  )}
                                </div>
                              );
                            } else if (mentorType === 'HQ') {
                              return (
                                <div className="flex items-center gap-2">
                                  <span className="inline-flex items-center gap-1 rounded-full bg-purple-100 px-2 py-1 text-xs font-semibold text-purple-700">
                                    본사
                                  </span>
                                  <span className="text-sm font-semibold text-gray-900">{mentorName}</span>
                                </div>
                              );
                            } else {
                              // 판매원인 경우 소속 대리점장 정보도 표시
                              return (
                                <div className="space-y-1">
                                  <div className="flex items-center gap-2">
                                    <span className="inline-flex items-center gap-1 rounded-full bg-green-100 px-2 py-1 text-xs font-semibold text-green-700">
                                      판매원
                                    </span>
                                    <span className="text-sm font-semibold text-gray-900">{mentorName}</span>
                                  </div>
                                  {contract.AffiliateProfile.affiliateCode && (
                                    <div className="text-xs font-mono text-green-600">
                                      {contract.AffiliateProfile.affiliateCode}
                                    </div>
                                  )}
                                  {contract.managerInfo && (
                                    <div className="text-xs text-gray-600 mt-1 pl-1 border-l-2 border-blue-200">
                                      <span className="text-gray-500">소속 대리점장: </span>
                                      <span className="font-semibold text-blue-700">
                                        {contract.managerInfo.displayName || contract.managerInfo.nickname || '이름 없음'}
                                      </span>
                                      {contract.managerInfo.affiliateCode && (
                                        <span className="text-blue-600 font-mono ml-1">
                                          ({contract.managerInfo.affiliateCode})
                                        </span>
                                      )}
                                      {contract.managerInfo.branchLabel && (
                                        <span className="text-gray-500 ml-1">
                                          - {contract.managerInfo.branchLabel}
                                        </span>
                                      )}
                                    </div>
                                  )}
                                </div>
                              );
                            }
                          }
                          
                          // AffiliateProfile이 없으면 본사로 표시
                          return (
                            <div className="flex items-center gap-2">
                              <span className="inline-flex items-center gap-1 rounded-full bg-purple-100 px-2 py-1 text-xs font-semibold text-purple-700">
                                본사
                              </span>
                              <span className="text-sm text-gray-400">직접 신청</span>
                            </div>
                          );
                        })()}
                      </td>
                      <td className="px-4 py-4">
                        <div className="space-y-1">
                          <span
                            className={`inline-flex items-center gap-1 rounded-full px-3 py-1 text-xs font-semibold ${getStatusColor(contract.status)}`}
                          >
                            {getStatusIcon(contract.status)}
                            {getStatusLabel(contract.status)}
                          </span>
                          {contract.status === 'terminated' && (() => {
                            const metadata = contract.metadata || {};
                            const terminatedAt = metadata.terminatedAt ? new Date(metadata.terminatedAt) : null;
                            const dbRecovered = metadata.dbRecovered || false;
                            const dbRecoveredAt = metadata.dbRecoveredAt ? new Date(metadata.dbRecoveredAt) : null;
                            
                            if (terminatedAt) {
                              const now = new Date();
                              const contractType = contract.AffiliateProfile?.type;
                              const daysSinceTermination = Math.floor((now.getTime() - terminatedAt.getTime()) / (1000 * 60 * 60 * 24));
                              
                              // 판매원은 1일, 대리점장은 즉시
                              const recoveryDays = contractType === 'BRANCH_MANAGER' ? 0 : 1;
                              const daysUntilRecovery = Math.max(0, recoveryDays - daysSinceTermination);
                              
                              return (
                                <div className="text-xs space-y-0.5">
                                  <div className="text-gray-600">
                                    해지일: {terminatedAt.toLocaleDateString('ko-KR')}
                                  </div>
                                  {dbRecovered ? (
                                    <div className="text-green-600 font-semibold">
                                      ✓ DB 회수 완료 ({dbRecoveredAt?.toLocaleDateString('ko-KR')})
                                    </div>
                                  ) : (
                                    <div className="space-y-1">
                                      {(() => {
                                        const retryCount = metadata.retryCount || 0;
                                        const maxRetries = 3;
                                        const retryErrors = metadata.retryErrors || [];
                                        const lastRetryAt = metadata.lastRetryAt ? new Date(metadata.lastRetryAt) : null;
                                        
                                        if (retryCount >= maxRetries) {
                                          return (
                                            <div className="text-red-600 font-semibold">
                                              ⚠️ DB 회수 실패 (재시도 {retryCount}회 실패)
                                            </div>
                                          );
                                        }
                                        
                                        if (retryCount > 0) {
                                          const backoffMinutes = Math.pow(2, retryCount - 1);
                                          const nextRetryTime = lastRetryAt ? new Date(lastRetryAt.getTime() + backoffMinutes * 60 * 1000) : null;
                                          const now = new Date();
                                          const minutesUntilRetry = nextRetryTime && nextRetryTime > now 
                                            ? Math.ceil((nextRetryTime.getTime() - now.getTime()) / (1000 * 60))
                                            : 0;
                                          
                                          return (
                                            <div className="text-orange-600">
                                              재시도 중 ({retryCount}/{maxRetries})
                                              {minutesUntilRetry > 0 && ` - ${minutesUntilRetry}분 후 재시도`}
                                            </div>
                                          );
                                        }
                                        
                                        return (
                                          <div className={daysUntilRecovery > 0 ? 'text-yellow-600' : 'text-red-600'}>
                                            {contractType === 'BRANCH_MANAGER' 
                                              ? 'DB 회수 대기 중 (즉시 처리 예정)'
                                              : daysUntilRecovery > 0 
                                                ? `DB 회수 예정: ${daysUntilRecovery}일 후`
                                                : 'DB 회수 대기 중 (1일 경과)'}
                                          </div>
                                        );
                                      })()}
                                    </div>
                                  )}
                                </div>
                              );
                            }
                            return null;
                          })()}
                        </div>
                      </td>
                      <td className="px-4 py-4 text-sm text-gray-600">
                        {contract.submittedAt
                          ? new Date(contract.submittedAt).toLocaleDateString('ko-KR')
                          : contract.createdAt
                            ? new Date(contract.createdAt).toLocaleDateString('ko-KR')
                            : '-'}
                      </td>
                      <td className="px-4 py-4 text-sm text-gray-600">
                        {contract.reviewedAt ? new Date(contract.reviewedAt).toLocaleDateString('ko-KR') : '-'}
                      </td>
                      <td className="px-4 py-4 text-sm text-gray-600">
                        {(() => {
                          const metadata = contract.metadata || {};
                          const renewalDate = metadata.renewalDate ? new Date(metadata.renewalDate) : null;
                          const renewalRequestStatus = metadata.renewalRequestStatus || null;
                          
                          // 재계약 갱신일 계산
                          let calculatedRenewalDate = renewalDate;
                          if (!calculatedRenewalDate && contract.reviewedAt && (contract.status === 'approved' || contract.status === 'completed')) {
                            calculatedRenewalDate = new Date(contract.reviewedAt);
                            calculatedRenewalDate.setFullYear(calculatedRenewalDate.getFullYear() + 1);
                          }
                          
                          // D-day 계산
                          const calculateDaysRemaining = (targetDate: Date | null) => {
                            if (!targetDate) return null;
                            const today = new Date();
                            today.setHours(0, 0, 0, 0);
                            const target = new Date(targetDate);
                            target.setHours(0, 0, 0, 0);
                            const diffTime = target.getTime() - today.getTime();
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                            return diffDays;
                          };
                          
                          const daysRemaining = calculatedRenewalDate ? calculateDaysRemaining(calculatedRenewalDate) : null;
                          
                          return (
                            <div className="space-y-1">
                              {calculatedRenewalDate ? (
                                <>
                                  <div className="text-gray-900">
                                    {calculatedRenewalDate.toLocaleDateString('ko-KR')}
                                  </div>
                                  {daysRemaining !== null && (
                                    <div className={`text-xs font-semibold ${
                                      daysRemaining < 0 
                                        ? 'text-red-600' 
                                        : daysRemaining <= 30 
                                        ? 'text-yellow-600'
                                        : 'text-blue-600'
                                    }`}>
                                      {daysRemaining < 0 ? `D+${Math.abs(daysRemaining)}` : `D-${daysRemaining}`}
                                    </div>
                                  )}
                                </>
                              ) : (
                                <span className="text-gray-400">-</span>
                              )}
                              {renewalRequestStatus === 'PENDING' && (
                                <div className="mt-1">
                                  <span className="inline-flex items-center gap-1 rounded-full bg-yellow-100 px-2 py-0.5 text-xs font-semibold text-yellow-700">
                                    재계약 신청
                                  </span>
                                </div>
                              )}
                            </div>
                          );
                        })()}
                      </td>
                      <td className="px-4 py-4 text-sm text-gray-600">
                        {contract.reviewer?.name || '-'}
                      </td>
                      <td className="px-4 py-4">
                        <div className="flex items-center gap-2">
                          <button
                            onClick={() => handleViewDetail(contract.id)}
                            disabled={loadingContractDetail}
                            className="inline-flex items-center gap-1 rounded-lg border border-gray-300 bg-white px-2 py-1 text-xs font-semibold text-gray-700 hover:bg-gray-50 disabled:opacity-50"
                          >
                            <FiEye className="text-xs" />
                            상세
                          </button>
                          {contract.user?.mallUserId && (
                            <a
                              href={`/partner/${contract.user.mallUserId}/dashboard`}
                              target="_blank"
                              rel="noopener noreferrer"
                              className="inline-flex items-center gap-1 rounded-lg border border-blue-200 bg-blue-50 px-2 py-1 text-xs font-semibold text-blue-700 hover:bg-blue-100"
                            >
                              대시보드
                              <FiExternalLink className="text-xs" />
                            </a>
                          )}
                          {contract.status === 'submitted' && (
                            <>
                              <button
                                onClick={() => handleComplete(contract.id)}
                                className="inline-flex items-center gap-1 rounded-lg bg-blue-600 px-3 py-1 text-xs font-semibold text-white hover:bg-blue-700"
                                title="계약서 완료 승인 (PDF 전송)"
                              >
                                <FiFileText className="text-xs" />
                                완료 승인
                              </button>
                              <button
                                onClick={() => handleApprove(contract.id)}
                                className="inline-flex items-center gap-1 rounded-lg bg-emerald-600 px-3 py-1 text-xs font-semibold text-white hover:bg-emerald-700"
                                title="아이디 생성 승인"
                              >
                                <FiCheckCircle className="text-xs" />
                                아이디 생성
                              </button>
                              <button
                                onClick={() => handleReject(contract.id)}
                                className="inline-flex items-center gap-1 rounded-lg bg-red-600 px-3 py-1 text-xs font-semibold text-white hover:bg-red-700"
                              >
                                <FiXCircle className="text-xs" />
                                거부
                              </button>
                            </>
                          )}
                          {contract.status === 'completed' && (
                            <button
                              onClick={() => handleApprove(contract.id)}
                              className="inline-flex items-center gap-1 rounded-lg bg-emerald-600 px-3 py-1 text-xs font-semibold text-white hover:bg-emerald-700"
                              title="아이디 생성 승인"
                            >
                              <FiCheckCircle className="text-xs" />
                              아이디 생성
                            </button>
                          )}
                          {(() => {
                            const metadata = contract.metadata || {};
                            const renewalRequestStatus = metadata.renewalRequestStatus;
                            
                            if (renewalRequestStatus === 'PENDING') {
                              return (
                                <>
                                  <button
                                    onClick={async () => {
                                      if (!confirm('재계약을 승인하시겠습니까? (1년 갱신)')) return;
                                      try {
                                        const res = await fetch(`/api/admin/affiliate/contracts/${contract.id}/renewal`, {
                                          method: 'POST',
                                          headers: { 'Content-Type': 'application/json' },
                                          body: JSON.stringify({ action: 'approve' }),
                                        });
                                        const json = await res.json();
                                        if (!res.ok || !json.ok) {
                                          throw new Error(json.message || '재계약 승인에 실패했습니다.');
                                        }
                                        showSuccess('재계약이 승인되었습니다.');
                                        loadContracts();
                                      } catch (error: any) {
                                        console.error('[AdminContracts] renewal approve error', error);
                                        showError(error.message || '재계약 승인 중 오류가 발생했습니다.');
                                      }
                                    }}
                                    className="inline-flex items-center gap-1 rounded-lg bg-green-600 px-3 py-1 text-xs font-semibold text-white hover:bg-green-700"
                                  >
                                    <FiCheckCircle className="text-xs" />
                                    재계약 승인
                                  </button>
                                  <button
                                    onClick={async () => {
                                      if (!confirm('재계약을 거부하시겠습니까? (계약 해지)')) return;
                                      try {
                                        const res = await fetch(`/api/admin/affiliate/contracts/${contract.id}/renewal`, {
                                          method: 'POST',
                                          headers: { 'Content-Type': 'application/json' },
                                          body: JSON.stringify({ action: 'reject' }),
                                        });
                                        const json = await res.json();
                                        if (!res.ok || !json.ok) {
                                          throw new Error(json.message || '재계약 거부에 실패했습니다.');
                                        }
                                        showSuccess('재계약이 거부되었고 계약이 해지되었습니다.');
                                        loadContracts();
                                      } catch (error: any) {
                                        console.error('[AdminContracts] renewal reject error', error);
                                        showError(error.message || '재계약 거부 중 오류가 발생했습니다.');
                                      }
                                    }}
                                    className="inline-flex items-center gap-1 rounded-lg bg-red-600 px-3 py-1 text-xs font-semibold text-white hover:bg-red-700"
                                  >
                                    <FiXCircle className="text-xs" />
                                    재계약 불가
                                  </button>
                                </>
                              );
                            }
                            return null;
                          })()}
                          {/* 계약 해지 버튼 - approved/completed 상태에서만 표시 */}
                          {(contract.status === 'approved' || contract.status === 'completed') && (
                            <button
                              onClick={async () => {
                                const reason = prompt('계약 해지 사유를 입력해주세요:');
                                if (!reason) return;
                                
                                if (!confirm(`정말로 이 계약을 해지하시겠습니까?\n\n사유: ${reason}\n\n해지 후:\n- 대리점장: DB가 즉시 본사로 회수됩니다\n- 판매원: 1일 후 DB가 대리점장으로 회수됩니다`)) return;
                                
                                try {
                                  const res = await fetch(`/api/admin/affiliate/contracts/${contract.id}/terminate`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ reason }),
                                  });
                                  const json = await res.json();
                                  if (!res.ok || !json.ok) {
                                    throw new Error(json.message || '계약 해지에 실패했습니다.');
                                  }
                                  showSuccess(json.message || '계약이 해지되었습니다.');
                                  loadContracts();
                                } catch (error: any) {
                                  console.error('[AdminContracts] terminate error', error);
                                  showError(error.message || '계약 해지 중 오류가 발생했습니다.');
                                }
                              }}
                              className="inline-flex items-center gap-1 rounded-lg bg-red-600 px-3 py-1 text-xs font-semibold text-white hover:bg-red-700"
                              title="계약 위반 등으로 즉시 계약 해지"
                            >
                              <FiXCircle className="text-xs" />
                              계약 해지
                            </button>
                          )}
                          {/* DB 회수 재시도 버튼 - 해지된 계약서 중 DB 회수 실패한 경우 */}
                          {contract.status === 'terminated' && (() => {
                            const metadata = contract.metadata || {};
                            const dbRecovered = metadata.dbRecovered || false;
                            const retryCount = metadata.retryCount || 0;
                            const maxRetries = 3;
                            
                            if (!dbRecovered && retryCount >= maxRetries) {
                              return (
                                <button
                                  onClick={async () => {
                                    if (!confirm('DB 회수 재시도를 하시겠습니까?')) return;
                                    
                                    try {
                                      const res = await fetch(`/api/admin/affiliate/contracts/${contract.id}/retry-recovery`, {
                                        method: 'POST',
                                        credentials: 'include',
                                      });
                                      const json = await res.json();
                                      if (!res.ok || !json.ok) {
                                        throw new Error(json.message || 'DB 회수 재시도에 실패했습니다.');
                                      }
                                      showSuccess('DB 회수 재시도가 완료되었습니다.');
                                      loadContracts();
                                    } catch (error: any) {
                                      console.error('[AdminContracts] retry recovery error', error);
                                      showError(error.message || 'DB 회수 재시도 중 오류가 발생했습니다.');
                                    }
                                  }}
                                  className="inline-flex items-center gap-1 rounded-lg bg-orange-600 px-3 py-1 text-xs font-semibold text-white hover:bg-orange-700"
                                  title="DB 회수 실패 시 수동 재시도"
                                >
                                  <FiRefreshCw className="text-xs" />
                                  DB 회수 재시도
                                </button>
                              );
                            }
                            return null;
                          })()}
                          <button
                            onClick={() => handleDelete(contract.id)}
                            disabled={deletingContractId === contract.id}
                            className="inline-flex items-center gap-1 rounded-lg border border-red-300 bg-red-50 px-2 py-1 text-xs font-semibold text-red-700 hover:bg-red-100 disabled:opacity-50"
                          >
                            <FiTrash2 className="text-xs" />
                            {deletingContractId === contract.id ? '삭제 중...' : '삭제'}
                          </button>
                        </div>
                      </td>
                    </tr>
                  ))}
              </tbody>
            </table>
          </div>
        </section>
      </div>

      {/* 계약서 보내기 모달 */}
      <ContractInviteModal
        isOpen={showSendContractModal}
        onClose={() => setShowSendContractModal(false)}
        contractType={contractType}
        onSuccess={() => {
          setShowSendContractModal(false);
          loadContracts();
        }}
      />

      {/* 계약서 작성 폼 모달 */}
      {showContractFormModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div className="sticky top-0 bg-white border-b border-gray-200 p-6 flex items-center justify-between rounded-t-2xl">
              <h2 className="text-2xl font-bold text-gray-900">계약서 작성</h2>
              <button
                onClick={() => setShowContractFormModal(false)}
                className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
              >
                <FiX className="text-xl text-gray-600" />
              </button>
            </div>

            <form onSubmit={handleSubmitContract} className="p-6 space-y-6">
              {/* 계약서 전문 확인 */}
              <section className="rounded-xl bg-gray-50 p-4">
                <h3 className="text-lg font-bold text-gray-900 mb-4">계약서 전문 확인</h3>
                <div className="space-y-3">
                  <div className="space-y-2">
                    <button
                      type="button"
                      onClick={() => {
                        setShowContractTextModal(true);
                        // 계약서 열람 확인 추가 (계약서 작성 폼에서는 계약서 ID가 없으므로 상세 모달에서만 추가)
                      }}
                      className="w-full inline-flex items-center justify-center gap-2 rounded-lg border border-blue-200 bg-blue-50 px-4 py-2 text-sm font-semibold text-blue-700 hover:bg-blue-100"
                    >
                      <FiFileText /> 크루즈닷 어필리에이트 계약서 전문 보기
                    </button>
                    <button
                      type="button"
                      onClick={() => {
                        setEducationContractType(contractType);
                        setShowEducationContractModal(true);
                      }}
                      className="w-full inline-flex items-center justify-center gap-2 rounded-lg border border-green-200 bg-green-50 px-4 py-2 text-sm font-semibold text-green-700 hover:bg-green-100"
                    >
                      <FiFileText /> 교육계약서 전문 보기
                    </button>
                  </div>
                  <label className="flex items-start gap-3 cursor-pointer">
                    <input
                      type="checkbox"
                      checked={contractReadConfirmed}
                      onChange={(e) => setContractReadConfirmed(e.target.checked)}
                      className="mt-1 h-4 w-4"
                      required
                    />
                    <span className="text-sm text-gray-700">
                      <span className="font-semibold">계약서 전문을 확인했습니다.</span>
                      <br />
                      <span className="text-xs text-gray-500">계약서 전문을 읽고 모든 내용을 이해했으며 동의합니다.</span>
                    </span>
                  </label>
                </div>
              </section>

              {/* 기본 정보 */}
              <section className="rounded-xl bg-gray-50 p-4">
                <h3 className="text-lg font-bold text-gray-900 mb-4">기본 정보</h3>
                <div className="grid gap-4 md:grid-cols-2">
                  <label className="flex flex-col gap-1 text-sm text-gray-700">
                    <span className="font-semibold">성명 *</span>
                    <input
                      value={contractForm.name}
                      onChange={(e) => setContractForm((prev) => ({ ...prev, name: e.target.value }))}
                      placeholder="예: 홍길동"
                      className="rounded-lg border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100"
                      required
                    />
                  </label>
                  <label className="flex flex-col gap-1 text-sm text-gray-700">
                    <span className="font-semibold">연락처 *</span>
                    <input
                      value={contractForm.phone}
                      onChange={(e) => setContractForm((prev) => ({ ...prev, phone: e.target.value }))}
                      placeholder="010-0000-0000"
                      className="rounded-lg border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100"
                      required
                    />
                  </label>
                  <label className="flex flex-col gap-1 text-sm text-gray-700">
                    <span className="font-semibold">이메일</span>
                    <input
                      value={contractForm.email}
                      onChange={(e) => setContractForm((prev) => ({ ...prev, email: e.target.value }))}
                      placeholder="example@cruisedot.com"
                      type="email"
                      className="rounded-lg border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100"
                    />
                  </label>
                  <div className="grid grid-cols-5 gap-2">
                    <label className="col-span-2 flex flex-col gap-1 text-sm text-gray-700">
                      <span className="font-semibold">주민등록번호 앞 6자리 *</span>
                      <input
                        value={contractForm.residentIdFront}
                        onChange={(e) => setContractForm((prev) => ({ ...prev, residentIdFront: e.target.value.replace(/[^0-9]/g, '').slice(0, 6) }))}
                        placeholder="예: 900101"
                        className="rounded-lg border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100"
                        required
                      />
                    </label>
                    <label className="col-span-3 flex flex-col gap-1 text-sm text-gray-700">
                      <span className="font-semibold">주민등록번호 뒤 7자리 *</span>
                      <input
                        value={contractForm.residentIdBack}
                        onChange={(e) => setContractForm((prev) => ({ ...prev, residentIdBack: e.target.value.replace(/[^0-9]/g, '').slice(0, 7) }))}
                        placeholder="예: 1234567"
                        className="rounded-lg border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100"
                        required
                      />
                    </label>
                  </div>
                  <label className="md:col-span-2 flex flex-col gap-1 text-sm text-gray-700">
                    <span className="font-semibold">주소 *</span>
                    <textarea
                      value={contractForm.address}
                      onChange={(e) => setContractForm((prev) => ({ ...prev, address: e.target.value }))}
                      rows={2}
                      placeholder="도로명 주소를 입력해주세요"
                      className="rounded-lg border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100"
                      required
                    />
                  </label>
                </div>
              </section>

              {/* 정산 계좌 정보 */}
              <section className="rounded-xl bg-gray-50 p-4">
                <h3 className="text-lg font-bold text-gray-900 mb-4">정산 계좌 정보</h3>
                <div className="grid gap-4 md:grid-cols-3">
                  <label className="flex flex-col gap-1 text-sm text-gray-700">
                    <span className="font-semibold">은행명</span>
                    <input
                      value={contractForm.bankName}
                      onChange={(e) => setContractForm((prev) => ({ ...prev, bankName: e.target.value }))}
                      placeholder="예: 국민은행"
                      className="rounded-lg border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100"
                    />
                  </label>
                  <label className="flex flex-col gap-1 text-sm text-gray-700">
                    <span className="font-semibold">계좌번호</span>
                    <input
                      value={contractForm.bankAccount}
                      onChange={(e) => setContractForm((prev) => ({ ...prev, bankAccount: e.target.value }))}
                      placeholder="예: 123456-78-901234"
                      className="rounded-lg border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100"
                    />
                  </label>
                  <label className="flex flex-col gap-1 text-sm text-gray-700">
                    <span className="font-semibold">예금주</span>
                    <input
                      value={contractForm.bankAccountHolder}
                      onChange={(e) => setContractForm((prev) => ({ ...prev, bankAccountHolder: e.target.value }))}
                      placeholder="예: 홍길동"
                      className="rounded-lg border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100"
                    />
                  </label>
                </div>
              </section>

              {/* 계약서 싸인 */}
              <section className="rounded-xl bg-gray-50 p-4">
                <h3 className="text-lg font-bold text-gray-900 mb-4">계약서 싸인</h3>
                <div className="space-y-4 text-sm text-gray-700">
                  <div className="flex flex-wrap items-center gap-3">
                    <button
                      type="button"
                      onClick={() => setShowSignatureModal(true)}
                      disabled={uploadingSignature}
                      className="rounded-lg border border-blue-200 bg-blue-50 px-4 py-2 text-sm font-semibold text-blue-700 hover:bg-blue-100 disabled:opacity-60"
                    >
                      {uploadingSignature ? '저장 중...' : '싸인 그리기'}
                    </button>
                    {contractForm.signatureUrl && contractForm.signatureFileId && (
                      <>
                        <button
                          type="button"
                          onClick={() => {
                            setContractForm((prev) => ({ ...prev, signatureUrl: '', signatureOriginalName: '', signatureFileId: '' }));
                            setSignaturePreview('');
                          }}
                          className="rounded-lg border border-gray-300 px-3 py-2 text-xs font-semibold text-gray-600 hover:bg-gray-100"
                        >
                          싸인 초기화
                        </button>
                        <span className="inline-flex items-center gap-2 rounded-full bg-green-50 px-3 py-1 text-xs font-semibold text-green-700">
                          <FiCheckCircle /> {contractForm.signatureOriginalName || '싸인 저장됨'}
                        </span>
                      </>
                    )}
                  </div>

                  {signaturePreview && contractForm.signatureUrl && (
                    <div className="rounded-lg border-2 border-green-200 bg-green-50/30 p-4">
                      <p className="mb-2 text-xs font-semibold text-green-800">저장된 싸인 미리보기:</p>
                      <div className="rounded-lg bg-white p-3 shadow-sm">
                        <img src={signaturePreview} alt="서명 미리보기" className="h-32 w-auto" />
                      </div>
                    </div>
                  )}
                </div>
              </section>

              {/* 필수 동의 */}
              <section className="rounded-xl bg-gray-50 p-4">
                <h3 className="text-lg font-bold text-gray-900 mb-4">필수 동의</h3>
                <div className="space-y-3 text-sm text-gray-700">
                  <label className="flex items-start gap-3">
                    <input
                      type="checkbox"
                      checked={contractForm.consentPrivacy}
                      onChange={(e) => setContractForm((prev) => ({ ...prev, consentPrivacy: e.target.checked }))}
                      className="mt-1 h-4 w-4"
                      required
                    />
                    <span>
                      <span className="font-semibold">개인정보 및 고객 DB 사용 제한에 동의합니다.</span>
                    </span>
                  </label>
                  <label className="flex items-start gap-3">
                    <input
                      type="checkbox"
                      checked={contractForm.consentNonCompete}
                      onChange={(e) => setContractForm((prev) => ({ ...prev, consentNonCompete: e.target.checked }))}
                      className="mt-1 h-4 w-4"
                      required
                    />
                    <span>
                      <span className="font-semibold">경업 및 리크루팅 금지 조항에 동의합니다.</span>
                    </span>
                  </label>
                  <label className="flex items-start gap-3">
                    <input
                      type="checkbox"
                      checked={contractForm.consentDbUse}
                      onChange={(e) => setContractForm((prev) => ({ ...prev, consentDbUse: e.target.checked }))}
                      className="mt-1 h-4 w-4"
                      required
                    />
                    <span>
                      <span className="font-semibold">고객 DB 보안 및 반환 의무를 준수합니다.</span>
                    </span>
                  </label>
                  <label className="flex items-start gap-3">
                    <input
                      type="checkbox"
                      checked={contractForm.consentPenalty}
                      onChange={(e) => setContractForm((prev) => ({ ...prev, consentPenalty: e.target.checked }))}
                      className="mt-1 h-4 w-4"
                      required
                    />
                    <span>
                      <span className="font-semibold">위반 시 손해배상 및 위약벌 조항을 이해하고 동의합니다.</span>
                    </span>
                  </label>
                  <label className="flex items-start gap-3">
                    <input
                      type="checkbox"
                      checked={contractForm.consentRefund}
                      onChange={(e) => setContractForm((prev) => ({ ...prev, consentRefund: e.target.checked }))}
                      className="mt-1 h-4 w-4"
                      required
                    />
                    <span>
                      <span className="font-semibold">
                        {contractType === 'SALES_AGENT' && '환불 조항(제11조)을 확인하고 동의합니다. 결제 금액(330만 원)에서 세팅비(50만 원)를 차감한 잔액(280만 원) 기준으로 환불됩니다.'}
                        {contractType === 'CRUISE_STAFF' && '환불 조항(제11조)을 확인하고 동의합니다. 결제 금액(540만 원)에서 세팅비(50만 원)를 차감한 잔액(490만 원) 기준으로 환불됩니다.'}
                        {contractType === 'PRIMARKETER' && '환불 조항(제11조)을 확인하고 동의합니다. 결제 금액(100만 원)에서 세팅비(50만 원)를 차감한 잔액(50만 원) 기준으로 환불됩니다.'}
                        {contractType === 'BRANCH_MANAGER' && '환불 조항(제11조)을 확인하고 동의합니다. 결제 금액(750만 원)에서 세팅비(50만 원)를 차감한 잔액(700만 원) 기준으로 환불됩니다.'}
                      </span>
                      <br />
                      <span className="text-xs text-gray-600 mt-1 block">
                        수업 시작 전 전액 환불, 총 수업시간의 1/3 경과 전 2/3 환불, 1/2 경과 전 1/2 환불, 1/2 경과 후 환불 불가. 단순 변심은 결제일로부터 7일 이내에만 100% 환불 가능합니다.
                      </span>
                    </span>
                  </label>
                </div>
              </section>

              <div className="flex items-center justify-end gap-3">
                <button
                  type="button"
                  onClick={() => setShowContractFormModal(false)}
                  className="rounded-lg border border-gray-300 px-4 py-2 text-sm font-semibold text-gray-600 hover:bg-gray-100"
                  disabled={submittingContract}
                >
                  취소
                </button>
                <button
                  type="submit"
                  disabled={submittingContract || uploadingSignature}
                  className="inline-flex items-center gap-2 rounded-lg bg-blue-600 px-5 py-2 text-sm font-bold text-white shadow hover:bg-blue-700 disabled:bg-blue-300"
                >
                  {submittingContract ? '접수 중...' : '계약서 접수하기'}
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* 싸인 입력 모달 */}
      {showSignatureModal && (
        <div
          className="fixed inset-0 z-[60] flex items-center justify-center bg-slate-900/70 px-4"
          onClick={() => {
            setShowSignatureModal(false);
            signaturePadRef.current?.clear();
          }}
        >
          <div
            className="w-full max-w-lg rounded-3xl bg-white shadow-2xl"
            onClick={(event) => event.stopPropagation()}
          >
            <div className="flex items-center justify-between border-b border-slate-200 px-6 py-4">
              <h3 className="text-lg font-bold text-slate-900">싸인 입력</h3>
              <button
                type="button"
                onClick={() => {
                  setShowSignatureModal(false);
                  signaturePadRef.current?.clear();
                }}
                className="rounded-full border border-slate-200 p-2 text-slate-500 hover:bg-slate-100"
              >
                <FiX />
              </button>
            </div>
            <div className="space-y-4 px-6 py-5">
              <div className="rounded-2xl border border-slate-200 bg-slate-50 p-4">
                <div className="h-48 w-full overflow-hidden rounded-xl bg-white shadow-inner">
                  <canvas ref={signatureCanvasRef} className="h-full w-full cursor-crosshair rounded-xl" />
                </div>
                <p className="mt-3 text-xs text-slate-500">
                  터치 패드, 마우스, 스타일러스를 이용해 싸인을 입력해주세요.
                </p>
              </div>
              <div className="flex items-center justify-between gap-3">
                <button
                  type="button"
                  onClick={() => signaturePadRef.current?.clear()}
                  className="rounded-lg border border-slate-300 px-4 py-2 text-sm font-semibold text-slate-600 hover:bg-slate-100"
                >
                  다시 그리기
                </button>
                <button
                  type="button"
                  onClick={handleSignatureSave}
                  disabled={uploadingSignature}
                  className="rounded-lg bg-blue-600 px-5 py-2 text-sm font-bold text-white shadow hover:bg-blue-700 disabled:bg-blue-300"
                >
                  {uploadingSignature ? '저장 중...' : '싸인 저장하기'}
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* 초대 메시지 생성 모달 */}
      {showInviteMessageModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div className="sticky top-0 bg-white border-b border-gray-200 p-6 flex items-center justify-between rounded-t-2xl">
              <h2 className="text-2xl font-bold text-gray-900">계약서 작성 초대 메시지 생성</h2>
              <button
                onClick={() => {
                  setShowInviteMessageModal(false);
                  setInviteMessage('');
                }}
                className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
              >
                <FiX className="text-xl text-gray-600" />
              </button>
            </div>

            <div className="p-6 space-y-6">
              {/* 판매원 정보 */}
              {selectedProfile && (
                <div className="bg-gray-50 rounded-xl p-4">
                  <h3 className="text-sm font-semibold text-gray-700 mb-2">선택된 판매원</h3>
                  <p className="text-sm font-bold text-gray-900">
                    {selectedProfile.nickname || selectedProfile.displayName || '이름 없음'}
                  </p>
                  <p className="text-xs text-gray-600 mt-1">
                    어필리에이트 코드: {selectedProfile.affiliateCode} | 유형: {selectedProfile.type}
                  </p>
                </div>
              )}

              {/* 이름, 전화번호 입력 */}
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-2">
                    받는 사람 이름 *
                  </label>
                  <input
                    type="text"
                    value={inviteForm.name}
                    onChange={(e) => setInviteForm((prev) => ({ ...prev, name: e.target.value }))}
                    placeholder="예: 홍길동"
                    className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100"
                  />
                </div>
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-2">
                    받는 사람 연락처 *
                  </label>
                  <input
                    type="text"
                    value={inviteForm.phone}
                    onChange={(e) => setInviteForm((prev) => ({ ...prev, phone: e.target.value }))}
                    placeholder="010-0000-0000"
                    className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100"
                  />
                </div>
                <button
                  onClick={handleGenerateInviteMessage}
                  disabled={generatingInvite || !inviteForm.name.trim() || !inviteForm.phone.trim()}
                  className="w-full inline-flex items-center justify-center gap-2 rounded-lg bg-purple-600 px-4 py-2 text-sm font-bold text-white shadow hover:bg-purple-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
                >
                  <FiSend /> 초대 메시지 생성 및 복사
                </button>
              </div>

              {/* 생성된 메시지 표시 */}
              {inviteMessage && (
                <div className="space-y-3">
                  <div className="flex items-center justify-between">
                    <h3 className="text-sm font-semibold text-gray-700">생성된 초대 메시지</h3>
                    <button
                      onClick={async () => {
                        try {
                          await navigator.clipboard.writeText(inviteMessage);
                          showSuccess('메시지가 클립보드에 복사되었습니다.');
                        } catch (error) {
                          showError('클립보드 복사에 실패했습니다.');
                        }
                      }}
                      className="inline-flex items-center gap-1 rounded-lg border border-blue-200 bg-blue-50 px-3 py-1 text-xs font-semibold text-blue-700 hover:bg-blue-100"
                    >
                      <FiCopy /> 다시 복사
                    </button>
                  </div>
                  <div className="rounded-lg border-2 border-blue-200 bg-blue-50 p-4">
                    <textarea
                      value={inviteMessage}
                      readOnly
                      rows={15}
                      className="w-full resize-none rounded-lg border border-blue-300 bg-white px-3 py-2 text-sm font-mono text-gray-900 focus:outline-none"
                    />
                  </div>
                  <div className="bg-green-50 border border-green-200 rounded-lg p-3">
                    <p className="text-xs text-green-800">
                      💡 위 메시지를 카카오톡이나 문자로 전송하세요. 메시지에 포함된 링크를 클릭하면 계약서 작성 페이지로 이동합니다.
                    </p>
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      )}

      {/* 계약서 전문 모달 */}
      {showContractTextModal && (
        <div
          className="fixed inset-0 z-[60] flex items-center justify-center bg-slate-900/70 px-4"
          onClick={() => setShowContractTextModal(false)}
        >
          <div
            className="relative max-h-[90vh] w-full max-w-3xl overflow-hidden rounded-3xl bg-white shadow-2xl"
            onClick={(event) => event.stopPropagation()}
          >
            <div className="flex items-center justify-between border-b border-slate-200 px-6 py-4">
              <h3 className="text-lg font-bold text-slate-900">크루즈닷 어필리에이트 계약서 전문</h3>
              <button
                type="button"
                onClick={() => setShowContractTextModal(false)}
                className="rounded-full border border-slate-200 p-2 text-slate-500 hover:bg-slate-100"
              >
                <FiX />
              </button>
            </div>
            <div className="h-[70vh] overflow-y-auto px-6 py-4 text-sm leading-relaxed text-slate-700 space-y-6">
              {CONTRACT_SECTIONS.map((section) => (
                <div key={section.title} className="space-y-2">
                  <h4 className="font-semibold text-slate-900">{section.title}</h4>
                  <ul className="list-disc space-y-1 pl-5">
                    {section.clauses.map((clause, index) => (
                      <li key={index}>{clause}</li>
                    ))}
                  </ul>
                </div>
              ))}
              <p className="text-xs text-slate-500">
                ※ 본 계약서는 전자 서명으로 체결되며, 갑(크루즈닷)의 최종 승인을 통해 효력이 발생합니다.
              </p>
            </div>
            <div className="border-t border-slate-200 px-6 py-4 flex items-center justify-end">
              <button
                type="button"
                onClick={() => {
                  setShowContractTextModal(false);
                  setContractReadConfirmed(true);
                }}
                className="rounded-lg bg-blue-600 px-5 py-2 text-sm font-bold text-white shadow hover:bg-blue-700"
              >
                확인했습니다
              </button>
            </div>
          </div>
        </div>
      )}

      {/* 계약서 상세 정보 모달 */}
      {showContractDetailModal && selectedContract && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div className="sticky top-0 bg-white border-b border-gray-200 p-6 flex items-center justify-between rounded-t-2xl">
              <h2 className="text-2xl font-bold text-gray-900">계약서 상세 정보</h2>
              <div className="flex items-center gap-2">
                <button
                  onClick={() => selectedContract && handleSendPDF(selectedContract.id)}
                  disabled={!selectedContract || sendingPdfContractId === selectedContract.id}
                  className="inline-flex items-center gap-2 rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                >
                  <FiSend className="text-sm" />
                  {sendingPdfContractId === selectedContract?.id ? '전송 중...' : 'PDF로 보내기'}
                </button>
                <button
                  onClick={() => {
                    setShowContractDetailModal(false);
                    setSelectedContract(null);
                  }}
                  className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
                >
                  <FiX className="text-xl text-gray-600" />
                </button>
              </div>
            </div>

            <div className="p-6 space-y-6">
              {/* 기본 정보 */}
              <section className="rounded-xl bg-gray-50 p-4">
                <h3 className="text-lg font-bold text-gray-900 mb-4">기본 정보</h3>
                <div className="grid gap-4 md:grid-cols-2 text-sm">
                  <div>
                    <span className="font-semibold text-gray-700">성명:</span>
                    <span className="ml-2 text-gray-900">{selectedContract.name}</span>
                  </div>
                  <div>
                    <span className="font-semibold text-gray-700">연락처:</span>
                    <span className="ml-2 text-gray-900">{selectedContract.phone}</span>
                  </div>
                  {selectedContract.email && (
                    <div>
                      <span className="font-semibold text-gray-700">이메일:</span>
                      <span className="ml-2 text-gray-900">{selectedContract.email}</span>
                    </div>
                  )}
                  {selectedContract.residentId && (
                    <div>
                      <span className="font-semibold text-gray-700">주민등록번호:</span>
                      <span className="ml-2 text-gray-900">{selectedContract.residentId}</span>
                    </div>
                  )}
                  {selectedContract.address && (
                    <div className="md:col-span-2">
                      <span className="font-semibold text-gray-700">주소:</span>
                      <span className="ml-2 text-gray-900">{selectedContract.address}</span>
                    </div>
                  )}
                </div>
              </section>

              {/* 정산 계좌 정보 */}
              {(selectedContract.bankName || selectedContract.bankAccount) && (
                <section className="rounded-xl bg-gray-50 p-4">
                  <h3 className="text-lg font-bold text-gray-900 mb-4">정산 계좌 정보</h3>
                  <div className="grid gap-4 md:grid-cols-2 text-sm">
                    {selectedContract.bankName && (
                      <div>
                        <span className="font-semibold text-gray-700">은행명:</span>
                        <span className="ml-2 text-gray-900">{selectedContract.bankName}</span>
                      </div>
                    )}
                    {selectedContract.bankAccount && (
                      <div>
                        <span className="font-semibold text-gray-700">계좌번호:</span>
                        <span className="ml-2 text-gray-900">{selectedContract.bankAccount}</span>
                      </div>
                    )}
                    {selectedContract.bankAccountHolder && (
                      <div>
                        <span className="font-semibold text-gray-700">예금주:</span>
                        <span className="ml-2 text-gray-900">{selectedContract.bankAccountHolder}</span>
                      </div>
                    )}
                  </div>
                </section>
              )}

              {/* 초대 정보 (멘토 정보) */}
              <section className="rounded-xl bg-gray-50 p-4">
                <h3 className="text-lg font-bold text-gray-900 mb-4">멘토 정보</h3>
                <div className="text-sm">
                  {(() => {
                    // 먼저 AffiliateProfile이 있는지 확인 (초대자가 있는 경우)
                    // 멘토 정보 표시
                    if (selectedContract.AffiliateProfile) {
                      const mentorType = selectedContract.AffiliateProfile.type;
                      // 프로필 수정에서 입력한 displayName을 우선 사용
                      const mentorName = selectedContract.AffiliateProfile.displayName || selectedContract.AffiliateProfile.nickname || selectedContract.AffiliateProfile.user?.name || '이름 없음';
                      
                      if (mentorType === 'BRANCH_MANAGER') {
                        return (
                          <div className="space-y-2">
                            <div className="flex items-center gap-2">
                              <span className="inline-flex items-center gap-1 rounded-full bg-blue-100 px-3 py-1 text-xs font-semibold text-blue-700">
                                대리점장
                              </span>
                              <span className="text-sm font-semibold text-gray-900">{mentorName}</span>
                            </div>
                            {selectedContract.AffiliateProfile.branchLabel && (
                              <div>
                                <span className="font-semibold text-gray-700">지점/팀:</span>
                                <span className="ml-2 text-gray-900">{selectedContract.AffiliateProfile.branchLabel}</span>
                              </div>
                            )}
                            {selectedContract.AffiliateProfile.affiliateCode && (
                              <div>
                                <span className="font-semibold text-gray-700">어필리에이트 코드:</span>
                                <span className="ml-2 text-gray-900 font-mono">{selectedContract.AffiliateProfile.affiliateCode}</span>
                              </div>
                            )}
                            {/* 프로필 수정에서 입력한 contactPhone을 우선 사용 */}
                            {selectedContract.AffiliateProfile.contactPhone || selectedContract.AffiliateProfile.user?.phone ? (
                              <div>
                                <span className="font-semibold text-gray-700">연락처:</span>
                                <span className="ml-2 text-gray-900">{selectedContract.AffiliateProfile.contactPhone || selectedContract.AffiliateProfile.user?.phone}</span>
                              </div>
                            ) : null}
                          </div>
                        );
                      } else if (mentorType === 'HQ') {
                        return (
                          <div className="space-y-2">
                            <div className="flex items-center gap-2">
                              <span className="inline-flex items-center gap-1 rounded-full bg-purple-100 px-3 py-1 text-xs font-semibold text-purple-700">
                                본사
                              </span>
                              <span className="text-sm font-semibold text-gray-900">{mentorName}</span>
                            </div>
                            {selectedContract.AffiliateProfile.affiliateCode && (
                              <div>
                                <span className="font-semibold text-gray-700">어필리에이트 코드:</span>
                                <span className="ml-2 text-gray-900 font-mono">{selectedContract.AffiliateProfile.affiliateCode}</span>
                              </div>
                            )}
                          </div>
                        );
                      } else {
                        // 판매원인 경우 소속 대리점장 정보도 표시
                        return (
                          <div className="space-y-2">
                            <div className="flex items-center gap-2">
                              <span className="inline-flex items-center gap-1 rounded-full bg-green-100 px-3 py-1 text-xs font-semibold text-green-700">
                                판매원
                              </span>
                              <span className="text-sm font-semibold text-gray-900">{mentorName}</span>
                            </div>
                            {selectedContract.AffiliateProfile.affiliateCode && (
                              <div>
                                <span className="font-semibold text-gray-700">어필리에이트 코드:</span>
                                <span className="ml-2 text-gray-900 font-mono">{selectedContract.AffiliateProfile.affiliateCode}</span>
                              </div>
                            )}
                            {selectedContract.managerInfo && (
                              <div className="mt-2 pt-2 border-t border-blue-200">
                                <div className="text-xs text-gray-500 mb-1">소속 대리점장</div>
                                <div className="flex items-center gap-2">
                                  <span className="inline-flex items-center gap-1 rounded-full bg-blue-100 px-2 py-1 text-xs font-semibold text-blue-700">
                                    대리점장
                                  </span>
                                  <span className="text-sm font-semibold text-blue-900">
                                    {selectedContract.managerInfo.displayName || selectedContract.managerInfo.nickname || '이름 없음'}
                                  </span>
                                </div>
                                {selectedContract.managerInfo.branchLabel && (
                                  <div className="text-xs text-gray-600 mt-1">
                                    지점/팀: {selectedContract.managerInfo.branchLabel}
                                  </div>
                                )}
                                {selectedContract.managerInfo.affiliateCode && (
                                  <div className="text-xs text-gray-600 mt-1">
                                    코드: <span className="font-mono">{selectedContract.managerInfo.affiliateCode}</span>
                                  </div>
                                )}
                              </div>
                            )}
                          </div>
                        );
                      }
                    }
                    
                    // AffiliateProfile이 없으면 본사로 표시
                    return (
                      <div className="space-y-2">
                        <div className="flex items-center gap-2">
                          <span className="inline-flex items-center gap-1 rounded-full bg-purple-100 px-3 py-1 text-xs font-semibold text-purple-700">
                            본사
                          </span>
                          <span className="text-sm text-gray-400">직접 신청</span>
                        </div>
                        <div className="text-xs text-gray-500 mt-2">
                          본사에서 직접 신청한 계약서입니다.
                        </div>
                      </div>
                    );
                  })()}
                </div>
              </section>

              {/* 계약서 상태 */}
              <section className="rounded-xl bg-gray-50 p-4">
                <h3 className="text-lg font-bold text-gray-900 mb-4">계약서 상태</h3>
                <div className="grid gap-4 md:grid-cols-2 text-sm">
                  <div>
                    <span className="font-semibold text-gray-700">상태:</span>
                    <span className={`ml-2 inline-flex items-center gap-1 rounded-full px-3 py-1 text-xs font-semibold ${getStatusColor(selectedContract.status)}`}>
                      {getStatusIcon(selectedContract.status)}
                      {getStatusLabel(selectedContract.status)}
                    </span>
                  </div>
                  <div>
                    <span className="font-semibold text-gray-700">계약서 타입:</span>
                    <span className="ml-2 text-gray-900">
                      {selectedContract.metadata?.contractType === 'BRANCH_MANAGER' 
                        ? '대리점장' 
                        : selectedContract.metadata?.contractType === 'CRUISE_STAFF'
                        ? '크루즈스탭'
                        : selectedContract.metadata?.contractType === 'PRIMARKETER'
                        ? '프리마케터'
                        : '판매원'}
                    </span>
                  </div>
                  <div>
                    <span className="font-semibold text-gray-700">제출일:</span>
                    <span className="ml-2 text-gray-900">
                      {selectedContract.submittedAt
                        ? new Date(selectedContract.submittedAt).toLocaleString('ko-KR')
                        : selectedContract.createdAt
                          ? new Date(selectedContract.createdAt).toLocaleString('ko-KR')
                          : '-'}
                    </span>
                  </div>
                  {selectedContract.reviewedAt && (
                    <div>
                      <span className="font-semibold text-gray-700">검토일:</span>
                      <span className="ml-2 text-gray-900">
                        {new Date(selectedContract.reviewedAt).toLocaleString('ko-KR')}
                      </span>
                    </div>
                  )}
                  {selectedContract.reviewer && (
                    <div>
                      <span className="font-semibold text-gray-700">검토자:</span>
                      <span className="ml-2 text-gray-900">{selectedContract.reviewer.name || '-'}</span>
                    </div>
                  )}
                </div>
              </section>

              {/* 사용자 정보 */}
              {selectedContract.user && (
                <section className="rounded-xl bg-gray-50 p-4">
                  <h3 className="text-lg font-bold text-gray-900 mb-4">사용자 정보</h3>
                  <div className="grid gap-4 md:grid-cols-2 text-sm">
                    {selectedContract.user.mallUserId && (
                      <div>
                        <span className="font-semibold text-gray-700">파트너 ID:</span>
                        <span className="ml-2 text-gray-900 font-mono">{selectedContract.user.mallUserId}</span>
                      </div>
                    )}
                    {selectedContract.metadata?.partnerId && (
                      <div>
                        <span className="font-semibold text-gray-700">생성된 ID:</span>
                        <span className="ml-2 text-purple-600 font-mono font-semibold">{selectedContract.metadata.partnerId}</span>
                      </div>
                    )}
                    {selectedContract.user && selectedContract.status === 'approved' && (
                      <div>
                        <span className="font-semibold text-gray-700">비밀번호:</span>
                        <span className="ml-2 text-green-600 font-mono font-semibold">{selectedContract.user.password || '1101'}</span>
                      </div>
                    )}
                    {selectedContract.user.name && (
                      <div>
                        <span className="font-semibold text-gray-700">이름:</span>
                        <span className="ml-2 text-gray-900">{selectedContract.user.name}</span>
                      </div>
                    )}
                    {selectedContract.user.email && (
                      <div>
                        <span className="font-semibold text-gray-700">이메일:</span>
                        <span className="ml-2 text-gray-900">{selectedContract.user.email}</span>
                      </div>
                    )}
                    {selectedContract.user.phone && (
                      <div>
                        <span className="font-semibold text-gray-700">연락처:</span>
                        <span className="ml-2 text-gray-900">{selectedContract.user.phone}</span>
                      </div>
                    )}
                  </div>
                </section>
              )}

              {/* 싸인 이미지들 */}
              {(selectedContract.metadata?.signatures || selectedContract.metadata?.signature) && (
                <section className="rounded-xl bg-gray-50 p-4">
                  <h3 className="text-lg font-bold text-gray-900 mb-4">계약서 싸인</h3>
                  <div className="space-y-4">
                    {/* 새로운 형식 (metadata.signatures) */}
                    {selectedContract.metadata?.signatures && (
                      <>
                        {/* 교육 계약서 싸인 */}
                        {selectedContract.metadata.signatures.education?.url && (
                          <div className="rounded-lg border-2 border-blue-200 bg-blue-50 p-4">
                            <div className="flex items-center justify-between mb-2">
                              <h4 className="text-sm font-semibold text-blue-700">교육 계약서 싸인</h4>
                              <button
                                onClick={() => {
                                  const contractType = selectedContract.metadata?.contractType || 'SALES_AGENT';
                                  setEducationContractType(contractType as any);
                                  setShowEducationContractModal(true);
                                  // 계약서 열람 확인 추가
                                  if (selectedContract) {
                                    setViewedContractIds(prev => new Set(prev).add(selectedContract.id));
                                  }
                                }}
                                className="text-xs text-blue-600 hover:text-blue-800 underline"
                              >
                                교육계약서 전문보기
                              </button>
                            </div>
                            {selectedContract.metadata.signatures.education.originalName && (
                              <p className="text-xs text-blue-600 mb-2">
                                파일명: {selectedContract.metadata.signatures.education.originalName}
                              </p>
                            )}
                            <img
                              src={selectedContract.metadata.signatures.education.url}
                              alt="교육 계약서 서명"
                              className="max-w-full h-auto"
                            />
                          </div>
                        )}
                        
                        {/* B2B 계약서 싸인 (대리점장 전용) */}
                        {selectedContract.metadata.signatures.b2b?.url && (
                          <div className="rounded-lg border-2 border-purple-200 bg-purple-50 p-4">
                            <h4 className="text-sm font-semibold text-purple-700 mb-2">B2B 계약서 싸인</h4>
                            {selectedContract.metadata.signatures.b2b.originalName && (
                              <p className="text-xs text-purple-600 mb-2">
                                파일명: {selectedContract.metadata.signatures.b2b.originalName}
                              </p>
                            )}
                            <img
                              src={selectedContract.metadata.signatures.b2b.url}
                              alt="B2B 계약서 서명"
                              className="max-w-full h-auto"
                            />
                          </div>
                        )}
                      </>
                    )}
                  </div>
                </section>
              )}
            </div>

            <div className="border-t border-gray-200 px-6 py-4 flex items-center justify-end gap-3">
              <button
                onClick={() => {
                  setShowContractDetailModal(false);
                  setSelectedContract(null);
                }}
                className="rounded-lg border border-gray-300 px-4 py-2 text-sm font-semibold text-gray-600 hover:bg-gray-100"
              >
                닫기
              </button>
              <button
                onClick={() => {
                  if (selectedContract) {
                    handleDelete(selectedContract.id);
                    setShowContractDetailModal(false);
                    setSelectedContract(null);
                  }
                }}
                disabled={deletingContractId === selectedContract?.id}
                className="rounded-lg border border-red-300 bg-red-50 px-4 py-2 text-sm font-semibold text-red-700 hover:bg-red-100 disabled:opacity-50"
              >
                {deletingContractId === selectedContract?.id ? '삭제 중...' : '삭제'}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* 교육계약서 전문 모달 */}
      {showEducationContractModal && (
        <div
          className="fixed inset-0 z-[60] flex items-center justify-center bg-slate-900/70 px-4"
          onClick={() => setShowEducationContractModal(false)}
        >
          <div
            className="relative max-h-[90vh] w-full max-w-3xl overflow-hidden rounded-3xl bg-white shadow-2xl"
            onClick={(event) => event.stopPropagation()}
          >
            <div className="flex items-center justify-between border-b border-slate-200 px-6 py-4">
              <h3 className="text-lg font-bold text-slate-900">
                {educationContractType === 'BRANCH_MANAGER' ? '대리점장' : educationContractType === 'CRUISE_STAFF' ? '크루즈스탭' : educationContractType === 'PRIMARKETER' ? '프리마케터' : '판매원'} 교육 계약서 전문
              </h3>
              <button
                type="button"
                onClick={() => setShowEducationContractModal(false)}
                className="rounded-full border border-slate-200 p-2 text-slate-500 hover:bg-slate-100"
              >
                <FiX />
              </button>
            </div>
            <div className="h-[70vh] overflow-y-auto px-6 py-4 text-sm leading-relaxed text-slate-700 space-y-4">
              {/* 전문 전체 내용만 표시 (요약본 제거 - 법적 리스크 방지) */}
              {(() => {
                const sections = EDUCATION_CONTRACT_SECTIONS[educationContractType] || EDUCATION_CONTRACT_SECTIONS['SALES_AGENT'];
                return sections.map((section) => (
                  <div key={section.title} className="space-y-3">
                    <h4 className="text-lg font-bold text-slate-900">{section.title}</h4>
                    <div className="space-y-2">
                      {section.clauses.map((clause, index) => {
                        if (clause === '') {
                          return <div key={index} className="h-2" />;
                        }
                        if (clause.startsWith('제') && clause.includes('조')) {
                          return (
                            <h5 key={index} className="font-semibold text-slate-900 mt-4 mb-2">
                              {clause}
                            </h5>
                          );
                        }
                        if (clause.match(/^\d+\./)) {
                          return (
                            <div key={index} className="ml-4 text-slate-700">
                              {clause}
                            </div>
                          );
                        }
                        return (
                          <p key={index} className="text-slate-700 leading-relaxed">
                            {clause}
                          </p>
                        );
                      })}
                    </div>
                  </div>
                ));
              })()}
              
              <p className="text-xs text-slate-500 mt-4">
                ※ 본 교육 계약서는 전자 서명으로 체결되며, 갑(크루즈닷)의 최종 승인을 통해 효력이 발생합니다.
              </p>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
