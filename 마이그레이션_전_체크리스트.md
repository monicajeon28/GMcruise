# 마이그레이션 전 전체 체크리스트

## ✅ 완료된 작업

### 1. API 전환 완료
- [x] `/api/admin/images/upload` → Google Drive
- [x] `/api/uploads/cruisedot` → Google Drive
- [x] `/api/partner/profile/upload-image` → Google Drive
- [x] `/api/community/upload` → Google Drive
- [x] `/api/affiliate/sales/[saleId]/submit-confirmation` → Google Drive
- [x] `/api/affiliate/contracts/upload` → Google Drive
- [x] `/api/admin/upload-image` → Google Drive
- [x] `/api/admin/mall/upload` → Google Drive
- [x] `/api/admin/pages/upload` → Google Drive
- [x] `/api/customer/passport-upload` → Google Drive
- [x] `/api/affiliate/profile/upload-documents` → Google Drive
- [x] `/api/admin/company/logo/upload` → Google Drive
- [x] `/api/admin/mall/cruise-photos` → Google Drive (수정 완료)
- [x] `/api/admin/affiliate/payment-pages/upload` → Google Drive (수정 완료)

### 2. 파일 서빙 API 전환 완료
- [x] `/api/admin/mall/files` → Google Drive
- [x] `/api/admin/images` → Google Drive
- [x] `/api/media` → Google Drive

### 3. 설정 파일 확인 완료
- [x] `next.config.mjs` - `public/uploads/**`, `public/contracts/pdfs/**`, `public/payment-pages/**` 제외 설정 확인
- [x] `.gitignore` - 업로드 폴더 제외 확인

### 4. 마이그레이션 스크립트 준비 완료
- [x] `scripts/migrate-uploads-to-drive.ts` - 로컬 파일 마이그레이션
- [x] `scripts/migrate-db-paths-to-drive.ts` - 데이터베이스 경로 마이그레이션
- [x] `scripts/verify-migration.ts` - 마이그레이션 검증

### 5. 문서 작성 완료
- [x] `마이그레이션_실행_가이드.md`
- [x] `마이그레이션_작업_완료_리포트.md`
- [x] `Google_Drive_마이그레이션_완료_리포트.md`

---

## ⚠️ 마이그레이션 전 확인 사항

### 1. 환경변수 확인

다음 환경변수들이 모두 `.env.local`에 설정되어 있는지 확인:

```bash
# Google Drive 인증
GOOGLE_DRIVE_SERVICE_ACCOUNT_EMAIL
GOOGLE_DRIVE_SERVICE_ACCOUNT_PRIVATE_KEY
GOOGLE_DRIVE_SHARED_DRIVE_ID
GOOGLE_DRIVE_ROOT_FOLDER_ID

# Google Sheets
COMMUNITY_BACKUP_SPREADSHEET_ID
TRIP_APIS_ARCHIVE_SPREADSHEET_ID

# Google Drive 폴더 ID
GOOGLE_DRIVE_PASSPORT_FOLDER_ID
GOOGLE_DRIVE_PRODUCTS_FOLDER_ID
GOOGLE_DRIVE_CRUISE_IMAGES_FOLDER_ID
GOOGLE_DRIVE_COMPANY_LOGO_FOLDER_ID
GOOGLE_DRIVE_AFFILIATE_INFO_FOLDER_ID

# 업로드 폴더
GOOGLE_DRIVE_UPLOADS_IMAGES_FOLDER_ID
GOOGLE_DRIVE_UPLOADS_PROFILES_FOLDER_ID
GOOGLE_DRIVE_UPLOADS_REVIEWS_FOLDER_ID
GOOGLE_DRIVE_UPLOADS_AUDIO_FOLDER_ID
GOOGLE_DRIVE_UPLOADS_DOCUMENTS_FOLDER_ID
GOOGLE_DRIVE_UPLOADS_VIDEOS_FOLDER_ID
GOOGLE_DRIVE_UPLOADS_SALES_AUDIO_FOLDER_ID
GOOGLE_DRIVE_UPLOADS_FONTS_FOLDER_ID
GOOGLE_DRIVE_CONTRACTS_PDFS_FOLDER_ID

# 어필리에이트 문서
GOOGLE_DRIVE_CONTRACTS_FOLDER_ID
GOOGLE_DRIVE_CONTRACT_SIGNATURES_FOLDER_ID
GOOGLE_DRIVE_CONTRACT_AUDIO_FOLDER_ID
GOOGLE_DRIVE_ID_CARD_FOLDER_ID
GOOGLE_DRIVE_BANKBOOK_FOLDER_ID
```

### 2. 데이터베이스 백업

**⚠️ 필수**: 마이그레이션 전에 반드시 데이터베이스를 백업하세요!

```bash
# PostgreSQL 백업 예시
pg_dump $DATABASE_URL > backup-$(date +%Y%m%d-%H%M%S).sql
```

### 3. 로컬 파일 확인

마이그레이션할 로컬 파일이 있는지 확인:

```bash
# 확인할 폴더들
ls -lh public/uploads/
ls -lh public/contracts/pdfs/
ls -lh public/payment-pages/
ls -lh public/크루즈정보사진/
```

### 4. Google Drive 권한 확인

- 서비스 계정이 모든 폴더에 접근 권한이 있는지 확인
- 공유 드라이브에 서비스 계정이 추가되어 있는지 확인

---

## 🚀 마이그레이션 실행 순서

### 1단계: Dry-run으로 확인

```bash
# 로컬 파일 마이그레이션 Dry-run
npm run migrate:uploads -- --dry-run

# 데이터베이스 경로 마이그레이션 Dry-run
npm run migrate:db-paths -- --dry-run
```

### 2단계: 실제 마이그레이션

```bash
# 1. 로컬 파일 마이그레이션
npm run migrate:uploads

# 2. 데이터베이스 백업 (필수!)
pg_dump $DATABASE_URL > backup-$(date +%Y%m%d-%H%M%S).sql

# 3. 데이터베이스 경로 마이그레이션
npm run migrate:db-paths
```

### 3단계: 검증

```bash
# 마이그레이션 결과 검증
npm run migrate:verify
```

### 4단계: 확인

- [ ] 사이트에서 이미지가 정상적으로 표시되는지 확인
- [ ] 관리자 패널에서 이미지 업로드가 정상 작동하는지 확인
- [ ] 마이그레이션 보고서 검토

### 5단계: 로컬 파일 정리 (선택사항)

**⚠️ 주의**: 모든 것이 정상 작동하는 것을 확인한 후에만 실행!

```bash
npm run migrate:uploads -- --delete-local
```

---

## 🐛 알려진 이슈 및 해결 방법

### 1. Google Drive API 할당량 초과

**증상**: `Quota exceeded` 에러

**해결**:
- 마이그레이션을 여러 번에 나눠서 실행
- `--only` 옵션으로 특정 폴더만 마이그레이션

### 2. 파일을 찾을 수 없음

**증상**: `File not found` 에러

**해결**:
- 로컬 파일이 이미 삭제되었을 수 있음
- 마이그레이션 보고서에서 `not-found` 상태 확인

### 3. 데이터베이스 업데이트 실패

**증상**: Prisma 에러

**해결**:
- 데이터베이스 연결 확인
- 트랜잭션 로그 확인
- 백업에서 복원 후 재시도

---

## 📊 마이그레이션 보고서 위치

모든 보고서는 `migrations/` 폴더에 저장됩니다:

- `uploads-to-drive-{timestamp}.json`: 로컬 파일 마이그레이션 결과
- `db-paths-to-drive-{timestamp}.json`: 데이터베이스 경로 마이그레이션 결과
- `verification-{timestamp}.json`: 검증 결과

---

## ✅ 최종 체크리스트

마이그레이션 실행 전:

- [ ] 모든 환경변수 설정 완료
- [ ] 데이터베이스 백업 완료
- [ ] Dry-run 실행 및 결과 확인
- [ ] Google Drive 권한 확인
- [ ] 로컬 파일 확인

마이그레이션 실행 후:

- [ ] 마이그레이션 보고서 검토
- [ ] 검증 스크립트 실행
- [ ] 사이트에서 이미지 정상 표시 확인
- [ ] 관리자 패널 기능 테스트
- [ ] 에러 로그 확인

---

## 📞 문제 발생 시

1. 마이그레이션 보고서 확인
2. 에러 로그 확인
3. 데이터베이스 백업에서 복원 (필요시)
4. 문제 해결 후 재시도


