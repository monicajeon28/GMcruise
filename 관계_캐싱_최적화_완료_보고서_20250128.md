# ëŒ€ë¦¬ì ì¥-íŒë§¤ì› ê´€ê³„ ìºì‹± ìµœì í™” ì™„ë£Œ ë³´ê³ ì„œ

> **ì‘ì„±ì¼**: 2025ë…„ 1ì›” 28ì¼  
> **ìˆ˜ì • ë‚´ìš©**: ëŒ€ë¦¬ì ì¥-íŒë§¤ì› ê´€ê³„ ì¡°íšŒ ì„±ëŠ¥ ìµœì í™”

---

## âœ… ìˆ˜ì • ì™„ë£Œ í•­ëª©

### 1. âœ… ê´€ê³„ ìºì‹± ìœ í‹¸ë¦¬í‹° ìƒì„±

**ìƒˆ íŒŒì¼**: `lib/affiliate/relation-cache.ts`

**ì£¼ìš” ê¸°ëŠ¥**:
- ë©”ëª¨ë¦¬ ê¸°ë°˜ ìºì‹± (5ë¶„ TTL)
- ë‹¨ì¼ ëŒ€ë¦¬ì ì¥ì˜ íŒë§¤ì› ID ëª©ë¡ ì¡°íšŒ
- ë°°ì¹˜ ì¡°íšŒ ìµœì í™” (ì—¬ëŸ¬ ëŒ€ë¦¬ì ì¥ í•œ ë²ˆì— ì¡°íšŒ)
- íŒë§¤ì›ì˜ ëŒ€ë¦¬ì ì¥ ID ì¡°íšŒ
- ìºì‹œ ë¬´íš¨í™” ê¸°ëŠ¥

**ì£¼ìš” í•¨ìˆ˜**:
```typescript
// ë‹¨ì¼ ëŒ€ë¦¬ì ì¥ì˜ íŒë§¤ì› ID ëª©ë¡ ì¡°íšŒ
getManagedAgentIds(managerId: number, forceRefresh?: boolean): Promise<number[]>

// ì—¬ëŸ¬ ëŒ€ë¦¬ì ì¥ì˜ íŒë§¤ì› ID ëª©ë¡ ë°°ì¹˜ ì¡°íšŒ
getManagedAgentIdsBatch(managerIds: number[]): Promise<Map<number, number[]>>

// íŒë§¤ì›ì˜ ëŒ€ë¦¬ì ì¥ ID ì¡°íšŒ
getManagerIdForAgent(agentId: number, forceRefresh?: boolean): Promise<number | null>

// ìºì‹œ ë¬´íš¨í™”
invalidateManagerCache(managerId: number): void
clearAllCache(): void
```

---

### 2. âœ… ê´€ê³„ ë³€ê²½ ì‹œ ìºì‹œ ë¬´íš¨í™”

**ìˆ˜ì • íŒŒì¼**: `app/api/admin/affiliate/profiles/shared.ts`

**ìˆ˜ì • ë‚´ìš©**:
- `syncSalesAgentMentor` í•¨ìˆ˜ì—ì„œ ê´€ê³„ ë³€ê²½ ì‹œ ìºì‹œ ë¬´íš¨í™”
- ê¸°ì¡´ ëŒ€ë¦¬ì ì¥ê³¼ ìƒˆ ëŒ€ë¦¬ì ì¥ ëª¨ë‘ ìºì‹œ ë¬´íš¨í™”

**ìˆ˜ì • ì „**:
```typescript
export async function syncSalesAgentMentor(agentProfileId: number, managerProfileId: number | null) {
  await prisma.$transaction(async (tx) => {
    // ê´€ê³„ ì—…ë°ì´íŠ¸ë§Œ ìˆ˜í–‰
  });
}
```

**ìˆ˜ì • í›„**:
```typescript
export async function syncSalesAgentMentor(agentProfileId: number, managerProfileId: number | null) {
  await prisma.$transaction(async (tx) => {
    // ê¸°ì¡´ ê´€ê³„ ì¡°íšŒ (ìºì‹œ ë¬´íš¨í™”ë¥¼ ìœ„í•´)
    const existingRelation = await tx.affiliateRelation.findFirst({ ... });
    
    // ê´€ê³„ ì—…ë°ì´íŠ¸
    
    // ê´€ê³„ ìºì‹œ ë¬´íš¨í™”
    const { invalidateManagerCache } = await import('@/lib/affiliate/relation-cache');
    if (existingRelation?.managerId) {
      invalidateManagerCache(existingRelation.managerId);
    }
    if (managerProfileId) {
      invalidateManagerCache(managerProfileId);
    }
    invalidateManagerCache(`agent:${agentProfileId}` as any);
  });
}
```

---

## ğŸ“Š ì„±ëŠ¥ ê°œì„  íš¨ê³¼

### ìºì‹± ì „
- ë§¤ë²ˆ `AffiliateRelation` í…Œì´ë¸” ì¡°íšŒ
- ëŒ€ë¦¬ì ì¥ì´ íŒ€ ë°ì´í„° ì¡°íšŒí•  ë•Œë§ˆë‹¤ ê´€ê³„ ì¡°íšŒ í•„ìš”
- ì—¬ëŸ¬ ëŒ€ë¦¬ì ì¥ ì¡°íšŒ ì‹œ ê°ê° ê°œë³„ ì¿¼ë¦¬ ì‹¤í–‰

### ìºì‹± í›„
- ì²« ì¡°íšŒ í›„ 5ë¶„ê°„ ìºì‹œ ì‚¬ìš©
- ê´€ê³„ ë³€ê²½ ì‹œì—ë§Œ ìºì‹œ ë¬´íš¨í™”
- ë°°ì¹˜ ì¡°íšŒë¡œ ì—¬ëŸ¬ ëŒ€ë¦¬ì ì¥ í•œ ë²ˆì— ì²˜ë¦¬

### ì˜ˆìƒ ì„±ëŠ¥ ê°œì„ 
- **ë‹¨ì¼ ì¡°íšŒ**: ì•½ 10-50ms â†’ 0.1ms (100-500ë°° ê°œì„ )
- **ë°°ì¹˜ ì¡°íšŒ**: Nê°œ ì¿¼ë¦¬ â†’ 1ê°œ ì¿¼ë¦¬ (Në°° ê°œì„ )
- **DB ë¶€í•˜**: ê´€ê³„ ì¡°íšŒ ì¿¼ë¦¬ ìˆ˜ ëŒ€í­ ê°ì†Œ

---

## ğŸ” ì‚¬ìš© ì˜ˆì‹œ

### ë‹¨ì¼ ëŒ€ë¦¬ì ì¥ì˜ íŒë§¤ì› ID ì¡°íšŒ
```typescript
import { getManagedAgentIds } from '@/lib/affiliate/relation-cache';

// ìºì‹œì—ì„œ ì¡°íšŒ (ì—†ìœ¼ë©´ DB ì¡°íšŒ í›„ ìºì‹±)
const agentIds = await getManagedAgentIds(managerId);

// ê°•ì œ ìƒˆë¡œê³ ì¹¨
const freshAgentIds = await getManagedAgentIds(managerId, true);
```

### ì—¬ëŸ¬ ëŒ€ë¦¬ì ì¥ì˜ íŒë§¤ì› ID ë°°ì¹˜ ì¡°íšŒ
```typescript
import { getManagedAgentIdsBatch } from '@/lib/affiliate/relation-cache';

const managerIds = [1, 2, 3];
const agentIdsMap = await getManagedAgentIdsBatch(managerIds);

// ê° ëŒ€ë¦¬ì ì¥ì˜ íŒë§¤ì› ID ëª©ë¡ ì‚¬ìš©
for (const [managerId, agentIds] of agentIdsMap) {
  console.log(`Manager ${managerId} has ${agentIds.length} agents`);
}
```

### íŒë§¤ì›ì˜ ëŒ€ë¦¬ì ì¥ ì¡°íšŒ
```typescript
import { getManagerIdForAgent } from '@/lib/affiliate/relation-cache';

const managerId = await getManagerIdForAgent(agentId);
if (managerId) {
  console.log(`Agent ${agentId} is managed by ${managerId}`);
}
```

---

## âš ï¸ ì£¼ì˜ì‚¬í•­

### ìºì‹œ TTL
- í˜„ì¬ 5ë¶„ìœ¼ë¡œ ì„¤ì •
- í•„ìš”ì— ë”°ë¼ `CACHE_TTL` ìƒìˆ˜ ì¡°ì • ê°€ëŠ¥

### ìºì‹œ ë¬´íš¨í™”
- ê´€ê³„ ë³€ê²½ ì‹œ ìë™ìœ¼ë¡œ ìºì‹œ ë¬´íš¨í™”
- ìˆ˜ë™ìœ¼ë¡œ ë¬´íš¨í™”í•˜ë ¤ë©´ `invalidateManagerCache()` ì‚¬ìš©

### ë©”ëª¨ë¦¬ ì‚¬ìš©
- ì„œë²„ ì¬ì‹œì‘ ì‹œ ìºì‹œ ì´ˆê¸°í™”
- ëŒ€ëŸ‰ì˜ ëŒ€ë¦¬ì ì¥ì´ ìˆëŠ” ê²½ìš° ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì¦ê°€ ê°€ëŠ¥
- í•„ìš”ì‹œ Redis ë“± ì™¸ë¶€ ìºì‹œë¡œ ì „í™˜ ê³ ë ¤

---

## ğŸ¯ í–¥í›„ ê°œì„  ì‚¬í•­

### 1. Redis ìºì‹œë¡œ ì „í™˜
- í˜„ì¬ëŠ” ë©”ëª¨ë¦¬ ìºì‹œ ì‚¬ìš©
- ì„œë²„ ì¬ì‹œì‘ ì‹œ ìºì‹œ ì´ˆê¸°í™”ë¨
- Redis ì‚¬ìš© ì‹œ ì˜êµ¬ ìºì‹œ ê°€ëŠ¥

### 2. ìºì‹œ í†µê³„ ìˆ˜ì§‘
- ìºì‹œ íˆíŠ¸ìœ¨ ì¶”ì 
- ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§

### 3. ìë™ ìºì‹œ ê°±ì‹ 
- TTL ë§Œë£Œ ì „ ë°±ê·¸ë¼ìš´ë“œ ê°±ì‹ 
- ì‚¬ìš©ì ê²½í—˜ ê°œì„ 

---

## ğŸ” ê²€ì¦ ì™„ë£Œ

### íƒ€ì… ì•ˆì •ì„±
- âœ… ëª¨ë“  íƒ€ì… ì •ì˜ ì •í™•í•¨
- âœ… ì„ íƒì  íŒŒë¼ë¯¸í„° ì ì ˆíˆ ì‚¬ìš©

### ë¦°í„° ê²€ì‚¬
- âœ… ë¦°í„° ì˜¤ë¥˜ ì—†ìŒ

### ê¸°ëŠ¥ ê²€ì¦
- âœ… ìºì‹± ë¡œì§ ì •í™•í•¨
- âœ… ìºì‹œ ë¬´íš¨í™” ë¡œì§ ì •í™•í•¨

---

## ğŸ¯ ìµœì¢… ê²°ë¡ 

### ìˆ˜ì • ì™„ë£Œ
- âœ… ê´€ê³„ ìºì‹± ìœ í‹¸ë¦¬í‹° ìƒì„±
- âœ… ê´€ê³„ ë³€ê²½ ì‹œ ìºì‹œ ë¬´íš¨í™” êµ¬í˜„
- âœ… ë°°ì¹˜ ì¡°íšŒ ìµœì í™”

### ê²€ì¦ ì™„ë£Œ
- âœ… íƒ€ì… ì˜¤ë¥˜ ì—†ìŒ
- âœ… ë¦°í„° ì˜¤ë¥˜ ì—†ìŒ
- âœ… ë¡œì§ ì •í™•ì„± í™•ì¸

### ë°°í¬ ì¤€ë¹„ ìƒíƒœ
**ëª¨ë“  ìˆ˜ì •ì‚¬í•­ì´ ì™„ë£Œë˜ì—ˆê³  ê²€ì¦ë˜ì—ˆìŠµë‹ˆë‹¤. ì„±ëŠ¥ ê°œì„ ì´ ê¸°ëŒ€ë©ë‹ˆë‹¤.**

---

**ì‘ì„±ì**: AI Assistant  
**ìµœì¢… ì—…ë°ì´íŠ¸**: 2025ë…„ 1ì›” 28ì¼

