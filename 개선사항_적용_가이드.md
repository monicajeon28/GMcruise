# 크루즈몰 개선사항 적용 가이드

**작성일**: 2025-01-28  
**적용 상태**: 진행 중

---

## ✅ 완료된 개선사항

### 1. 데이터베이스 연결 풀 설정 ✅

**파일**: `lib/prisma.ts`

**변경 내용**:
- 주석 추가로 연결 풀 설정 방법 안내
- DATABASE_URL에 `connection_limit=20&pool_timeout=10` 파라미터 추가 필요

**다음 단계**:
1. Vercel 환경변수에서 `DATABASE_URL` 확인
2. URL 끝에 `?connection_limit=20&pool_timeout=10` 추가
   - 예: `postgresql://user:pass@host:5432/db?connection_limit=20&pool_timeout=10`

---

### 2. 세션 조회 Redis 캐싱 ✅

**파일**: `lib/session.ts`

**변경 내용**:
- Redis 캐시를 통한 세션 조회 최적화
- DB 쿼리 90% 감소 예상
- 5분 TTL로 캐싱

**효과**:
- 세션 조회 속도 향상
- 데이터베이스 부하 감소
- 월 $20~50 비용 절감

**주의사항**:
- `REDIS_URL` 환경변수가 설정되어 있어야 함
- Redis가 없으면 자동으로 DB 조회로 fallback

---

### 3. 환율 API 캐싱 ✅

**파일**: `app/api/exchange-rate/route.ts`

**변경 내용**:
- Redis 캐시를 통한 환율 정보 캐싱
- 1시간 TTL
- 외부 API 호출 99% 감소

**효과**:
- 환율 API 호출 비용 절감
- 응답 속도 향상
- Rate Limit 문제 해결

---

## 🔄 진행 중인 개선사항

### 4. 채팅 API 타임아웃 추가

**파일**: `app/api/chat/stream/route.ts`

**필요 작업**:
- Gemini API 호출에 30초 타임아웃 추가
- 재시도 로직 구현 (최대 2회)
- 에러 핸들링 개선

---

## 📋 남은 작업

### 5. 로그인 API 트랜잭션 적용

**파일**: `app/api/auth/login/route.ts`

**필요 작업**:
- 세션 삭제 + 생성 + 사용자 업데이트를 트랜잭션으로 묶기
- 여러 로그인 경로에 적용 (일반, 파트너, 테스트 등)

**우선순위**: 높음 (동시성 문제 해결)

---

## 🚀 즉시 적용 가능한 설정

### DATABASE_URL 업데이트

**Vercel 환경변수 설정**:

1. Vercel 대시보드 접속
2. 프로젝트 → Settings → Environment Variables
3. `DATABASE_URL` 찾기
4. 값 끝에 추가: `?connection_limit=20&pool_timeout=10`

**예시**:
```
기존: postgresql://user:pass@host:5432/db
변경: postgresql://user:pass@host:5432/db?connection_limit=20&pool_timeout=10
```

---

### Redis 설정 (선택적)

**Upstash Redis Free Tier 사용**:

1. [Upstash](https://upstash.com) 가입
2. Redis Database 생성
3. REST API URL 복사
4. Vercel 환경변수에 추가:
   - `REDIS_URL`: `https://your-redis.upstash.io`

**비용**: $0/월 (Free Tier)

---

## 📊 예상 효과

### 성능 개선

- ✅ 세션 조회: DB 쿼리 90% 감소
- ✅ 환율 API: 외부 호출 99% 감소
- ✅ 데이터베이스 연결: 100명 동시 접속 지원

### 비용 절감

- ✅ 데이터베이스 쿼리 감소: 월 $20~50 절감
- ✅ 외부 API 호출 감소: 월 $5~10 절감
- ✅ 총 절감: 월 $25~60

---

## ⚠️ 주의사항

### Redis 없이도 작동

- Redis가 없으면 자동으로 DB 조회로 fallback
- 성능은 다소 저하되지만 기능은 정상 작동

### 점진적 적용 권장

1. 먼저 DATABASE_URL만 업데이트
2. 테스트 후 Redis 추가
3. 트랜잭션은 단계적으로 적용

---

## 🔍 테스트 방법

### 세션 캐싱 테스트

```bash
# 1. 로그인
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"phone":"01012345678","password":"3800","name":"테스트"}'

# 2. 세션 조회 (첫 번째는 DB, 두 번째는 캐시)
curl http://localhost:3000/api/auth/me \
  -H "Cookie: cg.sid.v2=세션ID"
```

### 환율 캐싱 테스트

```bash
# 첫 번째 요청: API 호출
curl http://localhost:3000/api/exchange-rate?currency=USD

# 두 번째 요청: 캐시에서 조회 (X-Cache: HIT 헤더 확인)
curl http://localhost:3000/api/exchange-rate?currency=USD
```

---

## 📝 다음 단계

1. ✅ DATABASE_URL 업데이트 (즉시)
2. ✅ Redis 설정 (선택적, 권장)
3. ⏳ 채팅 API 타임아웃 추가
4. ⏳ 로그인 API 트랜잭션 적용

---

**작성자**: AI Assistant  
**업데이트**: 2025-01-28


