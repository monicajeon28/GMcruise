# 🛡️ 배포 안전장치 가이드

**작성일**: 2025-11-23  
**목적**: 배포 전 필수 안전장치 및 문제 예방 가이드

---

## 🎯 배포 전 안전장치 체크리스트

### 1. ✅ Health Check 시스템

**목적**: 서버가 정상 작동하는지 실시간으로 확인

**확인 방법**:
```bash
# Health check API 호출
curl https://your-domain.com/api/health
```

**응답 예시**:
```json
{
  "status": "ok",
  "timestamp": "2025-11-23T12:00:00.000Z",
  "uptime": 3600,
  "services": {
    "database": "connected",
    "googleDrive": "configured"
  }
}
```

**문제 발생 시**:
- `status: "error"` → 즉시 확인 필요
- `database: "disconnected"` → 데이터베이스 연결 확인
- `googleDrive: "not_configured"` → 환경 변수 확인

---

### 2. ✅ 시스템 상태 모니터링

**목적**: 관리자 패널에서 전체 시스템 상태를 한눈에 확인

**확인 방법**:
1. 관리자 패널 접속
2. `/api/admin/system/status` 호출 또는 관리자 대시보드에서 확인

**확인 항목**:
- ✅ 데이터베이스 연결 상태
- ✅ 구글 드라이브 설정 상태
- ✅ 필수 환경 변수 설정 여부
- ✅ Cron job 보안 설정

**문제 발생 시**:
- 각 항목별로 상세 메시지 제공
- 누락된 환경 변수 목록 표시

---

### 3. ✅ 에러 로깅 및 모니터링

**현재 구현된 로깅**:
- `lib/logger.ts` - 보안 로그 및 인증 로그
- `console.error` - 일반 에러 로그

**Vercel에서 확인 방법**:
1. Vercel 대시보드 → 프로젝트 선택
2. "Logs" 탭에서 실시간 로그 확인
3. "Functions" 탭에서 함수별 에러 확인

**추가 권장 사항**:
- Sentry 같은 에러 트래킹 도구 연동 (선택사항)
- 에러 발생 시 이메일 알림 설정 (선택사항)

---

### 4. ✅ 데이터 백업 및 복구

**자동 백업**:
- ✅ 매일 새벽 3시 자동 백업 (구글 드라이브)
- ✅ 14개 주요 테이블 백업
- ✅ 월별/일별 폴더 구조

**백업 확인 방법**:
```bash
# 수동 백업 실행
curl -X GET https://your-domain.com/api/admin/test/backup \
  -H "Authorization: Bearer YOUR_CRON_SECRET"
```

**복구 계획**:
1. 구글 드라이브에서 백업 파일 다운로드
2. 데이터베이스에 직접 복구 (Prisma 사용)
3. 또는 데이터베이스 관리 도구 사용

**백업 위치**:
- 구글 드라이브: `백업/YYYY-MM/YYYY-MM-DD/`

---

### 5. ✅ 롤백 계획

**Vercel 롤백 방법**:

1. **이전 배포로 롤백**:
   - Vercel 대시보드 → Deployments
   - 이전 배포 선택 → "Promote to Production" 클릭

2. **Git으로 롤백**:
   ```bash
   # 이전 커밋으로 되돌리기
   git revert HEAD
   git push
   ```

3. **환경 변수 롤백**:
   - Vercel 대시보드 → Settings → Environment Variables
   - 이전 값으로 복구

**롤백 전 확인사항**:
- [ ] 데이터베이스 마이그레이션 롤백 필요 여부 확인
- [ ] 환경 변수 변경사항 확인
- [ ] 사용자에게 공지 (필요한 경우)

---

### 6. ✅ 안전한 배포 전략

**권장 배포 프로세스**:

1. **스테이징 환경에서 먼저 테스트** (가능한 경우)
   - 별도 Vercel 프로젝트 생성
   - 스테이징 환경에서 모든 기능 테스트
   - 문제 없으면 프로덕션 배포

2. **점진적 배포** (Vercel Pro 이상)
   - Preview 배포로 먼저 테스트
   - 문제 없으면 Production으로 승격

3. **배포 시간 선택**
   - 사용자가 적은 시간대 선택 (새벽 또는 평일 오전)
   - 긴급하지 않은 경우 주말 배포

---

### 7. ✅ 환경 변수 보안

**절대 하지 말아야 할 것**:
- ❌ `.env` 파일을 Git에 커밋
- ❌ 환경 변수를 코드에 하드코딩
- ❌ 환경 변수를 공개 채널에 공유

**안전한 관리 방법**:
- ✅ Vercel 대시보드에서만 설정
- ✅ 팀원과는 비밀 공유 도구 사용 (1Password 등)
- ✅ 환경 변수 변경 시 팀에 공지

**환경 변수 확인**:
```bash
# 로컬에서 확인 (절대 실제 값 노출하지 말 것)
node scripts/check-env.js
```

---

### 8. ✅ 데이터베이스 마이그레이션 안전성

**마이그레이션 전**:
- [ ] 반드시 데이터베이스 백업
- [ ] 스테이징 환경에서 먼저 테스트
- [ ] 롤백 계획 수립

**마이그레이션 실행**:
```bash
# Vercel은 자동으로 실행하지만, 수동 실행이 필요한 경우:
npx prisma migrate deploy
```

**마이그레이션 롤백**:
```bash
# 주의: 데이터 손실 가능성 있음
npx prisma migrate resolve --rolled-back MIGRATION_NAME
```

---

### 9. ✅ API 보안

**현재 구현된 보안**:
- ✅ Rate Limiting (middleware.ts)
- ✅ CSRF 토큰 검증
- ✅ 세션 기반 인증
- ✅ 관리자 권한 확인

**추가 확인사항**:
- [ ] 모든 API에 적절한 인증 확인
- [ ] 민감한 데이터는 암호화
- [ ] SQL Injection 방지 (Prisma 사용으로 자동 방지)
- [ ] XSS 방지 (입력값 검증)

---

### 10. ✅ 모니터링 및 알림

**Vercel 기본 모니터링**:
- ✅ 배포 상태
- ✅ 함수 실행 로그
- ✅ 에러 로그
- ✅ 성능 메트릭

**추가 모니터링 도구** (선택사항):
- Uptime Robot - 서버 가동 시간 모니터링
- Sentry - 에러 트래킹
- Datadog - 성능 모니터링

**알림 설정**:
- Vercel 대시보드 → Settings → Notifications
- 배포 실패 시 이메일 알림 설정

---

## 🚨 문제 발생 시 대응 가이드

### 문제 1: 사이트가 접속되지 않음

**확인 순서**:
1. Health check API 호출: `/api/health`
2. Vercel 대시보드에서 배포 상태 확인
3. 에러 로그 확인
4. 환경 변수 확인

**해결 방법**:
- 배포 실패 → 이전 배포로 롤백
- 환경 변수 누락 → Vercel 대시보드에서 설정
- 데이터베이스 연결 실패 → `DATABASE_URL` 확인

---

### 문제 2: 데이터베이스 연결 실패

**확인 사항**:
- `DATABASE_URL` 환경 변수 확인
- 데이터베이스 서버 상태 확인
- 방화벽 설정 확인

**해결 방법**:
1. Vercel 대시보드에서 `DATABASE_URL` 재설정
2. 데이터베이스 제공업체 대시보드에서 연결 확인
3. 필요시 데이터베이스 제공업체 지원팀에 문의

---

### 문제 3: 구글 드라이브 백업 실패

**확인 사항**:
- `/api/admin/system/status`에서 구글 드라이브 설정 확인
- 구글 서비스 계정 권한 확인
- 공유 드라이브 접근 권한 확인

**해결 방법**:
1. 환경 변수 재설정
2. 구글 클라우드 콘솔에서 서비스 계정 권한 확인
3. 수동 백업 실행: `/api/admin/test/backup`

---

### 문제 4: Cron Job이 작동하지 않음

**확인 사항**:
- Vercel 대시보드 → Settings → Cron Jobs
- `CRON_SECRET` 환경 변수 확인
- Cron 실행 로그 확인

**해결 방법**:
1. `CRON_SECRET` 환경 변수 설정
2. `vercel.json`에서 cron 설정 확인
3. 수동으로 cron API 호출하여 테스트

---

## 📋 배포 전 최종 확인

### 배포 직전 체크리스트

- [ ] Health check API 정상 작동 (`/api/health`)
- [ ] 시스템 상태 확인 (`/api/admin/system/status`)
- [ ] 모든 환경 변수 설정 완료
- [ ] 데이터베이스 백업 완료
- [ ] 로컬 빌드 성공 (`npm run build`)
- [ ] 핵심 기능 테스트 완료
- [ ] 롤백 계획 수립
- [ ] 팀원에게 배포 공지

### 배포 직후 체크리스트

- [ ] 사이트 접속 확인
- [ ] Health check API 확인
- [ ] 로그인/로그아웃 테스트
- [ ] 주요 기능 테스트
- [ ] 에러 로그 확인
- [ ] 성능 메트릭 확인

---

## 🎓 초보자를 위한 팁

### 1. 작은 단위로 배포
- 한 번에 많은 변경사항을 배포하지 말 것
- 기능별로 나누어 배포

### 2. 배포 전 테스트
- 로컬에서 충분히 테스트
- 가능하면 스테이징 환경에서 테스트

### 3. 문서화
- 변경사항을 문서로 기록
- 문제 발생 시 참고할 수 있도록

### 4. 백업 습관
- 중요한 변경 전에는 반드시 백업
- 배포 전에도 백업

### 5. 점진적 개선
- 완벽하지 않아도 괜찮음
- 배포 후 피드백을 받아 개선

---

## 📞 도움 요청

**문제가 발생했을 때**:
1. 에러 로그 수집
2. Health check 결과 확인
3. 시스템 상태 확인
4. Vercel 대시보드 스크린샷
5. 문제 상황 상세 설명

**이 정보들을 모아서**:
- 개발팀에 문의
- Vercel 지원팀에 문의
- 커뮤니티에 질문

---

**안전한 배포를 위해 이 가이드를 참고하세요!** 🛡️

