# 날씨 불러오기 문제 점검 보고서

**작성일**: 2025-11-26  
**점검 대상**: 크루즈가이드 3일 체험 - 날씨 불러오기 기능  
**점검자**: AI Assistant

---

## 📋 점검 개요

크루즈가이드 앱에서 날씨 정보를 불러오지 못하는 문제를 점검하고 원인을 분석했습니다.

---

## ✅ 점검 완료 항목

### 1. 코드 구조 점검

#### 1.1 날씨 API 라이브러리 (`lib/weather.ts`)
- ✅ 파일 존재 확인
- ✅ `getWeatherForecast()` 함수 구현 확인
- ✅ `getCurrentWeather()` 함수 구현 확인
- ✅ WeatherAPI.com API 연동 코드 확인
- ✅ 에러 핸들링 구현 확인

**주요 코드**:
```45:77:lib/weather.ts
export async function getWeatherForecast(
  city: string,
  days: number = 14
): Promise<WeatherResponse | null> {
  try {
    const apiKey = process.env.WEATHER_API_KEY;
    
    if (!apiKey) {
      console.warn('[Weather] WEATHER_API_KEY가 설정되지 않았습니다.');
      return null;
    }

    // 1시간 캐시 적용 (Next.js 자동 캐싱)
    const response = await fetch(
      `https://api.weatherapi.com/v1/forecast.json?key=${apiKey}&q=${encodeURIComponent(city)}&days=${days}&lang=ko`,
      { 
        next: { revalidate: 3600 } // 1시간 캐시
      }
    );

    if (!response.ok) {
      const errorText = await response.text();
      console.error('[Weather] API 오류:', response.status, errorText);
      throw new Error(`날씨 API 요청 실패: ${response.status}`);
    }

    const data = await response.json();
    return data;
  } catch (error) {
    console.error('[Weather] 날씨 정보 가져오기 실패:', error);
    return null;
  }
}
```

#### 1.2 날씨 API Route (`app/api/weather/forecast/route.ts`)
- ✅ API Route 파일 존재 확인
- ✅ GET 핸들러 구현 확인
- ✅ 에러 핸들링 구현 확인

**주요 코드**:
```9:42:app/api/weather/forecast/route.ts
export async function GET(request: NextRequest) {
  try {
    const { searchParams } = new URL(request.url);
    const city = searchParams.get('city');
    const days = parseInt(searchParams.get('days') || '14');

    if (!city) {
      return NextResponse.json(
        { ok: false, error: '도시명(city)이 필요합니다.' },
        { status: 400 }
      );
    }

    const weatherData = await getWeatherForecast(city, days);

    if (!weatherData) {
      return NextResponse.json(
        { ok: false, error: '날씨 정보를 가져올 수 없습니다.' },
        { status: 500 }
      );
    }

    return NextResponse.json({
      ok: true,
      data: weatherData,
    });
  } catch (error: any) {
    console.error('[Weather API] 오류:', error);
    return NextResponse.json(
      { ok: false, error: error.message || '날씨 정보를 가져오는 중 오류가 발생했습니다.' },
      { status: 500 }
    );
  }
}
```

#### 1.3 DailyBriefingCard 컴포넌트 (`app/chat/components/DailyBriefingCard.tsx`)
- ✅ 날씨 모달 열기 함수 구현 확인
- ✅ API 호출 로직 확인
- ✅ 에러 핸들링 확인

**주요 코드**:
```1146:1171:app/chat/components/DailyBriefingCard.tsx
  // 날씨 모달 열기 시 실제 API 데이터 가져오기
  const handleOpenWeatherModal = async (country: string, location: string | null) => {
    setShowWeatherModal(true);
    setWeatherLoading(true);
    
    // 도시명 결정 (location이 있으면 location 사용, 없으면 country 사용)
    const cityName = location || country;
    
    try {
      // API Route를 통해 서버에서 날씨 정보 가져오기
      const response = await fetch(`/api/weather/forecast?city=${encodeURIComponent(cityName)}&days=14`);
      const result = await response.json();
      
      if (result.ok && result.data) {
        setSelectedWeatherData(result.data);
      } else {
        console.error('[DailyBriefingCard] 날씨 데이터 가져오기 실패:', result.error);
        setSelectedWeatherData(null);
      }
    } catch (error) {
      console.error('[DailyBriefingCard] 날씨 데이터 가져오기 실패:', error);
      setSelectedWeatherData(null);
    } finally {
      setWeatherLoading(false);
    }
  };
```

### 2. API 키 유효성 테스트

#### 2.1 WeatherAPI.com 직접 호출 테스트
- ✅ API 키: `8cf954892eb9405681b63201252611`
- ✅ 테스트 결과: **정상 작동**
- ✅ 서울 날씨 데이터 정상 반환 확인

**테스트 명령어**:
```bash
curl "https://api.weatherapi.com/v1/forecast.json?key=8cf954892eb9405681b63201252611&q=Seoul&days=14&lang=ko"
```

**결과**: 날씨 데이터 정상 반환 (JSON 형식)

### 3. 환경변수 확인

#### 3.1 로컬 환경
- ⚠️ `.env` 파일에서 `WEATHER_API_KEY` 확인 불가
- ⚠️ 로컬 개발 환경에서는 환경변수가 설정되지 않았을 가능성

#### 3.2 Vercel 환경변수
- ✅ 문서상 설정값: `8cf954892eb9405681b63201252611`
- ⚠️ 실제 Vercel 환경에서 설정 여부 확인 필요

---

## 🔍 문제 원인 분석

### 가능한 원인 1: 환경변수 미설정 (가장 가능성 높음)

**증상**:
- 날씨 모달을 열었을 때 "날씨 정보를 불러올 수 없습니다" 메시지 표시
- 브라우저 콘솔에 `[Weather] WEATHER_API_KEY가 설정되지 않았습니다.` 경고 메시지

**원인**:
- 로컬 개발 환경: `.env.local` 파일에 `WEATHER_API_KEY` 미설정
- Vercel 프로덕션: 환경변수 미설정 또는 잘못된 환경(Production/Preview/Development)에만 설정

**해결 방법**:
1. **로컬 개발 환경**:
   - 프로젝트 루트에 `.env.local` 파일 생성
   - 다음 내용 추가:
     ```
     WEATHER_API_KEY=8cf954892eb9405681b63201252611
     ```
   - 개발 서버 재시작

2. **Vercel 프로덕션 환경**:
   - Vercel Dashboard → Settings → Environment Variables
   - `WEATHER_API_KEY` 확인 및 설정
   - 모든 환경(Production, Preview, Development)에 설정 확인
   - 재배포 필요

### 가능한 원인 2: 도시명 인식 문제

**증상**:
- 특정 국가/도시의 날씨만 불러오지 못함
- API는 정상 작동하지만 도시명을 찾을 수 없음

**원인**:
- 한국어 도시명이 WeatherAPI.com에서 인식되지 않음
- 예: "서울" → "Seoul"로 변환 필요
- `location` 필드가 비어있거나 잘못된 형식

**해결 방법**:
- `DailyBriefingCard.tsx`의 `handleOpenWeatherModal` 함수에서 도시명 변환 로직 추가
- 한국어 도시명 → 영문 도시명 매핑 테이블 사용

### 가능한 원인 3: API 호출 제한 초과

**증상**:
- 처음에는 작동하다가 갑자기 작동하지 않음
- API 응답에서 403 또는 429 에러

**원인**:
- WeatherAPI.com 무료 플랜: 하루 1,000회 제한
- 제한 초과 시 API 호출 실패

**해결 방법**:
1. WeatherAPI.com Dashboard에서 호출량 확인
2. 캐싱 시간 증가 (현재 1시간 → 3시간)
3. 호출량 모니터링 추가

### 가능한 원인 4: 네트워크/CORS 문제

**증상**:
- 브라우저 콘솔에 CORS 에러 또는 네트워크 에러
- `fetch` 요청 실패

**원인**:
- 서버 사이드에서 외부 API 호출 시 네트워크 문제
- Vercel 서버 지역 문제

**해결 방법**:
- Vercel 로그에서 네트워크 에러 확인
- API Route에서 더 자세한 에러 로깅 추가

---

## 🛠️ 권장 해결 방법

### 즉시 조치 사항

#### 1. 환경변수 확인 및 설정 (최우선)

**로컬 개발 환경**:
```bash
# 프로젝트 루트에 .env.local 파일 생성
echo "WEATHER_API_KEY=8cf954892eb9405681b63201252611" > .env.local
```

**Vercel 프로덕션**:
1. Vercel Dashboard 접속
2. 프로젝트 선택 → Settings → Environment Variables
3. `WEATHER_API_KEY` 확인:
   - Key: `WEATHER_API_KEY`
   - Value: `8cf954892eb9405681b63201252611`
   - Environment: **Production, Preview, Development 모두 선택**
4. 저장 후 재배포

#### 2. 브라우저 콘솔 확인

날씨 모달을 열 때 브라우저 개발자 도구(F12)에서 다음 확인:
- Console 탭: 에러 메시지 확인
- Network 탭: `/api/weather/forecast` 요청 상태 확인

**예상되는 에러 메시지**:
- `[Weather] WEATHER_API_KEY가 설정되지 않았습니다.` → 환경변수 미설정
- `[Weather] API 오류: 401` → API 키 오류
- `[Weather] API 오류: 400` → 도시명 오류
- `[Weather] API 오류: 403` → 호출 제한 초과

#### 3. API Route 직접 테스트

브라우저에서 다음 URL 직접 접속:
```
http://localhost:3000/api/weather/forecast?city=Seoul&days=14
```

**성공 시**: JSON 형식의 날씨 데이터 반환  
**실패 시**: 에러 메시지 확인

---

## 📊 점검 결과 요약

| 항목 | 상태 | 비고 |
|------|------|------|
| 코드 구조 | ✅ 정상 | 모든 파일 존재 및 구현 완료 |
| API 키 유효성 | ✅ 정상 | 직접 테스트 성공 |
| 환경변수 설정 | ⚠️ 확인 필요 | 로컬 미설정, Vercel 확인 필요 |
| API Route | ✅ 정상 | 구현 완료 |
| 에러 핸들링 | ✅ 정상 | 적절한 에러 처리 구현 |

---

## 🔧 추가 개선 사항

### 1. 에러 메시지 개선

현재 사용자에게 표시되는 에러 메시지가 부족할 수 있습니다. 다음 개선 권장:

```typescript
// DailyBriefingCard.tsx의 handleOpenWeatherModal 함수 개선
if (result.ok && result.data) {
  setSelectedWeatherData(result.data);
} else {
  // 사용자에게 더 명확한 에러 메시지 표시
  const errorMessage = result.error || '날씨 정보를 불러올 수 없습니다.';
  alert(`날씨 정보를 불러오는 중 오류가 발생했습니다: ${errorMessage}`);
  console.error('[DailyBriefingCard] 날씨 데이터 가져오기 실패:', result.error);
  setSelectedWeatherData(null);
}
```

### 2. 로딩 상태 개선

날씨 모달에서 로딩 중임을 더 명확하게 표시:

```typescript
{weatherLoading ? (
  <div className="flex items-center justify-center p-8">
    <div className="text-center">
      <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
      <p className="text-gray-600">날씨 정보를 불러오는 중...</p>
    </div>
  </div>
) : (
  // 날씨 데이터 표시
)}
```

### 3. 도시명 변환 로직 추가

한국어 도시명을 영문으로 변환하는 매핑 테이블 추가:

```typescript
const cityNameMapping: { [key: string]: string } = {
  '서울': 'Seoul',
  '부산': 'Busan',
  '도쿄': 'Tokyo',
  '오사카': 'Osaka',
  // ... 추가 매핑
};

const getCityName = (koreanName: string): string => {
  return cityNameMapping[koreanName] || koreanName;
};
```

---

## ✅ 체크리스트

### 즉시 확인 사항
- [ ] 로컬 `.env.local` 파일에 `WEATHER_API_KEY` 설정
- [ ] Vercel 환경변수에 `WEATHER_API_KEY` 설정 확인
- [ ] 브라우저 콘솔에서 에러 메시지 확인
- [ ] API Route 직접 테스트 (`/api/weather/forecast?city=Seoul`)

### 추가 개선 사항
- [ ] 에러 메시지 개선
- [ ] 로딩 상태 UI 개선
- [ ] 도시명 변환 로직 추가
- [ ] API 호출량 모니터링 추가

---

## 📝 결론

**코드 구조는 정상이며, API 키도 유효합니다.**

**가장 가능성 높은 원인**: 환경변수(`WEATHER_API_KEY`) 미설정

**즉시 조치**:
1. 로컬 개발 환경: `.env.local` 파일 생성 및 환경변수 설정
2. Vercel 프로덕션: 환경변수 확인 및 재배포
3. 브라우저 콘솔에서 실제 에러 메시지 확인

**예상 해결 시간**: 5-10분 (환경변수 설정 후)

---

## 📞 추가 지원

문제가 지속될 경우 다음 정보를 확인해주세요:
1. 브라우저 콘솔의 에러 메시지 (전체)
2. Network 탭의 `/api/weather/forecast` 요청 상태 코드
3. Vercel 로그의 에러 메시지 (있는 경우)

이 정보를 바탕으로 더 정확한 진단이 가능합니다.

