# 계약서 PDF 생성 및 전송 상세 테스트 가이드

## 📋 목차
1. [테스트 준비](#테스트-준비)
2. [대리점장 대시보드에서 테스트](#대리점장-대시보드에서-테스트)
3. [관리자 패널에서 테스트](#관리자-패널에서-테스트)
4. [PDF 생성 확인 방법](#pdf-생성-확인-방법)
5. [이메일 전송 확인 방법](#이메일-전송-확인-방법)
6. [문제 해결](#문제-해결)

---

## 테스트 준비

### 1. 테스트 계정 준비
- **대리점장**: `boss1` / `1101`
- **판매원**: `user1` / `1101`
- **관리자**: `01024958013` / `0313` 또는 `01038609161` / `0313`

### 2. 테스트 계약서 준비
계약서가 있어야 테스트할 수 있습니다. 없으면:
1. 대리점장 대시보드에서 "계약서 보내기" 클릭
2. 판매원 계약서 작성 및 제출
3. 서명 완료

---

## 대리점장 대시보드에서 테스트

### 단계별 테스트

#### 1단계: 대리점장 로그인
```
1. 브라우저에서 http://localhost:3001/partner 접속
2. 아이디: boss1
3. 비밀번호: 1101
4. 로그인
```

#### 2단계: 계약서 관리 섹션 확인
```
1. 대시보드에서 아래로 스크롤
2. "계약서 관리" 섹션 찾기
3. 제출된 계약서 목록 확인
   - 계약자 이름
   - 연락처
   - 이메일
   - 상태: "제출됨" (노란색 배지)
```

#### 3단계: 완료 승인 실행
```
1. "완료 승인 (PDF 전송)" 버튼 클릭
2. 성공 메시지 확인: "계약서가 완료되었고 이메일로 전송되었습니다."
3. 계약서 상태가 "완료됨" (초록색 배지)로 변경되는지 확인
```

#### 4단계: 서버 로그 확인
터미널에서 다음 로그를 찾으세요:
```
[Contract PDF] 이메일 전송 성공: {이메일주소} (계약서 ID: {contractId})
```

**확인 방법:**
1. 개발 서버가 실행 중인 터미널 창 확인
2. 버튼 클릭 후 로그 메시지 확인
3. 에러가 있으면 빨간색 에러 메시지 확인

---

## 관리자 패널에서 테스트

### 단계별 테스트

#### 1단계: 관리자 로그인
```
1. 브라우저에서 http://localhost:3001/admin 접속
2. 전화번호: 01024958013
3. 비밀번호: 0313
4. 로그인
```

#### 2단계: 계약서 목록 확인
```
1. 왼쪽 메뉴에서 "어필리에이트" > "계약서 관리" 클릭
2. 또는 직접 접속: http://localhost:3001/admin/affiliate/contracts
3. 계약서 목록 확인
```

#### 3단계: 계약서 완료 승인 테스트
```
1. 상태가 "제출됨"인 계약서 찾기
2. "완료 승인" 버튼 클릭 (파란색 버튼, FiFileText 아이콘)
3. 확인 대화상자에서 "확인" 클릭
4. 성공 메시지 확인
```

#### 4단계: 아이디 생성 승인 테스트
```
1. 상태가 "제출됨" 또는 "완료됨"인 계약서 찾기
2. "아이디 생성" 버튼 클릭 (초록색 버튼, FiCheckCircle 아이콘)
3. 확인 대화상자에서 "확인" 클릭
4. 성공 메시지 확인: "계약이 승인되었고 아이디와 비밀번호가 생성되었습니다."
```

---

## PDF 생성 확인 방법

### 방법 1: 파일 시스템에서 확인

#### 1단계: 파일 경로 확인
```
프로젝트 루트 디렉토리:
/home/userhyeseon28/projects/cruise-guide/public/contracts/pdfs/
```

#### 2단계: 파일 목록 확인
터미널에서 다음 명령어 실행:
```bash
cd /home/userhyeseon28/projects/cruise-guide
ls -lh public/contracts/pdfs/
```

**예상 출력:**
```
contract-1-1234567890.pdf
contract-2-1234567891.pdf
```

#### 3단계: PDF 파일 열기
```bash
# 파일이 있으면 PDF 뷰어로 열기
xdg-open public/contracts/pdfs/contract-{contractId}-{timestamp}.pdf
```

또는 파일 탐색기에서:
```
1. 프로젝트 폴더 열기
2. public > contracts > pdfs 폴더로 이동
3. PDF 파일 더블클릭하여 열기
```

#### 4단계: PDF 내용 확인
PDF를 열어서 다음을 확인:
- ✅ 계약자 이름이 올바른가?
- ✅ 연락처가 올바른가?
- ✅ 서명 이미지가 포함되어 있는가?
- ✅ 계약서 정보가 정확한가?

---

### 방법 2: 브라우저에서 직접 확인

#### 1단계: PDF URL 확인
서버 로그에서 생성된 PDF의 URL을 확인하거나, 다음 형식으로 접근:
```
http://localhost:3001/contracts/pdfs/contract-{contractId}-{timestamp}.pdf
```

#### 2단계: 브라우저에서 열기
```
1. 새 탭 열기
2. 위 URL 입력
3. PDF가 표시되는지 확인
```

---

## 이메일 전송 확인 방법

### 방법 1: 실제 이메일 수신 확인

#### 1단계: 계약서에 등록된 이메일 확인
```
1. 관리자 패널에서 계약서 상세 보기
2. "이메일" 필드 확인
3. 또는 대리점장 대시보드에서 계약서 목록의 이메일 확인
```

#### 2단계: 이메일 수신함 확인
```
1. 해당 이메일 주소로 로그인
2. 받은편지함 확인
3. 스팸함도 확인 (중요!)
```

#### 3단계: 이메일 내용 확인
확인할 내용:
- ✅ 제목: `[계약서 완료] 어필리에이트 계약서`
- ✅ 발신자: 설정한 이메일 주소
- ✅ 첨부파일: `계약서_{이름}_{날짜}.pdf`
- ✅ 본문: 계약서 완료 안내 메시지

---

### 방법 2: 서버 로그로 확인

#### 1단계: 터미널에서 로그 확인
개발 서버가 실행 중인 터미널에서 다음 메시지를 찾으세요:

**성공 메시지:**
```
[Contract PDF] 이메일 전송 성공: test@example.com (계약서 ID: 1)
```

**실패 메시지:**
```
[Contract PDF] 이메일 전송 실패 (계약서 ID: 1): {에러 메시지}
```

#### 2단계: 로그 위치 확인
- 개발 서버 터미널 창
- 또는 로그 파일 (있는 경우)

---

### 방법 3: 테스트 이메일 주소 사용

#### Gmail 테스트 계정 사용
```
1. Gmail 테스트 계정 생성
2. 계약서 작성 시 해당 이메일 입력
3. Gmail에서 수신 확인
```

#### 이메일 서비스 설정 확인
환경 변수 파일 (`.env.local`) 확인:
```bash
EMAIL_SMTP_HOST=smtp.gmail.com
EMAIL_SMTP_PORT=587
EMAIL_SMTP_USER=your-email@gmail.com
EMAIL_SMTP_PASSWORD=your-app-password
```

---

## 실제 테스트 시나리오

### 시나리오 1: 대리점장이 계약서 완료 승인

#### 준비
1. 대리점장 로그인: `boss1` / `1101`
2. 판매원 계약서가 제출되어 있어야 함

#### 실행
```
1. 대리점장 대시보드 접속
2. "계약서 관리" 섹션으로 스크롤
3. 제출된 계약서 확인
4. "완료 승인 (PDF 전송)" 버튼 클릭
```

#### 확인
```
✅ 성공 메시지 표시
✅ 계약서 상태가 "완료됨"으로 변경
✅ 터미널에 성공 로그 표시
✅ 이메일 수신 확인
✅ PDF 파일 생성 확인
```

---

### 시나리오 2: 관리자가 계약서 완료 승인

#### 준비
1. 관리자 로그인
2. 제출된 계약서 확인

#### 실행
```
1. 관리자 패널 > 어필리에이트 > 계약서 관리
2. 제출된 계약서 찾기
3. "완료 승인" 버튼 클릭 (파란색)
```

#### 확인
```
✅ 성공 메시지 표시
✅ 계약서 상태가 "완료됨"으로 변경
✅ 터미널에 성공 로그 표시
✅ 이메일 수신 확인
```

---

### 시나리오 3: 관리자가 아이디 생성 승인

#### 준비
1. 관리자 로그인
2. 제출된 또는 완료된 계약서 확인

#### 실행
```
1. 관리자 패널 > 어필리에이트 > 계약서 관리
2. 계약서 찾기
3. "아이디 생성" 버튼 클릭 (초록색)
```

#### 확인
```
✅ 성공 메시지 표시
✅ 계약서 상태가 "승인됨"으로 변경
✅ 생성된 아이디 확인 (boss1, user1 등)
✅ 비밀번호 확인 (1101)
```

---

## 문제 해결

### 문제 1: PDF가 생성되지 않음

#### 확인 사항
1. Puppeteer 설치 확인:
```bash
npm list puppeteer
```

2. 서버 로그에서 에러 확인:
```
[Contract PDF] error: ...
```

3. 파일 디렉토리 권한 확인:
```bash
ls -la public/contracts/
```

#### 해결 방법
```bash
# 디렉토리 생성
mkdir -p public/contracts/pdfs
chmod 755 public/contracts/pdfs
```

---

### 문제 2: 이메일이 전송되지 않음

#### 확인 사항
1. 환경 변수 확인:
```bash
cat .env.local | grep EMAIL
```

2. 서버 로그에서 에러 확인:
```
[Contract PDF] 이메일 전송 실패: ...
```

#### 해결 방법
1. 이메일 설정 확인:
   - Gmail 사용 시: 앱 비밀번호 생성 필요
   - SMTP 서버 주소 확인
   - 포트 번호 확인 (587 또는 465)

2. 테스트 이메일 발송:
```bash
# Node.js로 간단한 테스트
node -e "
const nodemailer = require('nodemailer');
const transporter = nodemailer.createTransport({
  host: process.env.EMAIL_SMTP_HOST,
  port: process.env.EMAIL_SMTP_PORT,
  auth: {
    user: process.env.EMAIL_SMTP_USER,
    pass: process.env.EMAIL_SMTP_PASSWORD
  }
});
transporter.sendMail({
  from: process.env.EMAIL_SMTP_USER,
  to: 'test@example.com',
  subject: 'Test',
  text: 'Test email'
}).then(() => console.log('Success')).catch(console.error);
"
```

---

### 문제 3: 계약서 목록이 표시되지 않음

#### 확인 사항
1. 대리점장 계정으로 로그인했는지 확인
2. 브라우저 콘솔에서 에러 확인 (F12)
3. 네트워크 탭에서 API 응답 확인

#### 해결 방법
1. 브라우저 개발자 도구 열기 (F12)
2. Console 탭에서 에러 확인
3. Network 탭에서 `/api/partner/contracts` 요청 확인
4. 응답 상태 코드 확인 (200이어야 함)

---

## 빠른 확인 체크리스트

### ✅ PDF 생성 확인
- [ ] 터미널에 성공 로그 표시
- [ ] `public/contracts/pdfs/` 폴더에 PDF 파일 생성됨
- [ ] PDF 파일을 열어서 내용 확인 가능
- [ ] 서명 이미지가 PDF에 포함되어 있음

### ✅ 이메일 전송 확인
- [ ] 터미널에 성공 로그 표시
- [ ] 이메일 수신함에서 확인 가능
- [ ] 첨부파일(PDF)이 포함되어 있음
- [ ] 이메일 제목이 올바름

### ✅ 기능 작동 확인
- [ ] 대리점장 대시보드에서 완료 승인 버튼 작동
- [ ] 관리자 패널에서 완료 승인 버튼 작동
- [ ] 관리자 패널에서 아이디 생성 버튼 작동
- [ ] 판매원/대리점장 자신의 계약서 보관 작동

---

## 실전 테스트 예시

### 예시 1: 전체 플로우 테스트

```
1. 대리점장(boss1) 로그인
   → 대시보드에서 "계약서 보내기" 클릭
   → 판매원 계약서 작성 및 제출

2. 판매원(user1) 로그인
   → 계약서 서명 완료

3. 대리점장(boss1) 로그인
   → "계약서 관리" 섹션에서 "완료 승인" 클릭
   → 터미널 로그 확인: "[Contract PDF] 이메일 전송 성공"
   → 이메일 수신 확인

4. 관리자 로그인
   → 계약서 관리에서 "아이디 생성" 클릭
   → 아이디/비밀번호 생성 확인
```

---

## 디버깅 팁

### 터미널 로그 확인 명령어
```bash
# 실시간 로그 확인 (개발 서버 실행 중)
# 로그는 자동으로 터미널에 표시됨

# 특정 키워드로 필터링 (다른 터미널에서)
tail -f /path/to/logfile | grep "Contract PDF"
```

### 브라우저 개발자 도구 사용
```
1. F12 키 누르기
2. Console 탭: JavaScript 에러 확인
3. Network 탭: API 요청/응답 확인
   - /api/partner/contracts/{id}/complete 요청 확인
   - 응답 상태 코드 확인 (200 = 성공)
   - 응답 내용 확인
```

### 파일 시스템 확인
```bash
# PDF 파일 목록 확인
ls -lh public/contracts/pdfs/

# 최근 생성된 파일 확인
ls -lht public/contracts/pdfs/ | head -5

# 파일 크기 확인 (0이면 생성 실패)
du -h public/contracts/pdfs/*.pdf
```

---

## 성공 기준

### ✅ 모든 것이 정상 작동하는 경우:
1. 버튼 클릭 시 성공 메시지 표시
2. 터미널에 성공 로그 표시
3. PDF 파일이 생성됨
4. 이메일이 전송됨
5. 계약서 상태가 올바르게 변경됨

### ❌ 문제가 있는 경우:
1. 에러 메시지 확인
2. 터미널 로그 확인
3. 브라우저 콘솔 확인
4. 위의 "문제 해결" 섹션 참고

---

## 추가 도움말

### 이메일이 오지 않는 경우
1. 스팸함 확인
2. 이메일 주소 오타 확인
3. 이메일 서버 설정 확인
4. 환경 변수 확인

### PDF가 생성되지 않는 경우
1. Puppeteer 설치 확인
2. 디렉토리 권한 확인
3. 서버 로그에서 에러 확인
4. 디스크 공간 확인

### 버튼이 작동하지 않는 경우
1. 브라우저 콘솔에서 에러 확인
2. 네트워크 탭에서 API 요청 확인
3. 권한 확인 (대리점장만 완료 승인 가능)
4. 계약서 상태 확인 (제출됨 상태여야 함)






