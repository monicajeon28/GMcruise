# 계약 해지 및 DB 회수 시스템 - 비즈니스 리스크 분석

## 🔴 Critical 리스크 (즉시 수정 필요)

### 1. **트랜잭션 부족 - 데이터 무결성 위험**
**문제**: DB 회수 로직이 여러 개별 쿼리로 이루어져 있어, 중간에 실패하면 데이터 불일치 발생
```typescript
// 현재: 개별 쿼리들
for (const lead of leads) {
  await prisma.affiliateLead.update(...); // 실패 시 이전 업데이트는 롤백 안됨
}
for (const sale of sales) {
  await prisma.affiliateSale.update(...);
}
await prisma.affiliateContract.update(...); // 마지막에 실패하면 모든 변경사항이 반영됨
```

**영향**: 
- 일부 Lead는 회수되었는데 Sale은 회수 안됨
- 계약서는 `dbRecovered: true`인데 실제 DB는 회수 안됨
- 데이터 복구 불가능

**해결책**: `prisma.$transaction`으로 전체 작업을 원자적으로 처리

---

### 2. **CommissionLedger 처리 누락 - 재무 리스크**
**문제**: 이미 지급된 수당(`CommissionLedger`)에 대한 처리가 없음

**영향**:
- 해지된 판매원/대리점장에게 이미 지급된 수당이 그대로 남음
- 수당 정산 시 잘못된 금액 계산
- 회계 오류 및 법적 문제 가능

**해결책**:
- `CommissionLedger`에서 해지된 계약의 수당 항목 마킹
- 미지급 수당은 취소, 이미 지급된 수당은 회수 또는 차감 처리
- 재무팀과 협의하여 정책 수립 필요

---

### 3. **AffiliateLink 처리 누락 - 추적 불가**
**문제**: `AffiliateLink`의 `managerId`/`agentId`가 업데이트되지 않음

**영향**:
- 기존 링크로 들어온 고객이 해지된 판매원/대리점장에게 귀속됨
- 새로운 구매가 잘못된 수당 구조로 생성됨
- 링크 추적 및 분석 데이터 왜곡

**해결책**: DB 회수 시 `AffiliateLink`도 함께 업데이트
```typescript
await prisma.affiliateLink.updateMany({
  where: { agentId: agentProfileId },
  data: { agentId: null, managerId: managerProfileId }
});
```

---

## 🟡 High 리스크 (우선 수정 권장)

### 4. **동시성 문제 - 중복 처리**
**문제**: 같은 계약서에 대해 여러 번 DB 회수 시도 가능

**영향**:
- 스케줄러와 즉시 회수가 동시 실행되면 중복 처리
- 데이터 중복 업데이트로 인한 성능 저하
- 로그 혼란

**해결책**: 
- `dbRecovered` 체크를 더 엄격하게 (트랜잭션 내에서)
- 분산 락 또는 DB 레벨 락 사용

---

### 5. **수당 중복 지급 가능성**
**문제**: 본사 전환 시 판매원 수당 + 오버라이딩 수당이 중복 지급될 수 있음
```typescript
// 현재 로직
if (finalProfileType === 'HQ') {
  if (finalAgentId) {
    salesCommission = Math.floor(netRevenue * 0.033); // 판매원 수당
    overrideCommission = Math.floor(netRevenue * 0.033); // 오버라이딩
    // 총 6.6% 지급됨! (의도는 3.3%일 수도)
  }
}
```

**영향**: 
- 수당 과다 지급으로 인한 재무 손실
- 비즈니스 로직 오류

**해결책**: 
- 수당 정책 명확화 (판매원이 본사 소속일 때 수당 구조)
- 비즈니스 요구사항 확인 필요

---

### 6. **대리점장 해지 시 판매원 계약 상태 미확인**
**문제**: 대리점장이 해지되면 판매원들의 계약 상태도 확인해야 함

**영향**:
- 해지된 판매원이 본사 소속으로 전환됨 (의도와 다를 수 있음)
- 판매원 계약도 함께 해지해야 하는지 불명확

**해결책**: 
- 비즈니스 정책 수립 (대리점장 해지 시 판매원 계약도 함께 해지? 유지?)
- 판매원 계약 상태 확인 로직 추가

---

## 🟢 Medium 리스크 (모니터링 필요)

### 7. **에러 복구 메커니즘 부족**
**문제**: DB 회수 실패 시 재시도 메커니즘이 없음

**영향**:
- 일시적 네트워크 오류로 인한 실패 시 수동 개입 필요
- 실패한 작업 추적 어려움

**해결책**: 
- 재시도 로직 추가 (exponential backoff)
- 실패한 작업을 별도 테이블에 기록하여 관리자 알림

---

### 8. **감사 로그 부족**
**문제**: DB 회수 작업에 대한 상세한 감사 로그가 부족

**영향**:
- 문제 발생 시 원인 추적 어려움
- 규정 준수(compliance) 문제

**해결책**: 
- `AdminActionLog`에 DB 회수 작업 기록
- 회수된 데이터 양, 영향받은 레코드 수 등 상세 정보 기록

---

### 9. **성능 이슈 가능성**
**문제**: 대량의 Lead/Sale을 개별 업데이트
```typescript
for (const lead of leads) {
  await prisma.affiliateLead.update(...); // N번 쿼리
}
```

**영향**:
- 대량 데이터 회수 시 느린 처리 속도
- DB 부하 증가

**해결책**: 
- `updateMany` 사용 (단, metadata 업데이트는 제한적)
- 배치 처리로 나누어 실행

---

### 10. **HQ 프로필 없음 시 처리**
**문제**: HQ 프로필이 없으면 DB 회수 실패

**영향**:
- 시스템 초기 설정 시 오류
- HQ 프로필 삭제 시 전체 시스템 마비

**해결책**: 
- HQ 프로필 생성 검증 로직 추가
- HQ 프로필 없을 때 에러 알림 및 수동 처리 가이드

---

## 📋 권장 수정 순서

1. **즉시**: 트랜잭션 처리 추가 (Critical #1)
2. **즉시**: AffiliateLink 처리 추가 (Critical #3)
3. **1주일 내**: CommissionLedger 처리 정책 수립 및 구현 (Critical #2)
4. **2주일 내**: 동시성 문제 해결 (High #4)
5. **2주일 내**: 수당 중복 지급 로직 검토 및 수정 (High #5)
6. **1개월 내**: 나머지 Medium 리스크 해결

---

## 💡 추가 고려사항

### 비즈니스 정책 명확화 필요
1. **대리점장 해지 시 판매원 계약**: 함께 해지? 유지?
2. **본사 소속 판매원 수당 구조**: 판매원 수당 + 오버라이딩? 오버라이딩만?
3. **이미 지급된 수당**: 회수? 차감? 유지?
4. **DB 회수 후 복구**: 가능? 불가능?

### 모니터링 지표
- DB 회수 성공률
- DB 회수 소요 시간
- 영향받은 레코드 수
- 실패한 회수 작업 수


