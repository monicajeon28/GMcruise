# 크루즈가이드 지니 3일체험 로그인 문제 분석 보고서

## 📋 문제 요약
- **페이지**: `/login-test` (http://localhost:3001/login-test)
- **증상**: 새로운 이름, 연락처, 비밀번호 1101을 입력했는데 로그인이 안됨
- **요구사항**: 
  1. 잠재고객 모집용도로 사용
  2. 어떤 이름, 연락처를 입력해도 중복이면 수정 가능하고 무조건 로그인 가능해야 함
  3. 비밀번호 1101이면 가볍게 로그인 가능해야 함

---

## 🔍 문제 원인 분석

### 1. 핵심 문제: 기존 사용자 조회 조건이 너무 엄격함

**위치**: `app/api/auth/login/route.ts` 371-376번 줄

```typescript
let testUser = await prisma.user.findFirst({
  where: {
    phone: phone || undefined,
    password: { in: TEST_MODE_PASSWORDS },  // ❌ 문제: 비밀번호도 조건에 포함
    role: 'user',
  },
  // ...
});
```

**문제점**:
- 기존 사용자를 찾을 때 `phone`과 `password`를 모두 조건으로 사용
- 새로운 이름/연락처로 로그인 시도 시, 기존에 다른 비밀번호를 가진 사용자가 있으면 찾지 못함
- 예: 기존 사용자가 `phone: "01012345678"`, `password: "3800"`인 경우, `password: "1101"`로 조회하면 찾지 못함

### 2. 중복 처리 로직의 한계

**위치**: `app/api/auth/login/route.ts` 421-433번 줄

```typescript
} else {
  // 기존 사용자: 이름/전화번호 업데이트 (입력한 값으로 업데이트)
  if (testUser.name !== name || testUser.phone !== phone) {
    await prisma.user.update({
      where: { id: testUser.id },
      data: {
        name: name || testUser.name,
        phone: phone || testUser.phone,
      },
    });
    // ...
  }
}
```

**문제점**:
- 기존 사용자를 찾지 못하면 이 업데이트 로직이 실행되지 않음
- 전화번호가 같지만 비밀번호가 다른 경우, 기존 사용자를 찾지 못해 새로 생성하려고 시도
- 새로 생성 시도 중 전화번호 중복 에러가 발생할 수 있음

### 3. 요구사항과의 불일치

**요구사항**:
- "어떠한 이름, 연락처를 입력해도 그게 중복이라면 수정으로도 가능하고 무조건 로그인 가능해야해"

**현재 동작**:
- 전화번호로만 사용자를 찾고, 비밀번호도 조건에 포함
- 전화번호가 같지만 비밀번호가 다른 경우 기존 사용자를 찾지 못함
- 결과적으로 중복된 전화번호로 새 사용자 생성 시도 → 에러 발생 가능

---

## 🛠️ 해결 방안

### 수정 전략

1. **기존 사용자 조회 조건 완화**
   - 전화번호(`phone`)만으로 기존 사용자 조회
   - 비밀번호 조건 제거 (테스트 모드에서는 비밀번호 1101이면 무조건 허용)

2. **중복 처리 개선**
   - 전화번호로 사용자를 찾으면, 비밀번호를 1101로 업데이트
   - 이름도 입력한 값으로 업데이트 (중복이면 수정)

3. **에러 처리 강화**
   - 사용자 생성 시 중복 에러 발생 시, 기존 사용자를 찾아서 업데이트

### 구체적 수정 사항

#### 수정 1: 기존 사용자 조회 조건 변경

**현재 코드** (371-376번 줄):
```typescript
let testUser = await prisma.user.findFirst({
  where: {
    phone: phone || undefined,
    password: { in: TEST_MODE_PASSWORDS },  // ❌ 제거 필요
    role: 'user',
  },
  // ...
});
```

**수정 후**:
```typescript
let testUser = await prisma.user.findFirst({
  where: {
    phone: phone || undefined,
    role: 'user',
    // password 조건 제거 - 전화번호만으로 조회
  },
  // ...
});
```

#### 수정 2: 기존 사용자 업데이트 로직 개선

**현재 코드** (421-433번 줄):
```typescript
} else {
  // 기존 사용자: 이름/전화번호 업데이트
  if (testUser.name !== name || testUser.phone !== phone) {
    await prisma.user.update({
      where: { id: testUser.id },
      data: {
        name: name || testUser.name,
        phone: phone || testUser.phone,
      },
    });
    // ...
  }
}
```

**수정 후**:
```typescript
} else {
  // 기존 사용자: 이름/전화번호/비밀번호 업데이트 (중복이면 수정)
  await prisma.user.update({
    where: { id: testUser.id },
    data: {
      name: name || testUser.name,  // 입력한 이름으로 업데이트
      phone: phone || testUser.phone,  // 입력한 전화번호로 업데이트
      password: normalizedTestPassword,  // 비밀번호를 1101로 업데이트
    },
  });
  testUser.name = name || testUser.name;
  testUser.phone = phone || testUser.phone;
  testUser.password = normalizedTestPassword;
}
```

#### 수정 3: 사용자 생성 실패 시 중복 처리

**현재 코드** (397-420번 줄):
```typescript
if (!testUser) {
  console.log('[Login] 테스트 모드 신규 사용자 생성 시작');
  const now = new Date();
  const newUser = await prisma.user.create({
    data: {
      name: name || '3일체험고객',
      phone: phone || `test-${Date.now()}`,
      password: normalizedTestPassword,
      // ...
    },
  });
  testUser = newUser;
}
```

**수정 후**:
```typescript
if (!testUser) {
  console.log('[Login] 테스트 모드 신규 사용자 생성 시작');
  const now = new Date();
  try {
    const newUser = await prisma.user.create({
      data: {
        name: name || '3일체험고객',
        phone: phone || `test-${Date.now()}`,
        password: normalizedTestPassword,
        // ...
      },
    });
    testUser = newUser;
  } catch (createError: any) {
    // 중복 키 에러인 경우 (전화번호 중복)
    if (createError?.code === 'P2002') {
      console.log('[Login] 전화번호 중복, 기존 사용자 조회 및 업데이트');
      // 전화번호로 다시 조회
      testUser = await prisma.user.findFirst({
        where: {
          phone: phone || undefined,
          role: 'user',
        },
        // ...
      });
      
      if (testUser) {
        // 기존 사용자 업데이트
        await prisma.user.update({
          where: { id: testUser.id },
          data: {
            name: name || testUser.name,
            phone: phone || testUser.phone,
            password: normalizedTestPassword,
          },
        });
        testUser.name = name || testUser.name;
        testUser.phone = phone || testUser.phone;
        testUser.password = normalizedTestPassword;
      } else {
        throw createError; // 다른 에러면 그대로 throw
      }
    } else {
      throw createError; // 다른 에러면 그대로 throw
    }
  }
}
```

---

## ✅ 수정 후 예상 동작

1. **새로운 이름, 연락처, 비밀번호 1101 입력 시**:
   - 전화번호로 기존 사용자 조회
   - 없으면 새로 생성 → ✅ 로그인 성공
   - 있으면 이름/비밀번호 업데이트 → ✅ 로그인 성공

2. **중복된 전화번호, 다른 이름/비밀번호 입력 시**:
   - 전화번호로 기존 사용자 찾음
   - 이름과 비밀번호를 입력한 값으로 업데이트 → ✅ 로그인 성공

3. **어떤 경우든 비밀번호 1101이면**:
   - 무조건 로그인 가능 → ✅ 요구사항 충족

---

## 📝 수정 우선순위

1. **높음**: 기존 사용자 조회 조건 변경 (비밀번호 조건 제거)
2. **높음**: 기존 사용자 업데이트 로직 개선 (비밀번호도 업데이트)
3. **중간**: 사용자 생성 실패 시 중복 처리 추가

---

## ✅ 수정 완료 사항

### 1. 기존 사용자 조회 조건 완화 ✅
- **수정 전**: `phone`과 `password` 모두 조건으로 사용
- **수정 후**: `phone`만으로 조회 (비밀번호 조건 제거)
- **효과**: 전화번호가 같으면 어떤 비밀번호든 1101로 업데이트 가능

### 2. 기존 사용자 업데이트 로직 개선 ✅
- **수정 전**: 이름/전화번호만 업데이트, 비밀번호는 업데이트 안함
- **수정 후**: 이름/전화번호/비밀번호 모두 입력한 값으로 업데이트
- **효과**: 중복된 전화번호로 로그인해도 정보가 업데이트되고 로그인 성공

### 3. 전화번호 중복 에러 처리 추가 ✅
- **수정 전**: `create` 실패 시 에러 발생
- **수정 후**: `P2002` (중복 키) 에러 발생 시 기존 사용자 찾아서 업데이트
- **효과**: 잘못된 전화번호 입력 후 올바른 정보로 다시 입력해도 정상 작동

### 4. customerStatus/customerSource 처리 개선 ✅
- **수정 전**: 항상 `customerStatus: 'test'`, `customerSource: 'test-guide'`로 강제 설정
- **수정 후**: 
  - `customerStatus`: 기존 값 유지 (구매고객이면 'active' 유지)
  - `customerSource`: 기존 값 유지 (구매고객이면 'cruise-guide' 유지)
- **효과**: 구매고객이 3일체험을 해도 기존 상태 유지, 오류 없음

---

## 🎯 최종 동작 시나리오

### 시나리오 1: 새로운 이름, 연락처, 비밀번호 1101 입력
1. 전화번호로 기존 사용자 조회 → 없음
2. 새 사용자 생성 → ✅ 로그인 성공

### 시나리오 2: 구매고객이 3일체험 입력
1. 전화번호로 기존 사용자 조회 → 찾음 (customerStatus: 'active', customerSource: 'cruise-guide')
2. 이름/비밀번호 업데이트 (customerStatus/customerSource 유지) → ✅ 로그인 성공
3. 결과: 구매고객 상태 유지 + 3일체험 활성화

### 시나리오 3: 잘못된 전화번호 입력 후 올바른 정보로 재입력
1. 첫 번째 시도: 잘못된 전화번호로 새 사용자 생성 시도
2. 두 번째 시도: 올바른 전화번호 입력
   - 전화번호로 기존 사용자 조회 → 없음
   - 새 사용자 생성 → ✅ 로그인 성공
3. 또는: 전화번호 중복 에러 발생 시 기존 사용자 찾아서 업데이트 → ✅ 로그인 성공

### 시나리오 4: 중복된 전화번호, 다른 이름/비밀번호 입력
1. 전화번호로 기존 사용자 조회 → 찾음
2. 이름/비밀번호를 입력한 값으로 업데이트 → ✅ 로그인 성공

---

## 🔒 핵심 원칙 (모든 시나리오 공통)

**비밀번호 1101이면 무조건 로그인 가능** ✅
- 전화번호만으로 기존 사용자 조회
- 기존 사용자가 있으면 비밀번호를 1101로 업데이트
- 기존 사용자가 없으면 새로 생성 (비밀번호 1101)
- 전화번호 중복 에러 발생 시에도 기존 사용자 찾아서 업데이트

---

## 📝 수정 완료

모든 수정 사항이 적용되었습니다. 이제 어떤 이름, 연락처를 입력하고 비밀번호 1101을 입력하면 무조건 로그인 가능합니다.

