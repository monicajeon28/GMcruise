# 정액제 결제 플로우 시뮬레이션 및 테스트 가이드

## 📋 개요

정액제 결제 시스템의 전체 플로우를 시뮬레이션하고 테스트하는 가이드입니다.

## 🔄 전체 플로우

### 1. 무료 체험 시작 (7일)

1. **gest1 계정으로 로그인**
   - ID: `gest1`
   - 비밀번호: `zxc1`
   - 로그인 모드: `gestpartner`

2. **대시보드 확인**
   - 제목: "정액제 대시보드"
   - 색상: 노란색 계열
   - 상단 배너: "🎁 무료 체험 중 (30% 기능) D-6 (12시간 남음)" 형식
   - 카운트다운: 실시간 업데이트 (일, 시, 분, 초)

3. **사용 가능한 기능 (30%)**
   - 나의 판매몰 (my-mall) ✅
   - 링크 관리 (link-create) ✅
   - 나의 고객관리 (customer-management) ✅
   - 구매고객 관리 (purchased-customers) ✅
   - 프로필 수정 (profile-edit) ✅
   - **빨간 테두리로 표시됨**

4. **사용 불가능한 기능**
   - 클릭 시 모달 표시: "지금은 무료 사용 중이십니다. 다른 기능은 사용할 수 없어요 ㅠㅠ"
   - 구매 유도 버튼: "정액제 구독하기 (10만원)"

### 2. 무료 체험 종료 시

1. **카운트다운이 0이 되면**
   - 자동으로 결제 확인 모달 표시
   - 메시지: "이 플랫폼은 크루즈닷과 함께 하는 (주)마비즈컴퍼니 마비즈스쿨 원격 평생교육원 회원으로 가입하며 마케팅 서비스 제공 회원으로 가입하게 됩니다."

2. **결제 확인 모달**
   - "취소" 버튼: 모달 닫기
   - "확인하고 결제하기" 버튼: PayApp 결제 페이지로 이동

### 3. 결제 완료 후

1. **PayApp 결제 완료**
   - PayApp 결제 페이지에서 결제 완료
   - 자동으로 `/partner/gest1/dashboard?payment=success`로 리다이렉트

2. **자동 갱신**
   - URL 파라미터 `payment=success` 확인
   - 구독 정보 자동 재로드 (`/api/partner/subscription/check`)
   - 성공 메시지 표시: "정액제 구독이 완료되었습니다! 이제 더 많은 기능을 사용할 수 있습니다."

3. **기능 자동 활성화**
   - 무료 체험 → 정식 구독 전환
   - `isTrial: false`
   - `status: 'active'`
   - `contractEndDate`: 현재 날짜 + 1개월

4. **사용 가능한 기능 (50%)**
   - 나의 판매몰 (my-mall) ✅
   - 링크 관리 (link-create) ✅
   - 나의 고객관리 (customer-management) ✅
   - 구매고객 관리 (purchased-customers) ✅
   - 크루즈 가이드 동행인 등록 (companion-registration) ✅
   - 고객 그룹 관리 (customer-group-management) ✅
   - 프로필 수정 (profile-edit) ✅
   - 나의 SNS 프로필 (sns-profile) ✅
   - **빨간 테두리로 표시됨**

5. **대시보드 업데이트**
   - 상단 배너: "✅ 정식 구독 중 (50% 기능) D-30 (12시간 남음)" 형식
   - 카운트다운: 정식 구독 종료일까지

## 🧪 테스트 시나리오

### 시나리오 1: 무료 체험 → 결제 완료

1. **준비**
   - gest1 계정 로그인
   - 무료 체험 중인 상태 확인

2. **테스트**
   - 카운트다운이 0이 되면 자동으로 결제 모달 표시 확인
   - 결제 확인 모달에서 "확인하고 결제하기" 클릭
   - PayApp 결제 페이지로 이동 확인
   - 결제 완료 후 대시보드로 리다이렉트 확인
   - 구독 정보 자동 갱신 확인
   - 기능 자동 활성화 확인

3. **예상 결과**
   - ✅ 결제 모달 자동 표시
   - ✅ 결제 완료 후 자동 갱신
   - ✅ 기능 자동 활성화
   - ✅ 성공 메시지 표시

### 시나리오 2: 결제 완료 후 기능 사용

1. **준비**
   - gest1 계정 로그인
   - 정식 구독 중인 상태 확인

2. **테스트**
   - 사용 가능한 기능 (50%) 클릭
   - 사용 불가능한 기능 클릭
   - 기능 제한 모달 확인

3. **예상 결과**
   - ✅ 사용 가능한 기능: 정상 작동
   - ✅ 사용 불가능한 기능: 모달 표시
   - ✅ 빨간 테두리로 사용 가능한 기능 표시

### 시나리오 3: 결제 완료 후 대시보드 갱신

1. **준비**
   - gest1 계정 로그인
   - 결제 완료 직후

2. **테스트**
   - 대시보드 새로고침
   - 구독 정보 확인
   - 카운트다운 확인
   - 기능 사용 가능 여부 확인

3. **예상 결과**
   - ✅ 구독 정보 정상 표시
   - ✅ 카운트다운 정상 작동
   - ✅ 기능 사용 가능 여부 정확

## 🔍 오류 체크 포인트

### 1. 무료 체험 종료 시

- [ ] 카운트다운이 0이 되면 자동으로 결제 모달 표시
- [ ] 결제 모달이 중복으로 표시되지 않음
- [ ] 결제 모달 메시지 정확

### 2. 결제 완료 후

- [ ] URL 파라미터 `payment=success` 확인
- [ ] 구독 정보 자동 재로드
- [ ] 성공 메시지 표시
- [ ] 기능 자동 활성화
- [ ] 대시보드 자동 갱신

### 3. 기능 사용

- [ ] 사용 가능한 기능 정상 작동
- [ ] 사용 불가능한 기능 모달 표시
- [ ] 빨간 테두리 정확히 표시
- [ ] 기능 제한 메시지 정확

### 4. 데이터 일관성

- [ ] PayApp 피드백 API 정상 작동
- [ ] 계약서 상태 정확히 업데이트
- [ ] 구독 정보 정확히 반영

## 🐛 발견된 오류 및 해결 방법

### 오류 1: 무료 체험 종료 시 결제 모달이 표시되지 않음

**원인**: `handleInitiatePayment` 함수가 정의되지 않음

**해결**: `handleInitiatePayment` 함수 추가 및 `useCallback`으로 최적화

### 오류 2: 결제 완료 후 자동 갱신이 되지 않음

**원인**: URL 파라미터 확인 로직 없음

**해결**: `useSearchParams`로 URL 파라미터 확인 및 구독 정보 재로드

### 오류 3: 결제 완료 후 기능이 활성화되지 않음

**원인**: PayApp 피드백 API에서 계약서 업데이트 로직 문제

**해결**: PayApp 피드백 API 확인 및 수정

## ✅ 테스트 체크리스트

- [ ] 무료 체험 시작 시 대시보드 정상 표시
- [ ] 무료 체험 종료 시 자동 결제 모달 표시
- [ ] 결제 확인 모달 정상 작동
- [ ] PayApp 결제 페이지 정상 이동
- [ ] 결제 완료 후 자동 리다이렉트
- [ ] 결제 완료 후 구독 정보 자동 갱신
- [ ] 결제 완료 후 기능 자동 활성화
- [ ] 결제 완료 후 성공 메시지 표시
- [ ] 정식 구독 중 기능 사용 정상
- [ ] 기능 제한 모달 정상 작동
- [ ] 빨간 테두리 정확히 표시
- [ ] 카운트다운 정상 작동

## 📝 참고 사항

1. **gest1 계정 특별 설정**
   - 로그인 시마다 무료 체험 7일 리셋
   - 테스트용 계정

2. **PayApp 설정**
   - 관리자 패널에서 PayApp 설정 확인
   - Vercel 환경변수 확인

3. **자동 갱신**
   - 결제 완료 후 자동으로 구독 정보 재로드
   - URL 파라미터로 결제 완료 확인

4. **기능 제한**
   - 무료 체험: 30% 기능 (5개)
   - 정식 구독: 50% 기능 (8개)

