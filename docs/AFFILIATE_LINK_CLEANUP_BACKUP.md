# 📦 어필리에이트 링크 정리 시 본사 데이터 백업 가이드

## 🔒 본사 데이터 보존 정책

**핵심 원칙**: 링크를 삭제하더라도 본사는 모든 고객 데이터를 보존해야 합니다.

## ✅ 절대 삭제되지 않는 데이터

### 1. 판매원몰 아이디 (AffiliateProfile)
- **절대 삭제되지 않음**
- 링크 삭제와 무관하게 항상 보존
- 판매원의 모든 정보 유지

### 2. 고객 DB (AffiliateLead)
- **DB에 그대로 보존**
- 링크 삭제 시 `linkId`만 `null`로 변경 (CASCADE: SetNull)
- 모든 고객 정보 유지

### 3. 판매 기록 (AffiliateSale)
- **DB에 그대로 보존**
- 링크 삭제 시 `linkId`만 `null`로 변경 (CASCADE: SetNull)
- 모든 판매 정보 유지

### 4. 여권 파일 (PassportSubmission)
- **DB에 그대로 보존**
- 사용자와 직접 연결되어 있어 링크 삭제와 무관
- 모든 여권 정보 유지

### 5. 계약서 (AffiliateContract)
- **DB에 그대로 보존**
- 프로필과 연결되어 있어 링크 삭제와 무관
- 모든 계약서 정보 유지

## 📦 자동 백업 시스템

### 백업 시점
링크 삭제 직전에 자동으로 백업 수행

### 백업 대상 데이터
1. **링크 정보**
   - 링크 코드, 제목, 상태
   - 매니저/에이전트 정보
   - 프로필 코드

2. **고객 DB (리드)**
   - 고객 이름, 전화번호
   - 상태, 메모
   - 여권 요청/완료 일시
   - 상호작용 기록

3. **판매 기록**
   - 주문 코드, 상품 코드
   - 판매 금액, 수수료
   - 판매 상태, 날짜
   - 원장 기록

4. **여권 파일**
   - 제출 토큰
   - 제출 상태
   - 게스트 정보 (이름, 전화번호, 여권번호 등)
   - Google Drive 폴더 URL

5. **계약서**
   - 계약자 정보
   - 계약 상태
   - 서명 일시
   - 첨부 문서 정보

6. **상호작용 기록**
   - 상담 내용
   - 메모
   - 미디어 파일 정보

### 백업 저장 위치
```
backups/affiliate/
  ├── link-{id}-{code}-{timestamp}.json
  ├── link-{id}-{code}-{timestamp}.json
  └── ...
```

### 백업 파일 형식
JSON 형식으로 저장되며, 다음 정보 포함:
- 링크 정보
- 관련된 모든 리드 데이터
- 관련된 모든 판매 데이터
- 관련된 모든 여권 제출 데이터
- 관련된 모든 계약서 데이터
- 관련된 모든 상호작용 및 미디어 정보

## 🔍 백업 확인 방법

### 1. 백업 파일 목록 확인
```bash
ls -lh backups/affiliate/
```

### 2. 백업 파일 내용 확인
```bash
cat backups/affiliate/link-{id}-{code}-{timestamp}.json | jq .
```

### 3. 관리자 페이지에서 확인
- 정리 실행 후 결과에 백업 정보 표시
- 백업된 링크 수 확인 가능

## ⚠️ 중요 사항

1. **판매원몰 아이디는 절대 삭제되지 않음**
   - `AffiliateProfile` 테이블은 링크 삭제와 무관
   - 모든 판매원 정보는 영구 보존

2. **고객 데이터는 DB에 그대로 보존**
   - 링크 삭제는 `linkId`만 `null`로 변경
   - 실제 데이터는 삭제되지 않음

3. **백업은 추가 보안 장치**
   - DB에 데이터가 있더라도 백업 파일로 이중 보존
   - 감사(audit) 목적으로 활용 가능

4. **백업 파일 관리**
   - 정기적으로 백업 파일 확인
   - 오래된 백업 파일은 별도 아카이빙 고려
   - 백업 디렉토리는 정기적으로 백업 권장

## 🛡️ 안전 장치

1. **리드/판매가 있는 링크는 삭제되지 않음**
   - 테스트 링크라도 리드/판매 기록이 있으면 삭제 안 됨

2. **백업 실패 시 삭제 중단**
   - 백업이 실패하면 링크 삭제도 중단됨
   - 모든 데이터 보존 보장

3. **로깅**
   - 모든 백업 작업은 로그에 기록
   - 백업 성공/실패 추적 가능

## 📊 백업 통계

정리 실행 후 다음 정보 확인 가능:
- 백업된 링크 수
- 백업 오류 수
- 백업 파일 위치

## 🔄 복구 방법

필요 시 백업 파일을 사용하여 데이터 복구 가능:
1. 백업 파일 읽기
2. 필요한 데이터 추출
3. 데이터베이스에 복구







