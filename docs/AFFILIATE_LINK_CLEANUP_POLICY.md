# 🔗 어필리에이트 링크 정리 정책

## 📋 정책 개요

어필리에이트 링크의 데이터베이스 용량을 효율적으로 관리하기 위한 자동/수동 정리 정책입니다.

## 🎯 정리 대상

### 1. 만료된 링크 (EXPIRED)
- **조건**: `expiresAt < 현재 시간`
- **처리**: 상태를 `EXPIRED`로 변경
- **보존 기간**: 만료 후 90일간 보존 (이후 아카이빙)

### 2. 비활성 링크 (INACTIVE)
- **조건**: 
  - `status = INACTIVE`
  - `lastAccessedAt`이 180일 이상 경과
  - 리드(Lead) 또는 판매(Sale) 기록이 없는 경우
- **처리**: 상태를 `REVOKED`로 변경 후 아카이빙

### 3. 오래된 링크 (ARCHIVED)
- **조건**:
  - 생성일(`createdAt`)이 365일 이상 경과
  - 리드 또는 판매 기록이 없는 경우
  - 마지막 접근일(`lastAccessedAt`)이 180일 이상 경과
- **처리**: 상태를 `REVOKED`로 변경 후 아카이빙

### 4. 테스트/임시 링크
- **조건**:
  - `campaignName`에 "test", "임시", "temp" 포함
  - 생성 후 30일 경과
  - 리드 또는 판매 기록이 없는 경우
- **처리**: 즉시 삭제 (soft delete)

## ⚙️ 정리 프로세스

### 자동 정리 (스케줄러)
- **실행 주기**: 매주 월요일 새벽 3시 (서버 부하 최소 시간)
- **Cron 표현식**: `0 3 * * 1`
- **처리 순서**:
  1. 만료된 링크 상태 변경
  2. 비활성 링크 아카이빙
  3. 오래된 링크 아카이빙
  4. 테스트 링크 삭제

### 수동 정리 (관리자)
- **접근 경로**: `/admin/affiliate/links/cleanup`
- **기능**:
  - 즉시 정리 실행
  - 정리 전 미리보기
  - 정리 통계 확인
  - 특정 조건으로 필터링

## 📊 정리 통계

정리 작업 후 다음 정보를 제공:
- 정리된 링크 수
- 상태별 분류
- 예상 절약 용량
- 관련 리드/판매 기록 보존 여부

## 🛡️ 안전 장치

### 보존 규칙
1. **판매 기록이 있는 링크**: 절대 삭제하지 않음
2. **활성 리드가 있는 링크**: 정리 대상에서 제외
3. **최근 30일 내 접근**: 정리 대상에서 제외
4. **관리자 지정 보존**: 특정 링크는 수동으로 보존 설정 가능

### 롤백 기능
- 정리 전 백업 생성
- 7일간 롤백 가능
- 정리 로그 기록

## 📝 정리 로그

모든 정리 작업은 다음 정보를 기록:
- 정리 일시
- 정리된 링크 ID 목록
- 정리 사유
- 실행자 (자동/관리자)
- 정리 전/후 상태

## 🔄 아카이빙 vs 삭제

### 아카이빙 (REVOKED)
- 데이터베이스에서 유지
- 상태만 변경
- 통계 조회 가능
- 복구 가능

### 삭제 (Soft Delete)
- `deletedAt` 필드 추가 (향후 구현)
- 완전 삭제는 하지 않음
- 복구 가능

## 📈 모니터링

정리 작업 후 다음 지표를 모니터링:
- 데이터베이스 크기 변화
- 링크 생성/정리 비율
- 활성 링크 수
- 평균 링크 수명

## ⚠️ 주의사항

1. **정리 전 백업 필수**: 프로덕션 환경에서는 정리 전 백업 권장
2. **점진적 적용**: 처음에는 보수적인 정책으로 시작 후 조정
3. **사용자 알림**: 링크가 정리될 예정인 경우 사전 알림 (선택사항)
4. **정기 검토**: 정리 정책을 분기별로 검토 및 조정







